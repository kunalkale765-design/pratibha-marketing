<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Orders - Pratibha Marketing</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e3532">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- Page-specific styles -->
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }

        /* Filters */
        .filters-bar {
            background: var(--warm-white);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--cream-dark);
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .filter-btn {
            flex-shrink: 0;
            padding: 0.625rem 1rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 20px;
            background: var(--cream);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            min-height: 40px;
        }

        .filter-btn.active {
            background: var(--gunmetal);
            color: white;
            border-color: var(--gunmetal);
        }

        /* Search */
        .search-bar {
            padding: 0.75rem 1rem;
            background: var(--warm-white);
            border-bottom: 1px solid var(--cream-dark);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--cream);
            min-height: 48px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--dusty-olive);
            box-shadow: 0 0 0 3px rgba(126, 145, 129, 0.15);
        }

        /* Orders List */
        .orders-list {
            padding: 0.5rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .order-card {
            background: var(--warm-white);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.625rem;
            cursor: pointer;
            transition: all 0.15s;
            border: 1px solid transparent;
        }

        .order-card:active {
            transform: scale(0.98);
            border-color: var(--dusty-olive);
            background: rgba(126, 145, 129, 0.05);
        }

        .order-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.5rem;
        }

        .order-number {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 0.9375rem;
            color: var(--gunmetal);
        }

        .order-amount {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            font-size: 1rem;
            color: var(--gunmetal);
        }

        .order-customer {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .order-bottom {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .order-date {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .order-badges {
            display: flex;
            gap: 0.375rem;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* Modal extras (order-specific) */
        .info-section {
            margin-bottom: 1rem;
        }

        .info-label {
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .info-value {
            font-size: 0.9375rem;
            color: var(--text-primary);
        }

        .info-row {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .info-row > div { flex: 1; }

        .product-item {
            background: var(--cream);
            border-radius: 10px;
            padding: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .product-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .product-qty {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .product-amount {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            text-align: right;
        }

        .prices-container {
            display: flex;
            gap: 0.75rem;
        }

        .price-box {
            flex: 1;
            background: var(--warm-white);
            border-radius: 8px;
            padding: 0.625rem;
        }

        .price-label {
            font-size: 0.625rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .price-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        .price-input {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid var(--cream-dark);
            border-radius: 6px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 500;
            text-align: left;
            background: white;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .price-input::-webkit-inner-spin-button,
        .price-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .price-input:focus {
            outline: none;
            border-color: var(--dusty-olive);
            box-shadow: 0 0 0 3px rgba(126, 145, 129, 0.15);
        }

        .price-input.changed {
            border-color: var(--dusty-olive);
            background: rgba(126, 145, 129, 0.08);
        }

        .amount-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.625rem;
            border-top: 1px dashed var(--cream-dark);
        }

        .amount-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .amount-display {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--gunmetal);
        }

        .total-section {
            background: var(--cream);
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .total-row:last-child { margin-bottom: 0; }

        .total-row.main {
            font-weight: 600;
            font-size: 1.125rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--cream-dark);
        }

        .modal-footer {
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            border-top: 1px solid var(--cream-dark);
            background: var(--warm-white);
        }

        .btn-save-prices {
            width: 100%;
            background: var(--dusty-olive);
            min-height: 52px;
            padding: 1rem;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-save-prices:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-save-prices:not(:disabled):active {
            transform: scale(0.98);
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            .filters-bar, .search-bar {
                padding: 0.5rem 0.75rem;
            }

            .filter-btn {
                padding: 0.5rem 0.75rem;
                font-size: 0.8125rem;
            }

            .search-input {
                padding: 0.625rem 0.875rem;
                font-size: 16px;
                min-height: 44px;
            }

            .orders-list {
                padding: 0.375rem;
            }

            .order-card {
                padding: 0.75rem;
                border-radius: 10px;
            }

            .order-number {
                font-size: 0.875rem;
            }

            .order-amount {
                font-size: 0.9375rem;
            }

            .order-customer {
                font-size: 0.8125rem;
            }

            .product-item {
                padding: 0.625rem;
            }

            .product-name {
                font-size: 0.9375rem;
            }

            .price-input {
                font-size: 16px;
                min-height: 44px;
            }

            .btn-action {
                padding: 0.625rem;
                font-size: 0.75rem;
                min-height: 44px;
            }
        }

        /* Mobile */
        @media (max-width: 480px) {
            .filter-btn {
                min-height: 44px;
            }
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .filters-bar, .search-bar {
                padding: 1rem 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }

            .orders-list {
                padding: 1rem 2rem;
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .order-card {
                margin-bottom: 0;
            }
        }

        /* Large Desktop */
        @media (min-width: 1024px) {
            .orders-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Pratibha <span>Marketing</span></a>
            <div class="header-btns">
                <a href="/customer-order-form.html" class="btn-header primary">+ New</a>
                <a href="/" class="btn-header">Home</a>
            </div>
        </div>
    </header>

    <div class="filters-bar" id="filtersBar">
        <button class="filter-btn active" data-filter="all">All</button>
        <button class="filter-btn" data-filter="pending">Pending</button>
        <button class="filter-btn" data-filter="confirmed">Confirmed</button>
        <button class="filter-btn" data-filter="delivered">Delivered</button>
        <button class="filter-btn" data-filter="cancelled">Cancelled</button>
    </div>

    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search order or customer..." id="searchInput">
    </div>

    <div id="toast" class="toast"></div>

    <div class="orders-list" id="ordersList">
        <div class="empty-state">Loading orders...</div>
    </div>

    <!-- Order Detail Modal -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title" id="modalTitle">Order Details</div>
                <button class="btn-close" onclick="closeModal()">×</button>
            </div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn-save-prices" id="savePricesBtn" onclick="savePrices()">Save Changes</button>
            </div>
        </div>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script type="module">
        import { escapeHtml } from '/js/utils.js';
        import { showToast } from '/js/ui.js';

        let orders = [];
        let marketRates = {};
        let currentFilter = 'all';
        let currentOrderId = null;
        let currentOrder = null;
        let currentUser = null;
        let priceChanges = {};

        async function init() {
            currentUser = await Auth.requireAuth();
            if (!currentUser) return;

            // Hide status controls for customers
            if (currentUser.role === 'customer') {
                document.getElementById('modalFooter').style.display = 'none';
            }

            await Promise.all([loadOrders(), loadMarketRates()]);
            setupFilters();
            setupSearch();
        }

        async function loadMarketRates() {
            try {
                const res = await fetch('/api/market-rates', { credentials: 'include' });
                if (!res.ok) {
                    throw new Error(`Server returned ${res.status}`);
                }
                const data = await res.json();
                (data.data || []).forEach(r => {
                    const pid = typeof r.product === 'object' ? r.product._id : r.product;
                    marketRates[pid] = r.rate;
                });
            } catch (e) {
                console.error('Failed to load market rates:', e);
                showToast('Failed to load market rates. Prices may be outdated.', 'error');
            }
        }

        async function loadOrders() {
            try {
                const res = await fetch('/api/orders?limit=100', { credentials: 'include' });
                const data = await res.json();
                orders = data.data || [];
                renderOrders();
            } catch (e) {
                showToast('Failed to load orders', 'error');
            }
        }

        function renderOrders() {
            const container = document.getElementById('ordersList');
            const search = document.getElementById('searchInput').value.toLowerCase();

            let filtered = orders;

            // Filter by status
            if (currentFilter !== 'all') {
                filtered = filtered.filter(o => o.status === currentFilter);
            }

            // Filter by search
            if (search) {
                filtered = filtered.filter(o =>
                    o.orderNumber?.toLowerCase().includes(search) ||
                    o.customer?.name?.toLowerCase().includes(search)
                );
            }

            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state">No orders found</div>';
                return;
            }

            container.innerHTML = filtered.map(o => `
                <div class="order-card" onclick="viewOrder('${escapeHtml(o._id)}')">
                    <div class="order-top">
                        <div class="order-number">#${escapeHtml(o.orderNumber)}</div>
                        <div class="order-amount">₹${(o.totalAmount || 0).toLocaleString('en-IN')}</div>
                    </div>
                    <div class="order-customer">${escapeHtml(o.customer?.name || 'Unknown')}</div>
                    <div class="order-bottom">
                        <div class="order-date">${new Date(o.createdAt).toLocaleDateString('en-IN')}</div>
                        <div class="order-badges">
                            <span class="badge badge-${escapeHtml(o.status)}">${escapeHtml(o.status)}</span>
                            <span class="badge badge-${escapeHtml(o.paymentStatus)}">${escapeHtml(o.paymentStatus)}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function setupFilters() {
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentFilter = btn.dataset.filter;
                    renderOrders();
                };
            });
        }

        function setupSearch() {
            document.getElementById('searchInput').addEventListener('input', renderOrders);
        }

        async function viewOrder(id) {
            try {
                const res = await fetch(`/api/orders/${id}`, { credentials: 'include' });
                const data = await res.json();
                const order = data.data;

                currentOrderId = id;
                currentOrder = order;
                priceChanges = {};
                document.getElementById('modalTitle').textContent = `#${order.orderNumber}`;
                document.getElementById('savePricesBtn').disabled = true;

                const isStaff = currentUser.role === 'admin' || currentUser.role === 'staff';

                const body = `
                    <div class="info-row">
                        <div>
                            <div class="info-label">Customer</div>
                            <div class="info-value">${escapeHtml(order.customer?.name)}</div>
                        </div>
                        <div>
                            <div class="info-label">Phone</div>
                            <div class="info-value">${escapeHtml(order.customer?.phone || '-')}</div>
                        </div>
                    </div>
                    <div class="info-row">
                        <div>
                            <div class="info-label">Date</div>
                            <div class="info-value">${new Date(order.createdAt).toLocaleDateString('en-IN')}</div>
                        </div>
                        <div>
                            <div class="info-label">Status</div>
                            <div class="info-value"><span class="badge badge-${escapeHtml(order.status)}">${escapeHtml(order.status)}</span></div>
                        </div>
                    </div>

                    <div class="info-section">
                        <div class="info-label">Products</div>
                        ${order.products.map((p, idx) => {
                            const productId = typeof p.product === 'object' ? p.product._id : p.product;
                            const purchasePrice = marketRates[productId] || p.rate;
                            return `
                            <div class="product-item" data-idx="${idx}">
                                <div class="product-top">
                                    <div>
                                        <div class="product-name">${escapeHtml(p.productName)}</div>
                                        <div class="product-qty">${p.quantity} ${escapeHtml(p.unit)}</div>
                                    </div>
                                </div>
                                <div class="prices-container">
                                    <div class="price-box">
                                        <div class="price-label">Purchase</div>
                                        <div class="price-value">₹${purchasePrice}</div>
                                    </div>
                                    <div class="price-box">
                                        <div class="price-label">Selling</div>
                                        ${isStaff ? `
                                            <input type="number" class="price-input"
                                                id="price-${idx}"
                                                data-idx="${idx}"
                                                data-original="${p.rate}"
                                                data-qty="${p.quantity}"
                                                value="${p.rate}"
                                                min="0" step="0.01"
                                                onfocus="clearZero(this)"
                                                onblur="restoreValue(this)"
                                                onchange="handlePriceChange(${idx})"
                                                oninput="handlePriceInput(${idx})">
                                        ` : `<div class="price-value">₹${p.rate}</div>`}
                                    </div>
                                </div>
                                <div class="amount-row">
                                    <span class="amount-label">Amount</span>
                                    <span class="amount-display" id="amount-${idx}">₹${p.amount}</span>
                                </div>
                            </div>
                        `}).join('')}
                    </div>

                    <div class="total-section">
                        <div class="total-row">
                            <span>Total</span>
                            <span id="orderTotal">₹${order.totalAmount}</span>
                        </div>
                        <div class="total-row">
                            <span>Paid</span>
                            <span>₹${order.paidAmount || 0}</span>
                        </div>
                        <div class="total-row main">
                            <span>Balance</span>
                            <span id="orderBalance">₹${order.totalAmount - (order.paidAmount || 0)}</span>
                        </div>
                    </div>
                `;

                document.getElementById('modalBody').innerHTML = body;
                document.getElementById('orderModal').classList.add('show');
            } catch (e) {
                showToast('Failed to load order', 'error');
            }
        }

        function clearZero(input) {
            input.dataset.prevValue = input.value;
            input.value = '';
            input.select();
        }

        function restoreValue(input) {
            if (input.value === '') {
                input.value = input.dataset.prevValue || input.dataset.original;
            }
            const idx = parseInt(input.dataset.idx);
            handlePriceChange(idx);
        }

        function handlePriceInput(idx) {
            const input = document.getElementById(`price-${idx}`);
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value) || 0;
            const qty = parseFloat(input.dataset.qty);

            input.classList.toggle('changed', current !== original);

            // Update amount display
            const amount = current * qty;
            document.getElementById(`amount-${idx}`).textContent = `₹${amount.toFixed(0)}`;

            // Update total
            updateOrderTotal();
        }

        function handlePriceChange(idx) {
            const input = document.getElementById(`price-${idx}`);
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value) || 0;

            if (current !== original && current > 0) {
                priceChanges[idx] = current;
            } else {
                delete priceChanges[idx];
            }

            // Enable/disable save button
            const hasChanges = Object.keys(priceChanges).length > 0;
            document.getElementById('savePricesBtn').disabled = !hasChanges;
        }

        function updateOrderTotal() {
            if (!currentOrder) return;

            let total = 0;
            currentOrder.products.forEach((p, idx) => {
                const input = document.getElementById(`price-${idx}`);
                const rate = input ? (parseFloat(input.value) || 0) : p.rate;
                total += rate * p.quantity;
            });

            document.getElementById('orderTotal').textContent = `₹${total.toFixed(0)}`;
            document.getElementById('orderBalance').textContent = `₹${(total - (currentOrder.paidAmount || 0)).toFixed(0)}`;
        }

        async function savePrices() {
            if (!currentOrderId || !currentOrder || Object.keys(priceChanges).length === 0) return;

            const btn = document.getElementById('savePricesBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                // Build updated products array
                const updatedProducts = currentOrder.products.map((p, idx) => ({
                    product: typeof p.product === 'object' ? p.product._id : p.product,
                    quantity: p.quantity,
                    priceAtTime: priceChanges[idx] !== undefined ? priceChanges[idx] : p.rate
                }));

                const headers = { 'Content-Type': 'application/json' };
                const csrfToken = Auth.getCsrfToken();
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const res = await fetch(`/api/orders/${currentOrderId}`, {
                    method: 'PUT',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({ products: updatedProducts })
                });

                if (res.ok) {
                    showToast('Prices saved', 'success');
                    priceChanges = {};
                    btn.disabled = true;
                    loadOrders();
                    // Refresh the modal
                    viewOrder(currentOrderId);
                } else {
                    const err = await res.json();
                    showToast(err.message || 'Failed to update', 'error');
                }
            } catch (e) {
                console.error('Save prices error:', e);
                if (!navigator.onLine) {
                    showToast('No internet connection', 'error');
                } else {
                    showToast('Failed to save prices. Please try again.', 'error');
                }
            }

            btn.textContent = 'Save Changes';
        }

        function closeModal() {
            document.getElementById('orderModal').classList.remove('show');
            currentOrderId = null;
        }
        // Expose to window for onclick handlers
        window.closeModal = closeModal;
        window.viewOrder = viewOrder;
        window.clearZero = clearZero;
        window.restoreValue = restoreValue;
        window.handlePriceChange = handlePriceChange;
        window.handlePriceInput = handlePriceInput;
        window.savePrices = savePrices;

        // Close modal on overlay click
        document.getElementById('orderModal').onclick = (e) => {
            if (e.target.id === 'orderModal') closeModal();
        };

        init();
    </script>
</body>
</html>
