<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Pratibha Marketing</title>

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#7e9181">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Pratibha">
    <link rel="apple-touch-icon" href="/assets/icons/icon.svg">

    <!-- Shared CSS (order matters!) -->
    <link rel="stylesheet" href="/assets/css/variables.css">
    <link rel="stylesheet" href="/assets/css/base.css">
    <link rel="stylesheet" href="/assets/css/components.css">
    <link rel="stylesheet" href="/assets/css/utilities.css">
    <link rel="stylesheet" href="/assets/css/responsive.css">

    <!-- Animations -->
    <link rel="stylesheet" href="/assets/css/animations/inputs.css">
    <link rel="stylesheet" href="/assets/css/animations/buttons.css">

    <!-- Page-specific styles -->
    <link rel="stylesheet" href="/assets/css/pages/login.css">
</head>

<body>
    <div class="login-container">
        <!-- Brand Side -->
        <div class="brand-side">
            <div class="brand-logo">
                <div class="logo-text">Pratibha <span>Marketing</span></div>
            </div>
            <h2 class="brand-tagline">Reset Your Password</h2>
            <p class="brand-description">
                Enter your new password below. Make sure it's secure and memorable.
            </p>
        </div>

        <!-- Form Side -->
        <div class="form-side">
            <div class="login-card">
                <div class="login-header">
                    <h1>New Password</h1>
                    <p>Create a strong password for your account</p>
                </div>

                <div id="noticeMessage" class="notice-message"></div>

                <form id="resetForm">
                    <div class="form-group">
                        <label class="form-label" for="password">New Password</label>
                        <div class="input-group">
                            <input type="password" id="password" class="form-input input-animated"
                                placeholder="Enter new password" required autocomplete="new-password">
                            <button type="button" class="password-toggle" id="passwordToggle">◉</button>
                        </div>
                        <small class="form-hint">Min 6 chars, 1 uppercase, 1 lowercase, 1 number</small>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="confirmPassword">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-input input-animated"
                            placeholder="Confirm new password" required autocomplete="new-password">
                    </div>

                    <button type="submit" id="resetBtn" class="btn btn-primary btn-block btn-animated">
                        <span class="btn-text">Reset Password</span>
                    </button>

                    <p class="signup-link" style="margin-top: 1.5rem;">
                        Remember your password? <a href="/pages/auth/login.html">Sign in</a>
                    </p>
                </form>
            </div>
        </div>
    </div>

    <script type="module">
        const form = document.getElementById('resetForm');
        const notice = document.getElementById('noticeMessage');
        const passwordToggle = document.getElementById('passwordToggle');
        const passwordInput = document.getElementById('password');

        // Toggle password visibility
        passwordToggle.addEventListener('click', () => {
            const type = passwordInput.type === 'password' ? 'text' : 'password';
            passwordInput.type = type;
            passwordToggle.textContent = type === 'password' ? '◉' : '◎';
        });

        // Get token from URL
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        if (!token) {
            notice.textContent = 'Invalid reset link. Please request a new one.';
            notice.classList.add('error', 'show');
            form.querySelector('button[type="submit"]').disabled = true;
        }

        // Remove token from URL for cleanliness
        if (token) {
            history.replaceState(null, '', window.location.pathname);
        }

        // Password requirement validation
        const reqContainer = document.createElement('div');
        reqContainer.className = 'password-requirements';
        reqContainer.style.cssText = 'margin-top: 0.5rem; font-size: 0.8rem;';
        reqContainer.innerHTML = `
            <div id="req-length" style="color: var(--text-muted);">◯ At least 6 characters</div>
            <div id="req-upper" style="color: var(--text-muted);">◯ One uppercase letter</div>
            <div id="req-lower" style="color: var(--text-muted);">◯ One lowercase letter</div>
            <div id="req-number" style="color: var(--text-muted);">◯ One number</div>
        `;
        passwordInput.parentElement.after(reqContainer);

        passwordInput.addEventListener('input', function() {
            const val = this.value;
            updateReq('req-length', val.length >= 6);
            updateReq('req-upper', /[A-Z]/.test(val));
            updateReq('req-lower', /[a-z]/.test(val));
            updateReq('req-number', /[0-9]/.test(val));
        });

        function updateReq(id, valid) {
            const el = document.getElementById(id);
            if (!el) return;
            const text = el.textContent.substring(2);
            el.textContent = (valid ? '✓ ' : '◯ ') + text;
            el.style.color = valid ? 'var(--success)' : 'var(--text-muted)';
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const btn = document.getElementById('resetBtn');

            notice.classList.remove('show', 'error', 'success');

            if (password.length < 6 || !/[A-Z]/.test(password) || !/[a-z]/.test(password) || !/[0-9]/.test(password)) {
                notice.textContent = 'Password does not meet requirements';
                notice.classList.add('error', 'show');
                return;
            }

            if (password !== confirmPassword) {
                notice.textContent = 'Passwords do not match';
                notice.classList.add('error', 'show');
                return;
            }

            btn.classList.add('btn-loading');
            btn.disabled = true;

            try {
                // Pre-fetch CSRF token
                await fetch('/api/csrf-token', { credentials: 'include' });
                const csrfCookie = document.cookie.split('; ').find(row => row.startsWith('csrf_token='));
                const csrfToken = csrfCookie ? csrfCookie.split('=')[1] : '';

                let res = await fetch(`/api/auth/reset-password/${token}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRF-Token': csrfToken
                    },
                    credentials: 'include',
                    body: JSON.stringify({ password })
                });

                let data = await res.json();

                // Retry on CSRF error
                if (res.status === 403 && data?.message?.toLowerCase().includes('csrf')) {
                    await fetch('/api/csrf-token', { credentials: 'include' });
                    const retryCookie = document.cookie.split('; ').find(row => row.startsWith('csrf_token='));
                    const retryToken = retryCookie ? retryCookie.split('=')[1] : '';
                    res = await fetch(`/api/auth/reset-password/${token}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': retryToken
                        },
                        credentials: 'include',
                        body: JSON.stringify({ password })
                    });
                    data = await res.json();
                }

                if (res.status === 429) {
                    throw new Error('Too many attempts. Please try again later.');
                }

                if (res.ok && data.success) {
                    notice.textContent = 'Password reset successful! Redirecting...';
                    notice.classList.add('success', 'show');
                    btn.classList.remove('btn-loading');
                    btn.classList.add('btn-success');

                    // Redirect based on role
                    setTimeout(() => {
                        const role = data.user?.role;
                        if (role === 'customer') {
                            window.location.href = '/pages/order-form/';
                        } else {
                            window.location.href = '/';
                        }
                    }, 1500);
                } else {
                    throw new Error(data.message || data.errors?.[0]?.msg || 'Reset failed');
                }
            } catch (err) {
                notice.textContent = err.message;
                notice.classList.add('error', 'show');
                btn.classList.remove('btn-loading');
                btn.disabled = false;
            }
        });
    </script>
</body>

</html>