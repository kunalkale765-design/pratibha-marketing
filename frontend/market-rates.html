<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Market Rates - Pratibha Marketing</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e3532">
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:wght@500;600&family=DM+Sans:wght@400;500;600&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --gunmetal: #2e3532;
            --dusty-olive: #7e9181;
            --dusty-olive-dark: #5d6b5f;
            --cream: #f9f7f3;
            --cream-dark: #efe9df;
            --warm-white: #fefdfb;
            --terracotta: #c4a77d;
            --text-primary: #1f2421;
            --text-muted: #8a918c;
            --success: #6b8f71;
            --pale-slate-light: #e8ebf0;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            min-height: 100vh;
            color: var(--text-primary);
            -webkit-tap-highlight-color: transparent;
        }

        /* Header */
        .header {
            background: var(--gunmetal);
            color: white;
            padding: 0.875rem 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'Crimson Pro', serif;
            font-size: 1.25rem;
            font-weight: 600;
            text-decoration: none;
            color: white;
        }

        .logo span {
            font-weight: 400;
            opacity: 0.8;
        }

        .btn-back {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.5rem 0.875rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            cursor: pointer;
            text-decoration: none;
        }

        /* Date Bar */
        .date-bar {
            background: var(--warm-white);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--cream-dark);
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Product List */
        .product-list {
            padding: 0.5rem;
            padding-bottom: 100px;
        }

        .product-item {
            background: var(--warm-white);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            min-height: 60px;
        }

        .product-info {
            flex: 1;
            min-width: 0;
        }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gunmetal);
            line-height: 1.3;
        }

        .product-unit {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .rate-input {
            width: 100px;
            padding: 0.75rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            text-align: right;
            background: white;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .rate-input::-webkit-inner-spin-button,
        .rate-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .rate-input:focus {
            outline: none;
            border-color: var(--dusty-olive);
            box-shadow: 0 0 0 3px rgba(126, 145, 129, 0.15);
        }

        .rate-input.changed {
            border-color: var(--dusty-olive);
            background: rgba(126, 145, 129, 0.1);
        }

        /* Category Header */
        .category-header {
            padding: 0.625rem 0.5rem;
            font-family: 'Crimson Pro', serif;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gunmetal);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .changes-count {
            font-size: 0.9375rem;
        }

        .btn-save {
            background: var(--dusty-olive);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 48px;
        }

        .btn-save:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-save:not(:disabled):active {
            transform: scale(0.97);
        }

        /* Toast */
        .toast {
            position: fixed;
            top: 60px;
            left: 1rem;
            right: 1rem;
            padding: 0.875rem 1rem;
            border-radius: 8px;
            font-weight: 500;
            z-index: 200;
            transform: translateY(-100px);
            opacity: 0;
            transition: all 0.3s ease;
            background: var(--success);
            color: white;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.error {
            background: #9a6565;
        }

        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            .header {
                padding: 0.75rem;
            }

            .logo {
                font-size: 1.125rem;
            }

            .btn-back {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
            }

            .date-bar {
                padding: 0.625rem 0.75rem;
                font-size: 0.75rem;
            }

            .product-list {
                padding: 0.375rem;
            }

            .product-item {
                padding: 0.75rem;
                border-radius: 10px;
            }

            .product-name {
                font-size: 0.9375rem;
            }

            .product-unit {
                font-size: 0.6875rem;
            }

            .rate-input {
                width: 80px;
                height: 40px;
                font-size: 16px;
            }

            .bottom-bar {
                padding: 0.75rem;
            }

            .changes-count {
                font-size: 0.8125rem;
            }

            .btn-save {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
                min-height: 44px;
            }
        }

        /* Mobile */
        @media (max-width: 480px) {
            .btn-back {
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .rate-input {
                min-height: 44px;
            }
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .header {
                padding: 1rem 2rem;
            }

            .header-content {
                max-width: 1200px;
                margin: 0 auto;
            }

            .logo {
                font-size: 1.5rem;
            }

            .date-bar {
                padding: 1rem 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }

            .product-list {
                padding: 0.5rem 2rem;
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .product-item {
                margin-bottom: 0;
            }

            .bottom-bar {
                padding: 1rem 2rem;
            }
        }

        /* Large Desktop */
        @media (min-width: 1024px) {
            .product-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .product-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Pratibha <span>Marketing</span></a>
            <a href="/" class="btn-back">Dashboard</a>
        </div>
    </header>

    <div class="date-bar" id="dateBar">Loading...</div>

    <div id="toast" class="toast"></div>

    <div class="product-list" id="productList">
        <div class="loading">Loading products...</div>
    </div>

    <div class="bottom-bar">
        <div class="changes-count"><span id="changesCount">0</span> changed</div>
        <button class="btn-save" id="saveBtn" disabled onclick="saveRates()">Save Rates</button>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script>
        let products = [];
        let rates = {};
        let changedRates = {};

        async function init() {
            const user = await Auth.requireAuth(['admin', 'staff']);
            if (!user) return;

            document.getElementById('dateBar').textContent = new Date().toLocaleDateString('en-IN', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            await loadData();
        }

        async function loadData() {
            try {
                const [productsRes, ratesRes] = await Promise.all([
                    fetch('/api/products', { credentials: 'include' }),
                    fetch('/api/market-rates', { credentials: 'include' })
                ]);

                const productsData = await productsRes.json();
                const ratesData = await ratesRes.json();

                products = (productsData.data || []).filter(p => p.isActive);

                // Map rates by product ID
                (ratesData.data || []).forEach(rate => {
                    const pid = typeof rate.product === 'object' ? rate.product._id : rate.product;
                    rates[pid] = rate.rate;
                });

                renderProducts();
            } catch (e) {
                console.error(e);
                showToast('Failed to load data', true);
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');

            if (!products.length) {
                container.innerHTML = '<div class="loading">No products found</div>';
                return;
            }

            // Group by category
            const grouped = {};
            products.forEach(p => {
                const cat = p.category || 'other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            let html = '';
            for (const [cat, prods] of Object.entries(grouped)) {
                const catName = cat.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `<div class="category-header">${catName}</div>`;

                prods.forEach(p => {
                    const currentRate = rates[p._id] || 0;
                    html += `
                        <div class="product-item">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(p.name)}</div>
                                <div class="product-unit">per ${escapeHtml(p.unit)}</div>
                            </div>
                            <input type="number" class="rate-input"
                                id="rate-${p._id}"
                                data-id="${p._id}"
                                data-original="${currentRate}"
                                value="${currentRate}"
                                min="0" step="0.01"
                                onfocus="clearZero(this)"
                                onblur="restoreValue(this)"
                                onchange="handleChange(this)"
                                oninput="handleInput(this)">
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function escapeHtml(str) {
            if (!str) return '';
            return String(str).replace(/[&<>"']/g, m => ({
                '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
            }[m]));
        }

        function clearZero(input) {
            input.dataset.prevValue = input.value;
            input.value = '';
            input.select();
        }

        function restoreValue(input) {
            if (input.value === '') {
                input.value = input.dataset.prevValue || input.dataset.original;
            }
            handleChange(input);
        }

        function handleInput(input) {
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value);
            input.classList.toggle('changed', current !== original);
        }

        function handleChange(input) {
            const id = input.dataset.id;
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value);

            if (current !== original && current > 0) {
                changedRates[id] = current;
                input.classList.add('changed');
            } else {
                delete changedRates[id];
                input.classList.remove('changed');
            }

            updateSaveButton();
        }

        function updateSaveButton() {
            const count = Object.keys(changedRates).length;
            document.getElementById('changesCount').textContent = count;
            document.getElementById('saveBtn').disabled = count === 0;
        }

        async function saveRates() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            let success = 0, failed = 0;

            for (const [productId, rate] of Object.entries(changedRates)) {
                try {
                    const res = await fetch('/api/market-rates', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({
                            product: productId,
                            rate: rate,
                            effectiveDate: new Date().toISOString()
                        })
                    });

                    if (res.ok) {
                        success++;
                        // Update the original value
                        const input = document.getElementById('rate-' + productId);
                        if (input) {
                            input.dataset.original = rate;
                            input.classList.remove('changed');
                        }
                        rates[productId] = rate;
                    } else {
                        failed++;
                    }
                } catch (e) {
                    failed++;
                }
            }

            changedRates = {};
            updateSaveButton();

            btn.textContent = 'Save Rates';

            if (success > 0) {
                showToast(`${success} rate(s) saved`);
            }
            if (failed > 0) {
                showToast(`${failed} rate(s) failed`, true);
            }
        }

        function showToast(message, isError = false) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast show' + (isError ? ' error' : '');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        init();
    </script>
</body>
</html>
