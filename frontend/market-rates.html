<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Market Rates - Pratibha Marketing</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e3532">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- Animations -->
    <link rel="stylesheet" href="/css/animations/skeleton.css">
    <link rel="stylesheet" href="/css/animations/cards.css">
    <link rel="stylesheet" href="/css/animations/inputs.css">
    <link rel="stylesheet" href="/css/animations/buttons.css">
    <link rel="stylesheet" href="/css/animations/page.css">

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Page-specific styles -->
    <link rel="stylesheet" href="/css/pages/market-rates.css">
</head>
<body>
    <header class="header header-animated">
        <div class="header-content">
            <a href="/" class="logo">Pratibha <span>Marketing</span></a>
            <a href="/" class="btn-back btn-animated">Dashboard</a>
        </div>
    </header>

    <div class="date-bar" id="dateBar">Loading...</div>

    <div id="toast" class="toast"></div>

    <div class="product-list" id="productList">
        <!-- Skeleton loading placeholders -->
        <div class="skeleton-card" style="display: flex; align-items: center; gap: 1rem;">
            <div style="flex: 1;">
                <div class="skeleton skeleton-title" style="width: 50%; margin-bottom: 0.25rem;"></div>
                <div class="skeleton skeleton-text" style="width: 30%;"></div>
            </div>
            <div class="skeleton" style="width: 100px; height: 44px; border-radius: 8px;"></div>
        </div>
        <div class="skeleton-card" style="display: flex; align-items: center; gap: 1rem;">
            <div style="flex: 1;">
                <div class="skeleton skeleton-title" style="width: 50%; margin-bottom: 0.25rem;"></div>
                <div class="skeleton skeleton-text" style="width: 30%;"></div>
            </div>
            <div class="skeleton" style="width: 100px; height: 44px; border-radius: 8px;"></div>
        </div>
        <div class="skeleton-card" style="display: flex; align-items: center; gap: 1rem;">
            <div style="flex: 1;">
                <div class="skeleton skeleton-title" style="width: 50%; margin-bottom: 0.25rem;"></div>
                <div class="skeleton skeleton-text" style="width: 30%;"></div>
            </div>
            <div class="skeleton" style="width: 100px; height: 44px; border-radius: 8px;"></div>
        </div>
    </div>

    <!-- 7-Day History Section -->
    <section class="history-section">
        <div class="history-card">
            <div class="history-header">
                <h2 class="history-title">7-Day Rate History</h2>
                <div class="history-controls">
                    <select id="historyCategory" class="history-select input-animated" onchange="loadHistory()">
                        <option value="all">All Categories</option>
                    </select>
                    <button class="btn-export" onclick="exportToPDF()">
                        <span>Export PDF</span>
                    </button>
                </div>
            </div>
            <div class="history-content" id="historyContent">
                <div class="history-loading">Loading history...</div>
            </div>
        </div>
    </section>

    <div class="bottom-bar">
        <div class="changes-count"><span id="changesCount">0</span> changed</div>
        <button class="btn-save btn-animated" id="saveBtn" disabled onclick="saveRates()">
            <span class="btn-text">Save Rates</span>
        </button>
    </div>

    <script type="module" src="/js/auth.js"></script>
    <script type="module" src="/js/api.js"></script>
    <script type="module">
        import { escapeHtml } from '/js/utils.js';
        import { showToast } from '/js/ui.js';

        // Wait for Auth to be available
        const waitForAuth = () => new Promise((resolve) => {
            if (window.Auth) resolve(window.Auth);
            else setTimeout(() => resolve(waitForAuth()), 10);
        });
        const Auth = await waitForAuth();

        let products = [];
        let rates = {};
        let changedRates = {};
        let historyData = null;

        async function init() {
            const user = await Auth.requireAuth(['admin', 'staff']);
            if (!user) return;

            document.getElementById('dateBar').textContent = new Date().toLocaleDateString('en-IN', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            await loadData();
            await loadHistory();
        }

        async function loadData() {
            try {
                const [productsRes, ratesRes] = await Promise.all([
                    fetch('/api/products', { credentials: 'include' }),
                    fetch('/api/market-rates', { credentials: 'include' })
                ]);

                const productsData = await productsRes.json();
                const ratesData = await ratesRes.json();

                products = (productsData.data || []).filter(p => p.isActive);

                // Map rates by product ID
                (ratesData.data || []).forEach(rate => {
                    const pid = typeof rate.product === 'object' ? rate.product._id : rate.product;
                    rates[pid] = rate.rate;
                });

                renderProducts();
            } catch (e) {
                console.error(e);
                const container = document.getElementById('productList');
                const errorMsg = !navigator.onLine ? 'No internet connection' : 'Data not available';
                container.innerHTML = `
                    <div class="loading">
                        <p>${errorMsg}</p>
                        <button onclick="loadData()"
                            style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--dusty-olive); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');

            if (!products.length) {
                container.innerHTML = '<div class="loading">No products found</div>';
                return;
            }

            // Group by category
            const grouped = {};
            products.forEach(p => {
                const cat = p.category || 'other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            let html = '';
            let itemIdx = 0;
            for (const [cat, prods] of Object.entries(grouped)) {
                const catName = cat.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `<div class="category-header">${escapeHtml(catName)}</div>`;

                prods.forEach(p => {
                    const currentRate = rates[p._id] || 0;
                    html += `
                        <div class="product-item card-animated card-fade-in" style="animation-delay: ${itemIdx * 0.03}s">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(p.name)}</div>
                                <div class="product-unit">per ${escapeHtml(p.unit)}</div>
                            </div>
                            <input type="number" class="rate-input input-animated"
                                id="rate-${escapeHtml(p._id)}"
                                data-id="${escapeHtml(p._id)}"
                                data-original="${escapeHtml(String(currentRate))}"
                                value="${escapeHtml(String(currentRate))}"
                                min="0" step="0.01"
                                onfocus="clearZero(this)"
                                onblur="restoreValue(this)"
                                onchange="handleChange(this)"
                                oninput="handleInput(this)">
                        </div>
                    `;
                    itemIdx++;
                });
            }

            container.innerHTML = html;
        }

        function clearZero(input) {
            input.dataset.prevValue = input.value;
            input.value = '';
            input.select();
        }

        function restoreValue(input) {
            if (input.value === '') {
                input.value = input.dataset.prevValue || input.dataset.original;
            }
            handleChange(input);
        }

        function handleInput(input) {
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value);
            input.classList.toggle('changed', current !== original);
        }

        function handleChange(input) {
            const id = input.dataset.id;
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value);

            if (current !== original && current > 0) {
                changedRates[id] = current;
                input.classList.add('changed');
            } else {
                delete changedRates[id];
                input.classList.remove('changed');
            }

            updateSaveButton();
        }

        function updateSaveButton() {
            const count = Object.keys(changedRates).length;
            document.getElementById('changesCount').textContent = count;
            document.getElementById('saveBtn').disabled = count === 0;
        }

        async function saveRates() {
            const btn = document.getElementById('saveBtn');

            // Client-side validation: Check for negative or invalid rates
            const invalidRates = [];
            for (const [productId, rate] of Object.entries(changedRates)) {
                if (isNaN(rate) || rate < 0) {
                    const product = products.find(p => p._id === productId);
                    invalidRates.push(product?.name || productId);
                }
            }

            if (invalidRates.length > 0) {
                showToast(`${invalidRates.slice(0, 2).join(', ')}: rates must be 0 or higher`, 'info');
                return;
            }

            btn.disabled = true;
            btn.classList.add('btn-loading');

            let success = 0, failed = 0;
            let firstError = null;
            const failedProducts = [];

            const headers = { 'Content-Type': 'application/json' };
            let csrfToken = await Auth.ensureCsrfToken();
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }

            for (const [productId, rate] of Object.entries(changedRates)) {
                try {
                    let res = await fetch('/api/market-rates', {
                        method: 'POST',
                        headers,
                        credentials: 'include',
                        body: JSON.stringify({
                            product: productId,
                            rate: rate,
                            effectiveDate: new Date().toISOString()
                        })
                    });

                    // Handle CSRF error with retry
                    if (res.status === 403) {
                        const err = await res.json().catch(() => ({}));
                        if (err.message?.toLowerCase().includes('csrf')) {
                            csrfToken = await Auth.refreshCsrfToken();
                            if (csrfToken) {
                                headers['X-CSRF-Token'] = csrfToken;
                                res = await fetch('/api/market-rates', {
                                    method: 'POST',
                                    headers,
                                    credentials: 'include',
                                    body: JSON.stringify({
                                        product: productId,
                                        rate: rate,
                                        effectiveDate: new Date().toISOString()
                                    })
                                });
                            }
                        }
                    }

                    if (res.ok) {
                        success++;
                        // Update the original value
                        const input = document.getElementById('rate-' + productId);
                        if (input) {
                            input.dataset.original = rate;
                            input.classList.remove('changed');
                        }
                        rates[productId] = rate;
                    } else {
                        failed++;
                        const errData = await res.json().catch(() => ({}));
                        const errorMsg = errData.message || `HTTP ${res.status}`;
                        console.error('Failed to save rate for product:', productId, errorMsg);
                        if (!firstError) firstError = errorMsg;
                        failedProducts.push(productId);
                    }
                } catch (e) {
                    failed++;
                    console.error('Failed to save rate for product:', productId, e.message);
                    if (!firstError) firstError = e.message || 'Network error';
                    failedProducts.push(productId);
                }
            }

            // Only clear rates that were successfully saved (keep failed ones for retry)
            const successfulRates = {};
            Object.keys(changedRates).forEach(pid => {
                if (failedProducts.includes(pid)) {
                    successfulRates[pid] = changedRates[pid];
                }
            });
            changedRates = successfulRates;
            updateSaveButton();

            btn.classList.remove('btn-loading');

            if (success > 0) {
                btn.classList.add('btn-success');
                setTimeout(() => btn.classList.remove('btn-success'), 1500);
                showToast(`${success} rate(s) saved`, 'success');
            }
            if (failed > 0) {
                showToast(`${failed} rate(s) not saved`, 'info');
            }
        }

        // History functions
        async function loadHistory() {
            const container = document.getElementById('historyContent');
            const categorySelect = document.getElementById('historyCategory');
            const selectedCategory = categorySelect.value;

            container.innerHTML = '<div class="history-loading">Loading history...</div>';

            try {
                const url = `/api/market-rates/history-summary?days=7${selectedCategory !== 'all' ? `&category=${encodeURIComponent(selectedCategory)}` : ''}`;
                const res = await fetch(url, { credentials: 'include' });

                if (!res.ok) {
                    throw new Error('History temporarily unavailable');
                }

                const data = await res.json();
                historyData = data;

                // Populate category dropdown (only on first load)
                if (categorySelect.options.length <= 1 && data.categories) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        categorySelect.appendChild(option);
                    });
                }

                renderHistory(data);
            } catch (e) {
                console.error('Failed to load history:', e);
                container.innerHTML = '<div class="history-loading">History not available</div>';
            }
        }

        function renderHistory(data) {
            const container = document.getElementById('historyContent');

            if (!data.data || data.data.length === 0 || !data.data[0]?.rates?.length) {
                container.innerHTML = '<div class="history-loading">No history data available</div>';
                return;
            }

            // Build date headers
            const dates = data.data[0].rates.map(r => r.date);
            const dateHeaders = dates.map(dateStr => {
                const date = new Date(dateStr);
                const day = date.toLocaleDateString('en-IN', { weekday: 'short' });
                const formatted = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                return `<th class="date-header">${formatted}<span class="date-day">${day}</span></th>`;
            }).join('');

            // Build table rows
            const rows = data.data.map(product => {
                const rateCells = product.rates.map(r => {
                    if (r.rate === null) {
                        return '<td class="rate-cell rate-null">-</td>';
                    }
                    const trendClass = r.trend || 'stable';
                    const trendIcon = r.trend === 'up' ? '↑' : (r.trend === 'down' ? '↓' : '');
                    return `<td class="rate-cell ${trendClass}">${r.rate.toFixed(2)}${trendIcon ? `<span class="trend-indicator">${trendIcon}</span>` : ''}</td>`;
                }).join('');

                return `
                    <tr>
                        <td>${escapeHtml(product.name)}<br><small style="color: var(--text-muted); font-weight: 400;">per ${escapeHtml(product.unit)}</small></td>
                        ${rateCells}
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            ${dateHeaders}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        function exportToPDF() {
            if (!historyData || !historyData.data || historyData.data.length === 0 || !historyData.data[0]?.rates?.length) {
                showToast('No data available to export', 'info');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Title
                doc.setFontSize(18);
                doc.setTextColor(46, 53, 50);
                doc.text('Pratibha Marketing - 7-Day Market Rate History', 14, 20);

                // Subtitle with date range
                doc.setFontSize(10);
                doc.setTextColor(138, 145, 140);
                const categorySelect = document.getElementById('historyCategory');
                const selectedCategory = categorySelect.value === 'all' ? 'All Categories' : categorySelect.options[categorySelect.selectedIndex].text;
                doc.text(`${historyData.startDate} to ${historyData.endDate} | ${selectedCategory}`, 14, 27);

                // Prepare table data
                const dates = historyData.data[0].rates.map(r => {
                    const date = new Date(r.date);
                    return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                });

                const tableHead = [['Product', 'Unit', ...dates]];
                const tableBody = historyData.data.map(product => {
                    const rates = product.rates.map(r => r.rate !== null ? r.rate.toFixed(2) : '-');
                    return [product.name, product.unit, ...rates];
                });

                // Generate table
                doc.autoTable({
                    startY: 32,
                    head: tableHead,
                    body: tableBody,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [46, 53, 50],
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: [31, 36, 33]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 40 },
                        1: { cellWidth: 20 }
                    },
                    alternateRowStyles: {
                        fillColor: [249, 247, 243]
                    },
                    margin: { left: 14, right: 14 }
                });

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(138, 145, 140);
                    doc.text(`Generated on ${new Date().toLocaleString('en-IN')} | Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10);
                }

                // Save the PDF
                const filename = `market-rates-${historyData.startDate}-to-${historyData.endDate}.pdf`;
                doc.save(filename);

                showToast('PDF exported successfully', 'success');
            } catch (e) {
                console.error('PDF export failed:', e);
                showToast('Could not export PDF', 'info');
            }
        }

        // Expose functions to window for inline handlers
        window.clearZero = clearZero;
        window.restoreValue = restoreValue;
        window.handleChange = handleChange;
        window.handleInput = handleInput;
        window.saveRates = saveRates;
        window.loadHistory = loadHistory;
        window.exportToPDF = exportToPDF;

        init();
    </script>
</body>
</html>
