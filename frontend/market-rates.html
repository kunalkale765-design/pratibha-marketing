<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Market Rates - Pratibha Marketing</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e3532">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Page-specific styles -->
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }

        .btn-back {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 0.5rem 0.875rem;
            border-radius: 6px;
            font-size: 0.8125rem;
            cursor: pointer;
            text-decoration: none;
        }

        /* Date Bar */
        .date-bar {
            background: var(--warm-white);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--cream-dark);
            text-align: center;
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        /* Product List */
        .product-list {
            padding: 0.5rem;
            padding-bottom: 100px;
        }

        .product-item {
            background: var(--warm-white);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            min-height: 60px;
        }

        .product-info {
            flex: 1;
            min-width: 0;
        }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gunmetal);
            line-height: 1.3;
        }

        .product-unit {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        .rate-input {
            width: 100px;
            padding: 0.75rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            text-align: right;
            background: white;
            -webkit-appearance: none;
            -moz-appearance: textfield;
        }

        .rate-input::-webkit-inner-spin-button,
        .rate-input::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .rate-input:focus {
            outline: none;
            border-color: var(--dusty-olive);
            box-shadow: 0 0 0 3px rgba(126, 145, 129, 0.15);
        }

        .rate-input.changed {
            border-color: var(--dusty-olive);
            background: rgba(126, 145, 129, 0.1);
        }

        /* Category Header */
        .category-header {
            padding: 0.625rem 0.5rem;
            font-family: 'Crimson Pro', serif;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 0.5rem;
        }

        /* Bottom Bar */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gunmetal);
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0,0,0,0.15);
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
        }

        .changes-count {
            font-size: 0.9375rem;
        }

        .btn-save {
            background: var(--dusty-olive);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 48px;
        }

        .btn-save:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .btn-save:not(:disabled):active {
            transform: scale(0.97);
        }

        .loading {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            .btn-back {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
            }

            .date-bar {
                padding: 0.625rem 0.75rem;
                font-size: 0.75rem;
            }

            .product-list {
                padding: 0.375rem;
            }

            .product-item {
                padding: 0.75rem;
                border-radius: 10px;
            }

            .product-name {
                font-size: 0.9375rem;
            }

            .product-unit {
                font-size: 0.6875rem;
            }

            .rate-input {
                width: 80px;
                height: 40px;
                font-size: 16px;
            }

            .bottom-bar {
                padding: 0.75rem;
            }

            .changes-count {
                font-size: 0.8125rem;
            }

            .btn-save {
                padding: 0.625rem 1rem;
                font-size: 0.875rem;
                min-height: 44px;
            }
        }

        /* Mobile */
        @media (max-width: 480px) {
            .btn-back {
                min-height: 44px;
                display: flex;
                align-items: center;
            }

            .rate-input {
                min-height: 44px;
            }
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .date-bar {
                padding: 1rem 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }

            .product-list {
                padding: 0.5rem 2rem;
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .product-item {
                margin-bottom: 0;
            }

            .bottom-bar {
                padding: 1rem 2rem;
            }
        }

        /* Large Desktop */
        @media (min-width: 1024px) {
            .product-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .product-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* History Section Styles */
        .history-section {
            padding: 1rem;
            padding-bottom: 180px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .history-card {
            background: var(--warm-white);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .history-header {
            background: var(--gunmetal);
            color: white;
            padding: 1.25rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .history-title {
            font-family: 'Crimson Pro', serif;
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .history-controls {
            display: flex;
            gap: 0.75rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .history-select {
            padding: 0.5rem 1rem;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 6px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-family: 'DM Sans', sans-serif;
            font-size: 0.875rem;
            cursor: pointer;
            min-height: 40px;
        }

        .history-select option {
            background: var(--gunmetal);
            color: white;
        }

        .btn-export {
            background: var(--terracotta);
            color: white;
            border: none;
            padding: 0.5rem 1.25rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-height: 40px;
            transition: transform 0.2s, background 0.2s;
        }

        .btn-export:hover {
            background: #b08f66;
        }

        .btn-export:active {
            transform: scale(0.97);
        }

        .history-content {
            padding: 1.5rem;
            overflow-x: auto;
        }

        .history-loading {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        .history-table th,
        .history-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--cream-dark);
        }

        .history-table th {
            background: var(--cream);
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        .history-table th:first-child {
            position: sticky;
            left: 0;
            z-index: 2;
        }

        .history-table td:first-child {
            font-weight: 600;
            color: var(--gunmetal);
            position: sticky;
            left: 0;
            background: var(--warm-white);
            min-width: 140px;
        }

        .history-table tr:hover td {
            background: var(--cream);
        }

        .history-table tr:hover td:first-child {
            background: var(--cream);
        }

        .rate-cell {
            font-family: 'JetBrains Mono', monospace;
            text-align: right;
            min-width: 80px;
        }

        .rate-cell.up {
            color: var(--success);
        }

        .rate-cell.down {
            color: #9a6565;
        }

        .rate-cell.stable {
            color: var(--text-muted);
        }

        .rate-null {
            color: var(--text-muted);
            font-style: italic;
        }

        .trend-indicator {
            font-size: 0.75rem;
            margin-left: 0.25rem;
        }

        .date-header {
            font-size: 0.7rem;
            white-space: nowrap;
        }

        .date-day {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        /* Mobile adjustments for history */
        @media (max-width: 480px) {
            .history-section {
                padding: 0.75rem;
                padding-bottom: 180px;
            }

            .history-header {
                padding: 1rem;
            }

            .history-title {
                font-size: 1.125rem;
            }

            .history-controls {
                width: 100%;
                justify-content: space-between;
            }

            .history-content {
                padding: 0.75rem;
            }

            .history-table th,
            .history-table td {
                padding: 0.5rem;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Pratibha <span>Marketing</span></a>
            <a href="/" class="btn-back">Dashboard</a>
        </div>
    </header>

    <div class="date-bar" id="dateBar">Loading...</div>

    <div id="toast" class="toast"></div>

    <div class="product-list" id="productList">
        <div class="loading">Loading products...</div>
    </div>

    <!-- 7-Day History Section -->
    <section class="history-section">
        <div class="history-card">
            <div class="history-header">
                <h2 class="history-title">7-Day Rate History</h2>
                <div class="history-controls">
                    <select id="historyCategory" class="history-select" onchange="loadHistory()">
                        <option value="all">All Categories</option>
                    </select>
                    <button class="btn-export" onclick="exportToPDF()">
                        <span>Export PDF</span>
                    </button>
                </div>
            </div>
            <div class="history-content" id="historyContent">
                <div class="history-loading">Loading history...</div>
            </div>
        </div>
    </section>

    <div class="bottom-bar">
        <div class="changes-count"><span id="changesCount">0</span> changed</div>
        <button class="btn-save" id="saveBtn" disabled onclick="saveRates()">Save Rates</button>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script type="module">
        import { escapeHtml } from '/js/utils.js';
        import { showToast } from '/js/ui.js';

        let products = [];
        let rates = {};
        let changedRates = {};
        let historyData = null;

        async function init() {
            const user = await Auth.requireAuth(['admin', 'staff']);
            if (!user) return;

            document.getElementById('dateBar').textContent = new Date().toLocaleDateString('en-IN', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });

            await loadData();
            await loadHistory();
        }

        async function loadData() {
            try {
                const [productsRes, ratesRes] = await Promise.all([
                    fetch('/api/products', { credentials: 'include' }),
                    fetch('/api/market-rates', { credentials: 'include' })
                ]);

                const productsData = await productsRes.json();
                const ratesData = await ratesRes.json();

                products = (productsData.data || []).filter(p => p.isActive);

                // Map rates by product ID
                (ratesData.data || []).forEach(rate => {
                    const pid = typeof rate.product === 'object' ? rate.product._id : rate.product;
                    rates[pid] = rate.rate;
                });

                renderProducts();
            } catch (e) {
                console.error(e);
                showToast('Failed to load data', 'error');
            }
        }

        function renderProducts() {
            const container = document.getElementById('productList');

            if (!products.length) {
                container.innerHTML = '<div class="loading">No products found</div>';
                return;
            }

            // Group by category
            const grouped = {};
            products.forEach(p => {
                const cat = p.category || 'other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            let html = '';
            for (const [cat, prods] of Object.entries(grouped)) {
                const catName = cat.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                html += `<div class="category-header">${escapeHtml(catName)}</div>`;

                prods.forEach(p => {
                    const currentRate = rates[p._id] || 0;
                    html += `
                        <div class="product-item">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(p.name)}</div>
                                <div class="product-unit">per ${escapeHtml(p.unit)}</div>
                            </div>
                            <input type="number" class="rate-input"
                                id="rate-${escapeHtml(p._id)}"
                                data-id="${escapeHtml(p._id)}"
                                data-original="${escapeHtml(String(currentRate))}"
                                value="${escapeHtml(String(currentRate))}"
                                min="0" step="0.01"
                                onfocus="clearZero(this)"
                                onblur="restoreValue(this)"
                                onchange="handleChange(this)"
                                oninput="handleInput(this)">
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        function clearZero(input) {
            input.dataset.prevValue = input.value;
            input.value = '';
            input.select();
        }

        function restoreValue(input) {
            if (input.value === '') {
                input.value = input.dataset.prevValue || input.dataset.original;
            }
            handleChange(input);
        }

        function handleInput(input) {
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value);
            input.classList.toggle('changed', current !== original);
        }

        function handleChange(input) {
            const id = input.dataset.id;
            const original = parseFloat(input.dataset.original);
            const current = parseFloat(input.value);

            if (current !== original && current > 0) {
                changedRates[id] = current;
                input.classList.add('changed');
            } else {
                delete changedRates[id];
                input.classList.remove('changed');
            }

            updateSaveButton();
        }

        function updateSaveButton() {
            const count = Object.keys(changedRates).length;
            document.getElementById('changesCount').textContent = count;
            document.getElementById('saveBtn').disabled = count === 0;
        }

        async function saveRates() {
            const btn = document.getElementById('saveBtn');
            btn.disabled = true;
            btn.textContent = 'Saving...';

            let success = 0, failed = 0;
            let firstError = null;
            const failedProducts = [];

            const headers = { 'Content-Type': 'application/json' };
            const csrfToken = Auth.getCsrfToken();
            if (csrfToken) {
                headers['X-CSRF-Token'] = csrfToken;
            }

            for (const [productId, rate] of Object.entries(changedRates)) {
                try {
                    const res = await fetch('/api/market-rates', {
                        method: 'POST',
                        headers,
                        credentials: 'include',
                        body: JSON.stringify({
                            product: productId,
                            rate: rate,
                            effectiveDate: new Date().toISOString()
                        })
                    });

                    if (res.ok) {
                        success++;
                        // Update the original value
                        const input = document.getElementById('rate-' + productId);
                        if (input) {
                            input.dataset.original = rate;
                            input.classList.remove('changed');
                        }
                        rates[productId] = rate;
                    } else {
                        failed++;
                        const errData = await res.json().catch(() => ({}));
                        const errorMsg = errData.message || `HTTP ${res.status}`;
                        console.error('Failed to save rate for product:', productId, errorMsg);
                        if (!firstError) firstError = errorMsg;
                        failedProducts.push(productId);
                    }
                } catch (e) {
                    failed++;
                    console.error('Failed to save rate for product:', productId, e.message);
                    if (!firstError) firstError = e.message || 'Network error';
                    failedProducts.push(productId);
                }
            }

            // Only clear rates that were successfully saved (keep failed ones for retry)
            const successfulRates = {};
            Object.keys(changedRates).forEach(pid => {
                if (failedProducts.includes(pid)) {
                    successfulRates[pid] = changedRates[pid];
                }
            });
            changedRates = successfulRates;
            updateSaveButton();

            btn.textContent = 'Save Rates';

            if (success > 0) {
                showToast(`${success} rate(s) saved`, 'success');
            }
            if (failed > 0) {
                showToast(`${failed} rate(s) failed: ${firstError}`, 'error');
            }
        }

        // History functions
        async function loadHistory() {
            const container = document.getElementById('historyContent');
            const categorySelect = document.getElementById('historyCategory');
            const selectedCategory = categorySelect.value;

            container.innerHTML = '<div class="history-loading">Loading history...</div>';

            try {
                const url = `/api/market-rates/history-summary?days=7${selectedCategory !== 'all' ? `&category=${encodeURIComponent(selectedCategory)}` : ''}`;
                const res = await fetch(url, { credentials: 'include' });

                if (!res.ok) {
                    throw new Error('Failed to load history');
                }

                const data = await res.json();
                historyData = data;

                // Populate category dropdown (only on first load)
                if (categorySelect.options.length <= 1 && data.categories) {
                    data.categories.forEach(cat => {
                        const option = document.createElement('option');
                        option.value = cat;
                        option.textContent = cat.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        categorySelect.appendChild(option);
                    });
                }

                renderHistory(data);
            } catch (e) {
                console.error('Failed to load history:', e);
                container.innerHTML = '<div class="history-loading">Failed to load history</div>';
            }
        }

        function renderHistory(data) {
            const container = document.getElementById('historyContent');

            if (!data.data || data.data.length === 0) {
                container.innerHTML = '<div class="history-loading">No history data available</div>';
                return;
            }

            // Build date headers
            const dates = data.data[0].rates.map(r => r.date);
            const dateHeaders = dates.map(dateStr => {
                const date = new Date(dateStr);
                const day = date.toLocaleDateString('en-IN', { weekday: 'short' });
                const formatted = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                return `<th class="date-header">${formatted}<span class="date-day">${day}</span></th>`;
            }).join('');

            // Build table rows
            const rows = data.data.map(product => {
                const rateCells = product.rates.map(r => {
                    if (r.rate === null) {
                        return '<td class="rate-cell rate-null">-</td>';
                    }
                    const trendClass = r.trend || 'stable';
                    const trendIcon = r.trend === 'up' ? '↑' : (r.trend === 'down' ? '↓' : '');
                    return `<td class="rate-cell ${trendClass}">${r.rate.toFixed(2)}${trendIcon ? `<span class="trend-indicator">${trendIcon}</span>` : ''}</td>`;
                }).join('');

                return `
                    <tr>
                        <td>${escapeHtml(product.name)}<br><small style="color: var(--text-muted); font-weight: 400;">per ${escapeHtml(product.unit)}</small></td>
                        ${rateCells}
                    </tr>
                `;
            }).join('');

            container.innerHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Product</th>
                            ${dateHeaders}
                        </tr>
                    </thead>
                    <tbody>
                        ${rows}
                    </tbody>
                </table>
            `;
        }

        function exportToPDF() {
            if (!historyData || !historyData.data || historyData.data.length === 0) {
                showToast('No data to export', 'error');
                return;
            }

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF({
                    orientation: 'landscape',
                    unit: 'mm',
                    format: 'a4'
                });

                // Title
                doc.setFontSize(18);
                doc.setTextColor(46, 53, 50);
                doc.text('Pratibha Marketing - 7-Day Market Rate History', 14, 20);

                // Subtitle with date range
                doc.setFontSize(10);
                doc.setTextColor(138, 145, 140);
                const categorySelect = document.getElementById('historyCategory');
                const selectedCategory = categorySelect.value === 'all' ? 'All Categories' : categorySelect.options[categorySelect.selectedIndex].text;
                doc.text(`${historyData.startDate} to ${historyData.endDate} | ${selectedCategory}`, 14, 27);

                // Prepare table data
                const dates = historyData.data[0].rates.map(r => {
                    const date = new Date(r.date);
                    return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });
                });

                const tableHead = [['Product', 'Unit', ...dates]];
                const tableBody = historyData.data.map(product => {
                    const rates = product.rates.map(r => r.rate !== null ? r.rate.toFixed(2) : '-');
                    return [product.name, product.unit, ...rates];
                });

                // Generate table
                doc.autoTable({
                    startY: 32,
                    head: tableHead,
                    body: tableBody,
                    theme: 'grid',
                    headStyles: {
                        fillColor: [46, 53, 50],
                        textColor: [255, 255, 255],
                        fontSize: 8,
                        fontStyle: 'bold'
                    },
                    bodyStyles: {
                        fontSize: 8,
                        textColor: [31, 36, 33]
                    },
                    columnStyles: {
                        0: { fontStyle: 'bold', cellWidth: 40 },
                        1: { cellWidth: 20 }
                    },
                    alternateRowStyles: {
                        fillColor: [249, 247, 243]
                    },
                    margin: { left: 14, right: 14 }
                });

                // Footer
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(138, 145, 140);
                    doc.text(`Generated on ${new Date().toLocaleString('en-IN')} | Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10);
                }

                // Save the PDF
                const filename = `market-rates-${historyData.startDate}-to-${historyData.endDate}.pdf`;
                doc.save(filename);

                showToast('PDF exported successfully', 'success');
            } catch (e) {
                console.error('PDF export failed:', e);
                showToast('Failed to export PDF', 'error');
            }
        }

        // Expose functions to window for inline handlers
        window.clearZero = clearZero;
        window.restoreValue = restoreValue;
        window.handleChange = handleChange;
        window.handleInput = handleInput;
        window.saveRates = saveRates;
        window.loadHistory = loadHistory;
        window.exportToPDF = exportToPDF;

        init();
    </script>
</body>
</html>
