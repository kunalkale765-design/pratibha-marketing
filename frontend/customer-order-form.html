<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order - Pratibha Marketing</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e3532">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- Page-specific styles -->
    <link rel="stylesheet" href="/css/pages/customer-order-form.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Pratibha <span>Marketing</span></a>
            <button class="btn-header" id="logoutBtn">Logout</button>
        </div>
    </header>

    <!-- Tab Navigation -->
    <div class="order-tabs">
        <button class="order-tab active" data-tab="new" id="newOrderTab">New Order</button>
        <button class="order-tab" data-tab="list" id="myOrdersTab">My Orders</button>
    </div>

    <!-- New Order View (existing content wrapped) -->
    <div id="newOrderView" class="order-view active">
        <div class="customer-bar" id="customerBar">
        <select id="customerSelect" class="customer-select">
            <option value="">Select Customer</option>
        </select>
    </div>

    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search products..." id="searchInput">
    </div>

    <div class="category-pills" id="categoryPills">
        <button class="cat-pill active" data-cat="all">All</button>
    </div>

    <div id="toast" class="toast"></div>

    <div class="product-list" id="productList">
        <div class="loading">Loading products...</div>
    </div>

        <div class="order-summary">
            <div class="summary-info">
                <div class="summary-stat">
                    <div class="value" id="itemCount">0</div>
                    <div class="label">Items</div>
                </div>
            </div>
            <input type="text" class="order-notes-input" id="orderNotes" placeholder="Add note (optional)..." maxlength="200">
            <button class="btn-order" id="orderBtn" disabled onclick="placeOrder()">
                Place Order
            </button>
        </div>
    </div><!-- End newOrderView -->

    <!-- My Orders View -->
    <div id="ordersListView" class="order-view">
        <div class="status-filters">
            <button class="status-pill active" data-status="all">All</button>
            <button class="status-pill" data-status="pending">Pending</button>
            <button class="status-pill" data-status="confirmed">Confirmed</button>
            <button class="status-pill" data-status="delivered">Delivered</button>
        </div>
        <div id="ordersContainer" class="orders-container">
            <div class="loading">Loading orders...</div>
        </div>
    </div>

    <!-- Order Detail/Edit Modal -->
    <div id="orderModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title" id="orderModalTitle"></h2>
                <button class="modal-close" onclick="closeOrderModal()">×</button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- Content rendered dynamically -->
            </div>
            <div class="modal-footer" id="orderModalFooter">
                <!-- Buttons rendered dynamically -->
            </div>
        </div>
    </div>

    <script type="module" src="/js/auth.js"></script>
    <script type="module" src="/js/api.js"></script>
    <script type="module">
        import { escapeHtml } from '/js/utils.js';
        import { showToast } from '/js/ui.js';
        import { logout } from '/js/init.js';

        // Wait for Auth to be available
        const waitForAuth = () => new Promise((resolve) => {
            if (window.Auth) resolve(window.Auth);
            else setTimeout(() => resolve(waitForAuth()), 10);
        });
        const Auth = await waitForAuth();

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Customer selector change
        document.getElementById('customerSelect').addEventListener('change', onCustomerChange);

        let currentUser = null;
        let selectedCustomer = null;
        let products = [];
        let marketRates = {};
        let customers = [];
        let isStaff = false;

        async function init() {
            // Check for magic link token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const magicToken = urlParams.get('token');

            if (magicToken) {
                // Authenticate via magic link
                try {
                    const res = await fetch(`/api/auth/magic/${magicToken}`, {
                        credentials: 'include'
                    });
                    const data = await res.json();

                    if (res.ok && data.user) {
                        currentUser = data.user;
                        Auth.setUser(data.user);
                        // Remove token from URL for cleaner bookmarking
                        window.history.replaceState({}, '', window.location.pathname);
                    } else {
                        showToast(data.message || 'Link expired. Please request a new one.', 'info');
                        window.location.href = '/login.html';
                        return;
                    }
                } catch (e) {
                    showToast('Authentication issue. Please refresh.', 'info');
                    window.location.href = '/login.html';
                    return;
                }
            } else {
                // Normal authentication
                currentUser = await Auth.verify();
                if (!currentUser) {
                    window.location.href = '/login.html';
                    return;
                }
            }

            isStaff = currentUser.role === 'admin' || currentUser.role === 'staff';
            await loadData();

            if (isStaff) {
                document.getElementById('customerBar').classList.add('show');
                populateCustomers();
            } else {
                if (currentUser.customer) {
                    selectedCustomer = typeof currentUser.customer === 'object'
                        ? currentUser.customer
                        : { _id: currentUser.customer, pricingType: 'market' };
                    renderProducts();
                } else {
                    document.getElementById('productList').innerHTML = '<div class="empty-state">Account setup in progress. Please check back later.</div>';
                }
            }
        }

        async function loadData() {
            try {
                const [productsRes, ratesRes, customersRes] = await Promise.all([
                    fetch('/api/products', { credentials: 'include' }),
                    fetch('/api/market-rates', { credentials: 'include' }),
                    fetch('/api/customers', { credentials: 'include' }).catch(() => ({ ok: false }))
                ]);

                if (productsRes.ok) {
                    const data = await productsRes.json();
                    products = (data?.data || []).filter(p => p.isActive !== false);
                }

                if (ratesRes.ok) {
                    const data = await ratesRes.json();
                    (data?.data || []).forEach(rate => {
                        const pid = typeof rate.product === 'object' ? rate.product._id : rate.product;
                        if (pid) marketRates[pid] = rate.rate;
                    });
                }

                if (customersRes.ok) {
                    const data = await customersRes.json();
                    customers = (data?.data || []).filter(c => c.isActive !== false);
                }
            } catch (e) {
                console.error('Failed to load data:', e);
                // Show retry UI instead of just a toast
                const productList = document.getElementById('productList');
                if (productList) {
                    productList.innerHTML = `
                        <div class="empty-state">
                            <p>Products not available</p>
                            <button onclick="loadData().then(() => { if (selectedCustomer) renderProducts(); })"
                                style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--dusty-olive); color: white; border: none; border-radius: 8px; cursor: pointer;">
                                Try Again
                            </button>
                        </div>
                    `;
                }
            }
        }

        function populateCustomers() {
            const select = document.getElementById('customerSelect');
            customers.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c._id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
        }

        function onCustomerChange() {
            const id = document.getElementById('customerSelect').value;
            selectedCustomer = customers.find(c => c._id === id) || null;
            if (selectedCustomer) {
                renderProducts();
            } else {
                document.getElementById('productList').innerHTML = '<div class="empty-state">Select a customer to start</div>';
            }
            updateSummary();
        }

        // Helper to safely get contract price (handles Map serialization edge cases)
        function getContractPrice(contractPrices, productId) {
            if (!contractPrices) return null;
            // Try direct property access (normal object)
            if (contractPrices[productId] !== undefined) {
                return contractPrices[productId];
            }
            // Try .get() in case it's still a Map-like structure
            if (typeof contractPrices.get === 'function') {
                return contractPrices.get(productId);
            }
            return null;
        }

        function getPrice(product) {
            if (!selectedCustomer) return marketRates[product._id] || 0;
            const type = selectedCustomer.pricingType || 'market';
            if (type === 'contract') {
                const contractPrice = getContractPrice(selectedCustomer.contractPrices, product._id);
                return contractPrice !== null ? contractPrice : (marketRates[product._id] || 0);
            } else if (type === 'markup') {
                const rate = marketRates[product._id] || 0;
                return Math.round(rate * (1 + (selectedCustomer.markupPercentage || 0) / 100));
            }
            return marketRates[product._id] || 0;
        }

        // Filter products for contract customers (only show products with contract prices)
        function getFilteredProducts() {
            // Staff/admin always see all products
            if (isStaff) {
                return products;
            }

            // Non-contract customers see all products
            if (!selectedCustomer || selectedCustomer.pricingType !== 'contract') {
                return products;
            }

            // Contract customers: filter to only products with contract prices
            const contractPrices = selectedCustomer.contractPrices || {};
            const contractProductIds = Object.keys(contractPrices);

            // If no contract prices configured, return empty array
            if (contractProductIds.length === 0) {
                return [];
            }

            return products.filter(p => contractProductIds.includes(p._id));
        }

        function buildCategoryPills(displayProducts = products) {
            const categories = [...new Set(displayProducts.map(p => p.category || 'Other'))];
            const container = document.getElementById('categoryPills');

            // Hide pills if no products or only one category
            if (displayProducts.length === 0 || categories.length <= 1) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'flex';
            container.innerHTML = '<button class="cat-pill active" data-cat="all">All</button>';

            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'cat-pill';
                btn.dataset.cat = cat;
                btn.textContent = cat;
                btn.onclick = () => filterByCategory(cat);
                container.appendChild(btn);
            });

            const allBtn = container.querySelector('[data-cat="all"]');
            if (allBtn) allBtn.onclick = () => filterByCategory('all');
        }

        function filterByCategory(cat) {
            document.querySelectorAll('.cat-pill').forEach(t => t.classList.remove('active'));
            const activeBtn = document.querySelector(`.cat-pill[data-cat="${cat}"]`);
            if (activeBtn) activeBtn.classList.add('active');

            document.querySelectorAll('.product-item').forEach(item => {
                item.style.display = (cat === 'all' || item.dataset.category === cat) ? '' : 'none';
            });

            document.querySelectorAll('.category-header').forEach(header => {
                header.style.display = (cat === 'all' || header.dataset.category === cat) ? '' : 'none';
            });
        }

        function renderProducts() {
            const container = document.getElementById('productList');

            // Get filtered products based on customer type
            const displayProducts = getFilteredProducts();

            if (!displayProducts.length) {
                // Different message for contract customers with no products configured
                const isContractWithNoProducts = selectedCustomer &&
                    selectedCustomer.pricingType === 'contract' &&
                    products.length > 0;

                const message = isContractWithNoProducts
                    ? 'No products configured for your account. Please contact us to set up pricing.'
                    : 'No products available';

                container.innerHTML = `<div class="empty-state">${message}</div>`;
                return;
            }

            buildCategoryPills(displayProducts);

            const grouped = {};
            displayProducts.forEach(p => {
                const cat = p.category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            let html = '';
            for (const [cat, prods] of Object.entries(grouped)) {
                html += `<div class="category-header" data-category="${cat}">${escapeHtml(cat)}</div>`;

                prods.forEach(p => {
                    const price = getPrice(p);
                    // Use step="1" for piece items to enforce whole numbers
                    const step = p.unit === 'piece' ? '1' : '0.01';
                    html += `
                        <div class="product-item" data-id="${p._id}" data-category="${cat}" data-price="${price}" data-unit="${escapeHtml(p.unit)}">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(p.name)}</div>
                                <div class="product-meta">${escapeHtml(p.unit)}</div>
                            </div>
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="changeQty('${p._id}', -1)">−</button>
                                <input type="number" class="qty-input" id="qty-${p._id}"
                                    value="0" min="0" step="${step}" inputmode="numeric"
                                    onfocus="clearZero(this)" onblur="restoreZero(this)"
                                    onchange="updateFromInput('${p._id}')">
                                <button class="qty-btn" onclick="changeQty('${p._id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // Expose qty functions to window for inline handlers
        window.clearZero = function(input) {
            if (input.value === '0') input.value = '';
            input.select();
        };

        window.restoreZero = function(input) {
            if (input.value === '') input.value = '0';
            window.updateFromInput(input.id.replace('qty-', ''));
        };

        window.changeQty = function(id, delta) {
            const input = document.getElementById('qty-' + id);
            let val = parseFloat(input.value) || 0;
            val = Math.max(0, val + delta);
            input.value = val;
            updateItem(id, val);
        };

        window.updateFromInput = function(id) {
            const input = document.getElementById('qty-' + id);
            const val = Math.max(0, parseFloat(input.value) || 0);
            input.value = val;
            updateItem(id, val);
        };

        function updateItem(id, qty) {
            const item = document.querySelector(`.product-item[data-id="${id}"]`);
            const input = document.getElementById('qty-' + id);

            if (qty > 0) {
                item.classList.add('has-qty');
                input.classList.add('has-value');
            } else {
                item.classList.remove('has-qty');
                input.classList.remove('has-value');
            }

            updateSummary();
        }

        function updateSummary() {
            let items = 0;

            document.querySelectorAll('.product-item').forEach(item => {
                const id = item.dataset.id;
                const input = document.getElementById('qty-' + id);
                const qty = parseFloat(input?.value) || 0;
                if (qty > 0) items++;
            });

            document.getElementById('itemCount').textContent = items;
            document.getElementById('orderBtn').disabled = items === 0 || !selectedCustomer;
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();

            document.querySelectorAll('.product-item').forEach(item => {
                const name = item.querySelector('.product-name').textContent.toLowerCase();
                item.style.display = name.includes(q) ? '' : 'none';
            });

            document.querySelectorAll('.category-header').forEach(header => {
                const cat = header.dataset.category;
                const hasVisible = [...document.querySelectorAll(`.product-item[data-category="${cat}"]`)]
                    .some(i => i.style.display !== 'none');
                header.style.display = hasVisible ? '' : 'none';
            });
        });

        // Expose placeOrder to window for inline handler
        window.placeOrder = async function() {
            if (!selectedCustomer) return;

            const orderProducts = [];
            const pieceErrors = [];

            document.querySelectorAll('.product-item').forEach(item => {
                const id = item.dataset.id;
                const input = document.getElementById('qty-' + id);
                const rawValue = parseFloat(input?.value) || 0;
                const qty = rawValue;
                const price = parseFloat(item.dataset.price) || 0;
                const unit = item.dataset.unit;
                const name = item.querySelector('.product-name')?.textContent || 'Unknown';

                if (qty > 0) {
                    // Validate piece quantities are whole numbers
                    if (unit === 'piece' && !Number.isInteger(qty)) {
                        pieceErrors.push(name);
                    }
                    // Only include rate if > 0; let backend calculate if not provided
                    const orderProduct = { product: id, quantity: qty };
                    if (price > 0) {
                        orderProduct.rate = price;
                    }
                    orderProducts.push(orderProduct);
                }
            });

            // Show info if piece items have decimal quantities
            if (pieceErrors.length > 0) {
                showToast(`${pieceErrors.join(', ')}: use whole numbers`, 'info');
                return;
            }

            if (!orderProducts.length) return;

            const btn = document.getElementById('orderBtn');
            btn.disabled = true;
            btn.textContent = 'Placing...';

            try {
                const headers = { 'Content-Type': 'application/json' };
                const csrfToken = await Auth.ensureCsrfToken();
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const notesInput = document.getElementById('orderNotes');
                const notes = notesInput?.value?.trim() || '';

                const orderPayload = {
                    customer: selectedCustomer._id,
                    products: orderProducts
                };

                if (notes) {
                    orderPayload.notes = notes;
                }

                let res = await fetch('/api/orders', {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify(orderPayload)
                });

                let data = await res.json();

                // Handle CSRF error with retry
                if (res.status === 403 && data?.message?.toLowerCase().includes('csrf')) {
                    const newToken = await Auth.refreshCsrfToken();
                    if (newToken) {
                        headers['X-CSRF-Token'] = newToken;
                        res = await fetch('/api/orders', {
                            method: 'POST',
                            headers,
                            credentials: 'include',
                            body: JSON.stringify(orderPayload)
                        });
                        data = await res.json();
                    }
                }

                if (res.ok) {
                    const orderNum = data?.data?.orderNumber || 'New';
                    showToast(`Order placed! #${orderNum}`, 'success');

                    // Show warning if contract pricing fallback was used
                    if (data.warning) {
                        setTimeout(() => {
                            showToast(data.warning, 'info');
                        }, 1500);
                    }

                    // Show confirmation if new contract prices were saved
                    if (data.message && data.newContractPrices && data.newContractPrices.length > 0) {
                        setTimeout(() => {
                            showToast(data.message, 'info');
                        }, data.warning ? 3000 : 1500); // Delay if warning shown first
                    }

                    document.querySelectorAll('.qty-input').forEach(input => {
                        input.value = '0';
                        input.classList.remove('has-value');
                    });
                    document.querySelectorAll('.product-item').forEach(item => {
                        item.classList.remove('has-qty');
                    });
                    // Clear notes field
                    if (notesInput) notesInput.value = '';
                    updateSummary();
                } else {
                    showToast(data.message || 'Could not place order', 'info');
                }
            } catch (e) {
                console.error('Order placement error:', e);
                if (!navigator.onLine) {
                    showToast('No internet connection', 'info');
                } else {
                    showToast('Could not place order. Try again.', 'info');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Place Order';
                updateSummary();
            }
        }

        // ====================
        // TAB MANAGEMENT
        // ====================
        let activeTab = 'new';

        function switchTab(tabName) {
            activeTab = tabName;

            // Update tab buttons
            document.querySelectorAll('.order-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabName);
            });

            // Update views
            document.querySelectorAll('.order-view').forEach(view => {
                view.classList.remove('active');
            });

            if (tabName === 'new') {
                document.getElementById('newOrderView').classList.add('active');
            } else if (tabName === 'list') {
                document.getElementById('ordersListView').classList.add('active');
                loadMyOrders();
            }
        }

        document.getElementById('newOrderTab').addEventListener('click', () => switchTab('new'));
        document.getElementById('myOrdersTab').addEventListener('click', () => switchTab('list'));

        // ====================
        // ORDERS LIST
        // ====================
        let myOrders = [];
        let currentStatusFilter = 'all';

        async function loadMyOrders() {
            const container = document.getElementById('ordersContainer');
            container.innerHTML = '<div class="loading">Loading orders...</div>';

            try {
                const res = await fetch('/api/orders', { credentials: 'include' });
                const data = await res.json();

                if (res.ok) {
                    myOrders = data.data || [];
                    renderOrdersList();
                } else {
                    container.innerHTML = `<div class="empty-state">${escapeHtml(data.message || 'Orders not available')}</div>`;
                }
            } catch (e) {
                console.error('Load orders error:', e);
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Orders not available</p>
                        <button onclick="loadMyOrders()"
                            style="margin-top: 1rem; padding: 0.5rem 1rem; background: var(--dusty-olive); color: white; border: none; border-radius: 8px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }

        function renderOrdersList() {
            const container = document.getElementById('ordersContainer');

            let filtered = myOrders;
            if (currentStatusFilter !== 'all') {
                filtered = myOrders.filter(o => o.status === currentStatusFilter);
            }

            if (!filtered.length) {
                container.innerHTML = '<div class="empty-state">No orders found</div>';
                return;
            }

            let html = '';
            filtered.forEach(order => {
                const date = new Date(order.createdAt).toLocaleDateString('en-IN', {
                    month: 'short', day: 'numeric', year: 'numeric'
                });

                html += `
                    <div class="order-card" onclick="openOrderDetail('${order._id}')">
                        <div class="order-top">
                            <div class="order-number">${escapeHtml(order.orderNumber)}</div>
                            <div class="order-products-summary">
                                ${order.products.length} item${order.products.length !== 1 ? 's' : ''}
                            </div>
                        </div>
                        <div class="order-bottom">
                            <div class="order-date">${date}</div>
                            <div class="order-badges">
                                <span class="badge badge-${order.status}">${order.status}</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        function filterOrdersByStatus(status) {
            currentStatusFilter = status;

            document.querySelectorAll('.status-pill').forEach(pill => {
                pill.classList.toggle('active', pill.dataset.status === status);
            });

            renderOrdersList();
        }

        // Setup filter event listeners
        document.querySelectorAll('.status-pill').forEach(pill => {
            pill.addEventListener('click', () => filterOrdersByStatus(pill.dataset.status));
        });

        // ====================
        // ORDER DETAIL/EDIT MODAL
        // ====================
        let currentOrder = null;
        let editedProducts = [];
        let orderInvoices = [];

        window.openOrderDetail = async function(orderId) {
            try {
                // Fetch order and invoices in parallel
                const [orderRes, invoicesRes] = await Promise.all([
                    fetch(`/api/orders/${orderId}`, { credentials: 'include' }),
                    fetch(`/api/invoices/my-order/${orderId}`, { credentials: 'include' })
                ]);

                const orderData = await orderRes.json();

                if (orderRes.ok && orderData.data) {
                    currentOrder = orderData.data;
                    editedProducts = JSON.parse(JSON.stringify(currentOrder.products || []));

                    // Load invoices (don't fail if invoice endpoint errors)
                    try {
                        const invoicesData = await invoicesRes.json();
                        orderInvoices = invoicesRes.ok ? (invoicesData.data || []) : [];
                    } catch {
                        orderInvoices = [];
                    }

                    renderOrderModal();
                    document.getElementById('orderModal').classList.add('show');
                    document.body.style.overflow = 'hidden';
                } else {
                    showToast(orderData.message || 'Could not load order', 'info');
                }
            } catch (e) {
                console.error('Load order detail error:', e);
                showToast('Could not load details', 'info');
            }
        }

        window.closeOrderModal = function() {
            document.getElementById('orderModal').classList.remove('show');
            document.body.style.overflow = '';
            currentOrder = null;
            editedProducts = [];
            orderInvoices = [];
        }

        function renderOrderModal() {
            const isPending = currentOrder.status === 'pending';
            const titleEl = document.getElementById('orderModalTitle');
            const bodyEl = document.getElementById('orderModalBody');
            const footerEl = document.getElementById('orderModalFooter');

            titleEl.textContent = currentOrder.orderNumber;

            // Render body
            let bodyHtml = `
                <div class="order-info-section">
                    <div class="order-info-grid">
                        <div>
                            <div class="info-label">Status</div>
                            <span class="badge badge-${currentOrder.status}">${currentOrder.status}</span>
                        </div>
                        <div>
                            <div class="info-label">Date</div>
                            <div class="info-value">${new Date(currentOrder.createdAt).toLocaleDateString('en-IN', {
                                month: 'short', day: 'numeric', year: 'numeric'
                            })}</div>
                        </div>
                    </div>
                    ${currentOrder.deliveryAddress ? `
                        <div style="margin-top: 1rem;">
                            <div class="info-label">Delivery Address</div>
                            <div class="info-value">${escapeHtml(currentOrder.deliveryAddress)}</div>
                        </div>
                    ` : ''}
                    ${currentOrder.notes ? `
                        <div style="margin-top: 1rem;">
                            <div class="info-label">Notes</div>
                            <div class="info-value">${escapeHtml(currentOrder.notes)}</div>
                        </div>
                    ` : ''}
                </div>

                <div class="divider"></div>

                <div class="info-label" style="margin-bottom: 0.5rem;">Products</div>
                <div id="orderProductsList">
                    ${renderOrderProducts(isPending)}
                </div>

                ${orderInvoices.length > 0 ? `
                    <div class="divider"></div>
                    <div class="info-label" style="margin-bottom: 0.5rem;">Invoices</div>
                    <div class="invoices-list">
                        ${orderInvoices.map(inv => `
                            <div class="invoice-item" onclick="downloadInvoice('${escapeHtml(inv.invoiceNumber)}')">
                                <div class="invoice-info">
                                    <div class="invoice-number">${escapeHtml(inv.invoiceNumber)}</div>
                                    <div class="invoice-meta">${escapeHtml(inv.firm?.name || 'Unknown Firm')} • ${new Date(inv.generatedAt).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })}</div>
                                </div>
                                <div class="invoice-download">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                        <polyline points="7 10 12 15 17 10"/>
                                        <line x1="12" y1="15" x2="12" y2="3"/>
                                    </svg>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
            `;

            bodyEl.innerHTML = bodyHtml;

            // Render footer
            if (isPending) {
                footerEl.innerHTML = `
                    <button class="btn btn-secondary" onclick="closeOrderModal()">Cancel</button>
                    <button class="btn btn-primary" style="flex: 1;" onclick="saveOrderEdit()">Save Changes</button>
                `;
            } else {
                footerEl.innerHTML = `
                    <button class="btn btn-primary btn-block" onclick="closeOrderModal()">Close</button>
                `;
            }
        }

        function renderOrderProducts(editable) {
            let html = '';

            editedProducts.forEach((item, index) => {
                if (editable) {
                    html += `
                        <div class="product-item-edit" data-index="${index}">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(item.productName)}</div>
                                <div class="product-meta">${item.unit}</div>
                            </div>
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="changeOrderQty(${index}, -1)">−</button>
                                <input type="number" class="qty-input" id="order-qty-${index}"
                                    value="${item.quantity}" min="0" inputmode="numeric"
                                    onchange="updateOrderQtyFromInput(${index})">
                                <button class="qty-btn" onclick="changeOrderQty(${index}, 1)">+</button>
                            </div>
                        </div>
                    `;
                } else {
                    html += `
                        <div class="product-item-edit readonly">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(item.productName)}</div>
                                <div class="product-meta">${item.quantity} ${item.unit}</div>
                            </div>
                        </div>
                    `;
                }
            });

            return html;
        }

        window.changeOrderQty = function(index, delta) {
            const input = document.getElementById(`order-qty-${index}`);
            let val = parseFloat(input.value) || 0;
            val = Math.max(0, val + delta);
            input.value = val;
            editedProducts[index].quantity = val;
        }

        window.updateOrderQtyFromInput = function(index) {
            const input = document.getElementById(`order-qty-${index}`);
            const val = Math.max(0, parseFloat(input.value) || 0);
            input.value = val;
            editedProducts[index].quantity = val;
        }

        window.downloadInvoice = async function(invoiceNumber) {
            try {
                showToast('Downloading invoice...', 'info');

                const res = await fetch(`/api/invoices/my/${invoiceNumber}/download`, {
                    credentials: 'include'
                });

                if (!res.ok) {
                    // Try to parse error message from JSON, fallback to status text
                    let errorMessage = 'Invoice not ready yet';
                    try {
                        const error = await res.json();
                        errorMessage = error.message || errorMessage;
                    } catch {
                        // Response might not be JSON
                        errorMessage = res.status === 404 ? 'Invoice not ready yet' :
                                      res.status === 403 ? 'Invoice access pending' :
                                      'Invoice temporarily unavailable';
                    }
                    throw new Error(errorMessage);
                }

                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${invoiceNumber}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showToast('Invoice downloaded!', 'success');
            } catch (e) {
                console.error('Download invoice error:', e);
                showToast(e.message || 'Could not download', 'info');
            }
        }

        window.saveOrderEdit = async function() {
            try {
                // Filter out zero-quantity items
                const products = editedProducts
                    .filter(p => p.quantity > 0)
                    .map(p => ({
                        product: typeof p.product === 'object' ? p.product._id : p.product,
                        quantity: p.quantity
                    }));

                if (!products.length) {
                    showToast('Add at least one product', 'info');
                    return;
                }

                const saveBtn = document.querySelector('#orderModalFooter .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.textContent = 'Saving...';
                }

                const headers = { 'Content-Type': 'application/json' };
                const csrfToken = await Auth.ensureCsrfToken();
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const payload = { products };

                let res = await fetch(`/api/orders/${currentOrder._id}/customer-edit`, {
                    method: 'PUT',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify(payload)
                });

                let data = await res.json();

                // Handle CSRF retry
                if (res.status === 403 && data?.message?.toLowerCase().includes('csrf')) {
                    const newToken = await Auth.refreshCsrfToken();
                    if (newToken) {
                        headers['X-CSRF-Token'] = newToken;
                        res = await fetch(`/api/orders/${currentOrder._id}/customer-edit`, {
                            method: 'PUT',
                            headers,
                            credentials: 'include',
                            body: JSON.stringify(payload)
                        });
                        data = await res.json();
                    }
                }

                if (res.ok) {
                    showToast('Order updated successfully', 'success');
                    closeOrderModal();
                    loadMyOrders(); // Refresh list
                } else {
                    showToast(data.message || 'Could not update', 'info');
                }
            } catch (e) {
                console.error('Order edit error:', e);
                if (!navigator.onLine) {
                    showToast('No internet connection', 'info');
                } else {
                    showToast('Could not update. Try again.', 'info');
                }
            } finally {
                const saveBtn = document.querySelector('#orderModalFooter .btn-primary');
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.textContent = 'Save Changes';
                }
            }
        }

        // Close modal on overlay click
        document.getElementById('orderModal').addEventListener('click', (e) => {
            if (e.target.id === 'orderModal') {
                closeOrderModal();
            }
        });

        // Close modal on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('orderModal').classList.contains('show')) {
                closeOrderModal();
            }
        });

        init();
    </script>
</body>
</html>
