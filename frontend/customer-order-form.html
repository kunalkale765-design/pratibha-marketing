<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Order - Pratibha Marketing</title>
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2e3532">

    <!-- Shared CSS -->
    <link rel="stylesheet" href="/css/variables.css">
    <link rel="stylesheet" href="/css/base.css">
    <link rel="stylesheet" href="/css/components.css">
    <link rel="stylesheet" href="/css/utilities.css">
    <link rel="stylesheet" href="/css/responsive.css">

    <!-- Page-specific styles -->
    <style>
        body {
            -webkit-tap-highlight-color: transparent;
        }

        /* Customer Selector */
        .customer-bar {
            background: var(--warm-white);
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--cream-dark);
            display: none;
        }

        .customer-bar.show { display: block; }

        .customer-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--cream);
            min-height: 48px;
        }

        .customer-select:focus {
            outline: none;
            border-color: var(--dusty-olive);
        }

        /* Search */
        .search-bar {
            padding: 0.75rem 1rem;
            background: var(--warm-white);
            border-bottom: 1px solid var(--cream-dark);
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--cream);
            min-height: 48px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--dusty-olive);
        }

        /* Category Pills */
        .category-pills {
            display: flex;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            background: var(--warm-white);
            border-bottom: 1px solid var(--cream-dark);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .category-pills::-webkit-scrollbar { display: none; }

        .cat-pill {
            flex-shrink: 0;
            padding: 0.5rem 1rem;
            border: 1.5px solid var(--cream-dark);
            border-radius: 20px;
            background: var(--cream);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            cursor: pointer;
            min-height: 40px;
            display: flex;
            align-items: center;
        }

        .cat-pill.active {
            background: var(--gunmetal);
            color: white;
            border-color: var(--gunmetal);
        }

        /* Product List */
        .product-list {
            padding: 0.5rem;
            padding-bottom: calc(100px + env(safe-area-inset-bottom));
        }

        .category-header {
            padding: 0.75rem 0.5rem 0.5rem;
            font-family: 'Crimson Pro', serif;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-item {
            background: var(--warm-white);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            border: 2px solid transparent;
        }

        .product-item.has-qty {
            background: rgba(126, 145, 129, 0.1);
            border-color: var(--dusty-olive);
        }

        .product-info { flex: 1; min-width: 0; }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
            color: var(--gunmetal);
        }

        .product-meta {
            font-size: 0.8125rem;
            color: var(--text-muted);
            margin-top: 0.125rem;
        }

        /* Quantity Controls */
        .qty-controls {
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .qty-btn {
            width: 44px;
            height: 44px;
            border: none;
            border-radius: 10px;
            background: var(--cream);
            font-size: 1.5rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gunmetal);
        }

        .qty-btn:active {
            background: var(--dusty-olive);
            color: white;
        }

        .qty-input {
            width: 56px;
            height: 44px;
            text-align: center;
            border: 2px solid var(--cream-dark);
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.125rem;
            font-weight: 600;
            background: white;
            color: var(--gunmetal);
            -moz-appearance: textfield;
        }

        .qty-input::-webkit-outer-spin-button,
        .qty-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .qty-input:focus {
            outline: none;
            border-color: var(--dusty-olive);
        }

        .qty-input.has-value {
            background: var(--dusty-olive);
            color: white;
            border-color: var(--dusty-olive);
        }

        /* Bottom Summary */
        .order-summary {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--gunmetal);
            color: white;
            padding: 1rem;
            padding-bottom: calc(1rem + env(safe-area-inset-bottom));
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 100;
        }

        .summary-info {
            display: flex;
            gap: 1.5rem;
        }

        .summary-stat .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .summary-stat .label {
            font-size: 0.6875rem;
            opacity: 0.7;
            text-transform: uppercase;
        }

        .btn-order {
            background: var(--dusty-olive);
            color: white;
            border: none;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            min-height: 52px;
        }

        .btn-order:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* States */
        .loading, .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-muted);
        }

        /* Extra small screens */
        @media (max-width: 360px) {
            .header {
                padding: 0.75rem;
            }

            .logo {
                font-size: 1.125rem;
            }

            .btn-logout {
                padding: 0.375rem 0.625rem;
                font-size: 0.75rem;
                min-height: 40px;
            }

            .search-bar, .category-pills, .customer-bar {
                padding: 0.5rem 0.75rem;
            }

            .search-input, .customer-select {
                padding: 0.625rem 0.875rem;
                font-size: 16px;
                min-height: 44px;
            }

            .cat-pill {
                padding: 0.375rem 0.75rem;
                font-size: 0.8125rem;
                min-height: 36px;
            }

            .product-list {
                padding: 0.375rem;
            }

            .product-item {
                padding: 0.75rem;
                border-radius: 10px;
            }

            .product-name {
                font-size: 0.9375rem;
            }

            .product-meta {
                font-size: 0.75rem;
            }

            .qty-btn {
                width: 40px;
                height: 40px;
                font-size: 1.25rem;
            }

            .qty-input {
                width: 48px;
                height: 40px;
                font-size: 1rem;
            }

            .summary-stat .value {
                font-size: 1.25rem;
            }

            .btn-order {
                padding: 0.75rem 1rem;
                font-size: 0.9375rem;
                min-height: 48px;
            }
        }

        /* Tablet and Desktop */
        @media (min-width: 768px) {
            .header {
                padding: 1rem 2rem;
            }

            .header-content {
                max-width: 1200px;
                margin: 0 auto;
            }

            .logo {
                font-size: 1.5rem;
            }

            .search-bar, .category-pills, .customer-bar {
                padding: 1rem 2rem;
                max-width: 1200px;
                margin: 0 auto;
            }

            .product-list {
                padding: 1rem 2rem;
                padding-bottom: calc(120px + env(safe-area-inset-bottom));
                max-width: 1200px;
                margin: 0 auto;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
            }

            .category-header {
                grid-column: 1 / -1;
            }

            .product-item {
                margin-bottom: 0;
            }

            .order-summary {
                padding: 1.25rem 2rem;
            }

            .summary-info {
                gap: 2rem;
            }

            .btn-order {
                padding: 1rem 2rem;
            }
        }

        /* Large Desktop */
        @media (min-width: 1024px) {
            .product-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <a href="/" class="logo">Pratibha <span>Marketing</span></a>
            <button class="btn-header" id="logoutBtn">Logout</button>
        </div>
    </header>

    <div class="customer-bar" id="customerBar">
        <select id="customerSelect" class="customer-select">
            <option value="">Select Customer</option>
        </select>
    </div>

    <div class="search-bar">
        <input type="text" class="search-input" placeholder="Search products..." id="searchInput">
    </div>

    <div class="category-pills" id="categoryPills">
        <button class="cat-pill active" data-cat="all">All</button>
    </div>

    <div id="toast" class="toast"></div>

    <div class="product-list" id="productList">
        <div class="loading">Loading products...</div>
    </div>

    <div class="order-summary">
        <div class="summary-info">
            <div class="summary-stat">
                <div class="value" id="itemCount">0</div>
                <div class="label">Items</div>
            </div>
        </div>
        <button class="btn-order" id="orderBtn" disabled onclick="placeOrder()">
            Place Order
        </button>
    </div>

    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script type="module">
        import { escapeHtml } from '/js/utils.js';
        import { showToast } from '/js/ui.js';
        import { logout } from '/js/init.js';

        // Logout button
        document.getElementById('logoutBtn').addEventListener('click', logout);

        // Customer selector change
        document.getElementById('customerSelect').addEventListener('change', onCustomerChange);

        let currentUser = null;
        let selectedCustomer = null;
        let products = [];
        let marketRates = {};
        let customers = [];
        let isStaff = false;

        async function init() {
            // Check for magic link token in URL
            const urlParams = new URLSearchParams(window.location.search);
            const magicToken = urlParams.get('token');

            if (magicToken) {
                // Authenticate via magic link
                try {
                    const res = await fetch(`/api/auth/magic/${magicToken}`, {
                        credentials: 'include'
                    });
                    const data = await res.json();

                    if (res.ok && data.user) {
                        currentUser = data.user;
                        Auth.setUser(data.user);
                        // Remove token from URL for cleaner bookmarking
                        window.history.replaceState({}, '', window.location.pathname);
                    } else {
                        showToast(data.message || 'Invalid magic link', 'error');
                        window.location.href = '/login.html';
                        return;
                    }
                } catch (e) {
                    showToast('Failed to authenticate', 'error');
                    window.location.href = '/login.html';
                    return;
                }
            } else {
                // Normal authentication
                currentUser = await Auth.verify();
                if (!currentUser) {
                    window.location.href = '/login.html';
                    return;
                }
            }

            isStaff = currentUser.role === 'admin' || currentUser.role === 'staff';
            await loadData();

            if (isStaff) {
                document.getElementById('customerBar').classList.add('show');
                populateCustomers();
            } else {
                if (currentUser.customer) {
                    selectedCustomer = typeof currentUser.customer === 'object'
                        ? currentUser.customer
                        : { _id: currentUser.customer, pricingType: 'market' };
                    renderProducts();
                } else {
                    document.getElementById('productList').innerHTML = '<div class="empty-state">Account not linked. Contact support.</div>';
                }
            }
        }

        async function loadData() {
            try {
                const [productsRes, ratesRes, customersRes] = await Promise.all([
                    fetch('/api/products', { credentials: 'include' }),
                    fetch('/api/market-rates', { credentials: 'include' }),
                    fetch('/api/customers', { credentials: 'include' }).catch(() => ({ ok: false }))
                ]);

                if (productsRes.ok) {
                    const data = await productsRes.json();
                    products = data.data.filter(p => p.isActive !== false);
                }

                if (ratesRes.ok) {
                    const data = await ratesRes.json();
                    data.data.forEach(rate => {
                        const pid = typeof rate.product === 'object' ? rate.product._id : rate.product;
                        marketRates[pid] = rate.rate;
                    });
                }

                if (customersRes.ok) {
                    const data = await customersRes.json();
                    customers = data.data.filter(c => c.isActive !== false);
                }
            } catch (e) {
                console.error('Failed to load data:', e);
                // Provide more specific error message
                if (!navigator.onLine) {
                    showToast('No internet connection. Please check your network.', 'error');
                } else {
                    showToast('Failed to load products. Please refresh the page.', 'error');
                }
            }
        }

        function populateCustomers() {
            const select = document.getElementById('customerSelect');
            customers.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c._id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });
        }

        function onCustomerChange() {
            const id = document.getElementById('customerSelect').value;
            selectedCustomer = customers.find(c => c._id === id) || null;
            if (selectedCustomer) {
                renderProducts();
            } else {
                document.getElementById('productList').innerHTML = '<div class="empty-state">Select a customer to start</div>';
            }
            updateSummary();
        }

        function getPrice(product) {
            if (!selectedCustomer) return marketRates[product._id] || 0;
            const type = selectedCustomer.pricingType || 'market';
            if (type === 'contract') {
                return selectedCustomer.contractPrices?.[product._id] || marketRates[product._id] || 0;
            } else if (type === 'markup') {
                const rate = marketRates[product._id] || 0;
                return Math.round(rate * (1 + (selectedCustomer.markupPercentage || 0) / 100));
            }
            return marketRates[product._id] || 0;
        }

        function buildCategoryPills() {
            const categories = [...new Set(products.map(p => p.category || 'Other'))];
            const container = document.getElementById('categoryPills');
            container.innerHTML = '<button class="cat-pill active" data-cat="all">All</button>';

            categories.forEach(cat => {
                const btn = document.createElement('button');
                btn.className = 'cat-pill';
                btn.dataset.cat = cat;
                btn.textContent = cat;
                btn.onclick = () => filterByCategory(cat);
                container.appendChild(btn);
            });

            container.querySelector('[data-cat="all"]').onclick = () => filterByCategory('all');
        }

        function filterByCategory(cat) {
            document.querySelectorAll('.cat-pill').forEach(t => t.classList.remove('active'));
            document.querySelector(`.cat-pill[data-cat="${cat}"]`).classList.add('active');

            document.querySelectorAll('.product-item').forEach(item => {
                item.style.display = (cat === 'all' || item.dataset.category === cat) ? '' : 'none';
            });

            document.querySelectorAll('.category-header').forEach(header => {
                header.style.display = (cat === 'all' || header.dataset.category === cat) ? '' : 'none';
            });
        }

        function renderProducts() {
            const container = document.getElementById('productList');

            if (!products.length) {
                container.innerHTML = '<div class="empty-state">No products available</div>';
                return;
            }

            buildCategoryPills();

            const grouped = {};
            products.forEach(p => {
                const cat = p.category || 'Other';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(p);
            });

            let html = '';
            for (const [cat, prods] of Object.entries(grouped)) {
                html += `<div class="category-header" data-category="${cat}">${escapeHtml(cat)}</div>`;

                prods.forEach(p => {
                    const price = getPrice(p);
                    html += `
                        <div class="product-item" data-id="${p._id}" data-category="${cat}" data-price="${price}">
                            <div class="product-info">
                                <div class="product-name">${escapeHtml(p.name)}</div>
                                <div class="product-meta">₹${price}/${escapeHtml(p.unit)}</div>
                            </div>
                            <div class="qty-controls">
                                <button class="qty-btn" onclick="changeQty('${p._id}', -1)">−</button>
                                <input type="number" class="qty-input" id="qty-${p._id}"
                                    value="0" min="0" inputmode="numeric"
                                    onfocus="clearZero(this)" onblur="restoreZero(this)"
                                    onchange="updateFromInput('${p._id}')">
                                <button class="qty-btn" onclick="changeQty('${p._id}', 1)">+</button>
                            </div>
                        </div>
                    `;
                });
            }

            container.innerHTML = html;
        }

        // Expose qty functions to window for inline handlers
        window.clearZero = function(input) {
            if (input.value === '0') input.value = '';
            input.select();
        };

        window.restoreZero = function(input) {
            if (input.value === '') input.value = '0';
            window.updateFromInput(input.id.replace('qty-', ''));
        };

        window.changeQty = function(id, delta) {
            const input = document.getElementById('qty-' + id);
            let val = parseInt(input.value) || 0;
            val = Math.max(0, val + delta);
            input.value = val;
            updateItem(id, val);
        };

        window.updateFromInput = function(id) {
            const input = document.getElementById('qty-' + id);
            const val = Math.max(0, parseInt(input.value) || 0);
            input.value = val;
            updateItem(id, val);
        };

        function updateItem(id, qty) {
            const item = document.querySelector(`.product-item[data-id="${id}"]`);
            const input = document.getElementById('qty-' + id);

            if (qty > 0) {
                item.classList.add('has-qty');
                input.classList.add('has-value');
            } else {
                item.classList.remove('has-qty');
                input.classList.remove('has-value');
            }

            updateSummary();
        }

        function updateSummary() {
            let items = 0;

            document.querySelectorAll('.product-item').forEach(item => {
                const id = item.dataset.id;
                const input = document.getElementById('qty-' + id);
                const qty = parseInt(input?.value) || 0;
                if (qty > 0) items++;
            });

            document.getElementById('itemCount').textContent = items;
            document.getElementById('orderBtn').disabled = items === 0 || !selectedCustomer;
        }

        // Search
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const q = e.target.value.toLowerCase();

            document.querySelectorAll('.product-item').forEach(item => {
                const name = item.querySelector('.product-name').textContent.toLowerCase();
                item.style.display = name.includes(q) ? '' : 'none';
            });

            document.querySelectorAll('.category-header').forEach(header => {
                const cat = header.dataset.category;
                const hasVisible = [...document.querySelectorAll(`.product-item[data-category="${cat}"]`)]
                    .some(i => i.style.display !== 'none');
                header.style.display = hasVisible ? '' : 'none';
            });
        });

        // Expose placeOrder to window for inline handler
        window.placeOrder = async function() {
            if (!selectedCustomer) return;

            const orderProducts = [];
            document.querySelectorAll('.product-item').forEach(item => {
                const id = item.dataset.id;
                const qty = parseInt(document.getElementById('qty-' + id)?.value) || 0;
                const price = parseFloat(item.dataset.price) || 0;
                if (qty > 0) {
                    orderProducts.push({ product: id, quantity: qty, rate: price });
                }
            });

            if (!orderProducts.length) return;

            const btn = document.getElementById('orderBtn');
            btn.disabled = true;
            btn.textContent = 'Placing...';

            try {
                const headers = { 'Content-Type': 'application/json' };
                const csrfToken = Auth.getCsrfToken();
                if (csrfToken) {
                    headers['X-CSRF-Token'] = csrfToken;
                }

                const res = await fetch('/api/orders', {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        customer: selectedCustomer._id,
                        products: orderProducts
                    })
                });

                const data = await res.json();

                if (res.ok) {
                    showToast(`Order placed! #${data.data.orderNumber}`, 'success');
                    document.querySelectorAll('.qty-input').forEach(input => {
                        input.value = '0';
                        input.classList.remove('has-value');
                    });
                    document.querySelectorAll('.product-item').forEach(item => {
                        item.classList.remove('has-qty');
                    });
                    updateSummary();
                } else {
                    showToast(data.message || 'Failed to place order', 'error');
                }
            } catch (e) {
                console.error('Order placement error:', e);
                if (!navigator.onLine) {
                    showToast('No internet connection', 'error');
                } else {
                    showToast('Failed to place order. Please try again.', 'error');
                }
            } finally {
                btn.disabled = false;
                btn.textContent = 'Place Order';
                updateSummary();
            }
        }

        init();
    </script>
</body>
</html>
