<!DOCTYPE html>
<html class="light" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Customer Management - Pratibha Marketing</title>
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#13ec13",
                        "background-light": "#f6f8f6",
                        "background-dark": "#102210",
                    },
                    fontFamily: {
                        "display": ["Work Sans", "sans-serif"]
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-gray-900 dark:text-gray-100">
    <div class="max-w-6xl mx-auto p-6">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold mb-2">Customer Management</h1>
                <p class="text-gray-600 dark:text-gray-400">Manage customers and personalized pricing</p>
            </div>
            <button onclick="showAddCustomerForm()" class="px-6 py-3 bg-primary text-black rounded-lg font-bold">
                Add Customer
            </button>
        </div>

        <!-- Search Bar -->
        <div class="mb-6">
            <input id="searchInput" type="text" placeholder="Search customers..."
                   class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900"
                   oninput="searchCustomers()">
        </div>

        <!-- Customers List -->
        <div id="customersList" class="grid gap-4">
            <!-- Customers will be loaded here -->
        </div>

        <!-- Add/Edit Customer Modal -->
        <div id="customerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="bg-white dark:bg-gray-800 rounded-xl p-6 max-w-md w-full mx-4">
                <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add Customer</h2>
                <form id="customerForm" class="space-y-4">
                    <input type="hidden" id="customerId">
                    <div>
                        <label class="block text-sm font-medium mb-2">Name *</label>
                        <input id="customerName" type="text" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Phone *</label>
                        <input id="customerPhone" type="tel" pattern="[0-9]{10}" required class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">WhatsApp</label>
                        <input id="customerWhatsapp" type="tel" pattern="[0-9]{10}" class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Address</label>
                        <textarea id="customerAddress" rows="2" class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900"></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-2">Credit Limit</label>
                        <input id="customerCreditLimit" type="number" step="0.01" value="0" class="w-full p-3 rounded-lg border border-gray-300 dark:border-gray-700 dark:bg-gray-900">
                    </div>
                    <div class="flex gap-4 pt-4">
                        <button type="submit" class="flex-1 py-3 bg-primary text-black rounded-lg font-bold">Save</button>
                        <button type="button" onclick="closeModal()" class="px-6 py-3 bg-gray-200 dark:bg-gray-700 rounded-lg">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div id="successMessage" class="hidden fixed top-4 right-4 p-4 bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 rounded-lg"></div>
        <div id="errorMessage" class="hidden fixed top-4 right-4 p-4 bg-red-100 dark:bg-red-900 text-red-800 dark:text-red-200 rounded-lg"></div>
    </div>

    <script>
        let allCustomers = [];

        async function loadCustomers() {
            try {
                const response = await fetch('/api/customers');
                const data = await response.json();
                allCustomers = data.data;
                displayCustomers(allCustomers);
            } catch (error) {
                console.error('Error loading customers:', error);
                showError('Failed to load customers');
            }
        }

        function displayCustomers(customers) {
            const container = document.getElementById('customersList');
            container.innerHTML = customers.map(customer => `
                <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-xl font-bold mb-2">${customer.name}</h3>
                            <div class="space-y-1 text-sm text-gray-600 dark:text-gray-400">
                                <p><span class="material-symbols-outlined text-sm">phone</span> ${customer.phone}</p>
                                ${customer.whatsapp ? `<p><span class="material-symbols-outlined text-sm">chat</span> ${customer.whatsapp}</p>` : ''}
                                ${customer.address ? `<p><span class="material-symbols-outlined text-sm">location_on</span> ${customer.address}</p>` : ''}
                            </div>
                            <div class="mt-3 flex gap-4 text-sm">
                                <span class="font-medium">Credit Limit: ₹${customer.creditLimit}</span>
                                <span class="font-medium ${customer.currentCredit > 0 ? 'text-red-600' : 'text-green-600'}">
                                    Current: ₹${customer.currentCredit}
                                </span>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick='editCustomer(${JSON.stringify(customer)})' class="p-2 bg-blue-500 text-white rounded-lg">
                                <span class="material-symbols-outlined">edit</span>
                            </button>
                            <button onclick="deleteCustomer('${customer._id}')" class="p-2 bg-red-500 text-white rounded-lg">
                                <span class="material-symbols-outlined">delete</span>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function searchCustomers() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allCustomers.filter(c =>
                c.name.toLowerCase().includes(query) ||
                c.phone.includes(query)
            );
            displayCustomers(filtered);
        }

        function showAddCustomerForm() {
            document.getElementById('modalTitle').textContent = 'Add Customer';
            document.getElementById('customerForm').reset();
            document.getElementById('customerId').value = '';
            document.getElementById('customerModal').classList.remove('hidden');
        }

        function editCustomer(customer) {
            document.getElementById('modalTitle').textContent = 'Edit Customer';
            document.getElementById('customerId').value = customer._id;
            document.getElementById('customerName').value = customer.name;
            document.getElementById('customerPhone').value = customer.phone;
            document.getElementById('customerWhatsapp').value = customer.whatsapp || '';
            document.getElementById('customerAddress').value = customer.address || '';
            document.getElementById('customerCreditLimit').value = customer.creditLimit;
            document.getElementById('customerModal').classList.remove('hidden');
        }

        function closeModal() {
            document.getElementById('customerModal').classList.add('hidden');
        }

        async function deleteCustomer(id) {
            if (!confirm('Are you sure you want to delete this customer?')) return;

            try {
                const response = await fetch(`/api/customers/${id}`, { method: 'DELETE' });
                if (response.ok) {
                    showSuccess('Customer deleted successfully');
                    loadCustomers();
                } else {
                    showError('Failed to delete customer');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Network error');
            }
        }

        function showSuccess(message) {
            const div = document.getElementById('successMessage');
            div.textContent = message;
            div.classList.remove('hidden');
            setTimeout(() => div.classList.add('hidden'), 3000);
        }

        function showError(message) {
            const div = document.getElementById('errorMessage');
            div.textContent = message;
            div.classList.remove('hidden');
            setTimeout(() => div.classList.add('hidden'), 3000);
        }

        document.getElementById('customerForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('customerId').value;
            const customerData = {
                name: document.getElementById('customerName').value,
                phone: document.getElementById('customerPhone').value,
                whatsapp: document.getElementById('customerWhatsapp').value,
                address: document.getElementById('customerAddress').value,
                creditLimit: parseFloat(document.getElementById('customerCreditLimit').value)
            };

            try {
                const url = id ? `/api/customers/${id}` : '/api/customers';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(customerData)
                });

                if (response.ok) {
                    showSuccess(id ? 'Customer updated' : 'Customer added');
                    closeModal();
                    loadCustomers();
                } else {
                    const data = await response.json();
                    showError(data.message || 'Failed to save customer');
                }
            } catch (error) {
                console.error('Error:', error);
                showError('Network error');
            }
        });

        // Load customers on page load
        loadCustomers();
    </script>
</body>
</html>
