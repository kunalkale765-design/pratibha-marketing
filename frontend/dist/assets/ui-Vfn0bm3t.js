let a=null;function c(){const e=document.cookie.match(/csrf_token=([^;]+)/);return e?e[1]:null}async function u(){if(a)return a;a=(async()=>{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3);try{const o=await fetch("/api/csrf-token",{credentials:"include",signal:e.signal});if(o.ok)return(await o.json()).csrfToken||c()}catch(o){o.name!=="AbortError"&&console.error("Failed to refresh CSRF token:",o)}finally{clearTimeout(t)}return null})();try{return await a}finally{a=null}}async function h(){let e=c();return e||(e=await u()),e}const g={USER_KEY:"user",getCsrfToken:c,refreshCsrfToken:u,ensureCsrfToken:h,isLoggedIn(){return!!this.getUser()},getUser(){try{const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Error parsing user data:",e),null}},setUser(e){const t={id:e.id,name:e.name,email:e.email,role:e.role,customer:e.customer?{_id:e.customer._id,name:e.customer.name,pricingType:e.customer.pricingType,...e.customer.allowedProducts?{allowedProducts:e.customer.allowedProducts}:{}}:null,isMagicLink:e.isMagicLink||!1};localStorage.setItem(this.USER_KEY,JSON.stringify(t))},clearAuth(){localStorage.removeItem(this.USER_KEY),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("logout"),"caches"in window&&caches.keys().then(e=>e.forEach(t=>caches.delete(t))).catch(()=>{})},getRole(){const e=this.getUser();return e?e.role:null},isStaff(){const e=this.getRole();return e==="admin"||e==="staff"},isCustomer(){return this.getRole()==="customer"},async verify(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const t=await e.json();return this.setUser(t.user),t.user}else return this.clearAuth(),null}catch(e){return console.error("Auth verification failed:",e),!navigator.onLine||e.name==="TypeError"||e.message.includes("network")||e.message.includes("fetch")||e.message.includes("Failed to fetch")?(console.warn("Network issue during auth verification - using cached user"),this.getUser()):(this.clearAuth(),null)}},async login(e,t,o=!1){try{const s={"Content-Type":"application/json"},r=await this.ensureCsrfToken();r&&(s["X-CSRF-Token"]=r);const n=await fetch("/api/auth/login",{method:"POST",headers:s,credentials:"include",body:JSON.stringify({email:e,password:t})}),i=await n.json();return n.ok?(this.setUser(i.user),{success:!0,user:i.user}):n.status===403&&i?.message?.toLowerCase().includes("csrf")&&!o?(console.log("CSRF token error during login, refreshing and retrying..."),await this.refreshCsrfToken(),this.login(e,t,!0)):{success:!1,error:i.message||"Login failed"}}catch(s){return console.error("Login error:",s),{success:!1,error:"Network error. Please try again."}}},async logout(){try{const e={},t=await this.ensureCsrfToken();t&&(e["X-CSRF-Token"]=t);const o=await fetch("/api/auth/logout",{method:"POST",headers:e,credentials:"include"});o.ok||console.warn("Server-side logout returned error:",o.status)}catch(e){console.error("Logout error:",e),console.warn("Server-side session may still be active due to:",e.message)}finally{this.clearAuth(),window.location.href="/pages/auth/login.html"}},async requireAuth(e=null){const t=await this.verify();return t?e&&!e.includes(t.role)?(t.role==="customer"?window.location.href="/pages/order-form/":t.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/",null):t:(window.location.href="/pages/auth/login.html",null)},async redirectIfLoggedIn(){const e=await this.verify();return e?(e.role==="customer"?window.location.href="/pages/order-form/":e.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/",!0):!1}};typeof window<"u"&&(window.Auth=g);function m(e,t={},o=[]){const s=document.createElement(e);return t&&Object.entries(t).forEach(([r,n])=>{r==="className"||r==="class"?s.className=n:r==="style"&&typeof n=="object"?Object.assign(s.style,n):r==="dataset"&&typeof n=="object"?Object.assign(s.dataset,n):r.startsWith("on")&&typeof n=="function"?s.addEventListener(r.substring(2).toLowerCase(),n):s.setAttribute(r,n)}),o&&(Array.isArray(o)||(o=[o]),o.forEach(r=>{r instanceof Node?s.appendChild(r):r!=null&&s.appendChild(document.createTextNode(String(r)))})),s}function f(e,t="success",o=3e3){let s=document.getElementById("toast");s||(s=document.createElement("div"),s.id="toast",s.className="toast",document.body.appendChild(s)),s._hideTimeout&&(clearTimeout(s._hideTimeout),s._hideTimeout=null),s.classList.remove("toast-success","toast-error","toast-warning","toast-info","show"),s.textContent=e,s.classList.add(`toast-${t}`),requestAnimationFrame(()=>{s.classList.add("show")}),s._hideTimeout=setTimeout(()=>{d()},o)}function d(){const e=document.getElementById("toast");e&&e.classList.remove("show")}function w(e,t=3e3){f(e,"success",t)}let l=!1;function p(){l||(l=!0,document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelectorAll(".modal-overlay.show");if(t.length===0)return;typeof window.closeModal=="function"?window.closeModal():(t.forEach(o=>{o.classList.remove("show")}),document.body.style.overflow="")}}))}function y(e,t){const o=document.getElementById(e);o&&(o.type==="password"?(o.type="text",t&&(t.textContent="○")):(o.type="password",t&&(t.textContent="◉")))}const T=Object.freeze(Object.defineProperty({__proto__:null,createElement:m,hideToast:d,setupModalCloseOnEscape:p,showSuccess:w,showToast:f,togglePassword:y},Symbol.toStringTag,{value:"Module"}));export{p as a,w as b,m as c,h as e,c as g,f as s,y as t,T as u};
