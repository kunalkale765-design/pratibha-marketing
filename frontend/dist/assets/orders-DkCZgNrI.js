import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as u,c as a}from"./ui-D1Am529b.js";import"./api-BqPqbFNt.js";const ie=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(ie()),10)}),q=await ie();let R=[];const Y={};let se=[],f=[],G="all",T=null,C=null,w=null,E={},N={},L=!1,oe=!1,h=null,Q=[];async function ue(){if(w=await q.requireAuth(),!!w){if(w.role==="customer"){const e=document.getElementById("modalFooter");e&&(e.style.display="none")}pe(),await Promise.all([M(),fe(),ge()]),ye(),we(),me()}}function me(){const e=new URLSearchParams(window.location.search),t=e.get("order"),o=e.get("action");t&&(window.history.replaceState({},"",window.location.pathname),o==="pack"?de(t):D(t))}function pe(){if(oe)return;oe=!0;const e=document.getElementById("ordersList");if(!e)return;document.addEventListener("click",i=>{i.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(c=>{c.classList.remove("swiped","swiped-single")})});let t={startX:0,isDragging:!1,currentItem:null};e.addEventListener("touchstart",i=>{const c=i.target.closest(".swipe-item");c&&(t={startX:i.touches[0].clientX,isDragging:!0,currentItem:c},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(r=>{r!==c&&r.classList.remove("swiped","swiped-single")}))},{passive:!0}),e.addEventListener("touchmove",i=>{if(!t.isDragging||!t.currentItem)return;const c=w?.role==="admin",r=t.startX-i.touches[0].clientX;r>50?(t.currentItem.classList.remove("swiped-single","swiped"),t.currentItem.classList.add(c?"swiped":"swiped-single")):r<-20&&t.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),e.addEventListener("touchend",()=>{t.isDragging=!1,t.currentItem=null},{passive:!0});const o=document.getElementById("orderModal");o&&(o.onclick=i=>{i.target.id==="orderModal"&&X()});const n=document.getElementById("invoiceModal");n&&(n.onclick=i=>{i.target.id==="invoiceModal"&&ee()})}async function fe(){try{const e=await fetch("/api/market-rates",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);((await e.json()).data||[]).forEach(o=>{const n=typeof o.product=="object"?o.product._id:o.product;Y[n]=o.rate})}catch(e){console.error("Failed to load market rates:",e)}}async function ge(){try{const e=await fetch("/api/products",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);se=((await e.json()).data||[]).filter(o=>o.isActive!==!1)}catch(e){console.error("Failed to load products:",e)}}async function M(){try{const e=await fetch("/api/orders?limit=100",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);const t=await e.json();if(!t.success)throw new Error(t.message||"Orders temporarily unavailable");R=t.data||[];const o=R.filter(n=>!n._id||!/^[a-f\d]{24}$/i.test(n._id));o.length>0&&console.warn("Orders with invalid IDs:",o.map(n=>({orderNumber:n.orderNumber,_id:n._id}))),K()}catch(e){if(console.error("Failed to load orders:",e),!R||R.length===0){const t=document.getElementById("ordersList"),o=navigator.onLine?"Orders not available":"No internet connection";t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},[a("p",{},o),a("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:M},"Try Again")]))}}}function ve(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function K(){const e=document.getElementById("ordersList");if(!e)return;const t=document.getElementById("searchInput"),o=t?t.value.toLowerCase():"",n=w?.role==="admin",i=w?.role==="admin"||w?.role==="staff";let c=R.filter(s=>s._id&&/^[a-f\d]{24}$/i.test(s._id));if(G==="all"?c=c.filter(s=>s.status!=="cancelled"):c=c.filter(s=>s.status===G),o&&(c=c.filter(s=>s.orderNumber?.toLowerCase().includes(o)||s.customer?.name?.toLowerCase().includes(o))),!c.length){e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},"No orders found"));return}e.innerHTML="";const r=document.createDocumentFragment();c.forEach((s,g)=>{let m=null;s.batch?.batchType&&(m=a("span",{className:"badge badge-batch"},[s.batch.batchType,s.batchLocked?" ðŸ”’":""]));let y=null;i&&s.status==="confirmed"&&(s.packingDone?y=a("span",{className:"packing-status-badge status-packed"},"âœ“ Packed"):y=a("span",{className:"packing-status-badge status-ready"},"Ready"));const l=a("div",{className:"swipe-content",onclick:()=>window.viewOrder(s._id)},[a("div",{className:"order-avatar"},ve(s.customer?.name)),a("div",{className:"order-info"},[a("div",{className:"order-customer"},s.customer?.name||"Unknown"),s.notes?a("div",{className:"order-notes"},s.notes):null,a("div",{className:"order-meta-row"},[a("span",{className:"order-number"},`Order #${s.orderNumber}`),m,y])]),a("div",{className:"order-amount-pill"},`â‚¹${(s.totalAmount||0).toLocaleString("en-IN")}`)]),p=[];i&&s.status==="confirmed"&&!s.packingDone&&p.push(a("button",{className:"swipe-action pack",onclick:d=>{d.stopPropagation(),window.openPackingPanel(s._id)}},"Pack")),i&&p.push(a("button",{className:"swipe-action edit",onclick:d=>{d.stopPropagation(),window.printOrder(s._id)}},"Print")),n&&p.push(a("button",{className:"swipe-action delete",onclick:d=>{d.stopPropagation(),window.deleteOrder(s._id)}},"Delete"));const k=a("div",{className:"swipe-actions"},p),V=a("div",{className:"swipe-item card-fade-in",dataset:{orderId:s._id},style:{animationDelay:`${g*.05}s`}},[l,k]);r.appendChild(V)}),e.appendChild(r)}function ye(){const e=document.getElementById("filterSegments"),t=document.getElementById("segmentIndicator"),o=e.querySelectorAll(".segment-btn");function n(c){const r=e.getBoundingClientRect(),s=c.getBoundingClientRect(),g=s.left-r.left,m=s.width;t.style.left=g+"px",t.style.width=m+"px"}const i=e.querySelector(".segment-btn.active");i&&setTimeout(()=>n(i),10),o.forEach(c=>{c.onclick=()=>{o.forEach(s=>s.classList.remove("active")),c.classList.add("active"),n(c),G=c.dataset.filter;const r=document.getElementById("ordersList");r.classList.add("segment-content"),K(),setTimeout(()=>r.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const c=e.querySelector(".segment-btn.active");c&&n(c)})}function he(e,t){let o;return function(...n){clearTimeout(o),o=setTimeout(()=>e.apply(this,n),t)}}function we(){const e=document.getElementById("searchInput");if(e){const t=he(K,200);e.addEventListener("input",t)}}let B=null,S=null,P=new Set;async function W(e){if(w?.role==="customer"){u("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i.classList.remove("swiped","swiped-single")});const t=/^[a-f\d]{24}$/i.test(e);if(!e||!t){console.error("Invalid order ID:",e),u("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const o=document.getElementById("invoiceModalBody");o.innerHTML="",o.appendChild(a("div",{className:"invoice-loading"},"Loading invoice data..."));const n=document.getElementById("generateInvoiceBtn");n&&(n.disabled=!0);try{await be();const i=await fetch(`/api/invoices/${e}/split`,{credentials:"include"});if(!i.ok){const r=await i.json().catch(()=>({}));throw new Error(r.message||"Invoice data temporarily unavailable")}B=(await i.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${B.orderNumber}`,x()}catch(i){console.error("Print order error:",i),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(a("div",{className:"invoice-no-items"},[a("p",{},"Invoice data not available"),a("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},i.message)]))}}let O=[];async function be(){if(!(O.length>0))try{const e=await fetch("/api/invoices/firms",{credentials:"include"});e.ok&&(O=(await e.json()).data||[])}catch(e){console.error("Failed to load firms:",e)}}function x(){const e=document.getElementById("invoiceModalBody");if(!B){e.innerHTML="",e.appendChild(a("div",{className:"invoice-no-items"},"No items to invoice"));return}const t=B.firms.flatMap(s=>s.items);if(t.length===0){e.innerHTML="",e.appendChild(a("div",{className:"invoice-no-items"},"No items to invoice"));return}S||(S=O.length>0?O[0].id:B?.firms?.[0]?.firmId||"pratibha",P=new Set(t.map(s=>s.productId)));const o=t.filter(s=>P.has(s.productId)).reduce((s,g)=>s+(g.amount||0),0),n=O.length>0?O:(B?.firms||[]).map(s=>({id:s.firmId,name:s.firmName}));e.innerHTML="";const i=document.createDocumentFragment(),c=a("div",{className:"invoice-firm-selector"},[a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),a("div",{className:"firm-options"},n.map(s=>a("label",{className:`firm-option ${S===s.id?"selected":""}`,onclick:()=>window.selectFirm(s.id)},[a("input",{type:"radio",name:"firm",value:s.id,checked:S===s.id}),a("span",{className:"firm-option-name"},s.name)])))]);i.appendChild(c),i.appendChild(a("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),i.appendChild(a("div",{className:"invoice-items-list"},t.map(s=>a("div",{className:"invoice-item"},[a("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:s.productId},checked:P.has(s.productId),onchange:()=>window.toggleInvoiceItem(null,s.productId)}),a("div",{className:"invoice-item-details"},[a("div",{className:"invoice-item-name"},s.productName),a("div",{className:"invoice-item-meta"},`${s.quantity||0} ${s.unit||""} Ã— â‚¹${(s.rate||0).toLocaleString("en-IN")}`)]),a("div",{className:"invoice-item-amount"},`â‚¹${(s.amount||0).toLocaleString("en-IN")}`)])))),i.appendChild(a("div",{className:"invoice-summary"},[a("div",{className:"invoice-summary-label"},"Total"),a("div",{className:"invoice-summary-total"},`â‚¹${o.toLocaleString("en-IN")}`)])),e.appendChild(i);const r=document.getElementById("generateInvoiceBtn");r&&(r.disabled=P.size===0)}function ke(e){S=e,x()}function Ie(e,t){P.has(t)?P.delete(t):P.add(t),x()}async function Ne(){if(!B||!S||P.size===0)return;const e=document.getElementById("generateInvoiceBtn");e.classList.add("btn-loading"),e.disabled=!0;try{const t={"Content-Type":"application/json"},o=await q.ensureCsrfToken();o&&(t["X-CSRF-Token"]=o);const n=await fetch(`/api/invoices/${B.orderId}/pdf`,{method:"POST",headers:t,credentials:"include",body:JSON.stringify({firmId:S,productIds:Array.from(P)})});if(!n.ok){const s=await n.json().catch(()=>({}));throw new Error(s.message||"Invoice generation temporarily unavailable")}const i=await n.blob(),c=URL.createObjectURL(i),r=document.createElement("a");r.href=c,r.download=`INV${B.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c),u("Invoice downloaded","success"),ee()}catch(t){console.error("Generate invoice error:",t),u(t.message||"Could not generate invoice","info")}finally{e.classList.remove("btn-loading"),e.disabled=!1}}function ee(){document.getElementById("invoiceModal").classList.remove("show"),B=null,S=null,P=new Set}function Ce(){if(!T)return;const e=T;X(),W(e)}async function Ee(e){if(w?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const t=document.querySelector(`.swipe-item[data-order-id="${e}"]`);try{const o={"Content-Type":"application/json"},n=await q.ensureCsrfToken();n&&(o["X-CSRF-Token"]=n);const i=await fetch(`/api/orders/${e}`,{method:"DELETE",headers:o,credentials:"include"});if(i.ok)t?(t.classList.add("deleting"),setTimeout(()=>{M()},300)):M(),u("Order cancelled","success");else{const c=await i.json().catch(()=>({message:"Could not cancel. Try again."}));u(c.message||"Could not cancel","info")}}catch(o){console.error("Delete order error:",o),u("Could not delete order","info")}}async function D(e){if(L){u("Please wait, saving in progress...","info");return}try{const t=await fetch(`/api/orders/${e}`,{credentials:"include"});let o;try{o=await t.json()}catch(d){console.error("Failed to parse order response:",d),u("Server issue. Please refresh.","info");return}if(!t.ok){u(o?.message||"Could not load order","info");return}const n=o.data;if(!n||!n.products){u("Order data updating. Refresh page.","info");return}T=e,C=n,E={},N={},f=[];const i=document.getElementById("modalTitle");i&&(i.textContent=`#${n.orderNumber}`);const c=document.getElementById("savePricesBtn");c&&(c.disabled=!0);const r=w.role==="admin"||w.role==="staff",s=n.batch?.batchType?`<span class="badge badge-batch">${n.batch.batchType}${n.batchLocked?" ðŸ”’":""}</span>`:"-",g=document.getElementById("modalBody");g.innerHTML="";const m=document.createDocumentFragment(),y=a("div",{className:"info-row"},[a("div",{},[a("div",{className:"info-label"},"Customer"),a("div",{className:"info-value"},n.customer?.name||"")]),a("div",{},[a("div",{className:"info-label"},"Phone"),a("div",{className:"info-value"},n.customer?.phone||"-")])]);m.appendChild(y);const l=n.batch?.batchType?a("span",{className:"badge badge-batch"},[n.batch.batchType,n.batchLocked?" ðŸ”’":""]):"-",p=a("div",{className:"info-row"},[a("div",{},[a("div",{className:"info-label"},"Date"),a("div",{className:"info-value"},new Date(n.createdAt).toLocaleDateString("en-IN"))]),a("div",{},[a("div",{className:"info-label"},"Batch"),a("div",{className:"info-value"},Array.isArray(l)?l:[l])])]);m.appendChild(p);const F=a("div",{className:"info-row"},[a("div",{},[a("div",{className:"info-label"},"Status"),a("div",{className:"info-value"},[a("span",{className:`badge badge-${n.status}`},n.status)])]),a("div",{})]);m.appendChild(F);const k=a("div",{className:"info-section"});if(k.appendChild(a("div",{className:"info-label"},"Products")),n.products.forEach((d,v)=>{const H=typeof d.product=="object"?d.product._id:d.product,b=Y[H]||d.rate||null,I=b?`â‚¹${b.toLocaleString("en-IN")}`:"N/A";let z;if(r){const j=a("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${v}`,value:d.quantity,min:"0",step:"0.01",dataset:{idx:v,original:d.quantity,unit:d.unit},onfocus:A=>window.clearZero(A.target),onblur:A=>window.restoreValue(A.target),onchange:()=>window.handleQuantityChange(v),oninput:()=>window.handleQuantityInput(v)});z=a("div",{className:"qty-controls-inline"},[a("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(v,-1)},"âˆ’"),j,a("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(v,1)},"+"),a("span",{className:"qty-unit"},d.unit)])}else z=a("div",{className:"product-qty"},`${d.quantity} ${d.unit}`);const J=["Selling"];d.isContractPrice&&(J.push(" "),J.push(a("span",{className:"contract-badge"},"Fixed")));let Z;if(r){const j=a("input",{type:"number",className:`price-input input-animated${d.isContractPrice?" contract-locked":""}`,id:`price-${v}`,value:d.rate,min:"0",step:"0.01",dataset:{idx:v,original:d.rate,qty:d.quantity,contract:d.isContractPrice||!1},onfocus:A=>window.clearZero(A.target),onblur:A=>window.restoreValue(A.target),onchange:()=>window.handlePriceChange(v),oninput:()=>window.handlePriceInput(v)});d.isContractPrice&&(j.disabled=!0,j.title="Contract price - edit in customer management"),Z=j}else Z=a("div",{className:"price-value"},`â‚¹${d.rate}`);const le=a("div",{className:"product-item",dataset:{idx:v}},[a("div",{className:"product-top"},[a("div",{},[a("div",{className:"product-name"},d.productName),z])]),a("div",{className:"prices-container"},[a("div",{className:"price-box"},[a("div",{className:"price-label"},"Purchase"),a("div",{className:"price-value"},I)]),a("div",{className:"price-box"},[a("div",{className:"price-label"},J),Z])]),a("div",{className:"amount-row"},[a("span",{className:"amount-label"},"Amount"),a("span",{className:"amount-display",id:`amount-${v}`},`â‚¹${d.amount}`)])]);k.appendChild(le)}),k.appendChild(a("div",{id:"addedProductsContainer"})),r){const d=[a("option",{value:""},"+ Add Product...")];se.filter(b=>!n.products.some(I=>(typeof I.product=="object"?I.product._id:I.product)===b._id)).forEach(b=>{d.push(a("option",{value:b._id,dataset:{name:b.name,unit:b.unit}},`${b.name} (${b.unit})`))});const v=a("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},d),H=a("div",{className:"add-product-section"},[v]);k.appendChild(H)}m.appendChild(k);const V=a("div",{className:"total-section"},[a("div",{className:"total-row"},[a("span",{},"Total"),a("span",{id:"orderTotal"},`â‚¹${n.totalAmount}`)]),a("div",{className:"total-row"},[a("span",{},"Paid"),a("span",{},`â‚¹${n.paidAmount||0}`)]),a("div",{className:"total-row main"},[a("span",{},"Balance"),a("span",{id:"orderBalance"},`â‚¹${n.totalAmount-(n.paidAmount||0)}`)])]);if(m.appendChild(V),g.appendChild(m),r){const d=document.getElementById("modalFooter");if(d){d.innerHTML="";const v=a("button",{className:"btn-modal secondary btn-animated",onclick:()=>window.printFromModal()},a("span",{className:"btn-text"},"Invoice"));if(d.appendChild(v),n.status==="pending"){const I=a("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--dusty-olive)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"confirmed")},"Confirm Order");d.appendChild(I)}else if(n.status==="confirmed"&&n.packingDone){const I=a("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--gunmetal)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"delivered")},"Mark Delivered");d.appendChild(I)}if(n.status==="confirmed"&&!n.packingDone){const I=a("button",{className:"btn-modal secondary btn-animated",style:{background:"var(--dusty-olive)",color:"white",border:"none"},onclick:()=>{window.closeModal(),setTimeout(()=>window.openPackingPanel(n._id),200)}},"Start Packing");d.appendChild(I)}const b=a("button",{className:"btn-save-prices btn-animated",id:"savePricesBtn",disabled:!0,onclick:()=>window.savePrices()},a("span",{className:"btn-text"},"Save"));d.appendChild(b)}}document.getElementById("orderModal").classList.add("show")}catch{u("Could not load order","info")}}function Be(e){e.dataset.prevValue=e.value,e.value="",e.select()}function Pe(e){e.value===""&&(e.value=e.dataset.prevValue||e.dataset.original);const t=parseInt(e.dataset.idx);ce(t)}function $e(e){const t=document.getElementById(`price-${e}`),o=document.getElementById(`quantity-${e}`),n=parseFloat(t.dataset.original),i=parseFloat(t.value)||0,c=o?parseFloat(o.value)||0:parseFloat(t.dataset.qty);t.classList.toggle("changed",i!==n);const r=Math.round(i*c*100)/100,s=document.getElementById(`amount-${e}`);s&&(s.textContent=`â‚¹${r.toLocaleString("en-IN")}`),$()}function ce(e){const t=document.getElementById(`price-${e}`);if(!t)return;const o=parseFloat(t.dataset.original),n=parseFloat(t.value)||0;n!==o&&n>0?E[e]=n:delete E[e],U()}function Le(e,t){const o=document.getElementById(`quantity-${e}`);if(!o)return;let i=(parseFloat(o.value)||0)+t;i<.01&&i>0&&(i=0),i<0&&(i=0),o.value=i,re(e),te(e)}function te(e){const t=document.getElementById(`quantity-${e}`),o=document.getElementById(`price-${e}`);if(!t)return;const n=parseFloat(t.dataset.original),i=parseFloat(t.value)||0;t.classList.remove("changed","removed"),i===0?t.classList.add("removed"):i!==n&&t.classList.add("changed");const c=o?parseFloat(o.value)||0:C?.products[e]?.rate||0,r=Math.round(i*c*100)/100,s=document.getElementById(`amount-${e}`);s&&(s.textContent=`â‚¹${r.toLocaleString("en-IN")}`),$()}function re(e){const t=document.getElementById(`quantity-${e}`);if(!t)return;const o=parseFloat(t.dataset.original),n=parseFloat(t.value)||0,i=.01;n>0&&n<i?(u(`Minimum quantity: ${i} ${t.dataset.unit}`,"info"),t.value=o,delete N[e]):n!==o?N[e]=n:delete N[e],U(),te(e)}function U(){const e=Object.keys(E).length>0||Object.keys(N).length>0||f.length>0,t=document.getElementById("savePricesBtn");t&&(t.disabled=!e)}function Te(){const e=document.getElementById("productSelector"),t=e.value;if(!t)return;const o=e.options[e.selectedIndex],n=o.dataset.name,i=o.dataset.unit,c=Y[t]||0;f.push({product:t,productName:n,unit:i,quantity:1,rate:c}),o.remove(),ne(),$(),U(),e.value=""}function ne(){const e=document.getElementById("addedProductsContainer");if(!e)return;e.innerHTML="";const t=document.createDocumentFragment();f.forEach((o,n)=>{const i=a("div",{className:"product-item added-product",dataset:{addedIdx:n}},[a("div",{className:"product-top"},[a("div",{},[a("div",{className:"product-name"},[o.productName," ",a("span",{className:"new-badge"},"New")]),a("div",{className:"qty-controls-inline"},[a("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,-1),type:"button"},"âˆ’"),a("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${n}`,value:o.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(n),oninput:()=>window.handleAddedQtyInput(n)}),a("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,1),type:"button"},"+"),a("span",{className:"qty-unit"},o.unit)])]),a("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(n),title:"Remove"},"Ã—")]),a("div",{className:"prices-container"},[a("div",{className:"price-box"},[a("div",{className:"price-label"},"Purchase"),a("div",{className:"price-value"},o.rate?`â‚¹${o.rate.toLocaleString("en-IN")}`:"N/A")]),a("div",{className:"price-box"},[a("div",{className:"price-label"},"Selling"),a("input",{type:"number",className:"price-input input-animated",id:`added-price-${n}`,value:o.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(n)})])]),a("div",{className:"amount-row"},[a("span",{className:"amount-label"},"Amount"),a("span",{className:"amount-display",id:`added-amount-${n}`},`â‚¹${((o.rate||0)*(o.quantity||0)).toLocaleString("en-IN")}`)])]);t.appendChild(i)}),e.appendChild(t)}function Se(e,t){const o=document.getElementById(`added-qty-${e}`);if(!o)return;let n=parseFloat(o.value)||0;n=Math.max(0,n+t),n>0&&n<.01&&(n=.01),o.value=n,f[e].quantity=n,_(e),$()}function qe(e){const t=document.getElementById(`added-qty-${e}`);if(!t)return;let o=parseFloat(t.value)||0;o>0&&o<.01&&(u("Minimum quantity: 0.01","info"),o=.01,t.value=o),f[e].quantity=o,_(e),$()}function Fe(e){const t=document.getElementById(`added-qty-${e}`);if(!t)return;const o=parseFloat(t.value)||0;f[e].quantity=o,_(e),$()}function Ae(e){const t=document.getElementById(`added-price-${e}`);if(!t)return;const o=parseFloat(t.value)||0;f[e].rate=o,_(e),$()}function Me(e){const t=document.getElementById(`added-price-${e}`);if(!t)return;const o=parseFloat(t.value)||0;f[e].rate=o,_(e),$()}function _(e){const t=document.getElementById(`added-amount-${e}`);if(!t)return;const o=f[e],n=(o.quantity||0)*(o.rate||0);t.textContent=`â‚¹${n.toLocaleString("en-IN")}`}function Oe(e){const t=f.splice(e,1)[0],o=document.getElementById("productSelector");if(o&&t){const n=document.createElement("option");n.value=t.product,n.dataset.name=t.productName,n.dataset.unit=t.unit,n.textContent=`${t.productName} (${t.unit})`,o.appendChild(n)}ne(),$(),U()}function $(){if(!C||!C.products)return;let e=0;C.products.forEach((i,c)=>{const r=document.getElementById(`price-${c}`),s=document.getElementById(`quantity-${c}`),g=r?parseFloat(r.value)||0:i.rate,m=s?parseFloat(s.value)||0:i.quantity;e+=g*m}),f.forEach(i=>{e+=(i.quantity||0)*(i.rate||0)}),e=Math.round(e*100)/100;const t=Math.round((e-(C.paidAmount||0))*100)/100,o=document.getElementById("orderTotal"),n=document.getElementById("orderBalance");o&&(o.textContent=`â‚¹${e.toLocaleString("en-IN")}`),n&&(n.textContent=`â‚¹${t.toLocaleString("en-IN")}`)}async function De(e){try{const t=await fetch(`/api/invoices/order/${e}`,{credentials:"include"});if(!t.ok)return!1;const o=await t.json();return o.data&&o.data.length>0}catch(t){return console.error("Failed to check invoices:",t),!1}}async function Qe(){const e=Object.keys(E).length>0||Object.keys(N).length>0||f.length>0;if(!T||!C||!C.products||!e)return;if(L){u("Save in progress...","info");return}L=!0;const t=document.getElementById("savePricesBtn");t&&(t.disabled=!0,t.classList.add("btn-loading"));let o=!1;try{if(o=await De(T),o&&!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`)){L=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}catch(n){console.error("Invoice check failed:",n)}try{const n=C.products.map((l,p)=>{let F=E[p]!==void 0?E[p]:l.rate,k=N[p]!==void 0?N[p]:l.quantity;return(!F||F<=0)&&(F=l.rate),k<0&&(k=l.quantity),{product:typeof l.product=="object"?l.product._id:l.product,quantity:k,priceAtTime:F}}).filter(l=>l.quantity>0),i=f.filter(l=>l.quantity>0).map(l=>({product:l.product,quantity:l.quantity,priceAtTime:l.rate})),c=[...n,...i],r={"Content-Type":"application/json"},s=await q.ensureCsrfToken();s&&(r["X-CSRF-Token"]=s);const g={products:c},m=T;let y=await fetch(`/api/orders/${m}`,{method:"PUT",headers:r,credentials:"include",body:JSON.stringify(g)});if(y.status===403){let l;try{l=await y.json()}catch(p){console.warn("Failed to parse CSRF error response:",p.message),l={message:`Access denied (code: ${y.status})`}}if(l.message?.toLowerCase().includes("csrf")){const p=await q.refreshCsrfToken();if(p){if(r["X-CSRF-Token"]=p,y=await fetch(`/api/orders/${m}`,{method:"PUT",headers:r,credentials:"include",body:JSON.stringify(g)}),y.status===403){u("Session expired. Please refresh the page.","info"),L=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}else{u("Session expired. Please refresh the page.","info"),L=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}else{u(l.message||"Access temporarily unavailable","info"),L=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}if(y.ok)u("Changes saved","success"),E={},N={},f=[],t&&(t.classList.remove("btn-loading"),t.classList.add("btn-success"),setTimeout(()=>t.classList.remove("btn-success"),1500),t.disabled=!0),M(),o&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const l=m;X(),setTimeout(()=>W(l),300)}},500),T===m&&D(m);else{let l;try{l=await y.json()}catch(p){console.warn("Failed to parse order save error response:",p.message),l={message:`Server error (${y.status})`}}u(l.message||"Could not update","info"),t&&(t.disabled=!1)}}catch(n){console.error("Save changes error:",n),navigator.onLine?u("Could not save. Try again.","info"):u("No internet connection","info"),t&&(t.disabled=!1)}finally{L=!1,t&&t.classList.remove("btn-loading")}}function X(){if((Object.keys(E).length>0||Object.keys(N).length>0||f.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const t=document.getElementById("orderModal");t&&t.classList.remove("show"),T=null,C=null,E={},N={},f=[]}window.closeModal=X;window.viewOrder=D;window.clearZero=Be;window.restoreValue=Pe;window.handlePriceChange=ce;window.handlePriceInput=$e;window.handleQuantityChange=re;window.handleQuantityInput=te;window.changeQuantity=Le;window.savePrices=Qe;window.deleteOrder=Ee;window.printOrder=W;window.closeInvoiceModal=ee;window.selectFirm=ke;window.toggleInvoiceItem=Ie;window.generateInvoice=Ne;window.printFromModal=Ce;window.addProductToOrder=Te;window.renderAddedProducts=ne;window.changeAddedQty=Se;window.handleAddedQtyChange=qe;window.handleAddedQtyInput=Fe;window.handleAddedPriceChange=Ae;window.handleAddedPriceInput=Me;window.removeAddedProduct=Oe;async function je(e,t){if(!(!w||w.role!=="admin"&&w.role!=="staff"))try{const o={"Content-Type":"application/json"},n=await q.ensureCsrfToken();n&&(o["X-CSRF-Token"]=n);const i=await fetch(`/api/orders/${e}/status`,{method:"PUT",headers:o,credentials:"include",body:JSON.stringify({status:t})}),c=await i.json();i.ok?(u(`Order marked as ${t}`,"success"),D(e),M()):(u(c.message||"Failed to update status","error"),D(e))}catch(o){console.error("Status update error:",o),u("Network error updating status","error"),D(e)}}window.updateOrderStatus=je;async function de(e){const t=document.getElementById("packingPanel"),o=document.getElementById("packingPanelOverlay");if(!(!t||!o)){document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(n=>{n.classList.remove("swiped","swiped-single")}),t.classList.add("active"),o.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("packingPanelBody").innerHTML='<div class="packing-loading">Loading order...</div>',document.getElementById("packingCompleteBtn").disabled=!0;try{const n=await fetch(`/api/packing/${e}`,{credentials:"include"});if(!n.ok)throw new Error("Failed to load order");h=(await n.json()).data,Q=h.items||[],Re()}catch(n){console.error("Error loading packing order:",n),u("Failed to load order details","error"),ae()}}}function Re(){document.getElementById("packingPanelTitle").textContent=`Pack ${h.orderNumber}`,document.getElementById("packingPanelSubtitle").textContent=`${h.customer?.name||"Unknown"} â€¢ ${h.customer?.phone||""}`,Ue();const e=document.getElementById("packingPanelBody");let t="";(h.deliveryAddress||h.notes)&&(t='<div class="packing-order-details">',h.deliveryAddress&&(t+=`
                <div class="packing-delivery-info">
                    <span class="packing-label">Deliver to</span>
                    <span class="packing-value">${h.deliveryAddress}</span>
                </div>`),h.notes&&(t+=`
                <div class="packing-order-notes">
                    <span class="packing-label">Notes</span>
                    <span class="packing-value">${h.notes}</span>
                </div>`),t+="</div>");const o=Q.map((c,r)=>{const s=c.packedQuantity??c.orderedQuantity,g=c.packedQuantity!==void 0&&c.packedQuantity!==c.orderedQuantity;return`
            <div class="packing-checklist-item ${g?"item-modified":""}" data-index="${r}" data-product-id="${c.product}">
                <div class="packing-item-main">
                    <div class="packing-item-details">
                        <span class="packing-item-name">${c.productName}</span>
                        <span class="packing-item-qty">Ordered: ${c.orderedQuantity} ${c.unit}</span>
                    </div>
                </div>
                <div class="packing-item-input">
                    <input type="number"
                        class="packing-qty-input ${g?"modified":""}"
                        value="${s}"
                        data-index="${r}"
                        data-original="${c.orderedQuantity}"
                        step="0.01"
                        min="0"
                        onchange="handlePackingQtyChange(${r})"
                    >
                    <span class="packing-unit-label">${c.unit}</span>
                </div>
            </div>
        `}).join("");e.innerHTML=`
        ${t}
        <div class="packing-checklist-header">
            <span>Items to Pack</span>
        </div>
        <div class="packing-checklist">
            ${o}
        </div>
    `;const n=document.getElementById("packingPanelAcknowledgement");n&&(n.style.display="none");const i=document.getElementById("packingPanelIssues");i&&(i.style.display="none"),Xe()}async function _e(e){const t=document.querySelector(`.packing-qty-input[data-index="${e}"]`),o=parseFloat(t?.value)||0,n=parseFloat(t?.dataset.original)||0;Q[e].packedQuantity=o,t.classList.toggle("modified",o!==n);const i=t.closest(".packing-checklist-item");i&&i.classList.toggle("item-modified",o!==n),await He(e)}async function He(e){const t=Q[e];try{const o=await q.ensureCsrfToken();if(!(await fetch(`/api/packing/${h._id}/item/${t.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":o},credentials:"include",body:JSON.stringify({quantity:t.packedQuantity})})).ok)throw new Error("Failed to save")}catch(o){console.error("Error saving packing item:",o),u("Failed to save changes","error")}}function Ue(){const e=Q.length;document.getElementById("packingProgressFill").style.width="100%",document.getElementById("packingProgressText").textContent=`${e} items`}function Xe(){const e=document.getElementById("packingCompleteBtn");e&&(e.disabled=!1)}async function Ve(){const e=document.getElementById("packingCompleteBtn");e.disabled=!0,e.innerHTML='<span class="btn-text">Completing...</span>';try{const t=await q.ensureCsrfToken(),o=await fetch(`/api/packing/${h._id}/done`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":t},credentials:"include"});if(!o.ok){const n=await o.json();throw new Error(n.message||"Failed to complete packing")}u("Packing completed!","success"),ae(),await M()}catch(t){console.error("Error completing packing:",t),u(t.message||"Failed to complete packing","error"),e.disabled=!1,e.innerHTML='<span class="btn-text">Mark Done</span>'}}function ae(){const e=document.getElementById("packingPanel"),t=document.getElementById("packingPanelOverlay");e.classList.remove("active"),t.classList.remove("active"),document.body.style.overflow="",h=null,Q=[]}window.openPackingPanel=de;window.closePackingPanel=ae;window.handlePackingQtyChange=_e;window.completePackingSession=Ve;ue();
