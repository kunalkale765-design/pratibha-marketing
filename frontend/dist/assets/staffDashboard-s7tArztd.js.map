{"version":3,"file":"staffDashboard-s7tArztd.js","sources":["../../src/js/pages/staff-dashboard.js"],"sourcesContent":["import { formatCurrency } from '/js/utils.js';\nimport { initPage } from '/js/init.js';\nimport { showToast, createElement } from '/js/ui.js';\n\n// Wait for Auth to be available (with timeout to prevent infinite recursion)\nconst waitForAuth = (attempts = 0) => new Promise((resolve, reject) => {\n    if (window.Auth) {\n        resolve(window.Auth);\n    } else if (attempts > 500) {\n        reject(new Error('Auth module failed to load'));\n    } else {\n        setTimeout(() => waitForAuth(attempts + 1).then(resolve).catch(reject), 10);\n    }\n});\n\nlet Auth;\ntry {\n    Auth = await waitForAuth();\n} catch (e) {\n    console.error('Auth initialization failed:', e);\n    window.location.href = '/pages/auth/login.html';\n}\n\n// Initialize page\ninitPage();\n\n// State\nlet rates = [];\nlet procurementData = { toProcure: [], procured: [], categories: [] };\nlet searchQuery = '';\nlet selectedCategory = '';\nconst changedRates = {};\nlet lastQuantities = {};\nlet pollingInterval = null;\nlet badgeHideTimeout = null;\n\n// Sound for new order notifications\nlet audioContext = null;\nlet notificationAudio = null;\nlet soundEnabled = false;\nlet isPolling = false;\n\n// Preload notification sound file\nfunction preloadNotificationSound() {\n    notificationAudio = new Audio('/assets/sounds/notification.wav');\n    notificationAudio.preload = 'auto';\n    notificationAudio.volume = 0.5;\n}\n\n// Cleanup resources on page unload\nwindow.addEventListener('beforeunload', () => {\n    if (pollingInterval) {\n        clearInterval(pollingInterval);\n        pollingInterval = null;\n    }\n    if (audioContext) {\n        audioContext.close().catch(() => {});\n        audioContext = null;\n    }\n    if (notificationAudio) {\n        notificationAudio = null;\n    }\n});\n\n// Pause polling when page is hidden, resume when visible\ndocument.addEventListener('visibilitychange', () => {\n    if (document.hidden) {\n        if (pollingInterval) {\n            clearInterval(pollingInterval);\n            pollingInterval = null;\n        }\n    } else {\n        if (!pollingInterval) {\n            startPolling();\n        }\n    }\n});\n\n// Play notification sound - tries audio file first, falls back to Web Audio API\nfunction playNotificationSound() {\n    if (!soundEnabled) return;\n\n    if (notificationAudio) {\n        notificationAudio.currentTime = 0;\n        notificationAudio.play().catch(() => {\n            playWebAudioNotification();\n        });\n        return;\n    }\n\n    playWebAudioNotification();\n}\n\n// Web Audio API fallback for notification sound\nfunction playWebAudioNotification() {\n    try {\n        if (!audioContext) {\n            audioContext = new (window.AudioContext || window.webkitAudioContext)();\n        }\n\n        if (audioContext.state === 'suspended') {\n            audioContext.resume();\n        }\n\n        const osc1 = audioContext.createOscillator();\n        const osc2 = audioContext.createOscillator();\n        const gainNode = audioContext.createGain();\n\n        osc1.connect(gainNode);\n        osc2.connect(gainNode);\n        gainNode.connect(audioContext.destination);\n\n        osc1.frequency.value = 880;\n        osc1.type = 'sine';\n        osc2.frequency.value = 1108.73;\n        osc2.type = 'sine';\n\n        const now = audioContext.currentTime;\n        gainNode.gain.setValueAtTime(0, now);\n        gainNode.gain.linearRampToValueAtTime(0.3, now + 0.05);\n        gainNode.gain.linearRampToValueAtTime(0.2, now + 0.15);\n        gainNode.gain.linearRampToValueAtTime(0.3, now + 0.2);\n        gainNode.gain.linearRampToValueAtTime(0, now + 0.35);\n\n        osc1.start(now);\n        osc2.start(now);\n        osc1.stop(now + 0.35);\n        osc2.stop(now + 0.35);\n    } catch (e) {\n        console.log('Could not play notification sound:', e);\n    }\n}\n\n// Elements\nconst printBtn = document.getElementById('printBtn');\nconst exportBtn = document.getElementById('exportBtn');\nconst saveRatesBtn = document.getElementById('saveRatesBtn');\nconst purchaseSearch = document.getElementById('purchaseSearch');\nconst newOrderBadge = document.getElementById('newOrderBadge');\nconst procuredHeader = document.getElementById('procuredHeader');\n\n// Event listeners\nif (printBtn) printBtn.addEventListener('click', printList);\nif (exportBtn) exportBtn.addEventListener('click', exportCSV);\nif (saveRatesBtn) saveRatesBtn.addEventListener('click', saveAllRates);\n\n// Search input (debounced)\nlet searchDebounceTimer = null;\nif (purchaseSearch) {\n    purchaseSearch.addEventListener('input', (e) => {\n        searchQuery = e.target.value.trim().toLowerCase();\n        clearTimeout(searchDebounceTimer);\n        searchDebounceTimer = setTimeout(() => displayProcurementList(), 200);\n    });\n}\n\n// Category filter pills - event delegation for dynamically added pills\nconst categoryPillsContainer = document.getElementById('categoryPills');\nif (categoryPillsContainer) {\n    categoryPillsContainer.addEventListener('click', (e) => {\n        const pill = e.target.closest('.category-pill');\n        if (!pill) return;\n\n        document.querySelectorAll('.category-pill').forEach(p => p.classList.remove('active'));\n        pill.classList.add('active');\n        selectedCategory = pill.dataset.category;\n        displayProcurementList();\n    });\n}\n\n// Populate category pills from API response\nfunction populateCategoryPills(categories) {\n    const container = document.getElementById('categoryPills');\n    if (!container) return;\n\n    container.innerHTML = '<button class=\"category-pill active\" data-category=\"\">All</button>';\n\n    const displayNames = {\n        'Indian Vegetables': 'Vegetables',\n        'Exotic Vegetables': 'Exotic',\n        'Fruits': 'Fruits',\n        'Frozen': 'Frozen',\n        'Dairy': 'Dairy'\n    };\n\n    categories.forEach(cat => {\n        const pill = createElement('button', {\n            className: 'category-pill' + (selectedCategory === cat ? ' active' : ''),\n            dataset: { category: cat }\n        }, displayNames[cat] || cat);\n        container.appendChild(pill);\n    });\n\n    if (selectedCategory) {\n        const currentPill = container.querySelector(`[data-category=\"${selectedCategory}\"]`);\n        if (currentPill) {\n            container.querySelector('.active')?.classList.remove('active');\n            currentPill.classList.add('active');\n        } else {\n            selectedCategory = '';\n        }\n    }\n}\n\n// Procured section toggle\nif (procuredHeader) {\n    procuredHeader.addEventListener('click', () => {\n        procuredHeader.classList.toggle('collapsed');\n    });\n}\n\n// Initialize sound on first user interaction\nfunction initSound() {\n    if (soundEnabled) return;\n    try {\n        audioContext = new (window.AudioContext || window.webkitAudioContext)();\n        preloadNotificationSound();\n        soundEnabled = true;\n    } catch (e) {\n        console.log('Could not initialize audio:', e);\n    }\n}\n\ndocument.addEventListener('click', initSound, { once: true });\ndocument.addEventListener('touchstart', initSound, { once: true });\n\nasync function loadData() {\n    try {\n        const [ratesRes, procurementRes] = await Promise.all([\n            fetch('/api/market-rates', { credentials: 'include' }),\n            fetch('/api/supplier/procurement-summary', { credentials: 'include' })\n        ]);\n\n        if (!ratesRes.ok || !procurementRes.ok) {\n            const failedEndpoint = !ratesRes.ok ? 'rates' : 'procurement';\n            throw new Error(`Failed to load ${failedEndpoint} data`);\n        }\n\n        const ratesData = await ratesRes.json();\n        const procurementResponse = await procurementRes.json();\n\n        rates = ratesData.data || [];\n        procurementData = {\n            toProcure: procurementResponse.toProcure || [],\n            procured: procurementResponse.procured || [],\n            categories: procurementResponse.categories || []\n        };\n\n        populateCategoryPills(procurementData.categories);\n        detectNewOrders(procurementData);\n        storeQuantities(procurementData);\n        displayProcurementList();\n        startPolling();\n    } catch (error) {\n        console.error('Error loading data:', error);\n        const toProcureEl = document.getElementById('toProcureList');\n        if (toProcureEl) {\n            toProcureEl.innerHTML = '';\n            toProcureEl.appendChild(createElement('div', { className: 'empty-state' }, [\n                createElement('p', {}, 'Data not available'),\n                createElement('button', {\n                    id: 'retryBtn',\n                    className: 'btn-retry',\n                    style: { marginTop: '1rem', padding: '0.5rem 1rem', background: 'var(--dusty-olive)', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer' },\n                    onclick: loadData\n                }, 'Try Again')\n            ]));\n        }\n    }\n}\n\nfunction storeQuantities(data) {\n    lastQuantities = {};\n    [...data.toProcure, ...data.procured].forEach(item => {\n        lastQuantities[item.productId] = item.totalQty;\n    });\n}\n\nfunction detectNewOrders(newData) {\n    if (Object.keys(lastQuantities).length === 0) return;\n\n    let newOrderCount = 0;\n    const allItems = [...newData.toProcure, ...newData.procured];\n\n    allItems.forEach(item => {\n        const prevQty = lastQuantities[item.productId] || 0;\n        if (item.totalQty > prevQty) {\n            newOrderCount++;\n        }\n    });\n\n    if (newOrderCount > 0) {\n        playNotificationSound();\n\n        if (newOrderBadge) {\n            newOrderBadge.textContent = `${newOrderCount} new`;\n            newOrderBadge.classList.remove('hidden');\n\n            if (badgeHideTimeout) {\n                clearTimeout(badgeHideTimeout);\n            }\n\n            badgeHideTimeout = setTimeout(() => {\n                if (newOrderBadge) newOrderBadge.classList.add('hidden');\n                badgeHideTimeout = null;\n            }, 30000);\n        }\n\n        showToast(`${newOrderCount} product(s) have new orders!`, 'info');\n    }\n}\n\nfunction startPolling() {\n    if (pollingInterval) clearInterval(pollingInterval);\n\n    pollingInterval = setInterval(async () => {\n        if (isPolling) return;\n        isPolling = true;\n\n        try {\n            if (!document.getElementById('toProcureList')) {\n                clearInterval(pollingInterval);\n                pollingInterval = null;\n                return;\n            }\n\n            const res = await fetch('/api/supplier/procurement-summary', { credentials: 'include' });\n            if (res.status === 401) {\n                clearInterval(pollingInterval);\n                pollingInterval = null;\n                window.location.href = '/pages/auth/login.html';\n                return;\n            }\n            if (!res.ok) {\n                console.warn('Polling failed:', res.status);\n                return;\n            }\n            const data = await res.json();\n\n            const newProcurementData = {\n                toProcure: data.toProcure || [],\n                procured: data.procured || [],\n                categories: data.categories || []\n            };\n\n            detectNewOrders(newProcurementData);\n            procurementData = newProcurementData;\n            storeQuantities(procurementData);\n            displayProcurementList(true);\n        } catch (error) {\n            console.error('Polling error:', error);\n        } finally {\n            isPolling = false;\n        }\n    }, 30000);\n}\n\nfunction displayProcurementList(preserveInputs = false) {\n    const toProcureContainer = document.getElementById('toProcureList');\n    const procuredContainer = document.getElementById('procuredList');\n    const emptyState = document.getElementById('procurementEmpty');\n    const procuredCountEl = document.getElementById('procuredCount');\n\n    if (!toProcureContainer || !procuredContainer) {\n        console.error('Purchase List: Required DOM elements missing.');\n        const fallback = document.querySelector('.procurement-container');\n        if (fallback) {\n            const existing = fallback.querySelector('.procurement-error');\n            if (!existing) {\n                const errDiv = document.createElement('div');\n                errDiv.className = 'procurement-error';\n                errDiv.style.cssText = 'padding:1.5rem;text-align:center;color:var(--error);font-size:0.875rem;';\n                errDiv.textContent = 'Purchase list failed to load. Please refresh the page.';\n                fallback.appendChild(errDiv);\n            }\n        }\n        return;\n    }\n\n    const inputValues = {};\n    if (preserveInputs) {\n        document.querySelectorAll('.item-rate-input').forEach(input => {\n            if (input.value) {\n                inputValues[input.dataset.productId] = input.value;\n            }\n        });\n    }\n\n    toProcureContainer.innerHTML = '';\n    procuredContainer.innerHTML = '';\n\n    const filterItems = (items) => {\n        return items.filter(item => {\n            const matchesSearch = !searchQuery || item.productName.toLowerCase().includes(searchQuery);\n            const matchesCategory = !selectedCategory || item.category === selectedCategory;\n            return matchesSearch && matchesCategory;\n        });\n    };\n\n    const filteredToProcure = filterItems(procurementData.toProcure);\n    const filteredProcured = filterItems(procurementData.procured);\n\n    if (procuredCountEl) {\n        procuredCountEl.textContent = filteredProcured.length;\n    }\n\n    if (filteredToProcure.length === 0 && procurementData.toProcure.length === 0) {\n        if (emptyState) emptyState.classList.remove('hidden');\n        toProcureContainer.innerHTML = '<div class=\"empty-list-msg\">No items to procure</div>';\n    } else {\n        if (emptyState) emptyState.classList.add('hidden');\n    }\n\n    const rateMap = {};\n    rates.forEach(rate => { rateMap[rate.product] = rate; });\n\n    // Render TO PROCURE section\n    if (filteredToProcure.length > 0) {\n        const fragment = document.createDocumentFragment();\n\n        fragment.appendChild(createElement('div', { className: 'procurement-column-header' }, [\n            createElement('span', { className: 'col-expand' }),\n            createElement('span', { className: 'col-name' }, 'Product'),\n            createElement('span', { className: 'col-qty' }, 'Qty'),\n            createElement('span', { className: 'col-input' }, 'Rate')\n        ]));\n\n        let currentCategory = '';\n        filteredToProcure.forEach(item => {\n            if (item.category !== currentCategory) {\n                currentCategory = item.category;\n                fragment.appendChild(createElement('div', { className: 'category-divider' }, currentCategory));\n            }\n\n            const rate = rateMap[item.productId];\n            const currentRate = item.currentRate || rate?.rate || 0;\n            const savedValue = inputValues[item.productId] || '';\n            const unsavedClass = currentRate === 0 ? ' unsaved' : '';\n\n            let qtyDisplay;\n            if (item.wasProcured) {\n                qtyDisplay = createElement('span', { className: 'qty-breakdown' }, [\n                    createElement('span', { className: 'procured-qty' }, String(item.procuredQty || 0)),\n                    createElement('span', { className: 'separator' }, '+'),\n                    createElement('span', { className: 'new-qty highlight-new' }, String(item.newQty || 0))\n                ]);\n            } else {\n                qtyDisplay = createElement('span', { className: 'qty-simple' }, String(item.totalQty || 0));\n            }\n\n            const detailRows = [\n                createElement('div', { className: 'detail-row' }, [\n                    createElement('span', { className: 'detail-label' }, 'Total Orders'),\n                    createElement('span', { className: 'detail-value' }, item.totalOrders || 0)\n                ])\n            ];\n\n            if (item.wasProcured && item.lastRate) {\n                detailRows.unshift(createElement('div', { className: 'detail-row highlight-info' }, [\n                    createElement('span', { className: 'detail-label' }, 'Last Rate'),\n                    createElement('span', { className: 'detail-value' }, `₹${item.lastRate}/${item.unit}`)\n                ]));\n            }\n\n            detailRows.push(\n                createElement('div', { className: 'detail-row' }, [\n                    createElement('span', { className: 'detail-label' }, 'Est. Cost'),\n                    createElement('span', { className: 'detail-value highlight' },\n                        item.totalQty > 0 && currentRate > 0 ? formatCurrency(item.totalQty * currentRate) : '—')\n                ]),\n                createElement('div', { className: 'detail-row' }, [\n                    createElement('span', { className: 'detail-label' }, 'Trend'),\n                    createElement('span', { className: 'detail-value' },\n                        item.trend === 'up' ? '↑ Up' : item.trend === 'down' ? '↓ Down' : '— Stable')\n                ])\n            );\n\n            const procurementItem = createElement('div', {\n                className: `procurement-item${unsavedClass}${item.wasProcured ? ' was-procured' : ''}`,\n                dataset: { productId: item.productId }\n            }, [\n                createElement('div', {\n                    className: 'item-main',\n                    onclick: (e) => toggleExpand(e.currentTarget)\n                }, [\n                    createElement('span', { className: 'item-expand' }, '▶'),\n                    createElement('span', { className: 'item-name' }, item.productName),\n                    qtyDisplay,\n                    createElement('span', { className: 'item-unit' }, item.unit),\n                    createElement('input', {\n                        type: 'number',\n                        className: 'item-rate-input' + (savedValue ? ' changed' : ''),\n                        dataset: {\n                            productId: item.productId,\n                            productName: item.productName,\n                            currentRate: currentRate,\n                            quantity: item.totalQty || 0,\n                            notProcuredToday: item.rate === undefined ? 'true' : ''\n                        },\n                        placeholder: '₹0',\n                        value: savedValue,\n                        step: '0.01',\n                        min: '0',\n                        onclick: (e) => e.stopPropagation(),\n                        onchange: (e) => handleRateChange(e.target),\n                        oninput: (e) => handleRateInput(e.target)\n                    })\n                ]),\n                createElement('div', { className: 'item-details' }, detailRows)\n            ]);\n            fragment.appendChild(procurementItem);\n        });\n\n        toProcureContainer.appendChild(fragment);\n    } else if (searchQuery || selectedCategory) {\n        toProcureContainer.innerHTML = '<div class=\"empty-list-msg\">No matching items</div>';\n    }\n\n    // Render PROCURED section\n    if (filteredProcured.length > 0) {\n        const fragment = document.createDocumentFragment();\n\n        let currentCategory = '';\n        filteredProcured.forEach(item => {\n            if (item.category !== currentCategory) {\n                currentCategory = item.category;\n                fragment.appendChild(createElement('div', { className: 'category-divider' }, currentCategory));\n            }\n\n            const procurementItem = createElement('div', {\n                className: 'procurement-item procured-item',\n                dataset: { productId: item.productId }\n            }, [\n                createElement('div', {\n                    className: 'item-main',\n                    onclick: (e) => toggleExpand(e.currentTarget)\n                }, [\n                    createElement('span', { className: 'item-expand' }, '▶'),\n                    createElement('span', { className: 'item-name' }, '✓ ' + item.productName),\n                    createElement('span', { className: 'qty-simple' }, String(item.procuredQty || 0)),\n                    createElement('span', { className: 'item-unit' }, item.unit),\n                    createElement('span', { className: 'procured-rate' }, `₹${item.rate}`)\n                ]),\n                createElement('div', { className: 'item-details' }, [\n                    createElement('div', { className: 'detail-row' }, [\n                        createElement('span', { className: 'detail-label' }, 'Procured At'),\n                        createElement('span', { className: 'detail-value' },\n                            new Date(item.procuredAt).toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit', timeZone: 'Asia/Kolkata' }))\n                    ]),\n                    createElement('div', { className: 'detail-row' }, [\n                        createElement('span', { className: 'detail-label' }, 'Total Orders'),\n                        createElement('span', { className: 'detail-value' }, item.totalOrders || 0)\n                    ]),\n                    createElement('div', { className: 'detail-row' }, [\n                        createElement('span', { className: 'detail-label' }, 'Total Value'),\n                        createElement('span', { className: 'detail-value highlight' }, formatCurrency(item.procuredQty * item.rate))\n                    ]),\n                    createElement('div', { className: 'detail-actions' }, [\n                        createElement('button', {\n                            className: 'btn-undo',\n                            onclick: (e) => {\n                                e.stopPropagation();\n                                undoProcurement(item.productId, item.productName);\n                            }\n                        }, 'Undo')\n                    ])\n                ])\n            ]);\n            fragment.appendChild(procurementItem);\n        });\n\n        procuredContainer.appendChild(fragment);\n    }\n}\n\nfunction toggleExpand(element) {\n    element.closest('.procurement-item').classList.toggle('expanded');\n}\n\nfunction handleRateInput(input) {\n    const currentRate = parseFloat(input.dataset.currentRate);\n    const newRate = parseFloat(input.value);\n    const notProcuredToday = input.dataset.notProcuredToday === 'true';\n    input.classList.toggle('changed', input.value && (newRate !== currentRate || notProcuredToday));\n}\n\nfunction handleRateChange(input) {\n    const productId = input.dataset.productId;\n    const productName = input.dataset.productName;\n    const currentRate = parseFloat(input.dataset.currentRate);\n    const quantity = parseFloat(input.dataset.quantity) || 0;\n    const newRate = parseFloat(input.value);\n\n    const notProcuredToday = input.dataset.notProcuredToday === 'true';\n    if (input.value && (newRate !== currentRate || notProcuredToday) && newRate > 0) {\n        changedRates[productId] = { product: productId, productName, rate: newRate, previousRate: currentRate, quantity };\n        input.classList.add('changed');\n    } else {\n        delete changedRates[productId];\n        input.classList.remove('changed');\n    }\n\n    if (saveRatesBtn) saveRatesBtn.classList.toggle('show', Object.keys(changedRates).length > 0);\n}\n\nasync function undoProcurement(productId, productName) {\n    if (!confirm(`Remove ${productName} from procured list?`)) return;\n\n    const item = document.querySelector(`[data-product-id=\"${CSS.escape(productId)}\"]`);\n    const undoBtn = item?.querySelector('.btn-undo');\n    if (undoBtn) { undoBtn.disabled = true; undoBtn.classList.add('btn-loading'); }\n\n    try {\n        const csrfToken = await Auth.ensureCsrfToken();\n        const headers = { 'Content-Type': 'application/json' };\n        if (csrfToken) headers['X-CSRF-Token'] = csrfToken;\n\n        const res = await fetch(`/api/supplier/procure/${encodeURIComponent(productId)}`, {\n            method: 'DELETE',\n            credentials: 'include',\n            headers\n        });\n\n        if (!res.ok) {\n            const data = await res.json();\n            showToast(data.message || 'Could not undo', 'error');\n            return;\n        }\n\n        showToast(`${productName} moved back to TO PROCURE`, 'success');\n        loadData();\n    } catch (error) {\n        console.error('Error undoing procurement:', error);\n        showToast('Could not undo', 'error');\n        if (undoBtn) { undoBtn.disabled = false; undoBtn.classList.remove('btn-loading'); }\n    }\n}\n\nfunction printList() {\n    const escapeHtml = (str) => {\n        if (typeof str !== 'string') return String(str);\n        return str\n            .replace(/&/g, '&amp;')\n            .replace(/</g, '&lt;')\n            .replace(/>/g, '&gt;')\n            .replace(/\"/g, '&quot;')\n            .replace(/'/g, '&#039;');\n    };\n\n    const filterItems = (items) => {\n        return items.filter(item => {\n            const matchesSearch = !searchQuery || item.productName.toLowerCase().includes(searchQuery);\n            const matchesCategory = !selectedCategory || item.category === selectedCategory;\n            return matchesSearch && matchesCategory;\n        });\n    };\n\n    const filteredToProcure = filterItems(procurementData.toProcure);\n    const filteredProcured = filterItems(procurementData.procured);\n\n    let toProcureRows = '';\n    let currentCategory = '';\n    filteredToProcure.forEach(item => {\n        if (item.category !== currentCategory) {\n            currentCategory = item.category;\n            toProcureRows += `<div class=\"category-header\">${escapeHtml(currentCategory)}</div>`;\n        }\n        const qtyDisplay = item.wasProcured\n            ? `${item.procuredQty || 0} + ${item.newQty || 0}`\n            : `${item.totalQty || 0}`;\n        toProcureRows += `\n            <div class=\"procurement-item\">\n                <span class=\"item-name\">${escapeHtml(item.productName)}</span>\n                <span class=\"qty-breakdown\">${qtyDisplay}</span>\n                <span class=\"item-unit\">${escapeHtml(item.unit)}</span>\n                <span class=\"current-rate\">₹${(item.currentRate || 0).toFixed(0)}</span>\n            </div>`;\n    });\n\n    let procuredRows = '';\n    currentCategory = '';\n    filteredProcured.forEach(item => {\n        if (item.category !== currentCategory) {\n            currentCategory = item.category;\n            procuredRows += `<div class=\"category-header\">${escapeHtml(currentCategory)}</div>`;\n        }\n        procuredRows += `\n            <div class=\"procurement-item procured-item\">\n                <span class=\"item-name\">${escapeHtml(item.productName)}</span>\n                <span class=\"qty-breakdown\">${item.procuredQty || 0}</span>\n                <span class=\"item-unit\">${escapeHtml(item.unit)}</span>\n                <span class=\"procured-rate\">₹${item.rate}</span>\n            </div>`;\n    });\n\n    const printWindow = window.open('', '_blank');\n    if (!printWindow) {\n        showToast('Popup blocked. Please allow popups for this site.', 'error');\n        return;\n    }\n\n    printWindow.document.write(`\n        <html>\n        <head>\n            <title>Purchase List - Pratibha Marketing</title>\n            <style>\n                body { font-family: Arial, sans-serif; padding: 20px; }\n                h1 { font-size: 18px; margin-bottom: 10px; }\n                h2 { font-size: 14px; margin-top: 20px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px; }\n                .date { color: #666; margin-bottom: 20px; }\n                .category-header { font-weight: bold; color: #666; margin: 15px 0 5px; font-size: 12px; text-transform: uppercase; }\n                .procurement-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }\n                .item-name { font-weight: bold; flex: 1; }\n                .qty-breakdown { font-family: monospace; min-width: 100px; }\n                .item-unit { color: #666; min-width: 50px; }\n                .current-rate { color: #666; min-width: 60px; text-align: right; }\n                .procured-rate { color: #5d7a5f; font-weight: bold; min-width: 60px; text-align: right; }\n                .procured-item .item-name::before { content: '✓ '; color: #5d7a5f; }\n                .empty-msg { color: #999; font-style: italic; padding: 10px 0; }\n            </style>\n        </head>\n        <body>\n            <h1>Purchase List - Pratibha Marketing</h1>\n            <div class=\"date\">${new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</div>\n            <h2>TO PROCURE (${filteredToProcure.length} items)</h2>\n            ${toProcureRows || '<div class=\"empty-msg\">No items to procure</div>'}\n            <h2>PROCURED (${filteredProcured.length} items)</h2>\n            ${procuredRows || '<div class=\"empty-msg\">No procured items</div>'}\n        </body>\n        </html>\n    `);\n    printWindow.document.close();\n    printWindow.print();\n}\n\nfunction exportCSV() {\n    const allItems = [...procurementData.toProcure, ...procurementData.procured];\n    const csvEscape = (val) => `\"${String(val).replace(/\"/g, '\"\"')}\"`;\n\n    const headers = ['Category', 'Product', 'Unit', 'Procured Qty', 'New Qty', 'Total Qty', 'Rate', 'Status'];\n    const rows = allItems.map(item => {\n        const status = procurementData.procured.find(p => p.productId === item.productId) ? 'Procured' : 'To Procure';\n        const rate = item.rate || item.currentRate || 0;\n\n        return [\n            csvEscape(item.category),\n            csvEscape(item.productName),\n            csvEscape(item.unit),\n            item.procuredQty || 0,\n            item.newQty || 0,\n            item.totalQty || item.procuredQty || 0,\n            rate,\n            status\n        ].join(',');\n    });\n\n    const csvContent = [headers.join(','), ...rows].join('\\n');\n    const blob = new Blob([csvContent], { type: 'text/csv' });\n    const url = window.URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `purchase-list-${new Date().toISOString().split('T')[0]}.csv`;\n    a.click();\n    window.URL.revokeObjectURL(url);\n}\n\nasync function saveAllRates() {\n    if (!saveRatesBtn) return;\n    saveRatesBtn.textContent = 'Saving...';\n    saveRatesBtn.disabled = true;\n\n    const failures = [];\n    const successfulProducts = [];\n\n    const headers = { 'Content-Type': 'application/json' };\n    let csrfToken = await Auth.ensureCsrfToken();\n    if (csrfToken) {\n        headers['X-CSRF-Token'] = csrfToken;\n    }\n\n    const entries = Object.entries(changedRates);\n    const BATCH_SIZE = 5;\n\n    for (let i = 0; i < entries.length; i += BATCH_SIZE) {\n        const batch = entries.slice(i, i + BATCH_SIZE);\n\n        const results = await Promise.all(batch.map(async ([productId, rateData]) => {\n            try {\n                let response = await fetch('/api/supplier/procure', {\n                    method: 'POST',\n                    headers,\n                    credentials: 'include',\n                    body: JSON.stringify({\n                        productId: rateData.product,\n                        rate: rateData.rate,\n                        quantity: rateData.quantity || 0\n                    })\n                });\n\n                if (response.status === 403) {\n                    const errorData = await response.json().catch(() => ({}));\n                    if (errorData.message?.toLowerCase().includes('csrf')) {\n                        csrfToken = await Auth.refreshCsrfToken();\n                        if (csrfToken) {\n                            headers['X-CSRF-Token'] = csrfToken;\n                            response = await fetch('/api/supplier/procure', {\n                                method: 'POST',\n                                headers,\n                                credentials: 'include',\n                                body: JSON.stringify({\n                                    productId: rateData.product,\n                                    rate: rateData.rate,\n                                    quantity: rateData.quantity || 0\n                                })\n                            });\n                        }\n                    } else {\n                        return { productId, success: false, productName: rateData.productName || productId, error: errorData.message || `HTTP ${response.status}` };\n                    }\n                }\n\n                if (!response.ok) {\n                    const errorData = await response.json().catch(() => ({}));\n                    return { productId, success: false, productName: rateData.productName || productId, error: errorData.message || `HTTP ${response.status}` };\n                } else {\n                    return { productId, success: true };\n                }\n            } catch (error) {\n                console.error('Error saving rate:', error);\n                return { productId, success: false, productName: rateData.productName || productId, error: error.message || 'Network error' };\n            }\n        }));\n\n        results.forEach(result => {\n            if (result.success) {\n                successfulProducts.push(result.productId);\n            } else {\n                failures.push({ productName: result.productName, error: result.error });\n            }\n        });\n    }\n\n    for (const productId of successfulProducts) {\n        delete changedRates[productId];\n    }\n\n    saveRatesBtn.textContent = 'Save';\n    saveRatesBtn.disabled = false;\n\n    if (failures.length > 0) {\n        showToast(`${failures.length} rate(s) not saved. Try again.`, 'info');\n        if (Object.keys(changedRates).length > 0) {\n            saveRatesBtn.classList.add('show');\n        } else {\n            saveRatesBtn.classList.remove('show');\n        }\n    } else {\n        saveRatesBtn.classList.remove('show');\n        document.querySelectorAll('.item-rate-input').forEach(input => {\n            input.value = '';\n            input.classList.remove('changed');\n        });\n        showToast('Items marked as procured!', 'success');\n    }\n\n    loadData();\n}\n\nasync function init() {\n    const user = await Auth.requireAuth(['staff']);\n    if (!user) return;\n\n    const userBadge = document.getElementById('userBadge');\n    if (userBadge) {\n        userBadge.textContent = user.name || user.email || 'User';\n    }\n    loadData();\n}\n\ninit();\n"],"names":["waitForAuth","attempts","resolve","reject","Auth","initPage","rates","procurementData","searchQuery","selectedCategory","changedRates","lastQuantities","pollingInterval","badgeHideTimeout","audioContext","notificationAudio","soundEnabled","isPolling","preloadNotificationSound","startPolling","playNotificationSound","playWebAudioNotification","osc1","osc2","gainNode","now","printBtn","exportBtn","saveRatesBtn","purchaseSearch","newOrderBadge","procuredHeader","printList","exportCSV","saveAllRates","searchDebounceTimer","displayProcurementList","categoryPillsContainer","pill","p","populateCategoryPills","categories","container","displayNames","cat","createElement","currentPill","initSound","loadData","ratesRes","procurementRes","failedEndpoint","ratesData","procurementResponse","detectNewOrders","storeQuantities","error","toProcureEl","data","item","newData","newOrderCount","prevQty","showToast","res","newProcurementData","preserveInputs","toProcureContainer","procuredContainer","emptyState","procuredCountEl","fallback","errDiv","inputValues","input","filterItems","items","matchesSearch","matchesCategory","filteredToProcure","filteredProcured","rateMap","rate","fragment","currentCategory","currentRate","savedValue","unsavedClass","qtyDisplay","detailRows","formatCurrency","procurementItem","e","toggleExpand","handleRateChange","handleRateInput","undoProcurement","element","newRate","notProcuredToday","productId","productName","quantity","undoBtn","csrfToken","headers","escapeHtml","str","toProcureRows","procuredRows","printWindow","allItems","csvEscape","val","rows","status","csvContent","blob","url","a","failures","successfulProducts","entries","BATCH_SIZE","i","batch","rateData","response","errorData","result","init","user","userBadge"],"mappings":"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"}