import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as d,c as o}from"./ui-Vfn0bm3t.js";import"./api-C8X7spwu.js";function G(t){if(!t)return"";const e=document.createElement("div");return e.textContent=t,e.innerHTML}const fe=(t=1e4)=>new Promise((e,a)=>{const n=Date.now(),i=()=>{if(window.Auth)return e(window.Auth);if(Date.now()-n>t)return a(new Error("Auth not available"));setTimeout(i,50)};i()}),A=await fe();let U=[];const K={};let ee=[],y=[],x="all",q=null,E=null,b=null,$={},B={},T=!1,Y=!1,ce=!1,w=null,k=[];async function ge(){if(b=await A.requireAuth(),!!b){if(b.role==="customer"){const t=document.getElementById("modalFooter");t&&(t.style.display="none")}ye(),await Promise.all([j(),we(),he()]),ke(),Ne(),ve()}}function ve(){const t=new URLSearchParams(window.location.search),e=t.get("order"),a=t.get("action");e&&(window.history.replaceState({},"",window.location.pathname),a==="pack"?me(e):R(e))}function ye(){if(ce)return;ce=!0;const t=document.getElementById("ordersList");if(!t)return;document.addEventListener("click",r=>{r.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(c=>{c.classList.remove("swiped","swiped-single")})});let e={startX:0,isDragging:!1,currentItem:null};t.addEventListener("touchstart",r=>{const c=r.target.closest(".swipe-item");c&&(e={startX:r.touches[0].clientX,isDragging:!0,currentItem:c},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s!==c&&s.classList.remove("swiped","swiped-single")}))},{passive:!0}),t.addEventListener("touchmove",r=>{if(!e.isDragging||!e.currentItem)return;const c=e.startX-r.touches[0].clientX,s=e.currentItem.querySelectorAll(".swipe-action").length;c>50?(e.currentItem.classList.remove("swiped-single","swiped"),s===1?e.currentItem.classList.add("swiped-single"):e.currentItem.classList.add("swiped")):c<-20&&e.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),t.addEventListener("touchend",()=>{e.isDragging=!1,e.currentItem=null},{passive:!0});let a={startX:0,isDragging:!1,currentItem:null};t.addEventListener("mousedown",r=>{const c=r.target.closest(".swipe-item");c&&(r.target.closest("button")||(a={startX:r.clientX,isDragging:!0,currentItem:c},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s!==c&&s.classList.remove("swiped","swiped-single")})))}),t.addEventListener("mousemove",r=>{if(!a.isDragging||!a.currentItem)return;const c=a.startX-r.clientX,s=a.currentItem.querySelectorAll(".swipe-action").length;c>50?(a.currentItem.classList.remove("swiped-single","swiped"),s===1?a.currentItem.classList.add("swiped-single"):a.currentItem.classList.add("swiped")):c<-20&&a.currentItem.classList.remove("swiped","swiped-single")}),t.addEventListener("mouseup",()=>{a.isDragging=!1,a.currentItem=null}),t.addEventListener("mouseleave",()=>{a.isDragging=!1,a.currentItem=null});const n=document.getElementById("orderModal");n&&(n.onclick=r=>{r.target.id==="orderModal"&&V()});const i=document.getElementById("invoiceModal");i&&(i.onclick=r=>{r.target.id==="invoiceModal"&&oe()})}async function we(){try{const t=await fetch("/api/market-rates",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);((await t.json()).data||[]).forEach(a=>{const n=typeof a.product=="object"?a.product._id:a.product;K[n]=a.rate})}catch(t){console.error("Failed to load market rates:",t),de("market-rates","Market rates may be outdated")}}async function he(){try{const t=await fetch("/api/products",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);ee=((await t.json()).data||[]).filter(a=>a.isActive!==!1)}catch(t){console.error("Failed to load products:",t),de("products","Product list unavailable")}}function de(t,e){if(document.querySelector(`.data-warning[data-type="${t}"]`))return;const a=o("div",{className:"data-warning",dataset:{type:t},style:{background:"var(--warning, #b89a5a)",color:"white",padding:"0.5rem 1rem",fontSize:"0.85rem",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem"}},[o("span",{},`⚠️ ${e}`),o("button",{style:{background:"transparent",border:"none",color:"white",cursor:"pointer",fontSize:"1rem",padding:"0 0.25rem"},onclick:i=>{i.target.closest(".data-warning").remove()}},"×")]),n=document.getElementById("ordersList");n&&n.parentElement&&n.parentElement.insertBefore(a,n)}async function j(){try{const t=await fetch("/api/orders?limit=100",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);const e=await t.json();if(!e.success)throw new Error(e.message||"Orders temporarily unavailable");U=e.data||[];const a=U.filter(n=>!n._id||!/^[a-f\d]{24}$/i.test(n._id));a.length>0&&console.warn("Orders with invalid IDs:",a.map(n=>({orderNumber:n.orderNumber,_id:n._id}))),te()}catch(t){if(console.error("Failed to load orders:",t),!U||U.length===0){const e=document.getElementById("ordersList"),a=navigator.onLine?"Orders not available":"No internet connection";e.innerHTML="",e.appendChild(o("div",{className:"empty-state"},[o("p",{},a),o("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:j},"Try Again")]))}}}function be(t){if(!t)return"?";const e=t.trim().split(/\s+/);return e.length===1?e[0].substring(0,2).toUpperCase():(e[0][0]+e[e.length-1][0]).toUpperCase()}function te(){const t=document.getElementById("ordersList");if(!t)return;const e=document.getElementById("searchInput"),a=e?e.value.toLowerCase():"",n=b?.role==="admin",i=b?.role==="admin"||b?.role==="staff";let r=U.filter(s=>s._id&&/^[a-f\d]{24}$/i.test(s._id));if(x==="all"?r=r.filter(s=>s.status!=="cancelled"):r=r.filter(s=>s.status===x),a&&(r=r.filter(s=>s.orderNumber?.toLowerCase().includes(a)||s.customer?.name?.toLowerCase().includes(a))),!r.length){t.innerHTML="",t.appendChild(o("div",{className:"empty-state"},"No orders found"));return}t.innerHTML="";const c=document.createDocumentFragment();r.forEach((s,f)=>{let m=null;s.batch?.batchType&&(m=o("span",{className:"badge badge-batch"},s.batch.batchType));let v=null;i&&s.status==="confirmed"&&(s.packingDone?v=o("span",{className:"packing-status-badge status-packed"},"✓ Packed"):v=o("span",{className:"packing-status-badge status-ready"},"Ready"));const p=o("div",{className:"swipe-content",onclick:()=>window.viewOrder(s._id)},[o("div",{className:"order-avatar"},be(s.customer?.name)),o("div",{className:"order-info"},[o("div",{className:"order-customer"},s.customer?.name||"Unknown"),s.notes?o("div",{className:"order-notes"},s.notes):null,o("div",{className:"order-meta-row"},[o("span",{className:"order-number"},`Order #${s.orderNumber}`),m,v])]),o("div",{className:"order-amount-pill"},`₹${(s.totalAmount||0).toLocaleString("en-IN")}`)]),u=[];i&&s.status==="confirmed"&&!s.packingDone&&u.push(o("button",{className:"swipe-action pack",onclick:P=>{P.stopPropagation(),window.openPackingPanel(s._id)}},"Pack")),i&&s.status==="confirmed"&&s.batch&&u.push(o("button",{className:"swipe-action bill",onclick:P=>{P.stopPropagation(),window.downloadDeliveryBill(s._id,s.batch?._id||s.batch)}},"Bill")),n&&u.push(o("button",{className:"swipe-action delete",onclick:P=>{P.stopPropagation(),window.deleteOrder(s._id)}},"Delete"));const M=o("div",{className:"swipe-actions"},u);let l="";u.length===1?l="single-action":u.length===2&&(l="two-actions");const g=o("div",{className:`swipe-item card-fade-in ${l}`.trim(),dataset:{orderId:s._id},style:{animationDelay:`${f*.05}s`}},[p,M]);c.appendChild(g)}),t.appendChild(c)}function ke(){const t=document.getElementById("filterSegments"),e=document.getElementById("segmentIndicator"),a=t.querySelectorAll(".segment-btn");function n(r){const c=t.getBoundingClientRect(),s=r.getBoundingClientRect(),f=s.left-c.left,m=s.width;e.style.left=f+"px",e.style.width=m+"px"}const i=t.querySelector(".segment-btn.active");i&&setTimeout(()=>n(i),10),a.forEach(r=>{r.onclick=()=>{a.forEach(s=>s.classList.remove("active")),r.classList.add("active"),n(r),x=r.dataset.filter;const c=document.getElementById("ordersList");c.classList.add("segment-content"),te(),setTimeout(()=>c.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const r=t.querySelector(".segment-btn.active");r&&n(r)})}function Ie(t,e){let a;return function(...n){clearTimeout(a),a=setTimeout(()=>t.apply(this,n),e)}}function Ne(){const t=document.getElementById("searchInput");if(t){const e=Ie(te,200);t.addEventListener("input",e)}}let L=null,D=null,S=new Set;async function Ce(t,e){if(b?.role==="customer"){d("Delivery bills are not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(r=>{r.classList.remove("swiped","swiped-single")});const a=/^[a-f\d]{24}$/i.test(t),n=/^[a-f\d]{24}$/i.test(e);if(!t||!a||!e||!n){console.error("Invalid order or batch ID:",t,e),d("Order data updating. Please refresh.","info");return}const i=document.querySelector(`.swipe-item[data-order-id="${t}"] .swipe-action.bill`);i&&(i.disabled=!0,i.classList.add("btn-loading")),d("Downloading delivery bill...","info");try{const r=await fetch(`/api/batches/${e}/bills/${t}/download?copy=original`,{credentials:"include"});if(!r.ok){const p=await r.json().catch(()=>({}));throw new Error(p.message||"Failed to download delivery bill")}const c=r.headers.get("Content-Disposition");let s="delivery-bill.pdf";if(c){const p=c.match(/filename="?([^";\n]+)"?/);p&&(s=p[1])}const f=await r.blob(),m=window.URL.createObjectURL(f),v=document.createElement("a");v.href=m,v.download=s,document.body.appendChild(v),v.click(),window.URL.revokeObjectURL(m),v.remove(),d("Delivery bill downloaded!","success")}catch(r){console.error("Error downloading delivery bill:",r),d(r.message||"Failed to download delivery bill","error")}finally{i&&(i.disabled=!1,i.classList.remove("btn-loading"))}}async function ne(t){if(b?.role==="customer"){d("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i.classList.remove("swiped","swiped-single")});const e=/^[a-f\d]{24}$/i.test(t);if(!t||!e){console.error("Invalid order ID:",t),d("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const a=document.getElementById("invoiceModalBody");a.innerHTML="",a.appendChild(o("div",{className:"invoice-loading"},"Loading invoice data..."));const n=document.getElementById("generateInvoiceBtn");n&&(n.disabled=!0);try{if(!(await Ee()).success)throw new Error("Could not load firm list. Please try again.");const r=await fetch(`/api/invoices/${t}/split`,{credentials:"include"});if(!r.ok){const s=await r.json().catch(()=>({}));throw new Error(s.message||"Invoice data temporarily unavailable")}L=(await r.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${L.orderNumber}`,ae()}catch(i){console.error("Print order error:",i),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(o("div",{className:"invoice-no-items"},[o("p",{},"Invoice data not available"),o("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},i.message)]))}}let Q=[];async function Ee(){if(Q.length>0)return{success:!0};try{const t=await fetch("/api/invoices/firms",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);return Q=(await t.json()).data||[],{success:!0}}catch(t){return console.error("Failed to load firms:",t),{success:!1,error:t.message}}}function ae(){const t=document.getElementById("invoiceModalBody");if(!L){t.innerHTML="",t.appendChild(o("div",{className:"invoice-no-items"},"No items to invoice"));return}const e=L.firms.flatMap(s=>s.items);if(e.length===0){t.innerHTML="",t.appendChild(o("div",{className:"invoice-no-items"},"No items to invoice"));return}D||(D=Q.length>0?Q[0].id:L?.firms?.[0]?.firmId||"pratibha",S=new Set(e.map(s=>s.productId)));const a=e.filter(s=>S.has(s.productId)).reduce((s,f)=>s+(f.amount||0),0),n=Q.length>0?Q:(L?.firms||[]).map(s=>({id:s.firmId,name:s.firmName}));t.innerHTML="";const i=document.createDocumentFragment(),r=o("div",{className:"invoice-firm-selector"},[o("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),o("div",{className:"firm-options"},n.map(s=>o("label",{className:`firm-option ${D===s.id?"selected":""}`,onclick:()=>window.selectFirm(s.id)},[o("input",{type:"radio",name:"firm",value:s.id,checked:D===s.id}),o("span",{className:"firm-option-name"},s.name)])))]);i.appendChild(r),i.appendChild(o("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),i.appendChild(o("div",{className:"invoice-items-list"},e.map(s=>o("div",{className:"invoice-item"},[o("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:s.productId},checked:S.has(s.productId),onchange:()=>window.toggleInvoiceItem(null,s.productId)}),o("div",{className:"invoice-item-details"},[o("div",{className:"invoice-item-name"},s.productName),o("div",{className:"invoice-item-meta"},`${s.quantity||0} ${s.unit||""} × ₹${(s.rate||0).toLocaleString("en-IN")}`)]),o("div",{className:"invoice-item-amount"},`₹${(s.amount||0).toLocaleString("en-IN")}`)])))),i.appendChild(o("div",{className:"invoice-summary"},[o("div",{className:"invoice-summary-label"},"Total"),o("div",{className:"invoice-summary-total"},`₹${a.toLocaleString("en-IN")}`)])),t.appendChild(i);const c=document.getElementById("generateInvoiceBtn");c&&(c.disabled=S.size===0)}function Be(t){D=t,ae()}function Pe(t,e){S.has(e)?S.delete(e):S.add(e),ae()}async function $e(){if(!L||!D||S.size===0)return;const t=document.getElementById("generateInvoiceBtn");t.classList.add("btn-loading"),t.disabled=!0;try{const e={"Content-Type":"application/json"},a=await A.ensureCsrfToken();a&&(e["X-CSRF-Token"]=a);const n=await fetch(`/api/invoices/${L.orderId}/pdf`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({firmId:D,productIds:Array.from(S)})});if(!n.ok){const s=await n.json().catch(()=>({}));throw new Error(s.message||"Invoice generation temporarily unavailable")}const i=await n.blob(),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download=`INV${L.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r),d("Invoice downloaded","success"),oe()}catch(e){console.error("Generate invoice error:",e),d(e.message||"Could not generate invoice","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}}function oe(){document.getElementById("invoiceModal").classList.remove("show"),L=null,D=null,S=new Set}function Le(){if(!q)return;const t=q;V(),ne(t)}async function Se(t){if(Y||b?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;Y=!0;const e=document.querySelector(`.swipe-item[data-order-id="${t}"]`);try{const a={"Content-Type":"application/json"},n=await A.ensureCsrfToken();n&&(a["X-CSRF-Token"]=n);const i=await fetch(`/api/orders/${t}`,{method:"DELETE",headers:a,credentials:"include"});if(i.ok)e?(e.classList.add("deleting"),setTimeout(()=>{j()},300)):j(),d("Order cancelled","success");else{const r=await i.json().catch(()=>({message:"Could not cancel. Try again."}));d(r.message||"Could not cancel","info")}}catch(a){console.error("Delete order error:",a),d("Could not delete order","info")}finally{Y=!1}}async function R(t){if(T){d("Please wait, saving in progress...","info");return}try{const e=await fetch(`/api/orders/${t}`,{credentials:"include"});let a;try{a=await e.json()}catch(l){console.error("Failed to parse order response:",l),d("Server issue. Please refresh.","info");return}if(!e.ok){d(a?.message||"Could not load order","info");return}const n=a.data;if(!n||!n.products){d("Order data updating. Refresh page.","info");return}q=t,E=n,$={},B={},y=[];const i=document.getElementById("modalTitle");i&&(i.textContent=`#${n.orderNumber}`);const r=document.getElementById("savePricesBtn");r&&(r.disabled=!0);const c=b.role==="admin"||b.role==="staff",s=n.batch?.batchType?`<span class="badge badge-batch">${n.batch.batchType}</span>`:"-",f=document.getElementById("modalBody");f.innerHTML="";const m=document.createDocumentFragment(),v=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Customer"),o("div",{className:"info-value"},n.customer?.name||"")]),o("div",{},[o("div",{className:"info-label"},"Phone"),o("div",{className:"info-value"},n.customer?.phone||"-")])]);m.appendChild(v);const p=n.batch?.batchType?o("span",{className:"badge badge-batch"},n.batch.batchType):"-",u=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Date"),o("div",{className:"info-value"},new Date(n.createdAt).toLocaleDateString("en-IN"))]),o("div",{},[o("div",{className:"info-label"},"Batch"),o("div",{className:"info-value"},Array.isArray(p)?p:[p])])]);m.appendChild(u);const h=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Status"),o("div",{className:"info-value"},[o("span",{className:`badge badge-${n.status}`},n.status)])]),o("div",{})]);m.appendChild(h);const N=o("div",{className:"info-section"});if(N.appendChild(o("div",{className:"info-label"},"Products")),n.products.forEach((l,g)=>{const P=typeof l.product=="object"?l.product._id:l.product,I=K[P]||l.rate||null,C=I?`₹${I.toLocaleString("en-IN")}`:"N/A";let z;if(c){const _=o("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${g}`,value:l.quantity,min:"0",step:"0.01",dataset:{idx:g,original:l.quantity,unit:l.unit},onfocus:O=>window.clearZero(O.target),onblur:O=>window.restoreValue(O.target),onchange:()=>window.handleQuantityChange(g),oninput:()=>window.handleQuantityInput(g)});z=o("div",{className:"qty-controls-inline"},[o("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(g,-1)},"−"),_,o("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(g,1)},"+"),o("span",{className:"qty-unit"},l.unit)])}else z=o("div",{className:"product-qty"},`${l.quantity} ${l.unit}`);const J=["Selling"];l.isContractPrice&&(J.push(" "),J.push(o("span",{className:"contract-badge"},"Fixed")));let Z;if(c){const _=o("input",{type:"number",className:`price-input input-animated${l.isContractPrice?" contract-locked":""}`,id:`price-${g}`,value:l.rate,min:"0",step:"0.01",dataset:{idx:g,original:l.rate,qty:l.quantity,contract:l.isContractPrice||!1},onfocus:O=>window.clearZero(O.target),onblur:O=>window.restoreValue(O.target),onchange:()=>window.handlePriceChange(g),oninput:()=>window.handlePriceInput(g)});l.isContractPrice&&(_.disabled=!0,_.title="Contract price - edit in customer management"),Z=_}else Z=o("div",{className:"price-value"},`₹${l.rate}`);const pe=o("div",{className:"product-item",dataset:{idx:g}},[o("div",{className:"product-top"},[o("div",{},[o("div",{className:"product-name"},l.productName),z])]),o("div",{className:"prices-container"},[o("div",{className:"price-box"},[o("div",{className:"price-label"},"Purchase"),o("div",{className:"price-value"},C)]),o("div",{className:"price-box"},[o("div",{className:"price-label"},J),Z])]),o("div",{className:"amount-row"},[o("span",{className:"amount-label"},"Amount"),o("span",{className:"amount-display",id:`amount-${g}`},`₹${l.amount}`)])]);N.appendChild(pe)}),N.appendChild(o("div",{id:"addedProductsContainer"})),c){const l=[o("option",{value:""},"+ Add Product...")];ee.filter(I=>!n.products.some(C=>(typeof C.product=="object"?C.product._id:C.product)===I._id)).forEach(I=>{l.push(o("option",{value:I._id,dataset:{name:I.name,unit:I.unit}},`${I.name} (${I.unit})`))});const g=o("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},l),P=o("div",{className:"add-product-section"},[g]);N.appendChild(P)}m.appendChild(N);const M=o("div",{className:"total-section"},[o("div",{className:"total-row"},[o("span",{},"Total"),o("span",{id:"orderTotal"},`₹${n.totalAmount}`)]),o("div",{className:"total-row"},[o("span",{},"Paid"),o("span",{},`₹${n.paidAmount||0}`)]),o("div",{className:"total-row main"},[o("span",{},"Balance"),o("span",{id:"orderBalance"},`₹${n.totalAmount-(n.paidAmount||0)}`)])]);if(m.appendChild(M),f.appendChild(m),c){const l=document.getElementById("modalFooter");if(l){l.innerHTML="";const g=o("button",{className:"btn-modal secondary btn-animated",onclick:()=>window.printFromModal()},o("span",{className:"btn-text"},"Invoice"));if(l.appendChild(g),n.status==="pending"){const C=o("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--dusty-olive)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"confirmed")},"Confirm Order");l.appendChild(C)}else if(n.status==="confirmed"&&n.packingDone){const C=o("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--gunmetal)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"delivered")},"Mark Delivered");l.appendChild(C)}if(n.status==="confirmed"&&!n.packingDone){const C=o("button",{className:"btn-modal secondary btn-animated",style:{background:"var(--dusty-olive)",color:"white",border:"none"},onclick:()=>{window.closeModal(),setTimeout(()=>window.openPackingPanel(n._id),200)}},"Start Packing");l.appendChild(C)}const I=o("button",{className:"btn-save-prices btn-animated",id:"savePricesBtn",disabled:!0,onclick:()=>window.savePrices()},o("span",{className:"btn-text"},"Save"));l.appendChild(I)}}document.getElementById("orderModal").classList.add("show")}catch(e){console.error("Error in viewOrder:",e),E=null,q=null;const a=document.getElementById("orderModal");a&&a.classList.remove("show"),navigator.onLine?e.message?.includes("401")||e.message?.includes("403")?(d("Session expired. Please log in again.","error"),setTimeout(()=>{window.location.href="/pages/auth/login.html"},1500)):e.message?.includes("404")?d("Order not found. It may have been deleted.","error"):e.message?.includes("500")?d("Server error. Please try again in a moment.","error"):d("Could not load order. Please try again.","info"):d("No internet connection. Check your network.","error")}}function Te(t){t.dataset.prevValue=t.value,t.value="",t.select()}function qe(t){t.value===""&&(t.value=t.dataset.prevValue||t.dataset.original);const e=parseInt(t.dataset.idx);le(e)}function Ae(t){const e=document.getElementById(`price-${t}`);if(!e)return;const a=document.getElementById(`quantity-${t}`),n=parseFloat(e.dataset.original),i=parseFloat(e.value)||0,r=a?parseFloat(a.value)||0:parseFloat(e.dataset.qty);e.classList.toggle("changed",i!==n);const c=Math.round(i*r*100)/100,s=document.getElementById(`amount-${t}`);s&&(s.textContent=`₹${c.toLocaleString("en-IN")}`),F()}function le(t){const e=document.getElementById(`price-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),n=parseFloat(e.value)||0;n!==a&&n>0?$[t]=n:delete $[t],X()}function Fe(t,e){const a=document.getElementById(`quantity-${t}`);if(!a)return;let i=(parseFloat(a.value)||0)+e;i<.01&&i>0&&(i=0),i<0&&(i=0),a.value=i,ue(t),ie(t)}function ie(t){const e=document.getElementById(`quantity-${t}`),a=document.getElementById(`price-${t}`);if(!e)return;const n=parseFloat(e.dataset.original),i=parseFloat(e.value)||0;e.classList.remove("changed","removed"),i===0?e.classList.add("removed"):i!==n&&e.classList.add("changed");const r=a?parseFloat(a.value)||0:E?.products[t]?.rate||0,c=Math.round(i*r*100)/100,s=document.getElementById(`amount-${t}`);s&&(s.textContent=`₹${c.toLocaleString("en-IN")}`),F()}function ue(t){const e=document.getElementById(`quantity-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),n=parseFloat(e.value)||0,i=.01;n>0&&n<i?(d(`Minimum quantity: ${i} ${e.dataset.unit}`,"info"),e.value=a,delete B[t]):n!==a?B[t]=n:delete B[t],X(),ie(t)}function X(){const t=Object.keys($).length>0||Object.keys(B).length>0||y.length>0,e=document.getElementById("savePricesBtn");e&&(e.disabled=!t)}function De(){const t=document.getElementById("productSelector"),e=t.value;if(!e){(ee.length===0||t.options.length<=1)&&d("No products available","info");return}const a=t.options[t.selectedIndex],n=a.dataset.name,i=a.dataset.unit,r=K[e]||0;y.push({product:e,productName:n,unit:i,quantity:1,rate:r}),a.remove(),se(),F(),X(),t.value=""}function se(){const t=document.getElementById("addedProductsContainer");if(!t)return;t.innerHTML="";const e=document.createDocumentFragment();y.forEach((a,n)=>{const i=o("div",{className:"product-item added-product",dataset:{addedIdx:n}},[o("div",{className:"product-top"},[o("div",{},[o("div",{className:"product-name"},[a.productName," ",o("span",{className:"new-badge"},"New")]),o("div",{className:"qty-controls-inline"},[o("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,-1),type:"button"},"−"),o("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${n}`,value:a.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(n),oninput:()=>window.handleAddedQtyInput(n)}),o("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,1),type:"button"},"+"),o("span",{className:"qty-unit"},a.unit)])]),o("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(n),title:"Remove"},"×")]),o("div",{className:"prices-container"},[o("div",{className:"price-box"},[o("div",{className:"price-label"},"Purchase"),o("div",{className:"price-value"},a.rate?`₹${a.rate.toLocaleString("en-IN")}`:"N/A")]),o("div",{className:"price-box"},[o("div",{className:"price-label"},"Selling"),o("input",{type:"number",className:"price-input input-animated",id:`added-price-${n}`,value:a.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(n)})])]),o("div",{className:"amount-row"},[o("span",{className:"amount-label"},"Amount"),o("span",{className:"amount-display",id:`added-amount-${n}`},`₹${((a.rate||0)*(a.quantity||0)).toLocaleString("en-IN")}`)])]);e.appendChild(i)}),t.appendChild(e)}function Me(t,e){const a=document.getElementById(`added-qty-${t}`);if(!a)return;let n=parseFloat(a.value)||0;n=Math.max(0,n+e),n>0&&n<.01&&(n=.01),a.value=n,y[t].quantity=n,H(t),F()}function Oe(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;let a=parseFloat(e.value)||0;a>0&&a<.01&&(d("Minimum quantity: 0.01","info"),a=.01,e.value=a),y[t].quantity=a,H(t),F()}function je(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;const a=parseFloat(e.value)||0;y[t].quantity=a,H(t),F()}function Qe(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const a=parseFloat(e.value)||0;y[t].rate=a,H(t),F()}function Re(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const a=parseFloat(e.value)||0;y[t].rate=a,H(t),F()}function H(t){const e=document.getElementById(`added-amount-${t}`);if(!e)return;const a=y[t],n=(a.quantity||0)*(a.rate||0);e.textContent=`₹${n.toLocaleString("en-IN")}`}function _e(t){const e=y.splice(t,1)[0],a=document.getElementById("productSelector");if(a&&e){const n=document.createElement("option");n.value=e.product,n.dataset.name=e.productName,n.dataset.unit=e.unit,n.textContent=`${e.productName} (${e.unit})`,a.appendChild(n)}se(),F(),X()}function F(){if(!E||!E.products)return;let t=0;E.products.forEach((i,r)=>{const c=document.getElementById(`price-${r}`),s=document.getElementById(`quantity-${r}`),f=c?parseFloat(c.value)||0:i.rate,m=s?parseFloat(s.value)||0:i.quantity;t+=f*m}),y.forEach(i=>{t+=(i.quantity||0)*(i.rate||0)}),t=Math.round(t*100)/100;const e=Math.round((t-(E.paidAmount||0))*100)/100,a=document.getElementById("orderTotal"),n=document.getElementById("orderBalance");a&&(a.textContent=`₹${t.toLocaleString("en-IN")}`),n&&(n.textContent=`₹${e.toLocaleString("en-IN")}`)}async function Ue(t){try{const e=await fetch(`/api/invoices/order/${t}`,{credentials:"include"});if(!e.ok)return e.status===401||e.status===403?{exists:!1,error:"auth"}:{exists:!1,error:`Server returned ${e.status}`};const a=await e.json();return{exists:a.data&&a.data.length>0}}catch(e){return console.error("Failed to check invoices:",e),{exists:!1,error:e.message}}}async function He(){const t=Object.keys($).length>0||Object.keys(B).length>0||y.length>0;if(!q||!E||!E.products||!t)return;if(T){d("Save in progress...","info");return}T=!0;const e=document.getElementById("savePricesBtn");e&&(e.disabled=!0,e.classList.add("btn-loading"));let a=!1;const n=await Ue(q);if(n.error){if(!confirm(`Could not check if invoices exist for this order.

If invoices exist, they may need to be regenerated after saving. Continue?`)){T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else if(n.exists&&(a=!0,!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`))){T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}try{const i=E.products.map((u,h)=>{let N=$[h]!==void 0?$[h]:u.rate,M=B[h]!==void 0?B[h]:u.quantity;return(!N||N<=0)&&(N=u.rate),M<0&&(M=u.quantity),{product:typeof u.product=="object"?u.product._id:u.product,quantity:M,priceAtTime:N}}).filter(u=>u.quantity>0),r=y.filter(u=>u.quantity>0).map(u=>({product:u.product,quantity:u.quantity,priceAtTime:u.rate})),c=[...i,...r],s={"Content-Type":"application/json"},f=await A.ensureCsrfToken();f&&(s["X-CSRF-Token"]=f);const m={products:c},v=q;let p=await fetch(`/api/orders/${v}`,{method:"PUT",headers:s,credentials:"include",body:JSON.stringify(m)});if(p.status===403){let u;try{u=await p.json()}catch(h){console.warn("Failed to parse CSRF error response:",h.message),u={message:`Access denied (code: ${p.status})`}}if(u.message?.toLowerCase().includes("csrf")){const h=await A.refreshCsrfToken();if(h){if(s["X-CSRF-Token"]=h,p=await fetch(`/api/orders/${v}`,{method:"PUT",headers:s,credentials:"include",body:JSON.stringify(m)}),p.status===403){d("Session expired. Please refresh the page.","info"),T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{d("Session expired. Please refresh the page.","info"),T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{d(u.message||"Access temporarily unavailable","info"),T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}if(p.ok)d("Changes saved","success"),$={},B={},y=[],e&&(e.classList.remove("btn-loading"),e.classList.add("btn-success"),setTimeout(()=>e.classList.remove("btn-success"),1500),e.disabled=!0),j(),a&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const u=v;V(),setTimeout(()=>ne(u),300)}},500),q===v&&R(v);else{let u;try{u=await p.json()}catch(h){console.warn("Failed to parse order save error response:",h.message),u={message:`Server error (${p.status})`}}d(u.message||"Could not update","info"),e&&(e.disabled=!1)}}catch(i){console.error("Save changes error:",i),navigator.onLine?d("Could not save. Try again.","info"):d("No internet connection","info"),e&&(e.disabled=!1)}finally{T=!1,e&&e.classList.remove("btn-loading")}}function V(){if((Object.keys($).length>0||Object.keys(B).length>0||y.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const e=document.getElementById("orderModal");e&&e.classList.remove("show"),q=null,E=null,$={},B={},y=[]}window.closeModal=V;window.viewOrder=R;window.clearZero=Te;window.restoreValue=qe;window.handlePriceChange=le;window.handlePriceInput=Ae;window.handleQuantityChange=ue;window.handleQuantityInput=ie;window.changeQuantity=Fe;window.savePrices=He;window.deleteOrder=Se;window.printOrder=ne;window.downloadDeliveryBill=Ce;window.closeInvoiceModal=oe;window.selectFirm=Be;window.toggleInvoiceItem=Pe;window.generateInvoice=$e;window.printFromModal=Le;window.addProductToOrder=De;window.renderAddedProducts=se;window.changeAddedQty=Me;window.handleAddedQtyChange=Oe;window.handleAddedQtyInput=je;window.handleAddedPriceChange=Qe;window.handleAddedPriceInput=Re;window.removeAddedProduct=_e;async function Xe(t,e){if(!b||b.role!=="admin"&&b.role!=="staff")return;const a=document.querySelectorAll("#modalBody .btn-confirm, #modalBody .btn-deliver");a.forEach(n=>{n.disabled=!0,n.classList.add("btn-loading")});try{const n={"Content-Type":"application/json"},i=await A.ensureCsrfToken();i&&(n["X-CSRF-Token"]=i);const r=await fetch(`/api/orders/${t}/status`,{method:"PUT",headers:n,credentials:"include",body:JSON.stringify({status:e})}),c=await r.json();r.ok?(d(`Order marked as ${e}`,"success"),R(t),j()):(d(c.message||"Failed to update status","error"),R(t))}catch(n){console.error("Status update error:",n),d("Network error updating status","error"),R(t)}finally{a.forEach(n=>{n.disabled=!1,n.classList.remove("btn-loading")})}}window.updateOrderStatus=Xe;async function me(t){const e=document.getElementById("packingPanel"),a=document.getElementById("packingPanelOverlay");if(!(!e||!a)){document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(n=>{n.classList.remove("swiped","swiped-single")}),e.classList.add("active"),a.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("packingPanelBody").innerHTML='<div class="packing-loading">Loading order...</div>',document.getElementById("packingCompleteBtn").disabled=!0;try{const n=await fetch(`/api/packing/${t}`,{credentials:"include"});if(!n.ok)throw new Error("Failed to load order");w=(await n.json()).data,k=w.items||[],W()}catch(n){console.error("Error loading packing order:",n),d("Failed to load order details","error"),w=null,k=[],re()}}}function W(){document.getElementById("packingPanelTitle").textContent=`Pack ${w.orderNumber}`,document.getElementById("packingPanelSubtitle").textContent=`${w.customer?.name||"Unknown"} • ${w.customer?.phone||""}`,Ze();const t=document.getElementById("packingPanelBody");let e="";(w.deliveryAddress||w.notes)&&(e='<div class="packing-order-details">',w.deliveryAddress&&(e+=`
                <div class="packing-delivery-info">
                    <span class="packing-label">Deliver to</span>
                    <span class="packing-value">${G(w.deliveryAddress)}</span>
                </div>`),w.notes&&(e+=`
                <div class="packing-order-notes">
                    <span class="packing-label">Notes</span>
                    <span class="packing-value">${G(w.notes)}</span>
                </div>`),e+="</div>");const a=k.map((r,c)=>{const s=r.packedQuantity??r.orderedQuantity,f=r.packedQuantity!==void 0&&r.packedQuantity!==r.orderedQuantity,m=r.packed||!1;return`
            <div class="packing-checklist-item ${m?"item-packed":""} ${f?"item-modified":""}" data-index="${c}" data-product-id="${r.product}">
                <div class="packing-item-main">
                    <div class="packing-item-check ${m?"checked":""}" onclick="togglePackedItem(${c})">
                        ${m?"✓":""}
                    </div>
                    <div class="packing-item-details">
                        <span class="packing-item-name">${G(r.productName)}</span>
                        <span class="packing-item-qty">Ordered: ${r.orderedQuantity} ${r.unit}</span>
                    </div>
                </div>
                <div class="packing-item-input">
                    <input type="number"
                        class="packing-qty-input ${f?"modified":""}"
                        value="${s}"
                        data-index="${c}"
                        data-original="${r.orderedQuantity}"
                        step="0.01"
                        min="0"
                        onchange="handlePackingQtyChange(${c})"
                    >
                    <span class="packing-unit-label">${r.unit}</span>
                </div>
            </div>
        `}).join("");t.innerHTML=`
        ${e}
        <div class="packing-checklist-header">
            <span>Items to Pack</span>
        </div>
        <div class="packing-checklist">
            ${a}
        </div>
    `;const n=document.getElementById("packingPanelAcknowledgement");n&&(n.style.display="none");const i=document.getElementById("packingPanelIssues");i&&(i.style.display="none"),Ge()}async function Ve(t){const e=k[t],a=!e.packed;e.packed=a,W();try{const n=await A.ensureCsrfToken(),i=await fetch(`/api/packing/${w._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":n},credentials:"include",body:JSON.stringify({packed:a})});if(!i.ok){const c=(await i.json().catch(()=>({}))).message||`Server error (${i.status})`;throw new Error(c)}}catch(n){console.error("Error toggling packed status:",n),e.packed=!a,W(),navigator.onLine?n.message?.includes("401")||n.message?.includes("403")||n.message?.includes("auth")?d("Session expired. Please refresh the page.","error"):n.message?.includes("404")?d("Order not found. It may have been modified.","error"):d(`Update failed: ${n.message}`,"error"):d("No connection. Check internet and retry.","error")}}async function ze(t){const e=document.querySelector(`.packing-qty-input[data-index="${t}"]`),a=parseFloat(e?.value)||0,n=parseFloat(e?.dataset.original)||0,i=k[t].packedQuantity;k[t].packedQuantity=a,e.classList.toggle("modified",a!==n);const r=e.closest(".packing-checklist-item");r&&r.classList.toggle("item-modified",a!==n),(await Je(t)).success||(k[t].packedQuantity=i,e.value=i??n,e.classList.toggle("modified",(i??n)!==n),r&&r.classList.toggle("item-modified",(i??n)!==n))}async function Je(t){const e=k[t];try{const a=await A.ensureCsrfToken(),n=await fetch(`/api/packing/${w._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":a},credentials:"include",body:JSON.stringify({quantity:e.packedQuantity})});if(!n.ok){const i=await n.json().catch(()=>({}));throw new Error(i.message||`Server error (${n.status})`)}return{success:!0}}catch(a){console.error("Error saving packing item:",a);let n="Failed to save changes";return navigator.onLine?(a.message?.includes("401")||a.message?.includes("403"))&&(n="Session expired. Please refresh."):n="No connection. Changes not saved.",d(n,"error"),{success:!1,error:a.message}}}function Ze(){const t=k.length,e=k.filter(n=>n.packed).length,a=t>0?Math.round(e/t*100):0;document.getElementById("packingProgressFill").style.width=`${a}%`,document.getElementById("packingProgressText").textContent=`${e}/${t} items packed`}function Ge(){const t=document.getElementById("packingCompleteBtn");if(t){const e=k.length,a=k.filter(i=>i.packed).length,n=a===e&&e>0;if(t.disabled=!n,!n&&e>0){const i=e-a;t.title=`${i} item(s) remaining`}else t.title=""}}async function Ye(){const t=document.getElementById("packingCompleteBtn");t.disabled=!0,t.innerHTML='<span class="btn-text">Completing...</span>';try{const e=await A.ensureCsrfToken(),a=await fetch(`/api/packing/${w._id}/done`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include"});if(!a.ok){const n=await a.json();throw new Error(n.message||"Failed to complete packing")}d("Packing completed!","success"),re(),await j()}catch(e){console.error("Error completing packing:",e),d(e.message||"Failed to complete packing","error"),t.disabled=!1,t.innerHTML='<span class="btn-text">Mark Done</span>'}}function re(){const t=document.getElementById("packingPanel"),e=document.getElementById("packingPanelOverlay");t.classList.remove("active"),e.classList.remove("active"),document.body.style.overflow="",w=null,k=[]}window.openPackingPanel=me;window.closePackingPanel=re;window.handlePackingQtyChange=ze;window.completePackingSession=Ye;window.togglePackedItem=Ve;ge();
