import{b as u,s as f}from"./ui-Bs0uH3rR.js";let t=null;function a(){const e=document.cookie.match(/csrf_token=([^;]+)/);return e?e[1]:null}async function l(){if(t)return t;t=(async()=>{try{const e=await fetch("/api/csrf-token",{credentials:"include"});if(e.ok)return(await e.json()).csrfToken||a()}catch(e){console.error("Failed to refresh CSRF token:",e)}return null})();try{return await t}finally{t=null}}async function h(){let e=a();return e||(e=await l()),e}const d={USER_KEY:"user",getCsrfToken:a,refreshCsrfToken:l,ensureCsrfToken:h,isLoggedIn(){return!!this.getUser()},getUser(){try{const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Error parsing user data:",e),null}},setUser(e){const r={id:e.id,name:e.name,email:e.email,role:e.role,customer:e.customer?{_id:e.customer._id,name:e.customer.name,pricingType:e.customer.pricingType,...e.customer.pricingType==="contract"&&e.customer.contractPrices?{contractPrices:e.customer.contractPrices}:{}}:null,isMagicLink:e.isMagicLink||!1};localStorage.setItem(this.USER_KEY,JSON.stringify(r))},clearAuth(){localStorage.removeItem(this.USER_KEY)},getRole(){const e=this.getUser();return e?e.role:null},isStaff(){const e=this.getRole();return e==="admin"||e==="staff"},isCustomer(){return this.getRole()==="customer"},async verify(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const r=await e.json();return this.setUser(r.user),r.user}else return this.clearAuth(),null}catch(e){return console.error("Auth verification failed:",e),!navigator.onLine||e.name==="TypeError"||e.message.includes("network")||e.message.includes("fetch")||e.message.includes("Failed to fetch")?(console.warn("Network issue during auth verification - using cached user"),this.getUser()):(this.clearAuth(),null)}},async login(e,r,n=!1){try{const o={"Content-Type":"application/json"},c=await this.ensureCsrfToken();c&&(o["X-CSRF-Token"]=c);const i=await fetch("/api/auth/login",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({email:e,password:r})}),s=await i.json();return i.ok?(this.setUser(s.user),{success:!0,user:s.user}):i.status===403&&s?.message?.toLowerCase().includes("csrf")&&!n?(console.log("CSRF token error during login, refreshing and retrying..."),await this.refreshCsrfToken(),this.login(e,r,!0)):{success:!1,error:s.message||"Login failed"}}catch(o){return console.error("Login error:",o),{success:!1,error:"Network error. Please try again."}}},async logout(){try{const e={},r=await this.ensureCsrfToken();r&&(e["X-CSRF-Token"]=r);const n=await fetch("/api/auth/logout",{method:"POST",headers:e,credentials:"include"});n.ok||console.warn("Server-side logout returned error:",n.status)}catch(e){console.error("Logout error:",e),console.warn("Server-side session may still be active due to:",e.message)}finally{this.clearAuth(),window.location.href="/pages/auth/login.html"}},async requireAuth(e=null){const r=await this.verify();return r?e&&!e.includes(r.role)?(r.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",null):r:(window.location.href="/pages/auth/login.html",null)},async redirectIfLoggedIn(){const e=await this.verify();return e?(e.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",!0):!1}};typeof window<"u"&&(window.Auth=d);window.addEventListener("online",()=>{console.log("Connection restored"),u("Connection restored")});window.addEventListener("offline",()=>{console.log("Connection lost"),f("No internet connection","info")});
