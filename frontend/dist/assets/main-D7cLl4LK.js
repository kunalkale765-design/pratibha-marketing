import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css                */import{f as x}from"./utils-DKdRYW2s.js";import{c as r,s as E}from"./ui-Vfn0bm3t.js";import"./api-C8X7spwu.js";import{i as ae}from"./init-SLHhpTPf.js";const X=(e=0)=>new Promise((t,n)=>{window.Auth?t(window.Auth):e>500?n(new Error("Auth module failed to load")):setTimeout(()=>X(e+1).then(t).catch(n),10)});let T;try{T=await X()}catch(e){console.error("Auth initialization failed:",e),window.location.href="/pages/auth/login.html"}ae();let J=[],h={toProcure:[],procured:[],categories:[]},I="",C="";const L={};let S={},y=null,R=null,w=null,N=null,F=!1,$=!1;function ne(){N=new Audio("/assets/sounds/notification.wav"),N.preload="auto",N.volume=.5}window.addEventListener("beforeunload",()=>{y&&(clearInterval(y),y=null),w&&(w.close().catch(()=>{}),w=null),N&&(N=null)});document.addEventListener("visibilitychange",()=>{document.hidden?y&&(clearInterval(y),y=null):y||ee()});function re(){if(F){if(N){N.currentTime=0,N.play().catch(()=>{V()});return}V()}}function V(){try{w||(w=new(window.AudioContext||window.webkitAudioContext)),w.state==="suspended"&&w.resume();const e=w.createOscillator(),t=w.createOscillator(),n=w.createGain();e.connect(n),t.connect(n),n.connect(w.destination),e.frequency.value=880,e.type="sine",t.frequency.value=1108.73,t.type="sine";const a=w.currentTime;n.gain.setValueAtTime(0,a),n.gain.linearRampToValueAtTime(.3,a+.05),n.gain.linearRampToValueAtTime(.2,a+.15),n.gain.linearRampToValueAtTime(.3,a+.2),n.gain.linearRampToValueAtTime(0,a+.35),e.start(a),t.start(a),e.stop(a+.35),t.stop(a+.35)}catch(e){console.log("Could not play notification sound:",e)}}const z=document.getElementById("printBtn"),Z=document.getElementById("exportBtn"),b=document.getElementById("saveRatesBtn"),_=document.getElementById("purchaseSearch"),k=document.getElementById("newOrderBadge"),q=document.getElementById("procuredHeader");z&&z.addEventListener("click",ce);Z&&Z.addEventListener("click",le);b&&b.addEventListener("click",ie);_&&_.addEventListener("input",e=>{I=e.target.value.trim().toLowerCase(),A()});const W=document.getElementById("categoryPills");W&&W.addEventListener("click",e=>{const t=e.target.closest(".category-pill");t&&(document.querySelectorAll(".category-pill").forEach(n=>n.classList.remove("active")),t.classList.add("active"),C=t.dataset.category,A())});function se(e){const t=document.getElementById("categoryPills");if(!t)return;t.innerHTML='<button class="category-pill active" data-category="">All</button>';const n={"Indian Vegetables":"Vegetables","Exotic Vegetables":"Exotic",Fruits:"Fruits",Frozen:"Frozen",Dairy:"Dairy"};if(e.forEach(a=>{const l=r("button",{className:"category-pill"+(C===a?" active":""),dataset:{category:a}},n[a]||a);t.appendChild(l)}),C){const a=t.querySelector(`[data-category="${C}"]`);a?(t.querySelector(".active")?.classList.remove("active"),a.classList.add("active")):C=""}}q&&q.addEventListener("click",()=>{q.classList.toggle("collapsed")});function G(){if(!F)try{w=new(window.AudioContext||window.webkitAudioContext),ne(),F=!0}catch(e){console.log("Could not initialize audio:",e)}}document.addEventListener("click",G,{once:!0});document.addEventListener("touchstart",G,{once:!0});async function B(){try{const[e,t,n,a]=await Promise.all([fetch("/api/orders",{credentials:"include"}),fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/supplier/procurement-summary",{credentials:"include"})]);if(!e.ok||!t.ok||!n.ok||!a.ok){const g=e.ok?t.ok?n.ok?"procurement":"rates":"products":"orders";throw new Error(`Failed to load ${g} data (status: ${e.ok?t.ok?n.ok?a.status:n.status:t.status:e.status})`)}const l=await e.json(),i=await n.json(),d=await a.json();J=i.data||[],h={toProcure:d.toProcure||[],procured:d.procured||[],categories:d.categories||[]},se(h.categories),Y(h),K(h);const m=l.data||[],c=m.filter(g=>g.status==="delivered"||g.paymentStatus==="paid").reduce((g,f)=>g+(f.totalAmount||0),0),s=c*.15,u=document.getElementById("totalSale"),o=document.getElementById("totalProfit");u&&(u.textContent=x(c)),o&&(o.textContent=x(s)),A(),ue(m),ee()}catch(e){console.error("Error loading dashboard stats:",e);const t=document.getElementById("totalSale"),n=document.getElementById("totalProfit"),a=document.getElementById("toProcureList");t&&(t.textContent="—"),n&&(n.textContent="—"),a&&(a.innerHTML="",a.appendChild(r("div",{className:"empty-state"},[r("p",{},"Data not available"),r("button",{id:"retryBtn",className:"btn-retry",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:B},"Try Again")])))}}function K(e){S={},[...e.toProcure,...e.procured].forEach(t=>{S[t.productId]=t.totalQty})}function Y(e){if(Object.keys(S).length===0)return;let t=0;[...e.toProcure,...e.procured].forEach(a=>{const l=S[a.productId]||0;a.totalQty>l&&t++}),t>0&&(re(),k&&(k.textContent=`${t} new`,k.classList.remove("hidden"),R&&clearTimeout(R),R=setTimeout(()=>{k&&k.classList.add("hidden"),R=null},3e4)),E(`${t} product(s) have new orders!`,"info"))}function ee(){y&&clearInterval(y),y=setInterval(async()=>{if(!$){$=!0;try{if(!document.getElementById("toProcureList")){clearInterval(y),y=null;return}const e=await fetch("/api/supplier/procurement-summary",{credentials:"include"});if(e.status===401){clearInterval(y),y=null,window.location.href="/pages/auth/login.html";return}if(!e.ok){console.warn("Polling failed:",e.status);return}const t=await e.json();if(e.ok){const n={toProcure:t.toProcure||[],procured:t.procured||[],categories:t.categories||[]};Y(n),h=n,K(h),A(!0)}}catch(e){console.error("Polling error:",e)}finally{$=!1}}},3e4)}function A(e=!1){const t=document.getElementById("toProcureList"),n=document.getElementById("procuredList"),a=document.getElementById("procurementEmpty"),l=document.getElementById("procuredCount");if(!t||!n){console.error("Purchase List: Required DOM elements missing (toProcureList or procuredList). Check index.html structure.");const s=document.querySelector(".procurement-container");if(s&&!s.querySelector(".procurement-error")){const o=document.createElement("div");o.className="procurement-error",o.style.cssText="padding:1.5rem;text-align:center;color:var(--error);font-size:0.875rem;",o.textContent="Purchase list failed to load. Please refresh the page.",s.appendChild(o)}return}const i={};e&&document.querySelectorAll(".item-rate-input").forEach(s=>{s.value&&(i[s.dataset.productId]=s.value)}),t.innerHTML="",n.innerHTML="";const d=s=>s.filter(u=>{const o=!I||u.productName.toLowerCase().includes(I),g=!C||u.category===C;return o&&g}),m=d(h.toProcure),c=d(h.procured);l&&(l.textContent=c.length),m.length===0&&h.toProcure.length===0?(a&&a.classList.remove("hidden"),t.innerHTML='<div class="empty-list-msg">No items to procure</div>'):a&&a.classList.add("hidden");const p={};if(J.forEach(s=>{p[s.product]=s}),m.length>0){const s=document.createDocumentFragment();s.appendChild(r("div",{className:"procurement-column-header"},[r("span",{className:"col-expand"}),r("span",{className:"col-name"},"Product"),r("span",{className:"col-qty"},"Qty"),r("span",{className:"col-input"},"Rate")]));let u="";m.forEach(o=>{o.category!==u&&(u=o.category,s.appendChild(r("div",{className:"category-divider"},u)));const g=p[o.productId],f=o.currentRate||g?.rate||0,H=i[o.productId]||"",te=f===0?" unsaved":"";let D;o.wasProcured?D=r("span",{className:"qty-breakdown"},[r("span",{className:"procured-qty"},String(o.procuredQty||0)),r("span",{className:"separator"},"+"),r("span",{className:"new-qty highlight-new"},String(o.newQty||0))]):D=r("span",{className:"qty-simple"},String(o.totalQty||0));const O=[r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Orders"),r("span",{className:"detail-value"},o.totalOrders||0)])];o.wasProcured&&o.lastRate&&O.unshift(r("div",{className:"detail-row highlight-info"},[r("span",{className:"detail-label"},"Last Rate"),r("span",{className:"detail-value"},`₹${o.lastRate}/${o.unit}`)])),O.push(r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Est. Cost"),r("span",{className:"detail-value highlight"},o.totalQty>0&&f>0?x(o.totalQty*f):"—")]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Trend"),r("span",{className:"detail-value"},o.trend==="up"?"↑ Up":o.trend==="down"?"↓ Down":"— Stable")]));const oe=r("div",{className:`procurement-item${te}${o.wasProcured?" was-procured":""}`,dataset:{productId:o.productId}},[r("div",{className:"item-main",onclick:P=>window.toggleExpand(P.currentTarget)},[r("span",{className:"item-expand"},"▶"),r("span",{className:"item-name"},o.productName),D,r("span",{className:"item-unit"},o.unit),r("input",{type:"number",className:"item-rate-input"+(H?" changed":""),dataset:{productId:o.productId,productName:o.productName,currentRate:f,quantity:o.totalQty||0,notProcuredToday:o.rate===void 0?"true":""},placeholder:"₹0",value:H,step:"0.01",min:"0",onclick:P=>P.stopPropagation(),onchange:P=>window.handleRateChange(P.target),oninput:P=>window.handleRateInput(P.target)})]),r("div",{className:"item-details"},O)]);s.appendChild(oe)}),t.appendChild(s)}else(I||C)&&(t.innerHTML='<div class="empty-list-msg">No matching items</div>');if(c.length>0){const s=document.createDocumentFragment();let u="";c.forEach(o=>{o.category!==u&&(u=o.category,s.appendChild(r("div",{className:"category-divider"},u)));const g=r("div",{className:"procurement-item procured-item",dataset:{productId:o.productId}},[r("div",{className:"item-main",onclick:f=>window.toggleExpand(f.currentTarget)},[r("span",{className:"item-expand"},"▶"),r("span",{className:"item-name"},"✓ "+o.productName),r("span",{className:"qty-simple"},String(o.procuredQty||0)),r("span",{className:"item-unit"},o.unit),r("span",{className:"procured-rate"},`₹${o.rate}`)]),r("div",{className:"item-details"},[r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Procured At"),r("span",{className:"detail-value"},new Date(o.procuredAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}))]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Orders"),r("span",{className:"detail-value"},o.totalOrders||0)]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Value"),r("span",{className:"detail-value highlight"},x(o.procuredQty*o.rate))]),r("div",{className:"detail-actions"},[r("button",{className:"btn-undo",onclick:f=>{f.stopPropagation(),window.undoProcurement(o.productId,o.productName)}},"Undo")])])]);s.appendChild(g)}),n.appendChild(s)}}window.toggleExpand=function(e){e.closest(".procurement-item").classList.toggle("expanded")};window.handleRateInput=function(e){const t=parseFloat(e.dataset.currentRate),n=parseFloat(e.value),a=e.dataset.notProcuredToday==="true";e.classList.toggle("changed",e.value&&(n!==t||a))};window.handleRateChange=function(e){const t=e.dataset.productId,n=e.dataset.productName,a=parseFloat(e.dataset.currentRate),l=parseFloat(e.dataset.quantity)||0,i=parseFloat(e.value),d=e.dataset.notProcuredToday==="true";e.value&&(i!==a||d)&&i>0?(L[t]={product:t,productName:n,rate:i,previousRate:a,quantity:l},e.classList.add("changed")):(delete L[t],e.classList.remove("changed")),b&&b.classList.toggle("show",Object.keys(L).length>0)};window.undoProcurement=async function(e,t){if(!confirm(`Remove ${t} from procured list?`))return;const n=document.querySelector(`[onclick*="undoProcurement('${e}'"]`)||document.querySelector(`[data-product-id="${e}"] .undo-btn`);n&&(n.disabled=!0,n.classList.add("btn-loading"));try{const a=await T.ensureCsrfToken(),l={"Content-Type":"application/json"};a&&(l["X-CSRF-Token"]=a);const i=await fetch(`/api/supplier/procure/${e}`,{method:"DELETE",credentials:"include",headers:l});if(!i.ok){const d=await i.json();E(d.message||"Could not undo","error");return}E(`${t} moved back to TO PROCURE`,"success"),B()}catch(a){console.error("Error undoing procurement:",a),E("Could not undo","error"),n&&(n.disabled=!1,n.classList.remove("btn-loading"))}};function ce(){const e=c=>typeof c!="string"?String(c):c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),t=c=>c.filter(p=>{const s=!I||p.productName.toLowerCase().includes(I),u=!C||p.category===C;return s&&u}),n=t(h.toProcure),a=t(h.procured);let l="",i="";n.forEach(c=>{c.category!==i&&(i=c.category,l+=`<div class="category-header">${e(i)}</div>`);const p=c.wasProcured?`${c.procuredQty||0} + ${c.newQty||0}`:`${c.totalQty||0}`;l+=`
            <div class="procurement-item">
                <span class="item-name">${e(c.productName)}</span>
                <span class="qty-breakdown">${p}</span>
                <span class="item-unit">${e(c.unit)}</span>
                <span class="current-rate">₹${(c.currentRate||0).toFixed(0)}</span>
            </div>`});let d="";i="",a.forEach(c=>{c.category!==i&&(i=c.category,d+=`<div class="category-header">${e(i)}</div>`),d+=`
            <div class="procurement-item procured-item">
                <span class="item-name">${e(c.productName)}</span>
                <span class="qty-breakdown">${c.procuredQty||0}</span>
                <span class="item-unit">${e(c.unit)}</span>
                <span class="procured-rate">₹${c.rate}</span>
            </div>`});const m=window.open("","_blank");if(!m){E("Popup blocked. Please allow popups for this site.","error");return}m.document.write(`
        <html>
        <head>
            <title>Purchase List - Pratibha Marketing</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { font-size: 18px; margin-bottom: 10px; }
                h2 { font-size: 14px; margin-top: 20px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                .date { color: #666; margin-bottom: 20px; }
                .category-header { font-weight: bold; color: #666; margin: 15px 0 5px; font-size: 12px; text-transform: uppercase; }
                .procurement-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
                .item-name { font-weight: bold; flex: 1; }
                .qty-breakdown { font-family: monospace; min-width: 100px; }
                .item-unit { color: #666; min-width: 50px; }
                .current-rate { color: #666; min-width: 60px; text-align: right; }
                .procured-rate { color: #5d7a5f; font-weight: bold; min-width: 60px; text-align: right; }
                .procured-item .item-name::before { content: '✓ '; color: #5d7a5f; }
                .empty-msg { color: #999; font-style: italic; padding: 10px 0; }
            </style>
        </head>
        <body>
            <h1>Purchase List - Pratibha Marketing</h1>
            <div class="date">${new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>
            <h2>TO PROCURE (${n.length} items)</h2>
            ${l||'<div class="empty-msg">No items to procure</div>'}
            <h2>PROCURED (${a.length} items)</h2>
            ${d||'<div class="empty-msg">No procured items</div>'}
        </body>
        </html>
    `),m.document.close(),m.print()}function le(){const e=[...h.toProcure,...h.procured],t=["Category","Product","Unit","Procured Qty","New Qty","Total Qty","Rate","Status"],n=e.map(m=>{const c=h.procured.find(s=>s.productId===m.productId)?"Procured":"To Procure",p=m.rate||m.currentRate||0;return[`"${m.category}"`,`"${m.productName}"`,m.unit,m.procuredQty||0,m.newQty||0,m.totalQty||m.procuredQty||0,p,c].join(",")}),a=[t.join(","),...n].join(`
`),l=new Blob([a],{type:"text/csv"}),i=window.URL.createObjectURL(l),d=document.createElement("a");d.href=i,d.download=`purchase-list-${new Date().toISOString().split("T")[0]}.csv`,d.click(),window.URL.revokeObjectURL(i)}async function ie(){if(!b)return;b.textContent="Saving...",b.disabled=!0;const e=[],t=[],n={"Content-Type":"application/json"};let a=await T.ensureCsrfToken();a&&(n["X-CSRF-Token"]=a);const l=Object.entries(L),i=5;for(let d=0;d<l.length;d+=i){const m=l.slice(d,d+i);(await Promise.all(m.map(async([p,s])=>{try{let u=await fetch("/api/supplier/procure",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({productId:s.product,rate:s.rate,quantity:s.quantity||0})});if(u.status===403){const o=await u.json().catch(()=>({}));if(o.message?.toLowerCase().includes("csrf"))a=await T.refreshCsrfToken(),a&&(n["X-CSRF-Token"]=a,u=await fetch("/api/supplier/procure",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({productId:s.product,rate:s.rate,quantity:s.quantity||0})}));else return{productId:p,success:!1,productName:s.productName||p,error:o.message||`HTTP ${u.status}`}}if(u.ok)return{productId:p,success:!0};{const o=await u.json().catch(()=>({}));return{productId:p,success:!1,productName:s.productName||p,error:o.message||`HTTP ${u.status}`}}}catch(u){return console.error("Error saving rate:",u),{productId:p,success:!1,productName:s.productName||p,error:u.message||"Network error"}}}))).forEach(p=>{p.success?t.push(p.productId):e.push({productName:p.productName,error:p.error})})}for(const d of t)delete L[d];b.textContent="Save",b.disabled=!1,e.length>0?(E(`${e.length} rate(s) not saved. Try again.`,"info"),Object.keys(L).length>0?b.classList.add("show"):b.classList.remove("show")):(b.classList.remove("show"),document.querySelectorAll(".item-rate-input").forEach(d=>{d.value="",d.classList.remove("changed")}),E("Items marked as procured!","success")),B()}async function de(){const e=document.getElementById("apiDot"),t=document.getElementById("apiStatus");if(!(!e||!t))try{(await(await fetch("/api/health")).json()).status==="ok"?(e.classList.remove("offline"),t.textContent="API Online"):(e.classList.add("offline"),t.textContent="API Offline")}catch{e.classList.add("offline"),t.textContent="API Offline"}}let Q=null,j=null,M=null;const v={olive:"rgb(126, 145, 129)",oliveLight:"rgba(126, 145, 129, 0.2)",gunmetal:"rgb(46, 53, 50)",terracotta:"rgb(196, 167, 125)",success:"rgb(93, 122, 95)",warning:"rgb(184, 154, 90)",error:"rgb(154, 101, 101)",slate:"rgb(199, 206, 219)"};async function ue(e){if(!window.Chart){["orderStatusChart","revenueChart","topProductsChart"].forEach(n=>{const a=document.getElementById(n);if(a&&a.parentElement){const l=document.createElement("div");l.style.cssText="display:flex;align-items:center;justify-content:center;height:100%;color:var(--dusty-olive);font-size:0.85rem;",l.textContent="Charts unavailable",a.parentElement.replaceChild(l,a)}});return}try{const t={pending:0,confirmed:0,delivered:0,cancelled:0};e.forEach(o=>{Object.hasOwn(t,o.status)&&t[o.status]++}),document.getElementById("pendingCount").textContent=t.pending,document.getElementById("processingCount").textContent=t.confirmed,document.getElementById("deliveredCount").textContent=t.delivered;const n=document.getElementById("orderStatusChart");n?(Q&&Q.destroy(),Q=new Chart(n,{type:"doughnut",data:{labels:["Pending","Confirmed","Delivered","Cancelled"],datasets:[{data:[t.pending,t.confirmed,t.delivered,t.cancelled],backgroundColor:[v.warning,v.olive,v.success,v.error],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!1}}}})):console.warn("Order status chart canvas not found");const a=[],l={};for(let o=6;o>=0;o--){const g=new Date;g.setDate(g.getDate()-o);const f=g.toISOString().split("T")[0];a.push(f),l[f]=0}e.forEach(o=>{if(o.status!=="cancelled"){const g=new Date(o.createdAt).toISOString().split("T")[0];Object.hasOwn(l,g)&&(l[g]+=o.totalAmount||0)}});const i=a.map(o=>l[o]),d=i.reduce((o,g)=>o+g,0),m=d/7;document.getElementById("weekTotal").textContent=x(d),document.getElementById("avgDaily").textContent=x(Math.round(m));const c=document.getElementById("revenueChart");c?(j&&j.destroy(),j=new Chart(c,{type:"line",data:{labels:a.map(o=>new Date(o).toLocaleDateString("en-IN",{weekday:"short"})),datasets:[{label:"Revenue",data:i,borderColor:v.olive,backgroundColor:v.oliveLight,fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:v.olive}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:o=>"₹"+o.toLocaleString("en-IN")}}}}})):console.warn("Revenue chart canvas not found");const p={};e.forEach(o=>{o.status!=="cancelled"&&o.products&&o.products.forEach(g=>{const f=g.productName||"Unknown";p[f]=(p[f]||0)+(g.quantity||0)})});const s=Object.entries(p).sort((o,g)=>g[1]-o[1]).slice(0,5),u=document.getElementById("topProductsChart");u?(M&&M.destroy(),M=new Chart(u,{type:"bar",data:{labels:s.map(([o])=>o.length>12?o.slice(0,12)+"...":o),datasets:[{label:"Quantity",data:s.map(([,o])=>o),backgroundColor:[v.olive,v.terracotta,v.gunmetal,v.success,v.warning],borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}})):console.warn("Top products chart canvas not found")}catch(t){console.error("Error loading analytics:",t)}}let U=[];async function pe(){try{const e=await fetch("/api/customers",{credentials:"include"}),t=await e.json();if(e.ok){U=t.data||[];const n=document.getElementById("ledgerCustomer");n.innerHTML="",n.appendChild(r("option",{value:""},"All Customers")),U.forEach(a=>{n.appendChild(r("option",{value:a._id},a.name))})}}catch(e){console.error("Error loading customers:",e)}}window.openLedgerModal=function(){U.length===0&&pe();const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1);document.getElementById("ledgerFromDate").value=t.toISOString().split("T")[0],document.getElementById("ledgerToDate").value=e.toISOString().split("T")[0],document.getElementById("ledgerModal").classList.add("show"),document.body.style.overflow="hidden"};window.closeLedgerModal=function(){document.getElementById("ledgerModal").classList.remove("show"),document.body.style.overflow=""};window.downloadLedger=async function(){const e=document.getElementById("ledgerCustomer").value,t=document.getElementById("ledgerFromDate").value,n=document.getElementById("ledgerToDate").value,a=new URLSearchParams;e&&a.append("customerId",e),t&&a.append("fromDate",t),n&&a.append("toDate",n);const l=document.querySelector('#ledgerModal .btn-download, #ledgerModal button[onclick*="downloadLedger"]');l&&(l.disabled=!0,l.classList.add("btn-loading"));try{E("Downloading ledger...","info");const i=await fetch(`/api/reports/ledger?${a}`,{credentials:"include"});if(!i.ok){const u=await i.json();throw new Error(u.message||"Ledger temporarily unavailable")}const d=await i.blob(),m=window.URL.createObjectURL(d),c=i.headers.get("Content-Disposition");let p="ledger.xlsx";c&&c.includes("filename=")&&(p=c.split("filename=")[1].replace(/"/g,""));const s=document.createElement("a");s.href=m,s.download=p,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(m),E("Ledger downloaded!","success"),window.closeLedgerModal()}catch(i){console.error("Download ledger error:",i),E(i.message||"Could not download","info")}finally{l&&(l.disabled=!1,l.classList.remove("btn-loading"))}};async function me(){const e=await T.requireAuth(["admin","staff"]);if(!e)return;if(e.role==="staff"){window.location.href="/pages/staff-dashboard/";return}const t=document.getElementById("userBadge");t&&(t.textContent=e.name||e.email||"User",e.role==="admin"&&(t.style.cursor="pointer",t.title="Manage Users",t.onclick=()=>{window.location.href="/pages/users/"})),B(),de()}me();
