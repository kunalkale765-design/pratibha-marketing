import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css                */import{c as o,s as C}from"./ui-D1Am529b.js";import"./api-BqPqbFNt.js";import{i as Z,l as X}from"./init-6NQZls6S.js";function E(e,a=!0){if(e==null||isNaN(e))return a?"â‚¹0":"0";const c=Number(e).toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2});return a?`â‚¹${c}`:c}const M=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(M()),10)}),N=await M();Z();let I=[],R=[],P=[],$=[],x="all";const v={},O=document.getElementById("logoutBtn"),j=document.getElementById("printBtn"),F=document.getElementById("exportBtn"),y=document.getElementById("saveRatesBtn");O&&O.addEventListener("click",X);j&&j.addEventListener("click",z);F&&F.addEventListener("click",J);y&&y.addEventListener("click",K);document.querySelectorAll(".batch-filter-btn").forEach(e=>{e.addEventListener("click",()=>{document.querySelectorAll(".batch-filter-btn").forEach(a=>a.classList.remove("active")),e.classList.add("active"),x=e.dataset.batch,q()})});async function A(){try{const[e,a,c,i,r,u]=await Promise.all([fetch("/api/orders",{credentials:"include"}),fetch("/api/customers",{credentials:"include"}),fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/supplier/quantity-summary",{credentials:"include"}),fetch("/api/supplier/batch-summary",{credentials:"include"})]),s=await e.json(),m=await a.json(),g=await c.json(),t=await i.json(),d=await r.json(),p=await u.json();I=g.data||[],R=t.data||[],P=d.data||[],$=p.data||[];const n=s.data||[],l=n.filter(w=>w.status==="delivered"||w.paymentStatus==="paid").reduce((w,L)=>w+(L.totalAmount||0),0),B=l*.15;document.getElementById("totalSale").textContent=E(l),document.getElementById("totalProfit").textContent=E(B),q(),Y(n)}catch(e){console.error("Error loading dashboard stats:",e),document.getElementById("totalSale").textContent="â€”",document.getElementById("totalProfit").textContent="â€”",document.getElementById("procurementList").innerHTML="",document.getElementById("procurementList").appendChild(o("div",{className:"empty-state"},[o("p",{},"Data not available"),o("button",{id:"retryBtn",className:"btn-retry",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:A},"Try Again")]))}}function q(){const e=document.getElementById("procurementList");if(e.innerHTML="",!I||I.length===0){e.appendChild(o("div",{className:"empty-state"},"No products available"));return}const a={};R.forEach(t=>{a[t.product]=t});let c=P;if(x!=="all"){const t=$.find(d=>d.batchType===x);t&&t.products?c=t.products.map(d=>({productName:d.productName,totalQuantity:d.totalQuantity,unit:d.unit,orderCount:d.orderCount})):c=[]}const i={};c.forEach(t=>{i[t.productName]=t});const u=[...I.filter(t=>t.category==="Indian Vegetables"||t.category==="Fruits")].sort((t,d)=>{if(t.category==="Indian Vegetables"&&d.category==="Fruits")return-1;if(t.category==="Fruits"&&d.category==="Indian Vegetables")return 1;const p=a[t._id]?.rate||0,n=a[d._id]?.rate||0;if(p===0&&n!==0)return-1;if(p!==0&&n===0)return 1;const l=i[t.name]?.totalQuantity||0;return(i[d.name]?.totalQuantity||0)-l}),s=document.createDocumentFragment(),m=o("div",{className:"procurement-column-header"},[o("span",{className:"col-expand"}),o("span",{className:"col-name"},"Product"),o("span",{className:"col-qty"},"Purchase Qty"),o("span",{className:"col-input"},"Purchase Price")]);s.appendChild(m);let g="";u.forEach(t=>{const d=a[t._id],p=d?d.rate:0,n=d?d.trend:"stable",l=i[t.name],f=l?l.totalQuantity:0,B=l?l.orderCount:0,w=f>0?f*p:0,L=f>0?"item-qty":"item-qty zero",U=n==="up"?"â†‘ Up":n==="down"?"â†“ Down":"â€” Stable",Q=p===0?" unsaved":"";t.category!==g&&(g=t.category,s.appendChild(o("div",{className:"category-divider"},g)));const V=o("div",{className:`procurement-item${Q}`,dataset:{productId:t._id}},[o("div",{className:"item-main",onclick:b=>window.toggleExpand(b.currentTarget)},[o("span",{className:"item-expand"},"â–¶"),o("span",{className:"item-name"},t.name),o("span",{className:L},f),o("span",{className:"item-unit"},t.unit),o("input",{type:"number",className:"item-rate-input",dataset:{productId:t._id,productName:t.name,currentRate:p},placeholder:`â‚¹${p.toFixed(0)}`,step:"0.01",min:"0",onclick:b=>b.stopPropagation(),onchange:b=>window.handleRateChange(b.target),oninput:b=>window.handleRateInput(b.target)})]),o("div",{className:"item-details"},[o("div",{className:"detail-row"},[o("span",{className:"detail-label"},"Current Rate"),o("span",{className:"detail-value"},`â‚¹${p.toFixed(2)}/${t.unit}`)]),o("div",{className:"detail-row"},[o("span",{className:"detail-label"},"Orders"),o("span",{className:"detail-value"},B)]),o("div",{className:"detail-row"},[o("span",{className:"detail-label"},"Est. Cost"),o("span",{className:"detail-value highlight"},w>0?E(w):"-")]),o("div",{className:"detail-row"},[o("span",{className:"detail-label"},"Trend"),o("span",{className:"detail-value"},U)])])]);s.appendChild(V)}),e.appendChild(s)}window.toggleExpand=function(e){e.closest(".procurement-item").classList.toggle("expanded")};window.handleRateInput=function(e){const a=parseFloat(e.dataset.currentRate),c=parseFloat(e.value);e.classList.toggle("changed",e.value&&c!==a)};window.handleRateChange=function(e){const a=e.dataset.productId,c=e.dataset.productName,i=parseFloat(e.dataset.currentRate),r=parseFloat(e.value);e.value&&r!==i&&r>0?(v[a]={product:a,productName:c,rate:r,previousRate:i},e.classList.add("changed")):(delete v[a],e.classList.remove("changed")),y&&y.classList.toggle("show",Object.keys(v).length>0)};function z(){const e=document.getElementById("procurementList").innerHTML,a=window.open("","_blank");a.document.write(`
        <html>
        <head>
            <title>Purchase List - Pratibha Marketing</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { font-size: 18px; margin-bottom: 10px; }
                .date { color: #666; margin-bottom: 20px; }
                .item { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
                .item-name { font-weight: bold; }
                .item-qty { font-family: monospace; }
                .item-details, .item-expand, .item-rate-input, button { display: none !important; }
            </style>
        </head>
        <body>
            <h1>Purchase List - Pratibha Marketing</h1>
            <div class="date">${new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>
            ${e}
        </body>
        </html>
    `),a.document.close(),a.print()}function J(){const e={};R.forEach(t=>{const d=typeof t.product=="object"?t.product._id:t.product;e[d]=t});const a={};P.forEach(t=>{a[t.productName]=t});const c=I.filter(t=>t.category==="Indian Vegetables"||t.category==="Fruits").sort((t,d)=>{if(t.category==="Indian Vegetables"&&d.category==="Fruits")return-1;if(t.category==="Fruits"&&d.category==="Indian Vegetables")return 1;const p=e[t._id]?.rate||0,n=e[d._id]?.rate||0;if(p===0&&n!==0)return-1;if(p!==0&&n===0)return 1;const l=a[t.name]?.totalQuantity||0;return(a[d.name]?.totalQuantity||0)-l}),i=["Category","Product","Unit","Qty Needed","Current Rate","Est. Cost"],r=c.map(t=>{const p=a[t.name]?.totalQuantity||0,n=e[t._id],l=n?n.rate:0,f=p*l;return[`"${t.category}"`,`"${t.name}"`,t.unit,p,l,f.toFixed(2)].join(",")}),u=[i.join(","),...r].join(`
`),s=new Blob([u],{type:"text/csv"}),m=window.URL.createObjectURL(s),g=document.createElement("a");g.href=m,g.download=`purchase-list-${new Date().toISOString().split("T")[0]}.csv`,g.click(),window.URL.revokeObjectURL(m)}async function K(){if(!y)return;y.textContent="Saving...",y.disabled=!0;const e=[],a=[],c={"Content-Type":"application/json"};let i=await N.ensureCsrfToken();i&&(c["X-CSRF-Token"]=i);for(const[r,u]of Object.entries(v))try{let s=await fetch("/api/market-rates",{method:"POST",headers:c,credentials:"include",body:JSON.stringify({product:u.product,rate:u.rate,effectiveDate:new Date().toISOString()})});if(s.status===403){const m=await s.json().catch(()=>({}));if(m.message?.toLowerCase().includes("csrf"))i=await N.refreshCsrfToken(),i&&(c["X-CSRF-Token"]=i,s=await fetch("/api/market-rates",{method:"POST",headers:c,credentials:"include",body:JSON.stringify({product:u.product,rate:u.rate,effectiveDate:new Date().toISOString()})}));else{e.push({productName:u.productName||r,error:m.message||`HTTP ${s.status}`});continue}}if(s.ok)a.push(r);else{const m=await s.json().catch(()=>({}));e.push({productName:u.productName||r,error:m.message||`HTTP ${s.status}`})}}catch(s){console.error("Error saving rate:",s),e.push({productName:u.productName||r,error:s.message||"Network error"})}for(const r of a)delete v[r];y.textContent="Save",y.disabled=!1,e.length>0?(e.map(r=>r.productName).join(", "),C(`${e.length} rate(s) not saved. Try again.`,"info"),Object.keys(v).length>0?y.classList.add("show"):y.classList.remove("show")):(y.classList.remove("show"),document.querySelectorAll(".item-rate-input").forEach(r=>{r.value="",r.classList.remove("changed")})),A()}async function W(){try{(await(await fetch("/api/health")).json()).status==="ok"?(document.getElementById("apiDot").classList.remove("offline"),document.getElementById("apiStatus").textContent="API Online"):(document.getElementById("apiDot").classList.add("offline"),document.getElementById("apiStatus").textContent="API Offline")}catch{document.getElementById("apiDot").classList.add("offline"),document.getElementById("apiStatus").textContent="API Offline"}}let D=null,T=null,k=null;const h={olive:"rgb(126, 145, 129)",oliveLight:"rgba(126, 145, 129, 0.2)",gunmetal:"rgb(46, 53, 50)",terracotta:"rgb(196, 167, 125)",success:"rgb(93, 122, 95)",warning:"rgb(184, 154, 90)",error:"rgb(154, 101, 101)",slate:"rgb(199, 206, 219)"};async function Y(e){try{const a={pending:0,confirmed:0,delivered:0,cancelled:0};e.forEach(n=>{Object.hasOwn(a,n.status)&&a[n.status]++}),document.getElementById("pendingCount").textContent=a.pending,document.getElementById("processingCount").textContent=a.confirmed,document.getElementById("deliveredCount").textContent=a.delivered;const c=document.getElementById("orderStatusChart");D&&D.destroy(),D=new Chart(c,{type:"doughnut",data:{labels:["Pending","Confirmed","Delivered","Cancelled"],datasets:[{data:[a.pending,a.confirmed,a.delivered,a.cancelled],backgroundColor:[h.warning,h.olive,h.success,h.error],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!1}}}});const i=[],r={};for(let n=6;n>=0;n--){const l=new Date;l.setDate(l.getDate()-n);const f=l.toISOString().split("T")[0];i.push(f),r[f]=0}e.forEach(n=>{if(n.status!=="cancelled"){const l=new Date(n.createdAt).toISOString().split("T")[0];Object.hasOwn(r,l)&&(r[l]+=n.totalAmount||0)}});const u=i.map(n=>r[n]),s=u.reduce((n,l)=>n+l,0),m=s/7;document.getElementById("weekTotal").textContent=E(s),document.getElementById("avgDaily").textContent=E(Math.round(m));const g=document.getElementById("revenueChart");T&&T.destroy(),T=new Chart(g,{type:"line",data:{labels:i.map(n=>new Date(n).toLocaleDateString("en-IN",{weekday:"short"})),datasets:[{label:"Revenue",data:u,borderColor:h.olive,backgroundColor:h.oliveLight,fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:h.olive}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:n=>"â‚¹"+n.toLocaleString("en-IN")}}}}});const t={};e.forEach(n=>{n.status!=="cancelled"&&n.products&&n.products.forEach(l=>{const f=l.productName||"Unknown";t[f]=(t[f]||0)+(l.quantity||0)})});const d=Object.entries(t).sort((n,l)=>l[1]-n[1]).slice(0,5),p=document.getElementById("topProductsChart");k&&k.destroy(),k=new Chart(p,{type:"bar",data:{labels:d.map(([n])=>n.length>12?n.slice(0,12)+"...":n),datasets:[{label:"Quantity",data:d.map(([,n])=>n),backgroundColor:[h.olive,h.terracotta,h.gunmetal,h.success,h.warning],borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}})}catch(a){console.error("Error loading analytics:",a)}}let S=[];async function G(){try{const e=await fetch("/api/customers",{credentials:"include"}),a=await e.json();if(e.ok){S=a.data||[];const c=document.getElementById("ledgerCustomer");c.innerHTML="",c.appendChild(o("option",{value:""},"All Customers")),S.forEach(i=>{c.appendChild(o("option",{value:i._id},i.name))})}}catch(e){console.error("Error loading customers:",e)}}window.openLedgerModal=function(){S.length===0&&G();const e=new Date,a=new Date(e.getFullYear(),e.getMonth(),1);document.getElementById("ledgerFromDate").value=a.toISOString().split("T")[0],document.getElementById("ledgerToDate").value=e.toISOString().split("T")[0],document.getElementById("ledgerModal").classList.add("show"),document.body.style.overflow="hidden"};window.closeLedgerModal=function(){document.getElementById("ledgerModal").classList.remove("show"),document.body.style.overflow=""};window.downloadLedger=async function(){const e=document.getElementById("ledgerCustomer").value,a=document.getElementById("ledgerFromDate").value,c=document.getElementById("ledgerToDate").value,i=new URLSearchParams;e&&i.append("customerId",e),a&&i.append("fromDate",a),c&&i.append("toDate",c);try{C("Downloading ledger...","info");const r=await fetch(`/api/reports/ledger?${i}`,{credentials:"include"});if(!r.ok){const d=await r.json();throw new Error(d.message||"Ledger temporarily unavailable")}const u=await r.blob(),s=window.URL.createObjectURL(u),m=r.headers.get("Content-Disposition");let g="ledger.xlsx";m&&m.includes("filename=")&&(g=m.split("filename=")[1].replace(/"/g,""));const t=document.createElement("a");t.href=s,t.download=g,document.body.appendChild(t),t.click(),document.body.removeChild(t),window.URL.revokeObjectURL(s),C("Ledger downloaded!","success"),window.closeLedgerModal()}catch(r){console.error("Download ledger error:",r),C(r.message||"Could not download","info")}};async function _(){try{const e=await fetch("/api/batches/today",{credentials:"include"}),a=await e.json();if(!e.ok){const s=document.getElementById("batchCards");s.innerHTML="",s.appendChild(o("div",{className:"empty-state"},"Could not load batches"));return}const c=document.getElementById("batchInfo");c.innerHTML="",c.appendChild(o("span",{className:"badge badge-info"},`Currently accepting: ${a.currentBatch}`));const i=new Date(a.currentTime);document.getElementById("batchCurrentTime").textContent=i.toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"})+" IST";const r=a.data||[];if(r.length===0){const s=document.getElementById("batchCards");s.innerHTML="",s.appendChild(o("div",{className:"empty-state"},"No batches for today yet"));return}document.getElementById("batchCards").innerHTML="";const u=document.createDocumentFragment();r.forEach(s=>{const m=s.status==="open",g=s.status==="confirmed",t=g?"confirmed":m?"open":"expired",d=g?"ðŸ”’ Confirmed":m?"ðŸ“ Open":"â° Expired",p=s.batchType==="2nd"&&m,n=[o("div",{className:"batch-stat"},[o("span",{className:"batch-stat-value"},s.totalOrders||0),o("span",{className:"batch-stat-label"},"Orders")])];if(g&&s.confirmedAt){const f=[`Confirmed at ${new Date(s.confirmedAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"})}`];s.confirmedBy?.name&&f.push(` by ${s.confirmedBy.name}`),n.push(o("div",{className:"batch-confirmed-info"},f))}const l=[o("div",{className:"batch-card-header"},[o("span",{className:"batch-type"},`${s.batchType} Batch`),o("span",{className:"batch-status"},d)]),o("div",{className:"batch-card-body"},n)];p&&l.push(o("div",{className:"batch-card-actions"},[o("button",{className:"btn-confirm-batch",onclick:()=>H(s._id)},"Confirm Batch")])),u.appendChild(o("div",{className:`batch-card ${t}`},l))}),document.getElementById("batchCards").appendChild(u)}catch(e){console.error("Error loading batches:",e);const a=document.getElementById("batchCards");a.innerHTML="",a.appendChild(o("div",{className:"empty-state"},"Could not load batches"))}}async function H(e){if(confirm("Are you sure you want to confirm this batch? Orders will be locked and customers will not be able to edit them."))try{const a=await N.ensureCsrfToken(),c={"Content-Type":"application/json"};a&&(c["X-CSRF-Token"]=a);const i=await fetch(`/api/batches/${e}/confirm`,{method:"POST",credentials:"include",headers:c}),r=await i.json();if(!i.ok){C(r.message||"Could not confirm batch","error");return}C(r.message||"Batch confirmed successfully","success"),_()}catch(a){console.error("Error confirming batch:",a),C("Could not confirm batch","error")}}window.confirmBatch=H;async function ee(){const e=await N.requireAuth(["admin","staff"]);e&&(document.getElementById("userBadge").textContent=e.name||e.email||"User",A(),W())}ee();
