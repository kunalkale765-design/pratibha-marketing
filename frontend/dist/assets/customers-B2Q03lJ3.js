import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as r,c as a}from"./ui-D1Am529b.js";const S=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(S()),10)}),u=await S();let m=[],w=[],p={},T="",F=!1;async function R(){u.ensureCsrfToken().catch(n=>console.warn("CSRF pre-fetch failed:",n)),await u.requireAuth(["admin","staff"])&&await Promise.all([y(),A()])}async function A(){try{const e=await fetch("/api/products",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);w=(await e.json()).data||[]}catch(e){console.error("Failed to load products:",e),r("Products not available. Try again.","info")}}async function y(){try{m=(await(await fetch(F?"/api/customers?includeTest=true":"/api/customers",{credentials:"include"})).json()).data||[],$(m)}catch(e){console.error("Failed to load customers:",e);const n=document.getElementById("customersList"),t=navigator.onLine?"Customers not available":"No internet connection";n.innerHTML="",n.appendChild(a("div",{className:"empty-state"},[a("p",{},t),a("button",{id:"retryCustomersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:y},"Try Again")]))}}function x(e){const n=e.pricingType||"market";return n==="contract"?a("span",{className:"badge badge-contract"},"Contract"):n==="markup"?a("span",{className:"badge badge-markup"},`+${e.markupPercentage||0}%`):a("span",{className:"badge badge-market"},"Market")}function $(e){const n=document.getElementById("customersList");if(!e||!e.length){n.innerHTML="",n.appendChild(a("div",{className:"empty-state"},"No customers found"));return}n.innerHTML="";const t=document.createDocumentFragment();e.forEach((o,s)=>{const c=[];o.phone&&c.push(a("span",{},o.phone)),o.address&&c.push(a("span",{},o.address));const i=[a("button",{onclick:()=>window.shareMagicLink(o._id),className:"btn-action link",title:"Share order link"},"Link")];o.pricingType==="contract"&&i.push(a("button",{onclick:()=>window.openContractPrices(o._id),className:"btn-action"},"Prices")),i.push(a("button",{onclick:()=>window.editCustomerById(o._id),className:"btn-action primary"},"Edit")),i.push(a("button",{onclick:()=>window.deleteCustomer(o._id),className:"btn-action danger"},"Delete"));const d=[x(o)];o.isTestCustomer&&d.unshift(a("span",{className:"badge badge-test"},"Test"));const l=a("div",{className:`customer-card card-animated card-fade-in${o.isTestCustomer?" test-customer":""}`,style:{animationDelay:`${s*.05}s`}},[a("div",{className:"customer-header"},[a("div",{className:"customer-name"},o.name),a("div",{className:"customer-badges"},d)]),a("div",{className:"customer-details"},c),a("div",{className:"customer-actions"},i)]);t.appendChild(l)}),n.appendChild(t)}function X(){const e=document.getElementById("searchInput").value.toLowerCase(),n=m.filter(t=>t.name.toLowerCase().includes(e)||t.phone&&t.phone.includes(e));$(n)}function E(){const e=document.getElementById("customerPricingType").value;document.getElementById("markupField").classList.toggle("hidden",e!=="markup"),document.getElementById("contractInfo").classList.toggle("hidden",e!=="contract")}function q(){document.getElementById("modalTitle").textContent="Add Customer",document.getElementById("customerForm").reset(),document.getElementById("customerId").value="",document.getElementById("customerIsTest").checked=!1,document.getElementById("customerPricingType").value="market",E(),document.getElementById("customerModal").classList.add("show")}function H(e){document.getElementById("modalTitle").textContent="Edit Customer",document.getElementById("customerId").value=e._id,document.getElementById("customerName").value=e.name,document.getElementById("customerPhone").value=e.phone||"",document.getElementById("customerWhatsapp").value=e.whatsapp||"",document.getElementById("customerAddress").value=e.address||"",document.getElementById("customerIsTest").checked=e.isTestCustomer||!1,document.getElementById("customerPricingType").value=e.pricingType||"market",document.getElementById("customerMarkup").value=e.markupPercentage||0,E(),document.getElementById("customerModal").classList.add("show")}function I(){document.getElementById("customerModal").classList.remove("show")}function J(){const e=document.getElementById("customerForm");e&&e.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("saveCustomerBtn"),o=document.getElementById("customerId").value,s=document.getElementById("customerPricingType").value,c=document.getElementById("customerName").value.trim(),i=document.getElementById("customerPhone").value.trim(),d=document.getElementById("customerWhatsapp").value.trim();if(!c){r("Please enter customer name","info"),document.getElementById("customerName").focus();return}if(i&&!/^[0-9]{10}$/.test(i)){r("Phone should be 10 digits","info"),document.getElementById("customerPhone").focus();return}if(d&&!/^[0-9]{10}$/.test(d)){r("WhatsApp should be 10 digits","info"),document.getElementById("customerWhatsapp").focus();return}const l=parseFloat(document.getElementById("customerMarkup").value)||0;if(s==="markup"&&(l<0||l>200)){r("Markup should be 0-200%","info"),document.getElementById("customerMarkup").focus();return}t.classList.add("btn-loading"),t.disabled=!0;const h={name:c,phone:i,whatsapp:d,address:document.getElementById("customerAddress").value.trim(),isTestCustomer:document.getElementById("customerIsTest").checked,pricingType:s,markupPercentage:s==="markup"?l:0};try{const k=o?`/api/customers/${o}`:"/api/customers",P=o?"PUT":"POST",v={"Content-Type":"application/json"},L=await u.ensureCsrfToken();L&&(v["X-CSRF-Token"]=L);let C=await fetch(k,{method:P,headers:v,credentials:"include",body:JSON.stringify(h)});if(C.status===403){const f=await C.json();if(f.message?.toLowerCase().includes("csrf")){const g=await u.refreshCsrfToken();g&&(v["X-CSRF-Token"]=g,C=await fetch(k,{method:P,headers:v,credentials:"include",body:JSON.stringify(h)}))}else{const g=f.errors?.[0]?.msg||f.message||"Could not save. Try again.";r(g,"info"),t.classList.remove("btn-loading"),t.disabled=!1;return}}if(C.ok)t.classList.remove("btn-loading"),t.classList.add("btn-success"),r(o?"Customer updated":"Customer added","success"),setTimeout(()=>{t.classList.remove("btn-success"),I()},800),y();else{const f=await C.json(),g=f.errors?.[0]?.msg||f.message||"Could not save. Try again.";r(g,"info")}}catch(k){console.error("Save customer error:",k),navigator.onLine?r("Could not save. Please try again.","info"):r("No internet connection","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}})}async function j(e,n=!1){if(!(!n&&!confirm("Delete this customer?")))try{const t={},o=await u.ensureCsrfToken();o&&(t["X-CSRF-Token"]=o);const s=await fetch(`/api/customers/${e}`,{method:"DELETE",headers:t,credentials:"include"});if(s.status===403&&!n&&(await s.json()).message?.toLowerCase().includes("csrf"))return await u.refreshCsrfToken(),j(e,!0);if(s.ok)r("Customer deleted","success"),y();else{const c=await s.json();r(c.message||"Could not delete","info")}}catch(t){console.error("Delete customer error:",t),navigator.onLine?r("Could not delete. Please try again.","info"):r("No internet connection","info")}}function U(e){const n=m.find(t=>t._id===e);n&&H(n)}async function O(e,n=!1){const t=m.find(o=>o._id===e);if(!t){r("Customer data updating. Please refresh.","info");return}try{const o={},s=await u.ensureCsrfToken();s&&(o["X-CSRF-Token"]=s);const c=await fetch(`/api/customers/${e}/magic-link`,{method:"POST",headers:o,credentials:"include"}),i=await c.json();if(c.status===403&&i?.message?.toLowerCase().includes("csrf")&&!n)return await u.refreshCsrfToken(),O(e,!0);if(c.ok&&i.data){const d=i.data.link;if(navigator.clipboard?(await navigator.clipboard.writeText(d),r(`Link copied for ${t.name}`,"success")):prompt("Copy this order link:",d),navigator.share)try{await navigator.share({title:"Pratibha Marketing - Order",text:`Place your order here, ${t.name}`,url:d})}catch(l){l.name!=="AbortError"&&console.warn("Share API failed:",l.name,l.message)}}else r(i.message||"Could not generate link","info")}catch(o){console.error("Magic link error:",o),navigator.onLine?r("Could not generate link. Try again.","info"):r("No internet connection","info")}}async function W(e){const n=m.find(t=>t._id===e);if(!n){r("Customer data updating. Please refresh.","info");return}w.length||await A(),document.getElementById("contractCustomerId").value=e,document.getElementById("contractCustomerName").textContent=n.name,n.contractPrices instanceof Map?p=Object.fromEntries(n.contractPrices):p=n.contractPrices||{},V(),T="",document.getElementById("productSearch").value="",_(w),document.getElementById("contractModal").classList.add("show")}function V(){const e=[...new Set(w.map(o=>o.category||"Other"))].sort(),n=document.getElementById("contractCategoryPills");n.innerHTML="";const t=document.createDocumentFragment();t.appendChild(a("button",{className:"cat-pill active",dataset:{category:""},onclick:()=>window.filterByContractCategory("")},"All")),e.forEach(o=>{const s=o.replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase());t.appendChild(a("button",{className:"cat-pill",dataset:{category:o},onclick:()=>window.filterByContractCategory(o)},s))}),n.appendChild(t)}function _(e){const n=document.getElementById("contractPricesList");n.innerHTML="";const t=document.createDocumentFragment();e.forEach(o=>{const s=p[o._id]||"",c=a("div",{className:"contract-item"},[a("div",{className:"contract-item-info"},[a("div",{className:"contract-item-name"},o.name),a("div",{className:"contract-item-base"},`per ${o.unit}`)]),a("input",{type:"number",step:"0.01",min:"0",className:"contract-price-input input-animated",dataset:{productId:o._id},value:String(s),placeholder:"â‚¹"}),a("span",{className:"contract-item-unit"},`/${o.unit}`)]);t.appendChild(c)}),n.appendChild(t)}function B(){document.querySelectorAll(".contract-price-input").forEach(e=>{const n=e.dataset.productId,t=parseFloat(e.value);!isNaN(t)&&t>0?p[n]=t:delete p[n]})}function D(){B();const e=document.getElementById("productSearch").value.toLowerCase(),n=w.filter(t=>{const o=t.name.toLowerCase().includes(e),s=!T||(t.category||"Other")===T;return o&&s});_(n)}function z(e){B(),T=e,document.querySelectorAll("#contractCategoryPills .cat-pill").forEach(n=>{n.classList.toggle("active",n.dataset.category===e)}),D()}async function G(){const e=document.getElementById("contractCustomerId").value,n=m.find(s=>s._id===e);if(!n){r("Customer data updating. Please refresh.","info");return}const t=document.getElementById("saveContractBtn");t.classList.add("btn-loading"),t.disabled=!0,B();const o={...p};try{const s={"Content-Type":"application/json"},c=await u.ensureCsrfToken();c&&(s["X-CSRF-Token"]=c);const i={name:n.name,phone:n.phone,contractPrices:o};let d=await fetch(`/api/customers/${e}`,{method:"PUT",headers:s,credentials:"include",body:JSON.stringify(i)});if(d.status===403&&(await d.json()).message?.toLowerCase().includes("csrf")){const h=await u.refreshCsrfToken();h&&(s["X-CSRF-Token"]=h,d=await fetch(`/api/customers/${e}`,{method:"PUT",headers:s,credentials:"include",body:JSON.stringify(i)}))}if(d.ok)t.classList.remove("btn-loading"),t.classList.add("btn-success"),r("Prices saved","success"),setTimeout(()=>{t.classList.remove("btn-success"),b()},800),y();else{const l=await d.json();r(l.errors?.[0]?.msg||l.message||"Could not save","info")}}catch(s){console.error("Save contract prices error:",s),navigator.onLine?r("Could not save prices. Try again.","info"):r("No internet connection","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}}function b(){document.getElementById("contractModal").classList.remove("show"),document.getElementById("productSearch").value=""}function K(){F=document.getElementById("showTestCustomers").checked,y()}window.showAddCustomerForm=q;window.searchCustomers=X;window.toggleMarkupField=E;window.toggleTestCustomers=K;window.closeModal=I;window.editCustomerById=U;window.deleteCustomer=j;window.shareMagicLink=O;window.openContractPrices=W;window.filterContractProducts=D;window.filterByContractCategory=z;window.saveContractPrices=G;window.closeContractModal=b;const N=document.getElementById("customerModal");N&&(N.onclick=e=>{e.target.id==="customerModal"&&I()});const M=document.getElementById("contractModal");M&&(M.onclick=e=>{e.target.id==="contractModal"&&b()});J();R();
