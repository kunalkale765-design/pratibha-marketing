import"./responsive-D1ZTW0b0.js";/* empty css               *//* empty css                *//* empty css              */import{t as p}from"./ui-CbzHyiqg.js";import"./api-CPXug1OA.js";import{r as y}from"./init-BoJp8Xjr.js";y();const k=(e=1e4)=>new Promise((r,o)=>{const t=Date.now(),i=()=>{if(window.Auth)return r(window.Auth);if(Date.now()-t>e)return o(new Error("Auth not available"));setTimeout(i,50)};i()}),l=await k();l.ensureCsrfToken().catch(e=>console.warn("CSRF pre-fetch failed:",e));const w=document.getElementById("loginForm"),d=document.getElementById("loginBtn"),s=document.getElementById("noticeMessage"),f=document.getElementById("passwordToggle");f&&f.addEventListener("click",()=>{p("password",f)});T();async function T(){try{const e=await fetch("/api/auth/me",{credentials:"include"});e.ok&&((await e.json()).user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/")}catch{}}w&&w.addEventListener("submit",async e=>{e.preventDefault();const r=document.getElementById("email").value.trim(),o=document.getElementById("password").value;if(!r||!o){n("Please enter username and password");return}d.disabled=!0,d.classList.add("btn-loading"),C();try{const t={"Content-Type":"application/json"},i=await l.ensureCsrfToken();i&&(t["X-CSRF-Token"]=i);const c=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:r,password:o})});if(c.status===429){n("Too many attempts. Please try again later.");return}const a=await c.json();if(c.status===403&&a?.message?.toLowerCase().includes("csrf")){console.log("CSRF error, refreshing token and retrying...");const m=await l.refreshCsrfToken();if(m){t["X-CSRF-Token"]=m;const g=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:r,password:o})}),u=await g.json();if(g.ok){l.setUser(u.user),u.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/";return}n(u.message||"Please check your credentials");return}}c.ok?(l.setUser(a.user),a.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/"):n(a.message||"Please check your credentials")}catch(t){console.error("Login error:",t),navigator.onLine?t.name==="TypeError"||t.message.includes("fetch")?n("Connection issue. Please try again."):n("Something went wrong. Try again."):n("No internet connection")}finally{d&&(d.disabled=!1,d.classList.remove("btn-loading"))}});function n(e){s&&(s.textContent=e,s.classList.add("show"))}function C(){s&&s.classList.remove("show")}const h=document.getElementById("forgotPasswordLink");h&&h.addEventListener("click",async e=>{e.preventDefault();const r=document.getElementById("email").value.trim();if(!r){n("Please enter your username first");return}try{const o={"Content-Type":"application/json"},t=await l.ensureCsrfToken();t&&(o["X-CSRF-Token"]=t);const i=await fetch("/api/auth/forgot-password",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({email:r})}),c=await i.json();if(i.ok&&c.resetUrl){s.textContent="",s.appendChild(document.createTextNode("Reset link generated! "));const a=document.createElement("a");a.href=c.resetUrl,a.style.cssText="color: var(--dusty-olive); text-decoration: underline;",a.textContent="Click here to reset",s.appendChild(a),s.classList.add("show"),s.classList.remove("error")}else n(c.message||"If an account exists, a reset link has been generated")}catch(o){console.error("Forgot password error:",o),n("Could not process request. Try again.")}});
