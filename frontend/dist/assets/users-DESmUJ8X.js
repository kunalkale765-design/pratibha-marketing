import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               *//* empty css                            */import{s as o,c as i}from"./ui-DPXrEiII.js";const M=(e=1e4)=>new Promise((t,n)=>{const s=Date.now(),a=()=>{if(window.Auth)return t(window.Auth);if(Date.now()-s>e)return n(new Error("Auth not available"));setTimeout(a,50)};a()}),f=await M();let g=[],h="",T=!1,U=!1,u=!1;async function R(){f.ensureCsrfToken().catch(t=>console.warn("CSRF pre-fetch failed:",t)),await f.requireAuth(["admin"])&&await m()}async function m(){try{const e=new URLSearchParams;T&&e.set("isActive","all"),U&&e.set("includeTest","true");const t="/api/users"+(e.toString()?"?"+e:""),n=await fetch(t,{credentials:"include"});if(!n.ok){const a=await n.json().catch(()=>({}));throw new Error(a.message||`Server returned ${n.status}`)}g=(await n.json()).data||[],p(v())}catch(e){console.error("Failed to load users:",e);const t=document.getElementById("usersList"),n=navigator.onLine?e.message||"Users not available":"No internet connection";t.innerHTML="",t.appendChild(i("div",{className:"empty-state"},[i("p",{},n),i("button",{style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:m},"Try Again")]))}}function v(){const e=document.getElementById("searchInput").value.toLowerCase();return g.filter(t=>{const n=t.name.toLowerCase().includes(e)||t.email.toLowerCase().includes(e)||t.phone&&t.phone.includes(e),s=!h||t.role===h;return n&&s})}function S(e){const t={admin:"Admin",staff:"Staff",customer:"Customer"};return i("span",{className:`badge badge-${e}`},t[e]||e)}function p(e){const t=document.getElementById("usersList");if(!e||!e.length){t.innerHTML="",t.appendChild(i("div",{className:"empty-state"},"No users found"));return}t.innerHTML="";const n=document.createDocumentFragment();e.forEach((s,a)=>{const d=[S(s.role)];s.isActive||d.push(i("span",{className:"badge badge-inactive"},"Inactive"));const c=[];c.push(i("span",{className:"user-email"},s.email)),s.phone&&c.push(i("span",{},s.phone));const r=[];r.push(i("button",{onclick:()=>window.editUserById(s._id),className:"btn-action primary"},"Edit")),r.push(i("button",{onclick:()=>window.openResetPassword(s._id),className:"btn-action"},"Password")),s.isActive?r.push(i("button",{onclick:()=>window.deactivateUser(s._id),className:"btn-action danger"},"Deactivate")):r.push(i("button",{onclick:()=>window.activateUser(s._id),className:"btn-action link"},"Activate"));const l=i("div",{className:`customer-card card-animated card-fade-in${s.isActive?"":" inactive"}`,style:{animationDelay:`${a*.05}s`}},[i("div",{className:"customer-header"},[i("div",{className:"customer-name"},s.name),i("div",{className:"customer-badges"},d)]),i("div",{className:"customer-details"},c),i("div",{className:"customer-actions"},r)]);n.appendChild(l)}),t.appendChild(n)}function F(){p(v())}function D(e){h=e,document.querySelectorAll(".role-pill").forEach(t=>{t.classList.toggle("active",t.dataset.role===e)}),p(v())}function $(){T=document.getElementById("showInactive").checked,m()}function x(){U=document.getElementById("showTestUsers").checked,m()}function _(){document.getElementById("modalTitle").textContent="Add User",document.getElementById("userForm").reset(),document.getElementById("userId").value="",document.getElementById("userRole").value="staff",document.getElementById("passwordGroup").classList.remove("hidden"),document.getElementById("userPassword").required=!0,document.getElementById("userModal").classList.add("show"),setTimeout(()=>{u=!1},0)}function q(e){document.getElementById("modalTitle").textContent="Edit User",document.getElementById("userId").value=e._id,document.getElementById("userName").value=e.name,document.getElementById("userEmail").value=e.email,document.getElementById("userPhone").value=e.phone||"",document.getElementById("userRole").value=e.role,document.getElementById("passwordGroup").classList.add("hidden"),document.getElementById("userPassword").required=!1,document.getElementById("userPassword").value="",document.getElementById("userModal").classList.add("show"),setTimeout(()=>{u=!1},0)}function j(e){const t=g.find(n=>n._id===e);t&&q(t)}function P(){u&&!confirm("You have unsaved changes. Discard them?")||(u=!1,document.getElementById("userModal").classList.remove("show"))}function H(e,t){const n=document.getElementById(e);n.type==="password"?(n.type="text",t.textContent="Hide"):(n.type="password",t.textContent="Show")}function O(e){const t=g.find(n=>n._id===e);t&&(document.getElementById("passwordUserId").value=e,document.getElementById("passwordUserName").textContent=`${t.name} (${t.email})`,document.getElementById("newPassword").value="",document.getElementById("passwordModal").classList.add("show"))}function E(){document.getElementById("passwordModal").classList.remove("show")}async function w(e,t){const n={"Content-Type":"application/json",...t.headers},s=await f.ensureCsrfToken();s&&(n["X-CSRF-Token"]=s);let a=await fetch(e,{...t,headers:n,credentials:"include"});if(a.status===403){const c=await a.json();if(c.message?.toLowerCase().includes("csrf")){const r=await f.refreshCsrfToken();r&&(n["X-CSRF-Token"]=r,a=await fetch(e,{...t,headers:n,credentials:"include"}))}else return{res:a,data:c,csrfFailed:!1}}const d=await a.json();return{res:a,data:d}}async function J(e){if(confirm("Deactivate this user? They will not be able to login."))try{const{res:t,data:n}=await w(`/api/users/${e}`,{method:"DELETE"});t.ok?(o("User deactivated","success"),m()):o(n.message||"Could not deactivate","info")}catch(t){console.error("Deactivate error:",t),o(navigator.onLine?"Could not deactivate. Try again.":"No internet connection","info")}}async function z(e){try{const{res:t,data:n}=await w(`/api/users/${e}`,{method:"PUT",body:JSON.stringify({isActive:!0})});t.ok?(o("User activated","success"),m()):o(n.message||"Could not activate","info")}catch(t){console.error("Activate error:",t),o(navigator.onLine?"Could not activate. Try again.":"No internet connection","info")}}function G(){const e=document.getElementById("userForm");e&&(e.addEventListener("input",()=>{u=!0}),e.addEventListener("change",()=>{u=!0}),e.addEventListener("submit",async n=>{n.preventDefault();const s=document.getElementById("saveUserBtn"),a=document.getElementById("userId").value,d=document.getElementById("userName").value.trim(),c=document.getElementById("userEmail").value.trim(),r=document.getElementById("userPassword").value,l=document.getElementById("userPhone").value.trim(),C=document.getElementById("userRole").value;if(!d){o("Please enter name","info");return}if(!c||c.length<3){o("Username must be at least 3 characters","info");return}if(l&&!/^[0-9]{10}$/.test(l)){o("Phone should be 10 digits","info");return}if(!a&&!r){o("Password is required","info");return}if(r){if(r.length<6){o("Password must be at least 6 characters","info");return}if(!/[A-Z]/.test(r)){o("Password needs an uppercase letter","info");return}if(!/[a-z]/.test(r)){o("Password needs a lowercase letter","info");return}if(!/[0-9]/.test(r)){o("Password needs a number","info");return}}s.classList.add("btn-loading"),s.disabled=!0;const I={name:d,email:c,phone:l,role:C};!a&&r&&(I.password=r);try{const y=a?`/api/users/${a}`:"/api/users",N=a?"PUT":"POST",{res:k,data:B}=await w(y,{method:N,body:JSON.stringify(I)});if(k.ok)s.classList.remove("btn-loading"),s.classList.add("btn-success"),o(a?"User updated":"User created","success"),setTimeout(()=>{s.classList.remove("btn-success"),u=!1,document.getElementById("userModal").classList.remove("show")},800),m();else{const A=B.errors?.[0]?.msg||B.message||"Could not save. Try again.";o(A,"info")}}catch(y){console.error("Save user error:",y),o(navigator.onLine?"Could not save. Try again.":"No internet connection","info")}finally{s.classList.remove("btn-loading"),s.disabled=!1}}));const t=document.getElementById("passwordForm");t&&t.addEventListener("submit",async n=>{n.preventDefault();const s=document.getElementById("savePasswordBtn"),a=document.getElementById("passwordUserId").value,d=document.getElementById("newPassword").value;if(!d){o("Please enter new password","info");return}if(d.length<6){o("Password must be at least 6 characters","info");return}if(!/[A-Z]/.test(d)){o("Password needs an uppercase letter","info");return}if(!/[a-z]/.test(d)){o("Password needs a lowercase letter","info");return}if(!/[0-9]/.test(d)){o("Password needs a number","info");return}s.classList.add("btn-loading"),s.disabled=!0;try{const{res:c,data:r}=await w(`/api/users/${a}/password`,{method:"PUT",body:JSON.stringify({password:d})});if(c.ok)s.classList.remove("btn-loading"),s.classList.add("btn-success"),o("Password reset successfully","success"),setTimeout(()=>{s.classList.remove("btn-success"),E()},800);else{const l=r.errors?.[0]?.msg||r.message||"Could not reset password";o(l,"info")}}catch(c){console.error("Password reset error:",c),o(navigator.onLine?"Could not reset. Try again.":"No internet connection","info")}finally{s.classList.remove("btn-loading"),s.disabled=!1}})}window.showAddUserForm=_;window.searchUsers=F;window.filterByRole=D;window.toggleInactive=$;window.toggleTestUsers=x;window.closeModal=P;window.editUserById=j;window.openResetPassword=O;window.closePasswordModal=E;window.deactivateUser=J;window.activateUser=z;window.togglePasswordVisibility=H;const b=document.getElementById("userModal");b&&(b.onclick=e=>{e.target.id==="userModal"&&P()});const L=document.getElementById("passwordModal");L&&(L.onclick=e=>{e.target.id==="passwordModal"&&E()});G();R();
