{"version":3,"file":"marketRates-UCsCW5-J.js","sources":["../../src/js/pages/market-rates.js"],"sourcesContent":["\nimport { showToast, createElement } from '/js/ui.js';\n\n// Wait for Auth to be available (with timeout to prevent infinite recursion)\nconst waitForAuth = (maxWait = 10000) => new Promise((resolve, reject) => {\n    const startTime = Date.now();\n    const check = () => {\n        if (window.Auth) return resolve(window.Auth);\n        if (Date.now() - startTime > maxWait) return reject(new Error('Auth not available'));\n        setTimeout(check, 50);\n    };\n    check();\n});\nconst Auth = await waitForAuth();\n\nlet products = [];\nconst rates = {};\nlet changedRates = {};\nlet historyData = null;\n\nasync function init() {\n    const user = await Auth.requireAuth(['admin', 'staff']);\n    if (!user) return;\n\n    document.getElementById('dateBar').textContent = new Date().toLocaleDateString('en-IN', {\n        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'\n    });\n\n    await loadData();\n    await loadHistory();\n}\n\nasync function loadData() {\n    try {\n        const [productsRes, ratesRes] = await Promise.all([\n            fetch('/api/products', { credentials: 'include' }),\n            fetch('/api/market-rates', { credentials: 'include' })\n        ]);\n\n        if (!productsRes.ok) {\n            throw new Error(`Products: server returned ${productsRes.status}`);\n        }\n        if (!ratesRes.ok) {\n            throw new Error(`Market rates: server returned ${ratesRes.status}`);\n        }\n\n        const productsData = await productsRes.json();\n        const ratesData = await ratesRes.json();\n\n        products = (productsData.data || []).filter(p => p.isActive);\n\n        // Map rates by product ID\n        (ratesData.data || []).forEach(rate => {\n            const pid = typeof rate.product === 'object' ? rate.product._id : rate.product;\n            rates[pid] = rate.rate;\n        });\n\n        renderProducts();\n    } catch (e) {\n        console.error(e);\n        const container = document.getElementById('productList');\n        const errorMsg = !navigator.onLine ? 'No internet connection' : 'Data not available';\n        container.innerHTML = '';\n        container.appendChild(createElement('div', { className: 'loading' }, [\n            createElement('p', {}, errorMsg),\n            createElement('button', {\n                id: 'retryDataBtn',\n                style: { marginTop: '1rem', padding: '0.5rem 1rem', background: 'var(--dusty-olive)', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer' },\n                onclick: loadData\n            }, 'Try Again')\n        ]));\n    }\n}\n\nfunction renderProducts() {\n    const container = document.getElementById('productList');\n    container.innerHTML = '';\n\n    if (!products.length) {\n        container.appendChild(createElement('div', { className: 'loading' }, 'No products found'));\n        return;\n    }\n\n    // Group by category\n    const grouped = {};\n    products.forEach(p => {\n        const cat = p.category || 'other';\n        if (!grouped[cat]) grouped[cat] = [];\n        grouped[cat].push(p);\n    });\n\n    const fragment = document.createDocumentFragment();\n    let itemIdx = 0;\n\n    for (const [cat, prods] of Object.entries(grouped)) {\n        const catName = cat.replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n        fragment.appendChild(createElement('div', { className: 'category-header' }, catName));\n\n        prods.forEach(p => {\n            const currentRate = rates[p._id] || 0;\n            const productItem = createElement('div', {\n                className: 'product-item card-animated card-fade-in',\n                style: { animationDelay: `${itemIdx * 0.03}s` }\n            }, [\n                createElement('div', { className: 'product-info' }, [\n                    createElement('div', { className: 'product-name' }, p.name),\n                    createElement('div', { className: 'product-unit' }, `per ${p.unit}`)\n                ]),\n                createElement('input', {\n                    type: 'number',\n                    className: 'rate-input input-animated',\n                    id: `rate-${p._id}`,\n                    dataset: { id: p._id, original: String(currentRate) },\n                    value: String(currentRate),\n                    min: '0',\n                    step: '0.01',\n                    onfocus: (e) => window.clearZero(e.target),\n                    onblur: (e) => window.restoreValue(e.target),\n                    onchange: (e) => window.handleChange(e.target),\n                    oninput: (e) => window.handleInput(e.target),\n                    onkeydown: (e) => {\n                        if (['e', 'E', '+', '-'].includes(e.key)) {\n                            e.preventDefault();\n                        }\n                    }\n                })\n            ]);\n            fragment.appendChild(productItem);\n            itemIdx++;\n        });\n    }\n\n    container.appendChild(fragment);\n}\n\nfunction clearZero(input) {\n    input.dataset.prevValue = input.value;\n    input.value = '';\n    input.select();\n}\n\nfunction restoreValue(input) {\n    if (input.value === '') {\n        input.value = input.dataset.prevValue || input.dataset.original;\n    }\n    handleChange(input);\n}\n\nfunction handleInput(input) {\n    const original = parseFloat(input.dataset.original);\n    const current = parseFloat(input.value);\n    input.classList.toggle('changed', current !== original);\n}\n\nfunction handleChange(input) {\n    const id = input.dataset.id;\n    const original = parseFloat(input.dataset.original);\n    const current = parseFloat(input.value);\n\n    if (current !== original && current > 0) {\n        changedRates[id] = current;\n        input.classList.add('changed');\n    } else {\n        delete changedRates[id];\n        input.classList.remove('changed');\n    }\n\n    // Large rate warning\n    if (current > 1000) {\n        input.style.borderColor = 'var(--warning)';\n    } else {\n        input.style.borderColor = '';\n    }\n\n    updateSaveButton();\n}\n\nfunction updateSaveButton() {\n    const count = Object.keys(changedRates).length;\n    document.getElementById('changesCount').textContent = count;\n    document.getElementById('saveBtn').disabled = count === 0;\n}\n\nasync function saveRates() {\n    const btn = document.getElementById('saveBtn');\n\n    // Client-side validation: Check for negative or invalid rates\n    const invalidRates = [];\n    for (const [productId, rate] of Object.entries(changedRates)) {\n        if (isNaN(rate) || rate < 0) {\n            const product = products.find(p => p._id === productId);\n            invalidRates.push(product?.name || productId);\n        }\n    }\n\n    if (invalidRates.length > 0) {\n        showToast(`${invalidRates.slice(0, 2).join(', ')}: rates must be 0 or higher`, 'info');\n        return;\n    }\n\n    btn.disabled = true;\n    btn.classList.add('btn-loading');\n\n    let success = 0, failed = 0;\n    let firstError = null;\n    const failedProducts = [];\n\n    const headers = { 'Content-Type': 'application/json' };\n    let csrfToken = await Auth.ensureCsrfToken();\n    if (csrfToken) {\n        headers['X-CSRF-Token'] = csrfToken;\n    }\n\n    // Batch entries into groups of 5 for parallel saves\n    const entries = Object.entries(changedRates);\n    const batchSize = 5;\n\n    for (let i = 0; i < entries.length; i += batchSize) {\n        const batch = entries.slice(i, i + batchSize);\n\n        const results = await Promise.all(batch.map(async ([productId, rate]) => {\n            try {\n                let res = await fetch('/api/market-rates', {\n                    method: 'POST',\n                    headers,\n                    credentials: 'include',\n                    body: JSON.stringify({\n                        product: productId,\n                        rate: rate\n                    })\n                });\n\n                // Handle CSRF error with retry\n                if (res.status === 403) {\n                    const err = await res.json().catch(() => ({}));\n                    if (err.message?.toLowerCase().includes('csrf')) {\n                        csrfToken = await Auth.refreshCsrfToken();\n                        if (csrfToken) {\n                            headers['X-CSRF-Token'] = csrfToken;\n                            res = await fetch('/api/market-rates', {\n                                method: 'POST',\n                                headers,\n                                credentials: 'include',\n                                body: JSON.stringify({\n                                    product: productId,\n                                    rate: rate\n                                })\n                            });\n                        }\n                    }\n                }\n\n                if (res.ok) {\n                    // Update the original value\n                    const input = document.getElementById('rate-' + productId);\n                    if (input) {\n                        input.dataset.original = rate;\n                        input.classList.remove('changed');\n                    }\n                    rates[productId] = rate;\n                    return { success: true, productId };\n                } else {\n                    const errData = await res.json().catch(() => ({}));\n                    const errorMsg = errData.message || `HTTP ${res.status}`;\n                    console.error('Failed to save rate for product:', productId, errorMsg);\n                    return { success: false, productId, error: errorMsg };\n                }\n            } catch (e) {\n                console.error('Failed to save rate for product:', productId, e.message);\n                return { success: false, productId, error: e.message || 'Network error' };\n            }\n        }));\n\n        results.forEach(result => {\n            if (result.success) {\n                success++;\n            } else {\n                failed++;\n                if (!firstError) firstError = result.error;\n                failedProducts.push(result.productId);\n            }\n        });\n    }\n\n    // Keep only failed rates for retry (clear successfully saved ones)\n    const remainingRates = {};\n    Object.keys(changedRates).forEach(pid => {\n        if (failedProducts.includes(pid)) {\n            remainingRates[pid] = changedRates[pid];\n        }\n    });\n    changedRates = remainingRates;\n    updateSaveButton();\n\n    btn.classList.remove('btn-loading');\n\n    if (success > 0) {\n        btn.classList.add('btn-success');\n        setTimeout(() => btn.classList.remove('btn-success'), 1500);\n        showToast(`${success} rate(s) saved`, 'success');\n    }\n    if (failed > 0) {\n        showToast(`${failed} rate(s) not saved`, 'info');\n    }\n}\n\n// History functions\nasync function loadHistory() {\n    const container = document.getElementById('historyContent');\n    const categorySelect = document.getElementById('historyCategory');\n    const selectedCategory = categorySelect.value;\n\n    container.innerHTML = '';\n    container.appendChild(createElement('div', { className: 'history-loading' }, 'Loading history...'));\n\n    try {\n        const url = `/api/market-rates/history-summary?days=7${selectedCategory !== 'all' ? `&category=${encodeURIComponent(selectedCategory)}` : ''}`;\n        const res = await fetch(url, { credentials: 'include' });\n\n        if (!res.ok) {\n            throw new Error('History temporarily unavailable');\n        }\n\n        const data = await res.json();\n        historyData = data;\n\n        // Populate category dropdown (only on first load)\n        if (categorySelect.options.length <= 1 && data.categories) {\n            data.categories.forEach(cat => {\n                const displayName = cat.replace(/-/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n                categorySelect.appendChild(createElement('option', { value: cat }, displayName));\n            });\n        }\n\n        renderHistory(data);\n    } catch (e) {\n        console.error('Failed to load history:', e);\n        container.innerHTML = '';\n        container.appendChild(createElement('div', { className: 'history-loading' }, 'History not available'));\n    }\n}\n\nfunction renderHistory(data) {\n    const container = document.getElementById('historyContent');\n    container.innerHTML = '';\n\n    if (!data.data || data.data.length === 0 || !data.data[0]?.rates?.length) {\n        container.appendChild(createElement('div', { className: 'history-loading' }, 'No history data available'));\n        return;\n    }\n\n    // Build date headers\n    const dates = data.data[0].rates.map(r => r.date);\n    const dateHeaders = dates.map(dateStr => {\n        const date = new Date(dateStr);\n        const day = date.toLocaleDateString('en-IN', { weekday: 'short' });\n        const formatted = date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });\n        return createElement('th', { className: 'date-header' }, [\n            formatted,\n            createElement('span', { className: 'date-day' }, day)\n        ]);\n    });\n\n    const headerRow = createElement('tr', {}, [\n        createElement('th', {}, 'Product'),\n        ...dateHeaders\n    ]);\n\n    const infoCell = (product) => createElement('td', {}, [\n        product.name,\n        createElement('br'),\n        createElement('small', { style: { color: 'var(--text-muted)', fontWeight: '400' } }, `per ${product.unit}`)\n    ]);\n\n    const tableBody = createElement('tbody');\n    data.data.forEach(product => {\n        const row = createElement('tr');\n        row.appendChild(infoCell(product));\n\n        product.rates.forEach(r => {\n            if (r.rate === null) {\n                row.appendChild(createElement('td', { className: 'rate-cell rate-null' }, '-'));\n            } else {\n                const trendClass = r.trend || 'stable';\n                const trendIcon = r.trend === 'up' ? '↑' : (r.trend === 'down' ? '↓' : '');\n                const cellContent = [r.rate.toFixed(2)];\n                if (trendIcon) {\n                    cellContent.push(createElement('span', { className: 'trend-indicator' }, trendIcon));\n                }\n                row.appendChild(createElement('td', { className: `rate-cell ${trendClass}` }, cellContent));\n            }\n        });\n        tableBody.appendChild(row);\n    });\n\n    const table = createElement('table', { className: 'history-table' }, [\n        createElement('thead', {}, [headerRow]),\n        tableBody\n    ]);\n\n    container.appendChild(table);\n}\n\nfunction exportToPDF() {\n    if (!window.jspdf) {\n        showToast('PDF export not available (library not loaded)', 'info');\n        return;\n    }\n\n    if (!historyData || !historyData.data || historyData.data.length === 0 || !historyData.data[0]?.rates?.length) {\n        showToast('No data available to export', 'info');\n        return;\n    }\n\n    try {\n        const { jsPDF } = window.jspdf;\n        const doc = new jsPDF({\n            orientation: 'landscape',\n            unit: 'mm',\n            format: 'a4'\n        });\n\n        // Title\n        doc.setFontSize(18);\n        doc.setTextColor(46, 53, 50);\n        doc.text('Pratibha Marketing - 7-Day Market Rate History', 14, 20);\n\n        // Subtitle with date range\n        doc.setFontSize(10);\n        doc.setTextColor(138, 145, 140);\n        const categorySelect = document.getElementById('historyCategory');\n        const selectedCategory = categorySelect.value === 'all' ? 'All Categories' : categorySelect.options[categorySelect.selectedIndex].text;\n        doc.text(`${historyData.startDate} to ${historyData.endDate} | ${selectedCategory}`, 14, 27);\n\n        // Prepare table data\n        const dates = historyData.data[0].rates.map(r => {\n            const date = new Date(r.date);\n            return date.toLocaleDateString('en-IN', { day: 'numeric', month: 'short' });\n        });\n\n        const tableHead = [['Product', 'Unit', ...dates]];\n        const tableBody = historyData.data.map(product => {\n            const rates = product.rates.map(r => r.rate !== null ? r.rate.toFixed(2) : '-');\n            return [product.name, product.unit, ...rates];\n        });\n\n        // Generate table\n        doc.autoTable({\n            startY: 32,\n            head: tableHead,\n            body: tableBody,\n            theme: 'grid',\n            headStyles: {\n                fillColor: [46, 53, 50],\n                textColor: [255, 255, 255],\n                fontSize: 8,\n                fontStyle: 'bold'\n            },\n            bodyStyles: {\n                fontSize: 8,\n                textColor: [31, 36, 33]\n            },\n            columnStyles: {\n                0: { fontStyle: 'bold', cellWidth: 40 },\n                1: { cellWidth: 20 }\n            },\n            alternateRowStyles: {\n                fillColor: [249, 247, 243]\n            },\n            margin: { left: 14, right: 14 }\n        });\n\n        // Footer\n        const pageCount = doc.internal.getNumberOfPages();\n        for (let i = 1; i <= pageCount; i++) {\n            doc.setPage(i);\n            doc.setFontSize(8);\n            doc.setTextColor(138, 145, 140);\n            doc.text(`Generated on ${new Date().toLocaleString('en-IN')} | Page ${i} of ${pageCount}`, 14, doc.internal.pageSize.height - 10);\n        }\n\n        // Save the PDF\n        const filename = `market-rates-${historyData.startDate}-to-${historyData.endDate}.pdf`;\n        doc.save(filename);\n\n        showToast('PDF exported successfully', 'success');\n    } catch (e) {\n        console.error('PDF export failed:', e);\n        showToast('Could not export PDF', 'info');\n    }\n}\n\n// Expose functions to window for inline handlers\nwindow.clearZero = clearZero;\nwindow.restoreValue = restoreValue;\nwindow.handleChange = handleChange;\nwindow.handleInput = handleInput;\nwindow.saveRates = saveRates;\nwindow.loadHistory = loadHistory;\nwindow.exportToPDF = exportToPDF;\n\ninit();\n"],"names":["waitForAuth","maxWait","resolve","reject","startTime","check","Auth","products","rates","changedRates","historyData","init","loadData","loadHistory","productsRes","ratesRes","productsData","ratesData","p","rate","pid","renderProducts","container","errorMsg","createElement","grouped","cat","fragment","itemIdx","prods","catName","l","currentRate","productItem","e","clearZero","input","restoreValue","handleChange","handleInput","original","current","id","updateSaveButton","count","saveRates","btn","invalidRates","productId","product","showToast","success","failed","firstError","failedProducts","headers","csrfToken","entries","batchSize","i","batch","res","result","remainingRates","categorySelect","selectedCategory","url","data","displayName","renderHistory","dateHeaders","r","dateStr","date","day","formatted","headerRow","infoCell","tableBody","row","trendClass","trendIcon","cellContent","table","exportToPDF","jsPDF","doc","tableHead","pageCount","filename"],"mappings":"6LAIA,MAAMA,EAAc,CAACC,EAAU,MAAU,IAAI,QAAQ,CAACC,EAASC,IAAW,CACtE,MAAMC,EAAY,KAAK,IAAG,EACpBC,EAAQ,IAAM,CAChB,GAAI,OAAO,KAAM,OAAOH,EAAQ,OAAO,IAAI,EAC3C,GAAI,KAAK,IAAG,EAAKE,EAAYH,EAAS,OAAOE,EAAO,IAAI,MAAM,oBAAoB,CAAC,EACnF,WAAWE,EAAO,EAAE,CACxB,EACAA,EAAK,CACT,CAAC,EACKC,EAAO,MAAMN,EAAW,EAE9B,IAAIO,EAAW,CAAA,EACf,MAAMC,EAAQ,CAAA,EACd,IAAIC,EAAe,CAAA,EACfC,EAAc,KAElB,eAAeC,GAAO,CACL,MAAML,EAAK,YAAY,CAAC,QAAS,OAAO,CAAC,IAGtD,SAAS,eAAe,SAAS,EAAE,YAAc,IAAI,KAAI,EAAG,mBAAmB,QAAS,CACpF,QAAS,OAAQ,KAAM,UAAW,MAAO,OAAQ,IAAK,SAC9D,CAAK,EAED,MAAMM,EAAQ,EACd,MAAMC,EAAW,EACrB,CAEA,eAAeD,GAAW,CACtB,GAAI,CACA,KAAM,CAACE,EAAaC,CAAQ,EAAI,MAAM,QAAQ,IAAI,CAC9C,MAAM,gBAAiB,CAAE,YAAa,SAAS,CAAE,EACjD,MAAM,oBAAqB,CAAE,YAAa,SAAS,CAAE,CACjE,CAAS,EAED,GAAI,CAACD,EAAY,GACb,MAAM,IAAI,MAAM,6BAA6BA,EAAY,MAAM,EAAE,EAErE,GAAI,CAACC,EAAS,GACV,MAAM,IAAI,MAAM,iCAAiCA,EAAS,MAAM,EAAE,EAGtE,MAAMC,EAAe,MAAMF,EAAY,KAAI,EACrCG,EAAY,MAAMF,EAAS,KAAI,EAErCR,GAAYS,EAAa,MAAQ,CAAA,GAAI,OAAOE,GAAKA,EAAE,QAAQ,GAG1DD,EAAU,MAAQ,IAAI,QAAQE,GAAQ,CACnC,MAAMC,EAAM,OAAOD,EAAK,SAAY,SAAWA,EAAK,QAAQ,IAAMA,EAAK,QACvEX,EAAMY,CAAG,EAAID,EAAK,IACtB,CAAC,EAEDE,EAAc,CAClB,OAAS,EAAG,CACR,QAAQ,MAAM,CAAC,EACf,MAAMC,EAAY,SAAS,eAAe,aAAa,EACjDC,EAAY,UAAU,OAAoC,qBAA3B,yBACrCD,EAAU,UAAY,GACtBA,EAAU,YAAYE,EAAc,MAAO,CAAE,UAAW,WAAa,CACjEA,EAAc,IAAK,CAAA,EAAID,CAAQ,EAC/BC,EAAc,SAAU,CACpB,GAAI,eACJ,MAAO,CAAE,UAAW,OAAQ,QAAS,cAAe,WAAY,qBAAsB,MAAO,QAAS,OAAQ,OAAQ,aAAc,MAAO,OAAQ,SAAS,EAC5J,QAASZ,CACzB,EAAe,WAAW,CAC1B,CAAS,CAAC,CACN,CACJ,CAEA,SAASS,GAAiB,CACtB,MAAMC,EAAY,SAAS,eAAe,aAAa,EAGvD,GAFAA,EAAU,UAAY,GAElB,CAACf,EAAS,OAAQ,CAClBe,EAAU,YAAYE,EAAc,MAAO,CAAE,UAAW,SAAS,EAAI,mBAAmB,CAAC,EACzF,MACJ,CAGA,MAAMC,EAAU,CAAA,EAChBlB,EAAS,QAAQW,GAAK,CAClB,MAAMQ,EAAMR,EAAE,UAAY,QACrBO,EAAQC,CAAG,IAAGD,EAAQC,CAAG,EAAI,CAAA,GAClCD,EAAQC,CAAG,EAAE,KAAKR,CAAC,CACvB,CAAC,EAED,MAAMS,EAAW,SAAS,uBAAsB,EAChD,IAAIC,EAAU,EAEd,SAAW,CAACF,EAAKG,CAAK,IAAK,OAAO,QAAQJ,CAAO,EAAG,CAChD,MAAMK,EAAUJ,EAAI,QAAQ,KAAM,GAAG,EAAE,QAAQ,QAASK,GAAKA,EAAE,YAAW,CAAE,EAC5EJ,EAAS,YAAYH,EAAc,MAAO,CAAE,UAAW,iBAAiB,EAAIM,CAAO,CAAC,EAEpFD,EAAM,QAAQX,GAAK,CACf,MAAMc,EAAcxB,EAAMU,EAAE,GAAG,GAAK,EAC9Be,EAAcT,EAAc,MAAO,CACrC,UAAW,0CACX,MAAO,CAAE,eAAgB,GAAGI,EAAU,GAAI,GAAG,CAC7D,EAAe,CACCJ,EAAc,MAAO,CAAE,UAAW,cAAc,EAAI,CAChDA,EAAc,MAAO,CAAE,UAAW,cAAc,EAAIN,EAAE,IAAI,EAC1DM,EAAc,MAAO,CAAE,UAAW,cAAc,EAAI,OAAON,EAAE,IAAI,EAAE,CACvF,CAAiB,EACDM,EAAc,QAAS,CACnB,KAAM,SACN,UAAW,4BACX,GAAI,QAAQN,EAAE,GAAG,GACjB,QAAS,CAAE,GAAIA,EAAE,IAAK,SAAU,OAAOc,CAAW,CAAC,EACnD,MAAO,OAAOA,CAAW,EACzB,IAAK,IACL,KAAM,OACN,QAAUE,GAAM,OAAO,UAAUA,EAAE,MAAM,EACzC,OAASA,GAAM,OAAO,aAAaA,EAAE,MAAM,EAC3C,SAAWA,GAAM,OAAO,aAAaA,EAAE,MAAM,EAC7C,QAAUA,GAAM,OAAO,YAAYA,EAAE,MAAM,EAC3C,UAAYA,GAAM,CACV,CAAC,IAAK,IAAK,IAAK,GAAG,EAAE,SAASA,EAAE,GAAG,GACnCA,EAAE,eAAc,CAExB,CACpB,CAAiB,CACjB,CAAa,EACDP,EAAS,YAAYM,CAAW,EAChCL,GACJ,CAAC,CACL,CAEAN,EAAU,YAAYK,CAAQ,CAClC,CAEA,SAASQ,EAAUC,EAAO,CACtBA,EAAM,QAAQ,UAAYA,EAAM,MAChCA,EAAM,MAAQ,GACdA,EAAM,OAAM,CAChB,CAEA,SAASC,EAAaD,EAAO,CACrBA,EAAM,QAAU,KAChBA,EAAM,MAAQA,EAAM,QAAQ,WAAaA,EAAM,QAAQ,UAE3DE,EAAaF,CAAK,CACtB,CAEA,SAASG,EAAYH,EAAO,CACxB,MAAMI,EAAW,WAAWJ,EAAM,QAAQ,QAAQ,EAC5CK,EAAU,WAAWL,EAAM,KAAK,EACtCA,EAAM,UAAU,OAAO,UAAWK,IAAYD,CAAQ,CAC1D,CAEA,SAASF,EAAaF,EAAO,CACzB,MAAMM,EAAKN,EAAM,QAAQ,GACnBI,EAAW,WAAWJ,EAAM,QAAQ,QAAQ,EAC5CK,EAAU,WAAWL,EAAM,KAAK,EAElCK,IAAYD,GAAYC,EAAU,GAClChC,EAAaiC,CAAE,EAAID,EACnBL,EAAM,UAAU,IAAI,SAAS,IAE7B,OAAO3B,EAAaiC,CAAE,EACtBN,EAAM,UAAU,OAAO,SAAS,GAIhCK,EAAU,IACVL,EAAM,MAAM,YAAc,iBAE1BA,EAAM,MAAM,YAAc,GAG9BO,EAAgB,CACpB,CAEA,SAASA,GAAmB,CACxB,MAAMC,EAAQ,OAAO,KAAKnC,CAAY,EAAE,OACxC,SAAS,eAAe,cAAc,EAAE,YAAcmC,EACtD,SAAS,eAAe,SAAS,EAAE,SAAWA,IAAU,CAC5D,CAEA,eAAeC,GAAY,CACvB,MAAMC,EAAM,SAAS,eAAe,SAAS,EAGvCC,EAAe,CAAA,EACrB,SAAW,CAACC,EAAW7B,CAAI,IAAK,OAAO,QAAQV,CAAY,EACvD,GAAI,MAAMU,CAAI,GAAKA,EAAO,EAAG,CACzB,MAAM8B,EAAU1C,EAAS,KAAKW,GAAKA,EAAE,MAAQ8B,CAAS,EACtDD,EAAa,KAAKE,GAAS,MAAQD,CAAS,CAChD,CAGJ,GAAID,EAAa,OAAS,EAAG,CACzBG,EAAU,GAAGH,EAAa,MAAM,EAAG,CAAC,EAAE,KAAK,IAAI,CAAC,8BAA+B,MAAM,EACrF,MACJ,CAEAD,EAAI,SAAW,GACfA,EAAI,UAAU,IAAI,aAAa,EAE/B,IAAIK,EAAU,EAAGC,EAAS,EACtBC,EAAa,KACjB,MAAMC,EAAiB,CAAA,EAEjBC,EAAU,CAAE,eAAgB,kBAAkB,EACpD,IAAIC,EAAY,MAAMlD,EAAK,gBAAe,EACtCkD,IACAD,EAAQ,cAAc,EAAIC,GAI9B,MAAMC,EAAU,OAAO,QAAQhD,CAAY,EACrCiD,EAAY,EAElB,QAASC,EAAI,EAAGA,EAAIF,EAAQ,OAAQE,GAAKD,EAAW,CAChD,MAAME,EAAQH,EAAQ,MAAME,EAAGA,EAAID,CAAS,GAE5B,MAAM,QAAQ,IAAIE,EAAM,IAAI,MAAO,CAACZ,EAAW7B,CAAI,IAAM,CACrE,GAAI,CACA,IAAI0C,EAAM,MAAM,MAAM,oBAAqB,CACvC,OAAQ,OACR,QAAAN,EACA,YAAa,UACb,KAAM,KAAK,UAAU,CACjB,QAASP,EACT,KAAM7B,CAC9B,CAAqB,CACrB,CAAiB,EAsBD,GAnBI0C,EAAI,SAAW,MACH,MAAMA,EAAI,KAAI,EAAG,MAAM,KAAO,CAAA,EAAG,GACrC,SAAS,YAAW,EAAG,SAAS,MAAM,IAC1CL,EAAY,MAAMlD,EAAK,iBAAgB,EACnCkD,IACAD,EAAQ,cAAc,EAAIC,EAC1BK,EAAM,MAAM,MAAM,oBAAqB,CACnC,OAAQ,OACR,QAAAN,EACA,YAAa,UACb,KAAM,KAAK,UAAU,CACjB,QAASP,EACT,KAAM7B,CAC1C,CAAiC,CACjC,CAA6B,IAKT0C,EAAI,GAAI,CAER,MAAMzB,EAAQ,SAAS,eAAe,QAAUY,CAAS,EACzD,OAAIZ,IACAA,EAAM,QAAQ,SAAWjB,EACzBiB,EAAM,UAAU,OAAO,SAAS,GAEpC5B,EAAMwC,CAAS,EAAI7B,EACZ,CAAE,QAAS,GAAM,UAAA6B,CAAS,CACrC,KAAO,CAEH,MAAMzB,GADU,MAAMsC,EAAI,KAAI,EAAG,MAAM,KAAO,CAAA,EAAG,GACxB,SAAW,QAAQA,EAAI,MAAM,GACtD,eAAQ,MAAM,mCAAoCb,EAAWzB,CAAQ,EAC9D,CAAE,QAAS,GAAO,UAAAyB,EAAW,MAAOzB,CAAQ,CACvD,CACJ,OAASW,EAAG,CACR,eAAQ,MAAM,mCAAoCc,EAAWd,EAAE,OAAO,EAC/D,CAAE,QAAS,GAAO,UAAAc,EAAW,MAAOd,EAAE,SAAW,eAAe,CAC3E,CACJ,CAAC,CAAC,GAEM,QAAQ4B,GAAU,CAClBA,EAAO,QACPX,KAEAC,IACKC,IAAYA,EAAaS,EAAO,OACrCR,EAAe,KAAKQ,EAAO,SAAS,EAE5C,CAAC,CACL,CAGA,MAAMC,EAAiB,CAAA,EACvB,OAAO,KAAKtD,CAAY,EAAE,QAAQW,GAAO,CACjCkC,EAAe,SAASlC,CAAG,IAC3B2C,EAAe3C,CAAG,EAAIX,EAAaW,CAAG,EAE9C,CAAC,EACDX,EAAesD,EACfpB,EAAgB,EAEhBG,EAAI,UAAU,OAAO,aAAa,EAE9BK,EAAU,IACVL,EAAI,UAAU,IAAI,aAAa,EAC/B,WAAW,IAAMA,EAAI,UAAU,OAAO,aAAa,EAAG,IAAI,EAC1DI,EAAU,GAAGC,CAAO,iBAAkB,SAAS,GAE/CC,EAAS,GACTF,EAAU,GAAGE,CAAM,qBAAsB,MAAM,CAEvD,CAGA,eAAevC,GAAc,CACzB,MAAMS,EAAY,SAAS,eAAe,gBAAgB,EACpD0C,EAAiB,SAAS,eAAe,iBAAiB,EAC1DC,EAAmBD,EAAe,MAExC1C,EAAU,UAAY,GACtBA,EAAU,YAAYE,EAAc,MAAO,CAAE,UAAW,iBAAiB,EAAI,oBAAoB,CAAC,EAElG,GAAI,CACA,MAAM0C,EAAM,2CAA2CD,IAAqB,MAAQ,aAAa,mBAAmBA,CAAgB,CAAC,GAAK,EAAE,GACtIJ,EAAM,MAAM,MAAMK,EAAK,CAAE,YAAa,UAAW,EAEvD,GAAI,CAACL,EAAI,GACL,MAAM,IAAI,MAAM,iCAAiC,EAGrD,MAAMM,EAAO,MAAMN,EAAI,KAAI,EAC3BnD,EAAcyD,EAGVH,EAAe,QAAQ,QAAU,GAAKG,EAAK,YAC3CA,EAAK,WAAW,QAAQzC,GAAO,CAC3B,MAAM0C,EAAc1C,EAAI,QAAQ,KAAM,GAAG,EAAE,QAAQ,QAASK,GAAKA,EAAE,YAAW,CAAE,EAChFiC,EAAe,YAAYxC,EAAc,SAAU,CAAE,MAAOE,CAAG,EAAI0C,CAAW,CAAC,CACnF,CAAC,EAGLC,EAAcF,CAAI,CACtB,OAASjC,EAAG,CACR,QAAQ,MAAM,0BAA2BA,CAAC,EAC1CZ,EAAU,UAAY,GACtBA,EAAU,YAAYE,EAAc,MAAO,CAAE,UAAW,iBAAiB,EAAI,uBAAuB,CAAC,CACzG,CACJ,CAEA,SAAS6C,EAAcF,EAAM,CACzB,MAAM7C,EAAY,SAAS,eAAe,gBAAgB,EAG1D,GAFAA,EAAU,UAAY,GAElB,CAAC6C,EAAK,MAAQA,EAAK,KAAK,SAAW,GAAK,CAACA,EAAK,KAAK,CAAC,GAAG,OAAO,OAAQ,CACtE7C,EAAU,YAAYE,EAAc,MAAO,CAAE,UAAW,iBAAiB,EAAI,2BAA2B,CAAC,EACzG,MACJ,CAIA,MAAM8C,EADQH,EAAK,KAAK,CAAC,EAAE,MAAM,IAAII,GAAKA,EAAE,IAAI,EACtB,IAAIC,GAAW,CACrC,MAAMC,EAAO,IAAI,KAAKD,CAAO,EACvBE,EAAMD,EAAK,mBAAmB,QAAS,CAAE,QAAS,QAAS,EAC3DE,EAAYF,EAAK,mBAAmB,QAAS,CAAE,IAAK,UAAW,MAAO,QAAS,EACrF,OAAOjD,EAAc,KAAM,CAAE,UAAW,aAAa,EAAI,CACrDmD,EACAnD,EAAc,OAAQ,CAAE,UAAW,UAAU,EAAIkD,CAAG,CAChE,CAAS,CACL,CAAC,EAEKE,EAAYpD,EAAc,KAAM,GAAI,CACtCA,EAAc,KAAM,CAAA,EAAI,SAAS,EACjC,GAAG8C,CACX,CAAK,EAEKO,EAAY5B,GAAYzB,EAAc,KAAM,CAAA,EAAI,CAClDyB,EAAQ,KACRzB,EAAc,IAAI,EAClBA,EAAc,QAAS,CAAE,MAAO,CAAE,MAAO,oBAAqB,WAAY,KAAK,CAAE,EAAI,OAAOyB,EAAQ,IAAI,EAAE,CAClH,CAAK,EAEK6B,EAAYtD,EAAc,OAAO,EACvC2C,EAAK,KAAK,QAAQlB,GAAW,CACzB,MAAM8B,EAAMvD,EAAc,IAAI,EAC9BuD,EAAI,YAAYF,EAAS5B,CAAO,CAAC,EAEjCA,EAAQ,MAAM,QAAQsB,GAAK,CACvB,GAAIA,EAAE,OAAS,KACXQ,EAAI,YAAYvD,EAAc,KAAM,CAAE,UAAW,qBAAqB,EAAI,GAAG,CAAC,MAC3E,CACH,MAAMwD,EAAaT,EAAE,OAAS,SACxBU,EAAYV,EAAE,QAAU,KAAO,IAAOA,EAAE,QAAU,OAAS,IAAM,GACjEW,EAAc,CAACX,EAAE,KAAK,QAAQ,CAAC,CAAC,EAClCU,GACAC,EAAY,KAAK1D,EAAc,OAAQ,CAAE,UAAW,iBAAiB,EAAIyD,CAAS,CAAC,EAEvFF,EAAI,YAAYvD,EAAc,KAAM,CAAE,UAAW,aAAawD,CAAU,EAAE,EAAIE,CAAW,CAAC,CAC9F,CACJ,CAAC,EACDJ,EAAU,YAAYC,CAAG,CAC7B,CAAC,EAED,MAAMI,EAAQ3D,EAAc,QAAS,CAAE,UAAW,eAAe,EAAI,CACjEA,EAAc,QAAS,GAAI,CAACoD,CAAS,CAAC,EACtCE,CACR,CAAK,EAEDxD,EAAU,YAAY6D,CAAK,CAC/B,CAEA,SAASC,GAAc,CACnB,GAAI,CAAC,OAAO,MAAO,CACflC,EAAU,gDAAiD,MAAM,EACjE,MACJ,CAEA,GAAI,CAACxC,GAAe,CAACA,EAAY,MAAQA,EAAY,KAAK,SAAW,GAAK,CAACA,EAAY,KAAK,CAAC,GAAG,OAAO,OAAQ,CAC3GwC,EAAU,8BAA+B,MAAM,EAC/C,MACJ,CAEA,GAAI,CACA,KAAM,CAAE,MAAAmC,GAAU,OAAO,MACnBC,EAAM,IAAID,EAAM,CAClB,YAAa,YACb,KAAM,KACN,OAAQ,IACpB,CAAS,EAGDC,EAAI,YAAY,EAAE,EAClBA,EAAI,aAAa,GAAI,GAAI,EAAE,EAC3BA,EAAI,KAAK,iDAAkD,GAAI,EAAE,EAGjEA,EAAI,YAAY,EAAE,EAClBA,EAAI,aAAa,IAAK,IAAK,GAAG,EAC9B,MAAMtB,EAAiB,SAAS,eAAe,iBAAiB,EAC1DC,EAAmBD,EAAe,QAAU,MAAQ,iBAAmBA,EAAe,QAAQA,EAAe,aAAa,EAAE,KAClIsB,EAAI,KAAK,GAAG5E,EAAY,SAAS,OAAOA,EAAY,OAAO,MAAMuD,CAAgB,GAAI,GAAI,EAAE,EAQ3F,MAAMsB,EAAY,CAAC,CAAC,UAAW,OAAQ,GALzB7E,EAAY,KAAK,CAAC,EAAE,MAAM,IAAI6D,GAC3B,IAAI,KAAKA,EAAE,IAAI,EAChB,mBAAmB,QAAS,CAAE,IAAK,UAAW,MAAO,QAAS,CAC7E,CAE8C,CAAC,EAC1CO,EAAYpE,EAAY,KAAK,IAAIuC,GAAW,CAC9C,MAAMzC,EAAQyC,EAAQ,MAAM,IAAIsB,GAAKA,EAAE,OAAS,KAAOA,EAAE,KAAK,QAAQ,CAAC,EAAI,GAAG,EAC9E,MAAO,CAACtB,EAAQ,KAAMA,EAAQ,KAAM,GAAGzC,CAAK,CAChD,CAAC,EAGD8E,EAAI,UAAU,CACV,OAAQ,GACR,KAAMC,EACN,KAAMT,EACN,MAAO,OACP,WAAY,CACR,UAAW,CAAC,GAAI,GAAI,EAAE,EACtB,UAAW,CAAC,IAAK,IAAK,GAAG,EACzB,SAAU,EACV,UAAW,MAC3B,EACY,WAAY,CACR,SAAU,EACV,UAAW,CAAC,GAAI,GAAI,EAAE,CACtC,EACY,aAAc,CACV,EAAG,CAAE,UAAW,OAAQ,UAAW,EAAE,EACrC,EAAG,CAAE,UAAW,EAAE,CAClC,EACY,mBAAoB,CAChB,UAAW,CAAC,IAAK,IAAK,GAAG,CACzC,EACY,OAAQ,CAAE,KAAM,GAAI,MAAO,EAAE,CACzC,CAAS,EAGD,MAAMU,EAAYF,EAAI,SAAS,iBAAgB,EAC/C,QAAS,EAAI,EAAG,GAAKE,EAAW,IAC5BF,EAAI,QAAQ,CAAC,EACbA,EAAI,YAAY,CAAC,EACjBA,EAAI,aAAa,IAAK,IAAK,GAAG,EAC9BA,EAAI,KAAK,gBAAgB,IAAI,KAAI,EAAG,eAAe,OAAO,CAAC,WAAW,CAAC,OAAOE,CAAS,GAAI,GAAIF,EAAI,SAAS,SAAS,OAAS,EAAE,EAIpI,MAAMG,EAAW,gBAAgB/E,EAAY,SAAS,OAAOA,EAAY,OAAO,OAChF4E,EAAI,KAAKG,CAAQ,EAEjBvC,EAAU,4BAA6B,SAAS,CACpD,OAAS,EAAG,CACR,QAAQ,MAAM,qBAAsB,CAAC,EACrCA,EAAU,uBAAwB,MAAM,CAC5C,CACJ,CAGA,OAAO,UAAYf,EACnB,OAAO,aAAeE,EACtB,OAAO,aAAeC,EACtB,OAAO,YAAcC,EACrB,OAAO,UAAYM,EACnB,OAAO,YAAchC,EACrB,OAAO,YAAcuE,EAErBzE,EAAI"}