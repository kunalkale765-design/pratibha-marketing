{"version":3,"file":"login-DmEKPDPS.js","sources":["../../src/js/pages/login.js"],"sourcesContent":["import { togglePassword } from '/js/ui.js';\nimport { registerServiceWorker } from '/js/init.js';\n\n// Initialize\nregisterServiceWorker();\n\n// Wait for Auth to be available (loaded from auth.js module)\nconst waitForAuth = (maxWait = 10000) => new Promise((resolve, reject) => {\n    const startTime = Date.now();\n    const check = () => {\n        if (window.Auth) return resolve(window.Auth);\n        if (Date.now() - startTime > maxWait) return reject(new Error('Auth not available'));\n        setTimeout(check, 50);\n    };\n    check();\n});\nconst Auth = await waitForAuth();\n\n// Pre-fetch CSRF token to ensure it's ready before form submission\nAuth.ensureCsrfToken().catch(err => console.warn('CSRF pre-fetch failed:', err));\n\n// Elements\nconst loginForm = document.getElementById('loginForm');\nconst loginBtn = document.getElementById('loginBtn');\nconst noticeMessage = document.getElementById('noticeMessage');\nconst passwordToggle = document.getElementById('passwordToggle');\n\n// Password visibility toggle\nif (passwordToggle) {\n    passwordToggle.addEventListener('click', () => {\n        togglePassword('password', passwordToggle);\n    });\n}\n\n// Check if already logged in\ncheckAuth();\n\nasync function checkAuth() {\n    try {\n        const response = await fetch('/api/auth/me', { credentials: 'include' });\n        if (response.ok) {\n            const data = await response.json();\n            if (data.user.role === 'customer') {\n                window.location.href = '/pages/order-form/';\n            } else if (data.user.role === 'staff') {\n                window.location.href = '/pages/staff-dashboard/';\n            } else {\n                window.location.href = '/';\n            }\n        }\n    } catch (_error) {\n        // Not logged in - stay on login page\n    }\n}\n\n// Form submission\nif (loginForm) {\n    loginForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n\n        const email = document.getElementById('email').value.trim();\n        const password = document.getElementById('password').value;\n\n        if (!email || !password) {\n            showNotice('Please enter username and password');\n            return;\n        }\n\n        loginBtn.disabled = true;\n        loginBtn.classList.add('btn-loading');\n        hideNotice();\n\n        try {\n            const headers = { 'Content-Type': 'application/json' };\n            // Ensure CSRF token is available (fetches from server if missing)\n            const csrfToken = await Auth.ensureCsrfToken();\n            if (csrfToken) {\n                headers['X-CSRF-Token'] = csrfToken;\n            }\n\n            const response = await fetch('/api/auth/login', {\n                method: 'POST',\n                headers,\n                credentials: 'include',\n                body: JSON.stringify({ email, password })\n            });\n\n            // Handle rate limiting (429)\n            if (response.status === 429) {\n                showNotice('Too many attempts. Please try again later.');\n                return;\n            }\n\n            const data = await response.json();\n\n            // Handle CSRF error (or missing token) with automatic retry\n            if (response.status === 403 && (data?.message?.toLowerCase().includes('csrf') || !csrfToken)) {\n                console.log('CSRF error, refreshing token and retrying...');\n                const newToken = await Auth.refreshCsrfToken();\n                if (newToken) {\n                    headers['X-CSRF-Token'] = newToken;\n                    const retryResponse = await fetch('/api/auth/login', {\n                        method: 'POST',\n                        headers,\n                        credentials: 'include',\n                        body: JSON.stringify({ email, password })\n                    });\n                    const retryData = await retryResponse.json();\n                    if (retryResponse.ok) {\n                        Auth.setUser(retryData.user);\n                        if (retryData.user.role === 'customer') {\n                            window.location.href = '/pages/order-form/';\n                        } else if (retryData.user.role === 'staff') {\n                            window.location.href = '/pages/staff-dashboard/';\n                        } else {\n                            window.location.href = '/';\n                        }\n                        return;\n                    }\n                    showNotice(retryData.message || 'Please check your credentials');\n                    return;\n                }\n            }\n\n            if (response.ok) {\n                Auth.setUser(data.user);  // Use Auth.setUser to filter sensitive data\n                if (data.user.role === 'customer') {\n                    window.location.href = '/pages/order-form/';\n                } else if (data.user.role === 'staff') {\n                    window.location.href = '/pages/staff-dashboard/';\n                } else {\n                    window.location.href = '/';\n                }\n            } else {\n                showNotice(data.message || 'Please check your credentials');\n            }\n        } catch (error) {\n            console.error('Login error:', error);\n            if (!navigator.onLine) {\n                showNotice('No internet connection');\n            } else if (error.name === 'TypeError' || error.message.includes('fetch')) {\n                showNotice('Connection issue. Please try again.');\n            } else {\n                showNotice('Something went wrong. Try again.');\n            }\n        } finally {\n            if (loginBtn) {\n                loginBtn.disabled = false;\n                loginBtn.classList.remove('btn-loading');\n            }\n        }\n    });\n}\n\nfunction showNotice(message) {\n    if (noticeMessage) {\n        noticeMessage.textContent = message;\n        noticeMessage.classList.add('show');\n    }\n}\n\nfunction hideNotice() {\n    if (noticeMessage) {\n        noticeMessage.classList.remove('show');\n    }\n}\n\n// Forgot password handler\nconst forgotLink = document.getElementById('forgotPasswordLink');\nif (forgotLink) {\n    forgotLink.addEventListener('click', async (e) => {\n        e.preventDefault();\n        const email = document.getElementById('email').value.trim();\n\n        if (!email) {\n            showNotice('Please enter your username first');\n            return;\n        }\n\n        try {\n            const headers = { 'Content-Type': 'application/json' };\n            const csrfToken = await Auth.ensureCsrfToken();\n            if (csrfToken) {\n                headers['X-CSRF-Token'] = csrfToken;\n            }\n\n            const response = await fetch('/api/auth/forgot-password', {\n                method: 'POST',\n                headers,\n                credentials: 'include',\n                body: JSON.stringify({ email })\n            });\n\n            const data = await response.json();\n\n            if (response.ok && data.resetUrl) {\n                // For development: show the reset link\n                // In production with email, this would just show a success message\n                // Use DOM methods to prevent XSS (don't use innerHTML with user data)\n                noticeMessage.textContent = '';\n                noticeMessage.appendChild(document.createTextNode('Reset link generated! '));\n                const link = document.createElement('a');\n                link.href = data.resetUrl;\n                link.style.cssText = 'color: var(--dusty-olive); text-decoration: underline;';\n                link.textContent = 'Click here to reset';\n                noticeMessage.appendChild(link);\n                noticeMessage.classList.add('show');\n                noticeMessage.classList.remove('error');\n            } else {\n                showNotice(data.message || 'If an account exists, a reset link has been generated');\n            }\n        } catch (error) {\n            console.error('Forgot password error:', error);\n            showNotice('Could not process request. Try again.');\n        }\n    });\n}\n"],"names":["registerServiceWorker","waitForAuth","maxWait","resolve","reject","startTime","check","Auth","err","loginForm","loginBtn","noticeMessage","passwordToggle","togglePassword","checkAuth","response","data","email","password","showNotice","hideNotice","headers","csrfToken","newToken","retryResponse","retryData","error","message","forgotLink","link"],"mappings":"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"}