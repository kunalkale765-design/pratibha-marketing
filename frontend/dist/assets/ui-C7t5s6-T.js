let i=null;function c(){const e=document.cookie.match(/csrf_token=([^;]+)/);return e?e[1]:null}async function f(){if(i)return i;i=(async()=>{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3);try{const s=await fetch("/api/csrf-token",{credentials:"include",signal:e.signal});if(s.ok)return(await s.json()).csrfToken||c()}catch(s){s.name!=="AbortError"&&console.error("Failed to refresh CSRF token:",s)}finally{clearTimeout(t)}return null})();try{return await i}finally{i=null}}async function g(){let e=c();return e||(e=await f()),e}const l={USER_KEY:"user",getCsrfToken:c,refreshCsrfToken:f,ensureCsrfToken:g,isLoggedIn(){return!!this.getUser()},getUser(){try{const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Error parsing user data:",e),null}},setUser(e){const t={id:e.id,name:e.name,email:e.email,role:e.role,customer:e.customer?{_id:e.customer._id,name:e.customer.name,pricingType:e.customer.pricingType,...e.customer.allowedProducts?{allowedProducts:e.customer.allowedProducts}:{}}:null,isMagicLink:e.isMagicLink||!1};localStorage.setItem(this.USER_KEY,JSON.stringify(t))},clearAuth(){localStorage.removeItem(this.USER_KEY),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("logout"),"caches"in window&&caches.keys().then(e=>e.forEach(t=>caches.delete(t))).catch(()=>{})},getRole(){const e=this.getUser();return e?e.role:null},isStaff(){const e=this.getRole();return e==="admin"||e==="staff"},isCustomer(){return this.getRole()==="customer"},async verify(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const t=await e.json();return this.setUser(t.user),t.user}else return this.clearAuth(),null}catch(e){return console.error("Auth verification failed:",e),navigator.onLine?(this.clearAuth(),null):(console.warn("Offline - using cached user"),this.getUser())}},async login(e,t,s=!1){try{const o={"Content-Type":"application/json"},r=await this.ensureCsrfToken();r&&(o["X-CSRF-Token"]=r);const n=await fetch("/api/auth/login",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({email:e,password:t})}),a=await n.json();return n.ok?(this.setUser(a.user),{success:!0,user:a.user}):n.status===403&&a?.message?.toLowerCase().includes("csrf")&&!s?(console.log("CSRF token error during login, refreshing and retrying..."),await this.refreshCsrfToken(),this.login(e,t,!0)):{success:!1,error:a.message||"Login failed"}}catch(o){return console.error("Login error:",o),{success:!1,error:"Network error. Please try again."}}},async logout(){try{const e={},t=await this.ensureCsrfToken();t&&(e["X-CSRF-Token"]=t);const s=await fetch("/api/auth/logout",{method:"POST",headers:e,credentials:"include"});s.ok||console.warn("Server-side logout returned error:",s.status)}catch(e){console.error("Logout error:",e),console.warn("Server-side session may still be active due to:",e.message)}finally{this.clearAuth(),window.location.href="/pages/auth/login.html"}},async requireAuth(e=null){const t=await this.verify();return t?e&&!e.includes(t.role)?(t.role==="customer"?window.location.href="/pages/order-form/":t.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/",null):t:(window.location.href="/pages/auth/login.html",null)},async redirectIfLoggedIn(){const e=await this.verify();return e?(e.role==="customer"?window.location.href="/pages/order-form/":e.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/",!0):!1}};if(typeof window<"u"){window.Auth=l;const e=window.fetch;let t=!1;window.fetch=async function(...s){const o=await e.apply(this,s);if(o.status===401&&!t){const r=typeof s[0]=="string"?s[0]:s[0]?.url||"";(r.startsWith("/api/")||r.startsWith(window.location.origin+"/api/"))&&(t=!0,l.clearAuth(),window.location.href="/pages/auth/login.html")}return o}}function m(e,t={},s=[]){const o=document.createElement(e);return t&&Object.entries(t).forEach(([r,n])=>{r==="className"||r==="class"?o.className=n:r==="style"&&typeof n=="object"?Object.assign(o.style,n):r==="dataset"&&typeof n=="object"?Object.assign(o.dataset,n):r.startsWith("on")&&typeof n=="function"?o.addEventListener(r.substring(2).toLowerCase(),n):o.setAttribute(r,n)}),s&&(Array.isArray(s)||(s=[s]),s.forEach(r=>{r instanceof Node?o.appendChild(r):r!=null&&o.appendChild(document.createTextNode(String(r)))})),o}function d(e,t="success",s=3e3){let o=document.getElementById("toast");o||(o=document.createElement("div"),o.id="toast",o.className="toast",document.body.appendChild(o)),o._hideTimeout&&(clearTimeout(o._hideTimeout),o._hideTimeout=null),o.classList.remove("toast-success","toast-error","toast-warning","toast-info","show"),o.textContent=e,o.classList.add(`toast-${t}`),requestAnimationFrame(()=>{o.classList.add("show")}),o._hideTimeout=setTimeout(()=>{h()},s)}function h(){const e=document.getElementById("toast");e&&e.classList.remove("show")}function w(e,t=3e3){d(e,"success",t)}let u=!1;function p(){u||(u=!0,document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelectorAll(".modal-overlay.show");if(t.length===0)return;typeof window.closeModal=="function"?window.closeModal():(t.forEach(s=>{s.classList.remove("show")}),document.body.style.overflow="")}}))}function y(e,t){const s=document.getElementById(e);s&&(s.type==="password"?(s.type="text",t&&(t.textContent="○")):(s.type="password",t&&(t.textContent="◉")))}const T=Object.freeze(Object.defineProperty({__proto__:null,createElement:m,hideToast:h,setupModalCloseOnEscape:p,showSuccess:w,showToast:d,togglePassword:y},Symbol.toStringTag,{value:"Module"}));export{p as a,w as b,m as c,g as e,c as g,d as s,y as t,T as u};
