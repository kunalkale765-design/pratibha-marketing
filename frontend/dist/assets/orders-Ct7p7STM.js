import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as l,c as s}from"./ui-D1Am529b.js";import"./api-BqPqbFNt.js";const re=()=>new Promise(t=>{window.Auth?t(window.Auth):setTimeout(()=>t(re()),10)}),C=await re();let U=[];const x={};let de=[],w=[],W="all",A=null,$=null,I=null,E={},P={},F=!1,ce=!1,p=null,y=[];async function he(){if(I=await C.requireAuth(),!!I){if(I.role==="customer"){const t=document.getElementById("modalFooter");t&&(t.style.display="none")}we(),await Promise.all([M(),ke(),be()]),Ne(),Ce(),ve()}}function ve(){const t=new URLSearchParams(window.location.search),e=t.get("order"),a=t.get("action");e&&(window.history.replaceState({},"",window.location.pathname),a==="pack"?pe(e):_(e))}function we(){if(ce)return;ce=!0;const t=document.getElementById("ordersList");if(!t)return;document.addEventListener("click",o=>{o.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(c=>{c.classList.remove("swiped","swiped-single")})});let e={startX:0,isDragging:!1,currentItem:null};t.addEventListener("touchstart",o=>{const c=o.target.closest(".swipe-item");c&&(e={startX:o.touches[0].clientX,isDragging:!0,currentItem:c},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(r=>{r!==c&&r.classList.remove("swiped","swiped-single")}))},{passive:!0}),t.addEventListener("touchmove",o=>{if(!e.isDragging||!e.currentItem)return;const c=I?.role==="admin",r=e.startX-o.touches[0].clientX;r>50?(e.currentItem.classList.remove("swiped-single","swiped"),e.currentItem.classList.add(c?"swiped":"swiped-single")):r<-20&&e.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),t.addEventListener("touchend",()=>{e.isDragging=!1,e.currentItem=null},{passive:!0});const a=document.getElementById("orderModal");a&&(a.onclick=o=>{o.target.id==="orderModal"&&G()});const n=document.getElementById("invoiceModal");n&&(n.onclick=o=>{o.target.id==="invoiceModal"&&ae()})}async function ke(){try{const t=await fetch("/api/market-rates",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);((await t.json()).data||[]).forEach(a=>{const n=typeof a.product=="object"?a.product._id:a.product;x[n]=a.rate})}catch(t){console.error("Failed to load market rates:",t)}}async function be(){try{const t=await fetch("/api/products",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);de=((await t.json()).data||[]).filter(a=>a.isActive!==!1)}catch(t){console.error("Failed to load products:",t)}}async function M(){try{const t=await fetch("/api/orders?limit=100",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);const e=await t.json();if(!e.success)throw new Error(e.message||"Orders temporarily unavailable");U=e.data||[];const a=U.filter(n=>!n._id||!/^[a-f\d]{24}$/i.test(n._id));a.length>0&&console.warn("Orders with invalid IDs:",a.map(n=>({orderNumber:n.orderNumber,_id:n._id}))),ee()}catch(t){if(console.error("Failed to load orders:",t),!U||U.length===0){const e=document.getElementById("ordersList"),a=navigator.onLine?"Orders not available":"No internet connection";e.innerHTML="",e.appendChild(s("div",{className:"empty-state"},[s("p",{},a),s("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:M},"Try Again")]))}}}function Ie(t){if(!t)return"?";const e=t.trim().split(/\s+/);return e.length===1?e[0].substring(0,2).toUpperCase():(e[0][0]+e[e.length-1][0]).toUpperCase()}function ee(){const t=document.getElementById("ordersList");if(!t)return;const e=document.getElementById("searchInput"),a=e?e.value.toLowerCase():"",n=I?.role==="admin",o=I?.role==="admin"||I?.role==="staff";let c=U.filter(i=>i._id&&/^[a-f\d]{24}$/i.test(i._id));if(W==="all"?c=c.filter(i=>i.status!=="cancelled"):c=c.filter(i=>i.status===W),a&&(c=c.filter(i=>i.orderNumber?.toLowerCase().includes(a)||i.customer?.name?.toLowerCase().includes(a))),!c.length){t.innerHTML="",t.appendChild(s("div",{className:"empty-state"},"No orders found"));return}t.innerHTML="";const r=document.createDocumentFragment();c.forEach((i,b)=>{let m=null;i.batch?.batchType&&(m=s("span",{className:"badge badge-batch"},[i.batch.batchType,i.batchLocked?" ðŸ”’":""]));let h=null;if(o&&["confirmed","processing","packed"].includes(i.status)){const v=i.packingDetails?.status||"not_started",k=i.packingProgress||{total:0,verified:0};v==="in_progress"?h=s("span",{className:"packing-status-badge status-packing"},`ðŸ“¦ ${k.verified}/${k.total}`):v==="completed"||i.status==="packed"?h=s("span",{className:"packing-status-badge status-packed"},"âœ“ Packed"):v==="on_hold"?h=s("span",{className:"packing-status-badge status-on-hold"},"â¸ Hold"):["confirmed","processing"].includes(i.status)&&(h=s("span",{className:"packing-status-badge status-ready"},"Ready"))}const u=s("div",{className:"swipe-content",onclick:()=>window.viewOrder(i._id)},[s("div",{className:"order-avatar"},Ie(i.customer?.name)),s("div",{className:"order-info"},[s("div",{className:"order-customer"},i.customer?.name||"Unknown"),i.notes?s("div",{className:"order-notes"},i.notes):null,s("div",{className:"order-meta-row"},[s("span",{className:"order-number"},`Order #${i.orderNumber}`),m,h])]),s("div",{className:"order-amount-pill"},`â‚¹${(i.totalAmount||0).toLocaleString("en-IN")}`)]),g=[],L=o&&["confirmed","processing"].includes(i.status),N=i.packingDetails?.status||"not_started";if(L&&N!=="completed"){const v=N==="in_progress"||N==="on_hold"?"Resume":"Pack";g.push(s("button",{className:"swipe-action pack",onclick:k=>{k.stopPropagation(),window.openPackingPanel(i._id)}},v))}o&&g.push(s("button",{className:"swipe-action edit",onclick:v=>{v.stopPropagation(),window.printOrder(i._id)}},"Print")),n&&g.push(s("button",{className:"swipe-action delete",onclick:v=>{v.stopPropagation(),window.deleteOrder(i._id)}},"Delete"));const d=s("div",{className:"swipe-actions"},g),f=s("div",{className:"swipe-item card-fade-in",dataset:{orderId:i._id},style:{animationDelay:`${b*.05}s`}},[u,d]);r.appendChild(f)}),t.appendChild(r)}function Ne(){const t=document.getElementById("filterSegments"),e=document.getElementById("segmentIndicator"),a=t.querySelectorAll(".segment-btn");function n(c){const r=t.getBoundingClientRect(),i=c.getBoundingClientRect(),b=i.left-r.left,m=i.width;e.style.left=b+"px",e.style.width=m+"px"}const o=t.querySelector(".segment-btn.active");o&&setTimeout(()=>n(o),10),a.forEach(c=>{c.onclick=()=>{a.forEach(i=>i.classList.remove("active")),c.classList.add("active"),n(c),W=c.dataset.filter;const r=document.getElementById("ordersList");r.classList.add("segment-content"),ee(),setTimeout(()=>r.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const c=t.querySelector(".segment-btn.active");c&&n(c)})}function Pe(t,e){let a;return function(...n){clearTimeout(a),a=setTimeout(()=>t.apply(this,n),e)}}function Ce(){const t=document.getElementById("searchInput");if(t){const e=Pe(ee,200);t.addEventListener("input",e)}}let B=null,O=null,S=new Set;async function te(t){if(I?.role==="customer"){l("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(o=>{o.classList.remove("swiped","swiped-single")});const e=/^[a-f\d]{24}$/i.test(t);if(!t||!e){console.error("Invalid order ID:",t),l("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const a=document.getElementById("invoiceModalBody");a.innerHTML="",a.appendChild(s("div",{className:"invoice-loading"},"Loading invoice data..."));const n=document.getElementById("generateInvoiceBtn");n&&(n.disabled=!0);try{await $e();const o=await fetch(`/api/invoices/${t}/split`,{credentials:"include"});if(!o.ok){const r=await o.json().catch(()=>({}));throw new Error(r.message||"Invoice data temporarily unavailable")}B=(await o.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${B.orderNumber}`,ne()}catch(o){console.error("Print order error:",o),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(s("div",{className:"invoice-no-items"},[s("p",{},"Invoice data not available"),s("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},o.message)]))}}let j=[];async function $e(){if(!(j.length>0))try{const t=await fetch("/api/invoices/firms",{credentials:"include"});t.ok&&(j=(await t.json()).data||[])}catch(t){console.error("Failed to load firms:",t)}}function ne(){const t=document.getElementById("invoiceModalBody");if(!B){t.innerHTML="",t.appendChild(s("div",{className:"invoice-no-items"},"No items to invoice"));return}const e=B.firms.flatMap(i=>i.items);if(e.length===0){t.innerHTML="",t.appendChild(s("div",{className:"invoice-no-items"},"No items to invoice"));return}O||(O=j.length>0?j[0].id:B?.firms?.[0]?.firmId||"pratibha",S=new Set(e.map(i=>i.productId)));const a=e.filter(i=>S.has(i.productId)).reduce((i,b)=>i+(b.amount||0),0),n=j.length>0?j:(B?.firms||[]).map(i=>({id:i.firmId,name:i.firmName}));t.innerHTML="";const o=document.createDocumentFragment(),c=s("div",{className:"invoice-firm-selector"},[s("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),s("div",{className:"firm-options"},n.map(i=>s("label",{className:`firm-option ${O===i.id?"selected":""}`,onclick:()=>window.selectFirm(i.id)},[s("input",{type:"radio",name:"firm",value:i.id,checked:O===i.id}),s("span",{className:"firm-option-name"},i.name)])))]);o.appendChild(c),o.appendChild(s("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),o.appendChild(s("div",{className:"invoice-items-list"},e.map(i=>s("div",{className:"invoice-item"},[s("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:i.productId},checked:S.has(i.productId),onchange:()=>window.toggleInvoiceItem(null,i.productId)}),s("div",{className:"invoice-item-details"},[s("div",{className:"invoice-item-name"},i.productName),s("div",{className:"invoice-item-meta"},`${i.quantity||0} ${i.unit||""} Ã— â‚¹${(i.rate||0).toLocaleString("en-IN")}`)]),s("div",{className:"invoice-item-amount"},`â‚¹${(i.amount||0).toLocaleString("en-IN")}`)])))),o.appendChild(s("div",{className:"invoice-summary"},[s("div",{className:"invoice-summary-label"},"Total"),s("div",{className:"invoice-summary-total"},`â‚¹${a.toLocaleString("en-IN")}`)])),t.appendChild(o);const r=document.getElementById("generateInvoiceBtn");r&&(r.disabled=S.size===0)}function Ee(t){O=t,ne()}function Be(t,e){S.has(e)?S.delete(e):S.add(e),ne()}async function Se(){if(!B||!O||S.size===0)return;const t=document.getElementById("generateInvoiceBtn");t.classList.add("btn-loading"),t.disabled=!0;try{const e={"Content-Type":"application/json"},a=await C.ensureCsrfToken();a&&(e["X-CSRF-Token"]=a);const n=await fetch(`/api/invoices/${B.orderId}/pdf`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({firmId:O,productIds:Array.from(S)})});if(!n.ok){const i=await n.json().catch(()=>({}));throw new Error(i.message||"Invoice generation temporarily unavailable")}const o=await n.blob(),c=URL.createObjectURL(o),r=document.createElement("a");r.href=c,r.download=`INV${B.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c),l("Invoice downloaded","success"),ae()}catch(e){console.error("Generate invoice error:",e),l(e.message||"Could not generate invoice","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}}function ae(){document.getElementById("invoiceModal").classList.remove("show"),B=null,O=null,S=new Set}function Te(){if(!A)return;const t=A;G(),te(t)}async function Le(t){if(I?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const e=document.querySelector(`.swipe-item[data-order-id="${t}"]`);try{const a={"Content-Type":"application/json"},n=await C.ensureCsrfToken();n&&(a["X-CSRF-Token"]=n);const o=await fetch(`/api/orders/${t}`,{method:"DELETE",headers:a,credentials:"include"});if(o.ok)e?(e.classList.add("deleting"),setTimeout(()=>{M()},300)):M(),l("Order cancelled","success");else{const c=await o.json().catch(()=>({message:"Could not cancel. Try again."}));l(c.message||"Could not cancel","info")}}catch(a){console.error("Delete order error:",a),l("Could not delete order","info")}}async function _(t){if(F){l("Please wait, saving in progress...","info");return}try{const e=await fetch(`/api/orders/${t}`,{credentials:"include"});let a;try{a=await e.json()}catch(d){console.error("Failed to parse order response:",d),l("Server issue. Please refresh.","info");return}if(!e.ok){l(a?.message||"Could not load order","info");return}const n=a.data;if(!n||!n.products){l("Order data updating. Refresh page.","info");return}A=t,$=n,E={},P={},w=[];const o=document.getElementById("modalTitle");o&&(o.textContent=`#${n.orderNumber}`);const c=document.getElementById("savePricesBtn");c&&(c.disabled=!0);const r=I.role==="admin"||I.role==="staff",i=n.batch?.batchType?`<span class="badge badge-batch">${n.batch.batchType}${n.batchLocked?" ðŸ”’":""}</span>`:"-",b=document.getElementById("modalBody");b.innerHTML="";const m=document.createDocumentFragment(),h=s("div",{className:"info-row"},[s("div",{},[s("div",{className:"info-label"},"Customer"),s("div",{className:"info-value"},n.customer?.name||"")]),s("div",{},[s("div",{className:"info-label"},"Phone"),s("div",{className:"info-value"},n.customer?.phone||"-")])]);m.appendChild(h);const u=n.batch?.batchType?s("span",{className:"badge badge-batch"},[n.batch.batchType,n.batchLocked?" ðŸ”’":""]):"-",g=s("div",{className:"info-row"},[s("div",{},[s("div",{className:"info-label"},"Date"),s("div",{className:"info-value"},new Date(n.createdAt).toLocaleDateString("en-IN"))]),s("div",{},[s("div",{className:"info-label"},"Batch"),s("div",{className:"info-value"},Array.isArray(u)?u:[u])])]);m.appendChild(g);const L=s("div",{className:"info-row"},[s("div",{},[s("div",{className:"info-label"},"Status"),s("div",{className:"info-value"},[s("span",{className:`badge badge-${n.status}`},n.status)])]),s("div",{})]);m.appendChild(L);const N=s("div",{className:"info-section"});if(N.appendChild(s("div",{className:"info-label"},"Products")),n.products.forEach((d,f)=>{const v=typeof d.product=="object"?d.product._id:d.product,k=x[v]||d.rate||null,D=k?`â‚¹${k.toLocaleString("en-IN")}`:"N/A";let q;if(r){const H=s("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${f}`,value:d.quantity,min:"0",step:"0.01",dataset:{idx:f,original:d.quantity,unit:d.unit},onfocus:Q=>window.clearZero(Q.target),onblur:Q=>window.restoreValue(Q.target),onchange:()=>window.handleQuantityChange(f),oninput:()=>window.handleQuantityInput(f)});q=s("div",{className:"qty-controls-inline"},[s("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(f,-1)},"âˆ’"),H,s("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(f,1)},"+"),s("span",{className:"qty-unit"},d.unit)])}else q=s("div",{className:"product-qty"},`${d.quantity} ${d.unit}`);const R=["Selling"];d.isContractPrice&&(R.push(" "),R.push(s("span",{className:"contract-badge"},"Fixed")));let K;if(r){const H=s("input",{type:"number",className:`price-input input-animated${d.isContractPrice?" contract-locked":""}`,id:`price-${f}`,value:d.rate,min:"0",step:"0.01",dataset:{idx:f,original:d.rate,qty:d.quantity,contract:d.isContractPrice||!1},onfocus:Q=>window.clearZero(Q.target),onblur:Q=>window.restoreValue(Q.target),onchange:()=>window.handlePriceChange(f),oninput:()=>window.handlePriceInput(f)});d.isContractPrice&&(H.disabled=!0,H.title="Contract price - edit in customer management"),K=H}else K=s("div",{className:"price-value"},`â‚¹${d.rate}`);const ye=s("div",{className:"product-item",dataset:{idx:f}},[s("div",{className:"product-top"},[s("div",{},[s("div",{className:"product-name"},d.productName),q])]),s("div",{className:"prices-container"},[s("div",{className:"price-box"},[s("div",{className:"price-label"},"Purchase"),s("div",{className:"price-value"},D)]),s("div",{className:"price-box"},[s("div",{className:"price-label"},R),K])]),s("div",{className:"amount-row"},[s("span",{className:"amount-label"},"Amount"),s("span",{className:"amount-display",id:`amount-${f}`},`â‚¹${d.amount}`)])]);N.appendChild(ye)}),N.appendChild(s("div",{id:"addedProductsContainer"})),r){const d=[s("option",{value:""},"+ Add Product...")];de.filter(k=>!n.products.some(D=>(typeof D.product=="object"?D.product._id:D.product)===k._id)).forEach(k=>{d.push(s("option",{value:k._id,dataset:{name:k.name,unit:k.unit}},`${k.name} (${k.unit})`))});const f=s("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},d),v=s("div",{className:"add-product-section"},[f]);N.appendChild(v)}m.appendChild(N);const ie=s("div",{className:"total-section"},[s("div",{className:"total-row"},[s("span",{},"Total"),s("span",{id:"orderTotal"},`â‚¹${n.totalAmount}`)]),s("div",{className:"total-row"},[s("span",{},"Paid"),s("span",{},`â‚¹${n.paidAmount||0}`)]),s("div",{className:"total-row main"},[s("span",{},"Balance"),s("span",{id:"orderBalance"},`â‚¹${n.totalAmount-(n.paidAmount||0)}`)])]);if(m.appendChild(ie),b.appendChild(m),r){const d=document.getElementById("modalFooter");if(d){d.innerHTML="";const f=s("button",{className:"btn-modal secondary btn-animated",onclick:()=>window.printFromModal()},s("span",{className:"btn-text"},"Invoice"));if(d.appendChild(f),n.status==="pending"){const q=s("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--dusty-olive)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"confirmed")},"Confirm Order");d.appendChild(q)}else if(["confirmed","processing","packed","shipped"].includes(n.status)){const q=s("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--gunmetal)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"delivered")},"Mark Delivered");d.appendChild(q)}const v=n.packingDetails?.status||"not_started";if(["confirmed","processing"].includes(n.status)&&v!=="completed"){const R=s("button",{className:"btn-modal secondary btn-animated",style:{background:"var(--dusty-olive)",color:"white",border:"none"},onclick:()=>{window.closeModal(),setTimeout(()=>window.openPackingPanel(n._id),200)}},v==="in_progress"||v==="on_hold"?"Resume Packing":"Start Packing");d.appendChild(R)}const D=s("button",{className:"btn-save-prices btn-animated",id:"savePricesBtn",disabled:!0,onclick:()=>window.savePrices()},s("span",{className:"btn-text"},"Save"));d.appendChild(D)}}document.getElementById("orderModal").classList.add("show")}catch{l("Could not load order","info")}}function qe(t){t.dataset.prevValue=t.value,t.value="",t.select()}function Fe(t){t.value===""&&(t.value=t.dataset.prevValue||t.dataset.original);const e=parseInt(t.dataset.idx);le(e)}function Ae(t){const e=document.getElementById(`price-${t}`),a=document.getElementById(`quantity-${t}`),n=parseFloat(e.dataset.original),o=parseFloat(e.value)||0,c=a?parseFloat(a.value)||0:parseFloat(e.dataset.qty);e.classList.toggle("changed",o!==n);const r=Math.round(o*c*100)/100,i=document.getElementById(`amount-${t}`);i&&(i.textContent=`â‚¹${r.toLocaleString("en-IN")}`),T()}function le(t){const e=document.getElementById(`price-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),n=parseFloat(e.value)||0;n!==a&&n>0?E[t]=n:delete E[t],Z()}function Oe(t,e){const a=document.getElementById(`quantity-${t}`);if(!a)return;let o=(parseFloat(a.value)||0)+e;o<.01&&o>0&&(o=0),o<0&&(o=0),a.value=o,ue(t),se(t)}function se(t){const e=document.getElementById(`quantity-${t}`),a=document.getElementById(`price-${t}`);if(!e)return;const n=parseFloat(e.dataset.original),o=parseFloat(e.value)||0;e.classList.remove("changed","removed"),o===0?e.classList.add("removed"):o!==n&&e.classList.add("changed");const c=a?parseFloat(a.value)||0:$?.products[t]?.rate||0,r=Math.round(o*c*100)/100,i=document.getElementById(`amount-${t}`);i&&(i.textContent=`â‚¹${r.toLocaleString("en-IN")}`),T()}function ue(t){const e=document.getElementById(`quantity-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),n=parseFloat(e.value)||0,o=.01;n>0&&n<o?(l(`Minimum quantity: ${o} ${e.dataset.unit}`,"info"),e.value=a,delete P[t]):n!==a?P[t]=n:delete P[t],Z(),se(t)}function Z(){const t=Object.keys(E).length>0||Object.keys(P).length>0||w.length>0,e=document.getElementById("savePricesBtn");e&&(e.disabled=!t)}function Me(){const t=document.getElementById("productSelector"),e=t.value;if(!e)return;const a=t.options[t.selectedIndex],n=a.dataset.name,o=a.dataset.unit,c=x[e]||0;w.push({product:e,productName:n,unit:o,quantity:1,rate:c}),a.remove(),oe(),T(),Z(),t.value=""}function oe(){const t=document.getElementById("addedProductsContainer");if(!t)return;t.innerHTML="";const e=document.createDocumentFragment();w.forEach((a,n)=>{const o=s("div",{className:"product-item added-product",dataset:{addedIdx:n}},[s("div",{className:"product-top"},[s("div",{},[s("div",{className:"product-name"},[a.productName," ",s("span",{className:"new-badge"},"New")]),s("div",{className:"qty-controls-inline"},[s("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,-1),type:"button"},"âˆ’"),s("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${n}`,value:a.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(n),oninput:()=>window.handleAddedQtyInput(n)}),s("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,1),type:"button"},"+"),s("span",{className:"qty-unit"},a.unit)])]),s("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(n),title:"Remove"},"Ã—")]),s("div",{className:"prices-container"},[s("div",{className:"price-box"},[s("div",{className:"price-label"},"Purchase"),s("div",{className:"price-value"},a.rate?`â‚¹${a.rate.toLocaleString("en-IN")}`:"N/A")]),s("div",{className:"price-box"},[s("div",{className:"price-label"},"Selling"),s("input",{type:"number",className:"price-input input-animated",id:`added-price-${n}`,value:a.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(n)})])]),s("div",{className:"amount-row"},[s("span",{className:"amount-label"},"Amount"),s("span",{className:"amount-display",id:`added-amount-${n}`},`â‚¹${((a.rate||0)*(a.quantity||0)).toLocaleString("en-IN")}`)])]);e.appendChild(o)}),t.appendChild(e)}function De(t,e){const a=document.getElementById(`added-qty-${t}`);if(!a)return;let n=parseFloat(a.value)||0;n=Math.max(0,n+e),n>0&&n<.01&&(n=.01),a.value=n,w[t].quantity=n,X(t),T()}function Qe(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;let a=parseFloat(e.value)||0;a>0&&a<.01&&(l("Minimum quantity: 0.01","info"),a=.01,e.value=a),w[t].quantity=a,X(t),T()}function je(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;const a=parseFloat(e.value)||0;w[t].quantity=a,X(t),T()}function _e(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const a=parseFloat(e.value)||0;w[t].rate=a,X(t),T()}function Re(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const a=parseFloat(e.value)||0;w[t].rate=a,X(t),T()}function X(t){const e=document.getElementById(`added-amount-${t}`);if(!e)return;const a=w[t],n=(a.quantity||0)*(a.rate||0);e.textContent=`â‚¹${n.toLocaleString("en-IN")}`}function He(t){const e=w.splice(t,1)[0],a=document.getElementById("productSelector");if(a&&e){const n=document.createElement("option");n.value=e.product,n.dataset.name=e.productName,n.dataset.unit=e.unit,n.textContent=`${e.productName} (${e.unit})`,a.appendChild(n)}oe(),T(),Z()}function T(){if(!$||!$.products)return;let t=0;$.products.forEach((o,c)=>{const r=document.getElementById(`price-${c}`),i=document.getElementById(`quantity-${c}`),b=r?parseFloat(r.value)||0:o.rate,m=i?parseFloat(i.value)||0:o.quantity;t+=b*m}),w.forEach(o=>{t+=(o.quantity||0)*(o.rate||0)}),t=Math.round(t*100)/100;const e=Math.round((t-($.paidAmount||0))*100)/100,a=document.getElementById("orderTotal"),n=document.getElementById("orderBalance");a&&(a.textContent=`â‚¹${t.toLocaleString("en-IN")}`),n&&(n.textContent=`â‚¹${e.toLocaleString("en-IN")}`)}async function Ue(t){try{const e=await fetch(`/api/invoices/order/${t}`,{credentials:"include"});if(!e.ok)return!1;const a=await e.json();return a.data&&a.data.length>0}catch(e){return console.error("Failed to check invoices:",e),!1}}async function Xe(){const t=Object.keys(E).length>0||Object.keys(P).length>0||w.length>0;if(!A||!$||!$.products||!t)return;if(F){l("Save in progress...","info");return}F=!0;const e=document.getElementById("savePricesBtn");e&&(e.disabled=!0,e.classList.add("btn-loading"));let a=!1;try{if(a=await Ue(A),a&&!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`)){F=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}catch(n){console.error("Invoice check failed:",n)}try{const n=$.products.map((u,g)=>{let L=E[g]!==void 0?E[g]:u.rate,N=P[g]!==void 0?P[g]:u.quantity;return(!L||L<=0)&&(L=u.rate),N<0&&(N=u.quantity),{product:typeof u.product=="object"?u.product._id:u.product,quantity:N,priceAtTime:L}}).filter(u=>u.quantity>0),o=w.filter(u=>u.quantity>0).map(u=>({product:u.product,quantity:u.quantity,priceAtTime:u.rate})),c=[...n,...o],r={"Content-Type":"application/json"},i=await C.ensureCsrfToken();i&&(r["X-CSRF-Token"]=i);const b={products:c},m=A;let h=await fetch(`/api/orders/${m}`,{method:"PUT",headers:r,credentials:"include",body:JSON.stringify(b)});if(h.status===403){let u;try{u=await h.json()}catch(g){console.warn("Failed to parse CSRF error response:",g.message),u={message:`Access denied (code: ${h.status})`}}if(u.message?.toLowerCase().includes("csrf")){const g=await C.refreshCsrfToken();if(g){if(r["X-CSRF-Token"]=g,h=await fetch(`/api/orders/${m}`,{method:"PUT",headers:r,credentials:"include",body:JSON.stringify(b)}),h.status===403){l("Session expired. Please refresh the page.","info"),F=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{l("Session expired. Please refresh the page.","info"),F=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{l(u.message||"Access temporarily unavailable","info"),F=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}if(h.ok)l("Changes saved","success"),E={},P={},w=[],e&&(e.classList.remove("btn-loading"),e.classList.add("btn-success"),setTimeout(()=>e.classList.remove("btn-success"),1500),e.disabled=!0),M(),a&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const u=m;G(),setTimeout(()=>te(u),300)}},500),A===m&&_(m);else{let u;try{u=await h.json()}catch(g){console.warn("Failed to parse order save error response:",g.message),u={message:`Server error (${h.status})`}}l(u.message||"Could not update","info"),e&&(e.disabled=!1)}}catch(n){console.error("Save changes error:",n),navigator.onLine?l("Could not save. Try again.","info"):l("No internet connection","info"),e&&(e.disabled=!1)}finally{F=!1,e&&e.classList.remove("btn-loading")}}function G(){if((Object.keys(E).length>0||Object.keys(P).length>0||w.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const e=document.getElementById("orderModal");e&&e.classList.remove("show"),A=null,$=null,E={},P={},w=[]}window.closeModal=G;window.viewOrder=_;window.clearZero=qe;window.restoreValue=Fe;window.handlePriceChange=le;window.handlePriceInput=Ae;window.handleQuantityChange=ue;window.handleQuantityInput=se;window.changeQuantity=Oe;window.savePrices=Xe;window.deleteOrder=Le;window.printOrder=te;window.closeInvoiceModal=ae;window.selectFirm=Ee;window.toggleInvoiceItem=Be;window.generateInvoice=Se;window.printFromModal=Te;window.addProductToOrder=Me;window.renderAddedProducts=oe;window.changeAddedQty=De;window.handleAddedQtyChange=Qe;window.handleAddedQtyInput=je;window.handleAddedPriceChange=_e;window.handleAddedPriceInput=Re;window.removeAddedProduct=He;async function Ve(t,e){if(!(!I||I.role!=="admin"&&I.role!=="staff"))try{const a={"Content-Type":"application/json"},n=await C.ensureCsrfToken();n&&(a["X-CSRF-Token"]=n);const o=await fetch(`/api/orders/${t}/status`,{method:"PUT",headers:a,credentials:"include",body:JSON.stringify({status:e})}),c=await o.json();o.ok?(l(`Order marked as ${e}`,"success"),_(t),M()):(l(c.message||"Failed to update status","error"),_(t))}catch(a){console.error("Status update error:",a),l("Network error updating status","error"),_(t)}}window.updateOrderStatus=Ve;async function pe(t){const e=document.getElementById("packingPanel"),a=document.getElementById("packingPanelOverlay");if(!(!e||!a)){document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(n=>{n.classList.remove("swiped","swiped-single")}),e.classList.add("active"),a.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("packingPanelBody").innerHTML='<div class="packing-loading">Loading order...</div>',document.getElementById("packingCompleteBtn").disabled=!0;try{const n=await fetch(`/api/packing/${t}`,{credentials:"include"});if(!n.ok)throw new Error("Failed to load order");p=(await n.json()).data;const c=p.packingDetails?.status||"not_started";c==="not_started"?await Je(t):c==="on_hold"&&await ze(t),y=p.packingDetails?.items||[],V()}catch(n){console.error("Error loading packing order:",n),l("Failed to load order details","error"),Y()}}}async function Je(t){try{const e=await C.ensureCsrfToken(),a=await fetch(`/api/packing/${t}/start`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include"});if(!a.ok){const o=await a.json();throw new Error(o.message||"Failed to start packing")}y=(await a.json()).data.items||[],p.packingDetails.status="in_progress"}catch(e){throw console.error("Error starting packing:",e),e}}async function ze(t){try{const e=await C.ensureCsrfToken(),a=await fetch(`/api/packing/${t}/resume`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include"});if(!a.ok){const n=await a.json();throw new Error(n.message||"Failed to resume packing")}p.packingDetails.status="in_progress"}catch(e){throw console.error("Error resuming packing:",e),e}}function V(){document.getElementById("packingPanelTitle").textContent=`Pack ${p.orderNumber}`,document.getElementById("packingPanelSubtitle").textContent=`${p.customer?.name||"Unknown"} â€¢ ${p.customer?.phone||""}`,me();const t=document.getElementById("packingPanelBody");let e="";(p.deliveryAddress||p.notes)&&(e='<div class="packing-order-details">',p.deliveryAddress&&(e+=`
                <div class="packing-delivery-info">
                    <span class="packing-label">Deliver to</span>
                    <span class="packing-value">${p.deliveryAddress}</span>
                </div>`),p.notes&&(e+=`
                <div class="packing-order-notes">
                    <span class="packing-label">Notes</span>
                    <span class="packing-value">${p.notes}</span>
                </div>`),e+="</div>");const a=y.map((r,i)=>{const b=r.status!=="pending",m=Ze(r.status);return`
            <div class="packing-checklist-item ${Ge(r.status)}" data-index="${i}" data-product-id="${r.product}">
                <div class="packing-item-main">
                    <div class="packing-item-check ${b?"checked":""}" onclick="togglePackingItemStatus(${i})">
                        ${m}
                    </div>
                    <div class="packing-item-details">
                        <span class="packing-item-name">${r.productName}</span>
                        <span class="packing-item-qty">Ordered: ${r.orderedQuantity} ${r.unit}</span>
                    </div>
                </div>

                <div class="packing-item-input">
                    <input type="number"
                        class="packing-qty-input"
                        placeholder="Qty"
                        value="${r.packedQuantity??""}"
                        data-index="${i}"
                        step="0.01"
                        min="0"
                        onchange="handlePackingQtyChange(${i})"
                    >
                    <span class="packing-unit-label">${r.unit}</span>
                </div>

                <div class="packing-item-status">
                    <select class="packing-status-select" data-index="${i}" onchange="updatePackingItemStatus(${i}, this.value)">
                        <option value="pending" ${r.status==="pending"?"selected":""}>Pending</option>
                        <option value="packed" ${r.status==="packed"?"selected":""}>Packed</option>
                        <option value="short" ${r.status==="short"?"selected":""}>Short</option>
                        <option value="damaged" ${r.status==="damaged"?"selected":""}>Damaged</option>
                        <option value="unavailable" ${r.status==="unavailable"?"selected":""}>Unavailable</option>
                    </select>
                </div>

                ${r.status!=="packed"&&r.status!=="pending"?`
                    <div class="packing-item-notes">
                        <input type="text"
                            class="packing-notes-input"
                            placeholder="Add note..."
                            value="${r.notes||""}"
                            data-index="${i}"
                            onchange="handlePackingNotesChange(${i})"
                        >
                    </div>
                `:""}
            </div>
        `}).join("");t.innerHTML=`
        ${e}
        <div class="packing-checklist-header">
            <span>Items to Pack</span>
            <button class="packing-btn-mini" onclick="markAllPacked()">Mark All Packed</button>
        </div>
        <div class="packing-checklist">
            ${a}
        </div>
    `,ge();const n=p.packingDetails?.issues?.length>0||y.some(r=>r.status!=="packed"&&r.status!=="pending"),o=document.getElementById("packingPanelAcknowledgement");n?o.style.display="block":o.style.display="none";const c=document.getElementById("packingAcknowledgeCheckbox");c&&(c.onchange=z),z()}function Ze(t){switch(t){case"packed":return"âœ“";case"short":return"âš ";case"damaged":return"âœ•";case"unavailable":return"âˆ…";default:return""}}function Ge(t){switch(t){case"packed":return"item-packed";case"short":return"item-short";case"damaged":return"item-damaged";case"unavailable":return"item-unavailable";default:return"item-pending"}}async function Ye(t){const e=y[t];if(e.status==="pending"){const a=document.querySelector(`.packing-qty-input[data-index="${t}"]`),n=parseFloat(a?.value)||e.orderedQuantity;e.packedQuantity=n,n>=e.orderedQuantity?e.status="packed":n>0&&(e.status="short")}else e.status==="packed"&&(e.status="pending");await J(t),V()}async function Ke(t,e){const a=y[t];a.status=e;const n=document.querySelector(`.packing-qty-input[data-index="${t}"]`);e==="packed"?a.packedQuantity=parseFloat(n?.value)||a.orderedQuantity:e==="unavailable"&&(a.packedQuantity=0),await J(t),V()}async function We(t){const e=document.querySelector(`.packing-qty-input[data-index="${t}"]`),a=parseFloat(e?.value)||0,n=y[t];n.packedQuantity=a,a>0&&a<n.orderedQuantity&&n.status==="pending"&&(n.status="short",V()),await J(t)}async function xe(t){const e=document.querySelector(`.packing-notes-input[data-index="${t}"]`);y[t].notes=e?.value||"",await J(t)}async function J(t){const e=y[t];try{const a=await C.ensureCsrfToken(),n=await fetch(`/api/packing/${p._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":a},credentials:"include",body:JSON.stringify({status:e.status,packedQuantity:e.packedQuantity,notes:e.notes})});if(!n.ok)throw new Error("Failed to save");const o=await n.json();o.data?.issues&&(p.packingDetails.issues=o.data.issues),me(),ge(),z()}catch(a){console.error("Error saving packing item:",a),l("Failed to save changes","error")}}async function et(){for(let t=0;t<y.length;t++){const e=y[t];e.status==="pending"&&(e.status="packed",e.packedQuantity=e.orderedQuantity,await J(t))}V()}function me(){const t=y.length,e=y.filter(n=>n.status!=="pending").length,a=t>0?Math.round(e/t*100):0;document.getElementById("packingProgressFill").style.width=`${a}%`,document.getElementById("packingProgressText").textContent=`${e}/${t} items`}function ge(){const t=p.packingDetails?.issues||[],e=document.getElementById("packingPanelIssues"),a=document.getElementById("packingIssuesList");t.length>0?(e.style.display="block",a.innerHTML=t.map(c=>`
            <div class="packing-issue-item issue-${c.issueType}">
                <span class="packing-issue-product">${c.productName}</span>
                <span class="packing-issue-type">${c.issueType}</span>
                <span class="packing-issue-qty">${c.quantityAffected} affected</span>
                ${c.description?`<span class="packing-issue-desc">${c.description}</span>`:""}
            </div>
        `).join("")):e.style.display="none";const n=document.getElementById("packingPanelAcknowledgement");t.length>0||y.some(c=>c.status!=="packed"&&c.status!=="pending")?n.style.display="block":n.style.display="none",z()}function z(){const t=document.getElementById("packingCompleteBtn"),e=y.every(o=>o.status!=="pending"),a=p.packingDetails?.issues?.length>0||y.some(o=>o.status!=="packed"&&o.status!=="pending"),n=document.getElementById("packingAcknowledgeCheckbox")?.checked||!a;t.disabled=!e||a&&!n}function tt(){document.getElementById("packingHoldModal").classList.add("active")}function fe(){document.getElementById("packingHoldModal").classList.remove("active"),document.getElementById("packingHoldReason").value=""}async function nt(){const t=document.getElementById("packingHoldReason").value.trim();if(!t){l("Please provide a reason","error");return}try{const e=await C.ensureCsrfToken();if(!(await fetch(`/api/packing/${p._id}/hold`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include",body:JSON.stringify({reason:t})})).ok)throw new Error("Failed to hold order");l("Order put on hold","warning"),fe(),Y(),await M()}catch(e){console.error("Error holding order:",e),l("Failed to hold order","error")}}async function at(){const t=p.packingDetails?.issues?.length>0||y.some(n=>n.status!=="packed"&&n.status!=="pending"),e=document.getElementById("packingAcknowledgeCheckbox")?.checked;if(t&&!e){l("Please acknowledge issues before completing","error");return}const a=document.getElementById("packingCompleteBtn");a.disabled=!0,a.innerHTML='<span class="btn-text">Completing...</span>';try{const n=await C.ensureCsrfToken(),o=await fetch(`/api/packing/${p._id}/complete`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":n},credentials:"include",body:JSON.stringify({acknowledgeIssues:e||!1})});if(!o.ok){const c=await o.json();throw new Error(c.message||"Failed to complete packing")}l("Packing completed!","success"),Y(),await M()}catch(n){console.error("Error completing packing:",n),l(n.message||"Failed to complete packing","error"),a.disabled=!1,a.innerHTML='<span class="btn-text">Complete Packing</span>'}}function Y(){const t=document.getElementById("packingPanel"),e=document.getElementById("packingPanelOverlay");t.classList.remove("active"),e.classList.remove("active"),document.body.style.overflow="",p=null,y=[]}window.openPackingPanel=pe;window.closePackingPanel=Y;window.togglePackingItemStatus=Ye;window.updatePackingItemStatus=Ke;window.handlePackingQtyChange=We;window.handlePackingNotesChange=xe;window.markAllPacked=et;window.holdPackingOrder=tt;window.closePackingHoldModal=fe;window.confirmPackingHold=nt;window.completePackingSession=at;he();
