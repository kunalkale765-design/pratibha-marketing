{"version":3,"mappings":"kGAmBA,OAAO,QAAU,SAAUA,EAASC,EAAQC,EAAQC,EAAOC,EAAO,CAChE,eAAQ,MAAM,kBAAmBJ,EAAS,KAAMC,EAAQC,EAAQC,CAAK,EACjEC,GACFC,EAAiBD,EAAO,CAAE,OAAAH,EAAQ,OAAAC,EAAQ,MAAAC,CAAK,CAAE,EAE5C,EACT,EAGA,OAAO,iBAAiB,qBAAsB,SAAUG,EAAO,CAC7D,QAAQ,MAAM,+BAAgCA,EAAM,MAAM,EAC1DD,EAAiBC,EAAM,QAAU,IAAI,MAAM,qBAAqB,CAAC,EACjEA,EAAM,eAAc,CACtB,CAAC,EASM,SAASC,GAAwB,CAClC,kBAAmB,YACrB,OAAO,iBAAiB,OAAQ,IAAM,CACpC,UAAU,cAAc,SAAS,oBAAoB,EAClD,KAAKC,GAAgB,CACpB,QAAQ,IAAI,4BAA6BA,EAAa,KAAK,CAC7D,CAAC,EACA,MAAMJ,GAAS,CACd,QAAQ,IAAI,qCAAsCA,CAAK,CACzD,CAAC,CACL,CAAC,EAGD,UAAU,cAAc,iBAAiB,UAAYE,GAAU,CACzDA,EAAM,MAAM,OAAS,cAExBG,EAAA,0BAAAC,CAAA,OAAC,QAAO,kBAAS,OAAAC,KAAA,oBAAAD,CAAA,OAAE,KAAK,CAAC,CAAE,UAAAA,KAAgB,CACxCA,EAAU,sCAAuC,MAAM,CACzD,CAAC,EAAE,MAAM,IAAM,CAEb,QAAQ,IAAI,yCAAyC,CACvD,CAAC,CAEL,CAAC,EAEL,CAUO,eAAeE,GAAS,CAC7B,GAAI,OAAO,MAAQ,OAAO,OAAO,KAAK,QAAW,WAC/C,OAAO,OAAO,KAAK,OAAM,EAI3B,aAAa,WAAW,MAAM,EAE9B,MAAMC,EAAU,CAAE,eAAgB,kBAAkB,EAC9CC,EAAYC,EAAY,EAC1BD,IACFD,EAAQ,cAAc,EAAIC,GAG5B,GAAI,CACF,MAAM,MAAM,mBAAoB,CAC9B,OAAQ,OACR,QAAAD,EACA,YAAa,SACnB,CAAK,CACH,OAAST,EAAO,CACd,QAAQ,MAAM,gBAAiBA,CAAK,CACtC,CAEA,OAAO,SAAS,KAAO,wBACzB,CAMO,SAASY,GAAoB,CACf,SAAS,iBAAiB,wCAAwC,EAC1E,QAAQC,GAAO,CACxBA,EAAI,iBAAiB,QAAUC,GAAM,CACnCA,EAAE,eAAc,EAChBN,EAAM,CACR,CAAC,CACH,CAAC,CACH,CAoBO,SAASO,EAASC,EAAU,GAAI,CACrC,KAAM,CACJ,cAAAC,EAAgB,GAChB,OAAAT,EAAS,GACT,YAAAU,EAAc,GACd,aAAAC,EAAe,EACnB,EAAMH,EAGAG,GACFC,EAAe,EAAG,MAAMC,GAAO,QAAQ,KAAK,yBAA0BA,CAAG,CAAC,EAIxEJ,GACFd,EAAqB,EAInBK,GACFI,EAAiB,EAIfM,GACFI,EAAuB,EAIzB,GAAI,CACF,MAAMC,EAAS,aAAa,QAAQ,MAAM,EACtCA,GAAQC,EAAc,KAAK,MAAMD,CAAM,CAAC,CAC9C,MAAY,CAA4B,CAC1C","names":["message","source","lineno","colno","error","captureException","event","registerServiceWorker","registration","__vitePreload","showToast","n","logout","headers","csrfToken","getCsrfToken","setupLogoutButton","btn","e","initPage","options","serviceWorker","modalEscape","csrfPreFetch","ensureCsrfToken","err","setupModalCloseOnEscape","stored","setSentryUser"],"ignoreList":[],"sources":["../../src/js/init.js"],"sourcesContent":["/**\n * Page Initialization\n *\n * Common setup tasks that every page needs:\n * - Service Worker registration\n * - Logout functionality\n * - Modal escape key handling\n * - Global error handling\n */\n\nimport { captureException, setSentryUser } from './sentry.js';\nimport { setupModalCloseOnEscape } from './ui.js';\nimport { getCsrfToken, ensureCsrfToken } from './csrf.js';\n\n/* ===================\n   GLOBAL ERROR HANDLERS\n   =================== */\n\n// Catch uncaught errors silently (prevent browser error dialogs)\nwindow.onerror = function (message, source, lineno, colno, error) {\n  console.error('Uncaught error:', message, 'at', source, lineno, colno);\n  if (error) {\n    captureException(error, { source, lineno, colno });\n  }\n  return true; // Prevents the browser's default error handling\n};\n\n// Catch unhandled promise rejections silently\nwindow.addEventListener('unhandledrejection', function (event) {\n  console.error('Unhandled promise rejection:', event.reason);\n  captureException(event.reason || new Error('Unhandled rejection'));\n  event.preventDefault(); // Prevents the browser's default handling\n});\n\n/* ===================\n   SERVICE WORKER\n   =================== */\n\n/**\n * Register the Service Worker for PWA support\n */\nexport function registerServiceWorker() {\n  if ('serviceWorker' in navigator) {\n    window.addEventListener('load', () => {\n      navigator.serviceWorker.register('/service-worker.js')\n        .then(registration => {\n          console.log('ServiceWorker registered:', registration.scope);\n        })\n        .catch(error => {\n          console.log('ServiceWorker registration failed:', error);\n        });\n    });\n\n    // Listen for SW update notifications\n    navigator.serviceWorker.addEventListener('message', (event) => {\n      if (event.data?.type === 'SW_UPDATED') {\n        // Dynamically import to avoid circular dependency at module load\n        import('./ui.js').then(({ showToast }) => {\n          showToast('Update available â€” refresh to apply', 'info');\n        }).catch(() => {\n          // Fallback if ui.js import fails\n          console.log('App update available. Refresh to apply.');\n        });\n      }\n    });\n  }\n}\n\n/* ===================\n   LOGOUT\n   =================== */\n\n/**\n * Logout the user\n * Delegates to Auth.logout() if available, otherwise performs direct logout\n */\nexport async function logout() {\n  if (window.Auth && typeof window.Auth.logout === 'function') {\n    return window.Auth.logout();\n  }\n\n  // Fallback: direct logout if Auth not loaded\n  localStorage.removeItem('user');\n\n  const headers = { 'Content-Type': 'application/json' };\n  const csrfToken = getCsrfToken();\n  if (csrfToken) {\n    headers['X-CSRF-Token'] = csrfToken;\n  }\n\n  try {\n    await fetch('/api/auth/logout', {\n      method: 'POST',\n      headers,\n      credentials: 'include'\n    });\n  } catch (error) {\n    console.error('Logout error:', error);\n  }\n\n  window.location.href = '/pages/auth/login.html';\n}\n\n/**\n * Setup logout button click handler\n * Looks for elements with data-logout attribute or class \"logout-btn\"\n */\nexport function setupLogoutButton() {\n  const logoutBtns = document.querySelectorAll('[data-logout], .logout-btn, #logoutBtn');\n  logoutBtns.forEach(btn => {\n    btn.addEventListener('click', (e) => {\n      e.preventDefault();\n      logout();\n    });\n  });\n}\n\n/* ===================\n   PAGE INITIALIZATION\n   =================== */\n\n/**\n * Initialize common page functionality\n *\n * @param {Object} options - Configuration options\n * @param {boolean} options.serviceWorker - Register service worker (default: true)\n * @param {boolean} options.logout - Setup logout button (default: true)\n * @param {boolean} options.modalEscape - Close modals on Escape (default: true)\n * @param {boolean} options.csrfPreFetch - Pre-fetch CSRF token (default: true)\n *\n * @example\n * // In your page script:\n * import { initPage } from '/js/init.js';\n * initPage();\n */\nexport function initPage(options = {}) {\n  const {\n    serviceWorker = true,\n    logout = true,\n    modalEscape = true,\n    csrfPreFetch = true\n  } = options;\n\n  // Pre-fetch CSRF token to ensure it's ready before form submissions\n  if (csrfPreFetch) {\n    ensureCsrfToken().catch(err => console.warn('CSRF pre-fetch failed:', err));\n  }\n\n  // Register service worker\n  if (serviceWorker) {\n    registerServiceWorker();\n  }\n\n  // Setup logout button\n  if (logout) {\n    setupLogoutButton();\n  }\n\n  // Setup modal escape key\n  if (modalEscape) {\n    setupModalCloseOnEscape();\n  }\n\n  // Set Sentry user context from stored auth\n  try {\n    const stored = localStorage.getItem('user');\n    if (stored) setSentryUser(JSON.parse(stored));\n  } catch (_) { /* ignore parse errors */ }\n}\n\n/* ===================\n   URL HELPERS\n   =================== */\n\n/**\n * Redirect to a URL\n */\nexport function redirect(url) {\n  window.location.href = url;\n}\n\n/**\n * Get current page name\n */\nexport function getCurrentPage() {\n  const path = window.location.pathname;\n  const page = path.split('/').pop() || 'index.html';\n  return page;\n}\n"],"file":"init-10IUnAVO.js"}