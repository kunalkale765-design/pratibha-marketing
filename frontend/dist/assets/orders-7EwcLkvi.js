import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as d,c as o}from"./ui-Bns_kLia.js";import"./api-CCOw0EgE.js";const me=(t=1e4)=>new Promise((e,a)=>{const n=Date.now(),s=()=>{if(window.Auth)return e(window.Auth);if(Date.now()-n>t)return a(new Error("Auth not available"));setTimeout(s,50)};s()}),q=await me();let U=[];const x={};let ie=[],f=[],G="all",F=null,$=null,b=null,B={},E={},T=!1,se=!1,y=null,I=[];async function pe(){if(b=await q.requireAuth(),!!b){if(b.role==="customer"){const t=document.getElementById("modalFooter");t&&(t.style.display="none")}fe(),await Promise.all([j(),ve(),ye()]),he(),ke(),ge()}}function ge(){const t=new URLSearchParams(window.location.search),e=t.get("order"),a=t.get("action");e&&(window.history.replaceState({},"",window.location.pathname),a==="pack"?le(e):R(e))}function fe(){if(se)return;se=!0;const t=document.getElementById("ordersList");if(!t)return;document.addEventListener("click",r=>{r.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(c=>{c.classList.remove("swiped","swiped-single")})});let e={startX:0,isDragging:!1,currentItem:null};t.addEventListener("touchstart",r=>{const c=r.target.closest(".swipe-item");c&&(e={startX:r.touches[0].clientX,isDragging:!0,currentItem:c},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i!==c&&i.classList.remove("swiped","swiped-single")}))},{passive:!0}),t.addEventListener("touchmove",r=>{if(!e.isDragging||!e.currentItem)return;const c=e.startX-r.touches[0].clientX,i=e.currentItem.querySelectorAll(".swipe-action").length;c>50?(e.currentItem.classList.remove("swiped-single","swiped"),i===1?e.currentItem.classList.add("swiped-single"):e.currentItem.classList.add("swiped")):c<-20&&e.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),t.addEventListener("touchend",()=>{e.isDragging=!1,e.currentItem=null},{passive:!0});let a={startX:0,isDragging:!1,currentItem:null};t.addEventListener("mousedown",r=>{const c=r.target.closest(".swipe-item");c&&(r.target.closest("button")||(a={startX:r.clientX,isDragging:!0,currentItem:c},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i!==c&&i.classList.remove("swiped","swiped-single")})))}),t.addEventListener("mousemove",r=>{if(!a.isDragging||!a.currentItem)return;const c=a.startX-r.clientX,i=a.currentItem.querySelectorAll(".swipe-action").length;c>50?(a.currentItem.classList.remove("swiped-single","swiped"),i===1?a.currentItem.classList.add("swiped-single"):a.currentItem.classList.add("swiped")):c<-20&&a.currentItem.classList.remove("swiped","swiped-single")}),t.addEventListener("mouseup",()=>{a.isDragging=!1,a.currentItem=null}),t.addEventListener("mouseleave",()=>{a.isDragging=!1,a.currentItem=null});const n=document.getElementById("orderModal");n&&(n.onclick=r=>{r.target.id==="orderModal"&&V()});const s=document.getElementById("invoiceModal");s&&(s.onclick=r=>{r.target.id==="invoiceModal"&&te()})}async function ve(){try{const t=await fetch("/api/market-rates",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);((await t.json()).data||[]).forEach(a=>{const n=typeof a.product=="object"?a.product._id:a.product;x[n]=a.rate})}catch(t){console.error("Failed to load market rates:",t),re("market-rates","Market rates may be outdated")}}async function ye(){try{const t=await fetch("/api/products",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);ie=((await t.json()).data||[]).filter(a=>a.isActive!==!1)}catch(t){console.error("Failed to load products:",t),re("products","Product list unavailable")}}function re(t,e){if(document.querySelector(`.data-warning[data-type="${t}"]`))return;const a=o("div",{className:"data-warning",dataset:{type:t},style:{background:"var(--warning, #b89a5a)",color:"white",padding:"0.5rem 1rem",fontSize:"0.85rem",display:"flex",alignItems:"center",justifyContent:"space-between",gap:"0.5rem"}},[o("span",{},`⚠️ ${e}`),o("button",{style:{background:"transparent",border:"none",color:"white",cursor:"pointer",fontSize:"1rem",padding:"0 0.25rem"},onclick:s=>{s.target.closest(".data-warning").remove()}},"×")]),n=document.getElementById("ordersList");n&&n.parentElement&&n.parentElement.insertBefore(a,n)}async function j(){try{const t=await fetch("/api/orders?limit=100",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);const e=await t.json();if(!e.success)throw new Error(e.message||"Orders temporarily unavailable");U=e.data||[];const a=U.filter(n=>!n._id||!/^[a-f\d]{24}$/i.test(n._id));a.length>0&&console.warn("Orders with invalid IDs:",a.map(n=>({orderNumber:n.orderNumber,_id:n._id}))),W()}catch(t){if(console.error("Failed to load orders:",t),!U||U.length===0){const e=document.getElementById("ordersList"),a=navigator.onLine?"Orders not available":"No internet connection";e.innerHTML="",e.appendChild(o("div",{className:"empty-state"},[o("p",{},a),o("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:j},"Try Again")]))}}}function we(t){if(!t)return"?";const e=t.trim().split(/\s+/);return e.length===1?e[0].substring(0,2).toUpperCase():(e[0][0]+e[e.length-1][0]).toUpperCase()}function W(){const t=document.getElementById("ordersList");if(!t)return;const e=document.getElementById("searchInput"),a=e?e.value.toLowerCase():"",n=b?.role==="admin",s=b?.role==="admin"||b?.role==="staff";let r=U.filter(i=>i._id&&/^[a-f\d]{24}$/i.test(i._id));if(G==="all"?r=r.filter(i=>i.status!=="cancelled"):r=r.filter(i=>i.status===G),a&&(r=r.filter(i=>i.orderNumber?.toLowerCase().includes(a)||i.customer?.name?.toLowerCase().includes(a))),!r.length){t.innerHTML="",t.appendChild(o("div",{className:"empty-state"},"No orders found"));return}t.innerHTML="";const c=document.createDocumentFragment();r.forEach((i,p)=>{let m=null;i.batch?.batchType&&(m=o("span",{className:"badge badge-batch"},i.batch.batchType));let v=null;s&&i.status==="confirmed"&&(i.packingDone?v=o("span",{className:"packing-status-badge status-packed"},"✓ Packed"):v=o("span",{className:"packing-status-badge status-ready"},"Ready"));const w=o("div",{className:"swipe-content",onclick:()=>window.viewOrder(i._id)},[o("div",{className:"order-avatar"},we(i.customer?.name)),o("div",{className:"order-info"},[o("div",{className:"order-customer"},i.customer?.name||"Unknown"),i.notes?o("div",{className:"order-notes"},i.notes):null,o("div",{className:"order-meta-row"},[o("span",{className:"order-number"},`Order #${i.orderNumber}`),m,v])]),o("div",{className:"order-amount-pill"},`₹${(i.totalAmount||0).toLocaleString("en-IN")}`)]),u=[];s&&i.status==="confirmed"&&!i.packingDone&&u.push(o("button",{className:"swipe-action pack",onclick:P=>{P.stopPropagation(),window.openPackingPanel(i._id)}},"Pack")),s&&i.status==="confirmed"&&i.batch&&u.push(o("button",{className:"swipe-action bill",onclick:P=>{P.stopPropagation(),window.downloadDeliveryBill(i._id,i.batch?._id||i.batch)}},"Bill")),n&&u.push(o("button",{className:"swipe-action delete",onclick:P=>{P.stopPropagation(),window.deleteOrder(i._id)}},"Delete"));const M=o("div",{className:"swipe-actions"},u);let l="";u.length===1?l="single-action":u.length===2&&(l="two-actions");const g=o("div",{className:`swipe-item card-fade-in ${l}`.trim(),dataset:{orderId:i._id},style:{animationDelay:`${p*.05}s`}},[w,M]);c.appendChild(g)}),t.appendChild(c)}function he(){const t=document.getElementById("filterSegments"),e=document.getElementById("segmentIndicator"),a=t.querySelectorAll(".segment-btn");function n(r){const c=t.getBoundingClientRect(),i=r.getBoundingClientRect(),p=i.left-c.left,m=i.width;e.style.left=p+"px",e.style.width=m+"px"}const s=t.querySelector(".segment-btn.active");s&&setTimeout(()=>n(s),10),a.forEach(r=>{r.onclick=()=>{a.forEach(i=>i.classList.remove("active")),r.classList.add("active"),n(r),G=r.dataset.filter;const c=document.getElementById("ordersList");c.classList.add("segment-content"),W(),setTimeout(()=>c.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const r=t.querySelector(".segment-btn.active");r&&n(r)})}function be(t,e){let a;return function(...n){clearTimeout(a),a=setTimeout(()=>t.apply(this,n),e)}}function ke(){const t=document.getElementById("searchInput");if(t){const e=be(W,200);t.addEventListener("input",e)}}let L=null,D=null,S=new Set;async function Ie(t,e){if(b?.role==="customer"){d("Delivery bills are not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s.classList.remove("swiped","swiped-single")});const a=/^[a-f\d]{24}$/i.test(t),n=/^[a-f\d]{24}$/i.test(e);if(!t||!a||!e||!n){console.error("Invalid order or batch ID:",t,e),d("Order data updating. Please refresh.","info");return}d("Downloading delivery bill...","info");try{const s=await fetch(`/api/batches/${e}/bills/${t}/download?copy=original`,{credentials:"include"});if(!s.ok){const v=await s.json().catch(()=>({}));throw new Error(v.message||"Failed to download delivery bill")}const r=s.headers.get("Content-Disposition");let c="delivery-bill.pdf";if(r){const v=r.match(/filename="?([^";\n]+)"?/);v&&(c=v[1])}const i=await s.blob(),p=window.URL.createObjectURL(i),m=document.createElement("a");m.href=p,m.download=c,document.body.appendChild(m),m.click(),window.URL.revokeObjectURL(p),m.remove(),d("Delivery bill downloaded!","success")}catch(s){console.error("Error downloading delivery bill:",s),d(s.message||"Failed to download delivery bill","error")}}async function K(t){if(b?.role==="customer"){d("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s.classList.remove("swiped","swiped-single")});const e=/^[a-f\d]{24}$/i.test(t);if(!t||!e){console.error("Invalid order ID:",t),d("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const a=document.getElementById("invoiceModalBody");a.innerHTML="",a.appendChild(o("div",{className:"invoice-loading"},"Loading invoice data..."));const n=document.getElementById("generateInvoiceBtn");n&&(n.disabled=!0);try{if(!(await Ne()).success)throw new Error("Could not load firm list. Please try again.");const r=await fetch(`/api/invoices/${t}/split`,{credentials:"include"});if(!r.ok){const i=await r.json().catch(()=>({}));throw new Error(i.message||"Invoice data temporarily unavailable")}L=(await r.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${L.orderNumber}`,ee()}catch(s){console.error("Print order error:",s),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(o("div",{className:"invoice-no-items"},[o("p",{},"Invoice data not available"),o("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},s.message)]))}}let Q=[];async function Ne(){if(Q.length>0)return{success:!0};try{const t=await fetch("/api/invoices/firms",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);return Q=(await t.json()).data||[],{success:!0}}catch(t){return console.error("Failed to load firms:",t),{success:!1,error:t.message}}}function ee(){const t=document.getElementById("invoiceModalBody");if(!L){t.innerHTML="",t.appendChild(o("div",{className:"invoice-no-items"},"No items to invoice"));return}const e=L.firms.flatMap(i=>i.items);if(e.length===0){t.innerHTML="",t.appendChild(o("div",{className:"invoice-no-items"},"No items to invoice"));return}D||(D=Q.length>0?Q[0].id:L?.firms?.[0]?.firmId||"pratibha",S=new Set(e.map(i=>i.productId)));const a=e.filter(i=>S.has(i.productId)).reduce((i,p)=>i+(p.amount||0),0),n=Q.length>0?Q:(L?.firms||[]).map(i=>({id:i.firmId,name:i.firmName}));t.innerHTML="";const s=document.createDocumentFragment(),r=o("div",{className:"invoice-firm-selector"},[o("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),o("div",{className:"firm-options"},n.map(i=>o("label",{className:`firm-option ${D===i.id?"selected":""}`,onclick:()=>window.selectFirm(i.id)},[o("input",{type:"radio",name:"firm",value:i.id,checked:D===i.id}),o("span",{className:"firm-option-name"},i.name)])))]);s.appendChild(r),s.appendChild(o("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),s.appendChild(o("div",{className:"invoice-items-list"},e.map(i=>o("div",{className:"invoice-item"},[o("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:i.productId},checked:S.has(i.productId),onchange:()=>window.toggleInvoiceItem(null,i.productId)}),o("div",{className:"invoice-item-details"},[o("div",{className:"invoice-item-name"},i.productName),o("div",{className:"invoice-item-meta"},`${i.quantity||0} ${i.unit||""} × ₹${(i.rate||0).toLocaleString("en-IN")}`)]),o("div",{className:"invoice-item-amount"},`₹${(i.amount||0).toLocaleString("en-IN")}`)])))),s.appendChild(o("div",{className:"invoice-summary"},[o("div",{className:"invoice-summary-label"},"Total"),o("div",{className:"invoice-summary-total"},`₹${a.toLocaleString("en-IN")}`)])),t.appendChild(s);const c=document.getElementById("generateInvoiceBtn");c&&(c.disabled=S.size===0)}function Ce(t){D=t,ee()}function Ee(t,e){S.has(e)?S.delete(e):S.add(e),ee()}async function Pe(){if(!L||!D||S.size===0)return;const t=document.getElementById("generateInvoiceBtn");t.classList.add("btn-loading"),t.disabled=!0;try{const e={"Content-Type":"application/json"},a=await q.ensureCsrfToken();a&&(e["X-CSRF-Token"]=a);const n=await fetch(`/api/invoices/${L.orderId}/pdf`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({firmId:D,productIds:Array.from(S)})});if(!n.ok){const i=await n.json().catch(()=>({}));throw new Error(i.message||"Invoice generation temporarily unavailable")}const s=await n.blob(),r=URL.createObjectURL(s),c=document.createElement("a");c.href=r,c.download=`INV${L.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r),d("Invoice downloaded","success"),te()}catch(e){console.error("Generate invoice error:",e),d(e.message||"Could not generate invoice","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}}function te(){document.getElementById("invoiceModal").classList.remove("show"),L=null,D=null,S=new Set}function $e(){if(!F)return;const t=F;V(),K(t)}async function Be(t){if(b?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const e=document.querySelector(`.swipe-item[data-order-id="${t}"]`);try{const a={"Content-Type":"application/json"},n=await q.ensureCsrfToken();n&&(a["X-CSRF-Token"]=n);const s=await fetch(`/api/orders/${t}`,{method:"DELETE",headers:a,credentials:"include"});if(s.ok)e?(e.classList.add("deleting"),setTimeout(()=>{j()},300)):j(),d("Order cancelled","success");else{const r=await s.json().catch(()=>({message:"Could not cancel. Try again."}));d(r.message||"Could not cancel","info")}}catch(a){console.error("Delete order error:",a),d("Could not delete order","info")}}async function R(t){if(T){d("Please wait, saving in progress...","info");return}try{const e=await fetch(`/api/orders/${t}`,{credentials:"include"});let a;try{a=await e.json()}catch(l){console.error("Failed to parse order response:",l),d("Server issue. Please refresh.","info");return}if(!e.ok){d(a?.message||"Could not load order","info");return}const n=a.data;if(!n||!n.products){d("Order data updating. Refresh page.","info");return}F=t,$=n,B={},E={},f=[];const s=document.getElementById("modalTitle");s&&(s.textContent=`#${n.orderNumber}`);const r=document.getElementById("savePricesBtn");r&&(r.disabled=!0);const c=b.role==="admin"||b.role==="staff",i=n.batch?.batchType?`<span class="badge badge-batch">${n.batch.batchType}</span>`:"-",p=document.getElementById("modalBody");p.innerHTML="";const m=document.createDocumentFragment(),v=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Customer"),o("div",{className:"info-value"},n.customer?.name||"")]),o("div",{},[o("div",{className:"info-label"},"Phone"),o("div",{className:"info-value"},n.customer?.phone||"-")])]);m.appendChild(v);const w=n.batch?.batchType?o("span",{className:"badge badge-batch"},n.batch.batchType):"-",u=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Date"),o("div",{className:"info-value"},new Date(n.createdAt).toLocaleDateString("en-IN"))]),o("div",{},[o("div",{className:"info-label"},"Batch"),o("div",{className:"info-value"},Array.isArray(w)?w:[w])])]);m.appendChild(u);const h=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Status"),o("div",{className:"info-value"},[o("span",{className:`badge badge-${n.status}`},n.status)])]),o("div",{})]);m.appendChild(h);const N=o("div",{className:"info-section"});if(N.appendChild(o("div",{className:"info-label"},"Products")),n.products.forEach((l,g)=>{const P=typeof l.product=="object"?l.product._id:l.product,k=x[P]||l.rate||null,C=k?`₹${k.toLocaleString("en-IN")}`:"N/A";let z;if(c){const _=o("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${g}`,value:l.quantity,min:"0",step:"0.01",dataset:{idx:g,original:l.quantity,unit:l.unit},onfocus:O=>window.clearZero(O.target),onblur:O=>window.restoreValue(O.target),onchange:()=>window.handleQuantityChange(g),oninput:()=>window.handleQuantityInput(g)});z=o("div",{className:"qty-controls-inline"},[o("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(g,-1)},"−"),_,o("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(g,1)},"+"),o("span",{className:"qty-unit"},l.unit)])}else z=o("div",{className:"product-qty"},`${l.quantity} ${l.unit}`);const J=["Selling"];l.isContractPrice&&(J.push(" "),J.push(o("span",{className:"contract-badge"},"Fixed")));let Z;if(c){const _=o("input",{type:"number",className:`price-input input-animated${l.isContractPrice?" contract-locked":""}`,id:`price-${g}`,value:l.rate,min:"0",step:"0.01",dataset:{idx:g,original:l.rate,qty:l.quantity,contract:l.isContractPrice||!1},onfocus:O=>window.clearZero(O.target),onblur:O=>window.restoreValue(O.target),onchange:()=>window.handlePriceChange(g),oninput:()=>window.handlePriceInput(g)});l.isContractPrice&&(_.disabled=!0,_.title="Contract price - edit in customer management"),Z=_}else Z=o("div",{className:"price-value"},`₹${l.rate}`);const ue=o("div",{className:"product-item",dataset:{idx:g}},[o("div",{className:"product-top"},[o("div",{},[o("div",{className:"product-name"},l.productName),z])]),o("div",{className:"prices-container"},[o("div",{className:"price-box"},[o("div",{className:"price-label"},"Purchase"),o("div",{className:"price-value"},C)]),o("div",{className:"price-box"},[o("div",{className:"price-label"},J),Z])]),o("div",{className:"amount-row"},[o("span",{className:"amount-label"},"Amount"),o("span",{className:"amount-display",id:`amount-${g}`},`₹${l.amount}`)])]);N.appendChild(ue)}),N.appendChild(o("div",{id:"addedProductsContainer"})),c){const l=[o("option",{value:""},"+ Add Product...")];ie.filter(k=>!n.products.some(C=>(typeof C.product=="object"?C.product._id:C.product)===k._id)).forEach(k=>{l.push(o("option",{value:k._id,dataset:{name:k.name,unit:k.unit}},`${k.name} (${k.unit})`))});const g=o("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},l),P=o("div",{className:"add-product-section"},[g]);N.appendChild(P)}m.appendChild(N);const M=o("div",{className:"total-section"},[o("div",{className:"total-row"},[o("span",{},"Total"),o("span",{id:"orderTotal"},`₹${n.totalAmount}`)]),o("div",{className:"total-row"},[o("span",{},"Paid"),o("span",{},`₹${n.paidAmount||0}`)]),o("div",{className:"total-row main"},[o("span",{},"Balance"),o("span",{id:"orderBalance"},`₹${n.totalAmount-(n.paidAmount||0)}`)])]);if(m.appendChild(M),p.appendChild(m),c){const l=document.getElementById("modalFooter");if(l){l.innerHTML="";const g=o("button",{className:"btn-modal secondary btn-animated",onclick:()=>window.printFromModal()},o("span",{className:"btn-text"},"Invoice"));if(l.appendChild(g),n.status==="pending"){const C=o("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--dusty-olive)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"confirmed")},"Confirm Order");l.appendChild(C)}else if(n.status==="confirmed"&&n.packingDone){const C=o("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--gunmetal)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(n._id,"delivered")},"Mark Delivered");l.appendChild(C)}if(n.status==="confirmed"&&!n.packingDone){const C=o("button",{className:"btn-modal secondary btn-animated",style:{background:"var(--dusty-olive)",color:"white",border:"none"},onclick:()=>{window.closeModal(),setTimeout(()=>window.openPackingPanel(n._id),200)}},"Start Packing");l.appendChild(C)}const k=o("button",{className:"btn-save-prices btn-animated",id:"savePricesBtn",disabled:!0,onclick:()=>window.savePrices()},o("span",{className:"btn-text"},"Save"));l.appendChild(k)}}document.getElementById("orderModal").classList.add("show")}catch(e){console.error("Error in viewOrder:",e),navigator.onLine?e.message?.includes("401")||e.message?.includes("403")?(d("Session expired. Please log in again.","error"),setTimeout(()=>{window.location.href="/login.html"},1500)):e.message?.includes("404")?d("Order not found. It may have been deleted.","error"):e.message?.includes("500")?d("Server error. Please try again in a moment.","error"):d("Could not load order. Please try again.","info"):d("No internet connection. Check your network.","error")}}function Le(t){t.dataset.prevValue=t.value,t.value="",t.select()}function Se(t){t.value===""&&(t.value=t.dataset.prevValue||t.dataset.original);const e=parseInt(t.dataset.idx);ce(e)}function Te(t){const e=document.getElementById(`price-${t}`),a=document.getElementById(`quantity-${t}`),n=parseFloat(e.dataset.original),s=parseFloat(e.value)||0,r=a?parseFloat(a.value)||0:parseFloat(e.dataset.qty);e.classList.toggle("changed",s!==n);const c=Math.round(s*r*100)/100,i=document.getElementById(`amount-${t}`);i&&(i.textContent=`₹${c.toLocaleString("en-IN")}`),A()}function ce(t){const e=document.getElementById(`price-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),n=parseFloat(e.value)||0;n!==a&&n>0?B[t]=n:delete B[t],H()}function qe(t,e){const a=document.getElementById(`quantity-${t}`);if(!a)return;let s=(parseFloat(a.value)||0)+e;s<.01&&s>0&&(s=0),s<0&&(s=0),a.value=s,de(t),ne(t)}function ne(t){const e=document.getElementById(`quantity-${t}`),a=document.getElementById(`price-${t}`);if(!e)return;const n=parseFloat(e.dataset.original),s=parseFloat(e.value)||0;e.classList.remove("changed","removed"),s===0?e.classList.add("removed"):s!==n&&e.classList.add("changed");const r=a?parseFloat(a.value)||0:$?.products[t]?.rate||0,c=Math.round(s*r*100)/100,i=document.getElementById(`amount-${t}`);i&&(i.textContent=`₹${c.toLocaleString("en-IN")}`),A()}function de(t){const e=document.getElementById(`quantity-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),n=parseFloat(e.value)||0,s=.01;n>0&&n<s?(d(`Minimum quantity: ${s} ${e.dataset.unit}`,"info"),e.value=a,delete E[t]):n!==a?E[t]=n:delete E[t],H(),ne(t)}function H(){const t=Object.keys(B).length>0||Object.keys(E).length>0||f.length>0,e=document.getElementById("savePricesBtn");e&&(e.disabled=!t)}function Ae(){const t=document.getElementById("productSelector"),e=t.value;if(!e)return;const a=t.options[t.selectedIndex],n=a.dataset.name,s=a.dataset.unit,r=x[e]||0;f.push({product:e,productName:n,unit:s,quantity:1,rate:r}),a.remove(),ae(),A(),H(),t.value=""}function ae(){const t=document.getElementById("addedProductsContainer");if(!t)return;t.innerHTML="";const e=document.createDocumentFragment();f.forEach((a,n)=>{const s=o("div",{className:"product-item added-product",dataset:{addedIdx:n}},[o("div",{className:"product-top"},[o("div",{},[o("div",{className:"product-name"},[a.productName," ",o("span",{className:"new-badge"},"New")]),o("div",{className:"qty-controls-inline"},[o("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,-1),type:"button"},"−"),o("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${n}`,value:a.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(n),oninput:()=>window.handleAddedQtyInput(n)}),o("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(n,1),type:"button"},"+"),o("span",{className:"qty-unit"},a.unit)])]),o("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(n),title:"Remove"},"×")]),o("div",{className:"prices-container"},[o("div",{className:"price-box"},[o("div",{className:"price-label"},"Purchase"),o("div",{className:"price-value"},a.rate?`₹${a.rate.toLocaleString("en-IN")}`:"N/A")]),o("div",{className:"price-box"},[o("div",{className:"price-label"},"Selling"),o("input",{type:"number",className:"price-input input-animated",id:`added-price-${n}`,value:a.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(n)})])]),o("div",{className:"amount-row"},[o("span",{className:"amount-label"},"Amount"),o("span",{className:"amount-display",id:`added-amount-${n}`},`₹${((a.rate||0)*(a.quantity||0)).toLocaleString("en-IN")}`)])]);e.appendChild(s)}),t.appendChild(e)}function Fe(t,e){const a=document.getElementById(`added-qty-${t}`);if(!a)return;let n=parseFloat(a.value)||0;n=Math.max(0,n+e),n>0&&n<.01&&(n=.01),a.value=n,f[t].quantity=n,X(t),A()}function De(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;let a=parseFloat(e.value)||0;a>0&&a<.01&&(d("Minimum quantity: 0.01","info"),a=.01,e.value=a),f[t].quantity=a,X(t),A()}function Me(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;const a=parseFloat(e.value)||0;f[t].quantity=a,X(t),A()}function Oe(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const a=parseFloat(e.value)||0;f[t].rate=a,X(t),A()}function je(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const a=parseFloat(e.value)||0;f[t].rate=a,X(t),A()}function X(t){const e=document.getElementById(`added-amount-${t}`);if(!e)return;const a=f[t],n=(a.quantity||0)*(a.rate||0);e.textContent=`₹${n.toLocaleString("en-IN")}`}function Qe(t){const e=f.splice(t,1)[0],a=document.getElementById("productSelector");if(a&&e){const n=document.createElement("option");n.value=e.product,n.dataset.name=e.productName,n.dataset.unit=e.unit,n.textContent=`${e.productName} (${e.unit})`,a.appendChild(n)}ae(),A(),H()}function A(){if(!$||!$.products)return;let t=0;$.products.forEach((s,r)=>{const c=document.getElementById(`price-${r}`),i=document.getElementById(`quantity-${r}`),p=c?parseFloat(c.value)||0:s.rate,m=i?parseFloat(i.value)||0:s.quantity;t+=p*m}),f.forEach(s=>{t+=(s.quantity||0)*(s.rate||0)}),t=Math.round(t*100)/100;const e=Math.round((t-($.paidAmount||0))*100)/100,a=document.getElementById("orderTotal"),n=document.getElementById("orderBalance");a&&(a.textContent=`₹${t.toLocaleString("en-IN")}`),n&&(n.textContent=`₹${e.toLocaleString("en-IN")}`)}async function Re(t){try{const e=await fetch(`/api/invoices/order/${t}`,{credentials:"include"});if(!e.ok)return e.status===401||e.status===403?{exists:!1,error:"auth"}:{exists:!1,error:`Server returned ${e.status}`};const a=await e.json();return{exists:a.data&&a.data.length>0}}catch(e){return console.error("Failed to check invoices:",e),{exists:!1,error:e.message}}}async function _e(){const t=Object.keys(B).length>0||Object.keys(E).length>0||f.length>0;if(!F||!$||!$.products||!t)return;if(T){d("Save in progress...","info");return}T=!0;const e=document.getElementById("savePricesBtn");e&&(e.disabled=!0,e.classList.add("btn-loading"));let a=!1;const n=await Re(F);if(n.error){if(!confirm(`Could not check if invoices exist for this order.

If invoices exist, they may need to be regenerated after saving. Continue?`)){T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else if(n.exists&&(a=!0,!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`))){T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}try{const s=$.products.map((u,h)=>{let N=B[h]!==void 0?B[h]:u.rate,M=E[h]!==void 0?E[h]:u.quantity;return(!N||N<=0)&&(N=u.rate),M<0&&(M=u.quantity),{product:typeof u.product=="object"?u.product._id:u.product,quantity:M,priceAtTime:N}}).filter(u=>u.quantity>0),r=f.filter(u=>u.quantity>0).map(u=>({product:u.product,quantity:u.quantity,priceAtTime:u.rate})),c=[...s,...r],i={"Content-Type":"application/json"},p=await q.ensureCsrfToken();p&&(i["X-CSRF-Token"]=p);const m={products:c},v=F;let w=await fetch(`/api/orders/${v}`,{method:"PUT",headers:i,credentials:"include",body:JSON.stringify(m)});if(w.status===403){let u;try{u=await w.json()}catch(h){console.warn("Failed to parse CSRF error response:",h.message),u={message:`Access denied (code: ${w.status})`}}if(u.message?.toLowerCase().includes("csrf")){const h=await q.refreshCsrfToken();if(h){if(i["X-CSRF-Token"]=h,w=await fetch(`/api/orders/${v}`,{method:"PUT",headers:i,credentials:"include",body:JSON.stringify(m)}),w.status===403){d("Session expired. Please refresh the page.","info"),T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{d("Session expired. Please refresh the page.","info"),T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{d(u.message||"Access temporarily unavailable","info"),T=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}if(w.ok)d("Changes saved","success"),B={},E={},f=[],e&&(e.classList.remove("btn-loading"),e.classList.add("btn-success"),setTimeout(()=>e.classList.remove("btn-success"),1500),e.disabled=!0),j(),a&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const u=v;V(),setTimeout(()=>K(u),300)}},500),F===v&&R(v);else{let u;try{u=await w.json()}catch(h){console.warn("Failed to parse order save error response:",h.message),u={message:`Server error (${w.status})`}}d(u.message||"Could not update","info"),e&&(e.disabled=!1)}}catch(s){console.error("Save changes error:",s),navigator.onLine?d("Could not save. Try again.","info"):d("No internet connection","info"),e&&(e.disabled=!1)}finally{T=!1,e&&e.classList.remove("btn-loading")}}function V(){if((Object.keys(B).length>0||Object.keys(E).length>0||f.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const e=document.getElementById("orderModal");e&&e.classList.remove("show"),F=null,$=null,B={},E={},f=[]}window.closeModal=V;window.viewOrder=R;window.clearZero=Le;window.restoreValue=Se;window.handlePriceChange=ce;window.handlePriceInput=Te;window.handleQuantityChange=de;window.handleQuantityInput=ne;window.changeQuantity=qe;window.savePrices=_e;window.deleteOrder=Be;window.printOrder=K;window.downloadDeliveryBill=Ie;window.closeInvoiceModal=te;window.selectFirm=Ce;window.toggleInvoiceItem=Ee;window.generateInvoice=Pe;window.printFromModal=$e;window.addProductToOrder=Ae;window.renderAddedProducts=ae;window.changeAddedQty=Fe;window.handleAddedQtyChange=De;window.handleAddedQtyInput=Me;window.handleAddedPriceChange=Oe;window.handleAddedPriceInput=je;window.removeAddedProduct=Qe;async function Ue(t,e){if(!(!b||b.role!=="admin"&&b.role!=="staff"))try{const a={"Content-Type":"application/json"},n=await q.ensureCsrfToken();n&&(a["X-CSRF-Token"]=n);const s=await fetch(`/api/orders/${t}/status`,{method:"PUT",headers:a,credentials:"include",body:JSON.stringify({status:e})}),r=await s.json();s.ok?(d(`Order marked as ${e}`,"success"),R(t),j()):(d(r.message||"Failed to update status","error"),R(t))}catch(a){console.error("Status update error:",a),d("Network error updating status","error"),R(t)}}window.updateOrderStatus=Ue;async function le(t){const e=document.getElementById("packingPanel"),a=document.getElementById("packingPanelOverlay");if(!(!e||!a)){document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(n=>{n.classList.remove("swiped","swiped-single")}),e.classList.add("active"),a.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("packingPanelBody").innerHTML='<div class="packing-loading">Loading order...</div>',document.getElementById("packingCompleteBtn").disabled=!0;try{const n=await fetch(`/api/packing/${t}`,{credentials:"include"});if(!n.ok)throw new Error("Failed to load order");y=(await n.json()).data,I=y.items||[],Y()}catch(n){console.error("Error loading packing order:",n),d("Failed to load order details","error"),oe()}}}function Y(){document.getElementById("packingPanelTitle").textContent=`Pack ${y.orderNumber}`,document.getElementById("packingPanelSubtitle").textContent=`${y.customer?.name||"Unknown"} • ${y.customer?.phone||""}`,ze();const t=document.getElementById("packingPanelBody");let e="";(y.deliveryAddress||y.notes)&&(e='<div class="packing-order-details">',y.deliveryAddress&&(e+=`
                <div class="packing-delivery-info">
                    <span class="packing-label">Deliver to</span>
                    <span class="packing-value">${y.deliveryAddress}</span>
                </div>`),y.notes&&(e+=`
                <div class="packing-order-notes">
                    <span class="packing-label">Notes</span>
                    <span class="packing-value">${y.notes}</span>
                </div>`),e+="</div>");const a=I.map((r,c)=>{const i=r.packedQuantity??r.orderedQuantity,p=r.packedQuantity!==void 0&&r.packedQuantity!==r.orderedQuantity,m=r.packed||!1;return`
            <div class="packing-checklist-item ${m?"item-packed":""} ${p?"item-modified":""}" data-index="${c}" data-product-id="${r.product}">
                <div class="packing-item-main">
                    <div class="packing-item-check ${m?"checked":""}" onclick="togglePackedItem(${c})">
                        ${m?"✓":""}
                    </div>
                    <div class="packing-item-details">
                        <span class="packing-item-name">${r.productName}</span>
                        <span class="packing-item-qty">Ordered: ${r.orderedQuantity} ${r.unit}</span>
                    </div>
                </div>
                <div class="packing-item-input">
                    <input type="number"
                        class="packing-qty-input ${p?"modified":""}"
                        value="${i}"
                        data-index="${c}"
                        data-original="${r.orderedQuantity}"
                        step="0.01"
                        min="0"
                        onchange="handlePackingQtyChange(${c})"
                    >
                    <span class="packing-unit-label">${r.unit}</span>
                </div>
            </div>
        `}).join("");t.innerHTML=`
        ${e}
        <div class="packing-checklist-header">
            <span>Items to Pack</span>
        </div>
        <div class="packing-checklist">
            ${a}
        </div>
    `;const n=document.getElementById("packingPanelAcknowledgement");n&&(n.style.display="none");const s=document.getElementById("packingPanelIssues");s&&(s.style.display="none"),Je()}async function Xe(t){const e=I[t],a=!e.packed;e.packed=a,Y();try{const n=await q.ensureCsrfToken(),s=await fetch(`/api/packing/${y._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":n},credentials:"include",body:JSON.stringify({packed:a})});if(!s.ok){const c=(await s.json().catch(()=>({}))).message||`Server error (${s.status})`;throw new Error(c)}}catch(n){console.error("Error toggling packed status:",n),e.packed=!a,Y(),navigator.onLine?n.message?.includes("401")||n.message?.includes("403")||n.message?.includes("auth")?d("Session expired. Please refresh the page.","error"):n.message?.includes("404")?d("Order not found. It may have been modified.","error"):d(`Update failed: ${n.message}`,"error"):d("No connection. Check internet and retry.","error")}}async function He(t){const e=document.querySelector(`.packing-qty-input[data-index="${t}"]`),a=parseFloat(e?.value)||0,n=parseFloat(e?.dataset.original)||0,s=I[t].packedQuantity;I[t].packedQuantity=a,e.classList.toggle("modified",a!==n);const r=e.closest(".packing-checklist-item");r&&r.classList.toggle("item-modified",a!==n),(await Ve(t)).success||(I[t].packedQuantity=s,e.value=s??n,e.classList.toggle("modified",(s??n)!==n),r&&r.classList.toggle("item-modified",(s??n)!==n))}async function Ve(t){const e=I[t];try{const a=await q.ensureCsrfToken(),n=await fetch(`/api/packing/${y._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":a},credentials:"include",body:JSON.stringify({quantity:e.packedQuantity})});if(!n.ok){const s=await n.json().catch(()=>({}));throw new Error(s.message||`Server error (${n.status})`)}return{success:!0}}catch(a){console.error("Error saving packing item:",a);let n="Failed to save changes";return navigator.onLine?(a.message?.includes("401")||a.message?.includes("403"))&&(n="Session expired. Please refresh."):n="No connection. Changes not saved.",d(n,"error"),{success:!1,error:a.message}}}function ze(){const t=I.length,e=I.filter(n=>n.packed).length,a=t>0?Math.round(e/t*100):0;document.getElementById("packingProgressFill").style.width=`${a}%`,document.getElementById("packingProgressText").textContent=`${e}/${t} items packed`}function Je(){const t=document.getElementById("packingCompleteBtn");if(t){const e=I.length,a=I.filter(s=>s.packed).length,n=a===e&&e>0;if(t.disabled=!n,!n&&e>0){const s=e-a;t.title=`${s} item(s) remaining`}else t.title=""}}async function Ze(){const t=document.getElementById("packingCompleteBtn");t.disabled=!0,t.innerHTML='<span class="btn-text">Completing...</span>';try{const e=await q.ensureCsrfToken(),a=await fetch(`/api/packing/${y._id}/done`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include"});if(!a.ok){const n=await a.json();throw new Error(n.message||"Failed to complete packing")}d("Packing completed!","success"),oe(),await j()}catch(e){console.error("Error completing packing:",e),d(e.message||"Failed to complete packing","error"),t.disabled=!1,t.innerHTML='<span class="btn-text">Mark Done</span>'}}function oe(){const t=document.getElementById("packingPanel"),e=document.getElementById("packingPanelOverlay");t.classList.remove("active"),e.classList.remove("active"),document.body.style.overflow="",y=null,I=[]}window.openPackingPanel=le;window.closePackingPanel=oe;window.handlePackingQtyChange=He;window.completePackingSession=Ze;window.togglePackedItem=Xe;pe();
