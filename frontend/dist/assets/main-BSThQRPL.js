import{s as b,c as n}from"./ui-Usu6AxiT.js";/* empty css             *//* empty css                */import{i as U,l as _}from"./init-DAk7Tmy7.js";function I(e,t=!0){if(e==null||isNaN(e))return t?"â‚¹0":"0";const i=Number(e).toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2});return t?`â‚¹${i}`:i}const O=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(O()),10)}),E=await O();U();let v=[],T=[],x=[],C={};const R=document.getElementById("logoutBtn"),P=document.getElementById("printBtn"),A=document.getElementById("exportBtn"),y=document.getElementById("saveRatesBtn");document.getElementById("saveRatesBtn");R&&R.addEventListener("click",_);P&&P.addEventListener("click",V);A&&A.addEventListener("click",X);y&&y.addEventListener("click",z);async function S(){try{const[e,t,i,d,s]=await Promise.all([fetch("/api/orders",{credentials:"include"}),fetch("/api/customers",{credentials:"include"}),fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/supplier/quantity-summary",{credentials:"include"})]),m=await e.json(),c=await t.json(),p=await i.json(),r=await d.json(),o=await s.json();v=p.data||[],T=r.data||[],x=o.data||[];const u=m.data||[],g=u.filter(f=>f.status==="delivered"||f.paymentStatus==="paid").reduce((f,B)=>f+(B.totalAmount||0),0),l=g*.15;document.getElementById("totalSale").textContent=I(g),document.getElementById("totalProfit").textContent=I(l),Q(),W(u)}catch(e){console.error("Error loading dashboard stats:",e),document.getElementById("totalSale").textContent="â€”",document.getElementById("totalProfit").textContent="â€”",document.getElementById("procurementList").innerHTML="",document.getElementById("procurementList").appendChild(n("div",{className:"empty-state"},[n("p",{},"Data not available"),n("button",{id:"retryBtn",className:"btn-retry",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:S},"Try Again")]))}}function Q(){const e=document.getElementById("procurementList");if(e.innerHTML="",!v||v.length===0){e.appendChild(n("div",{className:"empty-state"},"No products available"));return}const t={};T.forEach(r=>{t[r.product]=r});const i={};x.forEach(r=>{i[r.productName]=r});const s=[...v.filter(r=>r.category==="Indian Vegetables"||r.category==="Fruits")].sort((r,o)=>{if(r.category==="Indian Vegetables"&&o.category==="Fruits")return-1;if(r.category==="Fruits"&&o.category==="Indian Vegetables")return 1;const u=t[r._id]?.rate||0,g=t[o._id]?.rate||0;if(u===0&&g!==0)return-1;if(u!==0&&g===0)return 1;const a=i[r.name]?.totalQuantity||0;return(i[o.name]?.totalQuantity||0)-a}),m=document.createDocumentFragment(),c=n("div",{className:"procurement-column-header"},[n("span",{className:"col-expand"}),n("span",{className:"col-name"},"Product"),n("span",{className:"col-qty"},"Purchase Qty"),n("span",{className:"col-input"},"Purchase Price")]);m.appendChild(c);let p="";s.forEach(r=>{const o=t[r._id],u=o?o.rate:0,g=o?o.trend:"stable",a=i[r.name],l=a?a.totalQuantity:0,f=a?a.orderCount:0,B=l>0?l*u:0,M=l>0?"item-qty":"item-qty zero",$=g==="up"?"â†‘ Up":g==="down"?"â†“ Down":"â€” Stable",q=u===0?" unsaved":"";r.category!==p&&(p=r.category,m.appendChild(n("div",{className:"category-divider"},p)));const H=n("div",{className:`procurement-item${q}`,dataset:{productId:r._id}},[n("div",{className:"item-main",onclick:w=>window.toggleExpand(w.currentTarget)},[n("span",{className:"item-expand"},"â–¶"),n("span",{className:"item-name"},r.name),n("span",{className:M},l),n("span",{className:"item-unit"},r.unit),n("input",{type:"number",className:"item-rate-input",dataset:{productId:r._id,productName:r.name,currentRate:u},placeholder:`â‚¹${u.toFixed(0)}`,step:"0.01",min:"0",onclick:w=>w.stopPropagation(),onchange:w=>window.handleRateChange(w.target),oninput:w=>window.handleRateInput(w.target)})]),n("div",{className:"item-details"},[n("div",{className:"detail-row"},[n("span",{className:"detail-label"},"Current Rate"),n("span",{className:"detail-value"},`â‚¹${u.toFixed(2)}/${r.unit}`)]),n("div",{className:"detail-row"},[n("span",{className:"detail-label"},"Orders"),n("span",{className:"detail-value"},f)]),n("div",{className:"detail-row"},[n("span",{className:"detail-label"},"Est. Cost"),n("span",{className:"detail-value highlight"},B>0?I(B):"-")]),n("div",{className:"detail-row"},[n("span",{className:"detail-label"},"Trend"),n("span",{className:"detail-value"},$)])])]);m.appendChild(H)}),e.appendChild(m)}window.toggleExpand=function(e){e.closest(".procurement-item").classList.toggle("expanded")};window.handleRateInput=function(e){const t=parseFloat(e.dataset.currentRate),i=parseFloat(e.value);e.classList.toggle("changed",e.value&&i!==t)};window.handleRateChange=function(e){const t=e.dataset.productId,i=e.dataset.productName,d=parseFloat(e.dataset.currentRate),s=parseFloat(e.value);e.value&&s!==d&&s>0?(C[t]={product:t,productName:i,rate:s,previousRate:d},e.classList.add("changed")):(delete C[t],e.classList.remove("changed")),y&&y.classList.toggle("show",Object.keys(C).length>0)};function V(){const e=document.getElementById("procurementList").innerHTML,t=window.open("","_blank");t.document.write(`
        <html>
        <head>
            <title>Purchase List - Pratibha Marketing</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { font-size: 18px; margin-bottom: 10px; }
                .date { color: #666; margin-bottom: 20px; }
                .item { padding: 10px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; }
                .item-name { font-weight: bold; }
                .item-qty { font-family: monospace; }
                .item-details, .item-expand, .item-rate-input, button { display: none !important; }
            </style>
        </head>
        <body>
            <h1>Purchase List - Pratibha Marketing</h1>
            <div class="date">${new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>
            ${e}
        </body>
        </html>
    `),t.document.close(),t.print()}function X(){const e={};T.forEach(o=>{const u=typeof o.product=="object"?o.product._id:o.product;e[u]=o});const t={};x.forEach(o=>{t[o.productName]=o});const i=v.filter(o=>o.category==="Indian Vegetables"||o.category==="Fruits").sort((o,u)=>{if(o.category==="Indian Vegetables"&&u.category==="Fruits")return-1;if(o.category==="Fruits"&&u.category==="Indian Vegetables")return 1;const g=e[o._id]?.rate||0,a=e[u._id]?.rate||0;if(g===0&&a!==0)return-1;if(g!==0&&a===0)return 1;const l=t[o.name]?.totalQuantity||0;return(t[u.name]?.totalQuantity||0)-l}),d=["Category","Product","Unit","Qty Needed","Current Rate","Est. Cost"],s=i.map(o=>{const g=t[o.name]?.totalQuantity||0,a=e[o._id],l=a?a.rate:0,f=g*l;return[`"${o.category}"`,`"${o.name}"`,o.unit,g,l,f.toFixed(2)].join(",")}),m=[d.join(","),...s].join(`
`),c=new Blob([m],{type:"text/csv"}),p=window.URL.createObjectURL(c),r=document.createElement("a");r.href=p,r.download=`purchase-list-${new Date().toISOString().split("T")[0]}.csv`,r.click(),window.URL.revokeObjectURL(p)}async function z(){if(!y)return;y.textContent="Saving...",y.disabled=!0;const e=[],t=[],i={"Content-Type":"application/json"};let d=await E.ensureCsrfToken();d&&(i["X-CSRF-Token"]=d);for(const[s,m]of Object.entries(C))try{let c=await fetch("/api/market-rates",{method:"POST",headers:i,credentials:"include",body:JSON.stringify({product:m.product,rate:m.rate,effectiveDate:new Date().toISOString()})});if(c.status===403){const p=await c.json().catch(()=>({}));if(p.message?.toLowerCase().includes("csrf"))d=await E.refreshCsrfToken(),d&&(i["X-CSRF-Token"]=d,c=await fetch("/api/market-rates",{method:"POST",headers:i,credentials:"include",body:JSON.stringify({product:m.product,rate:m.rate,effectiveDate:new Date().toISOString()})}));else{e.push({productName:m.productName||s,error:p.message||`HTTP ${c.status}`});continue}}if(c.ok)t.push(s);else{const p=await c.json().catch(()=>({}));e.push({productName:m.productName||s,error:p.message||`HTTP ${c.status}`})}}catch(c){console.error("Error saving rate:",c),e.push({productName:m.productName||s,error:c.message||"Network error"})}for(const s of t)delete C[s];y.textContent="Save",y.disabled=!1,e.length>0?(e.map(s=>s.productName).join(", "),b(`${e.length} rate(s) not saved. Try again.`,"info"),Object.keys(C).length>0?y.classList.add("show"):y.classList.remove("show")):(y.classList.remove("show"),document.querySelectorAll(".item-rate-input").forEach(s=>{s.value="",s.classList.remove("changed")})),S()}async function J(){try{(await(await fetch("/api/health")).json()).status==="ok"?(document.getElementById("apiDot").classList.remove("offline"),document.getElementById("apiStatus").textContent="API Online"):(document.getElementById("apiDot").classList.add("offline"),document.getElementById("apiStatus").textContent="API Offline")}catch{document.getElementById("apiDot").classList.add("offline"),document.getElementById("apiStatus").textContent="API Offline"}}let N=null,L=null,k=null;const h={olive:"rgb(126, 145, 129)",oliveLight:"rgba(126, 145, 129, 0.2)",gunmetal:"rgb(46, 53, 50)",terracotta:"rgb(196, 167, 125)",success:"rgb(93, 122, 95)",warning:"rgb(184, 154, 90)",error:"rgb(154, 101, 101)",slate:"rgb(199, 206, 219)"};async function W(e){try{const t={pending:0,confirmed:0,processing:0,packed:0,shipped:0,delivered:0,cancelled:0};e.forEach(a=>{t.hasOwnProperty(a.status)&&t[a.status]++}),document.getElementById("pendingCount").textContent=t.pending,document.getElementById("processingCount").textContent=t.processing+t.packed+t.shipped,document.getElementById("deliveredCount").textContent=t.delivered;const i=document.getElementById("orderStatusChart");N&&N.destroy(),N=new Chart(i,{type:"doughnut",data:{labels:["Pending","Confirmed","Processing","Packed","Shipped","Delivered","Cancelled"],datasets:[{data:[t.pending,t.confirmed,t.processing,t.packed,t.shipped,t.delivered,t.cancelled],backgroundColor:[h.warning,h.olive,h.terracotta,h.gunmetal,h.slate,h.success,h.error],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!1}}}});const d=[],s={};for(let a=6;a>=0;a--){const l=new Date;l.setDate(l.getDate()-a);const f=l.toISOString().split("T")[0];d.push(f),s[f]=0}e.forEach(a=>{if(a.status!=="cancelled"){const l=new Date(a.createdAt).toISOString().split("T")[0];s.hasOwnProperty(l)&&(s[l]+=a.totalAmount||0)}});const m=d.map(a=>s[a]),c=m.reduce((a,l)=>a+l,0),p=c/7;document.getElementById("weekTotal").textContent=I(c),document.getElementById("avgDaily").textContent=I(Math.round(p));const r=document.getElementById("revenueChart");L&&L.destroy(),L=new Chart(r,{type:"line",data:{labels:d.map(a=>new Date(a).toLocaleDateString("en-IN",{weekday:"short"})),datasets:[{label:"Revenue",data:m,borderColor:h.olive,backgroundColor:h.oliveLight,fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:h.olive}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:a=>"â‚¹"+a.toLocaleString("en-IN")}}}}});const o={};e.forEach(a=>{a.status!=="cancelled"&&a.products&&a.products.forEach(l=>{const f=l.productName||"Unknown";o[f]=(o[f]||0)+(l.quantity||0)})});const u=Object.entries(o).sort((a,l)=>l[1]-a[1]).slice(0,5),g=document.getElementById("topProductsChart");k&&k.destroy(),k=new Chart(g,{type:"bar",data:{labels:u.map(([a])=>a.length>12?a.slice(0,12)+"...":a),datasets:[{label:"Quantity",data:u.map(([,a])=>a),backgroundColor:[h.olive,h.terracotta,h.gunmetal,h.success,h.warning],borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}})}catch(t){console.error("Error loading analytics:",t)}}let D=[];async function Z(){try{const e=await fetch("/api/customers",{credentials:"include"}),t=await e.json();if(e.ok){D=t.data||[];const i=document.getElementById("ledgerCustomer");i.innerHTML="",i.appendChild(n("option",{value:""},"All Customers")),D.forEach(d=>{i.appendChild(n("option",{value:d._id},d.name))})}}catch(e){console.error("Error loading customers:",e)}}window.openLedgerModal=function(){D.length===0&&Z();const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1);document.getElementById("ledgerFromDate").value=t.toISOString().split("T")[0],document.getElementById("ledgerToDate").value=e.toISOString().split("T")[0],document.getElementById("ledgerModal").classList.add("show"),document.body.style.overflow="hidden"};window.closeLedgerModal=function(){document.getElementById("ledgerModal").classList.remove("show"),document.body.style.overflow=""};window.downloadLedger=async function(){const e=document.getElementById("ledgerCustomer").value,t=document.getElementById("ledgerFromDate").value,i=document.getElementById("ledgerToDate").value,d=new URLSearchParams;e&&d.append("customerId",e),t&&d.append("fromDate",t),i&&d.append("toDate",i);try{b("Downloading ledger...","info");const s=await fetch(`/api/reports/ledger?${d}`,{credentials:"include"});if(!s.ok){const u=await s.json();throw new Error(u.message||"Ledger temporarily unavailable")}const m=await s.blob(),c=window.URL.createObjectURL(m),p=s.headers.get("Content-Disposition");let r="ledger.xlsx";p&&p.includes("filename=")&&(r=p.split("filename=")[1].replace(/"/g,""));const o=document.createElement("a");o.href=c,o.download=r,document.body.appendChild(o),o.click(),document.body.removeChild(o),window.URL.revokeObjectURL(c),b("Ledger downloaded!","success"),closeLedgerModal()}catch(s){console.error("Download ledger error:",s),b(s.message||"Could not download","info")}};async function j(){try{const e=await fetch("/api/batches/today",{credentials:"include"}),t=await e.json();if(!e.ok){const c=document.getElementById("batchCards");c.innerHTML="",c.appendChild(n("div",{className:"empty-state"},"Could not load batches"));return}const i=document.getElementById("batchInfo");i.innerHTML="",i.appendChild(n("span",{className:"badge badge-info"},`Currently accepting: ${t.currentBatch}`));const d=new Date(t.currentTime);document.getElementById("batchCurrentTime").textContent=d.toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"})+" IST";const s=t.data||[];if(s.length===0){const c=document.getElementById("batchCards");c.innerHTML="",c.appendChild(n("div",{className:"empty-state"},"No batches for today yet"));return}document.getElementById("batchCards").innerHTML="";const m=document.createDocumentFragment();s.forEach(c=>{const p=c.status==="open",r=c.status==="confirmed",o=r?"confirmed":p?"open":"expired",u=r?"ðŸ”’ Confirmed":p?"ðŸ“ Open":"â° Expired",g=c.batchType==="2nd"&&p,a=[n("div",{className:"batch-stat"},[n("span",{className:"batch-stat-value"},c.totalOrders||0),n("span",{className:"batch-stat-label"},"Orders")])];if(r&&c.confirmedAt){const f=[`Confirmed at ${new Date(c.confirmedAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"})}`];c.confirmedBy?.name&&f.push(` by ${c.confirmedBy.name}`),a.push(n("div",{className:"batch-confirmed-info"},f))}const l=[n("div",{className:"batch-card-header"},[n("span",{className:"batch-type"},`${c.batchType} Batch`),n("span",{className:"batch-status"},u)]),n("div",{className:"batch-card-body"},a)];g&&l.push(n("div",{className:"batch-card-actions"},[n("button",{className:"btn-confirm-batch",onclick:()=>F(c._id)},"Confirm Batch")])),m.appendChild(n("div",{className:`batch-card ${o}`},l))}),document.getElementById("batchCards").appendChild(m)}catch(e){console.error("Error loading batches:",e);const t=document.getElementById("batchCards");t.innerHTML="",t.appendChild(n("div",{className:"empty-state"},"Could not load batches"))}}async function F(e){if(confirm("Are you sure you want to confirm this batch? Orders will be locked and customers will not be able to edit them."))try{const t=await E.ensureCsrfToken(),i={"Content-Type":"application/json"};t&&(i["X-CSRF-Token"]=t);const d=await fetch(`/api/batches/${e}/confirm`,{method:"POST",credentials:"include",headers:i}),s=await d.json();if(!d.ok){b(s.message||"Could not confirm batch","error");return}b(s.message||"Batch confirmed successfully","success"),j()}catch(t){console.error("Error confirming batch:",t),b("Could not confirm batch","error")}}window.confirmBatch=F;async function Y(){const e=await E.requireAuth(["admin","staff"]);e&&(document.getElementById("userBadge").textContent=e.name||e.email||"User",S(),j(),J())}Y();
