import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css               *//* empty css                */import{s as w,c as a}from"./ui-C7t5s6-T.js";import"./api-BDW4zv3H.js";const L=(e=1e4)=>new Promise((t,o)=>{const r=Date.now(),s=()=>{if(window.Auth)return t(window.Auth);if(Date.now()-r>e)return o(new Error("Auth not available"));setTimeout(s,50)};s()}),D=await L();let N=[];const S={};let p={},f=null;async function P(){await D.requireAuth(["admin","staff"])&&(document.getElementById("dateBar").textContent=new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),await T(),await F())}async function T(){try{const[e,t]=await Promise.all([fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"})]);if(!e.ok)throw new Error(`Products: server returned ${e.status}`);if(!t.ok)throw new Error(`Market rates: server returned ${t.status}`);const o=await e.json(),r=await t.json();N=(o.data||[]).filter(s=>s.isActive),(r.data||[]).forEach(s=>{const l=typeof s.product=="object"?s.product._id:s.product;S[l]=s.rate}),$()}catch(e){console.error(e);const t=document.getElementById("productList"),o=navigator.onLine?"Data not available":"No internet connection";t.innerHTML="",t.appendChild(a("div",{className:"loading"},[a("p",{},o),a("button",{id:"retryDataBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:T},"Try Again")]))}}function $(){const e=document.getElementById("productList");if(e.innerHTML="",!N.length){e.appendChild(a("div",{className:"loading"},"No products found"));return}const t={};N.forEach(s=>{const l=s.category||"other";t[l]||(t[l]=[]),t[l].push(s)});const o=document.createDocumentFragment();let r=0;for(const[s,l]of Object.entries(t)){const h=s.replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase());o.appendChild(a("div",{className:"category-header"},h)),l.forEach(c=>{const d=S[c._id]||0,i=a("div",{className:"product-item card-animated card-fade-in",style:{animationDelay:`${r*.03}s`}},[a("div",{className:"product-info"},[a("div",{className:"product-name"},c.name),a("div",{className:"product-unit"},`per ${c.unit}`)]),a("input",{type:"number",className:"rate-input input-animated",id:`rate-${c._id}`,dataset:{id:c._id,original:String(d)},value:String(d),min:"0",step:"0.01",onfocus:n=>window.clearZero(n.target),onblur:n=>window.restoreValue(n.target),onchange:n=>window.handleChange(n.target),oninput:n=>window.handleInput(n.target),onkeydown:n=>{["e","E","+","-"].includes(n.key)&&n.preventDefault()}})]);o.appendChild(i),r++})}e.appendChild(o)}function B(e){e.dataset.prevValue=e.value,e.value="",e.select()}function I(e){e.value===""&&(e.value=e.dataset.prevValue||e.dataset.original),E(e)}function j(e){const t=parseFloat(e.dataset.original),o=parseFloat(e.value);e.classList.toggle("changed",o!==t)}function E(e){const t=e.dataset.id,o=parseFloat(e.dataset.original),r=parseFloat(e.value);r!==o&&r>0?(p[t]=r,e.classList.add("changed")):(delete p[t],e.classList.remove("changed")),r>1e3?e.style.borderColor="var(--warning)":e.style.borderColor="",x()}function x(){const e=Object.keys(p).length;document.getElementById("changesCount").textContent=e,document.getElementById("saveBtn").disabled=e===0}async function R(){const e=document.getElementById("saveBtn"),t=[];for(const[u,y]of Object.entries(p))if(isNaN(y)||y<0){const v=N.find(m=>m._id===u);t.push(v?.name||u)}if(t.length>0){w(`${t.slice(0,2).join(", ")}: rates must be 0 or higher`,"info");return}e.disabled=!0,e.classList.add("btn-loading");let o=0,r=0,s=null;const l=[],h={"Content-Type":"application/json"};let c=await D.ensureCsrfToken();c&&(h["X-CSRF-Token"]=c);const d=Object.entries(p),i=5;for(let u=0;u<d.length;u+=i){const y=d.slice(u,u+i);(await Promise.all(y.map(async([m,C])=>{try{let g=await fetch("/api/market-rates",{method:"POST",headers:h,credentials:"include",body:JSON.stringify({product:m,rate:C})});if(g.status===403&&(await g.json().catch(()=>({}))).message?.toLowerCase().includes("csrf")&&(c=await D.refreshCsrfToken(),c&&(h["X-CSRF-Token"]=c,g=await fetch("/api/market-rates",{method:"POST",headers:h,credentials:"include",body:JSON.stringify({product:m,rate:C})}))),g.ok){const b=document.getElementById("rate-"+m);return b&&(b.dataset.original=C,b.classList.remove("changed")),S[m]=C,{success:!0,productId:m}}else{const k=(await g.json().catch(()=>({}))).message||`HTTP ${g.status}`;return console.error("Failed to save rate for product:",m,k),{success:!1,productId:m,error:k}}}catch(g){return console.error("Failed to save rate for product:",m,g.message),{success:!1,productId:m,error:g.message||"Network error"}}}))).forEach(m=>{m.success?o++:(r++,s||(s=m.error),l.push(m.productId))})}const n={};Object.keys(p).forEach(u=>{l.includes(u)&&(n[u]=p[u])}),p=n,x(),e.classList.remove("btn-loading"),o>0&&(e.classList.add("btn-success"),setTimeout(()=>e.classList.remove("btn-success"),1500),w(`${o} rate(s) saved`,"success")),r>0&&w(`${r} rate(s) not saved`,"info")}async function F(){const e=document.getElementById("historyContent"),t=document.getElementById("historyCategory"),o=t.value;e.innerHTML="",e.appendChild(a("div",{className:"history-loading"},"Loading history..."));try{const r=`/api/market-rates/history-summary?days=7${o!=="all"?`&category=${encodeURIComponent(o)}`:""}`,s=await fetch(r,{credentials:"include"});if(!s.ok)throw new Error("History temporarily unavailable");const l=await s.json();f=l,t.options.length<=1&&l.categories&&l.categories.forEach(h=>{const c=h.replace(/-/g," ").replace(/\b\w/g,d=>d.toUpperCase());t.appendChild(a("option",{value:h},c))}),H(l)}catch(r){console.error("Failed to load history:",r),e.innerHTML="",e.appendChild(a("div",{className:"history-loading"},"History not available"))}}function H(e){const t=document.getElementById("historyContent");if(t.innerHTML="",!e.data||e.data.length===0||!e.data[0]?.rates?.length){t.appendChild(a("div",{className:"history-loading"},"No history data available"));return}const r=e.data[0].rates.map(d=>d.date).map(d=>{const i=new Date(d),n=i.toLocaleDateString("en-IN",{weekday:"short"}),u=i.toLocaleDateString("en-IN",{day:"numeric",month:"short"});return a("th",{className:"date-header"},[u,a("span",{className:"date-day"},n)])}),s=a("tr",{},[a("th",{},"Product"),...r]),l=d=>a("td",{},[d.name,a("br"),a("small",{style:{color:"var(--text-muted)",fontWeight:"400"}},`per ${d.unit}`)]),h=a("tbody");e.data.forEach(d=>{const i=a("tr");i.appendChild(l(d)),d.rates.forEach(n=>{if(n.rate===null)i.appendChild(a("td",{className:"rate-cell rate-null"},"-"));else{const u=n.trend||"stable",y=n.trend==="up"?"↑":n.trend==="down"?"↓":"",v=[n.rate.toFixed(2)];y&&v.push(a("span",{className:"trend-indicator"},y)),i.appendChild(a("td",{className:`rate-cell ${u}`},v))}}),h.appendChild(i)});const c=a("table",{className:"history-table"},[a("thead",{},[s]),h]);t.appendChild(c)}function M(){if(!window.jspdf){w("PDF export not available (library not loaded)","info");return}if(!f||!f.data||f.data.length===0||!f.data[0]?.rates?.length){w("No data available to export","info");return}try{const{jsPDF:e}=window.jspdf,t=new e({orientation:"landscape",unit:"mm",format:"a4"});t.setFontSize(18),t.setTextColor(46,53,50),t.text("Pratibha Marketing - 7-Day Market Rate History",14,20),t.setFontSize(10),t.setTextColor(138,145,140);const o=document.getElementById("historyCategory"),r=o.value==="all"?"All Categories":o.options[o.selectedIndex].text;t.text(`${f.startDate} to ${f.endDate} | ${r}`,14,27);const l=[["Product","Unit",...f.data[0].rates.map(i=>new Date(i.date).toLocaleDateString("en-IN",{day:"numeric",month:"short"}))]],h=f.data.map(i=>{const n=i.rates.map(u=>u.rate!==null?u.rate.toFixed(2):"-");return[i.name,i.unit,...n]});t.autoTable({startY:32,head:l,body:h,theme:"grid",headStyles:{fillColor:[46,53,50],textColor:[255,255,255],fontSize:8,fontStyle:"bold"},bodyStyles:{fontSize:8,textColor:[31,36,33]},columnStyles:{0:{fontStyle:"bold",cellWidth:40},1:{cellWidth:20}},alternateRowStyles:{fillColor:[249,247,243]},margin:{left:14,right:14}});const c=t.internal.getNumberOfPages();for(let i=1;i<=c;i++)t.setPage(i),t.setFontSize(8),t.setTextColor(138,145,140),t.text(`Generated on ${new Date().toLocaleString("en-IN")} | Page ${i} of ${c}`,14,t.internal.pageSize.height-10);const d=`market-rates-${f.startDate}-to-${f.endDate}.pdf`;t.save(d),w("PDF exported successfully","success")}catch(e){console.error("PDF export failed:",e),w("Could not export PDF","info")}}window.clearZero=B;window.restoreValue=I;window.handleChange=E;window.handleInput=j;window.saveRates=R;window.loadHistory=F;window.exportToPDF=M;P();
