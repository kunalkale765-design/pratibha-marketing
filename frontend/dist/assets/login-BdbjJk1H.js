import{t as p}from"./ui-Usu6AxiT.js";/* empty css               *//* empty css                */import"./api-BESsD5Cs.js";import{r as y}from"./init-DAk7Tmy7.js";y();const h=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(h()),10)}),f=await h();f.ensureCsrfToken().catch(e=>console.warn("CSRF pre-fetch failed:",e));const w=document.getElementById("loginForm"),n=document.getElementById("loginBtn"),s=document.getElementById("noticeMessage"),d=document.getElementById("passwordToggle");d&&d.addEventListener("click",()=>{p("password",d)});k();async function k(){try{const e=await fetch("/api/auth/me",{credentials:"include"});e.ok&&((await e.json()).user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/")}catch{}}w&&w.addEventListener("submit",async e=>{e.preventDefault();const r=document.getElementById("email").value.trim(),a=document.getElementById("password").value;if(!r||!a){t("Please enter username and password");return}n.disabled=!0,n.classList.add("btn-loading"),T();try{const o={"Content-Type":"application/json"},u=await f.ensureCsrfToken();u&&(o["X-CSRF-Token"]=u);const c=await fetch("/api/auth/login",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({email:r,password:a})}),i=await c.json();if(c.status===403&&i?.message?.toLowerCase().includes("csrf")){console.log("CSRF error, refreshing token and retrying...");const m=await f.refreshCsrfToken();if(m){o["X-CSRF-Token"]=m;const g=await fetch("/api/auth/login",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({email:r,password:a})}),l=await g.json();if(g.ok){localStorage.setItem("user",JSON.stringify(l.user)),l.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/";return}t(l.message||"Please check your credentials");return}}c.ok?(localStorage.setItem("user",JSON.stringify(i.user)),i.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/"):t(i.message||"Please check your credentials")}catch(o){console.error("Login error:",o),navigator.onLine?o.name==="TypeError"||o.message.includes("fetch")?t("Connection issue. Please try again."):t("Something went wrong. Try again."):t("No internet connection")}finally{n&&(n.disabled=!1,n.classList.remove("btn-loading"))}});function t(e){s&&(s.textContent=e,s.classList.add("show"))}function T(){s&&s.classList.remove("show")}
