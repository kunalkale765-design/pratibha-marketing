import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css                */import{c as r,s as E}from"./ui-CbzHyiqg.js";import"./api-CPXug1OA.js";import{i as oe}from"./init-BoJp8Xjr.js";function x(e,t=!0){if(e==null||isNaN(e))return t?"₹0":"0";const o=Number(e).toLocaleString("en-IN",{minimumFractionDigits:0,maximumFractionDigits:2});return t?`₹${o}`:o}const X=(e=0)=>new Promise((t,o)=>{window.Auth?t(window.Auth):e>500?o(new Error("Auth module failed to load")):setTimeout(()=>X(e+1).then(t).catch(o),10)});let T;try{T=await X()}catch(e){console.error("Auth initialization failed:",e),window.location.href="/pages/auth/login.html"}oe();let J=[],h={toProcure:[],procured:[],categories:[]},L="",C="";const P={};let S={},y=null,R=null,w=null,N=null,M=!1,$=!1;function ne(){N=new Audio("/assets/sounds/notification.wav"),N.preload="auto",N.volume=.5}window.addEventListener("beforeunload",()=>{y&&(clearInterval(y),y=null),w&&(w.close().catch(()=>{}),w=null),N&&(N=null)});document.addEventListener("visibilitychange",()=>{document.hidden?y&&(clearInterval(y),y=null):y||ee()});function re(){if(M){if(N){N.currentTime=0,N.play().catch(()=>{V()});return}V()}}function V(){try{w||(w=new(window.AudioContext||window.webkitAudioContext)),w.state==="suspended"&&w.resume();const e=w.createOscillator(),t=w.createOscillator(),o=w.createGain();e.connect(o),t.connect(o),o.connect(w.destination),e.frequency.value=880,e.type="sine",t.frequency.value=1108.73,t.type="sine";const n=w.currentTime;o.gain.setValueAtTime(0,n),o.gain.linearRampToValueAtTime(.3,n+.05),o.gain.linearRampToValueAtTime(.2,n+.15),o.gain.linearRampToValueAtTime(.3,n+.2),o.gain.linearRampToValueAtTime(0,n+.35),e.start(n),t.start(n),e.stop(n+.35),t.stop(n+.35)}catch(e){console.log("Could not play notification sound:",e)}}document.getElementById("logoutBtn");const z=document.getElementById("printBtn"),Z=document.getElementById("exportBtn"),b=document.getElementById("saveRatesBtn"),_=document.getElementById("purchaseSearch"),k=document.getElementById("newOrderBadge"),q=document.getElementById("procuredHeader");z&&z.addEventListener("click",ce);Z&&Z.addEventListener("click",le);b&&b.addEventListener("click",ie);_&&_.addEventListener("input",e=>{L=e.target.value.trim().toLowerCase(),A()});const W=document.getElementById("categoryPills");W&&W.addEventListener("click",e=>{const t=e.target.closest(".category-pill");t&&(document.querySelectorAll(".category-pill").forEach(o=>o.classList.remove("active")),t.classList.add("active"),C=t.dataset.category,A())});function se(e){const t=document.getElementById("categoryPills");if(!t)return;t.innerHTML='<button class="category-pill active" data-category="">All</button>';const o={"Indian Vegetables":"Vegetables","Exotic Vegetables":"Exotic",Fruits:"Fruits",Frozen:"Frozen",Dairy:"Dairy"};if(e.forEach(n=>{const l=r("button",{className:"category-pill"+(C===n?" active":""),dataset:{category:n}},o[n]||n);t.appendChild(l)}),C){const n=t.querySelector(`[data-category="${C}"]`);n?(t.querySelector(".active")?.classList.remove("active"),n.classList.add("active")):C=""}}q&&q.addEventListener("click",()=>{q.classList.toggle("collapsed")});function G(){if(!M)try{w=new(window.AudioContext||window.webkitAudioContext),ne(),M=!0}catch(e){console.log("Could not initialize audio:",e)}}document.addEventListener("click",G,{once:!0});document.addEventListener("touchstart",G,{once:!0});async function B(){try{const[e,t,o,n]=await Promise.all([fetch("/api/orders",{credentials:"include"}),fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/supplier/procurement-summary",{credentials:"include"})]);if(!e.ok||!t.ok||!o.ok||!n.ok){const g=e.ok?t.ok?o.ok?"procurement":"rates":"products":"orders";throw new Error(`Failed to load ${g} data (status: ${e.ok?t.ok?o.ok?n.status:o.status:t.status:e.status})`)}const l=await e.json(),i=await o.json(),u=await n.json();J=i.data||[],h={toProcure:u.toProcure||[],procured:u.procured||[],categories:u.categories||[]},se(h.categories),Y(h),K(h);const m=l.data||[],c=m.filter(g=>g.status==="delivered"||g.paymentStatus==="paid").reduce((g,f)=>g+(f.totalAmount||0),0),s=c*.15,d=document.getElementById("totalSale"),a=document.getElementById("totalProfit");d&&(d.textContent=x(c)),a&&(a.textContent=x(s)),A(),ue(m),ee()}catch(e){console.error("Error loading dashboard stats:",e);const t=document.getElementById("totalSale"),o=document.getElementById("totalProfit"),n=document.getElementById("toProcureList");t&&(t.textContent="—"),o&&(o.textContent="—"),n&&(n.innerHTML="",n.appendChild(r("div",{className:"empty-state"},[r("p",{},"Data not available"),r("button",{id:"retryBtn",className:"btn-retry",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:B},"Try Again")])))}}function K(e){S={},[...e.toProcure,...e.procured].forEach(t=>{S[t.productId]=t.totalQty})}function Y(e){if(Object.keys(S).length===0)return;let t=0;[...e.toProcure,...e.procured].forEach(n=>{const l=S[n.productId]||0;n.totalQty>l&&t++}),t>0&&(re(),k&&(k.textContent=`${t} new`,k.classList.remove("hidden"),R&&clearTimeout(R),R=setTimeout(()=>{k&&k.classList.add("hidden"),R=null},3e4)),E(`${t} product(s) have new orders!`,"info"))}function ee(){y&&clearInterval(y),y=setInterval(async()=>{if(!$){$=!0;try{if(!document.getElementById("toProcureList")){clearInterval(y),y=null;return}const e=await fetch("/api/supplier/procurement-summary",{credentials:"include"});if(e.status===401){clearInterval(y),y=null,window.location.href="/pages/auth/login.html";return}if(!e.ok){console.warn("Polling failed:",e.status);return}const t=await e.json();if(e.ok){const o={toProcure:t.toProcure||[],procured:t.procured||[],categories:t.categories||[]};Y(o),h=o,K(h),A(!0)}}catch(e){console.error("Polling error:",e)}finally{$=!1}}},3e4)}function A(e=!1){const t=document.getElementById("toProcureList"),o=document.getElementById("procuredList"),n=document.getElementById("procurementEmpty"),l=document.getElementById("procuredCount");if(!t||!o){console.error("Purchase List: Required DOM elements missing (toProcureList or procuredList). Check index.html structure.");const s=document.querySelector(".procurement-container");if(s&&!s.querySelector(".procurement-error")){const a=document.createElement("div");a.className="procurement-error",a.style.cssText="padding:1.5rem;text-align:center;color:var(--error);font-size:0.875rem;",a.textContent="Purchase list failed to load. Please refresh the page.",s.appendChild(a)}return}const i={};e&&document.querySelectorAll(".item-rate-input").forEach(s=>{s.value&&(i[s.dataset.productId]=s.value)}),t.innerHTML="",o.innerHTML="";const u=s=>s.filter(d=>{const a=!L||d.productName.toLowerCase().includes(L),g=!C||d.category===C;return a&&g}),m=u(h.toProcure),c=u(h.procured);l&&(l.textContent=c.length),m.length===0&&h.toProcure.length===0?(n&&n.classList.remove("hidden"),t.innerHTML='<div class="empty-list-msg">No items to procure</div>'):n&&n.classList.add("hidden");const p={};if(J.forEach(s=>{p[s.product]=s}),m.length>0){const s=document.createDocumentFragment();s.appendChild(r("div",{className:"procurement-column-header"},[r("span",{className:"col-expand"}),r("span",{className:"col-name"},"Product"),r("span",{className:"col-qty"},"Qty"),r("span",{className:"col-input"},"Rate")]));let d="";m.forEach(a=>{a.category!==d&&(d=a.category,s.appendChild(r("div",{className:"category-divider"},d)));const g=p[a.productId],f=a.currentRate||g?.rate||0,H=i[a.productId]||"",te=f===0?" unsaved":"";let D;a.wasProcured?D=r("span",{className:"qty-breakdown"},[r("span",{className:"procured-qty"},String(a.procuredQty||0)),r("span",{className:"separator"},"+"),r("span",{className:"new-qty highlight-new"},String(a.newQty||0))]):D=r("span",{className:"qty-simple"},String(a.totalQty||0));const O=[r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Orders"),r("span",{className:"detail-value"},a.totalOrders||0)])];a.wasProcured&&a.lastRate&&O.unshift(r("div",{className:"detail-row highlight-info"},[r("span",{className:"detail-label"},"Last Rate"),r("span",{className:"detail-value"},`₹${a.lastRate}/${a.unit}`)])),O.push(r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Est. Cost"),r("span",{className:"detail-value highlight"},a.totalQty>0&&f>0?x(a.totalQty*f):"—")]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Trend"),r("span",{className:"detail-value"},a.trend==="up"?"↑ Up":a.trend==="down"?"↓ Down":"— Stable")]));const ae=r("div",{className:`procurement-item${te}${a.wasProcured?" was-procured":""}`,dataset:{productId:a.productId}},[r("div",{className:"item-main",onclick:I=>window.toggleExpand(I.currentTarget)},[r("span",{className:"item-expand"},"▶"),r("span",{className:"item-name"},a.productName),D,r("span",{className:"item-unit"},a.unit),r("input",{type:"number",className:"item-rate-input"+(H?" changed":""),dataset:{productId:a.productId,productName:a.productName,currentRate:f,quantity:a.totalQty||0},placeholder:"₹0",value:H,step:"0.01",min:"0",onclick:I=>I.stopPropagation(),onchange:I=>window.handleRateChange(I.target),oninput:I=>window.handleRateInput(I.target)})]),r("div",{className:"item-details"},O)]);s.appendChild(ae)}),t.appendChild(s)}else(L||C)&&(t.innerHTML='<div class="empty-list-msg">No matching items</div>');if(c.length>0){const s=document.createDocumentFragment();let d="";c.forEach(a=>{a.category!==d&&(d=a.category,s.appendChild(r("div",{className:"category-divider"},d)));const g=r("div",{className:"procurement-item procured-item",dataset:{productId:a.productId}},[r("div",{className:"item-main",onclick:f=>window.toggleExpand(f.currentTarget)},[r("span",{className:"item-expand"},"▶"),r("span",{className:"item-name"},"✓ "+a.productName),r("span",{className:"qty-simple"},String(a.procuredQty||0)),r("span",{className:"item-unit"},a.unit),r("span",{className:"procured-rate"},`₹${a.rate}`)]),r("div",{className:"item-details"},[r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Procured At"),r("span",{className:"detail-value"},new Date(a.procuredAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}))]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Orders"),r("span",{className:"detail-value"},a.totalOrders||0)]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Value"),r("span",{className:"detail-value highlight"},x(a.procuredQty*a.rate))]),r("div",{className:"detail-actions"},[r("button",{className:"btn-undo",onclick:f=>{f.stopPropagation(),window.undoProcurement(a.productId,a.productName)}},"Undo")])])]);s.appendChild(g)}),o.appendChild(s)}}window.toggleExpand=function(e){e.closest(".procurement-item").classList.toggle("expanded")};window.handleRateInput=function(e){const t=parseFloat(e.dataset.currentRate),o=parseFloat(e.value);e.classList.toggle("changed",e.value&&o!==t)};window.handleRateChange=function(e){const t=e.dataset.productId,o=e.dataset.productName,n=parseFloat(e.dataset.currentRate),l=parseFloat(e.dataset.quantity)||0,i=parseFloat(e.value);e.value&&i!==n&&i>0?(P[t]={product:t,productName:o,rate:i,previousRate:n,quantity:l},e.classList.add("changed")):(delete P[t],e.classList.remove("changed")),b&&b.classList.toggle("show",Object.keys(P).length>0)};window.undoProcurement=async function(e,t){if(!confirm(`Remove ${t} from procured list?`))return;const o=document.querySelector(`[onclick*="undoProcurement('${e}'"]`)||document.querySelector(`[data-product-id="${e}"] .undo-btn`);o&&(o.disabled=!0,o.classList.add("btn-loading"));try{const n=await T.ensureCsrfToken(),l={"Content-Type":"application/json"};n&&(l["X-CSRF-Token"]=n);const i=await fetch(`/api/supplier/procure/${e}`,{method:"DELETE",credentials:"include",headers:l});if(!i.ok){const u=await i.json();E(u.message||"Could not undo","error");return}E(`${t} moved back to TO PROCURE`,"success"),B()}catch(n){console.error("Error undoing procurement:",n),E("Could not undo","error"),o&&(o.disabled=!1,o.classList.remove("btn-loading"))}};function ce(){const e=c=>typeof c!="string"?String(c):c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),t=c=>c.filter(p=>{const s=!L||p.productName.toLowerCase().includes(L),d=!C||p.category===C;return s&&d}),o=t(h.toProcure),n=t(h.procured);let l="",i="";o.forEach(c=>{c.category!==i&&(i=c.category,l+=`<div class="category-header">${e(i)}</div>`);const p=c.wasProcured?`${c.procuredQty||0} + ${c.newQty||0}`:`${c.totalQty||0}`;l+=`
            <div class="procurement-item">
                <span class="item-name">${e(c.productName)}</span>
                <span class="qty-breakdown">${p}</span>
                <span class="item-unit">${e(c.unit)}</span>
                <span class="current-rate">₹${(c.currentRate||0).toFixed(0)}</span>
            </div>`});let u="";i="",n.forEach(c=>{c.category!==i&&(i=c.category,u+=`<div class="category-header">${e(i)}</div>`),u+=`
            <div class="procurement-item procured-item">
                <span class="item-name">${e(c.productName)}</span>
                <span class="qty-breakdown">${c.procuredQty||0}</span>
                <span class="item-unit">${e(c.unit)}</span>
                <span class="procured-rate">₹${c.rate}</span>
            </div>`});const m=window.open("","_blank");if(!m){E("Popup blocked. Please allow popups for this site.","error");return}m.document.write(`
        <html>
        <head>
            <title>Purchase List - Pratibha Marketing</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { font-size: 18px; margin-bottom: 10px; }
                h2 { font-size: 14px; margin-top: 20px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                .date { color: #666; margin-bottom: 20px; }
                .category-header { font-weight: bold; color: #666; margin: 15px 0 5px; font-size: 12px; text-transform: uppercase; }
                .procurement-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
                .item-name { font-weight: bold; flex: 1; }
                .qty-breakdown { font-family: monospace; min-width: 100px; }
                .item-unit { color: #666; min-width: 50px; }
                .current-rate { color: #666; min-width: 60px; text-align: right; }
                .procured-rate { color: #5d7a5f; font-weight: bold; min-width: 60px; text-align: right; }
                .procured-item .item-name::before { content: '✓ '; color: #5d7a5f; }
                .empty-msg { color: #999; font-style: italic; padding: 10px 0; }
            </style>
        </head>
        <body>
            <h1>Purchase List - Pratibha Marketing</h1>
            <div class="date">${new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>
            <h2>TO PROCURE (${o.length} items)</h2>
            ${l||'<div class="empty-msg">No items to procure</div>'}
            <h2>PROCURED (${n.length} items)</h2>
            ${u||'<div class="empty-msg">No procured items</div>'}
        </body>
        </html>
    `),m.document.close(),m.print()}function le(){const e=[...h.toProcure,...h.procured],t=["Category","Product","Unit","Procured Qty","New Qty","Total Qty","Rate","Status"],o=e.map(m=>{const c=h.procured.find(s=>s.productId===m.productId)?"Procured":"To Procure",p=m.rate||m.currentRate||0;return[`"${m.category}"`,`"${m.productName}"`,m.unit,m.procuredQty||0,m.newQty||0,m.totalQty||m.procuredQty||0,p,c].join(",")}),n=[t.join(","),...o].join(`
`),l=new Blob([n],{type:"text/csv"}),i=window.URL.createObjectURL(l),u=document.createElement("a");u.href=i,u.download=`purchase-list-${new Date().toISOString().split("T")[0]}.csv`,u.click(),window.URL.revokeObjectURL(i)}async function ie(){if(!b)return;b.textContent="Saving...",b.disabled=!0;const e=[],t=[],o={"Content-Type":"application/json"};let n=await T.ensureCsrfToken();n&&(o["X-CSRF-Token"]=n);const l=Object.entries(P),i=5;for(let u=0;u<l.length;u+=i){const m=l.slice(u,u+i);(await Promise.all(m.map(async([p,s])=>{try{let d=await fetch("/api/supplier/procure",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({productId:s.product,rate:s.rate,quantity:s.quantity||0})});if(d.status===403){const a=await d.json().catch(()=>({}));if(a.message?.toLowerCase().includes("csrf"))n=await T.refreshCsrfToken(),n&&(o["X-CSRF-Token"]=n,d=await fetch("/api/supplier/procure",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({productId:s.product,rate:s.rate,quantity:s.quantity||0})}));else return{productId:p,success:!1,productName:s.productName||p,error:a.message||`HTTP ${d.status}`}}if(d.ok)return{productId:p,success:!0};{const a=await d.json().catch(()=>({}));return{productId:p,success:!1,productName:s.productName||p,error:a.message||`HTTP ${d.status}`}}}catch(d){return console.error("Error saving rate:",d),{productId:p,success:!1,productName:s.productName||p,error:d.message||"Network error"}}}))).forEach(p=>{p.success?t.push(p.productId):e.push({productName:p.productName,error:p.error})})}for(const u of t)delete P[u];b.textContent="Save",b.disabled=!1,e.length>0?(E(`${e.length} rate(s) not saved. Try again.`,"info"),Object.keys(P).length>0?b.classList.add("show"):b.classList.remove("show")):(b.classList.remove("show"),document.querySelectorAll(".item-rate-input").forEach(u=>{u.value="",u.classList.remove("changed")}),E("Items marked as procured!","success")),B()}async function de(){const e=document.getElementById("apiDot"),t=document.getElementById("apiStatus");if(!(!e||!t))try{(await(await fetch("/api/health")).json()).status==="ok"?(e.classList.remove("offline"),t.textContent="API Online"):(e.classList.add("offline"),t.textContent="API Offline")}catch{e.classList.add("offline"),t.textContent="API Offline"}}let Q=null,j=null,F=null;const v={olive:"rgb(126, 145, 129)",oliveLight:"rgba(126, 145, 129, 0.2)",gunmetal:"rgb(46, 53, 50)",terracotta:"rgb(196, 167, 125)",success:"rgb(93, 122, 95)",warning:"rgb(184, 154, 90)",error:"rgb(154, 101, 101)",slate:"rgb(199, 206, 219)"};async function ue(e){if(!window.Chart){["orderStatusChart","revenueChart","topProductsChart"].forEach(o=>{const n=document.getElementById(o);if(n&&n.parentElement){const l=document.createElement("div");l.style.cssText="display:flex;align-items:center;justify-content:center;height:100%;color:var(--dusty-olive);font-size:0.85rem;",l.textContent="Charts unavailable",n.parentElement.replaceChild(l,n)}});return}try{const t={pending:0,confirmed:0,delivered:0,cancelled:0};e.forEach(a=>{Object.hasOwn(t,a.status)&&t[a.status]++}),document.getElementById("pendingCount").textContent=t.pending,document.getElementById("processingCount").textContent=t.confirmed,document.getElementById("deliveredCount").textContent=t.delivered;const o=document.getElementById("orderStatusChart");o?(Q&&Q.destroy(),Q=new Chart(o,{type:"doughnut",data:{labels:["Pending","Confirmed","Delivered","Cancelled"],datasets:[{data:[t.pending,t.confirmed,t.delivered,t.cancelled],backgroundColor:[v.warning,v.olive,v.success,v.error],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!1}}}})):console.warn("Order status chart canvas not found");const n=[],l={};for(let a=6;a>=0;a--){const g=new Date;g.setDate(g.getDate()-a);const f=g.toISOString().split("T")[0];n.push(f),l[f]=0}e.forEach(a=>{if(a.status!=="cancelled"){const g=new Date(a.createdAt).toISOString().split("T")[0];Object.hasOwn(l,g)&&(l[g]+=a.totalAmount||0)}});const i=n.map(a=>l[a]),u=i.reduce((a,g)=>a+g,0),m=u/7;document.getElementById("weekTotal").textContent=x(u),document.getElementById("avgDaily").textContent=x(Math.round(m));const c=document.getElementById("revenueChart");c?(j&&j.destroy(),j=new Chart(c,{type:"line",data:{labels:n.map(a=>new Date(a).toLocaleDateString("en-IN",{weekday:"short"})),datasets:[{label:"Revenue",data:i,borderColor:v.olive,backgroundColor:v.oliveLight,fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:v.olive}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:a=>"₹"+a.toLocaleString("en-IN")}}}}})):console.warn("Revenue chart canvas not found");const p={};e.forEach(a=>{a.status!=="cancelled"&&a.products&&a.products.forEach(g=>{const f=g.productName||"Unknown";p[f]=(p[f]||0)+(g.quantity||0)})});const s=Object.entries(p).sort((a,g)=>g[1]-a[1]).slice(0,5),d=document.getElementById("topProductsChart");d?(F&&F.destroy(),F=new Chart(d,{type:"bar",data:{labels:s.map(([a])=>a.length>12?a.slice(0,12)+"...":a),datasets:[{label:"Quantity",data:s.map(([,a])=>a),backgroundColor:[v.olive,v.terracotta,v.gunmetal,v.success,v.warning],borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}})):console.warn("Top products chart canvas not found")}catch(t){console.error("Error loading analytics:",t)}}let U=[];async function pe(){try{const e=await fetch("/api/customers",{credentials:"include"}),t=await e.json();if(e.ok){U=t.data||[];const o=document.getElementById("ledgerCustomer");o.innerHTML="",o.appendChild(r("option",{value:""},"All Customers")),U.forEach(n=>{o.appendChild(r("option",{value:n._id},n.name))})}}catch(e){console.error("Error loading customers:",e)}}window.openLedgerModal=function(){U.length===0&&pe();const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1);document.getElementById("ledgerFromDate").value=t.toISOString().split("T")[0],document.getElementById("ledgerToDate").value=e.toISOString().split("T")[0],document.getElementById("ledgerModal").classList.add("show"),document.body.style.overflow="hidden"};window.closeLedgerModal=function(){document.getElementById("ledgerModal").classList.remove("show"),document.body.style.overflow=""};window.downloadLedger=async function(){const e=document.getElementById("ledgerCustomer").value,t=document.getElementById("ledgerFromDate").value,o=document.getElementById("ledgerToDate").value,n=new URLSearchParams;e&&n.append("customerId",e),t&&n.append("fromDate",t),o&&n.append("toDate",o);const l=document.querySelector('#ledgerModal .btn-download, #ledgerModal button[onclick*="downloadLedger"]');l&&(l.disabled=!0,l.classList.add("btn-loading"));try{E("Downloading ledger...","info");const i=await fetch(`/api/reports/ledger?${n}`,{credentials:"include"});if(!i.ok){const d=await i.json();throw new Error(d.message||"Ledger temporarily unavailable")}const u=await i.blob(),m=window.URL.createObjectURL(u),c=i.headers.get("Content-Disposition");let p="ledger.xlsx";c&&c.includes("filename=")&&(p=c.split("filename=")[1].replace(/"/g,""));const s=document.createElement("a");s.href=m,s.download=p,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(m),E("Ledger downloaded!","success"),window.closeLedgerModal()}catch(i){console.error("Download ledger error:",i),E(i.message||"Could not download","info")}finally{l&&(l.disabled=!1,l.classList.remove("btn-loading"))}};async function me(){const e=await T.requireAuth(["admin","staff"]);if(!e)return;const t=document.getElementById("userBadge");t&&(t.textContent=e.name||e.email||"User"),B(),de()}me();
