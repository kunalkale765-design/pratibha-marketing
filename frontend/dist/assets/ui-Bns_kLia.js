let a=null;function l(){const e=document.cookie.match(/csrf_token=([^;]+)/);return e?e[1]:null}async function u(){if(a)return a;a=(async()=>{try{const e=await fetch("/api/csrf-token",{credentials:"include"});if(e.ok)return(await e.json()).csrfToken||l()}catch(e){console.error("Failed to refresh CSRF token:",e)}return null})();try{return await a}finally{a=null}}async function f(){let e=l();return e||(e=await u()),e}const d={USER_KEY:"user",getCsrfToken:l,refreshCsrfToken:u,ensureCsrfToken:f,isLoggedIn(){return!!this.getUser()},getUser(){try{const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Error parsing user data:",e),null}},setUser(e){const t={id:e.id,name:e.name,email:e.email,role:e.role,customer:e.customer?{_id:e.customer._id,name:e.customer.name,pricingType:e.customer.pricingType,...e.customer.pricingType==="contract"&&e.customer.contractPrices?{allowedProducts:Object.keys(e.customer.contractPrices)}:{}}:null,isMagicLink:e.isMagicLink||!1};localStorage.setItem(this.USER_KEY,JSON.stringify(t))},clearAuth(){localStorage.removeItem(this.USER_KEY),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("logout")},getRole(){const e=this.getUser();return e?e.role:null},isStaff(){const e=this.getRole();return e==="admin"||e==="staff"},isCustomer(){return this.getRole()==="customer"},async verify(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const t=await e.json();return this.setUser(t.user),t.user}else return this.clearAuth(),null}catch(e){return console.error("Auth verification failed:",e),!navigator.onLine||e.name==="TypeError"||e.message.includes("network")||e.message.includes("fetch")||e.message.includes("Failed to fetch")?(console.warn("Network issue during auth verification - using cached user"),this.getUser()):(this.clearAuth(),null)}},async login(e,t,r=!1){try{const s={"Content-Type":"application/json"},o=await this.ensureCsrfToken();o&&(s["X-CSRF-Token"]=o);const n=await fetch("/api/auth/login",{method:"POST",headers:s,credentials:"include",body:JSON.stringify({email:e,password:t})}),i=await n.json();return n.ok?(this.setUser(i.user),{success:!0,user:i.user}):n.status===403&&i?.message?.toLowerCase().includes("csrf")&&!r?(console.log("CSRF token error during login, refreshing and retrying..."),await this.refreshCsrfToken(),this.login(e,t,!0)):{success:!1,error:i.message||"Login failed"}}catch(s){return console.error("Login error:",s),{success:!1,error:"Network error. Please try again."}}},async logout(){try{const e={},t=await this.ensureCsrfToken();t&&(e["X-CSRF-Token"]=t);const r=await fetch("/api/auth/logout",{method:"POST",headers:e,credentials:"include"});r.ok||console.warn("Server-side logout returned error:",r.status)}catch(e){console.error("Logout error:",e),console.warn("Server-side session may still be active due to:",e.message)}finally{this.clearAuth(),window.location.href="/pages/auth/login.html"}},async requireAuth(e=null){const t=await this.verify();return t?e&&!e.includes(t.role)?(t.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",null):t:(window.location.href="/pages/auth/login.html",null)},async redirectIfLoggedIn(){const e=await this.verify();return e?(e.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",!0):!1}};typeof window<"u"&&(window.Auth=d);function m(e,t={},r=[]){const s=document.createElement(e);return t&&Object.entries(t).forEach(([o,n])=>{o==="className"||o==="class"?s.className=n:o==="style"&&typeof n=="object"?Object.assign(s.style,n):o==="dataset"&&typeof n=="object"?Object.assign(s.dataset,n):o.startsWith("on")&&typeof n=="function"?s.addEventListener(o.substring(2).toLowerCase(),n):s.setAttribute(o,n)}),r&&(Array.isArray(r)||(r=[r]),r.forEach(o=>{o instanceof Node?s.appendChild(o):o!=null&&s.appendChild(document.createTextNode(String(o)))})),s}let c=null;function h(e,t="success",r=3e3){let s=document.getElementById("toast");s||(s=document.createElement("div"),s.id="toast",s.className="toast",document.body.appendChild(s)),c&&clearTimeout(c),s.classList.remove("toast-success","toast-error","toast-warning","toast-info","show"),s.textContent=e,s.classList.add(`toast-${t}`),requestAnimationFrame(()=>{s.classList.add("show")}),c=setTimeout(()=>{g()},r)}function g(){const e=document.getElementById("toast");e&&e.classList.remove("show")}function w(e,t=3e3){h(e,"success",t)}function p(){document.addEventListener("keydown",e=>{e.key==="Escape"&&(document.querySelectorAll(".modal-overlay.show").forEach(r=>{r.classList.remove("show")}),document.body.style.overflow="")})}function y(e,t){const r=document.getElementById(e);r&&(r.type==="password"?(r.type="text",t&&(t.textContent="○")):(r.type="password",t&&(t.textContent="◉")))}export{p as a,w as b,m as c,f as e,l as g,h as s,y as t};
