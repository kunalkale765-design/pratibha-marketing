{"version":3,"file":"orders-B4OGFhHj.js","sources":["../../src/js/pages/orders.js"],"sourcesContent":["import { showToast, createElement } from '/js/ui.js';\n\nfunction escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n}\n\n// Wait for Auth to be available\nconst waitForAuth = (maxWait = 10000) => new Promise((resolve, reject) => {\n    const startTime = Date.now();\n    const check = () => {\n        if (window.Auth) return resolve(window.Auth);\n        if (Date.now() - startTime > maxWait) return reject(new Error('Auth not available'));\n        setTimeout(check, 50);\n    };\n    check();\n});\nconst Auth = await waitForAuth();\n\nlet orders = [];\nconst marketRates = {};\nlet allProducts = []; // All available products for adding to orders\nlet addedProducts = []; // Newly added products (not yet saved)\nlet currentFilter = 'all';\nlet currentOrderId = null;\nlet currentOrder = null;\nlet currentUser = null;\nlet priceChanges = {};\nlet quantityChanges = {};\nlet isSaving = false; // Prevent concurrent saves\nlet isDeleting = false; // Prevent concurrent deletes\n\n// Track if global listeners have been initialized (prevents memory leak)\nlet globalListenersInitialized = false;\n\n// Packing panel state\nlet packingOrder = null;\nlet packingItems = [];\n\nasync function init() {\n    currentUser = await Auth.requireAuth();\n    if (!currentUser) return;\n\n    // Hide status controls for customers\n    if (currentUser.role === 'customer') {\n        const footer = document.getElementById('modalFooter');\n        if (footer) footer.style.display = 'none';\n    }\n\n    // Initialize global event listeners ONCE\n    initGlobalListeners();\n\n    await Promise.all([loadOrders(), loadMarketRates(), loadProducts()]);\n    setupFilters();\n    setupSearch();\n\n    // Handle deep links: /pages/orders/?order=<id>&action=pack\n    handleDeepLink();\n}\n\n// Handle deep links from Packing Station or other pages\nfunction handleDeepLink() {\n    const params = new URLSearchParams(window.location.search);\n    const orderId = params.get('order');\n    const action = params.get('action');\n\n    if (orderId) {\n        // Clear URL params without reload\n        window.history.replaceState({}, '', window.location.pathname);\n\n        if (action === 'pack') {\n            // Open packing panel directly\n            openPackingPanel(orderId);\n        } else {\n            // Open order detail modal\n            viewOrder(orderId);\n        }\n    }\n}\n\n// Initialize listeners that should only be added once (not per render)\nfunction initGlobalListeners() {\n    if (globalListenersInitialized) return;\n    globalListenersInitialized = true;\n\n    const container = document.getElementById('ordersList');\n    if (!container) return;\n\n    // Close swipe items when tapping elsewhere (ONCE, not per render)\n    document.addEventListener('click', (e) => {\n        if (!e.target.closest('.swipe-item')) {\n            document.querySelectorAll('.swipe-item.swiped, .swipe-item.swiped-single').forEach(item => {\n                item.classList.remove('swiped', 'swiped-single');\n            });\n        }\n    });\n\n    // Delegated touch handling for swipe gestures\n    let touchState = { startX: 0, isDragging: false, currentItem: null };\n\n    container.addEventListener('touchstart', (e) => {\n        const swipeItem = e.target.closest('.swipe-item');\n        if (!swipeItem) return;\n\n        touchState = {\n            startX: e.touches[0].clientX,\n            isDragging: true,\n            currentItem: swipeItem\n        };\n\n        // Close other open swipe items\n        document.querySelectorAll('.swipe-item.swiped, .swipe-item.swiped-single').forEach(item => {\n            if (item !== swipeItem) {\n                item.classList.remove('swiped', 'swiped-single');\n            }\n        });\n    }, { passive: true });\n\n    container.addEventListener('touchmove', (e) => {\n        if (!touchState.isDragging || !touchState.currentItem) return;\n\n        const diff = touchState.startX - e.touches[0].clientX;\n        const actionCount = touchState.currentItem.querySelectorAll('.swipe-action').length;\n\n        if (diff > 50) {\n            touchState.currentItem.classList.remove('swiped-single', 'swiped');\n            // Use appropriate class based on action count\n            if (actionCount === 1) {\n                touchState.currentItem.classList.add('swiped-single');\n            } else {\n                touchState.currentItem.classList.add('swiped');\n            }\n        } else if (diff < -20) {\n            touchState.currentItem.classList.remove('swiped', 'swiped-single');\n        }\n    }, { passive: true });\n\n    container.addEventListener('touchend', () => {\n        touchState.isDragging = false;\n        touchState.currentItem = null;\n    }, { passive: true });\n\n    // Mouse drag support for desktop (click and drag to swipe)\n    let mouseState = { startX: 0, isDragging: false, currentItem: null };\n\n    container.addEventListener('mousedown', (e) => {\n        const swipeItem = e.target.closest('.swipe-item');\n        if (!swipeItem) return;\n        // Don't start drag if clicking on a button\n        if (e.target.closest('button')) return;\n\n        mouseState = {\n            startX: e.clientX,\n            isDragging: true,\n            currentItem: swipeItem\n        };\n\n        // Close other open swipe items\n        document.querySelectorAll('.swipe-item.swiped, .swipe-item.swiped-single').forEach(item => {\n            if (item !== swipeItem) {\n                item.classList.remove('swiped', 'swiped-single');\n            }\n        });\n    });\n\n    container.addEventListener('mousemove', (e) => {\n        if (!mouseState.isDragging || !mouseState.currentItem) return;\n\n        const diff = mouseState.startX - e.clientX;\n        const actionCount = mouseState.currentItem.querySelectorAll('.swipe-action').length;\n\n        if (diff > 50) {\n            mouseState.currentItem.classList.remove('swiped-single', 'swiped');\n            // Use appropriate class based on action count\n            if (actionCount === 1) {\n                mouseState.currentItem.classList.add('swiped-single');\n            } else {\n                mouseState.currentItem.classList.add('swiped');\n            }\n        } else if (diff < -20) {\n            mouseState.currentItem.classList.remove('swiped', 'swiped-single');\n        }\n    });\n\n    container.addEventListener('mouseup', () => {\n        mouseState.isDragging = false;\n        mouseState.currentItem = null;\n    });\n\n    container.addEventListener('mouseleave', () => {\n        mouseState.isDragging = false;\n        mouseState.currentItem = null;\n    });\n\n    // Close modal on overlay click\n    const orderModal = document.getElementById('orderModal');\n    if (orderModal) {\n        orderModal.onclick = (e) => {\n            if (e.target.id === 'orderModal') closeModal();\n        };\n    }\n\n    // Close invoice modal on overlay click\n    const invoiceModal = document.getElementById('invoiceModal');\n    if (invoiceModal) {\n        invoiceModal.onclick = (e) => {\n            if (e.target.id === 'invoiceModal') closeInvoiceModal();\n        };\n    }\n}\n\nasync function loadMarketRates() {\n    try {\n        const res = await fetch('/api/market-rates', { credentials: 'include' });\n        if (!res.ok) {\n            throw new Error(`Server returned ${res.status}`);\n        }\n        const data = await res.json();\n        (data.data || []).forEach(r => {\n            const pid = typeof r.product === 'object' ? r.product._id : r.product;\n            marketRates[pid] = r.rate;\n        });\n    } catch (e) {\n        console.error('Failed to load market rates:', e);\n        // Show a subtle warning that can be dismissed\n        showDataLoadWarning('market-rates', 'Market rates may be outdated');\n    }\n}\n\nasync function loadProducts() {\n    try {\n        const res = await fetch('/api/products', { credentials: 'include' });\n        if (!res.ok) throw new Error(`Server returned ${res.status}`);\n        const data = await res.json();\n        allProducts = (data.data || []).filter(p => p.isActive !== false);\n    } catch (e) {\n        console.error('Failed to load products:', e);\n        // Show warning - this affects \"Add Product\" functionality\n        showDataLoadWarning('products', 'Product list unavailable');\n    }\n}\n\n// Show a dismissible warning banner for data load failures\nfunction showDataLoadWarning(type, message) {\n    // Don't show duplicate warnings\n    if (document.querySelector(`.data-warning[data-type=\"${type}\"]`)) return;\n\n    const warning = createElement('div', {\n        className: 'data-warning',\n        dataset: { type: type },\n        style: {\n            background: 'var(--warning, #b89a5a)',\n            color: 'white',\n            padding: '0.5rem 1rem',\n            fontSize: '0.85rem',\n            display: 'flex',\n            alignItems: 'center',\n            justifyContent: 'space-between',\n            gap: '0.5rem'\n        }\n    }, [\n        createElement('span', {}, `⚠️ ${message}`),\n        createElement('button', {\n            style: {\n                background: 'transparent',\n                border: 'none',\n                color: 'white',\n                cursor: 'pointer',\n                fontSize: '1rem',\n                padding: '0 0.25rem'\n            },\n            onclick: (e) => {\n                e.target.closest('.data-warning').remove();\n            }\n        }, '×')\n    ]);\n\n    // Insert at top of page\n    const container = document.getElementById('ordersList');\n    if (container && container.parentElement) {\n        container.parentElement.insertBefore(warning, container);\n    }\n}\n\nasync function loadOrders() {\n    try {\n        const res = await fetch('/api/orders?limit=100', { credentials: 'include' });\n        if (!res.ok) {\n            throw new Error(`Server returned ${res.status}`);\n        }\n        const data = await res.json();\n        if (!data.success) {\n            throw new Error(data.message || 'Orders temporarily unavailable');\n        }\n        orders = data.data || [];\n        // Debug: Log any orders with missing or invalid IDs\n        const invalidOrders = orders.filter(o => !o._id || !/^[a-f\\d]{24}$/i.test(o._id));\n        if (invalidOrders.length > 0) {\n            console.warn('Orders with invalid IDs:', invalidOrders.map(o => ({ orderNumber: o.orderNumber, _id: o._id })));\n        }\n        renderOrders();\n    } catch (e) {\n        console.error('Failed to load orders:', e);\n        // Show retry UI if no orders loaded yet\n        if (!orders || orders.length === 0) {\n            const container = document.getElementById('ordersList');\n            const errorMsg = !navigator.onLine ? 'No internet connection' : 'Orders not available';\n            container.innerHTML = '';\n            container.appendChild(createElement('div', { className: 'empty-state' }, [\n                createElement('p', {}, errorMsg),\n                createElement('button', {\n                    id: 'retryOrdersBtn',\n                    style: { marginTop: '1rem', padding: '0.5rem 1rem', background: 'var(--dusty-olive)', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer' },\n                    onclick: loadOrders\n                }, 'Try Again')\n            ]));\n        }\n    }\n}\n\nfunction getInitials(name) {\n    if (!name) return '?';\n    const words = name.trim().split(/\\s+/);\n    if (words.length === 1) {\n        return words[0].substring(0, 2).toUpperCase();\n    }\n    return (words[0][0] + words[words.length - 1][0]).toUpperCase();\n}\n\nfunction renderOrders() {\n    const container = document.getElementById('ordersList');\n    if (!container) return;\n\n    const searchInput = document.getElementById('searchInput');\n    const search = searchInput ? searchInput.value.toLowerCase() : '';\n    const isAdmin = currentUser?.role === 'admin';\n    const isStaff = currentUser?.role === 'admin' || currentUser?.role === 'staff';\n\n    // Filter out orders without valid _id first\n    let filtered = orders.filter(o => o._id && /^[a-f\\d]{24}$/i.test(o._id));\n\n    // Filter by status\n    if (currentFilter === 'all') {\n        // \"All\" shows everything except cancelled (there's a dedicated Cancelled tab)\n        filtered = filtered.filter(o => o.status !== 'cancelled');\n    } else {\n        filtered = filtered.filter(o => o.status === currentFilter);\n    }\n\n    // Filter by search\n    if (search) {\n        filtered = filtered.filter(o =>\n            o.orderNumber?.toLowerCase().includes(search) ||\n            o.customer?.name?.toLowerCase().includes(search)\n        );\n    }\n\n    if (!filtered.length) {\n        container.innerHTML = '';\n        container.appendChild(createElement('div', { className: 'empty-state' }, 'No orders found'));\n        return;\n    }\n\n    // Clear container\n    container.innerHTML = '';\n\n    const fragment = document.createDocumentFragment();\n\n    filtered.forEach((o, idx) => {\n        // Batch Badge\n        let batchBadge = null;\n        if (o.batch?.batchType) {\n            batchBadge = createElement('span', { className: 'badge badge-batch' }, o.batch.batchType);\n        }\n\n        // Packing Status Badge - show for confirmed orders\n        let packingBadge = null;\n        if (isStaff && o.status === 'confirmed') {\n            if (o.packingDone) {\n                packingBadge = createElement('span', { className: 'packing-status-badge status-packed' }, '✓ Packed');\n            } else {\n                packingBadge = createElement('span', { className: 'packing-status-badge status-ready' }, 'Ready');\n            }\n        }\n\n        // Swipe Content\n        const swipeContent = createElement('div', {\n            className: 'swipe-content',\n            onclick: () => window.viewOrder(o._id)\n        }, [\n            createElement('div', { className: 'order-avatar' }, getInitials(o.customer?.name)),\n            createElement('div', { className: 'order-info' }, [\n                createElement('div', { className: 'order-customer' }, o.customer?.name || 'Unknown'),\n                o.notes ? createElement('div', { className: 'order-notes' }, o.notes) : null,\n                createElement('div', { className: 'order-meta-row' }, [\n                    createElement('span', { className: 'order-number' }, `Order #${o.orderNumber}`),\n                    batchBadge,\n                    packingBadge\n                ])\n            ]),\n            createElement('div', { className: 'order-amount-pill' }, `₹${(o.totalAmount || 0).toLocaleString('en-IN')}`)\n        ]);\n\n        // Swipe Actions - add Pack action for confirmed orders that aren't packed yet\n        const actions = [];\n        const canPack = isStaff && o.status === 'confirmed' && !o.packingDone;\n\n        if (canPack) {\n            actions.push(createElement('button', {\n                className: 'swipe-action pack',\n                onclick: (e) => { e.stopPropagation(); window.openPackingPanel(o._id); }\n            }, 'Pack'));\n        }\n        // Show Bill button for confirmed orders with a batch\n        const canDownloadBill = isStaff && o.status === 'confirmed' && o.batch;\n        if (canDownloadBill) {\n            actions.push(createElement('button', {\n                className: 'swipe-action bill',\n                onclick: (e) => { e.stopPropagation(); window.downloadDeliveryBill(o._id, o.batch?._id || o.batch); }\n            }, 'Bill'));\n        }\n        if (isAdmin) {\n            actions.push(createElement('button', {\n                className: 'swipe-action delete',\n                onclick: (e) => { e.stopPropagation(); window.deleteOrder(o._id); }\n            }, 'Delete'));\n        }\n        const swipeActions = createElement('div', { className: 'swipe-actions' }, actions);\n\n        // Determine action count class for desktop hover\n        let actionCountClass = '';\n        if (actions.length === 1) actionCountClass = 'single-action';\n        else if (actions.length === 2) actionCountClass = 'two-actions';\n\n        // Main Card\n        const card = createElement('div', {\n            className: `swipe-item card-fade-in ${actionCountClass}`.trim(),\n            dataset: { orderId: o._id },\n            style: { animationDelay: `${idx * 0.05}s` }\n        }, [swipeContent, swipeActions]);\n\n        fragment.appendChild(card);\n    });\n\n    container.appendChild(fragment);\n    // Swipe handlers are now initialized once in initGlobalListeners() using event delegation\n}\n\nfunction setupFilters() {\n    const segmentControl = document.getElementById('filterSegments');\n    const indicator = document.getElementById('segmentIndicator');\n    const buttons = segmentControl.querySelectorAll('.segment-btn');\n\n    // Function to move indicator to a button\n    function moveIndicator(btn) {\n        const controlRect = segmentControl.getBoundingClientRect();\n        const btnRect = btn.getBoundingClientRect();\n\n        // Calculate position relative to the segment control\n        const left = btnRect.left - controlRect.left;\n        const width = btnRect.width;\n\n        indicator.style.left = left + 'px';\n        indicator.style.width = width + 'px';\n    }\n\n    // Initialize indicator position\n    const activeBtn = segmentControl.querySelector('.segment-btn.active');\n    if (activeBtn) {\n        // Small delay to ensure layout is complete\n        setTimeout(() => moveIndicator(activeBtn), 10);\n    }\n\n    // Handle clicks\n    buttons.forEach(btn => {\n        btn.onclick = () => {\n            // Update active state\n            buttons.forEach(b => b.classList.remove('active'));\n            btn.classList.add('active');\n\n            // Slide the indicator\n            moveIndicator(btn);\n\n            // Update filter and re-render with animation\n            currentFilter = btn.dataset.filter;\n            const container = document.getElementById('ordersList');\n            container.classList.add('segment-content');\n            renderOrders();\n\n            // Remove animation class after it plays\n            setTimeout(() => container.classList.remove('segment-content'), 300);\n        };\n    });\n\n    // Recalculate on window resize\n    window.addEventListener('resize', () => {\n        const active = segmentControl.querySelector('.segment-btn.active');\n        if (active) moveIndicator(active);\n    });\n}\n\n// Debounce utility to prevent excessive function calls\nfunction debounce(fn, delay) {\n    let timeoutId;\n    return function (...args) {\n        clearTimeout(timeoutId);\n        timeoutId = setTimeout(() => fn.apply(this, args), delay);\n    };\n}\n\nfunction setupSearch() {\n    const searchInput = document.getElementById('searchInput');\n    if (searchInput) {\n        const debouncedRender = debounce(renderOrders, 200);\n        searchInput.addEventListener('input', debouncedRender);\n    }\n}\n\n// Invoice state\nlet invoiceData = null;\nlet selectedFirmId = null;\nlet selectedProductIds = new Set();\n\n// Download delivery bill for an order\nasync function downloadDeliveryBill(orderId, batchId) {\n    // Only staff/admin can download delivery bills\n    if (currentUser?.role === 'customer') {\n        showToast('Delivery bills are not available', 'info');\n        return;\n    }\n\n    // Close swipe\n    document.querySelectorAll('.swipe-item.swiped, .swipe-item.swiped-single').forEach(item => {\n        item.classList.remove('swiped', 'swiped-single');\n    });\n\n    // Validate IDs\n    const isValidMongoId = /^[a-f\\d]{24}$/i.test(orderId);\n    const isValidBatchId = /^[a-f\\d]{24}$/i.test(batchId);\n    if (!orderId || !isValidMongoId || !batchId || !isValidBatchId) {\n        console.error('Invalid order or batch ID:', orderId, batchId);\n        showToast('Order data updating. Please refresh.', 'info');\n        return;\n    }\n\n    // Disable the bill button to prevent double-download\n    const billBtn = document.querySelector(`.swipe-item[data-order-id=\"${orderId}\"] .swipe-action.bill`);\n    if (billBtn) {\n        billBtn.disabled = true;\n        billBtn.classList.add('btn-loading');\n    }\n\n    showToast('Downloading delivery bill...', 'info');\n\n    try {\n        const response = await fetch(`/api/batches/${batchId}/bills/${orderId}/download?copy=original`, {\n            credentials: 'include'\n        });\n\n        if (!response.ok) {\n            const errorData = await response.json().catch(() => ({}));\n            throw new Error(errorData.message || 'Failed to download delivery bill');\n        }\n\n        // Get filename from Content-Disposition header or use default\n        const contentDisposition = response.headers.get('Content-Disposition');\n        let filename = 'delivery-bill.pdf';\n        if (contentDisposition) {\n            const match = contentDisposition.match(/filename=\"?([^\";\\n]+)\"?/);\n            if (match) filename = match[1];\n        }\n\n        // Download the file\n        const blob = await response.blob();\n        const url = window.URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = filename;\n        document.body.appendChild(a);\n        a.click();\n        window.URL.revokeObjectURL(url);\n        a.remove();\n\n        showToast('Delivery bill downloaded!', 'success');\n    } catch (error) {\n        console.error('Error downloading delivery bill:', error);\n        showToast(error.message || 'Failed to download delivery bill', 'error');\n    } finally {\n        if (billBtn) {\n            billBtn.disabled = false;\n            billBtn.classList.remove('btn-loading');\n        }\n    }\n}\n\nasync function printOrder(orderId) {\n    // Only staff/admin can print invoices\n    if (currentUser?.role === 'customer') {\n        showToast('Invoice printing is not available', 'info');\n        return;\n    }\n\n    // Close swipe\n    document.querySelectorAll('.swipe-item.swiped, .swipe-item.swiped-single').forEach(item => {\n        item.classList.remove('swiped', 'swiped-single');\n    });\n\n    // Validate order ID before proceeding\n    const isValidMongoId = /^[a-f\\d]{24}$/i.test(orderId);\n    if (!orderId || !isValidMongoId) {\n        console.error('Invalid order ID:', orderId);\n        showToast('Order data updating. Please refresh.', 'info');\n        return;\n    }\n\n    // Show invoice modal with loading\n    document.getElementById('invoiceModal').classList.add('show');\n    document.getElementById('invoiceModal').classList.add('show');\n    const modalBody = document.getElementById('invoiceModalBody');\n    modalBody.innerHTML = '';\n    modalBody.appendChild(createElement('div', { className: 'invoice-loading' }, 'Loading invoice data...'));\n    const generateBtn = document.getElementById('generateInvoiceBtn');\n    if (generateBtn) generateBtn.disabled = true;\n\n    try {\n        // Load firms list first\n        const firmsResult = await loadFirms();\n        if (!firmsResult.success) {\n            throw new Error('Could not load firm list. Please try again.');\n        }\n\n        // Fetch split data from API\n        const res = await fetch(`/api/invoices/${orderId}/split`, { credentials: 'include' });\n        if (!res.ok) {\n            const errData = await res.json().catch(() => ({}));\n            throw new Error(errData.message || 'Invoice data temporarily unavailable');\n        }\n        const data = await res.json();\n        invoiceData = data.data;\n\n        // Set modal title\n        document.getElementById('invoiceModalTitle').textContent = `Invoice for ${invoiceData.orderNumber}`;\n\n        // Render firms and items\n        renderInvoiceModal();\n    } catch (error) {\n        console.error('Print order error:', error);\n        document.getElementById('invoiceModalBody').innerHTML = ''; // Clear loading\n        document.getElementById('invoiceModalBody').appendChild(createElement('div', { className: 'invoice-no-items' }, [\n            createElement('p', {}, 'Invoice data not available'),\n            createElement('p', { style: { fontSize: '0.75rem', marginTop: '0.5rem' } }, error.message)\n        ]));\n    }\n}\n\n// All available firms (fetched once)\nlet allFirms = [];\n\nasync function loadFirms() {\n    if (allFirms.length > 0) return { success: true };\n    try {\n        const res = await fetch('/api/invoices/firms', { credentials: 'include' });\n        if (!res.ok) {\n            throw new Error(`Server returned ${res.status}`);\n        }\n        const data = await res.json();\n        allFirms = data.data || [];\n        return { success: true };\n    } catch (e) {\n        console.error('Failed to load firms:', e);\n        // Return error so caller can handle it\n        return { success: false, error: e.message };\n    }\n}\n\nfunction renderInvoiceModal() {\n    const modalBody = document.getElementById('invoiceModalBody');\n    if (!invoiceData) {\n        modalBody.innerHTML = '';\n        modalBody.appendChild(createElement('div', { className: 'invoice-no-items' }, 'No items to invoice'));\n        return;\n    }\n\n    // Get all items from all firms (flatten)\n    const allItems = invoiceData.firms.flatMap(f => f.items);\n    if (allItems.length === 0) {\n        modalBody.innerHTML = '';\n        modalBody.appendChild(createElement('div', { className: 'invoice-no-items' }, 'No items to invoice'));\n        return;\n    }\n\n    // Auto-select first firm and all items if none selected\n    if (!selectedFirmId) {\n        selectedFirmId = allFirms.length > 0 ? allFirms[0].id : (invoiceData?.firms?.[0]?.firmId || 'pratibha');\n        selectedProductIds = new Set(allItems.map(i => i.productId));\n    }\n\n    // Calculate selected total\n    const selectedTotal = allItems\n        .filter(i => selectedProductIds.has(i.productId))\n        .reduce((sum, i) => sum + (i.amount || 0), 0);\n\n    // Build firm selector\n    const firmsToShow = allFirms.length > 0 ? allFirms : (invoiceData?.firms || []).map(f => ({ id: f.firmId, name: f.firmName }));\n\n    modalBody.innerHTML = '';\n    const fragment = document.createDocumentFragment();\n\n    // Firm Selector\n    const firmSelector = createElement('div', { className: 'invoice-firm-selector' }, [\n        createElement('div', { className: 'info-label', style: { marginBottom: '0.5rem' } }, 'Select Firm'),\n        createElement('div', { className: 'firm-options' }, firmsToShow.map(firm =>\n            createElement('label', {\n                className: `firm-option ${selectedFirmId === firm.id ? 'selected' : ''}`,\n                onclick: () => window.selectFirm(firm.id)\n            }, [\n                createElement('input', {\n                    type: 'radio',\n                    name: 'firm',\n                    value: firm.id,\n                    checked: selectedFirmId === firm.id\n                }),\n                createElement('span', { className: 'firm-option-name' }, firm.name)\n            ])\n        ))\n    ]);\n    fragment.appendChild(firmSelector);\n\n    // Items Section\n    fragment.appendChild(createElement('div', { className: 'info-label', style: { margin: '1rem 0 0.5rem' } }, 'Select Items'));\n    fragment.appendChild(createElement('div', { className: 'invoice-items-list' }, allItems.map(item =>\n        createElement('div', { className: 'invoice-item' }, [\n            createElement('input', {\n                type: 'checkbox',\n                className: 'invoice-item-checkbox',\n                dataset: { product: item.productId },\n                checked: selectedProductIds.has(item.productId),\n                onchange: () => window.toggleInvoiceItem(null, item.productId)\n            }),\n            createElement('div', { className: 'invoice-item-details' }, [\n                createElement('div', { className: 'invoice-item-name' }, item.productName),\n                createElement('div', { className: 'invoice-item-meta' }, `${item.quantity || 0} ${item.unit || ''} × ₹${(item.rate || 0).toLocaleString('en-IN')}`)\n            ]),\n            createElement('div', { className: 'invoice-item-amount' }, `₹${(item.amount || 0).toLocaleString('en-IN')}`)\n        ])\n    )));\n\n    // Summary Section\n    fragment.appendChild(createElement('div', { className: 'invoice-summary' }, [\n        createElement('div', { className: 'invoice-summary-label' }, 'Total'),\n        createElement('div', { className: 'invoice-summary-total' }, `₹${selectedTotal.toLocaleString('en-IN')}`)\n    ]));\n\n    modalBody.appendChild(fragment);\n    const generateBtn = document.getElementById('generateInvoiceBtn');\n    if (generateBtn) generateBtn.disabled = selectedProductIds.size === 0;\n}\n\nfunction selectFirm(firmId) {\n    selectedFirmId = firmId;\n    renderInvoiceModal();\n}\n\nfunction toggleInvoiceItem(firmId, productId) {\n    if (selectedProductIds.has(productId)) {\n        selectedProductIds.delete(productId);\n    } else {\n        selectedProductIds.add(productId);\n    }\n    renderInvoiceModal();\n}\n\nasync function generateInvoice() {\n    // Button should already be disabled if no items selected\n    if (!invoiceData || !selectedFirmId || selectedProductIds.size === 0) {\n        return;\n    }\n\n    const btn = document.getElementById('generateInvoiceBtn');\n    btn.classList.add('btn-loading');\n    btn.disabled = true;\n\n    try {\n        const headers = { 'Content-Type': 'application/json' };\n        const csrfToken = await Auth.ensureCsrfToken();\n        if (csrfToken) {\n            headers['X-CSRF-Token'] = csrfToken;\n        }\n\n        const res = await fetch(`/api/invoices/${invoiceData.orderId}/pdf`, {\n            method: 'POST',\n            headers,\n            credentials: 'include',\n            body: JSON.stringify({\n                firmId: selectedFirmId,\n                productIds: Array.from(selectedProductIds)\n            })\n        });\n\n        if (!res.ok) {\n            const errData = await res.json().catch(() => ({}));\n            throw new Error(errData.message || 'Invoice generation temporarily unavailable');\n        }\n\n        // Download the PDF\n        const blob = await res.blob();\n        const url = URL.createObjectURL(blob);\n        const a = document.createElement('a');\n        a.href = url;\n        a.download = `INV${invoiceData.orderNumber.replace('ORD', '')}.pdf`;\n        document.body.appendChild(a);\n        a.click();\n        document.body.removeChild(a);\n        URL.revokeObjectURL(url);\n\n        showToast('Invoice downloaded', 'success');\n        closeInvoiceModal();\n    } catch (error) {\n        console.error('Generate invoice error:', error);\n        showToast(error.message || 'Could not generate invoice', 'info');\n    } finally {\n        btn.classList.remove('btn-loading');\n        btn.disabled = false;\n    }\n}\n\nfunction closeInvoiceModal() {\n    document.getElementById('invoiceModal').classList.remove('show');\n    invoiceData = null;\n    selectedFirmId = null;\n    selectedProductIds = new Set();\n}\n\nfunction printFromModal() {\n    // Silently return if no order - button shouldn't be clickable without an order\n    if (!currentOrderId) {\n        return;\n    }\n    // Save the ID before closeModal clears it\n    const orderId = currentOrderId;\n    closeModal(); // Close order detail modal (this sets currentOrderId = null)\n    printOrder(orderId); // Open invoice modal with saved ID\n}\n\nasync function deleteOrder(orderId) {\n    // Prevent concurrent deletes\n    if (isDeleting) return;\n\n    // Admin check - button should be hidden for non-admins anyway\n    if (currentUser?.role !== 'admin') {\n        return;\n    }\n\n    if (!confirm('Are you sure you want to delete this order? This action cannot be undone.')) {\n        return;\n    }\n\n    isDeleting = true;\n    const item = document.querySelector(`.swipe-item[data-order-id=\"${orderId}\"]`);\n\n    try {\n        const headers = { 'Content-Type': 'application/json' };\n        const csrfToken = await Auth.ensureCsrfToken();\n        if (csrfToken) {\n            headers['X-CSRF-Token'] = csrfToken;\n        }\n\n        const res = await fetch(`/api/orders/${orderId}`, {\n            method: 'DELETE',\n            headers,\n            credentials: 'include'\n        });\n\n        if (res.ok) {\n            // Add delete animation then reload orders\n            if (item) {\n                item.classList.add('deleting');\n                setTimeout(() => {\n                    loadOrders(); // Reload from server\n                }, 300);\n            } else {\n                loadOrders(); // Reload from server\n            }\n            showToast('Order cancelled', 'success');\n        } else {\n            const errData = await res.json().catch(() => ({ message: 'Could not cancel. Try again.' }));\n            showToast(errData.message || 'Could not cancel', 'info');\n        }\n    } catch (e) {\n        console.error('Delete order error:', e);\n        showToast('Could not delete order', 'info');\n    } finally {\n        isDeleting = false;\n    }\n}\n\nasync function viewOrder(id) {\n    // Prevent opening new order while saving is in progress\n    if (isSaving) {\n        showToast('Please wait, saving in progress...', 'info');\n        return;\n    }\n\n    try {\n        const res = await fetch(`/api/orders/${id}`, { credentials: 'include' });\n\n        // Handle non-JSON responses\n        let data;\n        try {\n            data = await res.json();\n        } catch (parseError) {\n            console.error('Failed to parse order response:', parseError);\n            showToast('Server issue. Please refresh.', 'info');\n            return;\n        }\n\n        if (!res.ok) {\n            showToast(data?.message || 'Could not load order', 'info');\n            return;\n        }\n\n        const order = data.data;\n        if (!order || !order.products) {\n            showToast('Order data updating. Refresh page.', 'info');\n            return;\n        }\n\n        currentOrderId = id;\n        currentOrder = order;\n        priceChanges = {};\n        quantityChanges = {};\n        addedProducts = [];\n\n        const modalTitle = document.getElementById('modalTitle');\n        if (modalTitle) modalTitle.textContent = `#${order.orderNumber}`;\n\n        const saveBtn = document.getElementById('savePricesBtn');\n        if (saveBtn) saveBtn.disabled = true;\n\n        const isStaff = currentUser.role === 'admin' || currentUser.role === 'staff';\n\n        const _batchInfo = order.batch?.batchType\n            ? `<span class=\"badge badge-batch\">${order.batch.batchType}</span>`\n            : '-';\n\n        const modalBody = document.getElementById('modalBody');\n        modalBody.innerHTML = ''; // Clear existing content\n\n        const fragment = document.createDocumentFragment();\n\n        // Customer Info Row\n        const infoRow1 = createElement('div', { className: 'info-row' }, [\n            createElement('div', {}, [\n                createElement('div', { className: 'info-label' }, 'Customer'),\n                createElement('div', { className: 'info-value' }, order.customer?.name || '')\n            ]),\n            createElement('div', {}, [\n                createElement('div', { className: 'info-label' }, 'Phone'),\n                createElement('div', { className: 'info-value' }, order.customer?.phone || '-')\n            ])\n        ]);\n        fragment.appendChild(infoRow1);\n\n        // Date and Batch Row\n        const batchBadge = order.batch?.batchType\n            ? createElement('span', { className: 'badge badge-batch' }, order.batch.batchType)\n            : '-';\n\n        const infoRow2 = createElement('div', { className: 'info-row' }, [\n            createElement('div', {}, [\n                createElement('div', { className: 'info-label' }, 'Date'),\n                createElement('div', { className: 'info-value' }, new Date(order.createdAt).toLocaleDateString('en-IN'))\n            ]),\n            createElement('div', {}, [\n                createElement('div', { className: 'info-label' }, 'Batch'),\n                createElement('div', { className: 'info-value' }, Array.isArray(batchBadge) ? batchBadge : [batchBadge])\n            ])\n        ]);\n        fragment.appendChild(infoRow2);\n\n        // Status Row\n        const infoRow3 = createElement('div', { className: 'info-row' }, [\n            createElement('div', {}, [\n                createElement('div', { className: 'info-label' }, 'Status'),\n                createElement('div', { className: 'info-value' }, [\n                    createElement('span', { className: `badge badge-${order.status}` }, order.status)\n                ])\n            ]),\n            createElement('div', {})\n        ]);\n        fragment.appendChild(infoRow3);\n\n        // Products Section\n        const infoSection = createElement('div', { className: 'info-section' });\n        infoSection.appendChild(createElement('div', { className: 'info-label' }, 'Products'));\n\n        order.products.forEach((p, idx) => {\n            const productId = typeof p.product === 'object' ? p.product._id : p.product;\n            const purchasePrice = marketRates[productId] || p.rate || null;\n            const purchaseDisplay = purchasePrice ? `₹${purchasePrice.toLocaleString('en-IN')}` : 'N/A';\n\n            // Qty Controls (Staff) or Display (Customer)\n            let qtyDisplay;\n            if (isStaff) {\n                const qtyInput = createElement('input', {\n                    type: 'number',\n                    className: 'qty-input-sm input-animated',\n                    id: `quantity-${idx}`,\n                    value: p.quantity,\n                    min: '0',\n                    step: '0.01',\n                    dataset: {\n                        idx: idx,\n                        original: p.quantity,\n                        unit: p.unit\n                    },\n                    onfocus: (e) => window.clearZero(e.target),\n                    onblur: (e) => window.restoreValue(e.target),\n                    onchange: () => window.handleQuantityChange(idx),\n                    oninput: () => window.handleQuantityInput(idx)\n                });\n\n                qtyDisplay = createElement('div', { className: 'qty-controls-inline' }, [\n                    createElement('button', { className: 'qty-btn-sm', type: 'button', onclick: () => window.changeQuantity(idx, -1) }, '−'),\n                    qtyInput,\n                    createElement('button', { className: 'qty-btn-sm', type: 'button', onclick: () => window.changeQuantity(idx, 1) }, '+'),\n                    createElement('span', { className: 'qty-unit' }, p.unit)\n                ]);\n            } else {\n                qtyDisplay = createElement('div', { className: 'product-qty' }, `${p.quantity} ${p.unit}`);\n            }\n\n            // Selling Price Controls (Staff) or Display (Customer)\n            const sellingLabelChildren = ['Selling'];\n            if (p.isContractPrice) {\n                sellingLabelChildren.push(' ');\n                sellingLabelChildren.push(createElement('span', { className: 'contract-badge' }, 'Fixed'));\n            }\n\n            let sellingDisplay;\n            if (isStaff) {\n                const priceInput = createElement('input', {\n                    type: 'number',\n                    className: `price-input input-animated${p.isContractPrice ? ' contract-locked' : ''}`,\n                    id: `price-${idx}`,\n                    value: p.rate,\n                    min: '0',\n                    step: '0.01',\n                    dataset: {\n                        idx: idx,\n                        original: p.rate,\n                        qty: p.quantity,\n                        contract: p.isContractPrice || false\n                    },\n                    onfocus: (e) => window.clearZero(e.target),\n                    onblur: (e) => window.restoreValue(e.target),\n                    onchange: () => window.handlePriceChange(idx),\n                    oninput: () => window.handlePriceInput(idx)\n                });\n                if (p.isContractPrice) {\n                    priceInput.disabled = true;\n                    priceInput.title = 'Contract price - edit in customer management';\n                }\n                sellingDisplay = priceInput;\n            } else {\n                sellingDisplay = createElement('div', { className: 'price-value' }, `₹${p.rate}`);\n            }\n\n            const productItem = createElement('div', { className: 'product-item', dataset: { idx: idx } }, [\n                createElement('div', { className: 'product-top' }, [\n                    createElement('div', {}, [\n                        createElement('div', { className: 'product-name' }, p.productName),\n                        qtyDisplay\n                    ])\n                ]),\n                createElement('div', { className: 'prices-container' }, [\n                    createElement('div', { className: 'price-box' }, [\n                        createElement('div', { className: 'price-label' }, 'Purchase'),\n                        createElement('div', { className: 'price-value' }, purchaseDisplay)\n                    ]),\n                    createElement('div', { className: 'price-box' }, [\n                        createElement('div', { className: 'price-label' }, sellingLabelChildren),\n                        sellingDisplay\n                    ])\n                ]),\n                createElement('div', { className: 'amount-row' }, [\n                    createElement('span', { className: 'amount-label' }, 'Amount'),\n                    createElement('span', { className: 'amount-display', id: `amount-${idx}` }, `₹${p.amount}`)\n                ])\n            ]);\n            infoSection.appendChild(productItem);\n        });\n\n        // Added Products Container\n        infoSection.appendChild(createElement('div', { id: 'addedProductsContainer' }));\n\n        // Add Product Section (Staff Only)\n        if (isStaff) {\n            const productOptions = [createElement('option', { value: '' }, '+ Add Product...')];\n            allProducts\n                .filter(p => !order.products.some(op => (typeof op.product === 'object' ? op.product._id : op.product) === p._id))\n                .forEach(p => {\n                    productOptions.push(createElement('option', {\n                        value: p._id,\n                        dataset: { name: p.name, unit: p.unit }\n                    }, `${p.name} (${p.unit})`));\n                });\n\n            const productSelector = createElement('select', {\n                id: 'productSelector',\n                className: 'product-select',\n                onchange: () => window.addProductToOrder()\n            }, productOptions);\n\n            const addProductDiv = createElement('div', { className: 'add-product-section' }, [productSelector]);\n            infoSection.appendChild(addProductDiv);\n        }\n\n        fragment.appendChild(infoSection);\n\n        // Total Section\n        const totalSection = createElement('div', { className: 'total-section' }, [\n            createElement('div', { className: 'total-row' }, [\n                createElement('span', {}, 'Total'),\n                createElement('span', { id: 'orderTotal' }, `₹${order.totalAmount}`)\n            ]),\n            createElement('div', { className: 'total-row' }, [\n                createElement('span', {}, 'Paid'),\n                createElement('span', {}, `₹${order.paidAmount || 0}`)\n            ]),\n            createElement('div', { className: 'total-row main' }, [\n                createElement('span', {}, 'Balance'),\n                createElement('span', { id: 'orderBalance' }, `₹${order.totalAmount - (order.paidAmount || 0)}`)\n            ])\n        ]);\n        fragment.appendChild(totalSection);\n\n        modalBody.appendChild(fragment);\n\n        // Dynamic Footer Actions\n        if (isStaff) {\n            const footer = document.getElementById('modalFooter');\n            if (footer) {\n                footer.innerHTML = ''; // Clear existing static buttons\n\n                // 1. Print Invoice Button\n                const printBtn = createElement('button', {\n                    className: 'btn-modal secondary btn-animated',\n                    onclick: () => window.printFromModal()\n                }, createElement('span', { className: 'btn-text' }, 'Invoice'));\n                footer.appendChild(printBtn);\n\n                // 2. Action Button (Status Change) OR Save Button\n                // We show specific status actions if no unsaved changes, otherwise Save\n\n                // Confirm Order (Pending -> Confirmed)\n                if (order.status === 'pending') {\n                    const confirmBtn = createElement('button', {\n                        className: 'btn-modal primary btn-animated status-action-btn',\n                        style: { background: 'var(--dusty-olive)', color: 'white', flex: '1.5' },\n                        onclick: () => window.updateOrderStatus(order._id, 'confirmed')\n                    }, 'Confirm Order');\n                    footer.appendChild(confirmBtn);\n                }\n\n                // Mark Delivered (Confirmed -> Delivered) - only show if packing is done\n                else if (order.status === 'confirmed' && order.packingDone) {\n                    const deliverBtn = createElement('button', {\n                        className: 'btn-modal primary btn-animated status-action-btn',\n                        style: { background: 'var(--gunmetal)', color: 'white', flex: '1.5' },\n                        onclick: () => window.updateOrderStatus(order._id, 'delivered')\n                    }, 'Mark Delivered');\n                    footer.appendChild(deliverBtn);\n                }\n\n                // Pack Order button (for confirmed orders not yet packed)\n                const canPack = order.status === 'confirmed' && !order.packingDone;\n\n                if (canPack) {\n                    const packBtn = createElement('button', {\n                        className: 'btn-modal secondary btn-animated',\n                        style: { background: 'var(--dusty-olive)', color: 'white', border: 'none' },\n                        onclick: () => { window.closeModal(); setTimeout(() => window.openPackingPanel(order._id), 200); }\n                    }, 'Start Packing');\n                    footer.appendChild(packBtn);\n                }\n\n                // 3. Save Changes Button (Always present but maybe hidden/disabled until changes)\n                // Actually, let's keep it simple: Save Button is always there but disabled if no changes\n                // But we want prominent status buttons. \n                // Let's add Save button too.\n\n                const saveBtn = createElement('button', {\n                    className: 'btn-save-prices btn-animated',\n                    id: 'savePricesBtn',\n                    disabled: true, // Initially disabled\n                    onclick: () => window.savePrices()\n                }, createElement('span', { className: 'btn-text' }, 'Save'));\n                footer.appendChild(saveBtn);\n            }\n        }\n\n        document.getElementById('orderModal').classList.add('show');\n    } catch (err) {\n        console.error('Error in viewOrder:', err);\n        // Reset state and close modal on error\n        currentOrder = null;\n        currentOrderId = null;\n        const modal = document.getElementById('orderModal');\n        if (modal) modal.classList.remove('show');\n\n        // Provide specific error messages based on error type\n        if (!navigator.onLine) {\n            showToast('No internet connection. Check your network.', 'error');\n        } else if (err.message?.includes('401') || err.message?.includes('403')) {\n            showToast('Session expired. Please log in again.', 'error');\n            setTimeout(() => { window.location.href = '/pages/auth/login.html'; }, 1500);\n        } else if (err.message?.includes('404')) {\n            showToast('Order not found. It may have been deleted.', 'error');\n        } else if (err.message?.includes('500')) {\n            showToast('Server error. Please try again in a moment.', 'error');\n        } else {\n            showToast('Could not load order. Please try again.', 'info');\n        }\n    }\n}\n\nfunction clearZero(input) {\n    input.dataset.prevValue = input.value;\n    input.value = '';\n    input.select();\n}\n\nfunction restoreValue(input) {\n    if (input.value === '') {\n        input.value = input.dataset.prevValue || input.dataset.original;\n    }\n    const idx = parseInt(input.dataset.idx);\n    handlePriceChange(idx);\n}\n\nfunction handlePriceInput(idx) {\n    const input = document.getElementById(`price-${idx}`);\n    if (!input) return;\n    const qtyInput = document.getElementById(`quantity-${idx}`);\n    const original = parseFloat(input.dataset.original);\n    const current = parseFloat(input.value) || 0;\n    // Use quantity from input if exists, otherwise from data attribute\n    const qty = qtyInput ? (parseFloat(qtyInput.value) || 0) : parseFloat(input.dataset.qty);\n\n    input.classList.toggle('changed', current !== original);\n\n    // Update amount display (round to 2 decimal places for consistency)\n    const amount = Math.round(current * qty * 100) / 100;\n    const amountEl = document.getElementById(`amount-${idx}`);\n    if (amountEl) amountEl.textContent = `₹${amount.toLocaleString('en-IN')}`;\n\n    // Update total\n    updateOrderTotal();\n}\n\nfunction handlePriceChange(idx) {\n    const input = document.getElementById(`price-${idx}`);\n    if (!input) return;\n    const original = parseFloat(input.dataset.original);\n    const current = parseFloat(input.value) || 0;\n\n    if (current !== original && current > 0) {\n        priceChanges[idx] = current;\n    } else {\n        delete priceChanges[idx];\n    }\n\n    // Enable/disable save button\n    updateSaveButtonState();\n}\n\n// Quantity change handlers\nfunction changeQuantity(idx, delta) {\n    const input = document.getElementById(`quantity-${idx}`);\n    if (!input) return;\n\n    const current = parseFloat(input.value) || 0;\n    let newValue = current + delta;\n\n    // Minimum quantity for all units\n    const minQty = 0.01;\n\n    // Snap to 0 if going below minimum (allows removal)\n    if (newValue < minQty && newValue > 0) {\n        newValue = 0;\n    }\n\n    // Don't go below 0\n    if (newValue < 0) {\n        newValue = 0;\n    }\n\n    input.value = newValue;\n    handleQuantityChange(idx);\n    handleQuantityInput(idx);\n}\n\nfunction handleQuantityInput(idx) {\n    const qtyInput = document.getElementById(`quantity-${idx}`);\n    const priceInput = document.getElementById(`price-${idx}`);\n    if (!qtyInput) return;\n\n    const originalQty = parseFloat(qtyInput.dataset.original);\n    const currentQty = parseFloat(qtyInput.value) || 0;\n\n    // Visual feedback for changed quantity\n    qtyInput.classList.remove('changed', 'removed');\n    if (currentQty === 0) {\n        qtyInput.classList.add('removed');\n    } else if (currentQty !== originalQty) {\n        qtyInput.classList.add('changed');\n    }\n\n    // Get current rate (may be modified)\n    const rate = priceInput ? (parseFloat(priceInput.value) || 0) : (currentOrder?.products[idx]?.rate || 0);\n\n    // Recalculate amount\n    const amount = Math.round(currentQty * rate * 100) / 100;\n    const amountEl = document.getElementById(`amount-${idx}`);\n    if (amountEl) amountEl.textContent = `₹${amount.toLocaleString('en-IN')}`;\n\n    // Update total\n    updateOrderTotal();\n}\n\nfunction handleQuantityChange(idx) {\n    const input = document.getElementById(`quantity-${idx}`);\n    if (!input) return;\n\n    const original = parseFloat(input.dataset.original);\n    const current = parseFloat(input.value) || 0;\n\n    // Validate minimum quantity\n    const minQty = 0.01;\n\n    if (current > 0 && current < minQty) {\n        showToast(`Minimum quantity: ${minQty} ${input.dataset.unit}`, 'info');\n        input.value = original;\n        delete quantityChanges[idx];\n    } else if (current !== original) {\n        quantityChanges[idx] = current;\n    } else {\n        delete quantityChanges[idx];\n    }\n\n    // Enable/disable save button (check price, quantity changes, and added products)\n    updateSaveButtonState();\n\n    // Trigger amount recalculation\n    handleQuantityInput(idx);\n}\n\nfunction updateSaveButtonState() {\n    const hasChanges = Object.keys(priceChanges).length > 0 ||\n        Object.keys(quantityChanges).length > 0 ||\n        addedProducts.length > 0;\n    const saveBtn = document.getElementById('savePricesBtn');\n    if (saveBtn) saveBtn.disabled = !hasChanges;\n}\n\nfunction addProductToOrder() {\n    const select = document.getElementById('productSelector');\n    const productId = select.value;\n    if (!productId) {\n        // Check if dropdown is empty (no products available besides the placeholder)\n        if (allProducts.length === 0 || select.options.length <= 1) {\n            showToast('No products available', 'info');\n        }\n        return;\n    }\n\n    const option = select.options[select.selectedIndex];\n    const productName = option.dataset.name;\n    const unit = option.dataset.unit;\n\n    // Get market rate for this product\n    const rate = marketRates[productId] || 0;\n\n    // Add to addedProducts array\n    addedProducts.push({\n        product: productId,\n        productName: productName,\n        unit: unit,\n        quantity: 1,\n        rate: rate\n    });\n\n    // Remove from dropdown\n    option.remove();\n\n    // Render added products\n    renderAddedProducts();\n    updateOrderTotal();\n    updateSaveButtonState();\n\n    // Reset select\n    select.value = '';\n}\n\nfunction renderAddedProducts() {\n    const container = document.getElementById('addedProductsContainer');\n    if (!container) return;\n\n    container.innerHTML = '';\n    const fragment = document.createDocumentFragment();\n\n    addedProducts.forEach((p, idx) => {\n        const productItem = createElement('div', { className: 'product-item added-product', dataset: { addedIdx: idx } }, [\n            createElement('div', { className: 'product-top' }, [\n                createElement('div', {}, [\n                    createElement('div', { className: 'product-name' }, [\n                        p.productName,\n                        ' ',\n                        createElement('span', { className: 'new-badge' }, 'New')\n                    ]),\n                    createElement('div', { className: 'qty-controls-inline' }, [\n                        createElement('button', { className: 'qty-btn-sm', onclick: () => window.changeAddedQty(idx, -1), type: 'button' }, '−'),\n                        createElement('input', {\n                            type: 'number',\n                            className: 'qty-input-sm input-animated',\n                            id: `added-qty-${idx}`,\n                            value: p.quantity,\n                            min: '0',\n                            step: '0.01',\n                            onchange: () => window.handleAddedQtyChange(idx),\n                            oninput: () => window.handleAddedQtyInput(idx)\n                        }),\n                        createElement('button', { className: 'qty-btn-sm', onclick: () => window.changeAddedQty(idx, 1), type: 'button' }, '+'),\n                        createElement('span', { className: 'qty-unit' }, p.unit)\n                    ])\n                ]),\n                createElement('button', { className: 'remove-btn', onclick: () => window.removeAddedProduct(idx), title: 'Remove' }, '×')\n            ]),\n            createElement('div', { className: 'prices-container' }, [\n                createElement('div', { className: 'price-box' }, [\n                    createElement('div', { className: 'price-label' }, 'Purchase'),\n                    createElement('div', { className: 'price-value' }, p.rate ? `₹${p.rate.toLocaleString('en-IN')}` : 'N/A')\n                ]),\n                createElement('div', { className: 'price-box' }, [\n                    createElement('div', { className: 'price-label' }, 'Selling'),\n                    createElement('input', {\n                        type: 'number',\n                        className: 'price-input input-animated',\n                        id: `added-price-${idx}`,\n                        value: p.rate || 0,\n                        min: '0',\n                        step: '0.01',\n                        onchange: () => window.handleAddedPriceChange(idx)\n                    })\n                ])\n            ]),\n            createElement('div', { className: 'amount-row' }, [\n                createElement('span', { className: 'amount-label' }, 'Amount'),\n                createElement('span', { className: 'amount-display', id: `added-amount-${idx}` }, `₹${((p.rate || 0) * (p.quantity || 0)).toLocaleString('en-IN')}`)\n            ])\n        ]);\n        fragment.appendChild(productItem);\n    });\n\n    container.appendChild(fragment);\n}\n\nfunction changeAddedQty(idx, delta) {\n    const input = document.getElementById(`added-qty-${idx}`);\n    if (!input) return;\n    let val = parseFloat(input.value) || 0;\n    val = Math.max(0, val + delta);\n    if (val > 0 && val < 0.01) val = 0.01;\n    input.value = val;\n    addedProducts[idx].quantity = val;\n    updateAddedAmount(idx);\n    updateOrderTotal();\n}\n\nfunction handleAddedQtyChange(idx) {\n    const input = document.getElementById(`added-qty-${idx}`);\n    if (!input) return;\n    let val = parseFloat(input.value) || 0;\n    if (val > 0 && val < 0.01) {\n        showToast('Minimum quantity: 0.01', 'info');\n        val = 0.01;\n        input.value = val;\n    }\n    addedProducts[idx].quantity = val;\n    updateAddedAmount(idx);\n    updateOrderTotal();\n}\n\nfunction handleAddedQtyInput(idx) {\n    const input = document.getElementById(`added-qty-${idx}`);\n    if (!input) return;\n    const val = parseFloat(input.value) || 0;\n    addedProducts[idx].quantity = val;\n    updateAddedAmount(idx);\n    updateOrderTotal();\n}\n\nfunction handleAddedPriceChange(idx) {\n    const input = document.getElementById(`added-price-${idx}`);\n    if (!input) return;\n    const val = parseFloat(input.value) || 0;\n    addedProducts[idx].rate = val;\n    updateAddedAmount(idx);\n    updateOrderTotal();\n}\n\nfunction handleAddedPriceInput(idx) {\n    const input = document.getElementById(`added-price-${idx}`);\n    if (!input) return;\n    const val = parseFloat(input.value) || 0;\n    addedProducts[idx].rate = val;\n    updateAddedAmount(idx);\n    updateOrderTotal();\n}\n\nfunction updateAddedAmount(idx) {\n    const amountEl = document.getElementById(`added-amount-${idx}`);\n    if (!amountEl) return;\n    const p = addedProducts[idx];\n    const amount = (p.quantity || 0) * (p.rate || 0);\n    amountEl.textContent = `₹${amount.toLocaleString('en-IN')}`;\n}\n\nfunction removeAddedProduct(idx) {\n    const removed = addedProducts.splice(idx, 1)[0];\n\n    // Add back to dropdown\n    const select = document.getElementById('productSelector');\n    if (select && removed) {\n        const opt = document.createElement('option');\n        opt.value = removed.product;\n        opt.dataset.name = removed.productName;\n        opt.dataset.unit = removed.unit;\n        opt.textContent = `${removed.productName} (${removed.unit})`;\n        select.appendChild(opt);\n    }\n\n    renderAddedProducts();\n    updateOrderTotal();\n    updateSaveButtonState();\n}\n\nfunction updateOrderTotal() {\n    if (!currentOrder || !currentOrder.products) return;\n\n    let total = 0;\n    currentOrder.products.forEach((p, idx) => {\n        const priceInput = document.getElementById(`price-${idx}`);\n        const qtyInput = document.getElementById(`quantity-${idx}`);\n        const rate = priceInput ? (parseFloat(priceInput.value) || 0) : p.rate;\n        const quantity = qtyInput ? (parseFloat(qtyInput.value) || 0) : p.quantity;\n        total += rate * quantity;\n    });\n\n    // Include added products\n    addedProducts.forEach(p => {\n        total += (p.quantity || 0) * (p.rate || 0);\n    });\n\n    // Round to 2 decimal places for consistency with backend\n    total = Math.round(total * 100) / 100;\n    const balance = Math.round((total - (currentOrder.paidAmount || 0)) * 100) / 100;\n\n    const totalEl = document.getElementById('orderTotal');\n    const balanceEl = document.getElementById('orderBalance');\n    if (totalEl) totalEl.textContent = `₹${total.toLocaleString('en-IN')}`;\n    if (balanceEl) balanceEl.textContent = `₹${balance.toLocaleString('en-IN')}`;\n}\n\n// Check if invoices exist for an order\n// Returns: { exists: boolean, error?: string }\nasync function checkInvoicesExist(orderId) {\n    try {\n        const res = await fetch(`/api/invoices/order/${orderId}`, { credentials: 'include' });\n        if (!res.ok) {\n            // Non-OK response - could be auth issue or server error\n            if (res.status === 401 || res.status === 403) {\n                return { exists: false, error: 'auth' };\n            }\n            return { exists: false, error: `Server returned ${res.status}` };\n        }\n        const data = await res.json();\n        return { exists: data.data && data.data.length > 0 };\n    } catch (e) {\n        console.error('Failed to check invoices:', e);\n        // Return error info so caller can decide how to handle\n        return { exists: false, error: e.message };\n    }\n}\n\nasync function savePrices() {\n    // Check for price, quantity changes, or added products\n    const hasChanges = Object.keys(priceChanges).length > 0 ||\n        Object.keys(quantityChanges).length > 0 ||\n        addedProducts.length > 0;\n    if (!currentOrderId || !currentOrder || !currentOrder.products || !hasChanges) return;\n\n    // Prevent concurrent saves\n    if (isSaving) {\n        showToast('Save in progress...', 'info');\n        return;\n    }\n\n    isSaving = true;\n    const btn = document.getElementById('savePricesBtn');\n    if (btn) {\n        btn.disabled = true;\n        btn.classList.add('btn-loading');\n    }\n\n    // Check if invoices exist\n    let hasInvoices = false;\n    const invoiceCheck = await checkInvoicesExist(currentOrderId);\n    if (invoiceCheck.error) {\n        // If we can't check invoices, warn user but allow them to proceed\n        const proceedAnyway = confirm(\n            'Could not check if invoices exist for this order.\\n\\n' +\n            'If invoices exist, they may need to be regenerated after saving. Continue?'\n        );\n        if (!proceedAnyway) {\n            isSaving = false;\n            if (btn) {\n                btn.classList.remove('btn-loading');\n                btn.disabled = false;\n            }\n            return;\n        }\n    } else if (invoiceCheck.exists) {\n        hasInvoices = true;\n        const proceed = confirm(\n            'Invoices exist for this order. Changes will not update existing invoices.\\n\\n' +\n            'You may need to regenerate invoices after saving. Continue?'\n        );\n        if (!proceed) {\n            isSaving = false;\n            if (btn) {\n                btn.classList.remove('btn-loading');\n                btn.disabled = false;\n            }\n            return;\n        }\n    }\n\n    try {\n        // Build updated products array with quantities\n        const existingProducts = currentOrder.products\n            .map((p, idx) => {\n                let price = priceChanges[idx] !== undefined ? priceChanges[idx] : p.rate;\n                let quantity = quantityChanges[idx] !== undefined ? quantityChanges[idx] : p.quantity;\n\n                // Safety checks\n                if (!price || price <= 0) price = p.rate;\n                if (quantity < 0) quantity = p.quantity;\n\n                return {\n                    product: typeof p.product === 'object' ? p.product._id : p.product,\n                    quantity: quantity,\n                    priceAtTime: price\n                };\n            })\n            .filter(item => item.quantity > 0); // Remove items with quantity = 0\n\n        // Include newly added products\n        const newProducts = addedProducts\n            .filter(p => p.quantity > 0)\n            .map(p => ({\n                product: p.product,\n                quantity: p.quantity,\n                priceAtTime: p.rate\n            }));\n\n        const updatedProducts = [...existingProducts, ...newProducts];\n\n        const headers = { 'Content-Type': 'application/json' };\n        const csrfToken = await Auth.ensureCsrfToken();\n        if (csrfToken) {\n            headers['X-CSRF-Token'] = csrfToken;\n        }\n\n        const payload = { products: updatedProducts };\n        const orderId = currentOrderId; // Capture to avoid race conditions\n\n        let res = await fetch(`/api/orders/${orderId}`, {\n            method: 'PUT',\n            headers,\n            credentials: 'include',\n            body: JSON.stringify(payload)\n        });\n\n        // Handle CSRF error with single retry\n        if (res.status === 403) {\n            let errData;\n            try {\n                errData = await res.json();\n            } catch (parseError) {\n                console.warn('Failed to parse CSRF error response:', parseError.message);\n                errData = { message: `Access denied (code: ${res.status})` };\n            }\n\n            if (errData.message?.toLowerCase().includes('csrf')) {\n                const newToken = await Auth.refreshCsrfToken();\n                if (newToken) {\n                    headers['X-CSRF-Token'] = newToken;\n                    res = await fetch(`/api/orders/${orderId}`, {\n                        method: 'PUT',\n                        headers,\n                        credentials: 'include',\n                        body: JSON.stringify(payload)\n                    });\n\n                    // If retry also fails with CSRF, tell user to refresh\n                    if (res.status === 403) {\n                        showToast('Session expired. Please refresh the page.', 'info');\n                        isSaving = false;\n                        if (btn) {\n                            btn.classList.remove('btn-loading');\n                            btn.disabled = false;\n                        }\n                        return;\n                    }\n                } else {\n                    showToast('Session expired. Please refresh the page.', 'info');\n                    isSaving = false;\n                    if (btn) {\n                        btn.classList.remove('btn-loading');\n                        btn.disabled = false;\n                    }\n                    return;\n                }\n            } else {\n                showToast(errData.message || 'Access temporarily unavailable', 'info');\n                isSaving = false;\n                if (btn) {\n                    btn.classList.remove('btn-loading');\n                    btn.disabled = false;\n                }\n                return;\n            }\n        }\n\n        if (res.ok) {\n            showToast('Changes saved', 'success');\n            priceChanges = {};\n            quantityChanges = {};\n            addedProducts = [];\n            if (btn) {\n                btn.classList.remove('btn-loading');\n                btn.classList.add('btn-success');\n                setTimeout(() => btn.classList.remove('btn-success'), 1500);\n                btn.disabled = true;\n            }\n            loadOrders();\n\n            // Prompt to regenerate invoice if needed\n            if (hasInvoices) {\n                setTimeout(() => {\n                    if (confirm('Order updated. Regenerate invoice with new quantities?')) {\n                        const orderIdToEdit = orderId; // Capture before modal closes\n                        closeModal();\n                        setTimeout(() => printOrder(orderIdToEdit), 300);\n                    }\n                }, 500);\n            }\n\n            // Refresh the modal if still viewing same order\n            if (currentOrderId === orderId) {\n                viewOrder(orderId);\n            }\n        } else {\n            let errData;\n            try {\n                errData = await res.json();\n            } catch (parseError) {\n                console.warn('Failed to parse order save error response:', parseError.message);\n                errData = { message: `Server error (${res.status})` };\n            }\n            showToast(errData.message || 'Could not update', 'info');\n            if (btn) btn.disabled = false;\n        }\n    } catch (e) {\n        console.error('Save changes error:', e);\n        if (!navigator.onLine) {\n            showToast('No internet connection', 'info');\n        } else {\n            showToast('Could not save. Try again.', 'info');\n        }\n        if (btn) btn.disabled = false;\n    } finally {\n        isSaving = false;\n        if (btn) btn.classList.remove('btn-loading');\n    }\n}\n\nfunction closeModal() {\n    // Warn about unsaved changes (price, quantity, or added products)\n    const hasChanges = Object.keys(priceChanges).length > 0 ||\n        Object.keys(quantityChanges).length > 0 ||\n        addedProducts.length > 0;\n    if (hasChanges) {\n        if (!confirm('You have unsaved changes. Discard them?')) {\n            return;\n        }\n    }\n    const orderModal = document.getElementById('orderModal');\n    if (orderModal) orderModal.classList.remove('show');\n    currentOrderId = null;\n    currentOrder = null;\n    priceChanges = {};\n    quantityChanges = {};\n    addedProducts = [];\n}\n\n// Expose to window for onclick handlers\nwindow.closeModal = closeModal;\nwindow.viewOrder = viewOrder;\nwindow.clearZero = clearZero;\nwindow.restoreValue = restoreValue;\nwindow.handlePriceChange = handlePriceChange;\nwindow.handlePriceInput = handlePriceInput;\nwindow.handleQuantityChange = handleQuantityChange;\nwindow.handleQuantityInput = handleQuantityInput;\nwindow.changeQuantity = changeQuantity;\nwindow.savePrices = savePrices;\nwindow.deleteOrder = deleteOrder;\nwindow.printOrder = printOrder;\nwindow.downloadDeliveryBill = downloadDeliveryBill;\n// Invoice modal functions\nwindow.closeInvoiceModal = closeInvoiceModal;\nwindow.selectFirm = selectFirm;\nwindow.toggleInvoiceItem = toggleInvoiceItem;\nwindow.generateInvoice = generateInvoice;\nwindow.printFromModal = printFromModal;\n\n// Added product functions\nwindow.addProductToOrder = addProductToOrder;\nwindow.renderAddedProducts = renderAddedProducts;\nwindow.changeAddedQty = changeAddedQty;\nwindow.handleAddedQtyChange = handleAddedQtyChange;\nwindow.handleAddedQtyInput = handleAddedQtyInput;\nwindow.handleAddedPriceChange = handleAddedPriceChange;\nwindow.handleAddedPriceInput = handleAddedPriceInput;\nwindow.removeAddedProduct = removeAddedProduct;\n\n\nasync function updateOrderStatus(orderId, newStatus) {\n    if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'staff')) return;\n\n    // Disable all status buttons to prevent double-click\n    const statusBtns = document.querySelectorAll('#modalBody .btn-confirm, #modalBody .btn-deliver');\n    statusBtns.forEach(b => { b.disabled = true; b.classList.add('btn-loading'); });\n\n    try {\n        const headers = { 'Content-Type': 'application/json' };\n        const csrfToken = await Auth.ensureCsrfToken();\n        if (csrfToken) headers['X-CSRF-Token'] = csrfToken;\n\n        const res = await fetch(`/api/orders/${orderId}/status`, {\n            method: 'PUT',\n            headers,\n            credentials: 'include',\n            body: JSON.stringify({ status: newStatus })\n        });\n\n        const data = await res.json();\n\n        if (res.ok) {\n            showToast(`Order marked as ${newStatus}`, 'success');\n            // Reload order to update UI (logs, timestamps etc)\n            viewOrder(orderId);\n            // Also refresh list in background\n            loadOrders();\n        } else {\n            showToast(data.message || 'Failed to update status', 'error');\n            // Revert select by reloading view\n            viewOrder(orderId);\n        }\n    } catch (error) {\n        console.error('Status update error:', error);\n        showToast('Network error updating status', 'error');\n        viewOrder(orderId);\n    } finally {\n        statusBtns.forEach(b => { b.disabled = false; b.classList.remove('btn-loading'); });\n    }\n}\n\nwindow.updateOrderStatus = updateOrderStatus;\n\n// ============================================\n// PACKING PANEL FUNCTIONS\n// ============================================\n\n// Open packing panel for an order\nasync function openPackingPanel(orderId) {\n    const panel = document.getElementById('packingPanel');\n    const overlay = document.getElementById('packingPanelOverlay');\n    if (!panel || !overlay) return;\n\n    // Close any open swipe items\n    document.querySelectorAll('.swipe-item.swiped, .swipe-item.swiped-single').forEach(item => {\n        item.classList.remove('swiped', 'swiped-single');\n    });\n\n    // Show panel with loading state\n    panel.classList.add('active');\n    overlay.classList.add('active');\n    document.body.style.overflow = 'hidden';\n\n    document.getElementById('packingPanelBody').innerHTML = '<div class=\"packing-loading\">Loading order...</div>';\n    document.getElementById('packingCompleteBtn').disabled = true;\n\n    try {\n        // Load packing details\n        const response = await fetch(`/api/packing/${orderId}`, { credentials: 'include' });\n        if (!response.ok) throw new Error('Failed to load order');\n\n        const data = await response.json();\n        packingOrder = data.data;\n\n        // Items are directly on the order (simplified packing)\n        packingItems = packingOrder.items || [];\n        renderPackingPanel();\n    } catch (error) {\n        console.error('Error loading packing order:', error);\n        showToast('Failed to load order details', 'error');\n        packingOrder = null;\n        packingItems = [];\n        closePackingPanel();\n    }\n}\n\n// Render the packing panel content (simplified)\nfunction renderPackingPanel() {\n    // Update title\n    document.getElementById('packingPanelTitle').textContent = `Pack ${packingOrder.orderNumber}`;\n    document.getElementById('packingPanelSubtitle').textContent =\n        `${packingOrder.customer?.name || 'Unknown'} • ${packingOrder.customer?.phone || ''}`;\n\n    // Update progress\n    updatePackingProgress();\n\n    // Render body\n    const body = document.getElementById('packingPanelBody');\n\n    let orderDetailsHtml = '';\n    if (packingOrder.deliveryAddress || packingOrder.notes) {\n        orderDetailsHtml = `<div class=\"packing-order-details\">`;\n        if (packingOrder.deliveryAddress) {\n            orderDetailsHtml += `\n                <div class=\"packing-delivery-info\">\n                    <span class=\"packing-label\">Deliver to</span>\n                    <span class=\"packing-value\">${escapeHtml(packingOrder.deliveryAddress)}</span>\n                </div>`;\n        }\n        if (packingOrder.notes) {\n            orderDetailsHtml += `\n                <div class=\"packing-order-notes\">\n                    <span class=\"packing-label\">Notes</span>\n                    <span class=\"packing-value\">${escapeHtml(packingOrder.notes)}</span>\n                </div>`;\n        }\n        orderDetailsHtml += `</div>`;\n    }\n\n    // Simplified packing - show items with packed checkbox and quantities\n    const checklistItems = packingItems.map((item, index) => {\n        // Track if quantity was modified\n        const packedQty = item.packedQuantity ?? item.orderedQuantity;\n        const isModified = item.packedQuantity !== undefined && item.packedQuantity !== item.orderedQuantity;\n        const isPacked = item.packed || false;\n\n        return `\n            <div class=\"packing-checklist-item ${isPacked ? 'item-packed' : ''} ${isModified ? 'item-modified' : ''}\" data-index=\"${index}\" data-product-id=\"${item.product}\">\n                <div class=\"packing-item-main\">\n                    <div class=\"packing-item-check ${isPacked ? 'checked' : ''}\" onclick=\"togglePackedItem(${index})\">\n                        ${isPacked ? '✓' : ''}\n                    </div>\n                    <div class=\"packing-item-details\">\n                        <span class=\"packing-item-name\">${escapeHtml(item.productName)}</span>\n                        <span class=\"packing-item-qty\">Ordered: ${item.orderedQuantity} ${item.unit}</span>\n                    </div>\n                </div>\n                <div class=\"packing-item-input\">\n                    <input type=\"number\"\n                        class=\"packing-qty-input ${isModified ? 'modified' : ''}\"\n                        value=\"${packedQty}\"\n                        data-index=\"${index}\"\n                        data-original=\"${item.orderedQuantity}\"\n                        step=\"0.01\"\n                        min=\"0\"\n                        onchange=\"handlePackingQtyChange(${index})\"\n                    >\n                    <span class=\"packing-unit-label\">${item.unit}</span>\n                </div>\n            </div>\n        `;\n    }).join('');\n\n    body.innerHTML = `\n        ${orderDetailsHtml}\n        <div class=\"packing-checklist-header\">\n            <span>Items to Pack</span>\n        </div>\n        <div class=\"packing-checklist\">\n            ${checklistItems}\n        </div>\n    `;\n\n    // Hide acknowledgement section (simplified flow)\n    const ackSection = document.getElementById('packingPanelAcknowledgement');\n    if (ackSection) ackSection.style.display = 'none';\n\n    // Hide issues section (simplified flow)\n    const issuesSection = document.getElementById('packingPanelIssues');\n    if (issuesSection) issuesSection.style.display = 'none';\n\n    updatePackingCompleteButton();\n}\n\n// Toggle packed status for an item\nasync function togglePackedItem(index) {\n    const item = packingItems[index];\n    const newPacked = !item.packed;\n\n    // Optimistic UI update\n    item.packed = newPacked;\n    renderPackingPanel();\n\n    try {\n        const csrfToken = await Auth.ensureCsrfToken();\n        const response = await fetch(`/api/packing/${packingOrder._id}/item/${item.product}`, {\n            method: 'PUT',\n            headers: {\n                'Content-Type': 'application/json',\n                'X-CSRF-Token': csrfToken\n            },\n            credentials: 'include',\n            body: JSON.stringify({ packed: newPacked })\n        });\n\n        if (!response.ok) {\n            // Parse error response for better message\n            const errData = await response.json().catch(() => ({}));\n            const errorMsg = errData.message || `Server error (${response.status})`;\n            throw new Error(errorMsg);\n        }\n    } catch (error) {\n        console.error('Error toggling packed status:', error);\n        // Revert on error\n        item.packed = !newPacked;\n        renderPackingPanel();\n\n        // Provide specific error messages\n        if (!navigator.onLine) {\n            showToast('No connection. Check internet and retry.', 'error');\n        } else if (error.message?.includes('401') || error.message?.includes('403') || error.message?.includes('auth')) {\n            showToast('Session expired. Please refresh the page.', 'error');\n        } else if (error.message?.includes('404')) {\n            showToast('Order not found. It may have been modified.', 'error');\n        } else {\n            showToast(`Update failed: ${error.message}`, 'error');\n        }\n    }\n}\n\n// Handle quantity change (simplified - just update local state)\nasync function handlePackingQtyChange(index) {\n    const qtyInput = document.querySelector(`.packing-qty-input[data-index=\"${index}\"]`);\n    const qty = parseFloat(qtyInput?.value) || 0;\n    const original = parseFloat(qtyInput?.dataset.original) || 0;\n\n    // Store original value in case we need to revert\n    const previousQty = packingItems[index].packedQuantity;\n    packingItems[index].packedQuantity = qty;\n\n    // Update visual feedback\n    qtyInput.classList.toggle('modified', qty !== original);\n    const itemEl = qtyInput.closest('.packing-checklist-item');\n    if (itemEl) {\n        itemEl.classList.toggle('item-modified', qty !== original);\n    }\n\n    // Save to server\n    const result = await savePackingItemUpdate(index);\n\n    // If save failed, revert the local state and visual feedback\n    if (!result.success) {\n        packingItems[index].packedQuantity = previousQty;\n        qtyInput.value = previousQty ?? original;\n        qtyInput.classList.toggle('modified', (previousQty ?? original) !== original);\n        if (itemEl) {\n            itemEl.classList.toggle('item-modified', (previousQty ?? original) !== original);\n        }\n    }\n}\n\n// Save item quantity update to server\n// Returns { success: boolean, error?: string }\nasync function savePackingItemUpdate(index) {\n    const item = packingItems[index];\n\n    try {\n        const csrfToken = await Auth.ensureCsrfToken();\n        const response = await fetch(`/api/packing/${packingOrder._id}/item/${item.product}`, {\n            method: 'PUT',\n            headers: {\n                'Content-Type': 'application/json',\n                'X-CSRF-Token': csrfToken\n            },\n            credentials: 'include',\n            body: JSON.stringify({\n                quantity: item.packedQuantity\n            })\n        });\n\n        if (!response.ok) {\n            const errData = await response.json().catch(() => ({}));\n            throw new Error(errData.message || `Server error (${response.status})`);\n        }\n        return { success: true };\n    } catch (error) {\n        console.error('Error saving packing item:', error);\n        // Provide specific error message\n        let userMsg = 'Failed to save changes';\n        if (!navigator.onLine) {\n            userMsg = 'No connection. Changes not saved.';\n        } else if (error.message?.includes('401') || error.message?.includes('403')) {\n            userMsg = 'Session expired. Please refresh.';\n        }\n        showToast(userMsg, 'error');\n        return { success: false, error: error.message };\n    }\n}\n\n// Update progress bar\nfunction updatePackingProgress() {\n    const total = packingItems.length;\n    const packed = packingItems.filter(item => item.packed).length;\n    const percentage = total > 0 ? Math.round((packed / total) * 100) : 0;\n\n    document.getElementById('packingProgressFill').style.width = `${percentage}%`;\n    document.getElementById('packingProgressText').textContent = `${packed}/${total} items packed`;\n}\n\n// Update complete button state - disable until all items are packed\nfunction updatePackingCompleteButton() {\n    const completeBtn = document.getElementById('packingCompleteBtn');\n    if (completeBtn) {\n        const total = packingItems.length;\n        const packed = packingItems.filter(item => item.packed).length;\n        const allPacked = packed === total && total > 0;\n\n        completeBtn.disabled = !allPacked;\n\n        // Update button text with remaining count if not all packed\n        if (!allPacked && total > 0) {\n            const remaining = total - packed;\n            completeBtn.title = `${remaining} item(s) remaining`;\n        } else {\n            completeBtn.title = '';\n        }\n    }\n}\n\n// Complete packing (mark as done)\nasync function completePackingSession() {\n    const completeBtn = document.getElementById('packingCompleteBtn');\n    completeBtn.disabled = true;\n    completeBtn.innerHTML = '<span class=\"btn-text\">Completing...</span>';\n\n    try {\n        const csrfToken = await Auth.ensureCsrfToken();\n        const response = await fetch(`/api/packing/${packingOrder._id}/done`, {\n            method: 'POST',\n            headers: {\n                'Content-Type': 'application/json',\n                'X-CSRF-Token': csrfToken\n            },\n            credentials: 'include'\n        });\n\n        if (!response.ok) {\n            const error = await response.json();\n            throw new Error(error.message || 'Failed to complete packing');\n        }\n\n        showToast('Packing completed!', 'success');\n        closePackingPanel();\n        await loadOrders();\n    } catch (error) {\n        console.error('Error completing packing:', error);\n        showToast(error.message || 'Failed to complete packing', 'error');\n        completeBtn.disabled = false;\n        completeBtn.innerHTML = '<span class=\"btn-text\">Mark Done</span>';\n    }\n}\n\n// Close packing panel\nfunction closePackingPanel() {\n    const panel = document.getElementById('packingPanel');\n    const overlay = document.getElementById('packingPanelOverlay');\n\n    panel.classList.remove('active');\n    overlay.classList.remove('active');\n    document.body.style.overflow = '';\n\n    packingOrder = null;\n    packingItems = [];\n}\n\n// Expose packing functions to window\nwindow.openPackingPanel = openPackingPanel;\nwindow.closePackingPanel = closePackingPanel;\nwindow.handlePackingQtyChange = handlePackingQtyChange;\nwindow.completePackingSession = completePackingSession;\nwindow.togglePackedItem = togglePackedItem;\n\ninit();\n"],"names":["escapeHtml","text","div","waitForAuth","maxWait","resolve","reject","startTime","check","Auth","orders","marketRates","allProducts","addedProducts","currentFilter","currentOrderId","currentOrder","currentUser","priceChanges","quantityChanges","isSaving","isDeleting","globalListenersInitialized","packingOrder","packingItems","init","footer","initGlobalListeners","loadOrders","loadMarketRates","loadProducts","setupFilters","setupSearch","handleDeepLink","params","orderId","action","openPackingPanel","viewOrder","container","e","item","touchState","swipeItem","diff","actionCount","mouseState","orderModal","closeModal","invoiceModal","closeInvoiceModal","res","r","pid","showDataLoadWarning","p","type","message","warning","createElement","data","invalidOrders","o","renderOrders","errorMsg","getInitials","name","words","searchInput","search","isAdmin","isStaff","filtered","fragment","idx","batchBadge","packingBadge","swipeContent","actions","swipeActions","actionCountClass","card","segmentControl","indicator","buttons","moveIndicator","btn","controlRect","btnRect","left","width","activeBtn","b","active","debounce","fn","delay","timeoutId","args","debouncedRender","invoiceData","selectedFirmId","selectedProductIds","downloadDeliveryBill","batchId","showToast","isValidMongoId","isValidBatchId","billBtn","response","errorData","contentDisposition","filename","match","blob","url","a","error","printOrder","modalBody","generateBtn","loadFirms","errData","renderInvoiceModal","allFirms","allItems","f","i","selectedTotal","sum","firmsToShow","firmSelector","firm","selectFirm","firmId","toggleInvoiceItem","productId","generateInvoice","headers","csrfToken","printFromModal","deleteOrder","id","parseError","order","modalTitle","saveBtn","_batchInfo","infoRow1","infoRow2","infoRow3","infoSection","purchasePrice","purchaseDisplay","qtyDisplay","qtyInput","sellingLabelChildren","sellingDisplay","priceInput","productItem","productOptions","op","productSelector","addProductDiv","totalSection","printBtn","confirmBtn","deliverBtn","packBtn","err","modal","clearZero","input","restoreValue","handlePriceChange","handlePriceInput","original","current","qty","amount","amountEl","updateOrderTotal","updateSaveButtonState","changeQuantity","delta","newValue","handleQuantityChange","handleQuantityInput","originalQty","currentQty","rate","minQty","hasChanges","addProductToOrder","select","option","productName","unit","renderAddedProducts","changeAddedQty","val","updateAddedAmount","handleAddedQtyChange","handleAddedQtyInput","handleAddedPriceChange","handleAddedPriceInput","removeAddedProduct","removed","opt","total","quantity","balance","totalEl","balanceEl","checkInvoicesExist","savePrices","hasInvoices","invoiceCheck","existingProducts","price","newProducts","updatedProducts","payload","newToken","orderIdToEdit","updateOrderStatus","newStatus","statusBtns","panel","overlay","renderPackingPanel","closePackingPanel","updatePackingProgress","body","orderDetailsHtml","checklistItems","index","packedQty","isModified","isPacked","ackSection","issuesSection","updatePackingCompleteButton","togglePackedItem","newPacked","handlePackingQtyChange","previousQty","itemEl","savePackingItemUpdate","userMsg","packed","percentage","completeBtn","allPacked","remaining","completePackingSession"],"mappings":"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"}