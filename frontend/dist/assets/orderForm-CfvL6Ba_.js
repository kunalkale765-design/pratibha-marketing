import"./responsive-D1ZTW0b0.js";import"./api-CEln0qT5.js";import{c as a,s as l}from"./ui-Bs0uH3rR.js";import{l as V}from"./init-BmEs7ovC.js";const D=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(D()),10)}),v=await D(),S=document.getElementById("logoutBtn");S&&S.addEventListener("click",V);const P=document.getElementById("customerSelect");P&&P.addEventListener("change",X);let h=null,m=null,g=[],b={},I=[],k=!1;async function J(){const t=new URLSearchParams(window.location.search).get("token");if(t)try{const o=await fetch(`/api/auth/magic/${t}`,{credentials:"include"}),n=await o.json();if(o.ok&&n.user)h=n.user,v.setUser(n.user),window.history.replaceState({},"",window.location.pathname);else{l(n.message||"Link expired. Please request a new one.","info"),window.location.href="/pages/auth/login.html";return}}catch{l("Authentication issue. Please refresh.","info"),window.location.href="/pages/auth/login.html";return}else if(h=await v.verify(),!h){window.location.href="/pages/auth/login.html";return}if(k=h.role==="admin"||h.role==="staff",await _(),k){const o=document.getElementById("customerBar");o&&o.classList.add("show"),Z()}else if(h.customer)m=typeof h.customer=="object"?h.customer:{_id:h.customer,pricingType:"market"},B();else{const o=document.getElementById("productList");o&&(o.innerHTML="",o.appendChild(a("div",{className:"empty-state"},"Account setup in progress. Please check back later.")))}}async function _(){try{const[e,t,o]=await Promise.all([fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/customers",{credentials:"include"}).catch(()=>({ok:!1}))]);e.ok&&(g=((await e.json())?.data||[]).filter(r=>r.isActive!==!1)),t.ok&&((await t.json())?.data||[]).forEach(r=>{const s=typeof r.product=="object"?r.product._id:r.product;s&&(b[s]=r.rate)}),o.ok&&(I=((await o.json())?.data||[]).filter(r=>r.isActive!==!1))}catch(e){console.error("Failed to load data:",e);const t=document.getElementById("productList");t&&(t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},[a("p",{},"Products not available"),a("button",{id:"retryDataBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:()=>_().then(()=>{m&&B()})},"Try Again")])))}}function Z(){const e=document.getElementById("customerSelect");I.forEach(t=>{e.appendChild(a("option",{value:t._id},t.name))})}function X(){const e=document.getElementById("customerSelect").value;if(m=I.find(t=>t._id===e)||null,m)B();else{const t=document.getElementById("productList");t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},"Select a customer to start"))}C()}function W(e,t){return e?e[t]!==void 0?e[t]:typeof e.get=="function"?e.get(t):null:null}function G(e){if(!m)return b[e._id]||0;const t=m.pricingType||"market";if(t==="contract"){const o=W(m.contractPrices,e._id);return o!==null?o:b[e._id]||0}else if(t==="markup"){const o=b[e._id]||0;return Math.round(o*(1+(m.markupPercentage||0)/100))}return b[e._id]||0}function z(){if(k||!m||m.pricingType!=="contract")return g;const e=m.contractPrices||{},t=Object.keys(e);return t.length===0?[]:g.filter(o=>t.includes(o._id))}function K(e=g){const t=[...new Set(e.map(n=>n.category||"Other"))],o=document.getElementById("categoryPills");if(o.innerHTML="",e.length===0||t.length<=1){o.style.display="none";return}o.style.display="flex",o.appendChild(a("button",{className:"cat-pill active",dataset:{cat:"all"},onclick:()=>M("all")},"All")),t.forEach(n=>{o.appendChild(a("button",{className:"cat-pill",dataset:{cat:n},onclick:()=>M(n)},n))})}function M(e){document.querySelectorAll(".cat-pill").forEach(o=>o.classList.remove("active"));const t=document.querySelector(`.cat-pill[data-cat="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".product-item").forEach(o=>{o.style.display=e==="all"||o.dataset.category===e?"":"none"}),document.querySelectorAll(".category-header").forEach(o=>{o.style.display=e==="all"||o.dataset.category===e?"":"none"})}function B(){const e=document.getElementById("productList");e.innerHTML="";const t=z();if(!t.length){const s=m&&m.pricingType==="contract"&&g.length>0?"No products configured for your account. Please contact us to set up pricing.":"No products available";e.appendChild(a("div",{className:"empty-state"},s));return}K(t);const o={};t.forEach(r=>{const s=r.category||"Other";o[s]||(o[s]=[]),o[s].push(r)});const n=document.createDocumentFragment();for(const[r,s]of Object.entries(o))n.appendChild(a("div",{className:"category-header",dataset:{category:r}},r)),s.forEach(c=>{const i=G(c),f=c.unit==="piece"?"1":"0.01",u=a("div",{className:"product-item",dataset:{id:c._id,category:r,price:i,unit:c.unit}},[a("div",{className:"product-info"},[a("div",{className:"product-name"},c.name),a("div",{className:"product-meta"},c.unit)]),a("div",{className:"qty-controls"},[a("button",{className:"qty-btn",onclick:()=>window.changeQty(c._id,-1)},"âˆ’"),a("input",{type:"number",className:"qty-input",id:`qty-${c._id}`,value:"0",min:"0",step:f,inputmode:"numeric",onfocus:p=>window.clearZero(p.target),onblur:p=>window.restoreZero(p.target),onchange:()=>window.updateFromInput(c._id)}),a("button",{className:"qty-btn",onclick:()=>window.changeQty(c._id,1)},"+")])]);n.appendChild(u)});e.appendChild(n)}function Y(e){e.value==="0"&&(e.value=""),e.select()}function ee(e){e.value===""&&(e.value="0"),R(e.id.replace("qty-",""))}function te(e,t){const o=document.getElementById("qty-"+e);let n=parseFloat(o.value)||0;n=Math.max(0,n+t),o.value=n,x(e,n)}function R(e){const t=document.getElementById("qty-"+e),o=Math.max(0,parseFloat(t.value)||0);t.value=o,x(e,o)}function x(e,t){const o=document.querySelector(`.product-item[data-id="${e}"]`),n=document.getElementById("qty-"+e);o&&n&&(t>0?(o.classList.add("has-qty"),n.classList.add("has-value")):(o.classList.remove("has-qty"),n.classList.remove("has-value"))),C()}function C(){let e=0;document.querySelectorAll(".product-item").forEach(t=>{const o=t.dataset.id,n=document.getElementById("qty-"+o);(parseFloat(n?.value)||0)>0&&e++}),document.getElementById("itemCount").textContent=e,document.getElementById("orderBtn").disabled=e===0||!m}const A=document.getElementById("searchInput");A&&A.addEventListener("input",e=>{const t=e.target.value.toLowerCase();document.querySelectorAll(".product-item").forEach(o=>{const n=o.querySelector(".product-name").textContent.toLowerCase();o.style.display=n.includes(t)?"":"none"}),document.querySelectorAll(".category-header").forEach(o=>{const n=o.dataset.category,r=[...document.querySelectorAll(`.product-item[data-category="${n}"]`)].some(s=>s.style.display!=="none");o.style.display=r?"":"none"})});async function oe(){if(!m)return;const e=[],t=[];if(document.querySelectorAll(".product-item").forEach(n=>{const r=n.dataset.id,s=document.getElementById("qty-"+r),i=parseFloat(s?.value)||0,f=parseFloat(n.dataset.price)||0,u=n.dataset.unit,p=n.querySelector(".product-name")?.textContent||"Unknown";if(i>0){u==="piece"&&!Number.isInteger(i)&&t.push(p);const y={product:r,quantity:i};f>0&&(y.rate=f),e.push(y)}}),t.length>0){l(`${t.join(", ")}: use whole numbers`,"info");return}if(!e.length)return;const o=document.getElementById("orderBtn");o.disabled=!0,o.textContent="Placing...";try{const n={"Content-Type":"application/json"},r=await v.ensureCsrfToken();r&&(n["X-CSRF-Token"]=r);const s=document.getElementById("orderNotes"),c=s?.value?.trim()||"",i={customer:m._id,products:e};c&&(i.notes=c);let f=await fetch("/api/orders",{method:"POST",headers:n,credentials:"include",body:JSON.stringify(i)}),u=await f.json();if(f.status===403&&u?.message?.toLowerCase().includes("csrf")){const p=await v.refreshCsrfToken();p&&(n["X-CSRF-Token"]=p,f=await fetch("/api/orders",{method:"POST",headers:n,credentials:"include",body:JSON.stringify(i)}),u=await f.json())}if(f.ok){const p=u?.data?.orderNumber||"New";l(`Order placed! #${p}`,"success"),u.warning&&setTimeout(()=>{l(u.warning,"info")},1500),u.message&&u.newContractPrices&&u.newContractPrices.length>0&&setTimeout(()=>{l(u.message,"info")},u.warning?3e3:1500),document.querySelectorAll(".qty-input").forEach(y=>{y.value="0",y.classList.remove("has-value")}),document.querySelectorAll(".product-item").forEach(y=>{y.classList.remove("has-qty")}),s&&(s.value=""),C()}else l(u.message||"Could not place order","info")}catch(n){console.error("Order placement error:",n),navigator.onLine?l("Could not place order. Try again.","info"):l("No internet connection","info")}finally{o.disabled=!1,o.textContent="Place Order",C()}}function H(e){if(document.querySelectorAll(".order-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".order-view").forEach(t=>{t.classList.remove("active")}),e==="new"){const t=document.getElementById("newOrderView");t&&t.classList.add("active")}else if(e==="list"){const t=document.getElementById("ordersListView");t&&t.classList.add("active"),q()}}const F=document.getElementById("newOrderTab"),$=document.getElementById("myOrdersTab");F&&F.addEventListener("click",()=>H("new"));$&&$.addEventListener("click",()=>H("list"));let L=[],T="all";async function q(){const e=document.getElementById("ordersContainer");e.innerHTML="",e.appendChild(a("div",{className:"loading"},"Loading orders..."));try{const t=await fetch("/api/orders",{credentials:"include"}),o=await t.json();t.ok?(L=o.data||[],Q()):(e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},o.message||"Orders not available")))}catch(t){console.error("Load orders error:",t),e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},[a("p",{},"Orders not available"),a("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:q},"Try Again")]))}}function Q(){const e=document.getElementById("ordersContainer");let t=L;if(T!=="all"&&(t=L.filter(n=>n.status===T)),e.innerHTML="",!t.length){e.appendChild(a("div",{className:"empty-state"},"No orders found"));return}const o=document.createDocumentFragment();t.forEach(n=>{const r=new Date(n.createdAt).toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"numeric"}),s=[];if(n.batch?.batchType){let i=`${n.batch.batchType} Batch`;s.push(a("span",{className:"badge badge-batch"},i))}s.push(a("span",{className:`badge badge-${n.status}`},n.status));const c=a("div",{className:"order-card",onclick:()=>window.openOrderDetail(n._id)},[a("div",{className:"order-top"},[a("div",{className:"order-number"},[n.orderNumber,n.batchLocked?" ðŸ”’":""]),a("div",{className:"order-products-summary"},`${n.products.length} item${n.products.length!==1?"s":""}`)]),a("div",{className:"order-bottom"},[a("div",{className:"order-date"},r),a("div",{className:"order-badges"},s)])]);o.appendChild(c)}),e.appendChild(o)}function ne(e){T=e,document.querySelectorAll(".status-pill").forEach(t=>{t.classList.toggle("active",t.dataset.status===e)}),Q()}document.querySelectorAll(".status-pill").forEach(e=>{e.addEventListener("click",()=>ne(e.dataset.status))});let d=null,w=[],N=[];async function ae(e){try{const[t,o]=await Promise.all([fetch(`/api/orders/${e}`,{credentials:"include"}),fetch(`/api/invoices/my-order/${e}`,{credentials:"include"})]),n=await t.json();if(t.ok&&n.data){d=n.data,w=JSON.parse(JSON.stringify(d.products||[]));try{const r=await o.json();N=o.ok?r.data||[]:[]}catch(r){console.warn("Failed to load invoices:",r.message),N=[]}re(),document.getElementById("orderModal").classList.add("show"),document.body.style.overflow="hidden"}else l(n.message||"Could not load order","info")}catch(t){console.error("Load order detail error:",t),l("Could not load details","info")}}function E(){document.getElementById("orderModal").classList.remove("show"),document.body.style.overflow="",d=null,w=[],N=[]}function re(){const e=d.status==="pending"&&!d.batchLocked,t=d.batchLocked,o=document.getElementById("orderModalTitle"),n=document.getElementById("orderModalBody"),r=document.getElementById("orderModalFooter");o.textContent=d.orderNumber,n.innerHTML="";const s=document.createDocumentFragment();t&&d.status==="pending"&&s.appendChild(a("div",{className:"batch-lock-notice"},[a("span",{className:"lock-icon"},"ðŸ”’"),a("span",{},"This order's batch has been confirmed. Contact us to make changes.")]));const c=a("div",{className:"order-info-grid"},[a("div",{},[a("div",{className:"info-label"},"Status"),a("span",{className:`badge badge-${d.status}`},d.status)]),a("div",{},[a("div",{className:"info-label"},"Date"),a("div",{className:"info-value"},new Date(d.createdAt).toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"numeric"}))])]);d.batch?.batchType&&c.appendChild(a("div",{},[a("div",{className:"info-label"},"Batch"),a("span",{className:"badge badge-batch"},[`${d.batch.batchType} Batch`,t?" ðŸ”’":""])]));const i=a("div",{className:"order-info-section"},[c,d.deliveryAddress?a("div",{style:{marginTop:"1rem"}},[a("div",{className:"info-label"},"Delivery Address"),a("div",{className:"info-value"},d.deliveryAddress)]):null,d.notes?a("div",{style:{marginTop:"1rem"}},[a("div",{className:"info-label"},"Notes"),a("div",{className:"info-value"},d.notes)]):null].filter(Boolean));s.appendChild(i),s.appendChild(a("div",{className:"divider"})),s.appendChild(a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Products"));const f=a("div",{id:"orderProductsList"});if(U(e,f),s.appendChild(f),N.length>0){s.appendChild(a("div",{className:"divider"})),s.appendChild(a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Invoices"));const u=a("div",{className:"invoices-list"});N.forEach(p=>{const y=new Date(p.generatedAt).toLocaleDateString("en-IN",{month:"short",day:"numeric"}),O=a("div",{className:"invoice-item",onclick:()=>window.downloadInvoice(p.invoiceNumber)},[a("div",{className:"invoice-info"},[a("div",{className:"invoice-number"},p.invoiceNumber),a("div",{className:"invoice-meta"},`${p.firm?.name||"Unknown Firm"} â€¢ ${y}`)]),a("div",{className:"invoice-download"},[])]);O.querySelector(".invoice-download").innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>`,u.appendChild(O)}),s.appendChild(u)}n.appendChild(s),r.innerHTML="",e?(r.appendChild(a("button",{className:"btn btn-secondary",onclick:()=>window.closeOrderModal()},"Cancel")),r.appendChild(a("button",{className:"btn btn-primary",style:{flex:"1"},onclick:()=>window.saveOrderEdit()},"Save Changes"))):r.appendChild(a("button",{className:"btn btn-primary btn-block",onclick:()=>window.closeOrderModal()},"Close"))}function U(e,t){t&&(t.innerHTML="",w.forEach((o,n)=>{e?t.appendChild(a("div",{className:"product-item-edit",dataset:{index:n}},[a("div",{className:"product-info"},[a("div",{className:"product-name"},o.productName),a("div",{className:"product-meta"},o.unit)]),a("div",{className:"qty-controls"},[a("button",{className:"qty-btn",onclick:()=>window.changeOrderQty(n,-1)},"âˆ’"),a("input",{type:"number",className:"qty-input",id:`order-qty-${n}`,value:o.quantity,min:"0",inputmode:"numeric",onchange:()=>window.updateOrderQtyFromInput(n)}),a("button",{className:"qty-btn",onclick:()=>window.changeOrderQty(n,1)},"+")])])):t.appendChild(a("div",{className:"product-item-edit readonly"},[a("div",{className:"product-info"},[a("div",{className:"product-name"},o.productName),a("div",{className:"product-meta"},`${o.quantity} ${o.unit}`)])]))}))}function se(e,t){const o=document.getElementById(`order-qty-${e}`);let n=parseFloat(o.value)||0;n=Math.max(0,n+t),o.value=n,w[e].quantity=n}function ce(e){const t=document.getElementById(`order-qty-${e}`),o=Math.max(0,parseFloat(t.value)||0);t.value=o,w[e].quantity=o}async function ie(e){try{l("Downloading invoice...","info");const t=await fetch(`/api/invoices/my/${e}/download`,{credentials:"include"});if(!t.ok){let s="Invoice not ready yet";try{s=(await t.json()).message||s}catch(c){console.warn("Failed to parse invoice download error:",c.message),s=t.status===404?"Invoice not ready yet":t.status===403?"Invoice access pending":"Invoice temporarily unavailable"}throw new Error(s)}const o=await t.blob(),n=window.URL.createObjectURL(o),r=document.createElement("a");r.href=n,r.download=`${e}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(n),l("Invoice downloaded!","success")}catch(t){console.error("Download invoice error:",t),l(t.message||"Could not download","info")}}async function de(){try{const e=w.filter(i=>i.quantity>0).map(i=>({product:typeof i.product=="object"?i.product._id:i.product,quantity:i.quantity}));if(!e.length){l("Add at least one product","info");return}const t=document.querySelector("#orderModalFooter .btn-primary");t&&(t.disabled=!0,t.textContent="Saving...");const o={"Content-Type":"application/json"},n=await v.ensureCsrfToken();n&&(o["X-CSRF-Token"]=n);const r={products:e};let s=await fetch(`/api/orders/${d._id}/customer-edit`,{method:"PUT",headers:o,credentials:"include",body:JSON.stringify(r)}),c=await s.json();if(s.status===403&&c?.message?.toLowerCase().includes("csrf")){const i=await v.refreshCsrfToken();i&&(o["X-CSRF-Token"]=i,s=await fetch(`/api/orders/${d._id}/customer-edit`,{method:"PUT",headers:o,credentials:"include",body:JSON.stringify(r)}),c=await s.json())}s.ok?(l("Order updated successfully","success"),E(),q()):l(c.message||"Could not update","info")}catch(e){console.error("Order edit error:",e),navigator.onLine?l("Could not update. Try again.","info"):l("No internet connection","info")}finally{const e=document.querySelector("#orderModalFooter .btn-primary");e&&(e.disabled=!1,e.textContent="Save Changes")}}const j=document.getElementById("orderModal");j&&j.addEventListener("click",e=>{e.target.id==="orderModal"&&E()});document.addEventListener("keydown",e=>{const t=document.getElementById("orderModal");e.key==="Escape"&&t&&t.classList.contains("show")&&E()});window.clearZero=Y;window.restoreZero=ee;window.changeQty=te;window.updateFromInput=R;window.placeOrder=oe;window.openOrderDetail=ae;window.closeOrderModal=E;window.saveOrderEdit=de;window.renderOrderProducts=U;window.changeOrderQty=se;window.updateOrderQtyFromInput=ce;window.downloadInvoice=ie;J();
