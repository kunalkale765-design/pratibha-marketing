import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as u,c as n}from"./ui-D1Am529b.js";import"./api-BqPqbFNt.js";const te=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(te()),10)}),A=await te();let j=[],J={},ne=[],p=[],z="all",T=null,N=null,h=null,C={},I={},k=!1,ee=!1;async function re(){if(h=await A.requireAuth(),!!h){if(h.role==="customer"){const e=document.getElementById("modalFooter");e&&(e.style.display="none")}ce(),await Promise.all([F(),de(),le()]),me(),fe()}}function ce(){if(ee)return;ee=!0;const e=document.getElementById("ordersList");if(!e)return;document.addEventListener("click",i=>{i.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(r=>{r.classList.remove("swiped","swiped-single")})});let t={startX:0,isDragging:!1,currentItem:null};e.addEventListener("touchstart",i=>{const r=i.target.closest(".swipe-item");r&&(t={startX:i.touches[0].clientX,isDragging:!0,currentItem:r},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(c=>{c!==r&&c.classList.remove("swiped","swiped-single")}))},{passive:!0}),e.addEventListener("touchmove",i=>{if(!t.isDragging||!t.currentItem)return;const r=h?.role==="admin",c=t.startX-i.touches[0].clientX;c>50?(t.currentItem.classList.remove("swiped-single","swiped"),t.currentItem.classList.add(r?"swiped":"swiped-single")):c<-20&&t.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),e.addEventListener("touchend",()=>{t.isDragging=!1,t.currentItem=null},{passive:!0});const o=document.getElementById("orderModal");o&&(o.onclick=i=>{i.target.id==="orderModal"&&H()});const a=document.getElementById("invoiceModal");a&&(a.onclick=i=>{i.target.id==="invoiceModal"&&K()})}async function de(){try{const e=await fetch("/api/market-rates",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);((await e.json()).data||[]).forEach(o=>{const a=typeof o.product=="object"?o.product._id:o.product;J[a]=o.rate})}catch(e){console.error("Failed to load market rates:",e)}}async function le(){try{const e=await fetch("/api/products",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);ne=((await e.json()).data||[]).filter(o=>o.isActive!==!1)}catch(e){console.error("Failed to load products:",e)}}async function F(){try{const e=await fetch("/api/orders?limit=100",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);const t=await e.json();if(!t.success)throw new Error(t.message||"Orders temporarily unavailable");j=t.data||[];const o=j.filter(a=>!a._id||!/^[a-f\d]{24}$/i.test(a._id));o.length>0&&console.warn("Orders with invalid IDs:",o.map(a=>({orderNumber:a.orderNumber,_id:a._id}))),Z()}catch(e){if(console.error("Failed to load orders:",e),!j||j.length===0){const t=document.getElementById("ordersList"),o=navigator.onLine?"Orders not available":"No internet connection";t.innerHTML="",t.appendChild(n("div",{className:"empty-state"},[n("p",{},o),n("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:F},"Try Again")]))}}}function ue(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Z(){const e=document.getElementById("ordersList");if(!e)return;const t=document.getElementById("searchInput"),o=t?t.value.toLowerCase():"",a=h?.role==="admin",i=h?.role==="admin"||h?.role==="staff";let r=j.filter(s=>s._id&&/^[a-f\d]{24}$/i.test(s._id));if(z==="all"?r=r.filter(s=>s.status!=="cancelled"):r=r.filter(s=>s.status===z),o&&(r=r.filter(s=>s.orderNumber?.toLowerCase().includes(o)||s.customer?.name?.toLowerCase().includes(o))),!r.length){e.innerHTML="",e.appendChild(n("div",{className:"empty-state"},"No orders found"));return}e.innerHTML="";const c=document.createDocumentFragment();r.forEach((s,y)=>{let m=null;s.batch?.batchType&&(m=n("span",{className:"badge badge-batch"},[s.batch.batchType,s.batchLocked?" ðŸ”’":""]));const b=n("div",{className:"swipe-content",onclick:()=>window.viewOrder(s._id)},[n("div",{className:"order-avatar"},ue(s.customer?.name)),n("div",{className:"order-info"},[n("div",{className:"order-customer"},s.customer?.name||"Unknown"),s.notes?n("div",{className:"order-notes"},s.notes):null,n("div",{className:"order-meta-row"},[n("span",{className:"order-number"},`Order #${s.orderNumber}`),m])]),n("div",{className:"order-amount-pill"},`â‚¹${(s.totalAmount||0).toLocaleString("en-IN")}`)]),d=[];i&&d.push(n("button",{className:"swipe-action edit",onclick:w=>{w.stopPropagation(),window.printOrder(s._id)}},"Print")),a&&d.push(n("button",{className:"swipe-action delete",onclick:w=>{w.stopPropagation(),window.deleteOrder(s._id)}},"Delete"));const v=n("div",{className:"swipe-actions"},d),$=n("div",{className:"swipe-item card-fade-in",dataset:{orderId:s._id},style:{animationDelay:`${y*.05}s`}},[b,v]);c.appendChild($)}),e.appendChild(c)}function me(){const e=document.getElementById("filterSegments"),t=document.getElementById("segmentIndicator"),o=e.querySelectorAll(".segment-btn");function a(r){const c=e.getBoundingClientRect(),s=r.getBoundingClientRect(),y=s.left-c.left,m=s.width;t.style.left=y+"px",t.style.width=m+"px"}const i=e.querySelector(".segment-btn.active");i&&setTimeout(()=>a(i),10),o.forEach(r=>{r.onclick=()=>{o.forEach(s=>s.classList.remove("active")),r.classList.add("active"),a(r),z=r.dataset.filter;const c=document.getElementById("ordersList");c.classList.add("segment-content"),Z(),setTimeout(()=>c.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const r=e.querySelector(".segment-btn.active");r&&a(r)})}function pe(e,t){let o;return function(...a){clearTimeout(o),o=setTimeout(()=>e.apply(this,a),t)}}function fe(){const e=document.getElementById("searchInput");if(e){const t=pe(Z,200);e.addEventListener("input",t)}}let E=null,S=null,B=new Set;async function G(e){if(h?.role==="customer"){u("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i.classList.remove("swiped","swiped-single")});const t=/^[a-f\d]{24}$/i.test(e);if(!e||!t){console.error("Invalid order ID:",e),u("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const o=document.getElementById("invoiceModalBody");o.innerHTML="",o.appendChild(n("div",{className:"invoice-loading"},"Loading invoice data..."));const a=document.getElementById("generateInvoiceBtn");a&&(a.disabled=!0);try{await ve();const i=await fetch(`/api/invoices/${e}/split`,{credentials:"include"});if(!i.ok){const c=await i.json().catch(()=>({}));throw new Error(c.message||"Invoice data temporarily unavailable")}E=(await i.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${E.orderNumber}`,Y()}catch(i){console.error("Print order error:",i),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(n("div",{className:"invoice-no-items"},[n("p",{},"Invoice data not available"),n("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},i.message)]))}}let P=[];async function ve(){if(!(P.length>0))try{const e=await fetch("/api/invoices/firms",{credentials:"include"});e.ok&&(P=(await e.json()).data||[])}catch(e){console.error("Failed to load firms:",e)}}function Y(){const e=document.getElementById("invoiceModalBody");if(!E){e.innerHTML="",e.appendChild(n("div",{className:"invoice-no-items"},"No items to invoice"));return}const t=E.firms.flatMap(s=>s.items);if(t.length===0){e.innerHTML="",e.appendChild(n("div",{className:"invoice-no-items"},"No items to invoice"));return}S||(S=P.length>0?P[0].id:E?.firms?.[0]?.firmId||"pratibha",B=new Set(t.map(s=>s.productId)));const o=t.filter(s=>B.has(s.productId)).reduce((s,y)=>s+(y.amount||0),0),a=P.length>0?P:(E?.firms||[]).map(s=>({id:s.firmId,name:s.firmName}));e.innerHTML="";const i=document.createDocumentFragment(),r=n("div",{className:"invoice-firm-selector"},[n("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),n("div",{className:"firm-options"},a.map(s=>n("label",{className:`firm-option ${S===s.id?"selected":""}`,onclick:()=>window.selectFirm(s.id)},[n("input",{type:"radio",name:"firm",value:s.id,checked:S===s.id}),n("span",{className:"firm-option-name"},s.name)])))]);i.appendChild(r),i.appendChild(n("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),i.appendChild(n("div",{className:"invoice-items-list"},t.map(s=>n("div",{className:"invoice-item"},[n("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:s.productId},checked:B.has(s.productId),onchange:()=>window.toggleInvoiceItem(null,s.productId)}),n("div",{className:"invoice-item-details"},[n("div",{className:"invoice-item-name"},s.productName),n("div",{className:"invoice-item-meta"},`${s.quantity||0} ${s.unit||""} Ã— â‚¹${(s.rate||0).toLocaleString("en-IN")}`)]),n("div",{className:"invoice-item-amount"},`â‚¹${(s.amount||0).toLocaleString("en-IN")}`)])))),i.appendChild(n("div",{className:"invoice-summary"},[n("div",{className:"invoice-summary-label"},"Total"),n("div",{className:"invoice-summary-total"},`â‚¹${o.toLocaleString("en-IN")}`)])),e.appendChild(i);const c=document.getElementById("generateInvoiceBtn");c&&(c.disabled=B.size===0)}function ge(e){S=e,Y()}function he(e,t){B.has(t)?B.delete(t):B.add(t),Y()}async function ye(){if(!E||!S||B.size===0)return;const e=document.getElementById("generateInvoiceBtn");e.classList.add("btn-loading"),e.disabled=!0;try{const t={"Content-Type":"application/json"},o=await A.ensureCsrfToken();o&&(t["X-CSRF-Token"]=o);const a=await fetch(`/api/invoices/${E.orderId}/pdf`,{method:"POST",headers:t,credentials:"include",body:JSON.stringify({firmId:S,productIds:Array.from(B)})});if(!a.ok){const s=await a.json().catch(()=>({}));throw new Error(s.message||"Invoice generation temporarily unavailable")}const i=await a.blob(),r=URL.createObjectURL(i),c=document.createElement("a");c.href=r,c.download=`INV${E.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r),u("Invoice downloaded","success"),K()}catch(t){console.error("Generate invoice error:",t),u(t.message||"Could not generate invoice","info")}finally{e.classList.remove("btn-loading"),e.disabled=!1}}function K(){document.getElementById("invoiceModal").classList.remove("show"),E=null,S=null,B=new Set}function we(){if(!T)return;const e=T;H(),G(e)}async function be(e){if(h?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const t=document.querySelector(`.swipe-item[data-order-id="${e}"]`);try{const o={"Content-Type":"application/json"},a=await A.ensureCsrfToken();a&&(o["X-CSRF-Token"]=a);const i=await fetch(`/api/orders/${e}`,{method:"DELETE",headers:o,credentials:"include"});if(i.ok)t?(t.classList.add("deleting"),setTimeout(()=>{F()},300)):F(),u("Order cancelled","success");else{const r=await i.json().catch(()=>({message:"Could not cancel. Try again."}));u(r.message||"Could not cancel","info")}}catch(o){console.error("Delete order error:",o),u("Could not delete order","info")}}async function Q(e){if(k){u("Please wait, saving in progress...","info");return}try{const t=await fetch(`/api/orders/${e}`,{credentials:"include"});let o;try{o=await t.json()}catch(l){console.error("Failed to parse order response:",l),u("Server issue. Please refresh.","info");return}if(!t.ok){u(o?.message||"Could not load order","info");return}const a=o.data;if(!a||!a.products){u("Order data updating. Refresh page.","info");return}T=e,N=a,C={},I={},p=[];const i=document.getElementById("modalTitle");i&&(i.textContent=`#${a.orderNumber}`);const r=document.getElementById("savePricesBtn");r&&(r.disabled=!0);const c=h.role==="admin"||h.role==="staff",s=a.batch?.batchType?`<span class="badge badge-batch">${a.batch.batchType}${a.batchLocked?" ðŸ”’":""}</span>`:"-",y=document.getElementById("modalBody");y.innerHTML="";const m=document.createDocumentFragment(),b=n("div",{className:"info-row"},[n("div",{},[n("div",{className:"info-label"},"Customer"),n("div",{className:"info-value"},a.customer?.name||"")]),n("div",{},[n("div",{className:"info-label"},"Phone"),n("div",{className:"info-value"},a.customer?.phone||"-")])]);m.appendChild(b);const d=a.batch?.batchType?n("span",{className:"badge badge-batch"},[a.batch.batchType,a.batchLocked?" ðŸ”’":""]):"-",v=n("div",{className:"info-row"},[n("div",{},[n("div",{className:"info-label"},"Date"),n("div",{className:"info-value"},new Date(a.createdAt).toLocaleDateString("en-IN"))]),n("div",{},[n("div",{className:"info-label"},"Batch"),n("div",{className:"info-value"},Array.isArray(d)?d:[d])])]);m.appendChild(v);const $=n("div",{className:"info-row"},[n("div",{},[n("div",{className:"info-label"},"Status"),n("div",{className:"info-value"},[n("span",{className:`badge badge-${a.status}`},a.status)])]),n("div",{})]);m.appendChild($);const w=n("div",{className:"info-section"});if(w.appendChild(n("div",{className:"info-label"},"Products")),a.products.forEach((l,f)=>{const M=typeof l.product=="object"?l.product._id:l.product,g=J[M]||l.rate||null,O=g?`â‚¹${g.toLocaleString("en-IN")}`:"N/A";let U;if(c){const D=n("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${f}`,value:l.quantity,min:"0",step:"0.01",dataset:{idx:f,original:l.quantity,unit:l.unit},onfocus:q=>window.clearZero(q.target),onblur:q=>window.restoreValue(q.target),onchange:()=>window.handleQuantityChange(f),oninput:()=>window.handleQuantityInput(f)});U=n("div",{className:"qty-controls-inline"},[n("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(f,-1)},"âˆ’"),D,n("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(f,1)},"+"),n("span",{className:"qty-unit"},l.unit)])}else U=n("div",{className:"product-qty"},`${l.quantity} ${l.unit}`);const X=["Selling"];l.isContractPrice&&(X.push(" "),X.push(n("span",{className:"contract-badge"},"Fixed")));let V;if(c){const D=n("input",{type:"number",className:`price-input input-animated${l.isContractPrice?" contract-locked":""}`,id:`price-${f}`,value:l.rate,min:"0",step:"0.01",dataset:{idx:f,original:l.rate,qty:l.quantity,contract:l.isContractPrice||!1},onfocus:q=>window.clearZero(q.target),onblur:q=>window.restoreValue(q.target),onchange:()=>window.handlePriceChange(f),oninput:()=>window.handlePriceInput(f)});l.isContractPrice&&(D.disabled=!0,D.title="Contract price - edit in customer management"),V=D}else V=n("div",{className:"price-value"},`â‚¹${l.rate}`);const se=n("div",{className:"product-item",dataset:{idx:f}},[n("div",{className:"product-top"},[n("div",{},[n("div",{className:"product-name"},l.productName),U])]),n("div",{className:"prices-container"},[n("div",{className:"price-box"},[n("div",{className:"price-label"},"Purchase"),n("div",{className:"price-value"},O)]),n("div",{className:"price-box"},[n("div",{className:"price-label"},X),V])]),n("div",{className:"amount-row"},[n("span",{className:"amount-label"},"Amount"),n("span",{className:"amount-display",id:`amount-${f}`},`â‚¹${l.amount}`)])]);w.appendChild(se)}),w.appendChild(n("div",{id:"addedProductsContainer"})),c){const l=[n("option",{value:""},"+ Add Product...")];ne.filter(g=>!a.products.some(O=>(typeof O.product=="object"?O.product._id:O.product)===g._id)).forEach(g=>{l.push(n("option",{value:g._id,dataset:{name:g.name,unit:g.unit}},`${g.name} (${g.unit})`))});const f=n("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},l),M=n("div",{className:"add-product-section"},[f]);w.appendChild(M)}m.appendChild(w);const ie=n("div",{className:"total-section"},[n("div",{className:"total-row"},[n("span",{},"Total"),n("span",{id:"orderTotal"},`â‚¹${a.totalAmount}`)]),n("div",{className:"total-row"},[n("span",{},"Paid"),n("span",{},`â‚¹${a.paidAmount||0}`)]),n("div",{className:"total-row main"},[n("span",{},"Balance"),n("span",{id:"orderBalance"},`â‚¹${a.totalAmount-(a.paidAmount||0)}`)])]);if(m.appendChild(ie),y.appendChild(m),c){const l=document.getElementById("modalFooter");if(l){l.innerHTML="";const f=n("button",{className:"btn-modal secondary btn-animated",onclick:()=>window.printFromModal()},n("span",{className:"btn-text"},"Invoice"));if(l.appendChild(f),a.status==="pending"){const g=n("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--dusty-olive)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(a._id,"confirmed")},"Confirm Order");l.appendChild(g)}else if(["confirmed","processing","packed","shipped"].includes(a.status)){const g=n("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--gunmetal)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(a._id,"delivered")},"Mark Delivered");l.appendChild(g)}const M=n("button",{className:"btn-save-prices btn-animated",id:"savePricesBtn",disabled:!0,onclick:()=>window.savePrices()},n("span",{className:"btn-text"},"Save"));l.appendChild(M)}}document.getElementById("orderModal").classList.add("show")}catch{u("Could not load order","info")}}function Ie(e){e.dataset.prevValue=e.value,e.value="",e.select()}function Ne(e){e.value===""&&(e.value=e.dataset.prevValue||e.dataset.original);const t=parseInt(e.dataset.idx);ae(t)}function Ce(e){const t=document.getElementById(`price-${e}`),o=document.getElementById(`quantity-${e}`),a=parseFloat(t.dataset.original),i=parseFloat(t.value)||0,r=o?parseFloat(o.value)||0:parseFloat(t.dataset.qty);t.classList.toggle("changed",i!==a);const c=Math.round(i*r*100)/100,s=document.getElementById(`amount-${e}`);s&&(s.textContent=`â‚¹${c.toLocaleString("en-IN")}`),L()}function ae(e){const t=document.getElementById(`price-${e}`);if(!t)return;const o=parseFloat(t.dataset.original),a=parseFloat(t.value)||0;a!==o&&a>0?C[e]=a:delete C[e],_()}function Ee(e,t){const o=document.getElementById(`quantity-${e}`);if(!o)return;let i=(parseFloat(o.value)||0)+t;i<.01&&i>0&&(i=0),i<0&&(i=0),o.value=i,oe(e),W(e)}function W(e){const t=document.getElementById(`quantity-${e}`),o=document.getElementById(`price-${e}`);if(!t)return;const a=parseFloat(t.dataset.original),i=parseFloat(t.value)||0;t.classList.remove("changed","removed"),i===0?t.classList.add("removed"):i!==a&&t.classList.add("changed");const r=o?parseFloat(o.value)||0:N?.products[e]?.rate||0,c=Math.round(i*r*100)/100,s=document.getElementById(`amount-${e}`);s&&(s.textContent=`â‚¹${c.toLocaleString("en-IN")}`),L()}function oe(e){const t=document.getElementById(`quantity-${e}`);if(!t)return;const o=parseFloat(t.dataset.original),a=parseFloat(t.value)||0,i=.01;a>0&&a<i?(u(`Minimum quantity: ${i} ${t.dataset.unit}`,"info"),t.value=o,delete I[e]):a!==o?I[e]=a:delete I[e],_(),W(e)}function _(){const e=Object.keys(C).length>0||Object.keys(I).length>0||p.length>0,t=document.getElementById("savePricesBtn");t&&(t.disabled=!e)}function Be(){const e=document.getElementById("productSelector"),t=e.value;if(!t)return;const o=e.options[e.selectedIndex],a=o.dataset.name,i=o.dataset.unit,r=J[t]||0;p.push({product:t,productName:a,unit:i,quantity:1,rate:r}),o.remove(),x(),L(),_(),e.value=""}function x(){const e=document.getElementById("addedProductsContainer");if(!e)return;e.innerHTML="";const t=document.createDocumentFragment();p.forEach((o,a)=>{const i=n("div",{className:"product-item added-product",dataset:{addedIdx:a}},[n("div",{className:"product-top"},[n("div",{},[n("div",{className:"product-name"},[o.productName," ",n("span",{className:"new-badge"},"New")]),n("div",{className:"qty-controls-inline"},[n("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(a,-1),type:"button"},"âˆ’"),n("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${a}`,value:o.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(a),oninput:()=>window.handleAddedQtyInput(a)}),n("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(a,1),type:"button"},"+"),n("span",{className:"qty-unit"},o.unit)])]),n("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(a),title:"Remove"},"Ã—")]),n("div",{className:"prices-container"},[n("div",{className:"price-box"},[n("div",{className:"price-label"},"Purchase"),n("div",{className:"price-value"},o.rate?`â‚¹${o.rate.toLocaleString("en-IN")}`:"N/A")]),n("div",{className:"price-box"},[n("div",{className:"price-label"},"Selling"),n("input",{type:"number",className:"price-input input-animated",id:`added-price-${a}`,value:o.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(a)})])]),n("div",{className:"amount-row"},[n("span",{className:"amount-label"},"Amount"),n("span",{className:"amount-display",id:`added-amount-${a}`},`â‚¹${((o.rate||0)*(o.quantity||0)).toLocaleString("en-IN")}`)])]);t.appendChild(i)}),e.appendChild(t)}function Le(e,t){const o=document.getElementById(`added-qty-${e}`);if(!o)return;let a=parseFloat(o.value)||0;a=Math.max(0,a+t),a>0&&a<.01&&(a=.01),o.value=a,p[e].quantity=a,R(e),L()}function $e(e){const t=document.getElementById(`added-qty-${e}`);if(!t)return;let o=parseFloat(t.value)||0;o>0&&o<.01&&(u("Minimum quantity: 0.01","info"),o=.01,t.value=o),p[e].quantity=o,R(e),L()}function ke(e){const t=document.getElementById(`added-qty-${e}`);if(!t)return;const o=parseFloat(t.value)||0;p[e].quantity=o,R(e),L()}function Te(e){const t=document.getElementById(`added-price-${e}`);if(!t)return;const o=parseFloat(t.value)||0;p[e].rate=o,R(e),L()}function Se(e){const t=document.getElementById(`added-price-${e}`);if(!t)return;const o=parseFloat(t.value)||0;p[e].rate=o,R(e),L()}function R(e){const t=document.getElementById(`added-amount-${e}`);if(!t)return;const o=p[e],a=(o.quantity||0)*(o.rate||0);t.textContent=`â‚¹${a.toLocaleString("en-IN")}`}function qe(e){const t=p.splice(e,1)[0],o=document.getElementById("productSelector");if(o&&t){const a=document.createElement("option");a.value=t.product,a.dataset.name=t.productName,a.dataset.unit=t.unit,a.textContent=`${t.productName} (${t.unit})`,o.appendChild(a)}x(),L(),_()}function L(){if(!N||!N.products)return;let e=0;N.products.forEach((i,r)=>{const c=document.getElementById(`price-${r}`),s=document.getElementById(`quantity-${r}`),y=c?parseFloat(c.value)||0:i.rate,m=s?parseFloat(s.value)||0:i.quantity;e+=y*m}),p.forEach(i=>{e+=(i.quantity||0)*(i.rate||0)}),e=Math.round(e*100)/100;const t=Math.round((e-(N.paidAmount||0))*100)/100,o=document.getElementById("orderTotal"),a=document.getElementById("orderBalance");o&&(o.textContent=`â‚¹${e.toLocaleString("en-IN")}`),a&&(a.textContent=`â‚¹${t.toLocaleString("en-IN")}`)}async function Pe(e){try{const t=await fetch(`/api/invoices/order/${e}`,{credentials:"include"});if(!t.ok)return!1;const o=await t.json();return o.data&&o.data.length>0}catch(t){return console.error("Failed to check invoices:",t),!1}}async function Ae(){const e=Object.keys(C).length>0||Object.keys(I).length>0||p.length>0;if(!T||!N||!N.products||!e)return;if(k){u("Save in progress...","info");return}k=!0;const t=document.getElementById("savePricesBtn");t&&(t.disabled=!0,t.classList.add("btn-loading"));let o=!1;try{if(o=await Pe(T),o&&!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`)){k=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}catch(a){console.error("Invoice check failed:",a)}try{const a=N.products.map((d,v)=>{let $=C[v]!==void 0?C[v]:d.rate,w=I[v]!==void 0?I[v]:d.quantity;return(!$||$<=0)&&($=d.rate),w<0&&(w=d.quantity),{product:typeof d.product=="object"?d.product._id:d.product,quantity:w,priceAtTime:$}}).filter(d=>d.quantity>0),i=p.filter(d=>d.quantity>0).map(d=>({product:d.product,quantity:d.quantity,priceAtTime:d.rate})),r=[...a,...i],c={"Content-Type":"application/json"},s=await A.ensureCsrfToken();s&&(c["X-CSRF-Token"]=s);const y={products:r},m=T;let b=await fetch(`/api/orders/${m}`,{method:"PUT",headers:c,credentials:"include",body:JSON.stringify(y)});if(b.status===403){let d;try{d=await b.json()}catch(v){console.warn("Failed to parse CSRF error response:",v.message),d={message:`Access denied (code: ${b.status})`}}if(d.message?.toLowerCase().includes("csrf")){const v=await A.refreshCsrfToken();if(v){if(c["X-CSRF-Token"]=v,b=await fetch(`/api/orders/${m}`,{method:"PUT",headers:c,credentials:"include",body:JSON.stringify(y)}),b.status===403){u("Session expired. Please refresh the page.","info"),k=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}else{u("Session expired. Please refresh the page.","info"),k=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}else{u(d.message||"Access temporarily unavailable","info"),k=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}if(b.ok)u("Changes saved","success"),C={},I={},p=[],t&&(t.classList.remove("btn-loading"),t.classList.add("btn-success"),setTimeout(()=>t.classList.remove("btn-success"),1500),t.disabled=!0),F(),o&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const d=m;H(),setTimeout(()=>G(d),300)}},500),T===m&&Q(m);else{let d;try{d=await b.json()}catch(v){console.warn("Failed to parse order save error response:",v.message),d={message:`Server error (${b.status})`}}u(d.message||"Could not update","info"),t&&(t.disabled=!1)}}catch(a){console.error("Save changes error:",a),navigator.onLine?u("Could not save. Try again.","info"):u("No internet connection","info"),t&&(t.disabled=!1)}finally{k=!1,t&&t.classList.remove("btn-loading")}}function H(){if((Object.keys(C).length>0||Object.keys(I).length>0||p.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const t=document.getElementById("orderModal");t&&t.classList.remove("show"),T=null,N=null,C={},I={},p=[]}window.closeModal=H;window.viewOrder=Q;window.clearZero=Ie;window.restoreValue=Ne;window.handlePriceChange=ae;window.handlePriceInput=Ce;window.handleQuantityChange=oe;window.handleQuantityInput=W;window.changeQuantity=Ee;window.savePrices=Ae;window.deleteOrder=be;window.printOrder=G;window.closeInvoiceModal=K;window.selectFirm=ge;window.toggleInvoiceItem=he;window.generateInvoice=ye;window.printFromModal=we;window.addProductToOrder=Be;window.renderAddedProducts=x;window.changeAddedQty=Le;window.handleAddedQtyChange=$e;window.handleAddedQtyInput=ke;window.handleAddedPriceChange=Te;window.handleAddedPriceInput=Se;window.removeAddedProduct=qe;async function Fe(e,t){if(!(!h||h.role!=="admin"&&h.role!=="staff"))try{const o={"Content-Type":"application/json"},a=await A.ensureCsrfToken();a&&(o["X-CSRF-Token"]=a);const i=await fetch(`/api/orders/${e}/status`,{method:"PUT",headers:o,credentials:"include",body:JSON.stringify({status:t})}),r=await i.json();i.ok?(u(`Order marked as ${t}`,"success"),Q(e),F()):(u(r.message||"Failed to update status","error"),Q(e))}catch(o){console.error("Status update error:",o),u("Network error updating status","error"),Q(e)}}window.updateOrderStatus=Fe;re();
