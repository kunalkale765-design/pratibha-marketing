import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css                */import{f as F}from"./utils-DKdRYW2s.js";import{c as a,s as P}from"./ui-DIkDDhU-.js";import"./api-ftmLnZye.js";import{i as ee}from"./init-ZQlfxMN6.js";const X=(e=0)=>new Promise((t,n)=>{window.Auth?t(window.Auth):e>500?n(new Error("Auth module failed to load")):setTimeout(()=>X(e+1).then(t).catch(n),10)});let x;try{x=await X()}catch(e){console.error("Auth initialization failed:",e),window.location.href="/pages/auth/login.html"}ee();let J=[],f={toProcure:[],procured:[],categories:[]},T="",v="";const C={};let R={},g=null,I=null,y=null,N=null,O=!1,A=!1;function te(){N=new Audio("/assets/sounds/notification.wav"),N.preload="auto",N.volume=.5}window.addEventListener("beforeunload",()=>{g&&(clearInterval(g),g=null),y&&(y.close().catch(()=>{}),y=null),N&&(N=null)});document.addEventListener("visibilitychange",()=>{document.hidden?g&&(clearInterval(g),g=null):g||G()});function ae(){if(O){if(N){N.currentTime=0,N.play().catch(()=>{j()});return}j()}}function j(){try{y||(y=new(window.AudioContext||window.webkitAudioContext)),y.state==="suspended"&&y.resume();const e=y.createOscillator(),t=y.createOscillator(),n=y.createGain();e.connect(n),t.connect(n),n.connect(y.destination),e.frequency.value=880,e.type="sine",t.frequency.value=1108.73,t.type="sine";const r=y.currentTime;n.gain.setValueAtTime(0,r),n.gain.linearRampToValueAtTime(.3,r+.05),n.gain.linearRampToValueAtTime(.2,r+.15),n.gain.linearRampToValueAtTime(.3,r+.2),n.gain.linearRampToValueAtTime(0,r+.35),e.start(r),t.start(r),e.stop(r+.35),t.stop(r+.35)}catch(e){console.log("Could not play notification sound:",e)}}const D=document.getElementById("printBtn"),H=document.getElementById("exportBtn"),h=document.getElementById("saveRatesBtn"),U=document.getElementById("purchaseSearch"),L=document.getElementById("newOrderBadge"),B=document.getElementById("procuredHeader");D&&D.addEventListener("click",ce);H&&H.addEventListener("click",ie);h&&h.addEventListener("click",le);let V=null;U&&U.addEventListener("input",e=>{T=e.target.value.trim().toLowerCase(),clearTimeout(V),V=setTimeout(()=>S(),200)});const M=document.getElementById("categoryPills");M&&M.addEventListener("click",e=>{const t=e.target.closest(".category-pill");t&&(document.querySelectorAll(".category-pill").forEach(n=>n.classList.remove("active")),t.classList.add("active"),v=t.dataset.category,S())});function re(e){const t=document.getElementById("categoryPills");if(!t)return;t.innerHTML='<button class="category-pill active" data-category="">All</button>';const n={"Indian Vegetables":"Vegetables","Exotic Vegetables":"Exotic",Fruits:"Fruits",Frozen:"Frozen",Dairy:"Dairy"};if(e.forEach(r=>{const l=a("button",{className:"category-pill"+(v===r?" active":""),dataset:{category:r}},n[r]||r);t.appendChild(l)}),v){const r=t.querySelector(`[data-category="${v}"]`);r?(t.querySelector(".active")?.classList.remove("active"),r.classList.add("active")):v=""}}B&&B.addEventListener("click",()=>{B.classList.toggle("collapsed")});function W(){if(!O)try{y=new(window.AudioContext||window.webkitAudioContext),te(),O=!0}catch(e){console.log("Could not initialize audio:",e)}}document.addEventListener("click",W,{once:!0});document.addEventListener("touchstart",W,{once:!0});async function k(){try{const[e,t]=await Promise.all([fetch("/api/market-rates",{credentials:"include"}),fetch("/api/supplier/procurement-summary",{credentials:"include"})]);if(!e.ok||!t.ok){const l=e.ok?"procurement":"rates";throw new Error(`Failed to load ${l} data`)}const n=await e.json(),r=await t.json();J=n.data||[],f={toProcure:r.toProcure||[],procured:r.procured||[],categories:r.categories||[]},re(f.categories),_(f),Z(f),S(),G()}catch(e){console.error("Error loading data:",e);const t=document.getElementById("toProcureList");t&&(t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},[a("p",{},"Data not available"),a("button",{id:"retryBtn",className:"btn-retry",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:k},"Try Again")])))}}function Z(e){R={},[...e.toProcure,...e.procured].forEach(t=>{R[t.productId]=t.totalQty})}function _(e){if(Object.keys(R).length===0)return;let t=0;[...e.toProcure,...e.procured].forEach(r=>{const l=R[r.productId]||0;r.totalQty>l&&t++}),t>0&&(ae(),L&&(L.textContent=`${t} new`,L.classList.remove("hidden"),I&&clearTimeout(I),I=setTimeout(()=>{L&&L.classList.add("hidden"),I=null},3e4)),P(`${t} product(s) have new orders!`,"info"))}function G(){g&&clearInterval(g),g=setInterval(async()=>{if(!A){A=!0;try{if(!document.getElementById("toProcureList")){clearInterval(g),g=null;return}const e=await fetch("/api/supplier/procurement-summary",{credentials:"include"});if(e.status===401){clearInterval(g),g=null,window.location.href="/pages/auth/login.html";return}if(!e.ok){console.warn("Polling failed:",e.status);return}const t=await e.json(),n={toProcure:t.toProcure||[],procured:t.procured||[],categories:t.categories||[]};_(n),f=n,Z(f),S(!0)}catch(e){console.error("Polling error:",e)}finally{A=!1}}},3e4)}function S(e=!1){const t=document.getElementById("toProcureList"),n=document.getElementById("procuredList"),r=document.getElementById("procurementEmpty"),l=document.getElementById("procuredCount");if(!t||!n){console.error("Purchase List: Required DOM elements missing.");const c=document.querySelector(".procurement-container");if(c&&!c.querySelector(".procurement-error")){const o=document.createElement("div");o.className="procurement-error",o.style.cssText="padding:1.5rem;text-align:center;color:var(--error);font-size:0.875rem;",o.textContent="Purchase list failed to load. Please refresh the page.",c.appendChild(o)}return}const u={};e&&document.querySelectorAll(".item-rate-input").forEach(c=>{c.value&&(u[c.dataset.productId]=c.value)}),t.innerHTML="",n.innerHTML="";const d=c=>c.filter(i=>{const o=!T||i.productName.toLowerCase().includes(T),E=!v||i.category===v;return o&&E}),m=d(f.toProcure),s=d(f.procured);l&&(l.textContent=s.length),m.length===0&&f.toProcure.length===0?(r&&r.classList.remove("hidden"),t.innerHTML='<div class="empty-list-msg">No items to procure</div>'):r&&r.classList.add("hidden");const p={};if(J.forEach(c=>{p[c.product]=c}),m.length>0){const c=document.createDocumentFragment();c.appendChild(a("div",{className:"procurement-column-header"},[a("span",{className:"col-expand"}),a("span",{className:"col-name"},"Product"),a("span",{className:"col-qty"},"Qty"),a("span",{className:"col-input"},"Rate")]));let i="";m.forEach(o=>{o.category!==i&&(i=o.category,c.appendChild(a("div",{className:"category-divider"},i)));const E=p[o.productId],w=o.currentRate||E?.rate||0,Q=u[o.productId]||"",K=w===0?" unsaved":"";let $;o.wasProcured?$=a("span",{className:"qty-breakdown"},[a("span",{className:"procured-qty"},String(o.procuredQty||0)),a("span",{className:"separator"},"+"),a("span",{className:"new-qty highlight-new"},String(o.newQty||0))]):$=a("span",{className:"qty-simple"},String(o.totalQty||0));const q=[a("div",{className:"detail-row"},[a("span",{className:"detail-label"},"Total Orders"),a("span",{className:"detail-value"},o.totalOrders||0)])];o.wasProcured&&o.lastRate&&q.unshift(a("div",{className:"detail-row highlight-info"},[a("span",{className:"detail-label"},"Last Rate"),a("span",{className:"detail-value"},`₹${o.lastRate}/${o.unit}`)])),q.push(a("div",{className:"detail-row"},[a("span",{className:"detail-label"},"Est. Cost"),a("span",{className:"detail-value highlight"},o.totalQty>0&&w>0?F(o.totalQty*w):"—")]),a("div",{className:"detail-row"},[a("span",{className:"detail-label"},"Trend"),a("span",{className:"detail-value"},o.trend==="up"?"↑ Up":o.trend==="down"?"↓ Down":"— Stable")]));const Y=a("div",{className:`procurement-item${K}${o.wasProcured?" was-procured":""}`,dataset:{productId:o.productId}},[a("div",{className:"item-main",onclick:b=>z(b.currentTarget)},[a("span",{className:"item-expand"},"▶"),a("span",{className:"item-name"},o.productName),$,a("span",{className:"item-unit"},o.unit),a("input",{type:"number",className:"item-rate-input"+(Q?" changed":""),dataset:{productId:o.productId,productName:o.productName,currentRate:w,quantity:o.totalQty||0,notProcuredToday:o.rate===void 0?"true":""},placeholder:"₹0",value:Q,step:"0.01",min:"0",onclick:b=>b.stopPropagation(),onchange:b=>ne(b.target),oninput:b=>oe(b.target)})]),a("div",{className:"item-details"},q)]);c.appendChild(Y)}),t.appendChild(c)}else(T||v)&&(t.innerHTML='<div class="empty-list-msg">No matching items</div>');if(s.length>0){const c=document.createDocumentFragment();let i="";s.forEach(o=>{o.category!==i&&(i=o.category,c.appendChild(a("div",{className:"category-divider"},i)));const E=a("div",{className:"procurement-item procured-item",dataset:{productId:o.productId}},[a("div",{className:"item-main",onclick:w=>z(w.currentTarget)},[a("span",{className:"item-expand"},"▶"),a("span",{className:"item-name"},"✓ "+o.productName),a("span",{className:"qty-simple"},String(o.procuredQty||0)),a("span",{className:"item-unit"},o.unit),a("span",{className:"procured-rate"},`₹${o.rate}`)]),a("div",{className:"item-details"},[a("div",{className:"detail-row"},[a("span",{className:"detail-label"},"Procured At"),a("span",{className:"detail-value"},new Date(o.procuredAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}))]),a("div",{className:"detail-row"},[a("span",{className:"detail-label"},"Total Orders"),a("span",{className:"detail-value"},o.totalOrders||0)]),a("div",{className:"detail-row"},[a("span",{className:"detail-label"},"Total Value"),a("span",{className:"detail-value highlight"},F(o.procuredQty*o.rate))]),a("div",{className:"detail-actions"},[a("button",{className:"btn-undo",onclick:w=>{w.stopPropagation(),se(o.productId,o.productName)}},"Undo")])])]);c.appendChild(E)}),n.appendChild(c)}}function z(e){e.closest(".procurement-item").classList.toggle("expanded")}function oe(e){const t=parseFloat(e.dataset.currentRate),n=parseFloat(e.value),r=e.dataset.notProcuredToday==="true";e.classList.toggle("changed",e.value&&(n!==t||r))}function ne(e){const t=e.dataset.productId,n=e.dataset.productName,r=parseFloat(e.dataset.currentRate),l=parseFloat(e.dataset.quantity)||0,u=parseFloat(e.value),d=e.dataset.notProcuredToday==="true";e.value&&(u!==r||d)&&u>0?(C[t]={product:t,productName:n,rate:u,previousRate:r,quantity:l},e.classList.add("changed")):(delete C[t],e.classList.remove("changed")),h&&h.classList.toggle("show",Object.keys(C).length>0)}async function se(e,t){if(!confirm(`Remove ${t} from procured list?`))return;const r=document.querySelector(`[data-product-id="${CSS.escape(e)}"]`)?.querySelector(".btn-undo");r&&(r.disabled=!0,r.classList.add("btn-loading"));try{const l=await x.ensureCsrfToken(),u={"Content-Type":"application/json"};l&&(u["X-CSRF-Token"]=l);const d=await fetch(`/api/supplier/procure/${encodeURIComponent(e)}`,{method:"DELETE",credentials:"include",headers:u});if(!d.ok){const m=await d.json();P(m.message||"Could not undo","error");return}P(`${t} moved back to TO PROCURE`,"success"),k()}catch(l){console.error("Error undoing procurement:",l),P("Could not undo","error"),r&&(r.disabled=!1,r.classList.remove("btn-loading"))}}function ce(){const e=s=>typeof s!="string"?String(s):s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),t=s=>s.filter(p=>{const c=!T||p.productName.toLowerCase().includes(T),i=!v||p.category===v;return c&&i}),n=t(f.toProcure),r=t(f.procured);let l="",u="";n.forEach(s=>{s.category!==u&&(u=s.category,l+=`<div class="category-header">${e(u)}</div>`);const p=s.wasProcured?`${s.procuredQty||0} + ${s.newQty||0}`:`${s.totalQty||0}`;l+=`
            <div class="procurement-item">
                <span class="item-name">${e(s.productName)}</span>
                <span class="qty-breakdown">${p}</span>
                <span class="item-unit">${e(s.unit)}</span>
                <span class="current-rate">₹${(s.currentRate||0).toFixed(0)}</span>
            </div>`});let d="";u="",r.forEach(s=>{s.category!==u&&(u=s.category,d+=`<div class="category-header">${e(u)}</div>`),d+=`
            <div class="procurement-item procured-item">
                <span class="item-name">${e(s.productName)}</span>
                <span class="qty-breakdown">${s.procuredQty||0}</span>
                <span class="item-unit">${e(s.unit)}</span>
                <span class="procured-rate">₹${s.rate}</span>
            </div>`});const m=window.open("","_blank");if(!m){P("Popup blocked. Please allow popups for this site.","error");return}m.document.write(`
        <html>
        <head>
            <title>Purchase List - Pratibha Marketing</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { font-size: 18px; margin-bottom: 10px; }
                h2 { font-size: 14px; margin-top: 20px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                .date { color: #666; margin-bottom: 20px; }
                .category-header { font-weight: bold; color: #666; margin: 15px 0 5px; font-size: 12px; text-transform: uppercase; }
                .procurement-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
                .item-name { font-weight: bold; flex: 1; }
                .qty-breakdown { font-family: monospace; min-width: 100px; }
                .item-unit { color: #666; min-width: 50px; }
                .current-rate { color: #666; min-width: 60px; text-align: right; }
                .procured-rate { color: #5d7a5f; font-weight: bold; min-width: 60px; text-align: right; }
                .procured-item .item-name::before { content: '✓ '; color: #5d7a5f; }
                .empty-msg { color: #999; font-style: italic; padding: 10px 0; }
            </style>
        </head>
        <body>
            <h1>Purchase List - Pratibha Marketing</h1>
            <div class="date">${new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>
            <h2>TO PROCURE (${n.length} items)</h2>
            ${l||'<div class="empty-msg">No items to procure</div>'}
            <h2>PROCURED (${r.length} items)</h2>
            ${d||'<div class="empty-msg">No procured items</div>'}
        </body>
        </html>
    `),m.document.close(),m.print()}function ie(){const e=[...f.toProcure,...f.procured],t=s=>`"${String(s).replace(/"/g,'""')}"`,n=["Category","Product","Unit","Procured Qty","New Qty","Total Qty","Rate","Status"],r=e.map(s=>{const p=f.procured.find(i=>i.productId===s.productId)?"Procured":"To Procure",c=s.rate||s.currentRate||0;return[t(s.category),t(s.productName),t(s.unit),s.procuredQty||0,s.newQty||0,s.totalQty||s.procuredQty||0,c,p].join(",")}),l=[n.join(","),...r].join(`
`),u=new Blob([l],{type:"text/csv"}),d=window.URL.createObjectURL(u),m=document.createElement("a");m.href=d,m.download=`purchase-list-${new Date().toISOString().split("T")[0]}.csv`,m.click(),window.URL.revokeObjectURL(d)}async function le(){if(!h)return;h.textContent="Saving...",h.disabled=!0;const e=[],t=[],n={"Content-Type":"application/json"};let r=await x.ensureCsrfToken();r&&(n["X-CSRF-Token"]=r);const l=Object.entries(C),u=5;for(let d=0;d<l.length;d+=u){const m=l.slice(d,d+u);(await Promise.all(m.map(async([p,c])=>{try{let i=await fetch("/api/supplier/procure",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({productId:c.product,rate:c.rate,quantity:c.quantity||0})});if(i.status===403){const o=await i.json().catch(()=>({}));if(o.message?.toLowerCase().includes("csrf"))r=await x.refreshCsrfToken(),r&&(n["X-CSRF-Token"]=r,i=await fetch("/api/supplier/procure",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({productId:c.product,rate:c.rate,quantity:c.quantity||0})}));else return{productId:p,success:!1,productName:c.productName||p,error:o.message||`HTTP ${i.status}`}}if(i.ok)return{productId:p,success:!0};{const o=await i.json().catch(()=>({}));return{productId:p,success:!1,productName:c.productName||p,error:o.message||`HTTP ${i.status}`}}}catch(i){return console.error("Error saving rate:",i),{productId:p,success:!1,productName:c.productName||p,error:i.message||"Network error"}}}))).forEach(p=>{p.success?t.push(p.productId):e.push({productName:p.productName,error:p.error})})}for(const d of t)delete C[d];h.textContent="Save",h.disabled=!1,e.length>0?(P(`${e.length} rate(s) not saved. Try again.`,"info"),Object.keys(C).length>0?h.classList.add("show"):h.classList.remove("show")):(h.classList.remove("show"),document.querySelectorAll(".item-rate-input").forEach(d=>{d.value="",d.classList.remove("changed")}),P("Items marked as procured!","success")),k()}async function de(){const e=await x.requireAuth(["staff"]);if(!e)return;const t=document.getElementById("userBadge");t&&(t.textContent=e.name||e.email||"User"),k()}de();
