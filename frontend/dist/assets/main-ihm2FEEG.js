import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css                */import{f as T}from"./utils-DKdRYW2s.js";import{c as r,s as E}from"./ui-DPXrEiII.js";import"./api-BVpkjr3r.js";import{i as ae}from"./init-10IUnAVO.js";const X=(e=0)=>new Promise((t,n)=>{window.Auth?t(window.Auth):e>500?n(new Error("Auth module failed to load")):setTimeout(()=>X(e+1).then(t).catch(n),10)});let R;try{R=await X()}catch(e){console.error("Auth initialization failed:",e),window.location.href="/pages/auth/login.html"}ae();let J=[],y={toProcure:[],procured:[],categories:[]},L="",C="";const x={};let B={},h=null,S=null,w=null,N=null,U=!1,q=!1;function ne(){N=new Audio("/assets/sounds/notification.wav"),N.preload="auto",N.volume=.5}window.addEventListener("beforeunload",()=>{h&&(clearInterval(h),h=null),w&&(w.close().catch(()=>{}),w=null),N&&(N=null)});document.addEventListener("visibilitychange",()=>{document.hidden?h&&(clearInterval(h),h=null):h||ee()});function re(){if(U){if(N){N.currentTime=0,N.play().catch(()=>{V()});return}V()}}function V(){try{w||(w=new(window.AudioContext||window.webkitAudioContext)),w.state==="suspended"&&w.resume();const e=w.createOscillator(),t=w.createOscillator(),n=w.createGain();e.connect(n),t.connect(n),n.connect(w.destination),e.frequency.value=880,e.type="sine",t.frequency.value=1108.73,t.type="sine";const a=w.currentTime;n.gain.setValueAtTime(0,a),n.gain.linearRampToValueAtTime(.3,a+.05),n.gain.linearRampToValueAtTime(.2,a+.15),n.gain.linearRampToValueAtTime(.3,a+.2),n.gain.linearRampToValueAtTime(0,a+.35),e.start(a),t.start(a),e.stop(a+.35),t.stop(a+.35)}catch(e){console.log("Could not play notification sound:",e)}}const z=document.getElementById("printBtn"),Z=document.getElementById("exportBtn"),b=document.getElementById("saveRatesBtn"),_=document.getElementById("purchaseSearch"),k=document.getElementById("newOrderBadge"),Q=document.getElementById("procuredHeader");z&&z.addEventListener("click",ce);Z&&Z.addEventListener("click",le);b&&b.addEventListener("click",ie);_&&_.addEventListener("input",e=>{L=e.target.value.trim().toLowerCase(),D()});const W=document.getElementById("categoryPills");W&&W.addEventListener("click",e=>{const t=e.target.closest(".category-pill");t&&(document.querySelectorAll(".category-pill").forEach(n=>n.classList.remove("active")),t.classList.add("active"),C=t.dataset.category,D())});function se(e){const t=document.getElementById("categoryPills");if(!t)return;t.innerHTML='<button class="category-pill active" data-category="">All</button>';const n={"Indian Vegetables":"Vegetables","Exotic Vegetables":"Exotic",Fruits:"Fruits",Frozen:"Frozen",Dairy:"Dairy"};if(e.forEach(a=>{const l=r("button",{className:"category-pill"+(C===a?" active":""),dataset:{category:a}},n[a]||a);t.appendChild(l)}),C){const a=t.querySelector(`[data-category="${C}"]`);a?(t.querySelector(".active")?.classList.remove("active"),a.classList.add("active")):C=""}}Q&&Q.addEventListener("click",()=>{Q.classList.toggle("collapsed")});function G(){if(!U)try{w=new(window.AudioContext||window.webkitAudioContext),ne(),U=!0}catch(e){console.log("Could not initialize audio:",e)}}document.addEventListener("click",G,{once:!0});document.addEventListener("touchstart",G,{once:!0});async function A(){try{const[e,t,n,a]=await Promise.all([fetch("/api/orders",{credentials:"include"}),fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/supplier/procurement-summary",{credentials:"include"})]);if([e,t,n,a].some(g=>g.status===401)){window.location.href="/pages/auth/login.html";return}if(!e.ok||!t.ok||!n.ok||!a.ok){const g={orders:e.status,products:t.status,rates:n.status,procurement:a.status};console.error("Dashboard API failures:",g);const P=e.ok?t.ok?n.ok?"procurement":"rates":"products":"orders";throw new Error(`Failed to load ${P} data (status: ${g[P]})`)}const i=await e.json(),u=await n.json(),m=await a.json();J=u.data||[],y={toProcure:m.toProcure||[],procured:m.procured||[],categories:m.categories||[]},se(y.categories),Y(y),K(y);const c=i.data||[],d=c.filter(g=>g.status==="delivered"||g.paymentStatus==="paid").reduce((g,P)=>g+(P.totalAmount||0),0),p=d*.15,o=document.getElementById("totalSale"),f=document.getElementById("totalProfit");o&&(o.textContent=T(d)),f&&(f.textContent=T(p)),D(),ue(c),ee()}catch(e){console.error("Error loading dashboard stats:",e);const t=document.getElementById("totalSale"),n=document.getElementById("totalProfit"),a=document.getElementById("toProcureList");t&&(t.textContent="—"),n&&(n.textContent="—"),a&&(a.innerHTML="",a.appendChild(r("div",{className:"empty-state"},[r("p",{},"Data not available"),r("button",{id:"retryBtn",className:"btn-retry",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:A},"Try Again")])))}}function K(e){B={},[...e.toProcure,...e.procured].forEach(t=>{B[t.productId]=t.totalQty})}function Y(e){if(Object.keys(B).length===0)return;let t=0;[...e.toProcure,...e.procured].forEach(a=>{const l=B[a.productId]||0;a.totalQty>l&&t++}),t>0&&(re(),k&&(k.textContent=`${t} new`,k.classList.remove("hidden"),S&&clearTimeout(S),S=setTimeout(()=>{k&&k.classList.add("hidden"),S=null},3e4)),E(`${t} product(s) have new orders!`,"info"))}function ee(){h&&clearInterval(h),h=setInterval(async()=>{if(!q){q=!0;try{if(!document.getElementById("toProcureList")){clearInterval(h),h=null;return}const e=await fetch("/api/supplier/procurement-summary",{credentials:"include"});if(e.status===401){clearInterval(h),h=null,window.location.href="/pages/auth/login.html";return}if(!e.ok){console.warn("Polling failed:",e.status);return}const t=await e.json();if(e.ok){const n={toProcure:t.toProcure||[],procured:t.procured||[],categories:t.categories||[]};Y(n),y=n,K(y),D(!0)}}catch(e){console.error("Polling error:",e)}finally{q=!1}}},3e4)}function D(e=!1){const t=document.getElementById("toProcureList"),n=document.getElementById("procuredList"),a=document.getElementById("procurementEmpty"),l=document.getElementById("procuredCount");if(!t||!n){console.error("Purchase List: Required DOM elements missing (toProcureList or procuredList). Check index.html structure.");const s=document.querySelector(".procurement-container");if(s&&!s.querySelector(".procurement-error")){const o=document.createElement("div");o.className="procurement-error",o.style.cssText="padding:1.5rem;text-align:center;color:var(--error);font-size:0.875rem;",o.textContent="Purchase list failed to load. Please refresh the page.",s.appendChild(o)}return}const i={};e&&document.querySelectorAll(".item-rate-input").forEach(s=>{s.value&&(i[s.dataset.productId]=s.value)}),t.innerHTML="",n.innerHTML="";const u=s=>s.filter(p=>{const o=!L||p.productName.toLowerCase().includes(L),f=!C||p.category===C;return o&&f}),m=u(y.toProcure),c=u(y.procured);l&&(l.textContent=c.length),m.length===0&&y.toProcure.length===0?(a&&a.classList.remove("hidden"),t.innerHTML='<div class="empty-list-msg">No items to procure</div>'):a&&a.classList.add("hidden");const d={};if(J.forEach(s=>{d[s.product]=s}),m.length>0){const s=document.createDocumentFragment();s.appendChild(r("div",{className:"procurement-column-header"},[r("span",{className:"col-expand"}),r("span",{className:"col-name"},"Product"),r("span",{className:"col-qty"},"Qty"),r("span",{className:"col-input"},"Rate")]));let p="";m.forEach(o=>{o.category!==p&&(p=o.category,s.appendChild(r("div",{className:"category-divider"},p)));const f=d[o.productId],g=o.currentRate||f?.rate||0,P=i[o.productId]||"",te=g===0?" unsaved":"";let O;o.wasProcured?O=r("span",{className:"qty-breakdown"},[r("span",{className:"procured-qty"},String(o.procuredQty||0)),r("span",{className:"separator"},"+"),r("span",{className:"new-qty highlight-new"},String(o.newQty||0))]):O=r("span",{className:"qty-simple"},String(o.totalQty||0));const $=[r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Orders"),r("span",{className:"detail-value"},o.totalOrders||0)])];o.wasProcured&&o.lastRate&&$.unshift(r("div",{className:"detail-row highlight-info"},[r("span",{className:"detail-label"},"Last Rate"),r("span",{className:"detail-value"},`₹${o.lastRate}/${o.unit}`)])),$.push(r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Est. Cost"),r("span",{className:"detail-value highlight"},o.totalQty>0&&g>0?T(o.totalQty*g):"—")]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Trend"),r("span",{className:"detail-value"},o.trend==="up"?"↑ Up":o.trend==="down"?"↓ Down":"— Stable")]));const oe=r("div",{className:`procurement-item${te}${o.wasProcured?" was-procured":""}`,dataset:{productId:o.productId}},[r("div",{className:"item-main",onclick:I=>window.toggleExpand(I.currentTarget)},[r("span",{className:"item-expand"},"▶"),r("span",{className:"item-name"},o.productName),O,r("span",{className:"item-unit"},o.unit),r("input",{type:"number",className:"item-rate-input"+(P?" changed":""),dataset:{productId:o.productId,productName:o.productName,currentRate:g,quantity:o.totalQty||0,notProcuredToday:o.rate===void 0?"true":""},placeholder:"₹0",value:P,step:"0.01",min:"0",onclick:I=>I.stopPropagation(),onchange:I=>window.handleRateChange(I.target),oninput:I=>window.handleRateInput(I.target)})]),r("div",{className:"item-details"},$)]);s.appendChild(oe)}),t.appendChild(s)}else(L||C)&&(t.innerHTML='<div class="empty-list-msg">No matching items</div>');if(c.length>0){const s=document.createDocumentFragment();let p="";c.forEach(o=>{o.category!==p&&(p=o.category,s.appendChild(r("div",{className:"category-divider"},p)));const f=r("div",{className:"procurement-item procured-item",dataset:{productId:o.productId}},[r("div",{className:"item-main",onclick:g=>window.toggleExpand(g.currentTarget)},[r("span",{className:"item-expand"},"▶"),r("span",{className:"item-name"},"✓ "+o.productName),r("span",{className:"qty-simple"},String(o.procuredQty||0)),r("span",{className:"item-unit"},o.unit),r("span",{className:"procured-rate"},`₹${o.rate}`)]),r("div",{className:"item-details"},[r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Procured At"),r("span",{className:"detail-value"},new Date(o.procuredAt).toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit",timeZone:"Asia/Kolkata"}))]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Orders"),r("span",{className:"detail-value"},o.totalOrders||0)]),r("div",{className:"detail-row"},[r("span",{className:"detail-label"},"Total Value"),r("span",{className:"detail-value highlight"},T(o.procuredQty*o.rate))]),r("div",{className:"detail-actions"},[r("button",{className:"btn-undo",onclick:g=>{g.stopPropagation(),window.undoProcurement(o.productId,o.productName)}},"Undo")])])]);s.appendChild(f)}),n.appendChild(s)}}window.toggleExpand=function(e){e.closest(".procurement-item").classList.toggle("expanded")};window.handleRateInput=function(e){const t=parseFloat(e.dataset.currentRate),n=parseFloat(e.value),a=e.dataset.notProcuredToday==="true";e.classList.toggle("changed",e.value&&(n!==t||a))};window.handleRateChange=function(e){const t=e.dataset.productId,n=e.dataset.productName,a=parseFloat(e.dataset.currentRate),l=parseFloat(e.dataset.quantity)||0,i=parseFloat(e.value),u=e.dataset.notProcuredToday==="true";e.value&&(i!==a||u)&&i>0?(x[t]={product:t,productName:n,rate:i,previousRate:a,quantity:l},e.classList.add("changed")):(delete x[t],e.classList.remove("changed")),b&&b.classList.toggle("show",Object.keys(x).length>0)};window.undoProcurement=async function(e,t){if(!confirm(`Remove ${t} from procured list?`))return;const n=document.querySelector(`[onclick*="undoProcurement('${e}'"]`)||document.querySelector(`[data-product-id="${e}"] .undo-btn`);n&&(n.disabled=!0,n.classList.add("btn-loading"));try{const a=await R.ensureCsrfToken(),l={"Content-Type":"application/json"};a&&(l["X-CSRF-Token"]=a);const i=await fetch(`/api/supplier/procure/${e}`,{method:"DELETE",credentials:"include",headers:l});if(!i.ok){const u=await i.json();E(u.message||"Could not undo","error");return}E(`${t} moved back to TO PROCURE`,"success"),A()}catch(a){console.error("Error undoing procurement:",a),E("Could not undo","error"),n&&(n.disabled=!1,n.classList.remove("btn-loading"))}};function ce(){const e=c=>typeof c!="string"?String(c):c.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),t=c=>c.filter(d=>{const s=!L||d.productName.toLowerCase().includes(L),p=!C||d.category===C;return s&&p}),n=t(y.toProcure),a=t(y.procured);let l="",i="";n.forEach(c=>{c.category!==i&&(i=c.category,l+=`<div class="category-header">${e(i)}</div>`);const d=c.wasProcured?`${c.procuredQty||0} + ${c.newQty||0}`:`${c.totalQty||0}`;l+=`
            <div class="procurement-item">
                <span class="item-name">${e(c.productName)}</span>
                <span class="qty-breakdown">${d}</span>
                <span class="item-unit">${e(c.unit)}</span>
                <span class="current-rate">₹${(c.currentRate||0).toFixed(0)}</span>
            </div>`});let u="";i="",a.forEach(c=>{c.category!==i&&(i=c.category,u+=`<div class="category-header">${e(i)}</div>`),u+=`
            <div class="procurement-item procured-item">
                <span class="item-name">${e(c.productName)}</span>
                <span class="qty-breakdown">${c.procuredQty||0}</span>
                <span class="item-unit">${e(c.unit)}</span>
                <span class="procured-rate">₹${c.rate}</span>
            </div>`});const m=window.open("","_blank");if(!m){E("Popup blocked. Please allow popups for this site.","error");return}m.document.write(`
        <html>
        <head>
            <title>Purchase List - Pratibha Marketing</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { font-size: 18px; margin-bottom: 10px; }
                h2 { font-size: 14px; margin-top: 20px; color: #666; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                .date { color: #666; margin-bottom: 20px; }
                .category-header { font-weight: bold; color: #666; margin: 15px 0 5px; font-size: 12px; text-transform: uppercase; }
                .procurement-item { padding: 8px 0; border-bottom: 1px solid #eee; display: flex; gap: 10px; align-items: center; }
                .item-name { font-weight: bold; flex: 1; }
                .qty-breakdown { font-family: monospace; min-width: 100px; }
                .item-unit { color: #666; min-width: 50px; }
                .current-rate { color: #666; min-width: 60px; text-align: right; }
                .procured-rate { color: #5d7a5f; font-weight: bold; min-width: 60px; text-align: right; }
                .procured-item .item-name::before { content: '✓ '; color: #5d7a5f; }
                .empty-msg { color: #999; font-style: italic; padding: 10px 0; }
            </style>
        </head>
        <body>
            <h1>Purchase List - Pratibha Marketing</h1>
            <div class="date">${new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}</div>
            <h2>TO PROCURE (${n.length} items)</h2>
            ${l||'<div class="empty-msg">No items to procure</div>'}
            <h2>PROCURED (${a.length} items)</h2>
            ${u||'<div class="empty-msg">No procured items</div>'}
        </body>
        </html>
    `),m.document.close(),m.print()}function le(){const e=[...y.toProcure,...y.procured],t=["Category","Product","Unit","Procured Qty","New Qty","Total Qty","Rate","Status"],n=e.map(m=>{const c=y.procured.find(s=>s.productId===m.productId)?"Procured":"To Procure",d=m.rate||m.currentRate||0;return[`"${m.category}"`,`"${m.productName}"`,m.unit,m.procuredQty||0,m.newQty||0,m.totalQty||m.procuredQty||0,d,c].join(",")}),a=[t.join(","),...n].join(`
`),l=new Blob([a],{type:"text/csv"}),i=window.URL.createObjectURL(l),u=document.createElement("a");u.href=i,u.download=`purchase-list-${new Date().toISOString().split("T")[0]}.csv`,u.click(),window.URL.revokeObjectURL(i)}async function ie(){if(!b)return;b.textContent="Saving...",b.disabled=!0;const e=[],t=[],n={"Content-Type":"application/json"};let a=await R.ensureCsrfToken();a&&(n["X-CSRF-Token"]=a);const l=Object.entries(x),i=5;for(let u=0;u<l.length;u+=i){const m=l.slice(u,u+i);(await Promise.all(m.map(async([d,s])=>{try{let p=await fetch("/api/supplier/procure",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({productId:s.product,rate:s.rate,quantity:s.quantity||0})});if(p.status===403){const o=await p.json().catch(()=>({}));if(o.message?.toLowerCase().includes("csrf"))a=await R.refreshCsrfToken(),a&&(n["X-CSRF-Token"]=a,p=await fetch("/api/supplier/procure",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({productId:s.product,rate:s.rate,quantity:s.quantity||0})}));else return{productId:d,success:!1,productName:s.productName||d,error:o.message||`HTTP ${p.status}`}}if(p.ok)return{productId:d,success:!0};{const o=await p.json().catch(()=>({}));return{productId:d,success:!1,productName:s.productName||d,error:o.message||`HTTP ${p.status}`}}}catch(p){return console.error("Error saving rate:",p),{productId:d,success:!1,productName:s.productName||d,error:p.message||"Network error"}}}))).forEach(d=>{d.success?t.push(d.productId):e.push({productName:d.productName,error:d.error})})}for(const u of t)delete x[u];b.textContent="Save",b.disabled=!1,e.length>0?(E(`${e.length} rate(s) not saved. Try again.`,"info"),Object.keys(x).length>0?b.classList.add("show"):b.classList.remove("show")):(b.classList.remove("show"),document.querySelectorAll(".item-rate-input").forEach(u=>{u.value="",u.classList.remove("changed")}),E("Items marked as procured!","success")),A()}async function de(){const e=document.getElementById("apiDot"),t=document.getElementById("apiStatus");if(!(!e||!t))try{(await(await fetch("/api/health")).json()).status==="ok"?(e.classList.remove("offline"),t.textContent="API Online"):(e.classList.add("offline"),t.textContent="API Offline")}catch{e.classList.add("offline"),t.textContent="API Offline"}}let j=null,M=null,F=null;const v={olive:"rgb(126, 145, 129)",oliveLight:"rgba(126, 145, 129, 0.2)",gunmetal:"rgb(46, 53, 50)",terracotta:"rgb(196, 167, 125)",success:"rgb(93, 122, 95)",warning:"rgb(184, 154, 90)",error:"rgb(154, 101, 101)",slate:"rgb(199, 206, 219)"};async function ue(e){if(!window.Chart){["orderStatusChart","revenueChart","topProductsChart"].forEach(n=>{const a=document.getElementById(n);if(a&&a.parentElement){const l=document.createElement("div");l.style.cssText="display:flex;align-items:center;justify-content:center;height:100%;color:var(--dusty-olive);font-size:0.85rem;",l.textContent="Charts unavailable",a.parentElement.replaceChild(l,a)}});return}try{const t={pending:0,confirmed:0,delivered:0,cancelled:0};e.forEach(o=>{Object.hasOwn(t,o.status)&&t[o.status]++}),document.getElementById("pendingCount").textContent=t.pending,document.getElementById("processingCount").textContent=t.confirmed,document.getElementById("deliveredCount").textContent=t.delivered;const n=document.getElementById("orderStatusChart");n?(j&&j.destroy(),j=new Chart(n,{type:"doughnut",data:{labels:["Pending","Confirmed","Delivered","Cancelled"],datasets:[{data:[t.pending,t.confirmed,t.delivered,t.cancelled],backgroundColor:[v.warning,v.olive,v.success,v.error],borderWidth:0}]},options:{responsive:!0,maintainAspectRatio:!1,cutout:"60%",plugins:{legend:{display:!1}}}})):console.warn("Order status chart canvas not found");const a=[],l={};for(let o=6;o>=0;o--){const f=new Date;f.setDate(f.getDate()-o);const g=f.toISOString().split("T")[0];a.push(g),l[g]=0}e.forEach(o=>{if(o.status!=="cancelled"){const f=new Date(o.createdAt).toISOString().split("T")[0];Object.hasOwn(l,f)&&(l[f]+=o.totalAmount||0)}});const i=a.map(o=>l[o]),u=i.reduce((o,f)=>o+f,0),m=u/7;document.getElementById("weekTotal").textContent=T(u),document.getElementById("avgDaily").textContent=T(Math.round(m));const c=document.getElementById("revenueChart");c?(M&&M.destroy(),M=new Chart(c,{type:"line",data:{labels:a.map(o=>new Date(o).toLocaleDateString("en-IN",{weekday:"short"})),datasets:[{label:"Revenue",data:i,borderColor:v.olive,backgroundColor:v.oliveLight,fill:!0,tension:.4,pointRadius:4,pointBackgroundColor:v.olive}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{beginAtZero:!0,ticks:{callback:o=>"₹"+o.toLocaleString("en-IN")}}}}})):console.warn("Revenue chart canvas not found");const d={};e.forEach(o=>{o.status!=="cancelled"&&o.products&&o.products.forEach(f=>{const g=f.productName||"Unknown";d[g]=(d[g]||0)+(f.quantity||0)})});const s=Object.entries(d).sort((o,f)=>f[1]-o[1]).slice(0,5),p=document.getElementById("topProductsChart");p?(F&&F.destroy(),F=new Chart(p,{type:"bar",data:{labels:s.map(([o])=>o.length>12?o.slice(0,12)+"...":o),datasets:[{label:"Quantity",data:s.map(([,o])=>o),backgroundColor:[v.olive,v.terracotta,v.gunmetal,v.success,v.warning],borderRadius:4}]},options:{responsive:!0,maintainAspectRatio:!1,indexAxis:"y",plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0}}}})):console.warn("Top products chart canvas not found")}catch(t){console.error("Error loading analytics:",t)}}let H=[];async function pe(){try{const e=await fetch("/api/customers",{credentials:"include"}),t=await e.json();if(e.ok){H=t.data||[];const n=document.getElementById("ledgerCustomer");n.innerHTML="",n.appendChild(r("option",{value:""},"All Customers")),H.forEach(a=>{n.appendChild(r("option",{value:a._id},a.name))})}}catch(e){console.error("Error loading customers:",e)}}window.openLedgerModal=function(){H.length===0&&pe();const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1);document.getElementById("ledgerFromDate").value=t.toISOString().split("T")[0],document.getElementById("ledgerToDate").value=e.toISOString().split("T")[0],document.getElementById("ledgerModal").classList.add("show"),document.body.style.overflow="hidden"};window.closeLedgerModal=function(){document.getElementById("ledgerModal").classList.remove("show"),document.body.style.overflow=""};window.downloadLedger=async function(){const e=document.getElementById("ledgerCustomer").value,t=document.getElementById("ledgerFromDate").value,n=document.getElementById("ledgerToDate").value,a=new URLSearchParams;e&&a.append("customerId",e),t&&a.append("fromDate",t),n&&a.append("toDate",n);const l=document.querySelector('#ledgerModal .btn-download, #ledgerModal button[onclick*="downloadLedger"]');l&&(l.disabled=!0,l.classList.add("btn-loading"));try{E("Downloading ledger...","info");const i=await fetch(`/api/reports/ledger?${a}`,{credentials:"include"});if(!i.ok){const p=await i.json();throw new Error(p.message||"Ledger temporarily unavailable")}const u=await i.blob(),m=window.URL.createObjectURL(u),c=i.headers.get("Content-Disposition");let d="ledger.xlsx";c&&c.includes("filename=")&&(d=c.split("filename=")[1].replace(/"/g,""));const s=document.createElement("a");s.href=m,s.download=d,document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(m),E("Ledger downloaded!","success"),window.closeLedgerModal()}catch(i){console.error("Download ledger error:",i),E(i.message||"Could not download","info")}finally{l&&(l.disabled=!1,l.classList.remove("btn-loading"))}};async function me(){const e=await R.requireAuth(["admin","staff"]);if(!e)return;if(e.role==="staff"){window.location.href="/pages/staff-dashboard/";return}const t=document.getElementById("userBadge");t&&(t.textContent=e.name||e.email||"User",e.role==="admin"&&(t.style.cursor="pointer",t.title="Manage Users",t.onclick=()=>{window.location.href="/pages/users/"})),A(),de()}me();
