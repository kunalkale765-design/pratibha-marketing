import"./responsive-D1ZTW0b0.js";/* empty css               *//* empty css                *//* empty css              */import"./api-CEln0qT5.js";import{t as y}from"./ui-Bs0uH3rR.js";import{r as k}from"./init-BmEs7ovC.js";k();const p=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(p()),10)}),d=await p();d.ensureCsrfToken().catch(e=>console.warn("CSRF pre-fetch failed:",e));const w=document.getElementById("loginForm"),c=document.getElementById("loginBtn"),s=document.getElementById("noticeMessage"),u=document.getElementById("passwordToggle");u&&u.addEventListener("click",()=>{y("password",u)});T();async function T(){try{const e=await fetch("/api/auth/me",{credentials:"include"});e.ok&&((await e.json()).user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/")}catch{}}w&&w.addEventListener("submit",async e=>{e.preventDefault();const r=document.getElementById("email").value.trim(),n=document.getElementById("password").value;if(!r||!n){o("Please enter username and password");return}c.disabled=!0,c.classList.add("btn-loading"),S();try{const t={"Content-Type":"application/json"},i=await d.ensureCsrfToken();i&&(t["X-CSRF-Token"]=i);const a=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:r,password:n})}),l=await a.json();if(a.status===403&&l?.message?.toLowerCase().includes("csrf")){console.log("CSRF error, refreshing token and retrying...");const m=await d.refreshCsrfToken();if(m){t["X-CSRF-Token"]=m;const g=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:r,password:n})}),f=await g.json();if(g.ok){localStorage.setItem("user",JSON.stringify(f.user)),f.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/";return}o(f.message||"Please check your credentials");return}}a.ok?(localStorage.setItem("user",JSON.stringify(l.user)),l.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/"):o(l.message||"Please check your credentials")}catch(t){console.error("Login error:",t),navigator.onLine?t.name==="TypeError"||t.message.includes("fetch")?o("Connection issue. Please try again."):o("Something went wrong. Try again."):o("No internet connection")}finally{c&&(c.disabled=!1,c.classList.remove("btn-loading"))}});function o(e){s&&(s.textContent=e,s.classList.add("show"))}function S(){s&&s.classList.remove("show")}const h=document.getElementById("forgotPasswordLink");h&&h.addEventListener("click",async e=>{e.preventDefault();const r=document.getElementById("email").value.trim();if(!r){o("Please enter your username first");return}try{const n={"Content-Type":"application/json"},t=await d.ensureCsrfToken();t&&(n["X-CSRF-Token"]=t);const i=await fetch("/api/auth/forgot-password",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({email:r})}),a=await i.json();i.ok&&a.resetUrl?(s.innerHTML=`Reset link generated! <a href="${a.resetUrl}" style="color: var(--dusty-olive); text-decoration: underline;">Click here to reset</a>`,s.classList.add("show"),s.classList.remove("error")):o(a.message||"If an account exists, a reset link has been generated")}catch(n){console.error("Forgot password error:",n),o("Could not process request. Try again.")}});
