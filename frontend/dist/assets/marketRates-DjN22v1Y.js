import{s as p,c as o}from"./ui-Usu6AxiT.js";/* empty css             *//* empty css               *//* empty css                */import"./api-BESsD5Cs.js";const b=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(b()),10)}),v=await b();let w=[],C={},g={},h=null;async function T(){await v.requireAuth(["admin","staff"])&&(document.getElementById("dateBar").textContent=new Date().toLocaleDateString("en-IN",{weekday:"long",year:"numeric",month:"long",day:"numeric"}),await N(),await I())}async function N(){try{const[e,t]=await Promise.all([fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"})]),s=await e.json(),i=await t.json();w=(s.data||[]).filter(r=>r.isActive),(i.data||[]).forEach(r=>{const c=typeof r.product=="object"?r.product._id:r.product;C[c]=r.rate}),x()}catch(e){console.error(e);const t=document.getElementById("productList"),s=navigator.onLine?"Data not available":"No internet connection";t.innerHTML="",t.appendChild(o("div",{className:"loading"},[o("p",{},s),o("button",{id:"retryDataBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:N},"Try Again")]))}}function x(){const e=document.getElementById("productList");if(e.innerHTML="",!w.length){e.appendChild(o("div",{className:"loading"},"No products found"));return}const t={};w.forEach(r=>{const c=r.category||"other";t[c]||(t[c]=[]),t[c].push(r)});const s=document.createDocumentFragment();let i=0;for(const[r,c]of Object.entries(t)){const m=r.replace(/-/g," ").replace(/\b\w/g,d=>d.toUpperCase());s.appendChild(o("div",{className:"category-header"},m)),c.forEach(d=>{const l=C[d._id]||0,a=o("div",{className:"product-item card-animated card-fade-in",style:{animationDelay:`${i*.03}s`}},[o("div",{className:"product-info"},[o("div",{className:"product-name"},d.name),o("div",{className:"product-unit"},`per ${d.unit}`)]),o("input",{type:"number",className:"rate-input input-animated",id:`rate-${d._id}`,dataset:{id:d._id,original:String(l)},value:String(l),min:"0",step:"0.01",onfocus:n=>window.clearZero(n.target),onblur:n=>window.restoreValue(n.target),onchange:n=>window.handleChange(n.target),oninput:n=>window.handleInput(n.target)})]);s.appendChild(a),i++})}e.appendChild(s)}function L(e){e.dataset.prevValue=e.value,e.value="",e.select()}function F(e){e.value===""&&(e.value=e.dataset.prevValue||e.dataset.original),D(e)}function k(e){const t=parseFloat(e.dataset.original),s=parseFloat(e.value);e.classList.toggle("changed",s!==t)}function D(e){const t=e.dataset.id,s=parseFloat(e.dataset.original),i=parseFloat(e.value);i!==s&&i>0?(g[t]=i,e.classList.add("changed")):(delete g[t],e.classList.remove("changed")),S()}function S(){const e=Object.keys(g).length;document.getElementById("changesCount").textContent=e,document.getElementById("saveBtn").disabled=e===0}async function E(){const e=document.getElementById("saveBtn"),t=[];for(const[a,n]of Object.entries(g))if(isNaN(n)||n<0){const u=w.find(f=>f._id===a);t.push(u?.name||a)}if(t.length>0){p(`${t.slice(0,2).join(", ")}: rates must be 0 or higher`,"info");return}e.disabled=!0,e.classList.add("btn-loading");let s=0,i=0,r=null;const c=[],m={"Content-Type":"application/json"};let d=await v.ensureCsrfToken();d&&(m["X-CSRF-Token"]=d);for(const[a,n]of Object.entries(g))try{let u=await fetch("/api/market-rates",{method:"POST",headers:m,credentials:"include",body:JSON.stringify({product:a,rate:n,effectiveDate:new Date().toISOString()})});if(u.status===403&&(await u.json().catch(()=>({}))).message?.toLowerCase().includes("csrf")&&(d=await v.refreshCsrfToken(),d&&(m["X-CSRF-Token"]=d,u=await fetch("/api/market-rates",{method:"POST",headers:m,credentials:"include",body:JSON.stringify({product:a,rate:n,effectiveDate:new Date().toISOString()})}))),u.ok){s++;const f=document.getElementById("rate-"+a);f&&(f.dataset.original=n,f.classList.remove("changed")),C[a]=n}else{i++;const y=(await u.json().catch(()=>({}))).message||`HTTP ${u.status}`;console.error("Failed to save rate for product:",a,y),r||(r=y),c.push(a)}}catch(u){i++,console.error("Failed to save rate for product:",a,u.message),r||(r=u.message||"Network error"),c.push(a)}const l={};Object.keys(g).forEach(a=>{c.includes(a)&&(l[a]=g[a])}),g=l,S(),e.classList.remove("btn-loading"),s>0&&(e.classList.add("btn-success"),setTimeout(()=>e.classList.remove("btn-success"),1500),p(`${s} rate(s) saved`,"success")),i>0&&p(`${i} rate(s) not saved`,"info")}async function I(){const e=document.getElementById("historyContent"),t=document.getElementById("historyCategory"),s=t.value;e.innerHTML="",e.appendChild(o("div",{className:"history-loading"},"Loading history..."));try{const i=`/api/market-rates/history-summary?days=7${s!=="all"?`&category=${encodeURIComponent(s)}`:""}`,r=await fetch(i,{credentials:"include"});if(!r.ok)throw new Error("History temporarily unavailable");const c=await r.json();h=c,t.options.length<=1&&c.categories&&c.categories.forEach(m=>{const d=m.replace(/-/g," ").replace(/\b\w/g,l=>l.toUpperCase());t.appendChild(o("option",{value:m},d))}),P(c)}catch(i){console.error("Failed to load history:",i),e.innerHTML="",e.appendChild(o("div",{className:"history-loading"},"History not available"))}}function P(e){const t=document.getElementById("historyContent");if(t.innerHTML="",!e.data||e.data.length===0||!e.data[0]?.rates?.length){t.appendChild(o("div",{className:"history-loading"},"No history data available"));return}const i=e.data[0].rates.map(l=>l.date).map(l=>{const a=new Date(l),n=a.toLocaleDateString("en-IN",{weekday:"short"}),u=a.toLocaleDateString("en-IN",{day:"numeric",month:"short"});return o("th",{className:"date-header"},[u,o("span",{className:"date-day"},n)])}),r=o("tr",{},[o("th",{},"Product"),...i]),c=l=>o("td",{},[l.name,o("br"),o("small",{style:{color:"var(--text-muted)",fontWeight:"400"}},`per ${l.unit}`)]),m=o("tbody");e.data.forEach(l=>{const a=o("tr");a.appendChild(c(l)),l.rates.forEach(n=>{if(n.rate===null)a.appendChild(o("td",{className:"rate-cell rate-null"},"-"));else{const u=n.trend||"stable",f=n.trend==="up"?"↑":n.trend==="down"?"↓":"",y=[n.rate.toFixed(2)];f&&y.push(o("span",{className:"trend-indicator"},f)),a.appendChild(o("td",{className:`rate-cell ${u}`},y))}}),m.appendChild(a)});const d=o("table",{className:"history-table"},[o("thead",{},[r]),m]);t.appendChild(d)}function $(){if(!h||!h.data||h.data.length===0||!h.data[0]?.rates?.length){p("No data available to export","info");return}try{const{jsPDF:e}=window.jspdf,t=new e({orientation:"landscape",unit:"mm",format:"a4"});t.setFontSize(18),t.setTextColor(46,53,50),t.text("Pratibha Marketing - 7-Day Market Rate History",14,20),t.setFontSize(10),t.setTextColor(138,145,140);const s=document.getElementById("historyCategory"),i=s.value==="all"?"All Categories":s.options[s.selectedIndex].text;t.text(`${h.startDate} to ${h.endDate} | ${i}`,14,27);const c=[["Product","Unit",...h.data[0].rates.map(a=>new Date(a.date).toLocaleDateString("en-IN",{day:"numeric",month:"short"}))]],m=h.data.map(a=>{const n=a.rates.map(u=>u.rate!==null?u.rate.toFixed(2):"-");return[a.name,a.unit,...n]});t.autoTable({startY:32,head:c,body:m,theme:"grid",headStyles:{fillColor:[46,53,50],textColor:[255,255,255],fontSize:8,fontStyle:"bold"},bodyStyles:{fontSize:8,textColor:[31,36,33]},columnStyles:{0:{fontStyle:"bold",cellWidth:40},1:{cellWidth:20}},alternateRowStyles:{fillColor:[249,247,243]},margin:{left:14,right:14}});const d=t.internal.getNumberOfPages();for(let a=1;a<=d;a++)t.setPage(a),t.setFontSize(8),t.setTextColor(138,145,140),t.text(`Generated on ${new Date().toLocaleString("en-IN")} | Page ${a} of ${d}`,14,t.internal.pageSize.height-10);const l=`market-rates-${h.startDate}-to-${h.endDate}.pdf`;t.save(l),p("PDF exported successfully","success")}catch(e){console.error("PDF export failed:",e),p("Could not export PDF","info")}}window.clearZero=L;window.restoreValue=F;window.handleChange=D;window.handleInput=k;window.saveRates=E;window.loadHistory=I;window.exportToPDF=$;T();
