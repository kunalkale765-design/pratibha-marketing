import"./responsive-D1ZTW0b0.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import{s as l,c as o}from"./ui-D1Am529b.js";import"./api-BqPqbFNt.js";const se=()=>new Promise(t=>{window.Auth?t(window.Auth):setTimeout(()=>t(se()),10)}),T=await se();let _=[];const K={};let ce=[],y=[],G="all",F=null,E=null,h=null,B={},I={},q=!1,ie=!1,w=null,L=[];async function me(){if(h=await T.requireAuth(),!!h){if(h.role==="customer"){const t=document.getElementById("modalFooter");t&&(t.style.display="none")}ge(),await Promise.all([D(),fe(),ve()]),we(),be(),pe()}}function pe(){const t=new URLSearchParams(window.location.search),e=t.get("order"),n=t.get("action");e&&(window.history.replaceState({},"",window.location.pathname),n==="pack"?le(e):Q(e))}function ge(){if(ie)return;ie=!0;const t=document.getElementById("ordersList");if(!t)return;document.addEventListener("click",c=>{c.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(r=>{r.classList.remove("swiped","swiped-single")})});let e={startX:0,isDragging:!1,currentItem:null};t.addEventListener("touchstart",c=>{const r=c.target.closest(".swipe-item");r&&(e={startX:c.touches[0].clientX,isDragging:!0,currentItem:r},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i!==r&&i.classList.remove("swiped","swiped-single")}))},{passive:!0}),t.addEventListener("touchmove",c=>{if(!e.isDragging||!e.currentItem)return;const r=e.startX-c.touches[0].clientX,i=e.currentItem.querySelectorAll(".swipe-action").length;r>50?(e.currentItem.classList.remove("swiped-single","swiped"),i===1?e.currentItem.classList.add("swiped-single"):e.currentItem.classList.add("swiped")):r<-20&&e.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),t.addEventListener("touchend",()=>{e.isDragging=!1,e.currentItem=null},{passive:!0});let n={startX:0,isDragging:!1,currentItem:null};t.addEventListener("mousedown",c=>{const r=c.target.closest(".swipe-item");r&&(c.target.closest("button")||(n={startX:c.clientX,isDragging:!0,currentItem:r},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(i=>{i!==r&&i.classList.remove("swiped","swiped-single")})))}),t.addEventListener("mousemove",c=>{if(!n.isDragging||!n.currentItem)return;const r=n.startX-c.clientX,i=n.currentItem.querySelectorAll(".swipe-action").length;r>50?(n.currentItem.classList.remove("swiped-single","swiped"),i===1?n.currentItem.classList.add("swiped-single"):n.currentItem.classList.add("swiped")):r<-20&&n.currentItem.classList.remove("swiped","swiped-single")}),t.addEventListener("mouseup",()=>{n.isDragging=!1,n.currentItem=null}),t.addEventListener("mouseleave",()=>{n.isDragging=!1,n.currentItem=null});const a=document.getElementById("orderModal");a&&(a.onclick=c=>{c.target.id==="orderModal"&&H()});const s=document.getElementById("invoiceModal");s&&(s.onclick=c=>{c.target.id==="invoiceModal"&&te()})}async function fe(){try{const t=await fetch("/api/market-rates",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);((await t.json()).data||[]).forEach(n=>{const a=typeof n.product=="object"?n.product._id:n.product;K[a]=n.rate})}catch(t){console.error("Failed to load market rates:",t)}}async function ve(){try{const t=await fetch("/api/products",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);ce=((await t.json()).data||[]).filter(n=>n.isActive!==!1)}catch(t){console.error("Failed to load products:",t)}}async function D(){try{const t=await fetch("/api/orders?limit=100",{credentials:"include"});if(!t.ok)throw new Error(`Server returned ${t.status}`);const e=await t.json();if(!e.success)throw new Error(e.message||"Orders temporarily unavailable");_=e.data||[];const n=_.filter(a=>!a._id||!/^[a-f\d]{24}$/i.test(a._id));n.length>0&&console.warn("Orders with invalid IDs:",n.map(a=>({orderNumber:a.orderNumber,_id:a._id}))),W()}catch(t){if(console.error("Failed to load orders:",t),!_||_.length===0){const e=document.getElementById("ordersList"),n=navigator.onLine?"Orders not available":"No internet connection";e.innerHTML="",e.appendChild(o("div",{className:"empty-state"},[o("p",{},n),o("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:D},"Try Again")]))}}}function ye(t){if(!t)return"?";const e=t.trim().split(/\s+/);return e.length===1?e[0].substring(0,2).toUpperCase():(e[0][0]+e[e.length-1][0]).toUpperCase()}function W(){const t=document.getElementById("ordersList");if(!t)return;const e=document.getElementById("searchInput"),n=e?e.value.toLowerCase():"",a=h?.role==="admin",s=h?.role==="admin"||h?.role==="staff";let c=_.filter(i=>i._id&&/^[a-f\d]{24}$/i.test(i._id));if(G==="all"?c=c.filter(i=>i.status!=="cancelled"):c=c.filter(i=>i.status===G),n&&(c=c.filter(i=>i.orderNumber?.toLowerCase().includes(n)||i.customer?.name?.toLowerCase().includes(n))),!c.length){t.innerHTML="",t.appendChild(o("div",{className:"empty-state"},"No orders found"));return}t.innerHTML="";const r=document.createDocumentFragment();c.forEach((i,g)=>{let m=null;i.batch?.batchType&&(m=o("span",{className:"badge badge-batch"},[i.batch.batchType,i.batchLocked?" ðŸ”’":""]));let f=null;s&&i.status==="confirmed"&&(i.packingDone?f=o("span",{className:"packing-status-badge status-packed"},"âœ“ Packed"):f=o("span",{className:"packing-status-badge status-ready"},"Ready"));const u=o("div",{className:"swipe-content",onclick:()=>window.viewOrder(i._id)},[o("div",{className:"order-avatar"},ye(i.customer?.name)),o("div",{className:"order-info"},[o("div",{className:"order-customer"},i.customer?.name||"Unknown"),i.notes?o("div",{className:"order-notes"},i.notes):null,o("div",{className:"order-meta-row"},[o("span",{className:"order-number"},`Order #${i.orderNumber}`),m,f])]),o("div",{className:"order-amount-pill"},`â‚¹${(i.totalAmount||0).toLocaleString("en-IN")}`)]),p=[];s&&i.status==="confirmed"&&!i.packingDone&&p.push(o("button",{className:"swipe-action pack",onclick:C=>{C.stopPropagation(),window.openPackingPanel(i._id)}},"Pack")),s&&i.status==="confirmed"&&i.batch&&p.push(o("button",{className:"swipe-action bill",onclick:C=>{C.stopPropagation(),window.downloadDeliveryBill(i._id,i.batch?._id||i.batch)}},"Bill")),a&&p.push(o("button",{className:"swipe-action delete",onclick:C=>{C.stopPropagation(),window.deleteOrder(i._id)}},"Delete"));const V=o("div",{className:"swipe-actions"},p);let d="";p.length===1?d="single-action":p.length===2&&(d="two-actions");const v=o("div",{className:`swipe-item card-fade-in ${d}`.trim(),dataset:{orderId:i._id},style:{animationDelay:`${g*.05}s`}},[u,V]);r.appendChild(v)}),t.appendChild(r)}function we(){const t=document.getElementById("filterSegments"),e=document.getElementById("segmentIndicator"),n=t.querySelectorAll(".segment-btn");function a(c){const r=t.getBoundingClientRect(),i=c.getBoundingClientRect(),g=i.left-r.left,m=i.width;e.style.left=g+"px",e.style.width=m+"px"}const s=t.querySelector(".segment-btn.active");s&&setTimeout(()=>a(s),10),n.forEach(c=>{c.onclick=()=>{n.forEach(i=>i.classList.remove("active")),c.classList.add("active"),a(c),G=c.dataset.filter;const r=document.getElementById("ordersList");r.classList.add("segment-content"),W(),setTimeout(()=>r.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const c=t.querySelector(".segment-btn.active");c&&a(c)})}function he(t,e){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>t.apply(this,a),e)}}function be(){const t=document.getElementById("searchInput");if(t){const e=he(W,200);t.addEventListener("input",e)}}let P=null,A=null,$=new Set;async function ke(t,e){if(h?.role==="customer"){l("Delivery bills are not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s.classList.remove("swiped","swiped-single")});const n=/^[a-f\d]{24}$/i.test(t),a=/^[a-f\d]{24}$/i.test(e);if(!t||!n||!e||!a){console.error("Invalid order or batch ID:",t,e),l("Order data updating. Please refresh.","info");return}l("Downloading delivery bill...","info");try{const s=await fetch(`/api/batches/${e}/bills/${t}/download?copy=original`,{credentials:"include"});if(!s.ok){const f=await s.json().catch(()=>({}));throw new Error(f.message||"Failed to download delivery bill")}const c=s.headers.get("Content-Disposition");let r="delivery-bill.pdf";if(c){const f=c.match(/filename="?([^";\n]+)"?/);f&&(r=f[1])}const i=await s.blob(),g=window.URL.createObjectURL(i),m=document.createElement("a");m.href=g,m.download=r,document.body.appendChild(m),m.click(),window.URL.revokeObjectURL(g),m.remove(),l("Delivery bill downloaded!","success")}catch(s){console.error("Error downloading delivery bill:",s),l(s.message||"Failed to download delivery bill","error")}}async function x(t){if(h?.role==="customer"){l("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s.classList.remove("swiped","swiped-single")});const e=/^[a-f\d]{24}$/i.test(t);if(!t||!e){console.error("Invalid order ID:",t),l("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const n=document.getElementById("invoiceModalBody");n.innerHTML="",n.appendChild(o("div",{className:"invoice-loading"},"Loading invoice data..."));const a=document.getElementById("generateInvoiceBtn");a&&(a.disabled=!0);try{await Ie();const s=await fetch(`/api/invoices/${t}/split`,{credentials:"include"});if(!s.ok){const r=await s.json().catch(()=>({}));throw new Error(r.message||"Invoice data temporarily unavailable")}P=(await s.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${P.orderNumber}`,ee()}catch(s){console.error("Print order error:",s),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(o("div",{className:"invoice-no-items"},[o("p",{},"Invoice data not available"),o("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},s.message)]))}}let j=[];async function Ie(){if(!(j.length>0))try{const t=await fetch("/api/invoices/firms",{credentials:"include"});t.ok&&(j=(await t.json()).data||[])}catch(t){console.error("Failed to load firms:",t)}}function ee(){const t=document.getElementById("invoiceModalBody");if(!P){t.innerHTML="",t.appendChild(o("div",{className:"invoice-no-items"},"No items to invoice"));return}const e=P.firms.flatMap(i=>i.items);if(e.length===0){t.innerHTML="",t.appendChild(o("div",{className:"invoice-no-items"},"No items to invoice"));return}A||(A=j.length>0?j[0].id:P?.firms?.[0]?.firmId||"pratibha",$=new Set(e.map(i=>i.productId)));const n=e.filter(i=>$.has(i.productId)).reduce((i,g)=>i+(g.amount||0),0),a=j.length>0?j:(P?.firms||[]).map(i=>({id:i.firmId,name:i.firmName}));t.innerHTML="";const s=document.createDocumentFragment(),c=o("div",{className:"invoice-firm-selector"},[o("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),o("div",{className:"firm-options"},a.map(i=>o("label",{className:`firm-option ${A===i.id?"selected":""}`,onclick:()=>window.selectFirm(i.id)},[o("input",{type:"radio",name:"firm",value:i.id,checked:A===i.id}),o("span",{className:"firm-option-name"},i.name)])))]);s.appendChild(c),s.appendChild(o("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),s.appendChild(o("div",{className:"invoice-items-list"},e.map(i=>o("div",{className:"invoice-item"},[o("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:i.productId},checked:$.has(i.productId),onchange:()=>window.toggleInvoiceItem(null,i.productId)}),o("div",{className:"invoice-item-details"},[o("div",{className:"invoice-item-name"},i.productName),o("div",{className:"invoice-item-meta"},`${i.quantity||0} ${i.unit||""} Ã— â‚¹${(i.rate||0).toLocaleString("en-IN")}`)]),o("div",{className:"invoice-item-amount"},`â‚¹${(i.amount||0).toLocaleString("en-IN")}`)])))),s.appendChild(o("div",{className:"invoice-summary"},[o("div",{className:"invoice-summary-label"},"Total"),o("div",{className:"invoice-summary-total"},`â‚¹${n.toLocaleString("en-IN")}`)])),t.appendChild(s);const r=document.getElementById("generateInvoiceBtn");r&&(r.disabled=$.size===0)}function Ne(t){A=t,ee()}function Ce(t,e){$.has(e)?$.delete(e):$.add(e),ee()}async function Ee(){if(!P||!A||$.size===0)return;const t=document.getElementById("generateInvoiceBtn");t.classList.add("btn-loading"),t.disabled=!0;try{const e={"Content-Type":"application/json"},n=await T.ensureCsrfToken();n&&(e["X-CSRF-Token"]=n);const a=await fetch(`/api/invoices/${P.orderId}/pdf`,{method:"POST",headers:e,credentials:"include",body:JSON.stringify({firmId:A,productIds:Array.from($)})});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||"Invoice generation temporarily unavailable")}const s=await a.blob(),c=URL.createObjectURL(s),r=document.createElement("a");r.href=c,r.download=`INV${P.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(c),l("Invoice downloaded","success"),te()}catch(e){console.error("Generate invoice error:",e),l(e.message||"Could not generate invoice","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}}function te(){document.getElementById("invoiceModal").classList.remove("show"),P=null,A=null,$=new Set}function Be(){if(!F)return;const t=F;H(),x(t)}async function Pe(t){if(h?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const e=document.querySelector(`.swipe-item[data-order-id="${t}"]`);try{const n={"Content-Type":"application/json"},a=await T.ensureCsrfToken();a&&(n["X-CSRF-Token"]=a);const s=await fetch(`/api/orders/${t}`,{method:"DELETE",headers:n,credentials:"include"});if(s.ok)e?(e.classList.add("deleting"),setTimeout(()=>{D()},300)):D(),l("Order cancelled","success");else{const c=await s.json().catch(()=>({message:"Could not cancel. Try again."}));l(c.message||"Could not cancel","info")}}catch(n){console.error("Delete order error:",n),l("Could not delete order","info")}}async function Q(t){if(q){l("Please wait, saving in progress...","info");return}try{const e=await fetch(`/api/orders/${t}`,{credentials:"include"});let n;try{n=await e.json()}catch(d){console.error("Failed to parse order response:",d),l("Server issue. Please refresh.","info");return}if(!e.ok){l(n?.message||"Could not load order","info");return}const a=n.data;if(!a||!a.products){l("Order data updating. Refresh page.","info");return}F=t,E=a,B={},I={},y=[];const s=document.getElementById("modalTitle");s&&(s.textContent=`#${a.orderNumber}`);const c=document.getElementById("savePricesBtn");c&&(c.disabled=!0);const r=h.role==="admin"||h.role==="staff",i=a.batch?.batchType?`<span class="badge badge-batch">${a.batch.batchType}${a.batchLocked?" ðŸ”’":""}</span>`:"-",g=document.getElementById("modalBody");g.innerHTML="";const m=document.createDocumentFragment(),f=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Customer"),o("div",{className:"info-value"},a.customer?.name||"")]),o("div",{},[o("div",{className:"info-label"},"Phone"),o("div",{className:"info-value"},a.customer?.phone||"-")])]);m.appendChild(f);const u=a.batch?.batchType?o("span",{className:"badge badge-batch"},[a.batch.batchType,a.batchLocked?" ðŸ”’":""]):"-",p=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Date"),o("div",{className:"info-value"},new Date(a.createdAt).toLocaleDateString("en-IN"))]),o("div",{},[o("div",{className:"info-label"},"Batch"),o("div",{className:"info-value"},Array.isArray(u)?u:[u])])]);m.appendChild(p);const M=o("div",{className:"info-row"},[o("div",{},[o("div",{className:"info-label"},"Status"),o("div",{className:"info-value"},[o("span",{className:`badge badge-${a.status}`},a.status)])]),o("div",{})]);m.appendChild(M);const N=o("div",{className:"info-section"});if(N.appendChild(o("div",{className:"info-label"},"Products")),a.products.forEach((d,v)=>{const C=typeof d.product=="object"?d.product._id:d.product,b=K[C]||d.rate||null,k=b?`â‚¹${b.toLocaleString("en-IN")}`:"N/A";let J;if(r){const R=o("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${v}`,value:d.quantity,min:"0",step:"0.01",dataset:{idx:v,original:d.quantity,unit:d.unit},onfocus:O=>window.clearZero(O.target),onblur:O=>window.restoreValue(O.target),onchange:()=>window.handleQuantityChange(v),oninput:()=>window.handleQuantityInput(v)});J=o("div",{className:"qty-controls-inline"},[o("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(v,-1)},"âˆ’"),R,o("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(v,1)},"+"),o("span",{className:"qty-unit"},d.unit)])}else J=o("div",{className:"product-qty"},`${d.quantity} ${d.unit}`);const z=["Selling"];d.isContractPrice&&(z.push(" "),z.push(o("span",{className:"contract-badge"},"Fixed")));let Z;if(r){const R=o("input",{type:"number",className:`price-input input-animated${d.isContractPrice?" contract-locked":""}`,id:`price-${v}`,value:d.rate,min:"0",step:"0.01",dataset:{idx:v,original:d.rate,qty:d.quantity,contract:d.isContractPrice||!1},onfocus:O=>window.clearZero(O.target),onblur:O=>window.restoreValue(O.target),onchange:()=>window.handlePriceChange(v),oninput:()=>window.handlePriceInput(v)});d.isContractPrice&&(R.disabled=!0,R.title="Contract price - edit in customer management"),Z=R}else Z=o("div",{className:"price-value"},`â‚¹${d.rate}`);const ue=o("div",{className:"product-item",dataset:{idx:v}},[o("div",{className:"product-top"},[o("div",{},[o("div",{className:"product-name"},d.productName),J])]),o("div",{className:"prices-container"},[o("div",{className:"price-box"},[o("div",{className:"price-label"},"Purchase"),o("div",{className:"price-value"},k)]),o("div",{className:"price-box"},[o("div",{className:"price-label"},z),Z])]),o("div",{className:"amount-row"},[o("span",{className:"amount-label"},"Amount"),o("span",{className:"amount-display",id:`amount-${v}`},`â‚¹${d.amount}`)])]);N.appendChild(ue)}),N.appendChild(o("div",{id:"addedProductsContainer"})),r){const d=[o("option",{value:""},"+ Add Product...")];ce.filter(b=>!a.products.some(k=>(typeof k.product=="object"?k.product._id:k.product)===b._id)).forEach(b=>{d.push(o("option",{value:b._id,dataset:{name:b.name,unit:b.unit}},`${b.name} (${b.unit})`))});const v=o("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},d),C=o("div",{className:"add-product-section"},[v]);N.appendChild(C)}m.appendChild(N);const V=o("div",{className:"total-section"},[o("div",{className:"total-row"},[o("span",{},"Total"),o("span",{id:"orderTotal"},`â‚¹${a.totalAmount}`)]),o("div",{className:"total-row"},[o("span",{},"Paid"),o("span",{},`â‚¹${a.paidAmount||0}`)]),o("div",{className:"total-row main"},[o("span",{},"Balance"),o("span",{id:"orderBalance"},`â‚¹${a.totalAmount-(a.paidAmount||0)}`)])]);if(m.appendChild(V),g.appendChild(m),r){const d=document.getElementById("modalFooter");if(d){d.innerHTML="";const v=o("button",{className:"btn-modal secondary btn-animated",onclick:()=>window.printFromModal()},o("span",{className:"btn-text"},"Invoice"));if(d.appendChild(v),a.status==="pending"){const k=o("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--dusty-olive)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(a._id,"confirmed")},"Confirm Order");d.appendChild(k)}else if(a.status==="confirmed"&&a.packingDone){const k=o("button",{className:"btn-modal primary btn-animated status-action-btn",style:{background:"var(--gunmetal)",color:"white",flex:"1.5"},onclick:()=>window.updateOrderStatus(a._id,"delivered")},"Mark Delivered");d.appendChild(k)}if(a.status==="confirmed"&&!a.packingDone){const k=o("button",{className:"btn-modal secondary btn-animated",style:{background:"var(--dusty-olive)",color:"white",border:"none"},onclick:()=>{window.closeModal(),setTimeout(()=>window.openPackingPanel(a._id),200)}},"Start Packing");d.appendChild(k)}const b=o("button",{className:"btn-save-prices btn-animated",id:"savePricesBtn",disabled:!0,onclick:()=>window.savePrices()},o("span",{className:"btn-text"},"Save"));d.appendChild(b)}}document.getElementById("orderModal").classList.add("show")}catch{l("Could not load order","info")}}function $e(t){t.dataset.prevValue=t.value,t.value="",t.select()}function Le(t){t.value===""&&(t.value=t.dataset.prevValue||t.dataset.original);const e=parseInt(t.dataset.idx);re(e)}function Te(t){const e=document.getElementById(`price-${t}`),n=document.getElementById(`quantity-${t}`),a=parseFloat(e.dataset.original),s=parseFloat(e.value)||0,c=n?parseFloat(n.value)||0:parseFloat(e.dataset.qty);e.classList.toggle("changed",s!==a);const r=Math.round(s*c*100)/100,i=document.getElementById(`amount-${t}`);i&&(i.textContent=`â‚¹${r.toLocaleString("en-IN")}`),S()}function re(t){const e=document.getElementById(`price-${t}`);if(!e)return;const n=parseFloat(e.dataset.original),a=parseFloat(e.value)||0;a!==n&&a>0?B[t]=a:delete B[t],X()}function Se(t,e){const n=document.getElementById(`quantity-${t}`);if(!n)return;let s=(parseFloat(n.value)||0)+e;s<.01&&s>0&&(s=0),s<0&&(s=0),n.value=s,de(t),ne(t)}function ne(t){const e=document.getElementById(`quantity-${t}`),n=document.getElementById(`price-${t}`);if(!e)return;const a=parseFloat(e.dataset.original),s=parseFloat(e.value)||0;e.classList.remove("changed","removed"),s===0?e.classList.add("removed"):s!==a&&e.classList.add("changed");const c=n?parseFloat(n.value)||0:E?.products[t]?.rate||0,r=Math.round(s*c*100)/100,i=document.getElementById(`amount-${t}`);i&&(i.textContent=`â‚¹${r.toLocaleString("en-IN")}`),S()}function de(t){const e=document.getElementById(`quantity-${t}`);if(!e)return;const n=parseFloat(e.dataset.original),a=parseFloat(e.value)||0,s=.01;a>0&&a<s?(l(`Minimum quantity: ${s} ${e.dataset.unit}`,"info"),e.value=n,delete I[t]):a!==n?I[t]=a:delete I[t],X(),ne(t)}function X(){const t=Object.keys(B).length>0||Object.keys(I).length>0||y.length>0,e=document.getElementById("savePricesBtn");e&&(e.disabled=!t)}function qe(){const t=document.getElementById("productSelector"),e=t.value;if(!e)return;const n=t.options[t.selectedIndex],a=n.dataset.name,s=n.dataset.unit,c=K[e]||0;y.push({product:e,productName:a,unit:s,quantity:1,rate:c}),n.remove(),ae(),S(),X(),t.value=""}function ae(){const t=document.getElementById("addedProductsContainer");if(!t)return;t.innerHTML="";const e=document.createDocumentFragment();y.forEach((n,a)=>{const s=o("div",{className:"product-item added-product",dataset:{addedIdx:a}},[o("div",{className:"product-top"},[o("div",{},[o("div",{className:"product-name"},[n.productName," ",o("span",{className:"new-badge"},"New")]),o("div",{className:"qty-controls-inline"},[o("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(a,-1),type:"button"},"âˆ’"),o("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${a}`,value:n.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(a),oninput:()=>window.handleAddedQtyInput(a)}),o("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(a,1),type:"button"},"+"),o("span",{className:"qty-unit"},n.unit)])]),o("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(a),title:"Remove"},"Ã—")]),o("div",{className:"prices-container"},[o("div",{className:"price-box"},[o("div",{className:"price-label"},"Purchase"),o("div",{className:"price-value"},n.rate?`â‚¹${n.rate.toLocaleString("en-IN")}`:"N/A")]),o("div",{className:"price-box"},[o("div",{className:"price-label"},"Selling"),o("input",{type:"number",className:"price-input input-animated",id:`added-price-${a}`,value:n.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(a)})])]),o("div",{className:"amount-row"},[o("span",{className:"amount-label"},"Amount"),o("span",{className:"amount-display",id:`added-amount-${a}`},`â‚¹${((n.rate||0)*(n.quantity||0)).toLocaleString("en-IN")}`)])]);e.appendChild(s)}),t.appendChild(e)}function Fe(t,e){const n=document.getElementById(`added-qty-${t}`);if(!n)return;let a=parseFloat(n.value)||0;a=Math.max(0,a+e),a>0&&a<.01&&(a=.01),n.value=a,y[t].quantity=a,U(t),S()}function Ae(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;let n=parseFloat(e.value)||0;n>0&&n<.01&&(l("Minimum quantity: 0.01","info"),n=.01,e.value=n),y[t].quantity=n,U(t),S()}function Me(t){const e=document.getElementById(`added-qty-${t}`);if(!e)return;const n=parseFloat(e.value)||0;y[t].quantity=n,U(t),S()}function Oe(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const n=parseFloat(e.value)||0;y[t].rate=n,U(t),S()}function De(t){const e=document.getElementById(`added-price-${t}`);if(!e)return;const n=parseFloat(e.value)||0;y[t].rate=n,U(t),S()}function U(t){const e=document.getElementById(`added-amount-${t}`);if(!e)return;const n=y[t],a=(n.quantity||0)*(n.rate||0);e.textContent=`â‚¹${a.toLocaleString("en-IN")}`}function je(t){const e=y.splice(t,1)[0],n=document.getElementById("productSelector");if(n&&e){const a=document.createElement("option");a.value=e.product,a.dataset.name=e.productName,a.dataset.unit=e.unit,a.textContent=`${e.productName} (${e.unit})`,n.appendChild(a)}ae(),S(),X()}function S(){if(!E||!E.products)return;let t=0;E.products.forEach((s,c)=>{const r=document.getElementById(`price-${c}`),i=document.getElementById(`quantity-${c}`),g=r?parseFloat(r.value)||0:s.rate,m=i?parseFloat(i.value)||0:s.quantity;t+=g*m}),y.forEach(s=>{t+=(s.quantity||0)*(s.rate||0)}),t=Math.round(t*100)/100;const e=Math.round((t-(E.paidAmount||0))*100)/100,n=document.getElementById("orderTotal"),a=document.getElementById("orderBalance");n&&(n.textContent=`â‚¹${t.toLocaleString("en-IN")}`),a&&(a.textContent=`â‚¹${e.toLocaleString("en-IN")}`)}async function Qe(t){try{const e=await fetch(`/api/invoices/order/${t}`,{credentials:"include"});if(!e.ok)return!1;const n=await e.json();return n.data&&n.data.length>0}catch(e){return console.error("Failed to check invoices:",e),!1}}async function Re(){const t=Object.keys(B).length>0||Object.keys(I).length>0||y.length>0;if(!F||!E||!E.products||!t)return;if(q){l("Save in progress...","info");return}q=!0;const e=document.getElementById("savePricesBtn");e&&(e.disabled=!0,e.classList.add("btn-loading"));let n=!1;try{if(n=await Qe(F),n&&!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`)){q=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}catch(a){console.error("Invoice check failed:",a)}try{const a=E.products.map((u,p)=>{let M=B[p]!==void 0?B[p]:u.rate,N=I[p]!==void 0?I[p]:u.quantity;return(!M||M<=0)&&(M=u.rate),N<0&&(N=u.quantity),{product:typeof u.product=="object"?u.product._id:u.product,quantity:N,priceAtTime:M}}).filter(u=>u.quantity>0),s=y.filter(u=>u.quantity>0).map(u=>({product:u.product,quantity:u.quantity,priceAtTime:u.rate})),c=[...a,...s],r={"Content-Type":"application/json"},i=await T.ensureCsrfToken();i&&(r["X-CSRF-Token"]=i);const g={products:c},m=F;let f=await fetch(`/api/orders/${m}`,{method:"PUT",headers:r,credentials:"include",body:JSON.stringify(g)});if(f.status===403){let u;try{u=await f.json()}catch(p){console.warn("Failed to parse CSRF error response:",p.message),u={message:`Access denied (code: ${f.status})`}}if(u.message?.toLowerCase().includes("csrf")){const p=await T.refreshCsrfToken();if(p){if(r["X-CSRF-Token"]=p,f=await fetch(`/api/orders/${m}`,{method:"PUT",headers:r,credentials:"include",body:JSON.stringify(g)}),f.status===403){l("Session expired. Please refresh the page.","info"),q=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{l("Session expired. Please refresh the page.","info"),q=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}else{l(u.message||"Access temporarily unavailable","info"),q=!1,e&&(e.classList.remove("btn-loading"),e.disabled=!1);return}}if(f.ok)l("Changes saved","success"),B={},I={},y=[],e&&(e.classList.remove("btn-loading"),e.classList.add("btn-success"),setTimeout(()=>e.classList.remove("btn-success"),1500),e.disabled=!0),D(),n&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const u=m;H(),setTimeout(()=>x(u),300)}},500),F===m&&Q(m);else{let u;try{u=await f.json()}catch(p){console.warn("Failed to parse order save error response:",p.message),u={message:`Server error (${f.status})`}}l(u.message||"Could not update","info"),e&&(e.disabled=!1)}}catch(a){console.error("Save changes error:",a),navigator.onLine?l("Could not save. Try again.","info"):l("No internet connection","info"),e&&(e.disabled=!1)}finally{q=!1,e&&e.classList.remove("btn-loading")}}function H(){if((Object.keys(B).length>0||Object.keys(I).length>0||y.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const e=document.getElementById("orderModal");e&&e.classList.remove("show"),F=null,E=null,B={},I={},y=[]}window.closeModal=H;window.viewOrder=Q;window.clearZero=$e;window.restoreValue=Le;window.handlePriceChange=re;window.handlePriceInput=Te;window.handleQuantityChange=de;window.handleQuantityInput=ne;window.changeQuantity=Se;window.savePrices=Re;window.deleteOrder=Pe;window.printOrder=x;window.downloadDeliveryBill=ke;window.closeInvoiceModal=te;window.selectFirm=Ne;window.toggleInvoiceItem=Ce;window.generateInvoice=Ee;window.printFromModal=Be;window.addProductToOrder=qe;window.renderAddedProducts=ae;window.changeAddedQty=Fe;window.handleAddedQtyChange=Ae;window.handleAddedQtyInput=Me;window.handleAddedPriceChange=Oe;window.handleAddedPriceInput=De;window.removeAddedProduct=je;async function _e(t,e){if(!(!h||h.role!=="admin"&&h.role!=="staff"))try{const n={"Content-Type":"application/json"},a=await T.ensureCsrfToken();a&&(n["X-CSRF-Token"]=a);const s=await fetch(`/api/orders/${t}/status`,{method:"PUT",headers:n,credentials:"include",body:JSON.stringify({status:e})}),c=await s.json();s.ok?(l(`Order marked as ${e}`,"success"),Q(t),D()):(l(c.message||"Failed to update status","error"),Q(t))}catch(n){console.error("Status update error:",n),l("Network error updating status","error"),Q(t)}}window.updateOrderStatus=_e;async function le(t){const e=document.getElementById("packingPanel"),n=document.getElementById("packingPanelOverlay");if(!(!e||!n)){document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(a=>{a.classList.remove("swiped","swiped-single")}),e.classList.add("active"),n.classList.add("active"),document.body.style.overflow="hidden",document.getElementById("packingPanelBody").innerHTML='<div class="packing-loading">Loading order...</div>',document.getElementById("packingCompleteBtn").disabled=!0;try{const a=await fetch(`/api/packing/${t}`,{credentials:"include"});if(!a.ok)throw new Error("Failed to load order");w=(await a.json()).data,L=w.items||[],Y()}catch(a){console.error("Error loading packing order:",a),l("Failed to load order details","error"),oe()}}}function Y(){document.getElementById("packingPanelTitle").textContent=`Pack ${w.orderNumber}`,document.getElementById("packingPanelSubtitle").textContent=`${w.customer?.name||"Unknown"} â€¢ ${w.customer?.phone||""}`,Ve();const t=document.getElementById("packingPanelBody");let e="";(w.deliveryAddress||w.notes)&&(e='<div class="packing-order-details">',w.deliveryAddress&&(e+=`
                <div class="packing-delivery-info">
                    <span class="packing-label">Deliver to</span>
                    <span class="packing-value">${w.deliveryAddress}</span>
                </div>`),w.notes&&(e+=`
                <div class="packing-order-notes">
                    <span class="packing-label">Notes</span>
                    <span class="packing-value">${w.notes}</span>
                </div>`),e+="</div>");const n=L.map((c,r)=>{const i=c.packedQuantity??c.orderedQuantity,g=c.packedQuantity!==void 0&&c.packedQuantity!==c.orderedQuantity,m=c.packed||!1;return`
            <div class="packing-checklist-item ${m?"item-packed":""} ${g?"item-modified":""}" data-index="${r}" data-product-id="${c.product}">
                <div class="packing-item-main">
                    <div class="packing-item-check ${m?"checked":""}" onclick="togglePackedItem(${r})">
                        ${m?"âœ“":""}
                    </div>
                    <div class="packing-item-details">
                        <span class="packing-item-name">${c.productName}</span>
                        <span class="packing-item-qty">Ordered: ${c.orderedQuantity} ${c.unit}</span>
                    </div>
                </div>
                <div class="packing-item-input">
                    <input type="number"
                        class="packing-qty-input ${g?"modified":""}"
                        value="${i}"
                        data-index="${r}"
                        data-original="${c.orderedQuantity}"
                        step="0.01"
                        min="0"
                        onchange="handlePackingQtyChange(${r})"
                    >
                    <span class="packing-unit-label">${c.unit}</span>
                </div>
            </div>
        `}).join("");t.innerHTML=`
        ${e}
        <div class="packing-checklist-header">
            <span>Items to Pack</span>
        </div>
        <div class="packing-checklist">
            ${n}
        </div>
    `;const a=document.getElementById("packingPanelAcknowledgement");a&&(a.style.display="none");const s=document.getElementById("packingPanelIssues");s&&(s.style.display="none"),Je()}async function Ue(t){const e=L[t],n=!e.packed;e.packed=n,Y();try{const a=await T.ensureCsrfToken();if(!(await fetch(`/api/packing/${w._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":a},credentials:"include",body:JSON.stringify({packed:n})})).ok)throw new Error("Failed to update packed status")}catch(a){console.error("Error toggling packed status:",a),e.packed=!n,Y(),l("Failed to update. Try again.","error")}}async function Xe(t){const e=document.querySelector(`.packing-qty-input[data-index="${t}"]`),n=parseFloat(e?.value)||0,a=parseFloat(e?.dataset.original)||0;L[t].packedQuantity=n,e.classList.toggle("modified",n!==a);const s=e.closest(".packing-checklist-item");s&&s.classList.toggle("item-modified",n!==a),await He(t)}async function He(t){const e=L[t];try{const n=await T.ensureCsrfToken();if(!(await fetch(`/api/packing/${w._id}/item/${e.product}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-Token":n},credentials:"include",body:JSON.stringify({quantity:e.packedQuantity})})).ok)throw new Error("Failed to save")}catch(n){console.error("Error saving packing item:",n),l("Failed to save changes","error")}}function Ve(){const t=L.length,e=L.filter(a=>a.packed).length,n=t>0?Math.round(e/t*100):0;document.getElementById("packingProgressFill").style.width=`${n}%`,document.getElementById("packingProgressText").textContent=`${e}/${t} items packed`}function Je(){const t=document.getElementById("packingCompleteBtn");if(t){const e=L.length,n=L.filter(s=>s.packed).length,a=n===e&&e>0;if(t.disabled=!a,!a&&e>0){const s=e-n;t.title=`${s} item(s) remaining`}else t.title=""}}async function ze(){const t=document.getElementById("packingCompleteBtn");t.disabled=!0,t.innerHTML='<span class="btn-text">Completing...</span>';try{const e=await T.ensureCsrfToken(),n=await fetch(`/api/packing/${w._id}/done`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-Token":e},credentials:"include"});if(!n.ok){const a=await n.json();throw new Error(a.message||"Failed to complete packing")}l("Packing completed!","success"),oe(),await D()}catch(e){console.error("Error completing packing:",e),l(e.message||"Failed to complete packing","error"),t.disabled=!1,t.innerHTML='<span class="btn-text">Mark Done</span>'}}function oe(){const t=document.getElementById("packingPanel"),e=document.getElementById("packingPanelOverlay");t.classList.remove("active"),e.classList.remove("active"),document.body.style.overflow="",w=null,L=[]}window.openPackingPanel=le;window.closePackingPanel=oe;window.handlePackingQtyChange=Xe;window.completePackingSession=ze;window.togglePackedItem=Ue;me();
