import"./responsive-C3eqjYrO.js";/* empty css               *//* empty css                *//* empty css              */import{t as p}from"./ui-C7t5s6-T.js";import"./api-BDW4zv3H.js";import{r as y}from"./init-CaZe2BNf.js";y();const k=(e=1e4)=>new Promise((o,s)=>{const t=Date.now(),i=()=>{if(window.Auth)return o(window.Auth);if(Date.now()-t>e)return s(new Error("Auth not available"));setTimeout(i,50)};i()}),l=await k();l.ensureCsrfToken().catch(e=>console.warn("CSRF pre-fetch failed:",e));const g=document.getElementById("loginForm"),d=document.getElementById("loginBtn"),a=document.getElementById("noticeMessage"),u=document.getElementById("passwordToggle");u&&u.addEventListener("click",()=>{p("password",u)});T();async function T(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const o=await e.json();o.user.role==="customer"?window.location.href="/pages/order-form/":o.user.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/"}}catch{}}g&&g.addEventListener("submit",async e=>{e.preventDefault();const o=document.getElementById("email").value.trim(),s=document.getElementById("password").value;if(!o||!s){r("Please enter username and password");return}d.disabled=!0,d.classList.add("btn-loading"),C();try{const t={"Content-Type":"application/json"},i=await l.ensureCsrfToken();i&&(t["X-CSRF-Token"]=i);const c=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:o,password:s})});if(c.status===429){r("Too many attempts. Please try again later.");return}const n=await c.json();if(c.status===403&&(n?.message?.toLowerCase().includes("csrf")||!i)){console.log("CSRF error, refreshing token and retrying...");const m=await l.refreshCsrfToken();if(m){t["X-CSRF-Token"]=m;const w=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:o,password:s})}),f=await w.json();if(w.ok){l.setUser(f.user),f.user.role==="customer"?window.location.href="/pages/order-form/":f.user.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/";return}r(f.message||"Please check your credentials");return}}c.ok?(l.setUser(n.user),n.user.role==="customer"?window.location.href="/pages/order-form/":n.user.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/"):r(n.message||"Please check your credentials")}catch(t){console.error("Login error:",t),navigator.onLine?t.name==="TypeError"||t.message.includes("fetch")?r("Connection issue. Please try again."):r("Something went wrong. Try again."):r("No internet connection")}finally{d&&(d.disabled=!1,d.classList.remove("btn-loading"))}});function r(e){a&&(a.textContent=e,a.classList.add("show"))}function C(){a&&a.classList.remove("show")}const h=document.getElementById("forgotPasswordLink");h&&h.addEventListener("click",async e=>{e.preventDefault();const o=document.getElementById("email").value.trim();if(!o){r("Please enter your username first");return}try{const s={"Content-Type":"application/json"},t=await l.ensureCsrfToken();t&&(s["X-CSRF-Token"]=t);const i=await fetch("/api/auth/forgot-password",{method:"POST",headers:s,credentials:"include",body:JSON.stringify({email:o})}),c=await i.json();if(i.ok&&c.resetUrl){a.textContent="",a.appendChild(document.createTextNode("Reset link generated! "));const n=document.createElement("a");n.href=c.resetUrl,n.style.cssText="color: var(--dusty-olive); text-decoration: underline;",n.textContent="Click here to reset",a.appendChild(n),a.classList.add("show"),a.classList.remove("error")}else r(c.message||"If an account exists, a reset link has been generated")}catch(s){console.error("Forgot password error:",s),r("Could not process request. Try again.")}});
