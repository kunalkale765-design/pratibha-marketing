import{s as r,c as s}from"./ui-Usu6AxiT.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */const S=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(S()),10)}),u=await S();let m=[],w=[],p={},E="";async function D(){u.ensureCsrfToken().catch(n=>console.warn("CSRF pre-fetch failed:",n)),await u.requireAuth(["admin","staff"])&&await Promise.all([C(),F()])}async function F(){try{const e=await fetch("/api/products",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);w=(await e.json()).data||[]}catch(e){console.error("Failed to load products:",e),r("Products not available. Try again.","info")}}async function C(){try{m=(await(await fetch("/api/customers",{credentials:"include"})).json()).data||[],A(m)}catch(e){console.error("Failed to load customers:",e);const n=document.getElementById("customersList"),t=navigator.onLine?"Customers not available":"No internet connection";n.innerHTML="",n.appendChild(s("div",{className:"empty-state"},[s("p",{},t),s("button",{id:"retryCustomersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:C},"Try Again")]))}}function R(e){const n=e.pricingType||"market";return n==="contract"?s("span",{className:"badge badge-contract"},"Contract"):n==="markup"?s("span",{className:"badge badge-markup"},`+${e.markupPercentage||0}%`):s("span",{className:"badge badge-market"},"Market")}function A(e){const n=document.getElementById("customersList");if(!e||!e.length){n.innerHTML="",n.appendChild(s("div",{className:"empty-state"},"No customers found"));return}n.innerHTML="";const t=document.createDocumentFragment();e.forEach((o,a)=>{const c=[];o.phone&&c.push(s("span",{},o.phone)),o.address&&c.push(s("span",{},o.address));const i=[s("button",{onclick:()=>window.shareMagicLink(o._id),className:"btn-action link",title:"Share order link"},"Link")];o.pricingType==="contract"&&i.push(s("button",{onclick:()=>window.openContractPrices(o._id),className:"btn-action"},"Prices")),i.push(s("button",{onclick:()=>window.editCustomerById(o._id),className:"btn-action primary"},"Edit")),i.push(s("button",{onclick:()=>window.deleteCustomer(o._id),className:"btn-action danger"},"Delete"));const d=s("div",{className:"customer-card card-animated card-fade-in",style:{animationDelay:`${a*.05}s`}},[s("div",{className:"customer-header"},[s("div",{className:"customer-name"},o.name),R(o)]),s("div",{className:"customer-details"},c),s("div",{className:"customer-actions"},i)]);t.appendChild(d)}),n.appendChild(t)}function x(){const e=document.getElementById("searchInput").value.toLowerCase(),n=m.filter(t=>t.name.toLowerCase().includes(e)||t.phone&&t.phone.includes(e));A(n)}function I(){const e=document.getElementById("customerPricingType").value;document.getElementById("markupField").classList.toggle("hidden",e!=="markup"),document.getElementById("contractInfo").classList.toggle("hidden",e!=="contract")}function X(){document.getElementById("modalTitle").textContent="Add Customer",document.getElementById("customerForm").reset(),document.getElementById("customerId").value="",document.getElementById("customerPricingType").value="market",I(),document.getElementById("customerModal").classList.add("show")}function q(e){document.getElementById("modalTitle").textContent="Edit Customer",document.getElementById("customerId").value=e._id,document.getElementById("customerName").value=e.name,document.getElementById("customerPhone").value=e.phone||"",document.getElementById("customerWhatsapp").value=e.whatsapp||"",document.getElementById("customerAddress").value=e.address||"",document.getElementById("customerPricingType").value=e.pricingType||"market",document.getElementById("customerMarkup").value=e.markupPercentage||0,I(),document.getElementById("customerModal").classList.add("show")}function B(){document.getElementById("customerModal").classList.remove("show")}function H(){const e=document.getElementById("customerForm");e&&e.addEventListener("submit",async n=>{n.preventDefault();const t=document.getElementById("saveCustomerBtn"),o=document.getElementById("customerId").value,a=document.getElementById("customerPricingType").value,c=document.getElementById("customerName").value.trim(),i=document.getElementById("customerPhone").value.trim(),d=document.getElementById("customerWhatsapp").value.trim();if(!c){r("Please enter customer name","info"),document.getElementById("customerName").focus();return}if(i&&!/^[0-9]{10}$/.test(i)){r("Phone should be 10 digits","info"),document.getElementById("customerPhone").focus();return}if(d&&!/^[0-9]{10}$/.test(d)){r("WhatsApp should be 10 digits","info"),document.getElementById("customerWhatsapp").focus();return}const l=parseFloat(document.getElementById("customerMarkup").value)||0;if(a==="markup"&&(l<0||l>200)){r("Markup should be 0-200%","info"),document.getElementById("customerMarkup").focus();return}t.classList.add("btn-loading"),t.disabled=!0;const y={name:c,phone:i,whatsapp:d,address:document.getElementById("customerAddress").value.trim(),pricingType:a,markupPercentage:a==="markup"?l:0};try{const v=o?`/api/customers/${o}`:"/api/customers",P=o?"PUT":"POST",k={"Content-Type":"application/json"},L=await u.ensureCsrfToken();L&&(k["X-CSRF-Token"]=L);let h=await fetch(v,{method:P,headers:k,credentials:"include",body:JSON.stringify(y)});if(h.status===403){const f=await h.json();if(f.message?.toLowerCase().includes("csrf")){const g=await u.refreshCsrfToken();g&&(k["X-CSRF-Token"]=g,h=await fetch(v,{method:P,headers:k,credentials:"include",body:JSON.stringify(y)}))}else{const g=f.errors?.[0]?.msg||f.message||"Could not save. Try again.";r(g,"info"),t.classList.remove("btn-loading"),t.disabled=!1;return}}if(h.ok)t.classList.remove("btn-loading"),t.classList.add("btn-success"),r(o?"Customer updated":"Customer added","success"),setTimeout(()=>{t.classList.remove("btn-success"),B()},800),C();else{const f=await h.json(),g=f.errors?.[0]?.msg||f.message||"Could not save. Try again.";r(g,"info")}}catch(v){console.error("Save customer error:",v),navigator.onLine?r("Could not save. Please try again.","info"):r("No internet connection","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}})}async function $(e,n=!1){if(!(!n&&!confirm("Delete this customer?")))try{const t={},o=await u.ensureCsrfToken();o&&(t["X-CSRF-Token"]=o);const a=await fetch(`/api/customers/${e}`,{method:"DELETE",headers:t,credentials:"include"});if(a.status===403&&!n&&(await a.json()).message?.toLowerCase().includes("csrf"))return await u.refreshCsrfToken(),$(e,!0);if(a.ok)r("Customer deleted","success"),C();else{const c=await a.json();r(c.message||"Could not delete","info")}}catch(t){console.error("Delete customer error:",t),navigator.onLine?r("Could not delete. Please try again.","info"):r("No internet connection","info")}}function J(e){const n=m.find(t=>t._id===e);n&&q(n)}async function j(e,n=!1){const t=m.find(o=>o._id===e);if(!t){r("Customer data updating. Please refresh.","info");return}try{const o={},a=await u.ensureCsrfToken();a&&(o["X-CSRF-Token"]=a);let c=await fetch(`/api/customers/${e}/magic-link`,{method:"POST",headers:o,credentials:"include"}),i=await c.json();if(c.status===403&&i?.message?.toLowerCase().includes("csrf")&&!n)return await u.refreshCsrfToken(),j(e,!0);if(c.ok&&i.data){const d=i.data.link;if(navigator.clipboard?(await navigator.clipboard.writeText(d),r(`Link copied for ${t.name}`,"success")):prompt("Copy this order link:",d),navigator.share)try{await navigator.share({title:"Pratibha Marketing - Order",text:`Place your order here, ${t.name}`,url:d})}catch(l){l.name!=="AbortError"&&console.warn("Share API failed:",l.name,l.message)}}else r(i.message||"Could not generate link","info")}catch(o){console.error("Magic link error:",o),navigator.onLine?r("Could not generate link. Try again.","info"):r("No internet connection","info")}}async function U(e){const n=m.find(t=>t._id===e);if(!n){r("Customer data updating. Please refresh.","info");return}w.length||await F(),document.getElementById("contractCustomerId").value=e,document.getElementById("contractCustomerName").textContent=n.name,n.contractPrices instanceof Map?p=Object.fromEntries(n.contractPrices):p=n.contractPrices||{},W(),E="",document.getElementById("productSearch").value="",O(w),document.getElementById("contractModal").classList.add("show")}function W(){const e=[...new Set(w.map(o=>o.category||"Other"))].sort(),n=document.getElementById("contractCategoryPills");n.innerHTML="";const t=document.createDocumentFragment();t.appendChild(s("button",{className:"cat-pill active",dataset:{category:""},onclick:()=>window.filterByContractCategory("")},"All")),e.forEach(o=>{const a=o.replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase());t.appendChild(s("button",{className:"cat-pill",dataset:{category:o},onclick:()=>window.filterByContractCategory(o)},a))}),n.appendChild(t)}function O(e){const n=document.getElementById("contractPricesList");n.innerHTML="";const t=document.createDocumentFragment();e.forEach(o=>{const a=p[o._id]||"",c=s("div",{className:"contract-item"},[s("div",{className:"contract-item-info"},[s("div",{className:"contract-item-name"},o.name),s("div",{className:"contract-item-base"},`per ${o.unit}`)]),s("input",{type:"number",step:"0.01",min:"0",className:"contract-price-input input-animated",dataset:{productId:o._id},value:String(a),placeholder:"â‚¹"}),s("span",{className:"contract-item-unit"},`/${o.unit}`)]);t.appendChild(c)}),n.appendChild(t)}function T(){document.querySelectorAll(".contract-price-input").forEach(e=>{const n=e.dataset.productId,t=parseFloat(e.value);!isNaN(t)&&t>0?p[n]=t:delete p[n]})}function _(){T();const e=document.getElementById("productSearch").value.toLowerCase(),n=w.filter(t=>{const o=t.name.toLowerCase().includes(e),a=!E||(t.category||"Other")===E;return o&&a});O(n)}function Q(e){T(),E=e,document.querySelectorAll("#contractCategoryPills .cat-pill").forEach(n=>{n.classList.toggle("active",n.dataset.category===e)}),_()}async function V(){const e=document.getElementById("contractCustomerId").value,n=m.find(a=>a._id===e);if(!n){r("Customer data updating. Please refresh.","info");return}const t=document.getElementById("saveContractBtn");t.classList.add("btn-loading"),t.disabled=!0,T();const o={...p};try{const a={"Content-Type":"application/json"},c=await u.ensureCsrfToken();c&&(a["X-CSRF-Token"]=c);const i={name:n.name,phone:n.phone,contractPrices:o};let d=await fetch(`/api/customers/${e}`,{method:"PUT",headers:a,credentials:"include",body:JSON.stringify(i)});if(d.status===403&&(await d.json()).message?.toLowerCase().includes("csrf")){const y=await u.refreshCsrfToken();y&&(a["X-CSRF-Token"]=y,d=await fetch(`/api/customers/${e}`,{method:"PUT",headers:a,credentials:"include",body:JSON.stringify(i)}))}if(d.ok)t.classList.remove("btn-loading"),t.classList.add("btn-success"),r("Prices saved","success"),setTimeout(()=>{t.classList.remove("btn-success"),b()},800),C();else{const l=await d.json();r(l.errors?.[0]?.msg||l.message||"Could not save","info")}}catch(a){console.error("Save contract prices error:",a),navigator.onLine?r("Could not save prices. Try again.","info"):r("No internet connection","info")}finally{t.classList.remove("btn-loading"),t.disabled=!1}}function b(){document.getElementById("contractModal").classList.remove("show"),document.getElementById("productSearch").value=""}window.showAddCustomerForm=X;window.searchCustomers=x;window.toggleMarkupField=I;window.closeModal=B;window.editCustomerById=J;window.deleteCustomer=$;window.shareMagicLink=j;window.openContractPrices=U;window.filterContractProducts=_;window.filterByContractCategory=Q;window.saveContractPrices=V;window.closeContractModal=b;window.changeAddedQty=window.changeAddedQty;const N=document.getElementById("customerModal");N&&(N.onclick=e=>{e.target.id==="customerModal"&&B()});const M=document.getElementById("contractModal");M&&(M.onclick=e=>{e.target.id==="contractModal"&&b()});H();D();
