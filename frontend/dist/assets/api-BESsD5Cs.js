var k=(e,r)=>()=>(r||e((r={exports:{}}).exports,r),r.exports);var S=k((A,i)=>{let u=null;function d(){const e=document.cookie.match(/csrf_token=([^;]+)/);return e?e[1]:null}async function g(){if(u)return u;u=(async()=>{try{const e=await fetch("/api/csrf-token",{credentials:"include"});if(e.ok)return(await e.json()).csrfToken||d()}catch(e){console.error("Failed to refresh CSRF token:",e)}return null})();try{return await u}finally{u=null}}async function w(){let e=d();return e||(e=await g()),e}const T={USER_KEY:"user",getCsrfToken:d,refreshCsrfToken:g,ensureCsrfToken:w,isLoggedIn(){return!!this.getUser()},getUser(){try{const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Error parsing user data:",e),null}},setUser(e){const r={id:e.id,name:e.name,email:e.email,role:e.role,customer:e.customer?{_id:e.customer._id,name:e.customer.name,pricingType:e.customer.pricingType,...e.customer.pricingType==="contract"&&e.customer.contractPrices?{contractPrices:e.customer.contractPrices}:{}}:null,isMagicLink:e.isMagicLink||!1};localStorage.setItem(this.USER_KEY,JSON.stringify(r))},clearAuth(){localStorage.removeItem(this.USER_KEY)},getRole(){const e=this.getUser();return e?e.role:null},isStaff(){const e=this.getRole();return e==="admin"||e==="staff"},isCustomer(){return this.getRole()==="customer"},async verify(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const r=await e.json();return this.setUser(r.user),r.user}else return this.clearAuth(),null}catch(e){return console.error("Auth verification failed:",e),!navigator.onLine||e.name==="TypeError"||e.message.includes("network")||e.message.includes("fetch")||e.message.includes("Failed to fetch")?(console.warn("Network issue during auth verification - using cached user"),this.getUser()):(this.clearAuth(),null)}},async login(e,r,a=!1){try{const n={"Content-Type":"application/json"},h=await this.ensureCsrfToken();h&&(n["X-CSRF-Token"]=h);const l=await fetch("/api/auth/login",{method:"POST",headers:n,credentials:"include",body:JSON.stringify({email:e,password:r})}),c=await l.json();return l.ok?(this.setUser(c.user),{success:!0,user:c.user}):l.status===403&&c?.message?.toLowerCase().includes("csrf")&&!a?(console.log("CSRF token error during login, refreshing and retrying..."),await this.refreshCsrfToken(),this.login(e,r,!0)):{success:!1,error:c.message||"Login failed"}}catch(n){return console.error("Login error:",n),{success:!1,error:"Network error. Please try again."}}},async logout(){try{const e={},r=await this.ensureCsrfToken();r&&(e["X-CSRF-Token"]=r);const a=await fetch("/api/auth/logout",{method:"POST",headers:e,credentials:"include"});a.ok||console.warn("Server-side logout returned error:",a.status)}catch(e){console.error("Logout error:",e),console.warn("Server-side session may still be active due to:",e.message)}finally{this.clearAuth(),window.location.href="/pages/auth/login.html"}},async requireAuth(e=null){const r=await this.verify();return r?e&&!e.includes(r.role)?(r.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",null):r:(window.location.href="/pages/auth/login.html",null)},async redirectIfLoggedIn(){const e=await this.verify();return e?(e.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",!0):!1}};typeof window<"u"&&(window.Auth=T);typeof i<"u"&&i.exports&&(i.exports=T);const E={getCsrfToken:d,refreshCsrfToken:g,ensureCsrfToken:w,async request(e,r={},a=!1,n=0){const f={...{credentials:"include",headers:{"Content-Type":"application/json",...r.headers}},...r},m=["POST","PUT","DELETE","PATCH"].includes(r.method?.toUpperCase());if(m){const o=await this.ensureCsrfToken();o&&(f.headers["X-CSRF-Token"]=o)}r.body instanceof FormData&&delete f.headers["Content-Type"];try{if(!navigator.onLine)return{success:!1,error:"No internet connection. Please check your network.",offline:!0};const o=new AbortController,y=setTimeout(()=>o.abort(),3e4);f.signal=o.signal;let t;try{t=await fetch(e,f)}finally{clearTimeout(y)}let s;try{s=await t.json()}catch(p){return console.error("API response parse error:",p,"Status:",t.status),{success:!1,error:t.ok?"Server returned an invalid response. Please try again.":`Server error (${t.status}). Please try again later.`,status:t.status,parseError:!0}}return t.ok?{success:!0,data:s,status:t.status}:t.status===401?(typeof Auth<"u"&&Auth.clearAuth(),window.location.href="/login.html",{success:!1,error:"Session expired. Please login again.",status:401}):t.status===403?s?.message?.toLowerCase().includes("csrf")&&!a&&m?(console.log("CSRF token error, refreshing and retrying..."),await this.refreshCsrfToken(),this.request(e,r,!0)):{success:!1,error:s?.message||"Access denied. You do not have permission.",status:403}:t.status===404?{success:!1,error:"Resource not found.",status:404}:t.status===429?{success:!1,error:"Too many requests. Please try again later.",status:429}:t.status===408?{success:!1,error:"Request timed out. Please try again.",status:408}:t.status===500?{success:!1,error:s?.message||"Server error. Please try again later.",status:500}:t.status===502||t.status===503||t.status===504?{success:!1,error:"Service temporarily unavailable. Please try again later.",status:t.status}:t.status===422?{success:!1,error:s?.message||"Invalid data provided. Please check your input.",errors:s?.errors,status:422}:{success:!1,error:s?.message||s?.error||"Something went wrong",status:t.status,data:s}}catch(o){return console.error("API request failed:",o),navigator.onLine?o.name==="AbortError"?{success:!1,error:"Request timed out. Please try again.",timeout:!0,networkError:!0}:n<2?(console.log(`Network error, retrying (${n+1}/2)...`),await new Promise(t=>setTimeout(t,1e3*(n+1))),this.request(e,r,a,n+1)):!r.method||r.method.toUpperCase()==="GET"?{success:!1,error:"",networkError:!0,silent:!0}:{success:!1,error:"Connection issue. Please try again.",networkError:!0}:{success:!1,error:"No internet connection.",offline:!0}}},async get(e){return this.request(e,{method:"GET"})},async post(e,r){return this.request(e,{method:"POST",body:JSON.stringify(r)})},async put(e,r){return this.request(e,{method:"PUT",body:JSON.stringify(r)})},async delete(e){return this.request(e,{method:"DELETE"})},async getProducts(){return this.get("/api/products")},async getCustomers(){return this.get("/api/customers")},async getOrders(e={}){const r=new URLSearchParams(e).toString();return this.get(`/api/orders${r?"?"+r:""}`)},async getMarketRates(){return this.get("/api/market-rates")},async getQuantitySummary(){return this.get("/api/supplier/quantity-summary")},async createOrder(e){return this.post("/api/orders",e)},async updateOrderStatus(e,r){return this.put(`/api/orders/${e}/status`,{status:r})},async updateMarketRate(e){return this.post("/api/market-rates",e)}};window.addEventListener("online",()=>{console.log("Connection restored"),typeof showSuccess=="function"&&showSuccess("Connection restored")});window.addEventListener("offline",()=>{console.log("Connection lost"),typeof showToast=="function"&&showToast("No internet connection","info")});typeof i<"u"&&i.exports&&(i.exports=E)});export default S();
