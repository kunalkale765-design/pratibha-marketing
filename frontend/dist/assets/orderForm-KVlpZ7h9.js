import"./responsive-D1ZTW0b0.js";import{c as a,s as l}from"./ui-Bns_kLia.js";import"./api-CCOw0EgE.js";import{l as Q}from"./init-CHmvMvUV.js";const U=(e=1e4)=>new Promise((t,o)=>{const n=Date.now(),r=()=>{if(window.Auth)return t(window.Auth);if(Date.now()-n>e)return o(new Error("Auth not available"));setTimeout(r,50)};r()}),w=await U(),O=document.getElementById("logoutBtn");O&&O.addEventListener("click",Q);const S=document.getElementById("customerSelect");S&&S.addEventListener("change",Z);let h=null,u=null,v=[];const N={};let I=[],g=!1;async function V(){const t=new URLSearchParams(window.location.search).get("token");if(t)try{const o=await fetch(`/api/auth/magic/${t}`,{credentials:"include"}),n=await o.json();if(o.ok&&n.user)h=n.user,w.setUser(n.user),window.history.replaceState({},"",window.location.pathname);else{l(n.message||"Link expired. Please request a new one.","info"),window.location.href="/pages/auth/login.html";return}}catch{l("Authentication issue. Please refresh.","info"),window.location.href="/pages/auth/login.html";return}else if(h=await w.verify(),!h){window.location.href="/pages/auth/login.html";return}if(g=h.role==="admin"||h.role==="staff",await D(),g){const o=document.getElementById("customerBar");o&&o.classList.add("show"),J()}else if(h.customer)u=typeof h.customer=="object"?h.customer:{_id:h.customer,pricingType:"market"},q();else{const o=document.getElementById("productList");o&&(o.innerHTML="",o.appendChild(a("div",{className:"empty-state"},"Account setup in progress. Please check back later.")))}}async function D(){try{const[e,t,o]=await Promise.all([fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/customers",{credentials:"include"}).catch(()=>({ok:!1}))]);e.ok&&(v=((await e.json())?.data||[]).filter(r=>r.isActive!==!1)),t.ok&&((await t.json())?.data||[]).forEach(r=>{const s=typeof r.product=="object"?r.product._id:r.product;s&&(N[s]=r.rate)}),o.ok&&(I=((await o.json())?.data||[]).filter(r=>r.isActive!==!1))}catch(e){console.error("Failed to load data:",e);const t=document.getElementById("productList");t&&(t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},[a("p",{},"Products not available"),a("button",{id:"retryDataBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:()=>D().then(()=>{u&&q()})},"Try Again")])))}}function J(){const e=document.getElementById("customerSelect");I.forEach(t=>{e.appendChild(a("option",{value:t._id},t.name))})}function Z(){const e=document.getElementById("customerSelect").value;if(u=I.find(t=>t._id===e)||null,u)q();else{const t=document.getElementById("productList");t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},"Select a customer to start"))}E()}function X(e,t){return e?e[t]!==void 0?e[t]:typeof e.get=="function"?e.get(t):null:null}function W(e){if(!u)return N[e._id]||0;const t=u.pricingType||"market";if(t==="contract"){const o=X(u.contractPrices,e._id);return o!==null?o:N[e._id]||0}else if(t==="markup"){const o=N[e._id]||0;return Math.round(o*(1+(u.markupPercentage||0)/100))}return N[e._id]||0}function G(){if(g||!u||u.pricingType!=="contract")return v;const e=u.allowedProducts||(u.contractPrices?Object.keys(u.contractPrices):[]);return e.length===0?[]:v.filter(t=>e.includes(t._id))}function z(e=v){const t=[...new Set(e.map(n=>n.category||"Other"))],o=document.getElementById("categoryPills");if(o.innerHTML="",e.length===0||t.length<=1){o.style.display="none";return}o.style.display="flex",o.appendChild(a("button",{className:"cat-pill active",dataset:{cat:"all"},onclick:()=>P("all")},"All")),t.forEach(n=>{o.appendChild(a("button",{className:"cat-pill",dataset:{cat:n},onclick:()=>P(n)},n))})}function P(e){document.querySelectorAll(".cat-pill").forEach(o=>o.classList.remove("active"));const t=document.querySelector(`.cat-pill[data-cat="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".product-item").forEach(o=>{o.style.display=e==="all"||o.dataset.category===e?"":"none"}),document.querySelectorAll(".category-header").forEach(o=>{o.style.display=e==="all"||o.dataset.category===e?"":"none"})}function q(){const e=document.getElementById("productList");e.innerHTML="";const t=G();if(!t.length){const s=u&&u.pricingType==="contract"&&v.length>0?"No products configured for your account. Please contact us to set up pricing.":"No products available";e.appendChild(a("div",{className:"empty-state"},s));return}z(t);const o={};t.forEach(r=>{const s=r.category||"Other";o[s]||(o[s]=[]),o[s].push(r)});const n=document.createDocumentFragment();for(const[r,s]of Object.entries(o))n.appendChild(a("div",{className:"category-header",dataset:{category:r}},r)),s.forEach(i=>{const c=g?W(i):0,p=i.unit==="piece"?"1":"0.01",d={id:i._id,category:r,unit:i.unit};g&&(d.price=c);const y=a("div",{className:"product-item",dataset:d},[a("div",{className:"product-info"},[a("div",{className:"product-name"},i.name),a("div",{className:"product-meta"},i.unit)]),a("div",{className:"qty-controls"},[a("button",{className:"qty-btn",onclick:()=>window.changeQty(i._id,-1)},"âˆ’"),a("input",{type:"number",className:"qty-input",id:`qty-${i._id}`,value:"0",min:"0",step:p,inputmode:"numeric",onfocus:f=>window.clearZero(f.target),onblur:f=>window.restoreZero(f.target),onchange:()=>window.updateFromInput(i._id)}),a("button",{className:"qty-btn",onclick:()=>window.changeQty(i._id,1)},"+")])]);n.appendChild(y)});e.appendChild(n)}function K(e){e.value==="0"&&(e.value=""),e.select()}function Y(e){e.value===""&&(e.value="0"),j(e.id.replace("qty-",""))}function ee(e,t){const o=document.getElementById("qty-"+e);let n=parseFloat(o.value)||0;n=Math.max(0,n+t),o.value=n,_(e,n)}function j(e){const t=document.getElementById("qty-"+e),o=Math.max(0,parseFloat(t.value)||0);t.value=o,_(e,o)}function _(e,t){const o=document.querySelector(`.product-item[data-id="${e}"]`),n=document.getElementById("qty-"+e);o&&n&&(t>0?(o.classList.add("has-qty"),n.classList.add("has-value")):(o.classList.remove("has-qty"),n.classList.remove("has-value"))),E()}function E(){let e=0;document.querySelectorAll(".product-item").forEach(t=>{const o=t.dataset.id,n=document.getElementById("qty-"+o);(parseFloat(n?.value)||0)>0&&e++}),document.getElementById("itemCount").textContent=e,document.getElementById("orderBtn").disabled=e===0||!u}const M=document.getElementById("searchInput");M&&M.addEventListener("input",e=>{const t=e.target.value.toLowerCase();document.querySelectorAll(".product-item").forEach(o=>{const n=o.querySelector(".product-name").textContent.toLowerCase();o.style.display=n.includes(t)?"":"none"}),document.querySelectorAll(".category-header").forEach(o=>{const n=o.dataset.category,r=[...document.querySelectorAll(`.product-item[data-category="${n}"]`)].some(s=>s.style.display!=="none");o.style.display=r?"":"none"})});async function te(){if(!u)return;const e=[],t=[];if(document.querySelectorAll(".product-item").forEach(n=>{const r=n.dataset.id,s=document.getElementById("qty-"+r),c=parseFloat(s?.value)||0,p=g&&parseFloat(n.dataset.price)||0,d=n.dataset.unit,y=n.querySelector(".product-name")?.textContent||"Unknown";if(c>0){d==="piece"&&!Number.isInteger(c)&&t.push(y);const f={product:r,quantity:c};g&&p>0&&(f.rate=p),e.push(f)}}),t.length>0){l(`${t.join(", ")}: use whole numbers`,"info");return}if(!e.length)return;const o=document.getElementById("orderBtn");o.disabled=!0,o.textContent="Placing...";try{const n={"Content-Type":"application/json"},r=await w.ensureCsrfToken();r&&(n["X-CSRF-Token"]=r);const s=document.getElementById("orderNotes"),i=s?.value?.trim()||"",c={customer:u._id,products:e};i&&(c.notes=i);let p=await fetch("/api/orders",{method:"POST",headers:n,credentials:"include",body:JSON.stringify(c)}),d=await p.json();if(p.status===403&&d?.message?.toLowerCase().includes("csrf")){const y=await w.refreshCsrfToken();y&&(n["X-CSRF-Token"]=y,p=await fetch("/api/orders",{method:"POST",headers:n,credentials:"include",body:JSON.stringify(c)}),d=await p.json())}if(p.ok){const y=d?.data?.orderNumber||"New";l(`Order placed! #${y}`,"success"),d.warning&&setTimeout(()=>{l(d.warning,"info")},1500),d.message&&d.newContractPrices&&d.newContractPrices.length>0&&setTimeout(()=>{l(d.message,"info")},d.warning?3e3:1500),document.querySelectorAll(".qty-input").forEach(f=>{f.value="0",f.classList.remove("has-value")}),document.querySelectorAll(".product-item").forEach(f=>{f.classList.remove("has-qty")}),s&&(s.value=""),E()}else l(d.message||"Could not place order","info")}catch(n){console.error("Order placement error:",n),navigator.onLine?l("Could not place order. Try again.","info"):l("No internet connection","info")}finally{o.disabled=!1,o.textContent="Place Order",E()}}function R(e){if(document.querySelectorAll(".order-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".order-view").forEach(t=>{t.classList.remove("active")}),e==="new"){const t=document.getElementById("newOrderView");t&&t.classList.add("active")}else if(e==="list"){const t=document.getElementById("ordersListView");t&&t.classList.add("active"),B()}}const A=document.getElementById("newOrderTab"),F=document.getElementById("myOrdersTab");A&&A.addEventListener("click",()=>R("new"));F&&F.addEventListener("click",()=>R("list"));let k=[],T="all";async function B(){const e=document.getElementById("ordersContainer");e.innerHTML="",e.appendChild(a("div",{className:"loading"},"Loading orders..."));try{const t=await fetch("/api/orders",{credentials:"include"}),o=await t.json();t.ok?(k=o.data||[],x()):(e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},o.message||"Orders not available")))}catch(t){console.error("Load orders error:",t),e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},[a("p",{},"Orders not available"),a("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:B},"Try Again")]))}}function x(){const e=document.getElementById("ordersContainer");let t=k;if(T!=="all"&&(t=k.filter(n=>n.status===T)),e.innerHTML="",!t.length){e.appendChild(a("div",{className:"empty-state"},"No orders found"));return}const o=document.createDocumentFragment();t.forEach(n=>{const r=new Date(n.createdAt).toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"numeric"}),s=[];if(n.batch?.batchType){const c=`${n.batch.batchType} Batch`;s.push(a("span",{className:"badge badge-batch"},c))}s.push(a("span",{className:`badge badge-${n.status}`},n.status));const i=a("div",{className:"order-card",onclick:()=>window.openOrderDetail(n._id)},[a("div",{className:"order-top"},[a("div",{className:"order-number"},n.orderNumber),a("div",{className:"order-products-summary"},`${n.products.length} item${n.products.length!==1?"s":""}`)]),a("div",{className:"order-bottom"},[a("div",{className:"order-date"},r),a("div",{className:"order-badges"},s)])]);o.appendChild(i)}),e.appendChild(o)}function oe(e){T=e,document.querySelectorAll(".status-pill").forEach(t=>{t.classList.toggle("active",t.dataset.status===e)}),x()}document.querySelectorAll(".status-pill").forEach(e=>{e.addEventListener("click",()=>oe(e.dataset.status))});let m=null,b=[],C=[];async function ne(e){try{const[t,o]=await Promise.all([fetch(`/api/orders/${e}`,{credentials:"include"}),fetch(`/api/invoices/my-order/${e}`,{credentials:"include"})]),n=await t.json();if(t.ok&&n.data){m=n.data,b=JSON.parse(JSON.stringify(m.products||[]));try{const r=await o.json();C=o.ok?r.data||[]:[]}catch(r){console.warn("Failed to load invoices:",r.message),C=[]}ae(),document.getElementById("orderModal").classList.add("show"),document.body.style.overflow="hidden"}else l(n.message||"Could not load order","info")}catch(t){console.error("Load order detail error:",t),l("Could not load details","info")}}function L(){document.getElementById("orderModal").classList.remove("show"),document.body.style.overflow="",m=null,b=[],C=[]}function ae(){const e=m.status==="pending",t=document.getElementById("orderModalTitle"),o=document.getElementById("orderModalBody"),n=document.getElementById("orderModalFooter");t.textContent=m.orderNumber,o.innerHTML="";const r=document.createDocumentFragment(),s=a("div",{className:"order-info-grid"},[a("div",{},[a("div",{className:"info-label"},"Status"),a("span",{className:`badge badge-${m.status}`},m.status)]),a("div",{},[a("div",{className:"info-label"},"Date"),a("div",{className:"info-value"},new Date(m.createdAt).toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"numeric"}))])]);if(m.batch?.batchType){const p=m.batch?.status==="confirmed";s.appendChild(a("div",{},[a("div",{className:"info-label"},"Batch"),a("span",{className:"badge badge-batch"},[`${m.batch.batchType} Batch`,p?" ðŸ”’":""])]))}const i=a("div",{className:"order-info-section"},[s,m.deliveryAddress?a("div",{style:{marginTop:"1rem"}},[a("div",{className:"info-label"},"Delivery Address"),a("div",{className:"info-value"},m.deliveryAddress)]):null,m.notes?a("div",{style:{marginTop:"1rem"}},[a("div",{className:"info-label"},"Notes"),a("div",{className:"info-value"},m.notes)]):null].filter(Boolean));r.appendChild(i),r.appendChild(a("div",{className:"divider"})),r.appendChild(a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Products"));const c=a("div",{id:"orderProductsList"});if(H(e,c),r.appendChild(c),C.length>0){r.appendChild(a("div",{className:"divider"})),r.appendChild(a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Invoices"));const p=a("div",{className:"invoices-list"});C.forEach(d=>{const y=new Date(d.generatedAt).toLocaleDateString("en-IN",{month:"short",day:"numeric"}),f=a("div",{className:"invoice-item",onclick:()=>window.downloadInvoice(d.invoiceNumber)},[a("div",{className:"invoice-info"},[a("div",{className:"invoice-number"},d.invoiceNumber),a("div",{className:"invoice-meta"},`${d.firm?.name||"Unknown Firm"} â€¢ ${y}`)]),a("div",{className:"invoice-download"},[])]);f.querySelector(".invoice-download").innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>`,p.appendChild(f)}),r.appendChild(p)}o.appendChild(r),n.innerHTML="",e?(n.appendChild(a("button",{className:"btn btn-secondary",onclick:()=>window.closeOrderModal()},"Cancel")),n.appendChild(a("button",{className:"btn btn-primary",style:{flex:"1"},onclick:()=>window.saveOrderEdit()},"Save Changes"))):n.appendChild(a("button",{className:"btn btn-primary btn-block",onclick:()=>window.closeOrderModal()},"Close"))}function H(e,t){t&&(t.innerHTML="",b.forEach((o,n)=>{e?t.appendChild(a("div",{className:"product-item-edit",dataset:{index:n}},[a("div",{className:"product-info"},[a("div",{className:"product-name"},o.productName),a("div",{className:"product-meta"},o.unit)]),a("div",{className:"qty-controls"},[a("button",{className:"qty-btn",onclick:()=>window.changeOrderQty(n,-1)},"âˆ’"),a("input",{type:"number",className:"qty-input",id:`order-qty-${n}`,value:o.quantity,min:"0",inputmode:"numeric",onchange:()=>window.updateOrderQtyFromInput(n)}),a("button",{className:"qty-btn",onclick:()=>window.changeOrderQty(n,1)},"+")])])):t.appendChild(a("div",{className:"product-item-edit readonly"},[a("div",{className:"product-info"},[a("div",{className:"product-name"},o.productName),a("div",{className:"product-meta"},`${o.quantity} ${o.unit}`)])]))}))}function re(e,t){const o=document.getElementById(`order-qty-${e}`);let n=parseFloat(o.value)||0;n=Math.max(0,n+t),o.value=n,b[e].quantity=n}function se(e){const t=document.getElementById(`order-qty-${e}`),o=Math.max(0,parseFloat(t.value)||0);t.value=o,b[e].quantity=o}async function ie(e){try{l("Downloading invoice...","info");const t=await fetch(`/api/invoices/my/${e}/download`,{credentials:"include"});if(!t.ok){let s="Invoice not ready yet";try{s=(await t.json()).message||s}catch(i){console.warn("Failed to parse invoice download error:",i.message),s=t.status===404?"Invoice not ready yet":t.status===403?"Invoice access pending":"Invoice temporarily unavailable"}throw new Error(s)}const o=await t.blob(),n=window.URL.createObjectURL(o),r=document.createElement("a");r.href=n,r.download=`${e}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(n),l("Invoice downloaded!","success")}catch(t){console.error("Download invoice error:",t),l(t.message||"Could not download","info")}}async function ce(){try{const e=b.filter(c=>c.quantity>0).map(c=>({product:typeof c.product=="object"?c.product._id:c.product,quantity:c.quantity}));if(!e.length){l("Add at least one product","info");return}const t=document.querySelector("#orderModalFooter .btn-primary");t&&(t.disabled=!0,t.textContent="Saving...");const o={"Content-Type":"application/json"},n=await w.ensureCsrfToken();n&&(o["X-CSRF-Token"]=n);const r={products:e};let s=await fetch(`/api/orders/${m._id}/customer-edit`,{method:"PUT",headers:o,credentials:"include",body:JSON.stringify(r)}),i=await s.json();if(s.status===403&&i?.message?.toLowerCase().includes("csrf")){const c=await w.refreshCsrfToken();c&&(o["X-CSRF-Token"]=c,s=await fetch(`/api/orders/${m._id}/customer-edit`,{method:"PUT",headers:o,credentials:"include",body:JSON.stringify(r)}),i=await s.json())}s.ok?(l("Order updated successfully","success"),L(),B()):l(i.message||"Could not update","info")}catch(e){console.error("Order edit error:",e),navigator.onLine?l("Could not update. Try again.","info"):l("No internet connection","info")}finally{const e=document.querySelector("#orderModalFooter .btn-primary");e&&(e.disabled=!1,e.textContent="Save Changes")}}const $=document.getElementById("orderModal");$&&$.addEventListener("click",e=>{e.target.id==="orderModal"&&L()});document.addEventListener("keydown",e=>{const t=document.getElementById("orderModal");e.key==="Escape"&&t&&t.classList.contains("show")&&L()});window.clearZero=K;window.restoreZero=Y;window.changeQty=ee;window.updateFromInput=j;window.placeOrder=te;window.openOrderDetail=ne;window.closeOrderModal=L;window.saveOrderEdit=ce;window.renderOrderProducts=H;window.changeOrderQty=re;window.updateOrderQtyFromInput=se;window.downloadInvoice=ie;V();
