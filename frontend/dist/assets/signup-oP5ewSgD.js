import"./responsive-C3eqjYrO.js";import"./ui-Vfn0bm3t.js";import"./api-C8X7spwu.js";import{r as k}from"./init-SLHhpTPf.js";k();const b=(e=1e4)=>new Promise((n,s)=>{const r=Date.now(),o=()=>{if(window.Auth)return n(window.Auth);if(Date.now()-r>e)return s(new Error("Auth not available"));setTimeout(o,50)};o()}),f=await b();f.ensureCsrfToken().catch(e=>console.warn("CSRF pre-fetch failed:",e));const v=document.getElementById("signupForm"),u=document.getElementById("signupBtn"),d=document.getElementById("noticeMessage"),l=document.getElementById("successMessage"),T=document.getElementById("password");T&&T.addEventListener("input",function(){const e=this.value;h("req-length",e.length>=6),h("req-upper",/[A-Z]/.test(e)),h("req-lower",/[a-z]/.test(e)),h("req-number",/[0-9]/.test(e))});function h(e,n){const s=document.getElementById(e);if(!s)return;const r=s.textContent.substring(2);n?(s.classList.add("valid"),s.textContent="✓ "+r):(s.classList.remove("valid"),s.textContent="◯ "+r)}B();async function B(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const n=await e.json();n.user.role==="customer"?window.location.href="/pages/order-form/":n.user.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/"}}catch{}}v&&v.addEventListener("submit",async e=>{e.preventDefault();const n=document.getElementById("name").value.trim(),s=document.getElementById("email").value.trim(),r=document.getElementById("phone").value.trim(),o=document.getElementById("password").value,p=document.getElementById("confirmPassword").value;if(!n||!s||!o||!p){t("Please complete all required fields");return}if(o.length<6){t("Password needs at least 6 characters");return}if(!/[A-Z]/.test(o)){t("Add an uppercase letter to password");return}if(!/[a-z]/.test(o)){t("Add a lowercase letter to password");return}if(!/[0-9]/.test(o)){t("Add a number to password");return}if(o!==p){t("Passwords don't match");return}if(r&&!/^[0-9]{10}$/.test(r)){t("Phone should be 10 digits");return}u.disabled=!0,u.textContent="Creating account...",L();try{const i={name:n,email:s,password:o,role:"customer"};r&&(i.phone=r);const m={"Content-Type":"application/json"},y=await f.ensureCsrfToken();y&&(m["X-CSRF-Token"]=y);const g=await fetch("/api/auth/register",{method:"POST",headers:m,credentials:"include",body:JSON.stringify(i)}),a=await g.json();if(g.status===403&&a?.message?.toLowerCase().includes("csrf")){console.log("CSRF error, refreshing token and retrying...");const w=await f.refreshCsrfToken();if(w){m["X-CSRF-Token"]=w;const C=await fetch("/api/auth/register",{method:"POST",headers:m,credentials:"include",body:JSON.stringify(i)}),c=await C.json();if(C.ok){f.setUser(c.user),A("Account created successfully! Redirecting..."),setTimeout(()=>{c.user.role==="customer"?window.location.href="/pages/order-form/":c.user.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/"},1500);return}c.errors&&c.errors.length>0?t(c.errors.map(E=>E.msg).join(", ")):t(c.message||"Could not create account. Try again.");return}}g.ok?(f.setUser(a.user),A("Account created successfully! Redirecting..."),setTimeout(()=>{a.user.role==="customer"?window.location.href="/pages/order-form/":a.user.role==="staff"?window.location.href="/pages/staff-dashboard/":window.location.href="/"},1500)):a.errors&&a.errors.length>0?t(a.errors.map(w=>w.msg).join(", ")):t(a.message||"Could not create account. Try again.")}catch(i){console.error("Signup error:",i),navigator.onLine?i.name==="TypeError"||i.message.includes("fetch")?t("Connection issue. Please try again."):t("Something went wrong. Try again."):t("No internet connection")}finally{u&&(u.disabled=!1,u.textContent="Create Account")}});function t(e){d&&(d.textContent=e,d.classList.add("show"),l&&l.classList.remove("show"))}function A(e){l&&(l.textContent=e,l.classList.add("show"),d&&d.classList.remove("show"))}function L(){d&&d.classList.remove("show"),l&&l.classList.remove("show")}
