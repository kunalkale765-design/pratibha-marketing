import"./responsive-C3eqjYrO.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               *//* empty css                            */import{s as r,c as a}from"./ui-C7t5s6-T.js";const q=(e=1e4)=>new Promise((t,n)=>{const o=Date.now(),s=()=>{if(window.Auth)return t(window.Auth);if(Date.now()-o>e)return n(new Error("Auth not available"));setTimeout(s,50)};s()}),u=await q();let f=[],k=[],h={},b="",F=!1,y=!1;async function R(){u.ensureCsrfToken().catch(t=>console.warn("CSRF pre-fetch failed:",t)),await u.requireAuth(["admin","staff"])&&await Promise.all([w(),A()])}async function A(){try{const e=await fetch("/api/products",{credentials:"include"});if(e.status===401){window.location.href="/pages/auth/login.html";return}if(!e.ok)throw new Error(`Server returned ${e.status}`);k=(await e.json()).data||[]}catch(e){console.error("Failed to load products:",e),r("Products not available. Try again.","info")}}async function w(){try{const t=await fetch(F?"/api/customers?includeTest=true":"/api/customers",{credentials:"include"});if(t.status===401){window.location.href="/pages/auth/login.html";return}if(!t.ok)throw new Error(`Server returned ${t.status}`);f=(await t.json()).data||[],D(f)}catch(e){console.error("Failed to load customers:",e);const t=document.getElementById("customersList"),n=navigator.onLine?"Customers not available":"No internet connection";t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},[a("p",{},n),a("button",{id:"retryCustomersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:w},"Try Again")]))}}function x(e){const t=e.pricingType||"market";return t==="contract"?a("span",{className:"badge badge-contract"},"Contract"):t==="markup"?a("span",{className:"badge badge-markup"},`+${e.markupPercentage||0}%`):a("span",{className:"badge badge-market"},"Market")}function D(e){const t=document.getElementById("customersList");if(!e||!e.length){t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},"No customers found"));return}t.innerHTML="";const n=document.createDocumentFragment();e.forEach((o,s)=>{const c=[];o.phone&&c.push(a("span",{},o.phone)),o.address&&c.push(a("span",{},o.address));const i=[a("button",{onclick:()=>window.shareMagicLink(o._id),className:"btn-action link",title:"Share order link"},"Link")];o.pricingType==="contract"&&i.push(a("button",{onclick:()=>window.openContractPrices(o._id),className:"btn-action"},"Prices")),i.push(a("button",{onclick:()=>window.editCustomerById(o._id),className:"btn-action primary"},"Edit")),i.push(a("button",{onclick:()=>window.deleteCustomer(o._id),className:"btn-action danger"},"Delete"));const d=[x(o)];o.balance>0&&d.push(a("span",{className:"balance-badge",style:{color:"var(--error)",fontSize:"0.75rem",fontWeight:"600"}},`₹${o.balance}`)),o.isTestCustomer&&d.unshift(a("span",{className:"badge badge-test"},"Test"));const l=a("div",{className:`customer-card card-animated card-fade-in${o.isTestCustomer?" test-customer":""}`,style:{animationDelay:`${s*.05}s`}},[a("div",{className:"customer-header"},[a("div",{className:"customer-name"},o.name),a("div",{className:"customer-badges"},d)]),a("div",{className:"customer-details"},c),a("div",{className:"customer-actions"},i)]);n.appendChild(l)}),t.appendChild(n)}function X(){const e=document.getElementById("searchInput").value.toLowerCase(),t=f.filter(n=>n.name.toLowerCase().includes(e)||n.phone&&n.phone.includes(e));D(t)}function T(){const e=document.getElementById("customerPricingType").value;document.getElementById("markupField").classList.toggle("hidden",e!=="markup"),document.getElementById("contractInfo").classList.toggle("hidden",e!=="contract")}function H(){document.getElementById("modalTitle").textContent="Add Customer",document.getElementById("customerForm").reset(),document.getElementById("customerId").value="",document.getElementById("customerIsTest").checked=!1,document.getElementById("customerPricingType").value="market",T(),document.getElementById("customerModal").classList.add("show"),setTimeout(()=>{y=!1},0)}function W(e){document.getElementById("modalTitle").textContent="Edit Customer",document.getElementById("customerId").value=e._id,document.getElementById("customerName").value=e.name,document.getElementById("customerPhone").value=e.phone||"",document.getElementById("customerWhatsapp").value=e.whatsapp||"",document.getElementById("customerAddress").value=e.address||"",document.getElementById("customerIsTest").checked=e.isTestCustomer||!1,document.getElementById("customerPricingType").value=e.pricingType||"market",document.getElementById("customerMarkup").value=e.markupPercentage||0,T(),document.getElementById("customerModal").classList.add("show"),setTimeout(()=>{y=!1},0)}function B(){y&&!confirm("You have unsaved changes. Discard them?")||(y=!1,document.getElementById("customerModal").classList.remove("show"))}function J(){const e=document.getElementById("customerForm");e&&(e.addEventListener("input",()=>{y=!0}),e.addEventListener("change",()=>{y=!0}),e.addEventListener("submit",async t=>{t.preventDefault();const n=document.getElementById("saveCustomerBtn"),o=document.getElementById("customerId").value,s=document.getElementById("customerPricingType").value,c=document.getElementById("customerName").value.trim(),i=document.getElementById("customerPhone").value.trim(),d=document.getElementById("customerWhatsapp").value.trim();if(!c){r("Please enter customer name","info"),document.getElementById("customerName").focus();return}if(i&&!/^[0-9]{10}$/.test(i)){r("Phone should be 10 digits","info"),document.getElementById("customerPhone").focus();return}if(d&&!/^[0-9]{10}$/.test(d)){r("WhatsApp should be 10 digits","info"),document.getElementById("customerWhatsapp").focus();return}const l=parseFloat(document.getElementById("customerMarkup").value)||0;if(s==="markup"&&(l<0||l>200)){r("Markup should be 0-200%","info"),document.getElementById("customerMarkup").focus();return}n.classList.add("btn-loading"),n.disabled=!0;const m={name:c,phone:i,whatsapp:d,address:document.getElementById("customerAddress").value.trim(),isTestCustomer:document.getElementById("customerIsTest").checked,pricingType:s,markupPercentage:s==="markup"?l:0};try{const v=o?`/api/customers/${o}`:"/api/customers",P=o?"PUT":"POST",E={"Content-Type":"application/json"},N=await u.ensureCsrfToken();N&&(E["X-CSRF-Token"]=N);let C=await fetch(v,{method:P,headers:E,credentials:"include",body:JSON.stringify(m)});if(C.status===403){const g=await C.json();if(g.message?.toLowerCase().includes("csrf")){const p=await u.refreshCsrfToken();p&&(E["X-CSRF-Token"]=p,C=await fetch(v,{method:P,headers:E,credentials:"include",body:JSON.stringify(m)}))}else{const p=g.errors?.[0]?.msg||g.message||"Could not save. Try again.";r(p,"info"),n.classList.remove("btn-loading"),n.disabled=!1;return}}if(C.ok)n.classList.remove("btn-loading"),n.classList.add("btn-success"),r(o?"Customer updated":"Customer added","success"),setTimeout(()=>{n.classList.remove("btn-success"),B()},800),w();else{const g=await C.json(),p=g.errors?.[0]?.msg||g.message||"Could not save. Try again.";r(p,"info")}}catch(v){console.error("Save customer error:",v),navigator.onLine?r("Could not save. Please try again.","info"):r("No internet connection","info")}finally{n.classList.remove("btn-loading"),n.disabled=!1}}))}async function $(e,t=!1){if(!t&&!confirm("Delete this customer?"))return;document.querySelectorAll(".btn-action.danger").forEach(o=>{o.disabled=!0});try{const o={},s=await u.ensureCsrfToken();s&&(o["X-CSRF-Token"]=s);const c=await fetch(`/api/customers/${e}`,{method:"DELETE",headers:o,credentials:"include"});if(c.status===403&&!t){const i=await c.json();if(i.message?.toLowerCase().includes("csrf"))return await u.refreshCsrfToken(),$(e,!0);r(i.message||"Could not delete","info");return}if(c.ok)r("Customer deleted","success"),w();else{const i=await c.json();r(i.message||"Could not delete","info")}}catch(o){console.error("Delete customer error:",o),navigator.onLine?r("Could not delete. Please try again.","info"):r("No internet connection","info")}finally{document.querySelectorAll(".btn-action.danger").forEach(s=>{s.disabled=!1})}}function U(e){const t=f.find(n=>n._id===e);t&&W(t)}async function j(e,t=!1){const n=f.find(s=>s._id===e);if(!n){r("Customer data updating. Please refresh.","info");return}document.querySelectorAll(".btn-action.link").forEach(s=>{s.disabled=!0});try{const s={},c=await u.ensureCsrfToken();c&&(s["X-CSRF-Token"]=c);const i=await fetch(`/api/customers/${e}/magic-link`,{method:"POST",headers:s,credentials:"include"}),d=await i.json();if(i.status===403&&d?.message?.toLowerCase().includes("csrf")&&!t)return await u.refreshCsrfToken(),j(e,!0);if(i.ok&&d.data){const l=d.data.link;if(navigator.clipboard?(await navigator.clipboard.writeText(l),r(`Link copied for ${n.name}`,"success")):prompt("Copy this order link:",l),navigator.share)try{await navigator.share({title:"Pratibha Marketing - Order",text:`Place your order here, ${n.name}`,url:l})}catch(m){m.name!=="AbortError"&&console.warn("Share API failed:",m.name,m.message)}}else r(d.message||"Could not generate link","info")}catch(s){console.error("Magic link error:",s),navigator.onLine?r("Could not generate link. Try again.","info"):r("No internet connection","info")}finally{document.querySelectorAll(".btn-action.link").forEach(c=>{c.disabled=!1})}}async function z(e){const t=f.find(n=>n._id===e);if(!t){r("Customer data updating. Please refresh.","info");return}k.length||await A(),document.getElementById("contractCustomerId").value=e,document.getElementById("contractCustomerName").textContent=t.name,t.contractPrices instanceof Map?h=Object.fromEntries(t.contractPrices):h=t.contractPrices||{},V(),b="",document.getElementById("productSearch").value="",O(k),document.getElementById("contractModal").classList.add("show")}function V(){const e=[...new Set(k.map(o=>o.category||"Other"))].sort(),t=document.getElementById("contractCategoryPills");t.innerHTML="";const n=document.createDocumentFragment();n.appendChild(a("button",{className:"cat-pill active",dataset:{category:""},onclick:()=>window.filterByContractCategory("")},"All")),e.forEach(o=>{const s=o.replace(/-/g," ").replace(/\b\w/g,c=>c.toUpperCase());n.appendChild(a("button",{className:"cat-pill",dataset:{category:o},onclick:()=>window.filterByContractCategory(o)},s))}),t.appendChild(n)}function O(e){const t=document.getElementById("contractPricesList");t.innerHTML="";const n=document.createDocumentFragment();e.forEach(o=>{const s=h[o._id]||"",c=a("div",{className:"contract-item"},[a("div",{className:"contract-item-info"},[a("div",{className:"contract-item-name"},o.name),a("div",{className:"contract-item-base"},`per ${o.unit}`)]),a("input",{type:"number",step:"0.01",min:"0",className:"contract-price-input input-animated",dataset:{productId:o._id},value:String(s),placeholder:"₹"}),a("span",{className:"contract-item-unit"},`/${o.unit}`)]);n.appendChild(c)}),t.appendChild(n)}function I(){document.querySelectorAll(".contract-price-input").forEach(e=>{const t=e.dataset.productId,n=parseFloat(e.value);!isNaN(n)&&n>0?h[t]=n:delete h[t]})}function _(){I();const e=document.getElementById("productSearch").value.toLowerCase(),t=k.filter(n=>{const o=n.name.toLowerCase().includes(e),s=!b||(n.category||"Other")===b;return o&&s});O(t)}function Y(e){I(),b=e,document.querySelectorAll("#contractCategoryPills .cat-pill").forEach(t=>{t.classList.toggle("active",t.dataset.category===e)}),_()}async function G(){const e=document.getElementById("contractCustomerId").value,t=f.find(s=>s._id===e);if(!t){r("Customer data updating. Please refresh.","info");return}const n=document.getElementById("saveContractBtn");n.classList.add("btn-loading"),n.disabled=!0,I();const o={...h};try{const s={"Content-Type":"application/json"},c=await u.ensureCsrfToken();c&&(s["X-CSRF-Token"]=c);const i={name:t.name,phone:t.phone,contractPrices:o};let d=await fetch(`/api/customers/${e}`,{method:"PUT",headers:s,credentials:"include",body:JSON.stringify(i)});if(d.status===403){const l=await d.json();if(l.message?.toLowerCase().includes("csrf")){const m=await u.refreshCsrfToken();m&&(s["X-CSRF-Token"]=m,d=await fetch(`/api/customers/${e}`,{method:"PUT",headers:s,credentials:"include",body:JSON.stringify(i)}))}else{r(l.message||"Could not save","info");return}}if(d.ok)n.classList.remove("btn-loading"),n.classList.add("btn-success"),r("Prices saved","success"),setTimeout(()=>{n.classList.remove("btn-success"),L()},800),w();else{const l=await d.json();r(l.errors?.[0]?.msg||l.message||"Could not save","info")}}catch(s){console.error("Save contract prices error:",s),navigator.onLine?r("Could not save prices. Try again.","info"):r("No internet connection","info")}finally{n.classList.remove("btn-loading"),n.disabled=!1}}function L(){document.getElementById("contractModal").classList.remove("show"),document.getElementById("productSearch").value=""}function K(){F=document.getElementById("showTestCustomers").checked,w()}window.showAddCustomerForm=H;window.searchCustomers=X;window.toggleMarkupField=T;window.toggleTestCustomers=K;window.closeModal=B;window.editCustomerById=U;window.deleteCustomer=$;window.shareMagicLink=j;window.openContractPrices=z;window.filterContractProducts=_;window.filterByContractCategory=Y;window.saveContractPrices=G;window.closeContractModal=L;const M=document.getElementById("customerModal");M&&(M.onclick=e=>{e.target.id==="customerModal"&&B()});const S=document.getElementById("contractModal");S&&(S.onclick=e=>{e.target.id==="contractModal"&&L()});J();R();
