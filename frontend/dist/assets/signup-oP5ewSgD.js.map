{"version":3,"file":"signup-oP5ewSgD.js","sources":["../../src/js/pages/signup.js"],"sourcesContent":["import { registerServiceWorker } from '/js/init.js';\n\n// Initialize\nregisterServiceWorker();\n\n// Wait for Auth to be available (loaded from auth.js module)\nconst waitForAuth = (maxWait = 10000) => new Promise((resolve, reject) => {\n    const startTime = Date.now();\n    const check = () => {\n        if (window.Auth) return resolve(window.Auth);\n        if (Date.now() - startTime > maxWait) return reject(new Error('Auth not available'));\n        setTimeout(check, 50);\n    };\n    check();\n});\nconst Auth = await waitForAuth();\n\n// Pre-fetch CSRF token to ensure it's ready before form submission\nAuth.ensureCsrfToken().catch(err => console.warn('CSRF pre-fetch failed:', err));\n\n// Elements\nconst signupForm = document.getElementById('signupForm');\nconst signupBtn = document.getElementById('signupBtn');\nconst noticeMessage = document.getElementById('noticeMessage');\nconst successMessage = document.getElementById('successMessage');\nconst password = document.getElementById('password');\n\n// Password requirement validation\nif (password) {\n    password.addEventListener('input', function () {\n        const val = this.value;\n        updateRequirement('req-length', val.length >= 6);\n        updateRequirement('req-upper', /[A-Z]/.test(val));\n        updateRequirement('req-lower', /[a-z]/.test(val));\n        updateRequirement('req-number', /[0-9]/.test(val));\n    });\n}\n\nfunction updateRequirement(id, valid) {\n    const el = document.getElementById(id);\n    if (!el) return;\n    const text = el.textContent.substring(2);\n    if (valid) {\n        el.classList.add('valid');\n        el.textContent = '✓ ' + text;\n    } else {\n        el.classList.remove('valid');\n        el.textContent = '◯ ' + text;\n    }\n}\n\n// Check if already logged in\ncheckAuth();\n\nasync function checkAuth() {\n    try {\n        const response = await fetch('/api/auth/me', { credentials: 'include' });\n        if (response.ok) {\n            const data = await response.json();\n            if (data.user.role === 'customer') {\n                window.location.href = '/pages/order-form/';\n            } else if (data.user.role === 'staff') {\n                window.location.href = '/pages/staff-dashboard/';\n            } else {\n                window.location.href = '/';\n            }\n        }\n    } catch (_error) {\n        // Not logged in - stay on signup page\n    }\n}\n\n// Form submission\nif (signupForm) {\n    signupForm.addEventListener('submit', async (e) => {\n        e.preventDefault();\n\n        const name = document.getElementById('name').value.trim();\n        const email = document.getElementById('email').value.trim();\n        const phone = document.getElementById('phone').value.trim();\n        const passwordVal = document.getElementById('password').value;\n        const confirmPassword = document.getElementById('confirmPassword').value;\n\n        // Validation\n        if (!name || !email || !passwordVal || !confirmPassword) {\n            showNotice('Please complete all required fields');\n            return;\n        }\n\n        if (passwordVal.length < 6) {\n            showNotice('Password needs at least 6 characters');\n            return;\n        }\n\n        if (!/[A-Z]/.test(passwordVal)) {\n            showNotice('Add an uppercase letter to password');\n            return;\n        }\n\n        if (!/[a-z]/.test(passwordVal)) {\n            showNotice('Add a lowercase letter to password');\n            return;\n        }\n\n        if (!/[0-9]/.test(passwordVal)) {\n            showNotice('Add a number to password');\n            return;\n        }\n\n        if (passwordVal !== confirmPassword) {\n            showNotice('Passwords don\\'t match');\n            return;\n        }\n\n        if (phone && !/^[0-9]{10}$/.test(phone)) {\n            showNotice('Phone should be 10 digits');\n            return;\n        }\n\n        signupBtn.disabled = true;\n        signupBtn.textContent = 'Creating account...';\n        hideAllMessages();\n\n        try {\n            const userData = { name, email, password: passwordVal, role: 'customer' };\n            if (phone) userData.phone = phone;\n\n            const headers = { 'Content-Type': 'application/json' };\n            // Ensure CSRF token is available (fetches from server if missing)\n            const csrfToken = await Auth.ensureCsrfToken();\n            if (csrfToken) {\n                headers['X-CSRF-Token'] = csrfToken;\n            }\n\n            const response = await fetch('/api/auth/register', {\n                method: 'POST',\n                headers,\n                credentials: 'include',\n                body: JSON.stringify(userData)\n            });\n\n            const data = await response.json();\n\n            // Handle CSRF error with automatic retry\n            if (response.status === 403 && data?.message?.toLowerCase().includes('csrf')) {\n                console.log('CSRF error, refreshing token and retrying...');\n                const newToken = await Auth.refreshCsrfToken();\n                if (newToken) {\n                    headers['X-CSRF-Token'] = newToken;\n                    const retryResponse = await fetch('/api/auth/register', {\n                        method: 'POST',\n                        headers,\n                        credentials: 'include',\n                        body: JSON.stringify(userData)\n                    });\n                    const retryData = await retryResponse.json();\n                    if (retryResponse.ok) {\n                        Auth.setUser(retryData.user);\n                        showSuccess('Account created successfully! Redirecting...');\n                        setTimeout(() => {\n                            if (retryData.user.role === 'customer') {\n                                window.location.href = '/pages/order-form/';\n                            } else if (retryData.user.role === 'staff') {\n                                window.location.href = '/pages/staff-dashboard/';\n                            } else {\n                                window.location.href = '/';\n                            }\n                        }, 1500);\n                        return;\n                    }\n                    if (retryData.errors && retryData.errors.length > 0) {\n                        showNotice(retryData.errors.map(e => e.msg).join(', '));\n                    } else {\n                        showNotice(retryData.message || 'Could not create account. Try again.');\n                    }\n                    return;\n                }\n            }\n\n            if (response.ok) {\n                Auth.setUser(data.user);\n                showSuccess('Account created successfully! Redirecting...');\n                setTimeout(() => {\n                    if (data.user.role === 'customer') {\n                        window.location.href = '/pages/order-form/';\n                    } else if (data.user.role === 'staff') {\n                        window.location.href = '/pages/staff-dashboard/';\n                    } else {\n                        window.location.href = '/';\n                    }\n                }, 1500);\n            } else {\n                if (data.errors && data.errors.length > 0) {\n                    showNotice(data.errors.map(e => e.msg).join(', '));\n                } else {\n                    showNotice(data.message || 'Could not create account. Try again.');\n                }\n            }\n        } catch (error) {\n            console.error('Signup error:', error);\n            if (!navigator.onLine) {\n                showNotice('No internet connection');\n            } else if (error.name === 'TypeError' || error.message.includes('fetch')) {\n                showNotice('Connection issue. Please try again.');\n            } else {\n                showNotice('Something went wrong. Try again.');\n            }\n        } finally {\n            if (signupBtn) {\n                signupBtn.disabled = false;\n                signupBtn.textContent = 'Create Account';\n            }\n        }\n    });\n}\n\nfunction showNotice(message) {\n    if (noticeMessage) {\n        noticeMessage.textContent = message;\n        noticeMessage.classList.add('show');\n        if (successMessage) successMessage.classList.remove('show');\n    }\n}\n\nfunction showSuccess(message) {\n    if (successMessage) {\n        successMessage.textContent = message;\n        successMessage.classList.add('show');\n        if (noticeMessage) noticeMessage.classList.remove('show');\n    }\n}\n\nfunction hideAllMessages() {\n    if (noticeMessage) noticeMessage.classList.remove('show');\n    if (successMessage) successMessage.classList.remove('show');\n}\n"],"names":["registerServiceWorker","waitForAuth","maxWait","resolve","reject","startTime","check","Auth","err","signupForm","signupBtn","noticeMessage","successMessage","password","val","updateRequirement","id","valid","el","text","checkAuth","response","data","name","email","phone","passwordVal","confirmPassword","showNotice","hideAllMessages","userData","headers","csrfToken","newToken","retryResponse","retryData","showSuccess","e","error","message"],"mappings":"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"}