import"./responsive-D1ZTW0b0.js";/* empty css               *//* empty css                *//* empty css              */import{t as p}from"./ui-Bns_kLia.js";import"./api-CCOw0EgE.js";import{r as y}from"./init-CHmvMvUV.js";y();const k=(e=1e4)=>new Promise((s,o)=>{const t=Date.now(),i=()=>{if(window.Auth)return s(window.Auth);if(Date.now()-t>e)return o(new Error("Auth not available"));setTimeout(i,50)};i()}),l=await k();l.ensureCsrfToken().catch(e=>console.warn("CSRF pre-fetch failed:",e));const w=document.getElementById("loginForm"),d=document.getElementById("loginBtn"),n=document.getElementById("noticeMessage"),u=document.getElementById("passwordToggle");u&&u.addEventListener("click",()=>{p("password",u)});T();async function T(){try{const e=await fetch("/api/auth/me",{credentials:"include"});e.ok&&((await e.json()).user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/")}catch{}}w&&w.addEventListener("submit",async e=>{e.preventDefault();const s=document.getElementById("email").value.trim(),o=document.getElementById("password").value;if(!s||!o){a("Please enter username and password");return}d.disabled=!0,d.classList.add("btn-loading"),C();try{const t={"Content-Type":"application/json"},i=await l.ensureCsrfToken();i&&(t["X-CSRF-Token"]=i);const c=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:s,password:o})}),r=await c.json();if(c.status===403&&r?.message?.toLowerCase().includes("csrf")){console.log("CSRF error, refreshing token and retrying...");const m=await l.refreshCsrfToken();if(m){t["X-CSRF-Token"]=m;const g=await fetch("/api/auth/login",{method:"POST",headers:t,credentials:"include",body:JSON.stringify({email:s,password:o})}),f=await g.json();if(g.ok){l.setUser(f.user),f.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/";return}a(f.message||"Please check your credentials");return}}c.ok?(l.setUser(r.user),r.user.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/"):a(r.message||"Please check your credentials")}catch(t){console.error("Login error:",t),navigator.onLine?t.name==="TypeError"||t.message.includes("fetch")?a("Connection issue. Please try again."):a("Something went wrong. Try again."):a("No internet connection")}finally{d&&(d.disabled=!1,d.classList.remove("btn-loading"))}});function a(e){n&&(n.textContent=e,n.classList.add("show"))}function C(){n&&n.classList.remove("show")}const h=document.getElementById("forgotPasswordLink");h&&h.addEventListener("click",async e=>{e.preventDefault();const s=document.getElementById("email").value.trim();if(!s){a("Please enter your username first");return}try{const o={"Content-Type":"application/json"},t=await l.ensureCsrfToken();t&&(o["X-CSRF-Token"]=t);const i=await fetch("/api/auth/forgot-password",{method:"POST",headers:o,credentials:"include",body:JSON.stringify({email:s})}),c=await i.json();if(i.ok&&c.resetUrl){n.textContent="",n.appendChild(document.createTextNode("Reset link generated! "));const r=document.createElement("a");r.href=c.resetUrl,r.style.cssText="color: var(--dusty-olive); text-decoration: underline;",r.textContent="Click here to reset",n.appendChild(r),n.classList.add("show"),n.classList.remove("error")}else a(c.message||"If an account exists, a reset link has been generated")}catch(o){console.error("Forgot password error:",o),a("Could not process request. Try again.")}});
