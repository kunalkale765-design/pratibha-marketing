import{s as u,c as n}from"./ui-Usu6AxiT.js";/* empty css             *//* empty css               *//* empty css                *//* empty css               */import"./api-BESsD5Cs.js";const ee=()=>new Promise(e=>{window.Auth?e(window.Auth):setTimeout(()=>e(ee()),10)}),O=await ee();let M=[],z={},te=[],p=[],X="all",q=null,N=null,b=null,C={},w={},T=!1,x=!1;async function re(){if(b=await O.requireAuth(),!!b){if(b.role==="customer"){const e=document.getElementById("modalFooter");e&&(e.style.display="none")}ce(),await Promise.all([D(),de(),le()]),me(),fe()}}function ce(){if(x)return;x=!0;const e=document.getElementById("ordersList");if(!e)return;document.addEventListener("click",s=>{s.target.closest(".swipe-item")||document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(r=>{r.classList.remove("swiped","swiped-single")})});let t={startX:0,isDragging:!1,currentItem:null};e.addEventListener("touchstart",s=>{const r=s.target.closest(".swipe-item");r&&(t={startX:s.touches[0].clientX,isDragging:!0,currentItem:r},document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(c=>{c!==r&&c.classList.remove("swiped","swiped-single")}))},{passive:!0}),e.addEventListener("touchmove",s=>{if(!t.isDragging||!t.currentItem)return;const r=b?.role==="admin",c=t.startX-s.touches[0].clientX;c>50?(t.currentItem.classList.remove("swiped-single","swiped"),t.currentItem.classList.add(r?"swiped":"swiped-single")):c<-20&&t.currentItem.classList.remove("swiped","swiped-single")},{passive:!0}),e.addEventListener("touchend",()=>{t.isDragging=!1,t.currentItem=null},{passive:!0});const o=document.getElementById("orderModal");o&&(o.onclick=s=>{s.target.id==="orderModal"&&R()});const a=document.getElementById("invoiceModal");a&&(a.onclick=s=>{s.target.id==="invoiceModal"&&Y()})}async function de(){try{const e=await fetch("/api/market-rates",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);((await e.json()).data||[]).forEach(o=>{const a=typeof o.product=="object"?o.product._id:o.product;z[a]=o.rate})}catch(e){console.error("Failed to load market rates:",e)}}async function le(){try{const e=await fetch("/api/products",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);te=((await e.json()).data||[]).filter(o=>o.isActive!==!1)}catch(e){console.error("Failed to load products:",e)}}async function D(){try{const e=await fetch("/api/orders?limit=100",{credentials:"include"});if(!e.ok)throw new Error(`Server returned ${e.status}`);const t=await e.json();if(!t.success)throw new Error(t.message||"Orders temporarily unavailable");M=t.data||[];const o=M.filter(a=>!a._id||!/^[a-f\d]{24}$/i.test(a._id));o.length>0&&console.warn("Orders with invalid IDs:",o.map(a=>({orderNumber:a.orderNumber,_id:a._id}))),Z()}catch(e){if(console.error("Failed to load orders:",e),!M||M.length===0){const t=document.getElementById("ordersList"),o=navigator.onLine?"Orders not available":"No internet connection";t.innerHTML="",t.appendChild(n("div",{className:"empty-state"},[n("p",{},o),n("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:D},"Try Again")]))}}}function ue(e){if(!e)return"?";const t=e.trim().split(/\s+/);return t.length===1?t[0].substring(0,2).toUpperCase():(t[0][0]+t[t.length-1][0]).toUpperCase()}function Z(){const e=document.getElementById("ordersList");if(!e)return;const t=document.getElementById("searchInput"),o=t?t.value.toLowerCase():"",a=b?.role==="admin",s=b?.role==="admin"||b?.role==="staff";let r=M.filter(i=>i._id&&/^[a-f\d]{24}$/i.test(i._id));if(X==="all"?r=r.filter(i=>i.status!=="cancelled"):r=r.filter(i=>i.status===X),o&&(r=r.filter(i=>i.orderNumber?.toLowerCase().includes(o)||i.customer?.name?.toLowerCase().includes(o))),!r.length){e.innerHTML="",e.appendChild(n("div",{className:"empty-state"},"No orders found"));return}e.innerHTML="";const c=document.createDocumentFragment();r.forEach((i,g)=>{let m=null;i.batch?.batchType&&(m=n("span",{className:"badge badge-batch"},[i.batch.batchType,i.batchLocked?" ðŸ”’":""]));const h=n("div",{className:"swipe-content",onclick:()=>window.viewOrder(i._id)},[n("div",{className:"order-avatar"},ue(i.customer?.name)),n("div",{className:"order-info"},[n("div",{className:"order-customer"},i.customer?.name||"Unknown"),i.notes?n("div",{className:"order-notes"},i.notes):null,n("div",{className:"order-meta-row"},[n("span",{className:"order-number"},`Order #${i.orderNumber}`),m])]),n("div",{className:"order-amount-pill"},`â‚¹${(i.totalAmount||0).toLocaleString("en-IN")}`)]),d=[];s&&d.push(n("button",{className:"swipe-action edit",onclick:v=>{v.stopPropagation(),window.printOrder(i._id)}},"Print")),a&&d.push(n("button",{className:"swipe-action delete",onclick:v=>{v.stopPropagation(),window.deleteOrder(i._id)}},"Delete"));const y=n("div",{className:"swipe-actions"},d),$=n("div",{className:"swipe-item card-fade-in",dataset:{orderId:i._id},style:{animationDelay:`${g*.05}s`}},[h,y]);c.appendChild($)}),e.appendChild(c)}function me(){const e=document.getElementById("filterSegments"),t=document.getElementById("segmentIndicator"),o=e.querySelectorAll(".segment-btn");function a(r){const c=e.getBoundingClientRect(),i=r.getBoundingClientRect(),g=i.left-c.left,m=i.width;t.style.left=g+"px",t.style.width=m+"px"}const s=e.querySelector(".segment-btn.active");s&&setTimeout(()=>a(s),10),o.forEach(r=>{r.onclick=()=>{o.forEach(i=>i.classList.remove("active")),r.classList.add("active"),a(r),X=r.dataset.filter;const c=document.getElementById("ordersList");c.classList.add("segment-content"),Z(),setTimeout(()=>c.classList.remove("segment-content"),300)}}),window.addEventListener("resize",()=>{const r=e.querySelector(".segment-btn.active");r&&a(r)})}function pe(e,t){let o;return function(...a){clearTimeout(o),o=setTimeout(()=>e.apply(this,a),t)}}function fe(){const e=document.getElementById("searchInput");if(e){const t=pe(Z,200);e.addEventListener("input",t)}}let E=null,S=null,L=new Set;async function J(e){if(b?.role==="customer"){u("Invoice printing is not available","info");return}document.querySelectorAll(".swipe-item.swiped, .swipe-item.swiped-single").forEach(s=>{s.classList.remove("swiped","swiped-single")});const t=/^[a-f\d]{24}$/i.test(e);if(!e||!t){console.error("Invalid order ID:",e),u("Order data updating. Please refresh.","info");return}document.getElementById("invoiceModal").classList.add("show"),document.getElementById("invoiceModal").classList.add("show");const o=document.getElementById("invoiceModalBody");o.innerHTML="",o.appendChild(n("div",{className:"invoice-loading"},"Loading invoice data..."));const a=document.getElementById("generateInvoiceBtn");a&&(a.disabled=!0);try{await ge();const s=await fetch(`/api/invoices/${e}/split`,{credentials:"include"});if(!s.ok){const c=await s.json().catch(()=>({}));throw new Error(c.message||"Invoice data temporarily unavailable")}E=(await s.json()).data,document.getElementById("invoiceModalTitle").textContent=`Invoice for ${E.orderNumber}`,G()}catch(s){console.error("Print order error:",s),document.getElementById("invoiceModalBody").innerHTML="",document.getElementById("invoiceModalBody").appendChild(n("div",{className:"invoice-no-items"},[n("p",{},"Invoice data not available"),n("p",{style:{fontSize:"0.75rem",marginTop:"0.5rem"}},s.message)]))}}let P=[];async function ge(){if(!(P.length>0))try{const e=await fetch("/api/invoices/firms",{credentials:"include"});e.ok&&(P=(await e.json()).data||[])}catch(e){console.error("Failed to load firms:",e)}}function G(){const e=document.getElementById("invoiceModalBody");if(!E){e.innerHTML="",e.appendChild(n("div",{className:"invoice-no-items"},"No items to invoice"));return}const t=E.firms.flatMap(i=>i.items);if(t.length===0){e.innerHTML="",e.appendChild(n("div",{className:"invoice-no-items"},"No items to invoice"));return}S||(S=P.length>0?P[0].id:E?.firms?.[0]?.firmId||"pratibha",L=new Set(t.map(i=>i.productId)));const o=t.filter(i=>L.has(i.productId)).reduce((i,g)=>i+(g.amount||0),0),a=P.length>0?P:(E?.firms||[]).map(i=>({id:i.firmId,name:i.firmName}));e.innerHTML="";const s=document.createDocumentFragment(),r=n("div",{className:"invoice-firm-selector"},[n("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Select Firm"),n("div",{className:"firm-options"},a.map(i=>n("label",{className:`firm-option ${S===i.id?"selected":""}`,onclick:()=>window.selectFirm(i.id)},[n("input",{type:"radio",name:"firm",value:i.id,checked:S===i.id}),n("span",{className:"firm-option-name"},i.name)])))]);s.appendChild(r),s.appendChild(n("div",{className:"info-label",style:{margin:"1rem 0 0.5rem"}},"Select Items")),s.appendChild(n("div",{className:"invoice-items-list"},t.map(i=>n("div",{className:"invoice-item"},[n("input",{type:"checkbox",className:"invoice-item-checkbox",dataset:{product:i.productId},checked:L.has(i.productId),onchange:()=>window.toggleInvoiceItem(null,i.productId)}),n("div",{className:"invoice-item-details"},[n("div",{className:"invoice-item-name"},i.productName),n("div",{className:"invoice-item-meta"},`${i.quantity||0} ${i.unit||""} Ã— â‚¹${(i.rate||0).toLocaleString("en-IN")}`)]),n("div",{className:"invoice-item-amount"},`â‚¹${(i.amount||0).toLocaleString("en-IN")}`)])))),s.appendChild(n("div",{className:"invoice-summary"},[n("div",{className:"invoice-summary-label"},"Total"),n("div",{className:"invoice-summary-total"},`â‚¹${o.toLocaleString("en-IN")}`)])),e.appendChild(s);const c=document.getElementById("generateInvoiceBtn");c&&(c.disabled=L.size===0)}function ve(e){S=e,G()}function he(e,t){L.has(t)?L.delete(t):L.add(t),G()}async function ye(){if(!E||!S||L.size===0)return;const e=document.getElementById("generateInvoiceBtn");e.classList.add("btn-loading"),e.disabled=!0;try{const t={"Content-Type":"application/json"},o=await O.ensureCsrfToken();o&&(t["X-CSRF-Token"]=o);const a=await fetch(`/api/invoices/${E.orderId}/pdf`,{method:"POST",headers:t,credentials:"include",body:JSON.stringify({firmId:S,productIds:Array.from(L)})});if(!a.ok){const i=await a.json().catch(()=>({}));throw new Error(i.message||"Invoice generation temporarily unavailable")}const s=await a.blob(),r=URL.createObjectURL(s),c=document.createElement("a");c.href=r,c.download=`INV${E.orderNumber.replace("ORD","")}.pdf`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r),u("Invoice downloaded","success"),Y()}catch(t){console.error("Generate invoice error:",t),u(t.message||"Could not generate invoice","info")}finally{e.classList.remove("btn-loading"),e.disabled=!1}}function Y(){document.getElementById("invoiceModal").classList.remove("show"),E=null,S=null,L=new Set}function we(){if(!q)return;const e=q;R(),J(e)}async function be(e){if(b?.role!=="admin"||!confirm("Are you sure you want to delete this order? This action cannot be undone."))return;const t=document.querySelector(`.swipe-item[data-order-id="${e}"]`);try{const o={"Content-Type":"application/json"},a=await O.ensureCsrfToken();a&&(o["X-CSRF-Token"]=a);const s=await fetch(`/api/orders/${e}`,{method:"DELETE",headers:o,credentials:"include"});if(s.ok)t?(t.classList.add("deleting"),setTimeout(()=>{D()},300)):D(),u("Order cancelled","success");else{const r=await s.json().catch(()=>({message:"Could not cancel. Try again."}));u(r.message||"Could not cancel","info")}}catch(o){console.error("Delete order error:",o),u("Could not delete order","info")}}async function ne(e){if(T){u("Please wait, saving in progress...","info");return}try{const t=await fetch(`/api/orders/${e}`,{credentials:"include"});let o;try{o=await t.json()}catch(l){console.error("Failed to parse order response:",l),u("Server issue. Please refresh.","info");return}if(!t.ok){u(o?.message||"Could not load order","info");return}const a=o.data;if(!a||!a.products){u("Order data updating. Refresh page.","info");return}q=e,N=a,C={},w={},p=[];const s=document.getElementById("modalTitle");s&&(s.textContent=`#${a.orderNumber}`);const r=document.getElementById("savePricesBtn");r&&(r.disabled=!0);const c=b.role==="admin"||b.role==="staff",i=a.batch?.batchType?`<span class="badge badge-batch">${a.batch.batchType}${a.batchLocked?" ðŸ”’":""}</span>`:"-",g=document.getElementById("modalBody");g.innerHTML="";const m=document.createDocumentFragment(),h=n("div",{className:"info-row"},[n("div",{},[n("div",{className:"info-label"},"Customer"),n("div",{className:"info-value"},a.customer?.name||"")]),n("div",{},[n("div",{className:"info-label"},"Phone"),n("div",{className:"info-value"},a.customer?.phone||"-")])]);m.appendChild(h);const d=a.batch?.batchType?n("span",{className:"badge badge-batch"},[a.batch.batchType,a.batchLocked?" ðŸ”’":""]):"-",y=n("div",{className:"info-row"},[n("div",{},[n("div",{className:"info-label"},"Date"),n("div",{className:"info-value"},new Date(a.createdAt).toLocaleDateString("en-IN"))]),n("div",{},[n("div",{className:"info-label"},"Batch"),n("div",{className:"info-value"},Array.isArray(d)?d:[d])])]);m.appendChild(y);const $=n("div",{className:"info-row"},[n("div",{},[n("div",{className:"info-label"},"Status"),n("div",{className:"info-value"},[n("span",{className:`badge badge-${a.status}`},a.status)])]),n("div",{})]);m.appendChild($);const v=n("div",{className:"info-section"});if(v.appendChild(n("div",{className:"info-label"},"Products")),a.products.forEach((l,f)=>{const _=typeof l.product=="object"?l.product._id:l.product,I=z[_]||l.rate||null,A=I?`â‚¹${I.toLocaleString("en-IN")}`:"N/A";let H;if(c){const F=n("input",{type:"number",className:"qty-input-sm input-animated",id:`quantity-${f}`,value:l.quantity,min:"0",step:"0.01",dataset:{idx:f,original:l.quantity,unit:l.unit},onfocus:k=>window.clearZero(k.target),onblur:k=>window.restoreValue(k.target),onchange:()=>window.handleQuantityChange(f),oninput:()=>window.handleQuantityInput(f)});H=n("div",{className:"qty-controls-inline"},[n("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(f,-1)},"âˆ’"),F,n("button",{className:"qty-btn-sm",type:"button",onclick:()=>window.changeQuantity(f,1)},"+"),n("span",{className:"qty-unit"},l.unit)])}else H=n("div",{className:"product-qty"},`${l.quantity} ${l.unit}`);const U=["Selling"];l.isContractPrice&&(U.push(" "),U.push(n("span",{className:"contract-badge"},"Fixed")));let V;if(c){const F=n("input",{type:"number",className:`price-input input-animated${l.isContractPrice?" contract-locked":""}`,id:`price-${f}`,value:l.rate,min:"0",step:"0.01",dataset:{idx:f,original:l.rate,qty:l.quantity,contract:l.isContractPrice||!1},onfocus:k=>window.clearZero(k.target),onblur:k=>window.restoreValue(k.target),onchange:()=>window.handlePriceChange(f),oninput:()=>window.handlePriceInput(f)});l.isContractPrice&&(F.disabled=!0,F.title="Contract price - edit in customer management"),V=F}else V=n("div",{className:"price-value"},`â‚¹${l.rate}`);const se=n("div",{className:"product-item",dataset:{idx:f}},[n("div",{className:"product-top"},[n("div",{},[n("div",{className:"product-name"},l.productName),H])]),n("div",{className:"prices-container"},[n("div",{className:"price-box"},[n("div",{className:"price-label"},"Purchase"),n("div",{className:"price-value"},A)]),n("div",{className:"price-box"},[n("div",{className:"price-label"},U),V])]),n("div",{className:"amount-row"},[n("span",{className:"amount-label"},"Amount"),n("span",{className:"amount-display",id:`amount-${f}`},`â‚¹${l.amount}`)])]);v.appendChild(se)}),v.appendChild(n("div",{id:"addedProductsContainer"})),c){const l=[n("option",{value:""},"+ Add Product...")];te.filter(I=>!a.products.some(A=>(typeof A.product=="object"?A.product._id:A.product)===I._id)).forEach(I=>{l.push(n("option",{value:I._id,dataset:{name:I.name,unit:I.unit}},`${I.name} (${I.unit})`))});const f=n("select",{id:"productSelector",className:"product-select",onchange:()=>window.addProductToOrder()},l),_=n("div",{className:"add-product-section"},[f]);v.appendChild(_)}m.appendChild(v);const ie=n("div",{className:"total-section"},[n("div",{className:"total-row"},[n("span",{},"Total"),n("span",{id:"orderTotal"},`â‚¹${a.totalAmount}`)]),n("div",{className:"total-row"},[n("span",{},"Paid"),n("span",{},`â‚¹${a.paidAmount||0}`)]),n("div",{className:"total-row main"},[n("span",{},"Balance"),n("span",{id:"orderBalance"},`â‚¹${a.totalAmount-(a.paidAmount||0)}`)])]);m.appendChild(ie),g.appendChild(m),document.getElementById("orderModal").classList.add("show")}catch{u("Could not load order","info")}}function Ie(e){e.dataset.prevValue=e.value,e.value="",e.select()}function Ne(e){e.value===""&&(e.value=e.dataset.prevValue||e.dataset.original);const t=parseInt(e.dataset.idx);ae(t)}function Ce(e){const t=document.getElementById(`price-${e}`),o=document.getElementById(`quantity-${e}`),a=parseFloat(t.dataset.original),s=parseFloat(t.value)||0,r=o?parseFloat(o.value)||0:parseFloat(t.dataset.qty);t.classList.toggle("changed",s!==a);const c=Math.round(s*r*100)/100,i=document.getElementById(`amount-${e}`);i&&(i.textContent=`â‚¹${c.toLocaleString("en-IN")}`),B()}function ae(e){const t=document.getElementById(`price-${e}`);if(!t)return;const o=parseFloat(t.dataset.original),a=parseFloat(t.value)||0;a!==o&&a>0?C[e]=a:delete C[e],Q()}function Ee(e,t){const o=document.getElementById(`quantity-${e}`);if(!o)return;let s=(parseFloat(o.value)||0)+t;s<.01&&s>0&&(s=0),s<0&&(s=0),o.value=s,oe(e),K(e)}function K(e){const t=document.getElementById(`quantity-${e}`),o=document.getElementById(`price-${e}`);if(!t)return;const a=parseFloat(t.dataset.original),s=parseFloat(t.value)||0;t.classList.remove("changed","removed"),s===0?t.classList.add("removed"):s!==a&&t.classList.add("changed");const r=o?parseFloat(o.value)||0:N?.products[e]?.rate||0,c=Math.round(s*r*100)/100,i=document.getElementById(`amount-${e}`);i&&(i.textContent=`â‚¹${c.toLocaleString("en-IN")}`),B()}function oe(e){const t=document.getElementById(`quantity-${e}`);if(!t)return;const o=parseFloat(t.dataset.original),a=parseFloat(t.value)||0,s=.01;a>0&&a<s?(u(`Minimum quantity: ${s} ${t.dataset.unit}`,"info"),t.value=o,delete w[e]):a!==o?w[e]=a:delete w[e],Q(),K(e)}function Q(){const e=Object.keys(C).length>0||Object.keys(w).length>0||p.length>0,t=document.getElementById("savePricesBtn");t&&(t.disabled=!e)}function Le(){const e=document.getElementById("productSelector"),t=e.value;if(!t)return;const o=e.options[e.selectedIndex],a=o.dataset.name,s=o.dataset.unit,r=z[t]||0;p.push({product:t,productName:a,unit:s,quantity:1,rate:r}),o.remove(),W(),B(),Q(),e.value=""}function W(){const e=document.getElementById("addedProductsContainer");if(!e)return;e.innerHTML="";const t=document.createDocumentFragment();p.forEach((o,a)=>{const s=n("div",{className:"product-item added-product",dataset:{addedIdx:a}},[n("div",{className:"product-top"},[n("div",{},[n("div",{className:"product-name"},[o.productName," ",n("span",{className:"new-badge"},"New")]),n("div",{className:"qty-controls-inline"},[n("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(a,-1),type:"button"},"âˆ’"),n("input",{type:"number",className:"qty-input-sm input-animated",id:`added-qty-${a}`,value:o.quantity,min:"0",step:"0.01",onchange:()=>window.handleAddedQtyChange(a),oninput:()=>window.handleAddedQtyInput(a)}),n("button",{className:"qty-btn-sm",onclick:()=>window.changeAddedQty(a,1),type:"button"},"+"),n("span",{className:"qty-unit"},o.unit)])]),n("button",{className:"remove-btn",onclick:()=>window.removeAddedProduct(a),title:"Remove"},"Ã—")]),n("div",{className:"prices-container"},[n("div",{className:"price-box"},[n("div",{className:"price-label"},"Purchase"),n("div",{className:"price-value"},o.rate?`â‚¹${o.rate.toLocaleString("en-IN")}`:"N/A")]),n("div",{className:"price-box"},[n("div",{className:"price-label"},"Selling"),n("input",{type:"number",className:"price-input input-animated",id:`added-price-${a}`,value:o.rate||0,min:"0",step:"0.01",onchange:()=>window.handleAddedPriceChange(a)})])]),n("div",{className:"amount-row"},[n("span",{className:"amount-label"},"Amount"),n("span",{className:"amount-display",id:`added-amount-${a}`},`â‚¹${((o.rate||0)*(o.quantity||0)).toLocaleString("en-IN")}`)])]);t.appendChild(s)}),e.appendChild(t)}function Be(e,t){const o=document.getElementById(`added-qty-${e}`);if(!o)return;let a=parseFloat(o.value)||0;a=Math.max(0,a+t),a>0&&a<.01&&(a=.01),o.value=a,p[e].quantity=a,j(e),B()}function $e(e){const t=document.getElementById(`added-qty-${e}`);if(!t)return;let o=parseFloat(t.value)||0;o>0&&o<.01&&(u("Minimum quantity: 0.01","info"),o=.01,t.value=o),p[e].quantity=o,j(e),B()}function Te(e){const t=document.getElementById(`added-qty-${e}`);if(!t)return;const o=parseFloat(t.value)||0;p[e].quantity=o,j(e),B()}function qe(e){const t=document.getElementById(`added-price-${e}`);if(!t)return;const o=parseFloat(t.value)||0;p[e].rate=o,j(e),B()}function Se(e){const t=document.getElementById(`added-price-${e}`);if(!t)return;const o=parseFloat(t.value)||0;p[e].rate=o,j(e),B()}function j(e){const t=document.getElementById(`added-amount-${e}`);if(!t)return;const o=p[e],a=(o.quantity||0)*(o.rate||0);t.textContent=`â‚¹${a.toLocaleString("en-IN")}`}function ke(e){const t=p.splice(e,1)[0],o=document.getElementById("productSelector");if(o&&t){const a=document.createElement("option");a.value=t.product,a.dataset.name=t.productName,a.dataset.unit=t.unit,a.textContent=`${t.productName} (${t.unit})`,o.appendChild(a)}W(),B(),Q()}function B(){if(!N||!N.products)return;let e=0;N.products.forEach((s,r)=>{const c=document.getElementById(`price-${r}`),i=document.getElementById(`quantity-${r}`),g=c?parseFloat(c.value)||0:s.rate,m=i?parseFloat(i.value)||0:s.quantity;e+=g*m}),p.forEach(s=>{e+=(s.quantity||0)*(s.rate||0)}),e=Math.round(e*100)/100;const t=Math.round((e-(N.paidAmount||0))*100)/100,o=document.getElementById("orderTotal"),a=document.getElementById("orderBalance");o&&(o.textContent=`â‚¹${e.toLocaleString("en-IN")}`),a&&(a.textContent=`â‚¹${t.toLocaleString("en-IN")}`)}async function Pe(e){try{const t=await fetch(`/api/invoices/order/${e}`,{credentials:"include"});if(!t.ok)return!1;const o=await t.json();return o.data&&o.data.length>0}catch(t){return console.error("Failed to check invoices:",t),!1}}async function Ae(){const e=Object.keys(C).length>0||Object.keys(w).length>0||p.length>0;if(!q||!N||!N.products||!e)return;if(T){u("Save in progress...","info");return}T=!0;const t=document.getElementById("savePricesBtn");t&&(t.disabled=!0,t.classList.add("btn-loading"));let o=!1;try{if(o=await Pe(q),o&&!confirm(`Invoices exist for this order. Changes will not update existing invoices.

You may need to regenerate invoices after saving. Continue?`)){T=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}catch(a){console.error("Invoice check failed:",a)}try{const a=N.products.map((d,y)=>{let $=C[y]!==void 0?C[y]:d.rate,v=w[y]!==void 0?w[y]:d.quantity;return(!$||$<=0)&&($=d.rate),v<0&&(v=d.quantity),{product:typeof d.product=="object"?d.product._id:d.product,quantity:v,priceAtTime:$}}).filter(d=>d.quantity>0),s=p.filter(d=>d.quantity>0).map(d=>({product:d.product,quantity:d.quantity,priceAtTime:d.rate})),r=[...a,...s],c={"Content-Type":"application/json"},i=await O.ensureCsrfToken();i&&(c["X-CSRF-Token"]=i);const g={products:r},m=q;let h=await fetch(`/api/orders/${m}`,{method:"PUT",headers:c,credentials:"include",body:JSON.stringify(g)});if(h.status===403){let d;try{d=await h.json()}catch{d={message:"Access denied"}}if(d.message?.toLowerCase().includes("csrf")){const y=await O.refreshCsrfToken();if(y){if(c["X-CSRF-Token"]=y,h=await fetch(`/api/orders/${m}`,{method:"PUT",headers:c,credentials:"include",body:JSON.stringify(g)}),h.status===403){u("Session expired. Please refresh the page.","info"),T=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}else{u("Session expired. Please refresh the page.","info"),T=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}else{u(d.message||"Access temporarily unavailable","info"),T=!1,t&&(t.classList.remove("btn-loading"),t.disabled=!1);return}}if(h.ok)u("Changes saved","success"),C={},w={},p=[],t&&(t.classList.remove("btn-loading"),t.classList.add("btn-success"),setTimeout(()=>t.classList.remove("btn-success"),1500),t.disabled=!0),D(),o&&setTimeout(()=>{if(confirm("Order updated. Regenerate invoice with new quantities?")){const d=m;R(),setTimeout(()=>J(d),300)}},500),q===m&&ne(m);else{let d;try{d=await h.json()}catch{d={message:`Server error (${h.status})`}}u(d.message||"Could not update","info"),t&&(t.disabled=!1)}}catch(a){console.error("Save changes error:",a),navigator.onLine?u("Could not save. Try again.","info"):u("No internet connection","info"),t&&(t.disabled=!1)}finally{T=!1,t&&t.classList.remove("btn-loading")}}function R(){if((Object.keys(C).length>0||Object.keys(w).length>0||p.length>0)&&!confirm("You have unsaved changes. Discard them?"))return;const t=document.getElementById("orderModal");t&&t.classList.remove("show"),q=null,N=null,C={},w={},p=[]}window.closeModal=R;window.viewOrder=ne;window.clearZero=Ie;window.restoreValue=Ne;window.handlePriceChange=ae;window.handlePriceInput=Ce;window.handleQuantityChange=oe;window.handleQuantityInput=K;window.changeQuantity=Ee;window.savePrices=Ae;window.deleteOrder=be;window.printOrder=J;window.closeInvoiceModal=Y;window.selectFirm=ve;window.toggleInvoiceItem=he;window.generateInvoice=ye;window.printFromModal=we;window.addProductToOrder=Le;window.renderAddedProducts=W;window.changeAddedQty=Be;window.handleAddedQtyChange=$e;window.handleAddedQtyInput=Te;window.handleAddedPriceChange=qe;window.handleAddedPriceInput=Se;window.removeAddedProduct=ke;re();
