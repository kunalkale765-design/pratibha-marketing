import"./responsive-C3eqjYrO.js";import{c as a,s as l}from"./ui-DPXrEiII.js";import"./api-BVpkjr3r.js";import{l as V}from"./init-10IUnAVO.js";const J=(e=1e4)=>new Promise((t,n)=>{const o=Date.now(),r=()=>{if(window.Auth)return t(window.Auth);if(Date.now()-o>e)return n(new Error("Auth not available"));setTimeout(r,50)};r()}),w=await J(),S=document.getElementById("logoutBtn");S&&S.addEventListener("click",V);const P=document.getElementById("customerSelect");P&&P.addEventListener("change",W);let h=null,u=null,v=[];const N={};let L=[],g=!1,C=!1;async function Z(){const t=new URLSearchParams(window.location.search).get("token");if(t)try{const n=await fetch(`/api/auth/magic/${t}`,{credentials:"include"}),o=await n.json();if(n.ok&&o.user)h=o.user,w.setUser(o.user),window.history.replaceState({},"",window.location.pathname);else{l(o.message||"Link expired. Please request a new one.","info"),window.location.href="/pages/auth/login.html";return}}catch{l("Authentication issue. Please refresh.","info"),window.location.href="/pages/auth/login.html";return}else if(h=await w.verify(),!h){window.location.href="/pages/auth/login.html";return}if(g=h.role==="admin"||h.role==="staff",await _(),g){const n=document.getElementById("customerBar");n&&n.classList.add("show"),X()}else if(h.customer)u=typeof h.customer=="object"?h.customer:{_id:h.customer,pricingType:"market"},O();else{const n=document.getElementById("productList");n&&(n.innerHTML="",n.appendChild(a("div",{className:"empty-state"},"Account setup in progress. Please check back later.")))}}async function _(){try{const[e,t,n]=await Promise.all([fetch("/api/products",{credentials:"include"}),fetch("/api/market-rates",{credentials:"include"}),fetch("/api/customers",{credentials:"include"}).catch(()=>({ok:!1}))]);e.ok&&(v=((await e.json())?.data||[]).filter(r=>r.isActive!==!1)),t.ok&&((await t.json())?.data||[]).forEach(r=>{const s=typeof r.product=="object"?r.product._id:r.product;s&&(N[s]=r.rate)}),n.ok&&(L=((await n.json())?.data||[]).filter(r=>r.isActive!==!1))}catch(e){console.error("Failed to load data:",e);const t=document.getElementById("productList");t&&(t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},[a("p",{},"Products not available"),a("button",{id:"retryDataBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:()=>_().then(()=>{u&&O()})},"Try Again")])))}}function X(){const e=document.getElementById("customerSelect");if(L.length===0){const t=a("option",{value:"",disabled:!0,selected:!0},"Loading customers...");e.appendChild(t);return}e.innerHTML="",e.appendChild(a("option",{value:""},"Select customer")),L.forEach(t=>{e.appendChild(a("option",{value:t._id},t.name))})}function W(){const e=document.getElementById("customerSelect").value;if(u=L.find(t=>t._id===e)||null,u)O();else{const t=document.getElementById("productList");t.innerHTML="",t.appendChild(a("div",{className:"empty-state"},"Select a customer to start"))}k()}function G(e,t){return e?e[t]!==void 0?e[t]:typeof e.get=="function"?e.get(t):null:null}function K(e){if(!u)return N[e._id]||0;const t=u.pricingType||"market";if(t==="contract"){const n=G(u.contractPrices,e._id);return n!==null?n:N[e._id]||0}else if(t==="markup"){const n=N[e._id]||0;return Math.round(n*(1+(u.markupPercentage||0)/100))}return N[e._id]||0}function Y(){if(g||!u||u.pricingType!=="contract")return v;const e=u.allowedProducts||(u.contractPrices?Object.keys(u.contractPrices):[]);return e.length===0?[]:v.filter(t=>e.includes(t._id))}function z(e=v){const t=[...new Set(e.map(o=>o.category||"Other"))],n=document.getElementById("categoryPills");if(n.innerHTML="",e.length===0||t.length<=1){n.style.display="none";return}n.style.display="flex",n.appendChild(a("button",{className:"cat-pill active",dataset:{cat:"all"},onclick:()=>M("all")},"All")),t.forEach(o=>{n.appendChild(a("button",{className:"cat-pill",dataset:{cat:o},onclick:()=>M(o)},o))})}function M(e){document.querySelectorAll(".cat-pill").forEach(n=>n.classList.remove("active"));const t=document.querySelector(`.cat-pill[data-cat="${e}"]`);t&&t.classList.add("active"),document.querySelectorAll(".product-item").forEach(n=>{n.style.display=e==="all"||n.dataset.category===e?"":"none"}),document.querySelectorAll(".category-header").forEach(n=>{n.style.display=e==="all"||n.dataset.category===e?"":"none"})}function O(){const e=document.getElementById("productList");e.innerHTML="";const t=Y();if(!t.length){const s=u&&u.pricingType==="contract"&&v.length>0?"No products configured for your account. Please contact us to set up pricing.":"No products available";e.appendChild(a("div",{className:"empty-state"},s));return}z(t);const n={};t.forEach(r=>{const s=r.category||"Other";n[s]||(n[s]=[]),n[s].push(r)});const o=document.createDocumentFragment();for(const[r,s]of Object.entries(n))o.appendChild(a("div",{className:"category-header",dataset:{category:r}},r)),s.forEach(i=>{const c=g?K(i):0,p=i.unit==="piece"?"1":"0.01",d={id:i._id,category:r,unit:i.unit};g&&(d.price=c);const y=a("div",{className:"product-item",dataset:d},[a("div",{className:"product-info"},[a("div",{className:"product-name"},i.name),a("div",{className:"product-meta"},i.unit)]),a("div",{className:"qty-controls"},[a("button",{className:"qty-btn",onclick:()=>window.changeQty(i._id,-1)},"âˆ’"),a("input",{type:"number",className:"qty-input",id:`qty-${i._id}`,value:"0",min:"0",step:p,inputmode:"numeric",onfocus:f=>window.clearZero(f.target),onblur:f=>window.restoreZero(f.target),onchange:()=>window.updateFromInput(i._id)}),a("button",{className:"qty-btn",onclick:()=>window.changeQty(i._id,1)},"+")])]);o.appendChild(y)});e.appendChild(o)}function ee(e){e.value==="0"&&(e.value=""),e.select()}function te(e){e.value===""&&(e.value="0"),j(e.id.replace("qty-",""))}function ne(e,t){const n=document.getElementById("qty-"+e);let o=parseFloat(n.value)||0;o=Math.max(0,o+t),n.value=o,R(e,o)}function j(e){const t=document.getElementById("qty-"+e),n=Math.max(0,parseFloat(t.value)||0);t.value=n,R(e,n)}function R(e,t){const n=document.querySelector(`.product-item[data-id="${e}"]`),o=document.getElementById("qty-"+e);n&&o&&(t>0?(n.classList.add("has-qty"),o.classList.add("has-value")):(n.classList.remove("has-qty"),o.classList.remove("has-value"))),k()}function k(){let e=0;document.querySelectorAll(".product-item").forEach(o=>{const r=o.dataset.id,s=document.getElementById("qty-"+r);(parseFloat(s?.value)||0)>0&&e++});const t=document.getElementById("itemCount"),n=document.getElementById("orderBtn");t&&(t.textContent=e),n&&(n.disabled=e===0||!u)}const A=document.getElementById("searchInput");A&&A.addEventListener("input",e=>{const t=e.target.value.toLowerCase();document.querySelectorAll(".product-item").forEach(n=>{const o=n.querySelector(".product-name").textContent.toLowerCase();n.style.display=o.includes(t)?"":"none"}),document.querySelectorAll(".category-header").forEach(n=>{const o=n.dataset.category,r=[...document.querySelectorAll(`.product-item[data-category="${o}"]`)].some(s=>s.style.display!=="none");n.style.display=r?"":"none"})});async function oe(){if(!u)return;const e=[],t=[];if(document.querySelectorAll(".product-item").forEach(o=>{const r=o.dataset.id,s=document.getElementById("qty-"+r),c=parseFloat(s?.value)||0,p=g&&parseFloat(o.dataset.price)||0,d=o.dataset.unit,y=o.querySelector(".product-name")?.textContent||"Unknown";if(c>0){d==="piece"&&!Number.isInteger(c)&&t.push(y);const f={product:r,quantity:c};g&&p>0&&(f.rate=p),e.push(f)}}),t.length>0){l(`${t.join(", ")}: use whole numbers`,"info");return}if(!e.length)return;const n=document.getElementById("orderBtn");n.disabled=!0,n.textContent="Placing...";try{const o={"Content-Type":"application/json"},r=await w.ensureCsrfToken();r&&(o["X-CSRF-Token"]=r);const s=document.getElementById("orderNotes"),i=s?.value?.trim()||"",c={customer:u._id,products:e,idempotencyKey:crypto.randomUUID()};i&&(c.notes=i);let p=await fetch("/api/orders",{method:"POST",headers:o,credentials:"include",body:JSON.stringify(c)}),d=await p.json();if(p.status===403&&d?.message?.toLowerCase().includes("csrf")){const y=await w.refreshCsrfToken();y&&(o["X-CSRF-Token"]=y,p=await fetch("/api/orders",{method:"POST",headers:o,credentials:"include",body:JSON.stringify(c)}),d=await p.json())}if(p.ok){const y=d?.data?.orderNumber||"New";l(`Order placed! #${y}`,"success"),d.warning&&setTimeout(()=>{l(d.warning,"info")},1500),d.message&&d.newContractPrices&&d.newContractPrices.length>0&&setTimeout(()=>{l(d.message,"info")},d.warning?3e3:1500),document.querySelectorAll(".qty-input").forEach(f=>{f.value="0",f.classList.remove("has-value")}),document.querySelectorAll(".product-item").forEach(f=>{f.classList.remove("has-qty")}),s&&(s.value=""),k()}else l(d.message||"Could not place order","info")}catch(o){console.error("Order placement error:",o),navigator.onLine?l("Could not place order. Try again.","info"):l("No internet connection","info")}finally{n&&(n.disabled=!1,n.textContent="Place Order"),k()}}let x="new";function H(e){if(x=e,document.querySelectorAll(".order-tab").forEach(t=>{t.classList.toggle("active",t.dataset.tab===e)}),document.querySelectorAll(".order-view").forEach(t=>{t.classList.remove("active")}),e==="new"){const t=document.getElementById("newOrderView");t&&t.classList.add("active")}else if(e==="list"){const t=document.getElementById("ordersListView");t&&t.classList.add("active"),T()}}const F=document.getElementById("newOrderTab"),D=document.getElementById("myOrdersTab");F&&F.addEventListener("click",()=>H("new"));D&&D.addEventListener("click",()=>H("list"));let B=[],q="all";async function T(){const e=document.getElementById("ordersContainer");e.innerHTML="",e.appendChild(a("div",{className:"loading"},"Loading orders..."));try{const t=await fetch("/api/orders",{credentials:"include"}),n=await t.json();t.ok?(B=n.data||[],U()):(e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},n.message||"Orders not available")))}catch(t){console.error("Load orders error:",t),e.innerHTML="",e.appendChild(a("div",{className:"empty-state"},[a("p",{},"Orders not available"),a("button",{id:"retryOrdersBtn",style:{marginTop:"1rem",padding:"0.5rem 1rem",background:"var(--dusty-olive)",color:"white",border:"none",borderRadius:"8px",cursor:"pointer"},onclick:T},"Try Again")]))}}function U(){const e=document.getElementById("ordersContainer");let t=B;if(q!=="all"&&(t=B.filter(o=>o.status===q)),e.innerHTML="",!t.length){e.appendChild(a("div",{className:"empty-state"},"No orders found"));return}const n=document.createDocumentFragment();t.forEach(o=>{const r=new Date(o.createdAt).toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"numeric"}),s=[];if(o.batch?.batchType){const c=`${o.batch.batchType} Batch`;s.push(a("span",{className:"badge badge-batch"},c))}s.push(a("span",{className:`badge badge-${o.status}`},o.status));const i=a("div",{className:"order-card",onclick:()=>window.openOrderDetail(o._id)},[a("div",{className:"order-top"},[a("div",{className:"order-number"},o.orderNumber),a("div",{className:"order-products-summary"},`${o.products.length} item${o.products.length!==1?"s":""}`)]),a("div",{className:"order-bottom"},[a("div",{className:"order-date"},r),a("div",{className:"order-badges"},s)])]);n.appendChild(i)}),e.appendChild(n)}function ae(e){q=e,document.querySelectorAll(".status-pill").forEach(t=>{t.classList.toggle("active",t.dataset.status===e)}),U()}document.querySelectorAll(".status-pill").forEach(e=>{e.addEventListener("click",()=>ae(e.dataset.status))});let m=null,b=[],E=[];async function re(e){try{const[t,n]=await Promise.all([fetch(`/api/orders/${e}`,{credentials:"include"}),fetch(`/api/invoices/my-order/${e}`,{credentials:"include"})]),o=await t.json();if(t.ok&&o.data){m=o.data,b=JSON.parse(JSON.stringify(m.products||[]));try{const r=await n.json();E=n.ok?r.data||[]:[]}catch(r){console.warn("Failed to load invoices:",r.message),E=[]}se(),document.getElementById("orderModal").classList.add("show"),document.body.style.overflow="hidden"}else l(o.message||"Could not load order","info")}catch(t){console.error("Load order detail error:",t),l("Could not load details","info")}}function I(){C&&!confirm("You have unsaved changes. Discard them?")||(document.getElementById("orderModal").classList.remove("show"),document.body.style.overflow="",m=null,b=[],E=[],C=!1)}function se(){const e=m.status==="pending",t=document.getElementById("orderModalTitle"),n=document.getElementById("orderModalBody"),o=document.getElementById("orderModalFooter");t.textContent=m.orderNumber,n.innerHTML="";const r=document.createDocumentFragment(),s=a("div",{className:"order-info-grid"},[a("div",{},[a("div",{className:"info-label"},"Status"),a("span",{className:`badge badge-${m.status}`},m.status)]),a("div",{},[a("div",{className:"info-label"},"Date"),a("div",{className:"info-value"},new Date(m.createdAt).toLocaleDateString("en-IN",{month:"short",day:"numeric",year:"numeric"}))])]);if(m.batch?.batchType){const p=m.batch?.status==="confirmed";s.appendChild(a("div",{},[a("div",{className:"info-label"},"Batch"),a("span",{className:"badge badge-batch"},[`${m.batch.batchType} Batch`,p?" ðŸ”’":""])]))}const i=a("div",{className:"order-info-section"},[s,m.deliveryAddress?a("div",{style:{marginTop:"1rem"}},[a("div",{className:"info-label"},"Delivery Address"),a("div",{className:"info-value"},m.deliveryAddress)]):null,m.notes?a("div",{style:{marginTop:"1rem"}},[a("div",{className:"info-label"},"Notes"),a("div",{className:"info-value"},m.notes)]):null].filter(Boolean));r.appendChild(i),r.appendChild(a("div",{className:"divider"})),r.appendChild(a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Products"));const c=a("div",{id:"orderProductsList"});if(Q(e,c),r.appendChild(c),E.length>0){r.appendChild(a("div",{className:"divider"})),r.appendChild(a("div",{className:"info-label",style:{marginBottom:"0.5rem"}},"Invoices"));const p=a("div",{className:"invoices-list"});E.forEach(d=>{const y=new Date(d.generatedAt).toLocaleDateString("en-IN",{month:"short",day:"numeric"}),f=a("div",{className:"invoice-item",onclick:()=>window.downloadInvoice(d.invoiceNumber)},[a("div",{className:"invoice-info"},[a("div",{className:"invoice-number"},d.invoiceNumber),a("div",{className:"invoice-meta"},`${d.firm?.name||"Unknown Firm"} â€¢ ${y}`)]),a("div",{className:"invoice-download"},[])]);f.querySelector(".invoice-download").innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>`,p.appendChild(f)}),r.appendChild(p)}n.appendChild(r),o.innerHTML="",e?(o.appendChild(a("button",{className:"btn btn-secondary",onclick:()=>window.closeOrderModal()},"Cancel")),o.appendChild(a("button",{className:"btn btn-primary",style:{flex:"1"},onclick:()=>window.saveOrderEdit()},"Save Changes"))):o.appendChild(a("button",{className:"btn btn-primary btn-block",onclick:()=>window.closeOrderModal()},"Close"))}function Q(e,t){t&&(t.innerHTML="",b.forEach((n,o)=>{e?t.appendChild(a("div",{className:"product-item-edit",dataset:{index:o}},[a("div",{className:"product-info"},[a("div",{className:"product-name"},n.productName),a("div",{className:"product-meta"},n.unit)]),a("div",{className:"qty-controls"},[a("button",{className:"qty-btn",onclick:()=>window.changeOrderQty(o,-1)},"âˆ’"),a("input",{type:"number",className:"qty-input",id:`order-qty-${o}`,value:n.quantity,min:"0",inputmode:"numeric",onchange:()=>window.updateOrderQtyFromInput(o)}),a("button",{className:"qty-btn",onclick:()=>window.changeOrderQty(o,1)},"+")])])):t.appendChild(a("div",{className:"product-item-edit readonly"},[a("div",{className:"product-info"},[a("div",{className:"product-name"},n.productName),a("div",{className:"product-meta"},`${n.quantity} ${n.unit}`)])]))}))}function ie(e,t){const n=document.getElementById(`order-qty-${e}`);let o=parseFloat(n.value)||0;o=Math.max(0,o+t),n.value=o,b[e].quantity=o,C=!0}function ce(e){const t=document.getElementById(`order-qty-${e}`),n=Math.max(0,parseFloat(t.value)||0);t.value=n,b[e].quantity=n,C=!0}async function de(e){try{l("Downloading invoice...","info");const t=await fetch(`/api/invoices/my/${e}/download`,{credentials:"include"});if(!t.ok){let s="Invoice not ready yet";try{s=(await t.json()).message||s}catch(i){console.warn("Failed to parse invoice download error:",i.message),s=t.status===404?"Invoice not ready yet":t.status===403?"Invoice access pending":"Invoice temporarily unavailable"}throw new Error(s)}const n=await t.blob(),o=window.URL.createObjectURL(n),r=document.createElement("a");r.href=o,r.download=`${e}.pdf`,document.body.appendChild(r),r.click(),document.body.removeChild(r),window.URL.revokeObjectURL(o),l("Invoice downloaded!","success")}catch(t){console.error("Download invoice error:",t),l(t.message||"Could not download","info")}}async function le(){try{const e=b.filter(c=>c.quantity>0).map(c=>({product:typeof c.product=="object"?c.product._id:c.product,quantity:c.quantity}));if(!e.length){l("Add at least one product","info");return}const t=document.querySelector("#orderModalFooter .btn-primary");t&&(t.disabled=!0,t.textContent="Saving...");const n={"Content-Type":"application/json"},o=await w.ensureCsrfToken();o&&(n["X-CSRF-Token"]=o);const r={products:e};let s=await fetch(`/api/orders/${m._id}/customer-edit`,{method:"PUT",headers:n,credentials:"include",body:JSON.stringify(r)}),i=await s.json();if(s.status===403&&i?.message?.toLowerCase().includes("csrf")){const c=await w.refreshCsrfToken();c&&(n["X-CSRF-Token"]=c,s=await fetch(`/api/orders/${m._id}/customer-edit`,{method:"PUT",headers:n,credentials:"include",body:JSON.stringify(r)}),i=await s.json())}s.ok?(l("Order updated successfully","success"),C=!1,I(),T()):l(i.message||"Could not update","info")}catch(e){console.error("Order edit error:",e),navigator.onLine?l("Could not update. Try again.","info"):l("No internet connection","info")}finally{const e=document.querySelector("#orderModalFooter .btn-primary");e&&(e.disabled=!1,e.textContent="Save Changes")}}const $=document.getElementById("orderModal");$&&$.addEventListener("click",e=>{e.target.id==="orderModal"&&I()});document.addEventListener("keydown",e=>{const t=document.getElementById("orderModal");e.key==="Escape"&&t&&t.classList.contains("show")&&I()});document.addEventListener("visibilitychange",()=>{document.visibilityState==="visible"&&x==="list"&&T()});window.clearZero=ee;window.restoreZero=te;window.changeQty=ne;window.updateFromInput=j;window.placeOrder=oe;window.openOrderDetail=re;window.closeOrderModal=I;window.saveOrderEdit=le;window.renderOrderProducts=Q;window.changeOrderQty=ie;window.updateOrderQtyFromInput=ce;window.downloadInvoice=de;Z();
