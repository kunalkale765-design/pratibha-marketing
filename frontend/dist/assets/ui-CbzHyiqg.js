let i=null;function c(){const e=document.cookie.match(/csrf_token=([^;]+)/);return e?e[1]:null}async function u(){if(i)return i;i=(async()=>{const e=new AbortController,t=setTimeout(()=>e.abort(),5e3);try{const s=await fetch("/api/csrf-token",{credentials:"include",signal:e.signal});if(s.ok)return(await s.json()).csrfToken||c()}catch(s){s.name!=="AbortError"&&console.error("Failed to refresh CSRF token:",s)}finally{clearTimeout(t)}return null})();try{return await i}finally{i=null}}async function m(){let e=c();return e||(e=await u()),e}const g={USER_KEY:"user",getCsrfToken:c,refreshCsrfToken:u,ensureCsrfToken:m,isLoggedIn(){return!!this.getUser()},getUser(){try{const e=localStorage.getItem(this.USER_KEY);return e?JSON.parse(e):null}catch(e){return console.error("Error parsing user data:",e),null}},setUser(e){const t={id:e.id,name:e.name,email:e.email,role:e.role,customer:e.customer?{_id:e.customer._id,name:e.customer.name,pricingType:e.customer.pricingType,...e.customer.pricingType==="contract"&&e.customer.contractPrices?{allowedProducts:Object.keys(e.customer.contractPrices)}:{}}:null,isMagicLink:e.isMagicLink||!1};localStorage.setItem(this.USER_KEY,JSON.stringify(t))},clearAuth(){localStorage.removeItem(this.USER_KEY),"serviceWorker"in navigator&&navigator.serviceWorker.controller&&navigator.serviceWorker.controller.postMessage("logout")},getRole(){const e=this.getUser();return e?e.role:null},isStaff(){const e=this.getRole();return e==="admin"||e==="staff"},isCustomer(){return this.getRole()==="customer"},async verify(){try{const e=await fetch("/api/auth/me",{credentials:"include"});if(e.ok){const t=await e.json();return this.setUser(t.user),t.user}else return this.clearAuth(),null}catch(e){return console.error("Auth verification failed:",e),!navigator.onLine||e.name==="TypeError"||e.message.includes("network")||e.message.includes("fetch")||e.message.includes("Failed to fetch")?(console.warn("Network issue during auth verification - using cached user"),this.getUser()):(this.clearAuth(),null)}},async login(e,t,s=!1){try{const r={"Content-Type":"application/json"},o=await this.ensureCsrfToken();o&&(r["X-CSRF-Token"]=o);const n=await fetch("/api/auth/login",{method:"POST",headers:r,credentials:"include",body:JSON.stringify({email:e,password:t})}),a=await n.json();return n.ok?(this.setUser(a.user),{success:!0,user:a.user}):n.status===403&&a?.message?.toLowerCase().includes("csrf")&&!s?(console.log("CSRF token error during login, refreshing and retrying..."),await this.refreshCsrfToken(),this.login(e,t,!0)):{success:!1,error:a.message||"Login failed"}}catch(r){return console.error("Login error:",r),{success:!1,error:"Network error. Please try again."}}},async logout(){try{const e={},t=await this.ensureCsrfToken();t&&(e["X-CSRF-Token"]=t);const s=await fetch("/api/auth/logout",{method:"POST",headers:e,credentials:"include"});s.ok||console.warn("Server-side logout returned error:",s.status)}catch(e){console.error("Logout error:",e),console.warn("Server-side session may still be active due to:",e.message)}finally{this.clearAuth(),window.location.href="/pages/auth/login.html"}},async requireAuth(e=null){const t=await this.verify();return t?e&&!e.includes(t.role)?(t.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",null):t:(window.location.href="/pages/auth/login.html",null)},async redirectIfLoggedIn(){const e=await this.verify();return e?(e.role==="customer"?window.location.href="/pages/order-form/":window.location.href="/",!0):!1}};typeof window<"u"&&(window.Auth=g);function h(e,t={},s=[]){const r=document.createElement(e);return t&&Object.entries(t).forEach(([o,n])=>{o==="className"||o==="class"?r.className=n:o==="style"&&typeof n=="object"?Object.assign(r.style,n):o==="dataset"&&typeof n=="object"?Object.assign(r.dataset,n):o.startsWith("on")&&typeof n=="function"?r.addEventListener(o.substring(2).toLowerCase(),n):r.setAttribute(o,n)}),s&&(Array.isArray(s)||(s=[s]),s.forEach(o=>{o instanceof Node?r.appendChild(o):o!=null&&r.appendChild(document.createTextNode(String(o)))})),r}function f(e,t="success",s=3e3){let r=document.getElementById("toast");r||(r=document.createElement("div"),r.id="toast",r.className="toast",document.body.appendChild(r)),r._hideTimeout&&(clearTimeout(r._hideTimeout),r._hideTimeout=null),r.classList.remove("toast-success","toast-error","toast-warning","toast-info","show"),r.textContent=e,r.classList.add(`toast-${t}`),requestAnimationFrame(()=>{r.classList.add("show")}),r._hideTimeout=setTimeout(()=>{d()},s)}function d(){const e=document.getElementById("toast");e&&e.classList.remove("show")}function w(e,t=3e3){f(e,"success",t)}let l=!1;function y(){l||(l=!0,document.addEventListener("keydown",e=>{if(e.key==="Escape"){const t=document.querySelectorAll(".modal-overlay.show");if(t.length===0)return;typeof window.closeModal=="function"?window.closeModal():(t.forEach(s=>{s.classList.remove("show")}),document.body.style.overflow="")}}))}function p(e,t){const s=document.getElementById(e);s&&(s.type==="password"?(s.type="text",t&&(t.textContent="○")):(s.type="password",t&&(t.textContent="◉")))}const T=Object.freeze(Object.defineProperty({__proto__:null,createElement:h,hideToast:d,setupModalCloseOnEscape:y,showSuccess:w,showToast:f,togglePassword:p},Symbol.toStringTag,{value:"Module"}));export{y as a,w as b,h as c,m as e,c as g,f as s,p as t,T as u};
